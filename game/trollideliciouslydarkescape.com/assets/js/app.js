// --------------------------------------
// 
//    _  _ _/ .  _  _/ /_ _  _  _        
//   /_|/_ / /|//_  / / //_ /_// /_/     
//   https://activetheory.net    _/      
// 
// --------------------------------------
//   4/1/21 9:53a
// --------------------------------------

"undefined"==typeof console&&(window.console={},console.log=console.error=console.info=console.debug=console.warn=console.trace=function(){}),window.performance=window.performance&&window.performance.now?window.performance:Date,Date.now=Date.now||function(){return+new Date},window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(){const start=Date.now();return function(callback){window.setTimeout(()=>callback(Date.now()-start),1e3/60)}}()),window.defer=window.requestAnimationFrame,window.clearTimeout=function(){const _clearTimeout=window.clearTimeout;return function(ref){return window.Timer&&Timer.__clearTimeout(ref)||_clearTimeout(ref)}}(),window.requestIdleCallback=function(){const _requestIdleCallback=window.requestIdleCallback;return function(callback,max){return _requestIdleCallback?_requestIdleCallback(callback,max?{timeout:max}:null):defer(()=>{callback({didTimeout:!1})},0)}}(),window.onIdle=window.requestIdleCallback,"undefined"==typeof Float32Array&&(Float32Array=Array),Math.sign=function(x){return 0===(x=+x)||isNaN(x)?Number(x):x>0?1:-1},Math._round=Math.round,Math.round=function(value,precision=0){let p=Math.pow(10,precision);return Math._round(value*p)/p},Math._random=Math.random,Math.rand=Math.random=function(min,max,precision=0){return void 0===min?Math._random():min===max?min:(min=min||0,max=max||1,0==precision?Math.floor(Math._random()*(max+1-min)+min):Math.round(min+Math._random()*(max-min),precision))},Math.degrees=function(radians){return radians*(180/Math.PI)},Math.radians=function(degrees){return degrees*(Math.PI/180)},Math.clamp=function(value,min=0,max=1){return Math.min(Math.max(value,Math.min(min,max)),Math.max(min,max))},Math.map=Math.range=function(value,oldMin=-1,oldMax=1,newMin=0,newMax=1,isClamp){const newValue=(value-oldMin)*(newMax-newMin)/(oldMax-oldMin)+newMin;return isClamp?Math.clamp(newValue,Math.min(newMin,newMax),Math.max(newMin,newMax)):newValue},Math.mix=function(a,b,alpha){return a*(1-alpha)+b*alpha},Math.step=function(edge,value){return value<edge?0:1},Math.smoothStep=function(min,max,value){const x=Math.max(0,Math.min(1,(value-min)/(max-min)));return x*x*(3-2*x)},Math.fract=function(value){return value-Math.floor(value)},Math.lerp=function(target,value,alpha,calcHz=!0){let hz=window.Render&&calcHz?Render.HZ_MULTIPLIER:1;return value+(target-value)*Math.clamp(alpha*hz,0,1)},Math.mod=function(value,n){return(value%n+n)%n},Array.prototype.shuffle=function(){let temp,r,i=this.length-1;for(;i>0;)r=Math.random(0,i,0),i-=1,temp=this[i],this[i]=this[r],this[r]=temp;return this},Array.storeRandom=function(arr){arr.randomStore=[]},Array.prototype.random=function(range){let value=Math.random(0,this.length-1);if(arguments.length&&!this.randomStore&&Array.storeRandom(this),!this.randomStore)return this[value];if(range>this.length-1&&(range=this.length),range>1){for(;~this.randomStore.indexOf(value);)(value+=1)>this.length-1&&(value=0);this.randomStore.push(value),this.randomStore.length>=range&&this.randomStore.shift()}return this[value]},Array.prototype.remove=function(element){if(!this.indexOf)return;const index=this.indexOf(element);return~index?this.splice(index,1):void 0},Array.prototype.last=function(){return this[this.length-1]},window.Promise=window.Promise||{},Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function flat(){var depth=isNaN(arguments[0])?1:Number(arguments[0]);return depth?Array.prototype.reduce.call(this,(function(acc,cur){return Array.isArray(cur)?acc.push.apply(acc,flat.call(cur,depth-1)):acc.push(cur),acc}),[]):Array.prototype.slice.call(this)},writable:!0}),Promise.create=function(){const promise=new Promise((resolve,reject)=>{this.temp_resolve=resolve,this.temp_reject=reject});return promise.resolve=this.temp_resolve,promise.reject=this.temp_reject,delete this.temp_resolve,delete this.temp_reject,promise},Promise.catchAll=function(array){let promises=[];return array.forEach(promise=>{let p=Promise.create();promises.push(p),promise.then(d=>p.resolve(d)).catch(e=>p.reject(e))}),Promise.all(promises)},String.prototype.includes=function(str){if(!Array.isArray(str))return!!~this.indexOf(str);for(let i=str.length-1;i>=0;i--)if(~this.indexOf(str[i]))return!0;return!1},String.prototype.equals=function(str){let compare=String(this);if(!Array.isArray(str))return str===compare;for(let i=str.length-1;i>=0;i--)if(str[i]===compare)return!0;return!1},String.prototype.strpos=function(str){return console.warn("strpos deprecated: use .includes()"),this.includes(str)},String.prototype.clip=function(num,end=""){return this.length>num?this.slice(0,Math.max(0,num-end.length)).trim()+end:this.slice()},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.replaceAll=function(find,replace){return this.split(find).join(replace)},String.prototype.replaceAt=function(index,replacement){return this.substr(0,index)+replacement+this.substr(index+replacement.length)},(!window.fetch||!window.AURA&&location.protocol.includes("file"))&&(window.fetch=function(url,options){options=options||{};const promise=Promise.create(),request=new XMLHttpRequest;request.open(options.method||"get",url),url.includes(".ktx")&&(request.responseType="arraybuffer");for(let i in options.headers)request.setRequestHeader(i,options.headers[i]);function response(){let header,keys=[],all=[],headers={};return request.getAllResponseHeaders().replace(/^(.*?):\s*([\s\S]*?)$/gm,(m,key,value)=>{keys.push(key=key.toLowerCase()),all.push([key,value]),header=headers[key],headers[key]=header?`${header},${value}`:value}),{ok:1==(request.status/200|0),status:request.status,statusText:request.statusText,url:request.responseURL,clone:response,text:()=>Promise.resolve(request.responseText),json:()=>Promise.resolve(request.responseText).then(JSON.parse),xml:()=>Promise.resolve(request.responseXML),blob:()=>Promise.resolve(new Blob([request.response])),arrayBuffer:()=>Promise.resolve(request.response),headers:{keys:()=>keys,entries:()=>all,get:n=>headers[n.toLowerCase()],has:n=>n.toLowerCase()in headers}}}return request.onload=()=>{promise.resolve(response())},request.onerror=promise.reject,request.send(options.body),promise}),window.get=function(url,options={credentials:"same-origin"}){let promise=Promise.create();return options.method="GET",fetch(url,options).then((function handleResponse(e){if(!e.ok)return promise.reject(e);e.text().then(text=>{if(text.charAt(0).includes(["[","{"]))try{promise.resolve(JSON.parse(text))}catch(err){promise.resolve(text)}else promise.resolve(text)})})).catch(promise.reject),promise},window.post=function(url,body={},options={}){let promise=Promise.create();return options.method="POST",body&&(options.body="object"==typeof body||Array.isArray(body)?JSON.stringify(body):body),options.headers||(options.headers={"content-type":"application/json"}),fetch(url,options).then((function handleResponse(e){if(!e.ok)return promise.reject(e);e.text().then(text=>{if(text.charAt(0).includes(["[","{"]))try{promise.resolve(JSON.parse(text))}catch(err){promise.resolve(text)}else promise.resolve(text)})})).catch(promise.reject),promise},window.put=function(url,body,options={}){let promise=Promise.create();return options.method="PUT",body&&(options.body="object"==typeof body||Array.isArray(body)?JSON.stringify(body):body),fetch(url,options).then((function handleResponse(e){if(!e.ok)return promise.reject(e);e.text().then(text=>{if(text.charAt(0).includes(["[","{"]))try{promise.resolve(JSON.parse(text))}catch(err){promise.resolve(text)}else promise.resolve(text)})})).catch(promise.reject),promise},window.Class=function(_class,_type,_static){const _this=this||window,_name=_class.name||_class.toString().match(/function ?([^\(]+)/)[1];"function"==typeof _type&&(_static=_type,_type=null),(_type=(_type||"").toLowerCase())?"static"==_type?_this[_name]=new _class:"singleton"==_type&&(_this[_name]=_class,function(){let _instance;_this[_name].instance=function(a,b,c){return _instance||(_instance=new _class(a,b,c)),_instance}}(),_static&&_static()):(_this[_name]=_class,_static&&_static()),this&&this!==window&&(this[_name]._namespace=this.__namespace)},window.Inherit=function(child,parent){const args=[].slice.call(arguments,2);parent.apply(child,args);const save={};for(let method in child)save[method]=child[method];defer(()=>{for(let method in child)if(save[method]&&child[method]!==save[method]){if("destroy"==method&&child.destroy&&!child.__element)throw"Do not override destroy directly, use onDestroy :: "+child.constructor.toString();child["_"+method]=save[method]}})},window.Namespace=function(obj){"string"==typeof obj?window[obj]||(window[obj]={Class:Class,__namespace:obj}):(obj.Class=Class,obj.__namespace=obj.constructor.name||obj.constructor.toString().match(/function ([^\(]+)/)[1])},window.Global={},window.THREAD=!1,Class((function Hydra(){const _this=this,_readyPromise=Promise.create();var _base,_callbacks=[];function initLoad(){return document&&window?window._NODE_?setTimeout(loaded,1):window._AURA_?window.Main?setTimeout(loaded,1):setTimeout(initLoad,1):void window.addEventListener("load",loaded,!1):setTimeout(initLoad,1)}function loaded(){window.removeEventListener("load",loaded,!1),_this.LOCAL=(!window._BUILT_||window.DREAM_CONFIG)&&(location.hostname.indexOf("local")>-1||"10"==location.hostname.split(".")[0]||"192"==location.hostname.split(".")[0])&&""==location.port,_callbacks.forEach(cb=>cb()),_callbacks=null,_readyPromise.resolve(),window.Main&&_readyPromise.then(()=>Hydra.Main=new window.Main)}this.HASH=window.location.hash.slice(1),this.LOCAL=!window._BUILT_&&(location.hostname.indexOf("local")>-1||"10"==location.hostname.split(".")[0]||"192"==location.hostname.split(".")[0])&&""==location.port,initLoad(),this.__triggerReady=function(){loaded()},this.ready=function(callback){if(!callback)return _readyPromise;_callbacks?_callbacks.push(callback):callback()},this.absolutePath=function(path){if(window.AURA)return path;let base=_base;if(void 0===base)try{if(document.getElementsByTagName("base").length>0){var a=document.createElement("a");a.href=document.getElementsByTagName("base")[0].href,base=a.pathname,_base=base}}catch(e){_base=null}let pathname=base||location.pathname;pathname.includes("/index.html")&&(pathname=pathname.replace("/index.html",""));let port=Number(location.port)>1e3?":"+location.port:"";return path.includes("http")?path:(location.protocol.length?location.protocol+"//":"")+(location.hostname+port+pathname+"/"+path).replace("//","/")}}),"Static"),Class((function Utils(){var _queries={};this.query=function(key,value){if(value&&(_queries[key]=value),void 0!==_queries[key])return _queries[key];const str=decodeURI(window.location.search.replace(new RegExp("^(?:.*[&\\?]"+encodeURI(key).replace(/[\.\+\*]/g,"\\$&")+"(?:\\=([^&]*))?)?.*$","i"),"$1"));return"0"==str?(_queries[key]=0,0):str.length&&"false"!=str?(_queries[key]=str,str):(_queries[key]=location.search.includes(key),_queries[key])},this.addQuery=function(query,value){return _queries[query]===value?_queries[query]:(this.removeQuery(query),window.history.replaceState({},document.title,`${location.pathname}${this.addParam(location.search,query,value)}`),_queries[query]=value)},this.removeQuery=function(query){return window.history.replaceState({},document.title,`${location.pathname}${this.removeParam(location.search,query)}`),delete _queries[query]},this.addParam=function(url,param,value){let u=url.split("?"),addedParam=encodeURIComponent(param)+"="+value,pars=u[1]?u[1].split(/[&;]/g):[];return pars.push(addedParam),url=u[0]+(pars.length>0?"?"+pars.join("&"):"")},this.removeParam=function(url,param){let u=url.split("?");if(u.length>=2){let prefix=encodeURIComponent(param)+"=",pars=u[1].split(/[&;]/g);for(let i=pars.length;i-- >0;)-1!==pars[i].lastIndexOf(prefix,0)&&pars.splice(i,1);return url=u[0]+(pars.length>0?"?"+pars.join("&"):"")}return url},this.getConstructorName=function(obj){return obj?obj.constructor.name||obj.constructor.toString().match(/function ([^\(]+)/)[1]:obj},this.nullObject=function(object){if(object&&(object.destroy||object.div))for(var key in object)void 0!==object[key]&&(object[key]=null);return null},this.cloneObject=function(obj){return JSON.parse(JSON.stringify(obj))},this.headsTails=function(n0,n1){return Math.random(0,1)?n1:n0},this.mergeObject=function(){for(var obj={},i=0;i<arguments.length;i++){var o=arguments[i];for(var key in o)obj[key]=o[key]}return obj},this.timestamp=this.uuid=function(){return Date.now()+"xx-4xx-yxx-xxx".replace(/[xy]/g,(function(c){let r=16*Math.random()|0;return("x"==c?r:3&r|8).toString(16)}))},this.randomColor=function(){var color="#"+Math.floor(16777215*Math.random()).toString(16);return color.length<7&&(color=this.randomColor()),color},this.numberWithCommas=function(num){return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},this.padInt=function(num,digits,isLimit){isLimit&&(num=Math.min(num,Math.pow(10,digits)-1));let str=Math.floor(num).toString();return Math.pow(10,Math.max(0,digits-str.length)).toString().slice(1)+str},this.copyToClipboard=function(string){try{var el=document.createElement("textarea"),range=document.createRange();el.contentEditable=!0,el.readOnly=!0,el.value=string,document.body.appendChild(el),el.select(),range.selectNodeContents(el);var s=window.getSelection();return s.removeAllRanges(),s.addRange(range),el.setSelectionRange(0,string.length),document.execCommand("copy"),document.body.removeChild(el),!0}catch(e){return!1}},this.stringList=function(items=[],limit=0,options={}){if(0===items.length)return"";let output="",printed=0;"object"==typeof limit&&(options=limit,limit=0),options.oxford=!0===options.oxford,options.more=!1!==options.more&&(options.more?options.more:"more"),options.and=options.and?options.and:"&",options.comma=options.comma?options.comma:",",isNaN(options.limit)||(limit=options.limit),0===limit&&(limit=items.length);do{output=`${output}${items.shift()}${options.comma} `,printed++}while(items.length>1&&printed+1<limit);if(output=output.trim(),output=output.slice(0,output.length-1),1===items.length)output=`${output}${options.oxford&&printed>1?options.comma:""} ${options.and} ${items.shift()}`;else if(items.length>1&&options.more){let more=`${items.length} ${options.more}`;output=`${output}${options.oxford&&printed>1?options.comma:""} ${options.and} ${more}`}return output}}),"Static"),Class((function Render(){const _this=this,_render=[],_drawFrame=[],_multipliers=[];var _last=performance.now(),_localTSL=0,_elapsed=0,_capLast=0,_sampleRefreshRate=[],_firstSample=!1,rAF=requestAnimationFrame;function render(tsl){if(_this.capFPS>0){let delta=tsl-_capLast;if(_capLast=tsl,(_elapsed+=delta)<1e3/_this.capFPS)return rAF(render);_this.REFRESH_RATE=_this.capFPS,_this.HZ_MULTIPLIER=60/_this.REFRESH_RATE,_elapsed=0}if(_this.timeScaleUniform.value=1,_multipliers.length)for(let i=0;i<_multipliers.length;i++){let obj=_multipliers[i];_this.timeScaleUniform.value*=obj.value}_this.DT=tsl-_last,_last=tsl;let delta=_this.DT*_this.timeScaleUniform.value;if(delta=Math.min(200,delta),_this.startFrame&&_this.startFrame(tsl,delta),_sampleRefreshRate&&!_this.capFPS){let fps=1e3/_this.DT;if(_sampleRefreshRate.push(fps),_sampleRefreshRate.length>30){_sampleRefreshRate.sort((a,b)=>a-b);let rate=_sampleRefreshRate[Math.round(_sampleRefreshRate.length/2)];rate=_this.REFRESH_TABLE.reduce((prev,curr)=>Math.abs(curr-rate)<Math.abs(prev-rate)?curr:prev),_this.REFRESH_RATE=_firstSample?Math.max(_this.REFRESH_RATE,rate):rate,_this.HZ_MULTIPLIER=60/_this.REFRESH_RATE,_sampleRefreshRate=null,_firstSample=!0}}_this.TIME=tsl,_this.DELTA=delta,_localTSL+=delta;for(let i=_render.length-1;i>=0;i--){var callback=_render[i];if(callback)if(callback.fps){if(tsl-callback.last<1e3/callback.fps)continue;callback(++callback.frame),callback.last=tsl}else callback(tsl,delta);else _render.remove(callback)}for(let i=_drawFrame.length-1;i>-1;i--)_drawFrame[i](tsl,delta);_this.drawFrame&&_this.drawFrame(tsl,delta),_this.endFrame&&_this.endFrame(tsl,delta),THREAD||_this.isPaused||rAF(render)}this.timeScaleUniform={value:1,type:"f",ignoreUIL:!0},this.REFRESH_TABLE=[30,60,72,90,100,120,144,240],this.REFRESH_RATE=60,this.HZ_MULTIPLIER=1,this.capFPS=null,THREAD||(rAF(render),setInterval(_=>_sampleRefreshRate=[],3e3)),this.now=function(){return _localTSL},this.start=function(callback,fps){fps&&(callback.fps=fps,callback.last=-1/0,callback.frame=-1),~_render.indexOf(callback)||_render.unshift(callback)},this.stop=function(callback){_render.remove(callback)},this.tick=function(){THREAD&&(this.TIME=performance.now(),render(this.TIME))},this.Worker=function(_callback,_budget=4){Inherit(this,Component);let _scope=this,_elapsed=0;function loop(){for(;_elapsed<_budget;){if(_scope.dead)return;const start=performance.now();_callback&&_callback(),_elapsed+=performance.now()-start}_elapsed=0}this.startRender(loop),this.stop=function(){this.dead=!0,this.stopRender(loop)},this.pause=function(){this.stopRender(loop)},this.resume=function(){this.startRender(loop)}},this.pause=function(){_this.isPaused=!0},this.resume=function(){_this.isPaused&&(_this.isPaused=!1,rAF(render))},this.useRAF=function(raf){_firstSample=null,_last=performance.now(),(rAF=raf)(render)},this.onDrawFrame=function(cb){_drawFrame.push(cb)},this.setTimeScale=function(v){_this.timeScaleUniform.value=v},this.getTimeScale=function(){return _this.timeScaleUniform.value},this.createTimeMultiplier=function(){let obj={value:1};return _multipliers.push(obj),obj},this.destroyTimeMultiplier=function(obj){_multipliers.remove(obj)},this.tweenTimeScale=function(value,time,ease,delay){return tween(_this.timeScaleUniform,{value:value},time,ease,delay,null,null,!0)}}),"Static"),Class((function Timer(){const _this=this,_callbacks=[],_discard=[],_deferA=[],_deferB=[];var _defer=_deferA;function loop(t,delta){for(let i=_discard.length-1;i>=0;i--){let obj=_discard[i];obj.callback=null,_callbacks.remove(obj)}_discard.length&&(_discard.length=0);for(let i=_callbacks.length-1;i>=0;i--){let obj=_callbacks[i];obj?(obj.scaledTime?obj.current+=delta:obj.current+=Render.DT,obj.current>=obj.time&&(obj.callback&&obj.callback(),_discard.push(obj))):_callbacks.remove(obj)}for(let i=_defer.length-1;i>-1;i--)_defer[i]();_defer.length=0,_defer=_defer==_deferA?_deferB:_deferA}Render.start(loop),this.__clearTimeout=function(ref){const obj=function find(ref){for(let i=_callbacks.length-1;i>-1;i--)if(_callbacks[i].ref==ref)return _callbacks[i]}(ref);return!!obj&&(obj.callback=null,_callbacks.remove(obj),!0)},this.create=function(callback,time,scaledTime){if(window._NODE_)return setTimeout(callback,time);const obj={time:Math.max(1,time||1),current:0,ref:Utils.timestamp(),callback:callback,scaledTime:scaledTime};return _callbacks.unshift(obj),obj.ref},this.delayedCall=function(time){let promise=Promise.create();return _this.create(promise.resolve,time),promise},window.defer=this.defer=function(callback){if(!callback){callback=Promise.create().resolve}(_defer==_deferA?_deferB:_deferA).unshift(callback)}}),"static"),Class((function Events(){this.events={};const _e={},_linked=[];let _emitter;this.events.sub=function(obj,evt,callback){if("object"!=typeof obj&&(callback=evt,evt=obj,obj=null),!obj)return Events.emitter._addEvent(evt,callback.resolve?callback.resolve:callback,this),callback;let emitter=obj.events.emitter();return emitter._addEvent(evt,callback.resolve?callback.resolve:callback,this),emitter._saveLink(this),_linked.push(emitter),callback},this.events.unsub=function(obj,evt,callback){if("object"!=typeof obj&&(callback=evt,evt=obj,obj=null),!obj)return Events.emitter._removeEvent(evt,callback.resolve?callback.resolve:callback);obj.events.emitter()._removeEvent(evt,callback.resolve?callback.resolve:callback)},this.events.fire=function(evt,obj,isLocalOnly){(obj=obj||_e).target=this,Events.emitter._check(evt),_emitter&&_emitter._fireEvent(evt,obj)||isLocalOnly||Events.emitter._fireEvent(evt,obj)},this.events.bubble=function(obj,evt){let _this=this;_this.sub(obj,evt,e=>_this.fire(evt,e))},this.events.destroy=function(){return Events.emitter._destroyEvents(this),_linked&&_linked.forEach(emitter=>emitter._destroyEvents(this)),_emitter&&_emitter.links&&_emitter.links.forEach(obj=>obj.events&&obj.events._unlink(_emitter)),null},this.events.emitter=function(){return _emitter||(_emitter=Events.emitter.createLocalEmitter()),_emitter},this.events._unlink=function(emitter){_linked.remove(emitter)}}),()=>{Events.emitter=new function Emitter(){const prototype=Emitter.prototype;if(this.events=[],void 0!==prototype._check)return;prototype._check=function(evt){if(void 0===evt)throw"Undefined event"},prototype._addEvent=function(evt,callback,object){this._check(evt),this.events.push({evt:evt,object:object,callback:callback})},prototype._removeEvent=function(eventString,callback){this._check(eventString);let _this=this,marked=!1;for(let i=this.events.length-1;i>=0;i--)this.events[i].evt==eventString&&this.events[i].callback==callback&&(this.events[i].markedForDeletion=!0,marked=!0);marked&&defer(()=>_this._sweepEvents())},prototype._sweepEvents=function(){for(let i=0;i<this.events.length;i++)this.events[i].markedForDeletion&&this.events.remove(this.events[i])},prototype._fireEvent=function(eventString,obj){this._check&&this._check(eventString),obj=obj||_e;let called=!1;for(let i=0;i<this.events.length;i++){let evt=this.events[i];evt.evt!=eventString||evt.markedForDeletion||(evt.callback(obj),called=!0)}return called},prototype._destroyEvents=function(object){for(var i=this.events.length-1;i>=0;i--)this.events[i].object==object&&(this.events.splice(i,1)[0]=null)},prototype._saveLink=function(obj){this.links||(this.links=[]),~this.links.indexOf(obj)||this.links.push(obj)},prototype.createLocalEmitter=function(){return new Emitter}},Events.broadcast=Events.emitter._fireEvent,Events.VISIBILITY="hydra_visibility",Events.HASH_UPDATE="hydra_hash_update",Events.COMPLETE="hydra_complete",Events.PROGRESS="hydra_progress",Events.UPDATE="hydra_update",Events.LOADED="hydra_loaded",Events.END="hydra_end",Events.FAIL="hydra_fail",Events.SELECT="hydra_select",Events.ERROR="hydra_error",Events.READY="hydra_ready",Events.RESIZE="hydra_resize",Events.CLICK="hydra_click",Events.HOVER="hydra_hover",Events.MESSAGE="hydra_message",Events.ORIENTATION="orientation",Events.BACKGROUND="background",Events.BACK="hydra_back",Events.PREVIOUS="hydra_previous",Events.NEXT="hydra_next",Events.RELOAD="hydra_reload",Events.UNLOAD="hydra_unload",Events.FULLSCREEN="hydra_fullscreen";const _e={};Hydra.ready(()=>{!function(){let _last,_lastTime=performance.now();function onfocus(){Render.blurTime=-1,"focus"!=_last&&Events.emitter._fireEvent(Events.VISIBILITY,{type:"focus"}),_last="focus"}function onblur(){Render.blurTime=Date.now(),"blur"!=_last&&Events.emitter._fireEvent(Events.VISIBILITY,{type:"blur"}),_last="blur"}Timer.create((function addVisibilityHandler(){let hidden,eventName;if([["msHidden","msvisibilitychange"],["webkitHidden","webkitvisibilitychange"],["hidden","visibilitychange"]].forEach(d=>{void 0!==document[d[0]]&&(hidden=d[0],eventName=d[1])}),!eventName){const root="ie"==Device.browser?document:window;return root.onfocus=onfocus,void(root.onblur=onblur)}document.addEventListener(eventName,()=>{const time=performance.now();time-_lastTime>10&&(!1===document[hidden]?onfocus():onblur()),_lastTime=time})}),250),window.onbeforeunload=_=>(Events.emitter._fireEvent(Events.UNLOAD),null)}(),window.Stage=window.Stage||{},updateStage();let timer,iosResize="ios"===Device.system.os,html=!!iosResize&&document.querySelector("html"),delay=iosResize?500:16;function updateStage(){Stage.width=window.innerWidth||document.body.clientWidth||document.documentElement.offsetWidth,Stage.height=window.innerHeight||document.body.clientHeight||document.documentElement.offsetHeight}window.addEventListener("resize",(function handleResize(){clearTimeout(timer),timer=setTimeout(_=>{updateStage(),html&&Math.min(window.screen.width,window.screen.height)!==Stage.height&&(html.scrollTop=-1),Events.emitter._fireEvent(Events.RESIZE)},delay)})),Device.social&&(Stage.height>=screen.height||Stage.width>=screen.width)&&setTimeout(updateStage,1e3),window.onorientationchange=window.onresize,defer(window.onresize)})}),Class((function Device(){var vid,_this=this;this.agent=navigator.userAgent.toLowerCase(),this.detect=function(match){return this.agent.includes(match)},this.touchCapable=!!navigator.maxTouchPoints,this.pixelRatio=window.devicePixelRatio,this.system={},this.system.retina=window.devicePixelRatio>1,this.system.webworker=void 0!==window.Worker,window._NODE_||(this.system.geolocation=void 0!==navigator.geolocation),window._NODE_||(this.system.pushstate=void 0!==window.history.pushState),this.system.webcam=!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),this.system.language=window.navigator.userLanguage||window.navigator.language,this.system.webaudio=void 0!==window.AudioContext,this.system.xr=navigator.getVRDisplays||navigator.xr,this.system.exokit=_this.detect("exokit");try{this.system.localStorage=void 0!==window.localStorage}catch(e){this.system.localStorage=!1}this.system.fullscreen=document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled,this.system.os=_this.detect(["exokit"])&&"linux"==navigator.platform?"magicleap":_this.detect(["ipad","iphone","ios"])||_this.detect("mac")&&_this.touchCapable&&Math.max(screen.width,screen.height)<1370?"ios":_this.detect(["android","kindle"])?"android":_this.detect(["blackberry"])?"blackberry":_this.detect(["mac os"])?"mac":_this.detect(["windows","iemobile"])?"windows":_this.detect(["linux"])?"linux":"unknown",this.system.version=function(){try{if("ios"==_this.system.os){if(_this.agent.includes("intel mac")){let split=_this.agent.split("version/")[1].split(" ")[0].split(".");return Number(split[0]+"."+split[1])}var num=_this.agent.split("os ")[1].split("_"),main=num[0],sub=num[1].split(" ")[0];return Number(main+"."+sub)}if("android"==_this.system.os){var version=_this.agent.split("android ")[1].split(";")[0];return version.length>3&&(version=version.slice(0,-2)),"."==version.charAt(version.length-1)&&(version=version.slice(0,-1)),Number(version)}if("windows"==_this.system.os)return _this.agent.includes("rv:11")?11:Number(_this.agent.split("windows phone ")[1].split(";")[0])}catch(e){}return-1}(),this.system.browser="ios"==_this.system.os?_this.detect(["twitter","fbios"])?"social":_this.detect(["crios"])?"chrome":_this.detect(["safari"])?"safari":"unknown":"android"==_this.system.os?_this.detect(["twitter","fb","facebook"])?"social":_this.detect(["chrome"])?"chrome":_this.detect(["firefox"])?"firefox":"browser":_this.detect(["msie"])||_this.detect(["trident"])&&_this.detect(["rv:"])||_this.detect(["windows"])&&_this.detect(["edge"])?"ie":_this.detect(["chrome"])?"chrome":_this.detect(["safari"])?"safari":_this.detect(["firefox"])?"firefox":"unknown",this.system.browserVersion=function(){try{if("chrome"==_this.system.browser)return Number(_this.agent.split("chrome/")[1].split(".")[0]);if("firefox"==_this.system.browser)return Number(_this.agent.split("firefox/")[1].split(".")[0]);if("safari"==_this.system.browser)return Number(_this.agent.split("version/")[1].split(".")[0].split(".")[0]);if("ie"==_this.system.browser)return _this.detect(["msie"])?Number(_this.agent.split("msie ")[1].split(".")[0]):_this.detect(["rv:"])?Number(_this.agent.split("rv:")[1].split(".")[0]):Number(_this.agent.split("edge/")[1].split(".")[0])}catch(e){return-1}}(),this.mobile=!(window._NODE_||!("ontouchstart"in window)&&!("onpointerdown"in window)||!_this.system.os.includes(["ios","android","magicleap"]))&&{},this.mobile&&this.detect(["windows"])&&!this.detect(["touch"])&&(this.mobile=!1),this.mobile&&(this.mobile.tablet=Math.max(window.screen?screen.width:window.innerWidth,window.screen?screen.height:window.innerHeight)>1e3,this.mobile.phone=!this.mobile.tablet,this.mobile.pwa=!(!window.matchMedia||!window.matchMedia("(display-mode: standalone)").matches)||!!window.navigator.standalone,Hydra.ready(()=>{_this.mobile.native=!(!Mobile.NativeCore||!Mobile.NativeCore.active)||!!window._AURA_})),this.media={},this.media.audio=!!document.createElement("audio").canPlayType&&(_this.detect(["firefox","opera"])?"ogg":"mp3"),this.media.video=!!(vid=document.createElement("video")).canPlayType&&(vid.canPlayType("video/webm;")?"webm":"mp4"),this.media.webrtc=!!(window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection||window.oRTCPeerConnection||window.RTCPeerConnection),this.graphics={},this.graphics.webgl=function(){let DISABLED=!1;Object.defineProperty(_this.graphics,"webgl",{get:()=>{if(DISABLED)return!1;if(_this.graphics._webglContext)return _this.graphics._webglContext;try{const names=["webgl2","webgl","experimental-webgl"],canvas=document.createElement("canvas");let gl;for(let i=0;i<names.length&&(gl=canvas.getContext(names[i]),!gl);i++);let info=gl.getExtension("WEBGL_debug_renderer_info"),output={};if(info){let gpu=info.UNMASKED_RENDERER_WEBGL;output.gpu=gl.getParameter(gpu).toLowerCase()}return output.renderer=gl.getParameter(gl.RENDERER).toLowerCase(),output.version=gl.getParameter(gl.VERSION).toLowerCase(),output.glsl=gl.getParameter(gl.SHADING_LANGUAGE_VERSION).toLowerCase(),output.extensions=gl.getSupportedExtensions(),output.webgl2=output.version.includes(["webgl 2","webgl2"]),output.canvas=canvas,output.context=gl,output.detect=function(matches){if(output.gpu&&output.gpu.toLowerCase().includes(matches))return!0;if(output.version&&output.version.toLowerCase().includes(matches))return!0;for(let i=0;i<output.extensions.length;i++)if(output.extensions[i].toLowerCase().includes(matches))return!0;return!1},output.webgl2||output.detect("instance")||window.AURA||(DISABLED=!0),_this.graphics._webglContext=output,output}catch(e){return!1}},set:v=>{!1===v&&(DISABLED=!0)}})}(),this.graphics.metal=function(){if(!window.Metal)return!1;let output={};return output.gpu=Metal.device.getName().toLowerCase(),output.detect=function(matches){return output.gpu.includes(matches)},output}(),this.graphics.gpu=function(){if(!_this.graphics.webgl&&!_this.graphics.metal)return!1;let output={};return["metal","webgl"].forEach(name=>{_this.graphics[name]&&!output.identifier&&(output.detect=_this.graphics[name].detect,output.identifier=_this.graphics[name].gpu)}),output}(),this.graphics.canvas=!!document.createElement("canvas").getContext;const checkForStyle=function(){let _tagDiv;return function(prop){_tagDiv=_tagDiv||document.createElement("div");const vendors=["Khtml","ms","O","Moz","Webkit"];if(prop in _tagDiv.style)return!0;prop=prop.replace(/^[a-z]/,val=>val.toUpperCase());for(let i=vendors.length-1;i>=0;i--)if(vendors[i]+prop in _tagDiv.style)return!0;return!1}}();this.styles={},this.styles.filter=checkForStyle("filter"),this.styles.blendMode=checkForStyle("mix-blend-mode"),this.tween={},this.tween.transition=checkForStyle("transition"),this.tween.css2d=checkForStyle("transform"),this.tween.css3d=checkForStyle("perspective"),this.social=_this.agent.includes("instagram")?"instagram":_this.agent.includes("FBAN")||_this.agent.includes("FBAV")||_this.agent.includes("fb")?"facebook":(_this.agent.includes("twitter")||_this.agent.includes("Twitter")||!(!document.referrer||!document.referrer.includes("//t.co/")))&&"twitter"}),"Static"),Class((function Component(){Inherit(this,Events);const _this=this,_setters={},_flags={},_timers=[],_loops=[];var _postLoops,_onDestroy;function defineSetter(_this,prop){_setters[prop]={},Object.defineProperty(_this,prop,{set:function(v){_setters[prop]&&_setters[prop].s&&_setters[prop].s.call(_this,v),v=null},get:function(){if(_setters[prop]&&_setters[prop].g)return _setters[prop].g.apply(_this)}})}this.classes={},this.findParent=function(type){let p=_this.parent;for(;p;){if(p._cachedName||(p._cachedName=Utils.getConstructorName(p)),p._cachedName==type)return p;p=p.parent}},this.set=function(prop,callback){_setters[prop]||defineSetter(this,prop),_setters[prop].s=callback},this.get=function(prop,callback){_setters[prop]||defineSetter(this,prop),_setters[prop].g=callback},this.isPlayground=function(name){return Global.PLAYGROUND&&Global.PLAYGROUND==(name||Utils.getConstructorName(_this))},this.initClass=function(clss){if(!clss)throw"unable to locate class";const args=[].slice.call(arguments,1),child=Object.create(clss.prototype);if(child.parent=this,clss.apply(child,args),child.destroy){const id=Utils.timestamp();this.classes[id]=child,this.classes[id].__id=id}if(child.element){const last=arguments[arguments.length-1];Array.isArray(last)&&1==last.length&&last[0]instanceof HydraObject?last[0].add(child.element):this.element&&null!==last&&this.element.add(child.element)}if(child.group){const last=arguments[arguments.length-1];this.group&&null!==last&&this.group.add(child.group)}return child},this.delayedCall=function(callback,time,scaledTime){const timer=Timer.create(()=>{_this&&_this.destroy&&callback&&callback()},time,scaledTime);return _timers.push(timer),_timers.length>50&&_timers.shift(),timer},this.clearTimers=function(){for(let i=_timers.length-1;i>=0;i--)clearTimeout(_timers[i]);_timers.length=0},this.startRender=function(callback,fps,obj){"object"==typeof fps&&(obj=fps,fps=void 0);for(let i=0;i<_loops.length;i++)if(_loops[i].callback==callback)return;let flagInvisible=_=>{_this._invisible||(_this._invisible=!0,_this.onInvisible&&_this.onInvisible())},loop=(a,b,c,d)=>{if(!_this.startRender)return!1;let p=_this;for(;p;){if(!1===p.visible)return flagInvisible();if(p.group&&!1===p.group.visible)return flagInvisible();p=p.parent}return!1!==_this._invisible&&(_this._invisible=!1,_this.onVisible&&_this.onVisible()),callback(a,b,c,d),!0};_loops.push({callback:callback,loop:loop}),obj?(window.RenderManager&&obj==window.RenderManager&&(RenderManager.type==RenderManager.WEBVR?_this.events.sub(RenderManager.EYE_RENDER,loop):_this.events.sub(RenderManager.RENDER,loop)),window.Nuke&&obj instanceof window.Nuke?_this.events.sub(obj,Nuke.RENDER,loop):obj._onPostLoop&&obj._onPostLoop(loop)):Render.start(loop,fps)},this.postLoop=function(){_postLoops&&_postLoops.forEach(cb=>{!1===cb()&&_postLoops.remove(cb)})},this._onPostLoop=function(callback){_postLoops||(_postLoops=[]),_postLoops.push(callback)},this.onResize=function(callback){callback(),this.events.sub(Events.RESIZE,callback)},this.stopRender=function(callback,obj){for(let i=0;i<_loops.length;i++)if(_loops[i].callback==callback){let loop=_loops[i].loop;obj&&(window.RenderManager&&obj==window.RenderManager&&(RenderManager.type==RenderManager.WEBVR?_this.events.unsub(RenderManager.EYE_RENDER,loop):_this.events.unsub(RenderManager.RENDER,loop)),window.Nuke&&obj instanceof window.Nuke&&_this.events.unsub(obj,Nuke.RENDER,loop)),Render.stop(loop),_loops.splice(i,1)}},this.clearRenders=function(){for(let i=0;i<_loops.length;i++)Render.stop(_loops[i].loop);_loops.length=0},this.wait=function(object,key,callback){const promise=Promise.create();if("string"==typeof object&&(callback=key,key=object,object=_this),"number"==typeof object&&!key)return _this.delayedCall(promise.resolve,object),promise;if("function"==typeof object&&"function"!=typeof callback){let _object=object;object=key,key=callback,callback=_object}if(callback=callback||promise.resolve,object[key]||_this.flag(key))callback();else{Render.start((function test(){if(!object||!_this.flag)return Render.stop(test);(object[key]||_this.flag(key))&&(callback(),Render.stop(test))}))}return promise},this.flag=function(name,value,time){if(void 0===value)return _flags[name];_flags[name]=value,time&&(clearTimeout(_flags[name+"_timer"]),_flags[name+"_timer"]=this.delayedCall(()=>{_flags[name]=!_flags[name]},time))},this.destroy=function(){this.removeDispatch&&this.removeDispatch(),this.onDestroy&&this.onDestroy(),this.fxDestroy&&this.fxDestroy(),_onDestroy&&_onDestroy.forEach(cb=>cb());for(let id in this.classes){var clss=this.classes[id];clss&&clss.destroy&&clss.destroy()}return this.classes=null,this.clearRenders&&this.clearRenders(),this.clearTimers&&this.clearTimers(),this.element&&window.GLUI&&this.element instanceof GLUIObject&&this.element.remove(),this.events&&(this.events=this.events.destroy()),this.parent&&this.parent.__destroyChild&&this.parent.__destroyChild(this.__id),Utils.nullObject(this)},this._bindOnDestroy=function(cb){_onDestroy||(_onDestroy=[]),_onDestroy.push(cb)},this.__destroyChild=function(name){delete this.classes[name]}})),Class((function Model(){Inherit(this,Component),Namespace(this);const _this=this,_storage={};let _data=0,_triggered=0;this.push=function(name,val){_storage[name]=val},this.pull=function(name){return _storage[name]},this.waitForData=this.promiseData=function(num=1){_data+=num},this.fulfillData=this.resolveData=function(){_triggered++,_triggered==_data&&(_this.dataReady=!0)},this.ready=function(callback){let promise=Promise.create();return callback&&promise.then(callback),_this.wait(_this,"dataReady").then(promise.resolve),promise},this.initWithData=function(data){for(var key in _this.STATIC_DATA=data,_this){var model=_this[key],init=!1;for(var i in data)i.toLowerCase().replace(/-/g,"")==key.toLowerCase()&&(init=!0,model.init&&model.init(data[i]));!init&&model.init&&model.init()}_this.init&&_this.init(data)},this.loadData=function(url,callback){let promise=Promise.create();callback||(callback=promise.resolve);var _this=this;return get(url+"?"+Utils.timestamp()).then(d=>{defer(()=>{_this.initWithData(d),callback(d)})}),promise}})),Class((function Modules(){const _modules={},_constructors={};function exec(){for(let m in _modules)for(let key in _modules[m]){let module=_modules[m][key];module._ready||(module._ready=!0,module.exec&&module.exec())}}defer(exec),this.Module=function(module){let m=new module,name=module.toString().slice(0,100).match(/function ([^\(]+)/);name?(m._ready=!0,name=name[1],_modules[name]={index:m},_constructors[name]=module):(_modules[m.module]||(_modules[m.module]={}),_modules[m.module][m.path]=m)},this.require=function(path){let root;return path.includes("/")?(root=path.split("/")[0],path=path.replace(root+"/","")):(root=path,path="index"),function requireModule(root,path){let module=_modules[root];if(!module)throw`Module ${root} not found`;return module=module[path],module._ready||(module._ready=!0,module.exec&&module.exec()),module}(root,path).exports},this.getConstructor=function(name){return _constructors[name]},window.Module=this.Module,window._NODE_||(window.requireNative=window.require,window.require=this.require)}),"Static"),Class((function LinkedList(){var prototype=LinkedList.prototype;this.length=0,this.first=null,this.last=null,this.current=null,this.prev=null,void 0===prototype.push&&(prototype.push=function(obj){this.first?(obj.__next=this.first,obj.__prev=this.last,this.last.__next=obj,this.last=obj):(this.first=obj,this.last=obj,obj.__prev=obj,obj.__next=obj),this.length++},prototype.remove=function(obj){obj&&obj.__next&&(this.length<=1?this.empty():(obj==this.first?(this.first=obj.__next,this.last.__next=this.first,this.first.__prev=this.last):obj==this.last?(this.last=obj.__prev,this.last.__next=this.first,this.first.__prev=this.last):(obj.__prev.__next=obj.__next,obj.__next.__prev=obj.__prev),this.length--),obj.__prev=null,obj.__next=null)},prototype.empty=function(){this.first=null,this.last=null,this.current=null,this.prev=null,this.length=0},prototype.start=function(){return this.current=this.first,this.prev=this.current,this.current},prototype.next=function(){if(this.current&&(this.current=this.current.__next,1!=this.length&&this.prev.__next!=this.first))return this.prev=this.current,this.current},prototype.destroy=function(){return Utils.nullObject(this),null})})),Class((function ObjectPool(_type,_number=10){var _pool=[];this.array=_pool,function(){if(_type)for(var i=0;i<_number;i++)_pool.push(new _type)}(),this.get=function(){return _pool.shift()||(_type?new _type:null)},this.empty=function(){_pool.length=0},this.put=function(obj){obj&&_pool.push(obj)},this.insert=function(array){void 0===array.push&&(array=[array]);for(var i=0;i<array.length;i++)_pool.push(array[i])},this.length=function(){return _pool.length},this.randomize=function(){let array=_pool;for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}},this.destroy=function(){for(let i=_pool.length-1;i>=0;i--)_pool[i].destroy&&_pool[i].destroy();return _pool=null}})),Class((function Gate(){var _list=[],_map={};this.create=function(name){let promise=Promise.create();name?_map[name]=promise:_list.push(promise)},this.open=function(name){name&&(_map[name]||(_map[name]=Promise.create()),_map[name].resolve());let promise=_list.shift();promise&&promise.resolve()},this.wait=function(name){return _list.length||name?name?(_map[name]||(_map[name]=Promise.create()),_map[name]):_list[_list.length-1]||Promise.resolve():Promise.resolve()}}),"static"),Class((function Assets(){const _this=this;function AssetList(arr){return arr.__proto__=AssetList.prototype,arr}this.__loaded=[],this.FLIPY=!0,this.CDN="",this.CORS="anonymous",this.IMAGES={},this.VIDEOS={},this.AUDIOS={},this.SDF={},this.JSON={push:function(prop,value){this[prop]=value,Object.defineProperty(this,prop,{get:()=>JSON.parse(JSON.stringify(value))})}},Object.defineProperty(this.JSON,"push",{enumerable:!1,writable:!0}),this.SVG={},AssetList.prototype=new Array,AssetList.prototype.filter=function(items){for(let i=this.length-1;i>=0;i--)this[i].includes(items)||this.splice(i,1);return this},AssetList.prototype.exclude=function(items){for(let i=this.length-1;i>=0;i--)this[i].includes(items)&&this.splice(i,1);return this},AssetList.prototype.prepend=function(prefix){for(let i=this.length-1;i>=0;i--)this[i]=prefix+this[i];return this},AssetList.prototype.append=function(suffix){for(let i=this.length-1;i>=0;i--)this[i]=this[i]+suffix;return this},this.list=function(){return window.ASSETS||console.warn("ASSETS list not available"),new AssetList(window.ASSETS.slice(0)||[])},this.BASE_PATH="",this.getPath=function(path){if(path.includes("~"))return _this.BASE_PATH+path.replace("~","");if(path.includes("//"))return path;if(path=function parseResolution(path){if(!window.ASSETS||!ASSETS.RES)return path;var res=ASSETS.RES[path],ratio=Math.min(Device.pixelRatio,3);if(!res)return path;if(!res["x"+ratio])return path;var split=path.split("/"),file=split[split.length-1];return split=file.split("."),path.replace(file,split[0]+"-"+ratio+"x."+split[1])}(path),_this.dictionary)for(let pathKey in _this.dictionary)if(_this.dictionary[pathKey].includes(path.split("?")[0]))return pathKey+path;return this.CDN&&!~path.indexOf(this.CDN)&&(path=this.CDN+path),path},this.registerPath=function(path,assets){_this.dictionary||(_this.dictionary={}),_this.dictionary[path]=assets},this.loadImage=function(path,isStore){var img=new Image;return img.crossOrigin=this.CORS,img.src=_this.getPath(path),img.loadPromise=function(){let promise=Promise.create();return img.onload=promise.resolve,promise},isStore&&(this.IMAGES[path]=img),img},this.decodeImage=function(path,params){let promise=Promise.create(),img=_this.loadImage(path);return img.onload=()=>promise.resolve(img),img.onerror=()=>promise.reject(),promise}}),"static"),Class((function AssetLoader(_assets,_callback,ASSETS=Assets){Inherit(this,Events);const _this=this;let _total=_assets.length,_loaded=0,_lastFiredPercent=0;function loadAsset(){let path=_assets.splice(_assets.length-1,1)[0];const name=path.split("assets/").last().split(".")[0],ext=path.split(".").last().split("?")[0].toLowerCase();let timeout=Timer.create(timedOut,AssetLoader.TIMEOUT,path);if(!Assets.preventCache&&~Assets.__loaded.indexOf(path))return loaded();if(ext.includes(["jpg","jpeg","png","gif"])){let image=ASSETS.loadImage(path);return image.complete?loaded():(image.onload=loaded,void(image.onerror=loaded))}function loaded(){timeout&&clearTimeout(timeout),increment(),_assets.length&&loadAsset()}ext.includes(["mp4","webm"])?fetch(path).then(async response=>{let blob=await response.blob();Assets.VIDEOS[name]=URL.createObjectURL(blob),loaded()}).catch(e=>{console.warn(e),loaded()}):ext.includes(["mp3"])?fetch(path).then(async response=>{let blob=await response.blob();Assets.AUDIOS[name]=URL.createObjectURL(blob),loaded()}).catch(e=>{console.warn(e),loaded()}):get(Assets.getPath(path),Assets.HEADERS).then(data=>{Assets.__loaded.push(path),"json"==ext&&ASSETS.JSON.push(name,data),"svg"==ext&&(ASSETS.SVG[name]=data),"fnt"==ext&&(ASSETS.SDF[name.split("/")[1]]=data),"js"==ext&&window.eval(data),ext.includes(["fs","vs","glsl"])&&window.Shaders&&Shaders.parse(data,path),loaded()}).catch(e=>{console.warn(e),loaded()})}function increment(){let percent=Math.max(_lastFiredPercent,Math.min(1,++_loaded/_total));_this.events.fire(Events.PROGRESS,{percent:percent}),_lastFiredPercent=percent,_loaded>=_total&&defer(complete)}function complete(){_this.completed||(_this.completed=!0,defer(()=>{_callback&&_callback(),_this.events.fire(Events.COMPLETE)}))}function timedOut(path){console.warn("Asset timed out",path)}!function(){if(!Array.isArray(_assets))throw"AssetLoader requires array of assets to load";_assets=_assets.slice(0).reverse(),function init(){if(!_assets.length)return complete();for(let i=0;i<AssetLoader.SPLIT;i++)_assets.length&&loadAsset()}()}(),this.loadModules=function(){if(!window._BUILT_)return;this.add(1);let module=window._ES5_?"es5-modules":"modules",s=document.createElement("script");return s.src="assets/js/"+module+".js?"+window._CACHE_,s.async=!0,document.head.appendChild(s),AssetLoader.waitForLib("_MODULES_").then(_=>_this.trigger(1))},this.add=function(num){_total+=num||1},this.trigger=function(num){for(let i=0;i<(num||1);i++)increment()}}),()=>{AssetLoader.SPLIT=2,AssetLoader.TIMEOUT=5e3,AssetLoader.loadAllAssets=function(callback){let promise=Promise.create();return callback||(callback=promise.resolve),promise.loader=new AssetLoader(Assets.list(),()=>{callback&&callback(),promise.loader&&promise.loader.destroy&&(promise.loader=promise.loader.destroy())}),promise},AssetLoader.loadAssets=function(list,callback){let promise=Promise.create();return callback||(callback=promise.resolve),promise.loader=new AssetLoader(list,()=>{callback&&callback(),promise.loader&&promise.loader.destroy&&(promise.loader=promise.loader.destroy())}),promise},AssetLoader.waitForLib=function(name,callback){let promise=Promise.create();return callback||(callback=promise.resolve),Render.start((function check(){window[name]&&(Render.stop(check),callback&&callback())})),promise},AssetLoader.waitForModules=function(){return AssetLoader.waitForLib(window._BUILT_?"_MODULES_":"zUtils3D")}}),Hydra.ready((function(){window.__window=$(window),window.__document=$(document),window.__body=$(document.getElementsByTagName("body")[0]),window.Stage=window.Stage&&window.Stage.style?$(window.Stage):__body.create("#Stage"),Stage.size("100%"),Stage.__useFragment=!0,Stage.width=window.innerWidth||document.body.clientWidth||document.documentElement.offsetWidth,Stage.height=window.innerHeight||document.body.clientHeight||document.documentElement.offsetHeight})),Class((function CSS(){var _obj,_style,_needsUpdate,_this=this;function objToCSS(key){var match=key.match(/[A-Z]/),camelIndex=match?match.index:null;if(camelIndex){var start=key.slice(0,camelIndex),end=key.slice(camelIndex);key=start+"-"+end.toLowerCase()}return key}function cssToObj(key){var match=key.match(/\-/),camelIndex=match?match.index:null;if(camelIndex){var start=key.slice(0,camelIndex),end=key.slice(camelIndex).slice(1),letter=end.charAt(0);end=end.slice(1),key=start+(end=letter.toUpperCase()+end)}return key}function setHTML(){_obj.innerHTML=_style,_needsUpdate=!1}Hydra.ready((function(){_style="",(_obj=document.createElement("style")).type="text/css",document.getElementsByTagName("head")[0].appendChild(_obj)})),this._read=function(){return _style},this._write=function(css){_style=css,_needsUpdate||(_needsUpdate=!0,defer(setHTML))},this.style=function(selector,obj){var s=selector+" {";for(var key in obj){var prop=objToCSS(key),val=obj[key];"string"!=typeof val&&"opacity"!=key&&(val+="px"),s+=prop+":"+val+"!important;"}s+="}",_this._write(_style+s)},this.get=function(selector,prop){for(var values=new Object,string=_obj.innerHTML.split(selector+" {"),i=0;i<string.length;i++){var str=string[i];if(str.length){var split=str.split("!important;");for(var j in split)if(split[j].includes(":")){var fsplit=split[j].split(":");"px"==fsplit[1].slice(-2)&&(fsplit[1]=Number(fsplit[1].slice(0,-2))),values[cssToObj(fsplit[0])]=fsplit[1]}}}return prop?values[prop]:values},this.textSize=function($obj){var $clone=$obj.clone();$clone.css({position:"relative",cssFloat:"left",styleFloat:"left",marginTop:-99999,width:"",height:""}),__body.addChild($clone);var width=$clone.div.offsetWidth,height=$clone.div.offsetHeight;return $clone.remove(),{width:width,height:height}},this.prefix=function(style){return""==_this.styles.vendor?style.charAt(0).toLowerCase()+style.slice(1):_this.styles.vendor+style},this._toCSS=objToCSS}),"Static"),Class((function HydraObject(_selector,_type,_exists,_useFragment){this._children=new LinkedList,this.__useFragment=_useFragment,this._initSelector(_selector,_type,_exists)}),()=>{var prototype=HydraObject.prototype;prototype._initSelector=function(_selector,_type,_exists){if(_selector&&"string"!=typeof _selector)this.div=_selector;else{var first=_selector?_selector.charAt(0):null,name=_selector?_selector.slice(1):null;if("."!=first&&"#"!=first&&(name=_selector,first="."),_exists){if("#"!=first)throw"Hydra Selectors Require #ID";this.div=document.getElementById(name)}else this._type=_type||"div","svg"==this._type?(this.div=document.createElementNS("http://www.w3.org/2000/svg",this._type),this.div.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink")):(this.div=document.createElement(this._type),first&&("#"==first?this.div.id=name:this.div.className=name))}this.div.hydraObject=this},prototype.add=function(child){var div=this.div,_this=this,createFrag=function(){_this.__useFragment&&(_this._fragment||(_this._fragment=document.createDocumentFragment(),defer((function(){if(!_this._fragment||!_this.div)return _this._fragment=null;_this.div.appendChild(_this._fragment),_this._fragment=null}))),div=_this._fragment)};return child.element&&child.element instanceof HydraObject?(createFrag(),div.appendChild(child.element.div),this._children.push(child.element),child.element._parent=this,child.element.div.parentNode=this.div):child.div?(createFrag(),div.appendChild(child.div),this._children.push(child),child._parent=this,child.div.parentNode=this.div):child.nodeName&&(createFrag(),div.appendChild(child),child.parentNode=this.div),this},prototype.clone=function(){return $(this.div.cloneNode(!0))},prototype.create=function(name,type){var $obj=$(name,type);return this.add($obj),$obj},prototype.empty=function(){for(var child=this._children.start();child;)child&&child.remove&&child.remove(),child=this._children.next();return this.div.innerHTML="",this},prototype.parent=function(){return this._parent},prototype.children=function(){return this.div.children?this.div.children:this.div.childNodes},prototype.removeChild=function(object,keep){try{object.div.parentNode.removeChild(object.div)}catch(e){}keep||this._children.remove(object)},prototype.remove=prototype.destroy=function(){this.removed=!0;var parent=this._parent;parent&&!parent.removed&&parent.removeChild&&parent.removeChild(this,!0);for(var child=this._children.start();child;)child&&child.remove&&child.remove(),child=this._children.next();this._children.destroy(),this.div.hydraObject=null,Utils.nullObject(this)},window.$=function(selector,type,exists){return new HydraObject(selector,type,exists)},$.fn=HydraObject.prototype}),$.fn.text=function(text){return void 0!==text?(this.__cacheText!=text&&(this.div.textContent=text),this.__cacheText=text,this):this.div.textContent},$.fn.html=function(text,force){return!text||text.includes("<")||force?void 0!==text?(this.div.innerHTML=text,this):this.div.innerHTML:this.text(text)},$.fn.hide=function(){return this.div.style.display="none",this},$.fn.show=function(){return this.div.style.display="",this},$.fn.visible=function(){return this.div.style.visibility="visible",this},$.fn.invisible=function(){return this.div.style.visibility="hidden",this},$.fn.setZ=function(z){return this.div.style.zIndex=z,this},$.fn.clearAlpha=function(){return this.div.style.opacity="",this},$.fn.size=function(w,h,noScale){return"string"==typeof w?(void 0===h?h="100%":"string"!=typeof h&&(h+="px"),this.div.style.width=w,this.div.style.height=h):(this.div.style.width=w+"px",this.div.style.height=h+"px",noScale||(this.div.style.backgroundSize=w+"px "+h+"px")),this.width=w,this.height=h,this},$.fn.mouseEnabled=function(bool){return this.div.style.pointerEvents=bool?"auto":"none",this},$.fn.fontStyle=function(family,size,color,style){var font={};return family&&(font.fontFamily=family),size&&(font.fontSize=size),color&&(font.color=color),style&&(font.fontStyle=style),this.css(font),this},$.fn.font=function(font){return this.css("font",font),this},$.fn.bg=function(src,x,y,repeat){return src?(src.includes(".")&&(src=Assets.getPath(src)),src.includes(".")?this.div.style.backgroundImage="url("+src+")":this.div.style.backgroundColor=src,void 0!==x&&(x="number"==typeof x?x+"px":x,y="number"==typeof y?y+"px":y,this.div.style.backgroundPosition=x+" "+y),repeat&&(this.div.style.backgroundSize="",this.div.style.backgroundRepeat=repeat),"cover"!=x&&"contain"!=x||(this.div.style.backgroundSize=x,this.div.style.backgroundPosition=void 0!==y?y+" "+repeat:"center"),this):this},$.fn.center=function(x,y,noPos){var css={};return void 0===x?(css.left="50%",css.top="50%",css.marginLeft=-this.width/2,css.marginTop=-this.height/2):(x&&(css.left="50%",css.marginLeft=-this.width/2),y&&(css.top="50%",css.marginTop=-this.height/2)),noPos&&(delete css.left,delete css.top),this.css(css),this},$.fn.max=function(width,height){let w,h;return void 0!==width&&(w="number"==typeof width?width+"px":width,this.div.style.maxWidth=w),void 0!==height?(h="number"==typeof height?height+"px":height,this.div.style.maxHeight=h):(h=w,this.div.style.maxHeight=h),this},$.fn.min=function(width,height){let w,h;return void 0!==width&&(w="number"==typeof width?width+"px":width,this.div.style.minWidth=w),void 0!==height?(h="number"==typeof height?height+"px":height,this.div.style.minHeight=h):(h=w,this.div.style.minHeight=h),this},$.fn.flex=function(inline){return this.div.style.display=inline?"inline-flex":"flex",this.div.style.justifyContent="center",this.div.style.alignItems="center",this.div.classList.add("relative-children"),this},$.fn.order=function(opts={}){let s=this.div.style;return"none"===opts.flexWrap&&(opts.flexWrap="nowrap"),opts.direction&&(s.flexDirection=opts.direction),opts.wrap&&(s.flexWrap=opts.wrap),opts.order&&(s.order=opts.order),this},$.fn.align=function(opts={}){let s=this.div.style;function flex(str,contentMode=!1){return"start"===str?"flex-start":"end"===str?"flex-end":"between"===str?contentMode?"space-between":"flex-between":"around"===str?contentMode?"space-around":"flex-around":"none"===str?"nowrap":str}return opts.justify&&(s.justifyContent=flex(opts.justify)),opts.items&&(s.alignItems=flex(opts.items)),opts.self&&(s.alignSelf=flex(opts.self)),opts.content&&(s.alignContent=flex(opts.content,!0)),this},$.fn.flexibility=function(opts={}){let s=this.div.style;return"undefined"!==opts.grow&&(s.flexGrow=opts.grow),"undefined"!==opts.shrink&&(s.flexGrow=opts.shrink),void 0!==opts.basis&&(s.flexBasis="number"==typeof opts.basis?opts.basis+"px":opts.basis),this},$.fn.mask=function(arg){let maskPrefix="Moz"===CSS.styles.vendor?"mask":CSS.prefix("Mask");return this.div.style[maskPrefix]=(arg.includes(".")?"url("+arg+")":arg)+" no-repeat",this.div.style[maskPrefix+"Size"]="contain",this},$.fn.blendMode=function(mode,bg){return bg?this.div.style["background-blend-mode"]=mode:this.div.style["mix-blend-mode"]=mode,this},$.fn.css=function(obj,value){if("boolean"==typeof value&&(value=null),"object"!=typeof obj){if(value)return this.div.style[obj]=value,this;var style=this.div.style[obj];if("number"!=typeof style){if(!style)return!1;style.includes("px")&&(style=Number(style.slice(0,-2))),"opacity"==obj&&(style=isNaN(Number(this.div.style.opacity))?1:Number(this.div.style.opacity))}return style||(style=0),style}for(var type in TweenManager._clearCSSTween(this),obj){var val=obj[type];"string"!=typeof val&&"number"!=typeof val||("string"!=typeof val&&"opacity"!=type&&"zIndex"!=type&&(val+="px"),this.div.style[type]=val)}return this},$.fn.transform=function(props){if(!(this.multiTween&&this.cssTweens&&this._cssTweens.length>1&&this.__transformTime&&Render.TIME-this.__transformTime<15)){if(this.__transformTime=Render.TIME,TweenManager._clearCSSTween(this),Device.tween.css2d){if(props)for(var key in props)"number"==typeof props[key]&&(this[key]=props[key]);else props=this;var transformString=TweenManager._parseTransform(props);this.__transformCache!=transformString&&(this.div.style[CSS.styles.vendorTransform]=transformString,this.__transformCache=transformString)}return this}},$.fn.willChange=function(props){if("boolean"==typeof props)this._willChangeLock=!0===props;else if(this._willChangeLock)return;var string="string"==typeof props;this._willChange&&!string||"null"==typeof props?(this._willChange=!1,this.div.style["will-change"]=""):(this._willChange=!0,this.div.style["will-change"]=string?props:CSS.transformProperty+", opacity")},$.fn.backfaceVisibility=function(visible){this.div.style[CSS.prefix("BackfaceVisibility")]=visible?"visible":"hidden"},$.fn.enable3D=function(perspective,x,y){return Device.tween.css3d?(this.div.style[CSS.prefix("TransformStyle")]="preserve-3d",perspective&&(this.div.style[CSS.prefix("Perspective")]=perspective+"px"),void 0!==x&&(x="number"==typeof x?x+"px":x,y="number"==typeof y?y+"px":y,this.div.style[CSS.prefix("PerspectiveOrigin")]=x+" "+y),this):this},$.fn.disable3D=function(){return this.div.style[CSS.prefix("TransformStyle")]="",this.div.style[CSS.prefix("Perspective")]="",this},$.fn.transformPoint=function(x,y,z){var origin="";return void 0!==x&&(origin+="number"==typeof x?x+"px ":x+" "),void 0!==y&&(origin+="number"==typeof y?y+"px ":y+" "),void 0!==z&&(origin+="number"==typeof z?z+"px":z),this.div.style[CSS.prefix("TransformOrigin")]=origin,this},$.fn.tween=function(props,time,ease,delay,callback,manual){"boolean"==typeof delay?(manual=delay,delay=0,callback=null):"function"==typeof delay&&(callback=delay,delay=0),"boolean"==typeof callback&&(manual=callback,callback=null),delay||(delay=0);var usePromise=null;callback&&callback instanceof Promise&&(usePromise=callback,callback=callback.resolve);var tween=TweenManager._detectTween(this,props,time,ease,delay,callback,manual);return usePromise||tween},$.fn.clearTransform=function(){return"number"==typeof this.x&&(this.x=0),"number"==typeof this.y&&(this.y=0),"number"==typeof this.z&&(this.z=0),"number"==typeof this.scale&&(this.scale=1),"number"==typeof this.scaleX&&(this.scaleX=1),"number"==typeof this.scaleY&&(this.scaleY=1),"number"==typeof this.rotation&&(this.rotation=0),"number"==typeof this.rotationX&&(this.rotationX=0),"number"==typeof this.rotationY&&(this.rotationY=0),"number"==typeof this.rotationZ&&(this.rotationZ=0),"number"==typeof this.skewX&&(this.skewX=0),"number"==typeof this.skewY&&(this.skewY=0),this.div.style[CSS.styles.vendorTransform]="",this},$.fn.clearTween=function(){return this._cssTween&&this._cssTween.stop(),this._mathTween&&this._mathTween.stop(),this},$.fn.stopTween=function(){return console.warn(".stopTween deprecated. use .clearTween instead"),this.clearTween()},$.fn.keypress=function(callback){this.div.onkeypress=function(e){(e=e||window.event).code=e.keyCode?e.keyCode:e.charCode,callback&&callback(e)}},$.fn.keydown=function(callback){this.div.onkeydown=function(e){(e=e||window.event).code=e.keyCode,callback&&callback(e)}},$.fn.keyup=function(callback){this.div.onkeyup=function(e){(e=e||window.event).code=e.keyCode,callback&&callback(e)}},$.fn.attr=function(attr,value){return"string"!=typeof attr?this:void 0===value?this.div.getAttribute(attr):(!1===value||null===value?this.div.removeAttribute(attr):this.div.setAttribute(attr,value),this)},$.fn.val=function(value){return void 0===value?this.div.value:(this.div.value=value,this)},$.fn.change=function(callback){var _this=this;this.div.onchange=function(){callback({object:_this,value:_this.div.value||""})}},$.fn.svgSymbol=function(id,width,height){var config=SVG.getSymbolConfig(id),svgHTML='<svg viewBox="0 0 '+config.width+" "+config.height+'" width="'+width+'" height="'+height+'"><use xlink:href="#'+config.id+'" x="0" y="0" /></svg>';this.html(svgHTML,!0)},$.fn.svg=async function(url){let promise=Promise.create();return fetch(url).then(async res=>{let svgHTML=await res.text();this.html(svgHTML,!0),promise.resolve()}),promise},$.fn.overflowScroll=function(dir){var x=!!dir.x,y=!!dir.y,overflow={};(!x&&!y||x&&y)&&(overflow.overflow="auto"),!x&&y&&(overflow.overflowY="auto",overflow.overflowX="hidden"),x&&!y&&(overflow.overflowX="auto",overflow.overflowY="hidden"),Device.mobile&&(overflow["-webkit-overflow-scrolling"]="touch",Mobile._addOverflowScroll(this)),this.css(overflow)},$.fn.removeOverflowScroll=function(){this.css({overflow:"hidden",overflowX:"",overflowY:"","-webkit-overflow-scrolling":""}),Device.mobile&&Mobile._removeOverflowScroll(this)},$.fn.accessible=function(type="label",tabIndex=-1){switch(tabIndex>-1&&this.attr("tabindex",tabIndex),type){case"label":this.attr("aria-label",this.div.textContent);break;case"hidden":this.attr("aria-hidden",!0)}},$.fn.tabIndex=function(tabIndex){this.attr("tabindex",tabIndex)},$.fn.cursor=function(cursor,lock){lock&&(this.cursorLock||(this.cursorLock=new Map),"auto"==cursor?this.cursorLock.delete(lock):this.cursorLock.set(lock,cursor)),this.cursorLock&&"auto"==cursor&&this.cursorLock.forEach(v=>{cursor=v}),this.css("cursor",cursor)},function(){var windowsPointer=!!window.MSGesture,translateEvent=function(evt){if(windowsPointer)switch(evt){case"touchstart":return"pointerdown";case"touchmove":return"MSGestureChange";case"touchend":return"pointerup"}return evt},convertTouchEvent=function(e){var touchEvent={x:0,y:0};if(e.windowsPointer)return e;if(!e)return touchEvent;if(e.touches||e.changedTouches?e.touches.length?(touchEvent.x=e.touches[0].pageX,touchEvent.y=e.touches[0].pageY):(touchEvent.x=e.changedTouches[0].pageX,touchEvent.y=e.changedTouches[0].pageY):(touchEvent.x=e.pageX,touchEvent.y=e.pageY),Mobile.ScreenLock&&Mobile.ScreenLock.isActive&&Mobile.orientationSet&&Mobile.orientation!==Mobile.orientationSet){if(90==window.orientation||0===window.orientation){var x=touchEvent.y;touchEvent.y=touchEvent.x,touchEvent.x=Stage.width-x}if(-90==window.orientation||180===window.orientation){var y=touchEvent.x;touchEvent.x=touchEvent.y,touchEvent.y=Stage.height-y}}return touchEvent};$.fn.click=function(callback){var _this=this;return this.div.addEventListener(translateEvent("click"),(function click(e){return!!_this.div&&(!Mouse._preventClicks&&(e.object="hit"==_this.div.className?_this.parent():_this,e.action="click",e.pageX||(e.pageX=e.clientX,e.pageY=e.clientY),callback&&callback(e),void(Mouse.autoPreventClicks&&Mouse.preventClicks())))}),!0),this.div.style.cursor="pointer",this},$.fn.hover=function(callback){var _time,_this=this,_over=!1;function hover(e){if(!_this.div)return!1;var time=performance.now(),original=e.toElement||e.relatedTarget;if(_time&&time-_time<5)return _time=time,!1;switch(_time=time,e.object="hit"==_this.div.className?_this.parent():_this,e.type){case"mouseout":case"mouseleave":e.action="out";break;default:e.action="over"}if(_over){if(Mouse._preventClicks)return!1;if("over"==e.action)return!1;if("out"==e.action&&function isAChild(div,object){for(var len=div.children.length-1,i=len;i>-1;i--)if(object==div.children[i])return!0;for(i=len;i>-1;i--)if(isAChild(div.children[i],object))return!0}(_this.div,original))return!1;_over=!1}else{if("out"==e.action)return!1;_over=!0}e.pageX||(e.pageX=e.clientX,e.pageY=e.clientY),callback&&callback(e)}return this.div.addEventListener(translateEvent("mouseover"),hover,!0),this.div.addEventListener(translateEvent("mouseout"),hover,!0),this},$.fn.press=function(callback){var _this=this;function press(e){if(!_this.div)return!1;switch(e.object="hit"==_this.div.className?_this.parent():_this,e.type){case"mousedown":e.action="down";break;default:e.action="up"}e.pageX||(e.pageX=e.clientX,e.pageY=e.clientY),callback&&callback(e)}return this.div.addEventListener(translateEvent("mousedown"),press,!0),this.div.addEventListener(translateEvent("mouseup"),press,!0),this},$.fn.bind=function(evt,callback){if(this._events=this._events||{},windowsPointer&&this==__window)return Stage.bind(evt,callback);"touchstart"==evt?Device.mobile||(Device.touchCapable?this.bind("mousedown",callback):evt="mousedown"):"touchmove"==evt?(Device.mobile||(Device.touchCapable?this.bind("mousemove",callback):evt="mousemove"),windowsPointer&&!this.div.msGesture&&(this.div.msGesture=new MSGesture,this.div.msGesture.target=this.div)):"touchend"==evt&&(Device.mobile||(Device.touchCapable?this.bind("mouseup",callback):evt="mouseup")),this._events["bind_"+evt]=this._events["bind_"+evt]||[];var _events=this._events["bind_"+evt],e={},target=this.div;function touchEvent(e){windowsPointer&&target.msGesture&&"touchstart"==evt&&target.msGesture.addPointer(e.pointerId),Device.mobile||"touchstart"!=evt||e.preventDefault();var touch=convertTouchEvent(e);if(windowsPointer){var windowsEvt=e;(e={}).x=Number(windowsEvt.pageX||windowsEvt.clientX),e.y=Number(windowsEvt.pageY||windowsEvt.clientY),e.target=windowsEvt.target,e.currentTarget=windowsEvt.currentTarget,e.path=[];for(var node=e.target;node;)e.path.push(node),node=node.parentElement||null;e.windowsPointer=!0}else e.x=touch.x,e.y=touch.y;for(var i=0;i<_events.length;i++){var ev=_events[i];ev.target==e.currentTarget&&ev.callback(e)}}return e.callback=callback,e.target=this.div,_events.push(e),this._events["fn_"+evt]||(this._events["fn_"+evt]=touchEvent,this.div.addEventListener(translateEvent(evt),touchEvent,{capture:!0,passive:!1})),this},$.fn.unbind=function(evt,callback){if(this._events=this._events||{},windowsPointer&&this==__window)return Stage.unbind(evt,callback);"touchstart"==evt?Device.mobile||(Device.touchCapable?this.unbind("mousedown",callback):evt="mousedown"):"touchmove"==evt?Device.mobile||(Device.touchCapable?this.unbind("mousemove",callback):evt="mousemove"):"touchend"==evt&&(Device.mobile||(Device.touchCapable?this.unbind("mouseup",callback):evt="mouseup"));var _events=this._events["bind_"+evt];if(!_events)return this;for(var i=0;i<_events.length;i++){_events[i].callback==callback&&_events.splice(i,1)}return this._events["fn_"+evt]&&!_events.length&&(this.div.removeEventListener(translateEvent(evt),this._events["fn_"+evt],!Device.mobile||{passive:!0}),this._events["fn_"+evt]=null),this},$.fn.interact=function(overCallback,clickCallback,seoLink,seoText){this.hit||(this.hit=$(".hit",seoLink?"a":void 0),this.hit.css({width:"100%",height:"100%",zIndex:99999,top:0,left:0,position:"absolute"}),this.add(this.hit),seoLink&&(this.hit.attr("href",Hydra.absolutePath(seoLink)),this.hit.text(seoText||this.div.textContent),this.hit.css({fontSize:0}),this.hit.accessible(),this.hit.div.onfocus=_=>overCallback({action:"over"}),this.hit.div.onblur=_=>overCallback({action:"out"}),this.hit.div.onclick=e=>{e.preventDefault(),clicked(e)}));let time=Render.TIME;function clicked(e){clickCallback&&Render.TIME-time>100&&clickCallback(e),time=Render.TIME}Device.mobile?this.hit.touchClick(overCallback,clicked).click(clicked):this.hit.hover(overCallback).click(clicked)},$.fn.touchSwipe=function(callback,distance){if(!window.addEventListener)return this;var _startX,_startY,_this=this,_distance=distance||75,_moving=!1,_move={};function touchMove(e){if(!_this.div)return!1;if(_moving){var touch=convertTouchEvent(e),dx=_startX-touch.x,dy=_startY-touch.y;_move.direction=null,_move.moving=null,_move.x=null,_move.y=null,_move.evt=e,Math.abs(dx)>=_distance?(touchEnd(),_move.direction=dx>0?"left":"right"):Math.abs(dy)>=_distance?(touchEnd(),_move.direction=dy>0?"up":"down"):(_move.moving=!0,_move.x=dx,_move.y=dy),callback&&callback(_move,e)}}function touchEnd(e){if(!_this.div)return!1;_startX=_startY=_moving=!1,_this.div.removeEventListener(translateEvent("touchmove"),touchMove)}return Device.mobile&&(this.div.addEventListener(translateEvent("touchstart"),(function touchStart(e){var touch=convertTouchEvent(e);if(!_this.div)return!1;1==e.touches.length&&(_startX=touch.x,_startY=touch.y,_moving=!0,_this.div.addEventListener(translateEvent("touchmove"),touchMove,{passive:!0}))}),{passive:!0}),this.div.addEventListener(translateEvent("touchend"),touchEnd,{passive:!0}),this.div.addEventListener(translateEvent("touchcancel"),touchEnd,{passive:!0})),this},$.fn.touchClick=function(hover,click){if(!window.addEventListener)return this;var _time,_move,_this=this,_start={},_touch={};function setTouch(e){var touch=convertTouchEvent(e);e.touchX=touch.x,e.touchY=touch.y,_start.x=e.touchX,_start.y=e.touchY}return Device.mobile&&(this.div.addEventListener(translateEvent("touchstart"),(function touchStart(e){if(!_this.div)return!1;_time=performance.now(),e.action="over",e.object="hit"==_this.div.className?_this.parent():_this,setTouch(e),hover&&!_move&&hover(e)}),{passive:!0}),this.div.addEventListener(translateEvent("touchend"),(function touchEnd(e){if(!_this.div)return!1;var time=performance.now();if(_touch=convertTouchEvent(e),_move=function findDistance(p1,p2){var dx=p2.x-p1.x,dy=p2.y-p1.y;return Math.sqrt(dx*dx+dy*dy)}(_start,_touch)>5,e.object="hit"==_this.div.className?_this.parent():_this,setTouch(e),_time&&time-_time<750){if(Mouse._preventClicks)return!1;click&&!_move&&(!0,e.action="click",click&&!_move&&click(e),Mouse.autoPreventClicks&&Mouse.preventClicks())}hover&&(e.action="out",Mouse._preventFire||hover(e));_move=!1}),{passive:!0})),this}}(),Class((function Element(type="div"){Inherit(this,Component);var name=Utils.getConstructorName(this);this.__element=!0,this.element=$("."+name,type),this.element.__useFragment=!0,this.destroy=function(){this.element&&this.element.remove&&(this.element=this.element.remove()),this._destroy&&this._destroy()}})),Hydra.ready(()=>{TweenManager.Transforms=["scale","scaleX","scaleY","x","y","z","rotation","rotationX","rotationY","rotationZ","skewX","skewY","perspective"],TweenManager.CubicEases=[{name:"easeOutCubic",curve:"cubic-bezier(0.215, 0.610, 0.355, 1.000)"},{name:"easeOutQuad",curve:"cubic-bezier(0.250, 0.460, 0.450, 0.940)"},{name:"easeOutQuart",curve:"cubic-bezier(0.165, 0.840, 0.440, 1.000)"},{name:"easeOutQuint",curve:"cubic-bezier(0.230, 1.000, 0.320, 1.000)"},{name:"easeOutSine",curve:"cubic-bezier(0.390, 0.575, 0.565, 1.000)"},{name:"easeOutExpo",curve:"cubic-bezier(0.190, 1.000, 0.220, 1.000)"},{name:"easeOutCirc",curve:"cubic-bezier(0.075, 0.820, 0.165, 1.000)"},{name:"easeOutBack",curve:"cubic-bezier(0.175, 0.885, 0.320, 1.275)"},{name:"easeInCubic",curve:"cubic-bezier(0.550, 0.055, 0.675, 0.190)"},{name:"easeInQuad",curve:"cubic-bezier(0.550, 0.085, 0.680, 0.530)"},{name:"easeInQuart",curve:"cubic-bezier(0.895, 0.030, 0.685, 0.220)"},{name:"easeInQuint",curve:"cubic-bezier(0.755, 0.050, 0.855, 0.060)"},{name:"easeInSine",curve:"cubic-bezier(0.470, 0.000, 0.745, 0.715)"},{name:"easeInCirc",curve:"cubic-bezier(0.600, 0.040, 0.980, 0.335)"},{name:"easeInBack",curve:"cubic-bezier(0.600, -0.280, 0.735, 0.045)"},{name:"easeInOutCubic",curve:"cubic-bezier(0.645, 0.045, 0.355, 1.000)"},{name:"easeInOutQuad",curve:"cubic-bezier(0.455, 0.030, 0.515, 0.955)"},{name:"easeInOutQuart",curve:"cubic-bezier(0.770, 0.000, 0.175, 1.000)"},{name:"easeInOutQuint",curve:"cubic-bezier(0.860, 0.000, 0.070, 1.000)"},{name:"easeInOutSine",curve:"cubic-bezier(0.445, 0.050, 0.550, 0.950)"},{name:"easeInOutExpo",curve:"cubic-bezier(1.000, 0.000, 0.000, 1.000)"},{name:"easeInOutCirc",curve:"cubic-bezier(0.785, 0.135, 0.150, 0.860)"},{name:"easeInOutBack",curve:"cubic-bezier(0.680, -0.550, 0.265, 1.550)"},{name:"easeInOut",curve:"cubic-bezier(.42,0,.58,1)"},{name:"linear",curve:"linear"}],TweenManager.useCSSTrans=function(props,ease,object){return!(props.math||"string"==typeof ease&&ease.includes(["Elastic","Bounce"])||object.multiTween||TweenManager._inspectEase(ease).path||!Device.tween.transition)},TweenManager._detectTween=function(object,props,time,ease,delay,callback){return TweenManager.useCSSTrans(props,ease,object)?new CSSTransition(object,props,time,ease,delay,callback):new FrameTween(object,props,time,ease,delay,callback)},TweenManager._parseTransform=function(props){var transforms="",translate="";if(props.perspective>0&&(transforms+="perspective("+props.perspective+"px)"),void 0!==props.x||void 0!==props.y||void 0!==props.z){var x=props.x||0,y=props.y||0,z=props.z||0;translate+=x+("string"==typeof props.x&&(props.x.includes("%")||props.x.includes("vw")||props.x.includes("vh"))?"":"px")+", ",translate+=y+("string"==typeof props.y&&(props.y.includes("%")||props.y.includes("vw")||props.y.includes("vh"))?"":"px"),Device.tween.css3d?transforms+="translate3d("+(translate+=", "+z+"px")+")":transforms+="translate("+translate+")"}return void 0!==props.scale?transforms+="scale("+props.scale+")":(void 0!==props.scaleX&&(transforms+="scaleX("+props.scaleX+")"),void 0!==props.scaleY&&(transforms+="scaleY("+props.scaleY+")")),void 0!==props.rotation&&(transforms+="rotate("+props.rotation+"deg)"),void 0!==props.rotationX&&(transforms+="rotateX("+props.rotationX+"deg)"),void 0!==props.rotationY&&(transforms+="rotateY("+props.rotationY+"deg)"),void 0!==props.rotationZ&&(transforms+="rotateZ("+props.rotationZ+"deg)"),void 0!==props.skewX&&(transforms+="skewX("+props.skewX+"deg)"),void 0!==props.skewY&&(transforms+="skewY("+props.skewY+"deg)"),transforms},TweenManager._clearCSSTween=function(obj){obj&&!obj._cssTween&&obj.div._transition&&!obj.persistTween&&(obj.div.style[CSS.styles.vendorTransition]="",obj.div._transition=!1,obj._cssTween=null)},TweenManager._isTransform=function(key){return TweenManager.Transforms.indexOf(key)>-1},TweenManager._getAllTransforms=function(object){for(var obj={},i=TweenManager.Transforms.length-1;i>-1;i--){var tf=TweenManager.Transforms[i],val=object[tf];0!==val&&"number"==typeof val&&(obj[tf]=val)}return obj};const prefix=function(){let pre="",dom="";try{var styles=window.getComputedStyle(document.documentElement,"");return pre=(Array.prototype.slice.call(styles).join("").match(/-(moz|webkit|ms)-/)||""===styles.OLink&&["","o"])[1],dom="WebKit|Moz|MS|O".match(new RegExp("("+pre+")","i"))[1],{unprefixed:"ie"==Device.system.browser&&!Device.detect("msie 9"),dom:dom,lowercase:pre,css:"-"+pre+"-",js:("ie"==Device.system.browser?pre[0]:pre[0].toUpperCase())+pre.substr(1)}}catch(e){return{unprefixed:!0,dom:"",lowercase:"",css:"",js:""}}}();CSS.styles={},CSS.styles.vendor=prefix.unprefixed?"":prefix.js,CSS.styles.vendorTransition=CSS.styles.vendor.length?CSS.styles.vendor+"Transition":"transition",CSS.styles.vendorTransform=CSS.styles.vendor.length?CSS.styles.vendor+"Transform":"transform",CSS.vendor=prefix.css,CSS.transformProperty=function(){switch(prefix.lowercase){case"moz":return"-moz-transform";case"webkit":return"-webkit-transform";case"o":return"-o-transform";case"ms":return"-ms-transform";default:return"transform"}}(),CSS.tween={},CSS.tween.complete=prefix.unprefixed?"transitionend":prefix.lowercase+"TransitionEnd"}),Class((function CSSTransition(_object,_props,_time,_ease,_delay,_callback){const _this=this;let _transformProps,_transitionProps;function killed(){return!_this||_this.kill||!_object||!_object.div}function clearCSSTween(){killed()||(_this.playing=!1,_object._cssTween=null,_object.willChange(null),_object=_props=null,Utils.nullObject(this))}this.playing=!0,function(){if("number"!=typeof _time)throw"CSSTween Requires object, props, time, ease";!function initProperties(){var transform=TweenManager._getAllTransforms(_object),properties=[];for(var key in _props)TweenManager._isTransform(key)?(transform.use=!0,transform[key]=_props[key],delete _props[key]):("number"==typeof _props[key]||key.includes(["-","color"]))&&properties.push(key);transform.use&&(properties.push(CSS.transformProperty),delete transform.use);_transformProps=transform,_transitionProps=properties}(),async function initCSSTween(values){if(killed())return;_object._cssTween&&(_object._cssTween.kill=!0);_object._cssTween=_this,_object.div._transition=!0;var strings=function buildStrings(time,ease,delay){for(var props="",str="",len=_transitionProps.length,i=0;i<len;i++){var transitionProp=_transitionProps[i];props+=(props.length?", ":"")+transitionProp,str+=(str.length?", ":"")+transitionProp+" "+time+"ms "+TweenManager._getEase(ease)+" "+delay+"ms"}return{props:props,transition:str}}(_time,_ease,_delay);_object.willChange(strings.props);var time=values?values.time:_time,delay=values?values.delay:_delay,props=values?values.props:_props,transformProps=values?values.transform:_transformProps,singleFrame=1e3/Render.REFRESH_RATE;if(_this.time=_time,_this.delay=_delay,await Timer.delayedCall(3*singleFrame),killed())return;if(_object.div.style[CSS.styles.vendorTransition]=strings.transition,_this.playing=!0,"safari"==Device.system.browser){if(Device.system.browserVersion<11&&await Timer.delayedCall(singleFrame),killed())return;_object.css(props),_object.transform(transformProps)}else _object.css(props),_object.transform(transformProps);Timer.create((function(){killed()||(clearCSSTween(),_callback&&_callback(),_this.completePromise&&_this.completePromise.resolve())}),time+delay)}()}(),this.stop=function(){this.playing&&(this.kill=!0,this.playing=!1,_object.div.style[CSS.styles.vendorTransition]="",_object.div._transition=!1,_object.willChange(null),_object._cssTween=null,Utils.nullObject(this))},this.onComplete=function(callback){return _callback=callback,this},this.promise=function(){return _this.completePromise=Promise.create(),_this.completePromise}})),Class((function FrameTween(_object,_props,_time,_ease,_delay,_callback,_manual){var _endValues,_transformEnd,_transformStart,_startValues,_isTransform,_isCSS,_transformProps,_cssTween,_transformTween,_this=this;function copy(obj){let newObj={};for(let key in obj)"number"==typeof obj[key]&&(newObj[key]=obj[key]);return newObj}function clear(){_object._cssTweens&&_object._cssTweens.remove(_this),_this.playing=!1,_object._cssTween=null,_object=_props=null}function update(){if(!function killed(){return _this.kill||!_object||!_object.div||!_object.css}()){if(_isCSS&&_object.css(_props),_isTransform)if(_object.multiTween){for(var key in _transformProps)"number"==typeof _transformProps[key]&&(_object[key]=_transformProps[key]);_object.transform()}else _object.transform(_transformProps);void 0}}function tweenComplete(){_this.playing&&(clear(),_callback&&_callback(),_this.completePromise&&_this.completePromise.resolve())}this.playing=!0,_this.object=_object,_this.props=_props,_this.time=_time,_this.ease=_ease,_this.delay=_delay,defer((function(){if(_this.overrideValues){let values=_this.overrideValues(_this,_object,_props,_time,_ease,_delay);values&&(_this.props=_props=values.props||_props,_this.time=_time=values.time||_time,_this.ease=_ease=values.ease||_ease,_this.delay=_delay=values.delay||_delay)}if("object"==typeof _ease&&(_ease="easeOutCubic"),_object&&_props){if(_this.object=_object,"number"!=typeof _time)throw"FrameTween Requires object, props, time, ease";!function initValues(){_props.math&&delete _props.math;Device.tween.transition&&_object.div&&_object.div._transition&&(_object.div.style[CSS.styles.vendorTransition]="",_object.div._transition=!1);_this.time=_time,_this.delay=_delay,_endValues={},_transformEnd={},_transformStart={},_startValues={},_object.multiTween||(void 0===_props.x&&(_props.x=_object.x),void 0===_props.y&&(_props.y=_object.y),void 0===_props.z&&(_props.z=_object.z));for(var key in _props)if(key.includes(["damping","spring"]))_endValues[key]=_props[key],_transformEnd[key]=_props[key];else if(TweenManager._isTransform(key))_isTransform=!0,_transformStart[key]=_object[key]||("scale"==key?1:0),_transformEnd[key]=_props[key];else{_isCSS=!0;var v=_props[key];"string"==typeof v?_object.div.style[key]=v:"number"==typeof v&&(_startValues[key]=_object.css?Number(_object.css(key)):0,_endValues[key]=v)}}(),function startTween(){!_object._cssTween||_manual||_object.multiTween||(_object._cssTween.kill=!0);_this.time=_time,_this.delay=_delay,_object.multiTween&&(_object._cssTweens||(_object._cssTweens=[]),_object._cssTweens.push(_this));_object._cssTween=_this,_this.playing=!0,_props=copy(_startValues),_transformProps=copy(_transformStart),_isCSS&&(_cssTween=tween(_props,_endValues,_time,_ease,_delay,null,_manual).onUpdate(update).onComplete(tweenComplete));_isTransform&&(_transformTween=tween(_transformProps,_transformEnd,_time,_ease,_delay,null,_manual).onComplete(_isCSS?null:tweenComplete).onUpdate(_isCSS?null:update))}()}})),this.stop=function(){this.playing&&(_cssTween&&_cssTween.stop&&_cssTween.stop(),_transformTween&&_transformTween.stop&&_transformTween.stop(),clear())},this.interpolate=function(elapsed){_cssTween&&_cssTween.interpolate(elapsed),_transformTween&&_transformTween.interpolate(elapsed),update()},this.getValues=function(){return{start:_startValues,transformStart:_transformStart,end:_endValues,transformEnd:_transformEnd}},this.setEase=function(ease){_cssTween&&_cssTween.setEase(ease),_transformTween&&_transformTween.setEase(ease)},this.onUpdate=function(){return this},this.onComplete=function(callback){return _callback=callback,this},this.promise=function(){return _this.completePromise||(_this.completePromise=Promise.create()),_this.completePromise}})),Class((function Interaction(_object){Inherit(this,Events);const _this=this;var _touchId,_velocity=[],_moved=0,_time=performance.now();function Vec2(){this.x=0,this.y=0,this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)}}var _vec2Pool=new ObjectPool(Vec2,10);let _distance,_timeDown,_timeMove;function loop(){_moved++>10&&(_this.velocity.x=_this.velocity.y=0,_this.delta.x=_this.delta.y=0)}function down(e){if(_this.isTouching||"hit"==e.target.className&&e.target.hydraObject!=_object||Interaction.hitIsBound(e.target,_object))return;_this.isTouching=!0;let x=e.x,y=e.y;e.changedTouches&&(x=e.changedTouches[0].pageX,y=e.changedTouches[0].pageY,_touchId=e.changedTouches[0].identifier),e.touches&&"number"==typeof e.touches[0].force&&(e.force=e.touches[0].force),e.x=_this.x=x,e.y=_this.y=y,_this.hold.x=_this.last.x=x,_this.hold.y=_this.last.y=y,_this.delta.x=_this.move.x=_this.velocity.x=0,_this.delta.y=_this.move.y=_this.velocity.y=0,_distance=0,_this.events.fire(Interaction.START,e,!0),_timeDown=_timeMove=Render.TIME}function move(e){if(!_this.isTouching&&!_this.unlocked)return;let now=performance.now();if(now-_time<16)return;_time=now;let x=e.x,y=e.y;if(e.touches)for(let i=0;i<e.touches.length;i++){let touch=e.touches[i];touch.identifier==_touchId&&(x=touch.pageX,y=touch.pageY)}_this.isTouching&&(_this.move.x=x-_this.hold.x,_this.move.y=y-_this.hold.y),e.touches&&"number"==typeof e.touches[0].force&&(e.force=e.touches[0].force),e.x=_this.x=x,e.y=_this.y=y,_this.delta.x=x-_this.last.x,_this.delta.y=y-_this.last.y,_this.last.x=x,_this.last.y=y,_moved=0,_distance+=_this.delta.length();let delta=Render.TIME-(_timeMove||Render.TIME);if(_timeMove=Render.TIME,delta>.01){let velocity=_vec2Pool.get();velocity.x=Math.abs(_this.delta.x)/delta,velocity.y=Math.abs(_this.delta.y)/delta,_velocity.push(velocity),_velocity.length>5&&_vec2Pool.put(_velocity.shift())}_this.velocity.x=_this.velocity.y=0;for(let i=0;i<_velocity.length;i++)_this.velocity.x+=_velocity[i].x,_this.velocity.y+=_velocity[i].y;_this.velocity.x/=_velocity.length,_this.velocity.y/=_velocity.length,_this.velocity.x=_this.velocity.x||0,_this.velocity.y=_this.velocity.y||0,_this.events.fire(Interaction.MOVE,e,!0),_this.isTouching&&_this.events.fire(Interaction.DRAG,e,!0)}function up(e){if(e&&e.changedTouches)for(let i=0;i<e.changedTouches.length;i++)if(e.changedTouches[i].identifier!=_touchId)return;if(!_this.isTouching&&!_this.unlocked)return;_this.isTouching=!1,_this.move.x=0,_this.move.y=0,Math.max(.001,Render.TIME-(_timeMove||Render.TIME))>100&&(_this.delta.x=0,_this.delta.y=0),_distance<20&&Render.TIME-_timeDown<2e3&&_this.events.fire(Interaction.CLICK,e,!0),_this.events.fire(Interaction.END,e,!0),Device.mobile&&(_this.velocity.x=_this.velocity.y=0)}function leave(){_this.ignoreLeave||(_this.delta.x=0,_this.delta.y=0,up())}this.x=0,this.y=0,this.hold=new Vec2,this.last=new Vec2,this.delta=new Vec2,this.move=new Vec2,this.velocity=new Vec2,function(){if(!_object instanceof HydraObject)throw"Interaction.Input requires a HydraObject";!function addHandlers(){_object==Stage||_object==__window?Interaction.bind("touchstart",down):(_object.bind("touchstart",down),Interaction.bindObject(_object));Interaction.bind("touchmove",move),Interaction.bind("touchend",up),Interaction.bind("leave",leave)}(),Render.start(loop)}(),this.onDestroy=function(){Interaction.unbind("touchstart",down),Interaction.unbind("touchmove",move),Interaction.unbind("touchend",up),Render.stop(loop),Interaction.unbindObject(_object),_object&&_object.unbind&&_object.unbind("touchstart",down)}}),()=>{Namespace(Interaction),Interaction.CLICK="interaction_click",Interaction.START="interaction_start",Interaction.MOVE="interaction_move",Interaction.DRAG="interaction_drag",Interaction.END="interaction_end";const _objects=[],_events={touchstart:[],touchmove:[],touchend:[],leave:[]};function touchMove(e){_events.touchmove.forEach(c=>c(e))}function touchStart(e){_events.touchstart.forEach(c=>c(e))}function touchEnd(e){_events.touchend.forEach(c=>c(e))}function leave(e){e.leave=!0,_events.leave.forEach(c=>c(e))}Hydra.ready(async()=>{await defer(),__window.bind("touchstart",touchStart),__window.bind("touchmove",touchMove),__window.bind("touchend",touchEnd),__window.bind("touchcancel",touchEnd),__window.bind("contextmenu",touchEnd),__window.bind("mouseleave",leave),__window.bind("mouseout",leave)}),Interaction.bind=function(evt,callback){_events[evt].push(callback)},Interaction.unbind=function(evt,callback){_events[evt].remove(callback)},Interaction.bindObject=function(obj){_objects.push(obj)},Interaction.unbindObject=function(obj){_objects.remove(obj)},Interaction.hitIsBound=function(element,boundObj){let obj=element.hydraObject;if(!obj)return!1;for(;obj;){if(obj!=boundObj&&_objects.includes(obj))return!0;obj=obj._parent}return!1}}),Class((function Mouse(){Inherit(this,Events);const _this=this;this.x=0,this.y=0,this.normal={x:0,y:0},this.tilt={x:0,y:0},this.inverseNormal={x:0,y:0},this.resetOnRelease=!1;const _offset={x:0,y:0};function init(){defer(_=>{_this.resetOnRelease&&Device.mobile&&(_this.x=Stage.width/2,_this.y=Stage.height/2)}),_this.input=new Interaction(__window),_this.input.unlocked=!0,_this.events.sub(_this.input,Interaction.START,update),_this.events.sub(_this.input,Interaction.MOVE,update),_this.events.sub(_this.input,Interaction.END,end),_this.hold=_this.input.hold,_this.last=_this.input.last,_this.delta=_this.input.delta,_this.move=_this.input.move,_this.velocity=_this.input.velocity,defer(()=>{_this.events.sub(Events.RESIZE,resize),resize()})}function update(e){_this.x=e.x,_this.y=e.y,Stage.width&&Stage.height&&(_this.normal.x=e.x/Stage.width-_offset.x,_this.normal.y=e.y/Stage.height-_offset.y,_this.tilt.x=2*_this.normal.x-1,_this.tilt.y=1-2*_this.normal.y,_this.inverseNormal.x=_this.normal.x,_this.inverseNormal.y=1-_this.normal.y)}function end(e){Device.mobile&&_this.resetOnRelease&&update({x:Stage.width/2,y:Stage.height/2})}function resize(){Stage.css("top")&&(_offset.y=Stage.css("top")/Stage.height),Stage.css("left")&&(_offset.x=Stage.css("left")/Stage.width)}Hydra.ready(init)}),"Static"),Class((function Keyboard(){Inherit(this,Component);var _this=this;function addListeners(){__window.keydown(keydown),__window.keyup(keyup),__window.keypress(keypress)}function keydown(e){_this.events.fire(_this.DOWN,e)}function keyup(e){_this.events.fire(_this.UP,e)}function keypress(e){_this.events.fire(_this.PRESS,e)}_this.DOWN="keyboard_down",_this.PRESS="keyboard_press",_this.UP="keyboard_up",Hydra.ready(addListeners)}),"static"),Class((function Mobile(){Inherit(this,Component),Namespace(this);const _this=this;function preventNativeScroll(e){if(_this.isAllowNativeScroll)return;let target=e.target;if("LABEL"==target.nodeName||"INPUT"==target.nodeName||"TEXTAREA"==target.nodeName||"SELECT"==target.nodeName||"A"==target.nodeName)return;let prevent=target.hydraObject;for(;target.parentNode&&prevent;)target._scrollParent&&(prevent=!1),target=target.parentNode;prevent&&e.preventDefault()}function resize(){updateOrientation(),checkResizeRefresh(),_this.isAllowNativeScroll||(document.body.scrollTop=0)}function updateOrientation(){_this.orientation=Stage.width>Stage.height?"landscape":"portrait",_this.orientationSet&&(window.Fullscreen.isOpen||Device.mobile.pwa)&&window.screen&&window.screen.orientation&&window.screen.orientation.lock(_this.orientationSet)}Hydra.ready(()=>{Device.mobile&&(!function addHandlers(){_this.events.sub(Events.RESIZE,resize),Device.mobile.native||window.addEventListener("touchstart",preventNativeScroll,{passive:!1})}(),"safari"!=Device.system.browser||Device.mobile.native||(__body.css({height:"100%"}).div.scrollTop=0),Device.mobile.native&&Stage.css({width:"100vw",height:"100vh"}))});const checkResizeRefresh=function(){let _lastWidth;return function(){_this.isPreventResizeReload||_lastWidth!=Stage.width&&(_lastWidth=Stage.width,("ios"===Device.system.os||"android"==Device.system.os&&Device.system.version>=7)&&(!Device.mobile.tablet||Math.max(Stage.width,Stage.height)>800||window.location.reload()))}}();this.vibrate=function(duration){navigator.vibrate&&navigator.vibrate(duration)},this.fullscreen=function(){if(Device.mobile&&!Device.mobile.native&&!Device.mobile.pwa&&!Dev.emulator){if(!window.Fullscreen)throw"Mobile.fullscreen requires Fullscreen module";"android"===Device.system.os&&(__window.bind("touchend",()=>{Fullscreen.open()}),_this.ScreenLock&&_this.ScreenLock.isActive&&window.onresize())}},this.setOrientation=function(orientation,isForce){if(_this.System&&_this.NativeCore.active)return _this.System.orientation=_this.System[orientation.toUpperCase()];if(_this.orientationSet=orientation,updateOrientation(),isForce){if(!_this.ScreenLock)throw"Mobile.setOrientation isForce argument requires ScreenLock module";"any"===orientation?_this.ScreenLock.unlock():_this.ScreenLock.lock()}},this.allowNativeScroll=function(){_this.isAllowNativeScroll=!0},this.preventResizeReload=function(){_this.isPreventResizeReload=!0},this._addOverflowScroll=function($obj){$obj.div._scrollParent=!0,Device.mobile.native||($obj.div._preventEvent=function(e){e.stopPropagation()},$obj.bind("touchmove",$obj.div._preventEvent))},this._removeOverflowScroll=function($obj){$obj.unbind("touchmove",$obj.div._preventEvent)},this.get("phone",()=>{throw"Mobile.phone is removed. Use Device.mobile.phone"}),this.get("tablet",()=>{throw"Mobile.tablet is removed. Use Device.mobile.tablet"}),this.get("os",()=>{throw"Mobile.os is removed. Use Device.system.os"})}),"Static"),Class((function PushState(_isHash){const _this=this;let _store,_root="";function getState(){return _isHash?String(window.location.hash.slice(3)):("/"!==_root?location.pathname.split(_root)[1]:location.pathname.slice(1))||""}function handleStateChange(state,forced){if(state!==_store||forced)if(!_this.isLocked||forced)_store=state,_this.events.fire(Events.UPDATE,{value:state,split:state.split("/")});else{if(!_store)return;_isHash?window.location.hash="!/"+_store:window.history.pushState(null,null,_root+_store)}}"boolean"!=typeof _isHash&&(_isHash=Hydra.LOCAL||!Device.system.pushstate),this.isLocked=!1,function addHandlers(){if(_isHash)return window.addEventListener("hashchange",()=>handleStateChange(getState()),!1);window.onpopstate=history.onpushstate=()=>handleStateChange(getState())}(),_store=getState(),this.getState=this._getState=function(){return Device.mobile.native?Storage.get("app_state")||"":getState()},this.setRoot=function(root){_root="/"===root.charAt(0)?root:"/"+root},this.setState=this._setState=function(state,forced){if(Device.mobile.native&&Storage.set("app_state",state),state!==_store||forced)return _isHash?window.location.hash="!/"+state:window.history.pushState(null,null,_root+state),_this.fireChangeWhenSet&&handleStateChange(getState(),forced),_store=state,!0},this.replaceState=function(state){state!==_store&&(_store=state,_isHash?window.location.hash="!/"+state:window.history.replaceState(null,null,_root+state))},this.setTitle=function(title){document.title=title},this.lock=function(){this.isLocked=!0,_this.events.fire(PushState.LOCK)},this.unlock=function(){this.isLocked=!1,_this.events.fire(PushState.UNLOCK)},this.useHash=function(){_isHash=!0}}),_=>{PushState.LOCK="push_state_lock",PushState.UNLOCK="push_state_unlock"}),Class((function AppState(){const _this=this;var _map=new Map,_bindings=new Map;function StateBinding(_keys,_obj){var _string,_oldValue;_obj instanceof HydraObject?("div"==_obj._type&&(_string=_obj.text()),"input"==_obj._type&&(_string=_obj.val())):window.GLUI&&_obj instanceof GLUIText&&(_string=_obj.getTextString()),this.update=function(key,value){let newValue=function parse(key,value){if(!_string||!_string.includes("$("))return value;let string=_string;return _keys.forEach(key=>{string=string.replace(`$(${key})`,_this.get(key))}),string}(0,value);newValue!=_oldValue&&(_oldValue=newValue,_obj instanceof HydraObject?("div"==_obj._type&&_obj.text(newValue),"input"==_obj._type&&_obj.val(newValue)):window.GLUI&&_obj instanceof GLUIText?_obj.setText(newValue):_obj.onStateChange?_obj.onStateChange(value):"function"==typeof _obj&&_obj(value))}}this.set=function(key,value){_map.set(key,value);let array=_bindings.get(key);array&&array.forEach(b=>b.update(key,value))},this.get=function(key){return _map.get(key)},this.bind=function(keys,obj){Array.isArray(keys)||(keys=[keys]);let binding=new StateBinding(keys,obj);keys.forEach(key=>{_bindings.has(key)?_bindings.get(key).push(binding):_bindings.set(key,[binding]);let value=_map.get(key);value&&binding.update(value)})},this.createLocal=function(){return new AppState}}),"static"),Class((function Dev(){var _post,_alert,_inter,_timerName,_this=this,_id=Utils.timestamp();function catchErrors(){window.onerror=function(message,file,line){var string=message+" ::: "+file+" : "+line;_alert&&alert(string),_post&&post(_post+"/api/data/debug",getDebugInfo(string)),_this.onError&&_this.onError(message,file,line)}}function getDebugInfo(string){var obj={};return obj.time=(new Date).toString(),obj.deviceId=_id,obj.err=string,obj.ua=Device.agent,obj.width=Stage.width,obj.height=Stage.height,obj.screenWidth=screen.width,obj.screenHeight=screen.height,obj}this.emulator=Device.mobile&&navigator.platform&&navigator.platform.toLowerCase().includes(["mac","windows"]),this.alertErrors=function(url){_alert=!0,"string"==typeof url&&(url=[url]);for(var i=0;i<url.length;i++)if(location.href.includes(url[i])||location.hash.includes(url[i]))return catchErrors()},this.postErrors=function(url,post){_post=post,"string"==typeof url&&(url=[url]);for(var i=0;i<url.length;i++)if(location.href.includes(url[i]))return catchErrors()},this.expose=function(name,val,force){(Hydra.LOCAL||force)&&(window[name]=val)},this.logServer=function(msg){_post&&post(_post+"/api/data/debug",getDebugInfo(msg))},this.unsupported=function(needsAlert){needsAlert&&alert("Hi! This build is not yet ready for this device, things may not work as expected. Refer to build schedule for when this device will be supported.")},this.checkForLeaks=function(flag,array){if(!window.AURA){var matchArray=function(prop){if(!array)return!1;for(var i=0;i<array.length;i++)if(prop.includes(array[i]))return!0;return!1};clearInterval(_inter),flag&&(_inter=setInterval((function(){for(var prop in window){if(!prop.includes("webkit"))if("function"!=typeof window[prop]&&prop.length>2){if(prop.includes("_ga")||prop.includes("_typeface_js")||matchArray(prop))continue;var char1=prop.charAt(0),char2=prop.charAt(1);if(("_"==char1||"$"==char1)&&char2!==char2.toUpperCase())throw console.log(window[prop]),"Hydra Warning:: "+prop+" leaking into global scope"}}}),1e3))}},this.startTimer=function(name){_timerName=name||"Timer",console.time&&!window._NODE_?console.time(_timerName):_timer=performance.now()},this.stopTimer=function(){console.time&&!window._NODE_?console.timeEnd(_timerName):console.log("Render "+_timerName+": "+(performance.now()-_timer))},this.writeFile=function(file,data){let protocol=location.protocol,port="https:"===protocol?":8018":":8017",url=protocol+"//"+location.hostname+port+location.pathname+file;post(url,data,{headers:{"content-type":"text/plain"}}).then(e=>{"OK"!=e&&console.warn("Unable to write to "+file)})},this.execUILScript=async function(name,data){if(!Hydra.LOCAL)return;let url=location.protocol+"//"+location.hostname+":8017"+(_this.pathName||location.pathname)+"/uil/"+name,response=await post(url,data,{headers:{"content-type":"text/plain"}});if("ERROR"==response)throw response;return response},Hydra.LOCAL&&_this.checkForLeaks(!0)}),"Static"),Class((function Service(){Inherit(this,Component);var _sw,_this=this;function getSWAssets(){if(!window.ASSETS.SW||_this.cached)return[];var assets=window.ASSETS.SW;return assets.forEach((asset,i)=>{asset.includes(".js")&&(asset=assets[i].replace(".js",".js?"+window._CACHE_))}),assets}function handleRegistration(e){}function handleReady(e){_this.isReady=!0,_this.events.fire(Events.READY,e,!0),_sw=navigator.serviceWorker.controller,function checkCache(){Storage.get("service_cache")!=window._CACHE_&&_this.post("clearCache")}()}function handleError(e){e&&(_this.events.fire(Events.ERROR,e,!0),_this.active=!1)}function handleMessage(e){var data=e.data;data.evt&&_this.events.fire(data.evt,data)}this.active=!1,this.ready=!1,this.cached=!1,this.offline=!1,this.disabled=!1,this.ready=function(){return this.wait(this,"isReady")},this.init=function(){Hydra.ready(()=>{!("serviceWorker"in navigator)||Hydra.LOCAL&&""==location.port||window.process||_this.disabled||function initWorker(){_this.active=!0,navigator.serviceWorker.register("sw.js").then(handleRegistration).then(handleReady).then(handleError)}()})},this.cache=function(assets=[]){assets=Array.from(assets);_this.active&&_this.wait(_this,"ready",(function(){_this.post("upload",{assets:assets,cdn:Assets.CDN,hostname:location.hostname,sw:getSWAssets(),offline:_this.offline}),Storage.set("service_cache",window._CACHE_),_this.cached=!0}))},this.post=function(fn,data={}){if(!_this.active)return;_this.wait(_this,"ready",(function(){let mc=new MessageChannel;mc.port1.onmessage=handleMessage,data.fn=fn,_sw&&_sw.postMessage(data,[mc.port2])}))}}),"static"),Class((function Storage(){var _storage;function cookie(key,value,expires){var options;if(arguments.length>1&&(null===value||"object"!=typeof value)){if((options={}).path="/",options.expires=expires||1,null===value&&(options.expires=-1),"number"==typeof options.expires){var days=options.expires,t=options.expires=new Date;t.setDate(t.getDate()+days)}return document.cookie=[encodeURIComponent(key),"=",options.raw?String(value):encodeURIComponent(String(value)),options.expires?"; expires="+options.expires.toUTCString():"",options.path?"; path="+options.path:"",options.domain?"; domain="+options.domain:"",options.secure?"; secure":""].join("")}var result,decode=(options=value||{}).raw?function(s){return s}:decodeURIComponent;return(result=new RegExp("(?:^|; )"+encodeURIComponent(key)+"=([^;]*)").exec(document.cookie))?decode(result[1]):null}!function testStorage(){try{if(window.localStorage)try{window.localStorage.test=1,window.localStorage.removeItem("test"),_storage=!0}catch(e){_storage=!1}else _storage=!1}catch(e){_storage=!1}}(),this.setCookie=function(key,value,expires){cookie(key,value,expires)},this.getCookie=function(key){return cookie(key)},this.set=function(key,value){null!=value&&"object"==typeof value&&(value=JSON.stringify(value)),_storage?null===value?window.localStorage.removeItem(key):window.localStorage[key]=value:cookie(key,value,365)},this.get=function(key){var val,char0;(val=_storage?window.localStorage[key]:cookie(key))&&(val.charAt&&(char0=val.charAt(0)),"{"!=char0&&"["!=char0||(val=JSON.parse(val)),"true"!=val&&"false"!=val||(val="true"==val));return val}}),"Static"),Class((function Thread(_class){Inherit(this,Component);var _this=this,_worker,_callbacks,_path,_mvc,_msg={};function init(){let file=window._ES5_?"assets/js/hydra/hydra-thread-es5.js":"assets/js/hydra/hydra-thread.js";_callbacks={},_worker=new Worker(Thread.PATH+file)}function importClasses(){importClass(Utils),importClass(Component),importClass(Events),importClass(_class,!0)}function importClass(_class,scoped){if(_class){var code;if(scoped){code=(code=_class.toString().replace("{","!!!")).split("!!!")[1];for(var splitChar=window._MINIFIED_?"=":" ";code.includes("this");){var name=code.slice(code.indexOf("this.")).split("this.")[1].split(splitChar)[0];code=code.replace("this","self"),createMethod(name)}code=(code=code.slice(0,-1)).replace(/_self/g,"_this")}else if("function"!=typeof _class){if((code=_class.constructor.toString()).includes("[native"))return;code=(_class.constructor._namespace?_class.constructor._namespace+".":"")+"Class("+code+', "static");'}else code=(_class._namespace?_class._namespace+".":"")+"Class("+_class.toString()+");";_worker.postMessage({code:code})}}function createMethod(name){_this[name]=function(message={},callback,buffer){let promise;return Array.isArray(callback)&&(buffer=callback,callback=void 0),Array.isArray(buffer)&&((message={msg:message,transfer:!0}).buffer=buffer),void 0===callback&&(promise=Promise.create(),callback=promise.resolve),_this.send(name,message,callback),promise}}function addListeners(){_worker.addEventListener("message",workerMessage)}function workerMessage(e){if(e.data.console)console.log(e.data.message);else if(e.data.id){(callback=_callbacks[e.data.id])&&callback(e.data.message),delete _callbacks[e.data.id]}else if(e.data.emit){(callback=_callbacks[e.data.evt])&&callback(e.data.msg)}else{var callback;(callback=_callbacks.transfer)&&callback(e.data)}}init(),importClasses(),addListeners(),this.on=function(evt,callback){_callbacks[evt]=callback},this.off=function(evt){delete _callbacks[evt]},this.loadFunction=function(){let names=[],load=code=>{var split=(code=(code=code.toString()).replace("(","!!!")).split("!!!"),name=split[0].split(" ")[1];code="self."+name+" = function("+split[1],_worker.postMessage({code:code}),createMethod(name),names.push(name)};for(var i=0;i<arguments.length;i++)load(arguments[i]);return names},this.importScript=function(path){_worker.postMessage({path:Thread.absolutePath(path),importScript:!0})},this.importCode=function(code){_worker.postMessage({code:code})},this.importClass=function(){for(var i=0;i<arguments.length;i++){var code=arguments[i];importClass(code)}},this.importModules=this.importModule=function(){for(var i=0;i<arguments.length;i++){let code=Modules.getConstructor(arguments[i]).toString();_worker.postMessage({code:`Module(${code})`})}},this.importES6Class=function(name){if(window._ES5_){let Class=window[name],base=Class.toString(),proto=[];Object.getOwnPropertyNames(Class.prototype).forEach(fn=>{"constructor"!=fn&&Class.prototype[fn]&&proto.push({key:fn,string:Class.prototype[fn].toString()})}),_worker.postMessage({es5:base,name:name,proto:proto})}else _worker.postMessage({es6:`(${eval(name)})`,name:name})},this.send=function(name,message,callback){if("string"==typeof name){(message=message||{}).fn=name}else callback=message,message=name;Thread.UNIQUE_ID>999999&&(Thread.UNIQUE_ID=1);var id=Thread.UNIQUE_ID++;callback&&(_callbacks[id]=callback),message.transfer?(message.msg.id=id,message.msg.fn=message.fn,message.msg.transfer=!0,_worker.postMessage(message.msg,message.buffer)):(_msg.message=message,_msg.id=id,_worker.postMessage(_msg))},this.onDestroy=function(){_worker.terminate&&_worker.terminate()}}),()=>{var _shared;Thread.PATH="",Thread.UNIQUE_ID=1,Thread.absolutePath=Hydra.absolutePath,Thread.cluster=function(){return new function(){let index=0,array=[];this.push=function(thread){array.push(thread)},this.get=function(){let thread=array[index];return index++,index>=array.length&&(index=0),thread},this.array=array}},Thread.upload=function(...args){let name;Thread.shared();for(let i=0;i<_shared.array.length;i++)name=_shared.array[i].loadFunction(...args);return name},Thread.shared=function(list){if(!_shared){_shared=Thread.cluster();let hardware=navigator.hardwareConcurrency||4,count=Math.max(Math.min(hardware,8),4);for(let i=0;i<count;i++)_shared.push(new Thread)}return list?_shared:_shared.get()}}),Class((function TweenManager(){Namespace(this);var _this=this,_tweens=[];function updateTweens(time,dt){for(let i=_tweens.length-1;i>=0;i--){let tween=_tweens[i];tween.update?tween.update(dt):_this._removeMathTween(tween)}}function findEase(name){for(var eases=_this.CubicEases,i=eases.length-1;i>-1;i--)if(eases[i].name==name)return eases[i];return!1}this.CubicEases=[],Render.start(updateTweens),this._addMathTween=function(tween){_tweens.push(tween)},this._removeMathTween=function(tween){_tweens.remove(tween)},this._getEase=function(name,values){var ease=findEase(name);return!!ease&&(values?ease.path?ease.path.solve:ease.values:ease.curve)},this._inspectEase=function(name){return findEase(name)},this.tween=function(object,props,time,ease,delay,complete,isManual,scaledTime){"number"!=typeof delay&&(update=complete,complete=delay,delay=0);const tween=new MathTween(object,props,time,ease,delay,complete,isManual,scaledTime);let usePromise=null;return complete&&complete instanceof Promise&&(usePromise=complete,complete=complete.resolve),usePromise||tween},this.clearTween=function(object){if(object._mathTween&&object._mathTween.stop&&object._mathTween.stop(),object._mathTweens){for(var tweens=object._mathTweens,i=0;i<tweens.length;i++){var tw=tweens[i];tw&&tw.stop&&tw.stop()}object._mathTweens=null}},this.addCustomEase=function(ease){var add=!0;if("object"!=typeof ease||!ease.name||!ease.curve)throw"TweenManager :: addCustomEase requires {name, curve}";for(var i=_this.CubicEases.length-1;i>-1;i--)ease.name==_this.CubicEases[i].name&&(add=!1);if(add){if("m"==ease.curve.charAt(0).toLowerCase()){if(!window.EasingPath)throw"Using custom eases requires easingpath module";ease.path=new EasingPath(ease.curve)}else ease.values=function stringToValues(str){for(var values=str.split("(")[1].slice(0,-1).split(","),i=0;i<values.length;i++)values[i]=parseFloat(values[i]);return values}(ease.curve);_this.CubicEases.push(ease)}return ease},Math.interpolate=function(start,end,alpha,ease){const fn=_this.Interpolation.convertEase(ease);return Math.mix(start,end,"function"==typeof fn?fn(alpha):_this.Interpolation.solve(fn,alpha))},window.tween=this.tween,window.clearTween=this.clearTween}),"Static"),TweenManager.Class((function Interpolation(){function calculateBezier(aT,aA1,aA2){return((A(aA1,aA2)*aT+B(aA1,aA2))*aT+C(aA1))*aT}function A(aA1,aA2){return 1-3*aA2+3*aA1}function B(aA1,aA2){return 3*aA2-6*aA1}function C(aA1){return 3*aA1}this.convertEase=function(ease){var fn=function(){switch(ease){case"easeInQuad":return TweenManager.Interpolation.Quad.In;case"easeInCubic":return TweenManager.Interpolation.Cubic.In;case"easeInQuart":return TweenManager.Interpolation.Quart.In;case"easeInQuint":return TweenManager.Interpolation.Quint.In;case"easeInSine":return TweenManager.Interpolation.Sine.In;case"easeInExpo":return TweenManager.Interpolation.Expo.In;case"easeInCirc":return TweenManager.Interpolation.Circ.In;case"easeInElastic":return TweenManager.Interpolation.Elastic.In;case"easeInBack":return TweenManager.Interpolation.Back.In;case"easeInBounce":return TweenManager.Interpolation.Bounce.In;case"easeOutQuad":return TweenManager.Interpolation.Quad.Out;case"easeOutCubic":return TweenManager.Interpolation.Cubic.Out;case"easeOutQuart":return TweenManager.Interpolation.Quart.Out;case"easeOutQuint":return TweenManager.Interpolation.Quint.Out;case"easeOutSine":return TweenManager.Interpolation.Sine.Out;case"easeOutExpo":return TweenManager.Interpolation.Expo.Out;case"easeOutCirc":return TweenManager.Interpolation.Circ.Out;case"easeOutElastic":return TweenManager.Interpolation.Elastic.Out;case"easeOutBack":return TweenManager.Interpolation.Back.Out;case"easeOutBounce":return TweenManager.Interpolation.Bounce.Out;case"easeInOutQuad":return TweenManager.Interpolation.Quad.InOut;case"easeInOutCubic":return TweenManager.Interpolation.Cubic.InOut;case"easeInOutQuart":return TweenManager.Interpolation.Quart.InOut;case"easeInOutQuint":return TweenManager.Interpolation.Quint.InOut;case"easeInOutSine":return TweenManager.Interpolation.Sine.InOut;case"easeInOutExpo":return TweenManager.Interpolation.Expo.InOut;case"easeInOutCirc":return TweenManager.Interpolation.Circ.InOut;case"easeInOutElastic":return TweenManager.Interpolation.Elastic.InOut;case"easeInOutBack":return TweenManager.Interpolation.Back.InOut;case"easeInOutBounce":return TweenManager.Interpolation.Bounce.InOut;case"linear":return TweenManager.Interpolation.Linear.None}}();if(!fn){var curve=TweenManager._getEase(ease,!0);fn=curve||TweenManager.Interpolation.Cubic.Out}return fn},this.solve=function(values,elapsed){return values[0]==values[1]&&values[2]==values[3]?elapsed:calculateBezier(function getTForX(aX,mX1,mX2){for(var aT,aA1,aA2,aGuessT=aX,i=0;i<4;i++){var currentSlope=(aT=aGuessT,3*A(aA1=mX1,aA2=mX2)*aT*aT+2*B(aA1,aA2)*aT+C(aA1));if(0==currentSlope)return aGuessT;aGuessT-=(calculateBezier(aGuessT,mX1,mX2)-aX)/currentSlope}return aGuessT}(elapsed,values[0],values[2]),values[1],values[3])},this.Linear={None:function(k){return k}},this.Quad={In:function(k){return k*k},Out:function(k){return k*(2-k)},InOut:function(k){return(k*=2)<1?.5*k*k:-.5*(--k*(k-2)-1)}},this.Cubic={In:function(k){return k*k*k},Out:function(k){return--k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k:.5*((k-=2)*k*k+2)}},this.Quart={In:function(k){return k*k*k*k},Out:function(k){return 1- --k*k*k*k},InOut:function(k){return(k*=2)<1?.5*k*k*k*k:-.5*((k-=2)*k*k*k-2)}},this.Quint={In:function(k){return k*k*k*k*k},Out:function(k){return--k*k*k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k*k*k:.5*((k-=2)*k*k*k*k+2)}},this.Sine={In:function(k){return 1-Math.cos(k*Math.PI/2)},Out:function(k){return Math.sin(k*Math.PI/2)},InOut:function(k){return.5*(1-Math.cos(Math.PI*k))}},this.Expo={In:function(k){return 0===k?0:Math.pow(1024,k-1)},Out:function(k){return 1===k?1:1-Math.pow(2,-10*k)},InOut:function(k){return 0===k?0:1===k?1:(k*=2)<1?.5*Math.pow(1024,k-1):.5*(2-Math.pow(2,-10*(k-1)))}},this.Circ={In:function(k){return 1-Math.sqrt(1-k*k)},Out:function(k){return Math.sqrt(1- --k*k)},InOut:function(k){return(k*=2)<1?-.5*(Math.sqrt(1-k*k)-1):.5*(Math.sqrt(1-(k-=2)*k)+1)}},this.Elastic={In:function(k,a=1,p=.4){var s;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),-a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p))},Out:function(k,a=1,p=.4){var s;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),a*Math.pow(2,-10*k)*Math.sin((k-s)*(2*Math.PI)/p)+1)},InOut:function(k,a=1,p=.4){var s;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),(k*=2)<1?a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)*-.5:a*Math.pow(2,-10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)*.5+1)}},this.Back={In:function(k){var s=1.70158;return k*k*((s+1)*k-s)},Out:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},InOut:function(k){var s=2.5949095;return(k*=2)<1?k*k*((s+1)*k-s)*.5:.5*((k-=2)*k*((s+1)*k+s)+2)}},this.Bounce={In:function(k){return 1-this.Bounce.Out(1-k)},Out:function(k){return k<1/2.75?7.5625*k*k:k<2/2.75?7.5625*(k-=1.5/2.75)*k+.75:k<2.5/2.75?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375},InOut:function(k){return k<.5?.5*this.Bounce.In(2*k):.5*this.Bounce.Out(2*k-1)+.5}}}),"Static"),Class((function MathTween(_object,_props,_time,_ease,_delay,_callback,_manual,_scaledTime){var _startTime,_startValues,_endValues,_easeFunction,_paused,_newEase,_spring,_damping,_update,_currentTime,_this=this,_elapsed=0;function clear(){if(!_object&&!_props)return!1;_object._mathTween=null,TweenManager._removeMathTween(_this),Utils.nullObject(_this),_object._mathTweens&&_object._mathTweens.remove(_this._tweenWrapper)}_this.object=_object,_this.props=_props,_this.time=_time,_this.ease=_ease,_this.delay=_delay,defer((function(){if(_this.overrideValues){let values=_this.overrideValues(_this,_object,_props,_time,_ease,_delay);values&&(_this.props=_props=values.props||_props,_this.time=_time=values.time||_time,_this.ease=_ease=values.ease||_ease,_this.delay=_delay=values.delay||_delay)}if(_object&&_props){if(_this.object=_object,"number"!=typeof _time)throw"MathTween Requires object, props, time, ease";!function start(){_object.multiTween||!_object._mathTween||_manual||TweenManager.clearTween(_object);_manual||TweenManager._addMathTween(_this);_this.time=_time,_this.delay=_delay;let propString=function getPropString(){let string="";for(let key in _props)"number"==typeof _props[key]&&(string+=key+" ");return string}();_object._mathTween=_this,_object.multiTween&&(_object._mathTweens||(_object._mathTweens=[]),_object._mathTweens.forEach(t=>{t.props==propString&&t.tween.stop()}),_this._tweenWrapper={props:propString,tween:_this},_object._mathTweens.push(_this._tweenWrapper));_ease||(_ease="linear");"string"==typeof _ease&&(_ease=TweenManager.Interpolation.convertEase(_ease),_easeFunction="function"==typeof _ease);_startTime=_scaledTime?Render.now():performance.now(),_currentTime=_startTime,_startTime+=_delay,_endValues=_props,_startValues={},_props.spring&&(_spring=_props.spring);_props.damping&&(_damping=_props.damping);for(var prop in _this.startValues=_startValues,_endValues)"number"==typeof _object[prop]&&(_startValues[prop]=_object[prop])}()}})),this.update=function(dt){if(_paused)return;if((_currentTime+=_scaledTime?dt:Render.DT)<_startTime)return;_elapsed=(_elapsed=(_currentTime-_startTime)/_time)>1?1:_elapsed;let delta=this.interpolate(_elapsed);_update&&_update(delta),1==_elapsed&&(_callback&&_callback(),_this.completePromise&&_this.completePromise.resolve(),clear())},this.pause=function(){_paused=!0},this.resume=function(){_paused=!1},this.stop=function(){return _this.stopped=!0,clear(),null},this.setEase=function(ease){_newEase!=ease&&(_newEase=ease,_ease=TweenManager.Interpolation.convertEase(ease),_easeFunction="function"==typeof _ease)},this.getValues=function(){return{start:_startValues,end:_endValues}},this.interpolate=function(elapsed){var delta=_easeFunction?_ease(elapsed,_spring,_damping):TweenManager.Interpolation.solve(_ease,elapsed);for(var prop in _startValues)if("number"==typeof _startValues[prop]&&"number"==typeof _endValues[prop]){var start=_startValues[prop],end=_endValues[prop];_object[prop]=start+(end-start)*delta}return delta},this.onUpdate=function(callback){return _update=callback,this},this.onComplete=function(callback){return _callback=callback,this},this.promise=function(){return _this.completePromise=Promise.create(),_this.completePromise},this.setElapsed=function(elapsed){_startTime=performance.now(),_currentTime=_startTime+_time*elapsed}})),Class((function TweenTimeline(){Inherit(this,Component);const _this=this;let _tween,_total=0;const _tweens=[];function calculate(){_tweens.sort((function(a,b){const ta=a.time+a.delay;return b.time+b.delay-ta}));const first=_tweens[0];_total=first.time+first.delay}function loop(){let time=_this.elapsed*_total;for(let i=_tweens.length-1;i>-1;i--){let t=_tweens[i],relativeTime=time-t.delay,elapsed=Math.clamp(relativeTime/t.time,0,1);t.interpolate(elapsed)}_this.events.fire(Events.UPDATE,_this,!0)}this.elapsed=0,this.get("timeRemaining",()=>_total-_this.elapsed*_total),this.add=function(object,props,time,ease,delay=0){let tween;return(object instanceof MathTween||object instanceof FrameTween)&&(props=object.props,time=object.time,ease=object.ease,delay=object.delay,object=object.object),tween=object instanceof HydraObject?new FrameTween(object,props,time,ease,delay,null,!0):new MathTween(object,props,time,ease,delay,null,!0),_tweens.push(tween),defer(calculate),tween},this.tween=function(to,time,ease,delay,callback){return _this.clearTween(),_tween=tween(_this,{elapsed:to},time,ease,delay).onUpdate(loop).onComplete(callback),_tween},this.clearTween=function(){_tween&&_tween.stop&&_tween.stop()},this.startRender=function(){Render.start(loop)},this.stopRender=function(){Render.stop(loop)},this.update=function(){loop()},this.onDestroy=function(){_this.clearTween(),Render.stop(loop);for(var i=0;i<_tweens.length;i++)_tweens[i].stop()}})),Class((function Data(){Inherit(this,Model);const _this=this;!async function(){await Hydra.ready(),await async function onLoad(){let data=Config.PREVIEW?await get(Config.DATA):window._DATA_||await _this.loadData(Config.DATA);Object.keys(data).forEach(key=>_this[key.toUpperCase()]=data[key])}(),_this.dataReady=!0}()}),"static"),Class((function Account(){this.isLoggedIn=function(){return localStorage.getItem("email")},this.login=function(email){localStorage.setItem("email",email)},this.logout=function(){localStorage.removeItem("email")},this.setLevel=function(level,stars){localStorage.setItem("level-"+level,stars)},this.getLevel=function(level){return localStorage.getItem("level-"+level)}}),"singleton"),window.ASSETS=["assets/data/levels/citricalley.json","assets/data/levels/datamine.json","assets/data/levels/datamine2.json","assets/data/levels/datamine5.json","assets/data/levels/datamines.json","assets/data/levels/datamino.json","assets/data/levels/demo/demo-level-tileset.json","assets/data/levels/demo/demo-level.json","assets/data/levels/demo/demo-level.png","assets/data/levels/exotic.json","assets/data/levels/gummyleaks.json","assets/data/levels/level_test.json","assets/data/levels/new.json","assets/data/levels/petshop.json","assets/data/levels/sr1.json","assets/data/levels/sugar_road.json","assets/data/levels/sugar_road2.json","assets/data/levels/sugarroad2.json","assets/data/levels/test2.json","assets/data/levels/test4.json","assets/data/levels/test4aa.json","assets/data/tilesets/citricalley.json","assets/data/tilesets/datamine.json","assets/data/tilesets/datamine2.json","assets/data/tilesets/datamine3.json","assets/data/tilesets/datamine3.tsx","assets/data/tilesets/datamine5.json","assets/data/tilesets/datamine6.json","assets/data/tilesets/datamineo.json","assets/data/tilesets/datamines.json","assets/data/tilesets/datamino.json","assets/data/tilesets/exotic.json","assets/data/tilesets/gummieleaks.json","assets/data/tilesets/new.json","assets/data/tilesets/new.tsx","assets/data/tilesets/petshop.json","assets/data/tilesets/test4a.tsx","assets/data/tilesets/tileset_sugarroad.json","assets/data/tilesets/tileset_test.json","assets/data/tilesets/tileset_test2.tsx","assets/data/uil.json","assets/shaders/compiled.vs"],ASSETS.SW=["assets/fonts/dogica-bold.json","assets/fonts/dogica-bold.png","assets/fonts/dogica-bold.ttf","assets/fonts/lomo-wall-pixel.json","assets/fonts/lomo-wall-pixel.png","assets/fonts/lomo-wall-pixel.ttf","assets/fonts/lomo-wall-pixel.woff","assets/fonts/lomo-wall-pixel.woff2","assets/fonts/lomo-web-pixel.json","assets/fonts/lomo-web-pixel.png","assets/fonts/lomo-web-pixel.ttf","assets/fonts/lomo-web-pixel.woff","assets/fonts/lomo-web-pixel.woff2","assets/fonts/odisseia.json","assets/fonts/odisseia.otf","assets/fonts/odisseia.png","assets/css/style.css","assets/js/app.js"],Class((function AudioConfig(){function sound(name,volume=1){return{src:!1!==name&&`assets/audio/${name}.mp3`,volume:volume}}function music(name,volume=1,loop=!0){return{src:!1!==name&&`assets/audio/${name}.mp3`,loop:loop,volume:volume}}this.EFFECTS={shoot:sound("effect-shoot",1),coin:sound("effect-pickup-coin",1),key:sound("effect-powerup",.45),powerUp:sound("effect-level-success",.8),collectAll:sound("effect-collect-all",1),jump:sound("effect-click",.4),land:sound("effect-enemy-shoot",.5),hurt:sound("effect-hurt",1),playerDeath:sound("effect-level-fail",.75),enemyDeath:sound("effect-powerup",.45),enemyShoot:sound("effect-enemy-shoot",1),text:sound(!1,1),gateOpen:sound("effect-click",.4),levelStart:sound("effect-level-eaten",.2),levelSuccess:sound("effect-level-eaten",1),levelFail:sound("effect-level-fail",.25),click:sound("effect-click",.3),freePet:sound("effect-click",.35),resultsCounter:sound("effect-results-counter",.75)},this.TRACKS={siteMainTrack:music("track-site-background",.015),trackLevelGummiLeaks:music("track-gummi-leaks",.15),trackLevelDataMine:music("track-data-mine",.15),trackLevelCitricAlley:music("track-citric-alley",.15),trackLevelSugarRoad:music("track-sugar-road",.15),trackLevelExoticPetShop:music("track-exotic-pet-shop",.15),lowHealth:music("track-low-health",1),lowTime:music("track-low-time",.6),results:music("track-jingle",.35,!1)}}),"static"),Module((function Bosses(){this.exports={LevelGummiLeaks:{offset:{x:0,y:1e3},position:{x:100,y:400},happy:"excited",sad:"sad"},LevelDataMine:{offset:{x:0,y:2750},position:{x:0,y:475},happy:"animation",sad:"animation_bad"},LevelCitricAlley:{offset:{x:0,y:3250},position:{x:0,y:700},happy:"excited",sad:"sad"},LevelSugarRoad:{offset:{x:0,y:2350},position:{x:0,y:400},happy:"excited",sad:"sad"},LevelExoticPetShop:{offset:{x:0,y:1e3},position:{x:0,y:250},happy:"excited",sad:"sad"}}})),Module((function Collectibles(){this.exports={LevelGummiLeaks:{coins:{x:1,y:1,type:0},keys:[{x:0,y:2,type:2},{x:2,y:32,type:2}],jump:[{x:2,y:1,type:1},{x:1,y:32,type:1}],speed:{x:4,y:32,type:3},invincible:{x:5,y:32,type:4},disable:{x:6,y:32,type:5},random:{x:7,y:32,type:6}},LevelDataMine:{coins:{x:0,y:32,type:0},jump:{x:1,y:32,type:1},keys:{x:2,y:32,type:2},speed:{x:4,y:32,type:3},invincible:{x:5,y:32,type:4},disable:{x:6,y:32,type:5},random:{x:7,y:32,type:6}},LevelCitricAlley:{coins:{x:0,y:32,type:0},jump:{x:1,y:32,type:1},keys:{x:2,y:32,type:2},speed:{x:4,y:32,type:3},invincible:{x:5,y:32,type:4},disable:{x:6,y:32,type:5},random:{x:7,y:32,type:6}},LevelSugarRoad:{coins:{x:0,y:32,type:0},jump:{x:1,y:32,type:1},keys:{x:2,y:32,type:2},speed:{x:4,y:32,type:3},invincible:{x:5,y:32,type:4},disable:{x:6,y:32,type:5},random:{x:7,y:32,type:6}},LevelExoticPetShop:{coins:{x:0,y:32,type:0},jump:{x:1,y:32,type:1},keys:{x:2,y:32,type:2},speed:{x:4,y:32,type:3},invincible:{x:5,y:32,type:4},disable:{x:6,y:32,type:5},random:{x:7,y:32,type:6}}}})),Class((function Colors(){Inherit(this,Component);const _this=this;var _colors={};!function initConfig(){let config=InputUIL.create("colors",_this.isPlayground()?void 0:null);config.setLabel("Colors"),config.add("total",9);let count=config.getNumber("total");for(let i=0;i<count;i++){let configColor=InputUIL.create("color_"+i,_this.isPlayground()?void 0:null);configColor.setLabel("Color"),configColor.add("name",""),configColor.addColor("color"),_colors[configColor.get("name")]=configColor.get("color")}}(),_this.getColor=function(color){return _colors[color]},_this.get("colors",_=>_colors)}),"singleton"),Class((function Config(){Inherit(this,Model);this.PROD=!window.location.host.includes(["localhost","activetheory"]),this.PREVIEW=window._CONFIG_&&window._CONFIG_.PREVIEW&&Utils.query("preview"),this.PREVIEW&&(window._CONFIG_.DATA=""+window._CONFIG_.PREVIEW),this.DATA=window._CONFIG_&&window._CONFIG_.DATA,this.API=window._CONFIG_&&window._CONFIG_.API||"/api",this.BOT=Utils.query("ImABot")||!(!window._CONFIG_||!window._CONFIG_.CAPTCHA)&&window._CONFIG_.CAPTCHA.score<.4,this.API_TEST=window._CONFIG_&&window._CONFIG_.API_TEST||"/api",this.ANALYTICS_ID="UA-109981912-19",this.CAN_REGISTER=(new Date).getTime()>15989328e5,this.LEVEL_ORDER=["LevelGummiLeaks","LevelDataMine","LevelCitricAlley","LevelSugarRoad","LevelExoticPetShop"],this.CMS_LEVEL={LevelGummiLeaks:"gummi-leaks",LevelDataMine:"data-mine",LevelCitricAlley:"citric-alley",LevelSugarRoad:"sugar-road",LevelExoticPetShop:"the-exotic-pet-shop"},this.TRACK_LEVEL={LevelGummiLeaks:{index:0,intro:"IntroGummiLeaks",name:"Devour Data",route:"devour-data",type:"LevelDevourData"},LevelCitricAlley:{index:1,intro:"IntroCitricAlley",name:"Crack Firewalls",route:"crack-firewalls",type:"LevelCrackFirewalls"},LevelDataMine:{index:2,intro:"IntroDataMine",name:"Wiggle Deep",route:"wiggle-deep",type:"LevelWiggleDeep"},LevelSugarRoad:{index:3,intro:"IntroSugarRoad",name:"Escape Glitch",route:"escape-glitch",type:"LevelEscapeGlitch"},LevelExoticPetShop:{index:4,intro:"IntroExoticPetShop",name:"Free Friends",route:"free-friends",type:"LevelFreeFriends"}}}),"static"),Module((function Controls(){this.exports={desktop:{up:[38,87],down:[40,83],left:[37,65],right:[39,68],jump:[32,38,87],action:[88,69]},mobile:{sensitivity:1.5,deadZone:.5,jump:"a",action:"b"}}})),Module((function Enemies(){this.exports={LevelGummiLeaks:{BasicEnemy:{x:13,y:3},ShootingEnemy:{x:1,y:30},FlyingEnemy:{x:2,y:30}},LevelDataMine:{BasicEnemy:{x:0,y:30},ShootingEnemy:{x:1,y:30},FlyingEnemy:{x:2,y:30}},LevelCitricAlley:{BasicEnemy:{x:0,y:30},ShootingEnemy:{x:1,y:30},FlyingEnemy:{x:2,y:30}},LevelSugarRoad:{BasicEnemy:{x:0,y:30},ShootingEnemy:{x:1,y:30},FlyingEnemy:{x:2,y:30}},LevelExoticPetShop:{BasicEnemy:{x:0,y:30},ShootingEnemy:{x:1,y:30},FlyingEnemy:{x:2,y:30}}}})),Module((function Hacks(){this.exports={invincible:{duration:1e4},disableEnemies:{duration:1e4},speedBoost:{duration:1e4,amount:2},jumping:{duration:1e4}}})),Module((function Hazards(){let damage={harmful:!0,type:0,coordinates:{x:2,y:31},collision:function(player,hazards){hazards.events.fire(PlayerHealth.DAMAGE)}},bounce={harmful:!1,type:2,coordinates:{x:3,y:31},collision:function(player,hazards){let value=-Math.max(35,1.05*Math.abs(player.movement.velocity.y));value>-40&&player.movement.flag("hitBounce",!0,10),player.movement.velocity.y=value}};this.exports={slowing:{harmful:!0,type:1,coordinates:{x:1,y:31},collision:function(player,hazards){player.movement.velocity.x*=.5}},slippery:{harmful:!1,type:3,coordinates:{x:0,y:31},collision:function(player,hazards){player.movement.velocity.x*=1.15}},damage:damage,bounce:bounce,treadmillRight:{harmful:!1,type:4,coordinates:{x:4,y:31},collision:function(player,hazards){player.movement.velocity.x+=2}},treadmillLeft:{harmful:!1,type:4,coordinates:{x:5,y:31},collision:function(player,hazards){player.movement.velocity.x-=2}}}})),Module((function Health(){this.exports={maxHealth:3,invulnerableDuration:2e3,damagePerHit:1}})),Module((function LevelAnimations(){this.exports={LevelGummiLeaks:{},LevelDataMine:{frameSize:32,textureSize:512},LevelCitricAlley:{},LevelSugarRoad:{},LevelExoticPetShop:{}}})),Class((function Levels(){Inherit(this,Component);const _this=this;var _levels=[];!function initConfig(){let config=InputUIL.create("levels",_this.isPlayground()?void 0:null);config.setLabel("Levels"),config.add("total",5);let count=config.getNumber("total");for(let i=0;i<count;i++){let configLevel=InputUIL.create("level_"+i,_this.isPlayground()?void 0:null);configLevel.setLabel("Levels"),configLevel.addColor("color"),configLevel.add("title","Level "+i),configLevel.addTextarea("story",""),configLevel.addVector("video",[0,0]),configLevel.add("id","level"),configLevel.add("intro","intro"),configLevel.addToggle("showKeysUI",!1),_levels.push({color:configLevel.get("color"),title:configLevel.get("title"),story:configLevel.get("story"),video:configLevel.get("video"),level:configLevel.get("id"),intro:configLevel.get("intro"),showKeysUI:configLevel.get("showKeysUI"),index:i})}}(),_this.getList=_=>_levels,_this.getItem=index=>_levels[index],_this.getItemById=function(id){return _levels.find(level=>level.level==id)}}),"singleton"),Module((function Movement(){this.exports={maxSpeed:14,acceleration:1.25,maxJump:25,gravity:1.5,powerDropSpeed:50,powerDropXMultiplier:.25}})),Module((function Player(){this.exports={colors:[["#60b7dd","#aa3077"],["#fadf4d","#ca302e"],["#8848d9","#cb388b"],["#79fa76","#c95022"]]}})),Class((function Regex(){this.NAME=/^[a-zA-Z ,.'-]+$/u,this.EMAIL=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,this.ZIP=/^\d{5}(?:[-\s]\d{4})?$/}),"static"),Module((function Scoring(){function toHalves(score=0){return Math.round(2*score)/2}this.exports={calculate:function calculate(c,t,mit,mat,mic,mac,tw,cw){mit=isNaN(mit)?0:mit,mat=isNaN(mat)?10:mat,mic=isNaN(mic)?0:mic,mac=isNaN(mac)?1:mac,tw=isNaN(tw)?1:tw,cw=isNaN(tw)?1:tw;const TIME_SCORING_WEIGHT=Math.max(1,tw),COIN_SCORING_WEIGHT=Math.max(1,cw),TIME=TIME_SCORING_WEIGHT/(COIN_SCORING_WEIGHT+TIME_SCORING_WEIGHT)*3,COIN=COIN_SCORING_WEIGHT/(COIN_SCORING_WEIGHT+TIME_SCORING_WEIGHT)*3,minTime=6e4*mit,maxTime=6e4*mat,minCoins=mic,maxCoins=mac,fullTime=Math.range(t,minTime,maxTime,0,TIME,!0),fullCoins=Math.range(c,minCoins,maxCoins,0,COIN,!0),time=toHalves(fullTime),coins=toHalves(fullCoins),score=Math.min(time+coins,3);return{score:score,time:time,coins:coins,hint:function getHint(score,time,coins,COIN,TIME,TOTAL_SCORE){return score===TOTAL_SCORE?"congrats":coins/COIN>=time/TIME?"time":"coins"}(score,fullTime,fullCoins,COIN,TIME,3),maxCoins:maxCoins}}}})),Module((function SugarRoadGlitch(){this.exports={onScreenProgress:.25,offScreenProgress:6,start:37400,end:13e3,spawns:[{x:3900,y:26400},{x:5500,y:26400},{x:5400,y:25900},{x:4500,y:25200},{x:3500,y:24600},{x:2700,y:24e3},{x:2500,y:23e3},{x:2800,y:22e3},{x:2700,y:21400},{x:3500,y:20800},{x:5100,y:2e4},{x:6800,y:19400},{x:4200,y:18800},{x:2300,y:18100},{x:1900,y:16700},{x:2600,y:16100},{x:1900,y:15600},{x:2800,y:14800},{x:5500,y:14100},{x:2400,y:13700},{x:2400,y:13e3},{x:2300,y:12200},{x:6300,y:12200},{x:2500,y:10900},{x:2400,y:1e4},{x:3500,y:8900},{x:5e3,y:8900},{x:4200,y:8400},{x:4200,y:7300},{x:2400,y:6500},{x:5500,y:6500},{x:4500,y:5700},{x:1900,y:5700},{x:6500,y:5700},{x:5500,y:5e3},{x:6500,y:4700},{x:5900,y:3900},{x:6600,y:3300},{x:5800,y:2800},{x:2900,y:5200},{x:3600,y:11500},{x:5400,y:11500},{x:3600,y:16700},{x:5500,y:16700}]}})),Class((function UI(){this.FONT_PRIMARY="lomo-wall-pixel",this.FONT_SECONDARY="odisseia",this.FONT_TERTIARY="lomo-web-pixel",this.FONT_ACCENT="dogica-bold"}),"static"),Module((function Weapons(){this.exports=[{id:"default",style:"#dddddd",perShot:1,rate:3,speed:30,size:.25,life:2e3,shake:15,update:function(projectile,position){let speed=Math.range(Math.cos(100*projectile.random),-1,1,.8*projectile.speed,1.2*projectile.speed),offset=Math.range(projectile.random,0,1,.02,.07),angle=Math.sin(.025*projectile.life*Math.range(projectile.random,0,1,.75,1.5)+2*Math.PI*projectile.random)*offset,direction=Math.range(projectile.random,0,1,-.005,.005);position.x+=speed*projectile.direction*Render.HZ_MULTIPLIER,position.y+=angle+100*direction*Render.HZ_MULTIPLIER}},{id:"defaultEnemy",style:"#dddddd",perShot:1,rate:3,speed:10,size:.25,life:4e3,shake:15,update:function(projectile,position){position.x+=projectile.speed*projectile.direction*Render.HZ_MULTIPLIER,position.y+=5*Math.sin(.01*projectile.life+.5*Math.PI)*Render.HZ_MULTIPLIER}},{id:"sineballs",style:"#ff5511",perShot:1,rate:5,speed:7,size:.75,life:5e3,shake:0,update:function(projectile,position){position.x+=projectile.speed*projectile.direction*.01*Render.HZ_MULTIPLIER,position.y+=.05*Math.sin(.01*projectile.life)*Render.HZ_MULTIPLIER}},{id:"shotgun",style:"#dddddd",perShot:6,rate:1,speed:30,size:.125,life:3e3,shake:60,update:function(projectile,position){let speed=projectile.direction*Math.range(Math.sin(30*projectile.random),-1,1,.74*projectile.speed,projectile.speed),y=projectile.speed*Math.range(projectile.random,0,1,-.1,.1);position.x+=.01*speed*Render.HZ_MULTIPLIER,position.y+=.01*y*Render.HZ_MULTIPLIER}},{id:"machinegun",style:"#ffffff",perShot:1,rate:50,speed:30,size:.075,life:3e3,shake:5,update:function(projectile,position){let speed=projectile.direction*Math.range(Math.sin(30*projectile.random),-1,1,.5*projectile.speed,projectile.speed),y=projectile.speed*Math.range(projectile.random,0,1,-.03,.03);position.x+=.01*speed*Render.HZ_MULTIPLIER,position.y+=.01*y*Render.HZ_MULTIPLIER}}]})),Module((function DialogRobotAnimation(){this.exports={src:"assets/images/npcs/robot-dialog.png",frameSize:90,textureSize:900,animations:{idle:{index:0,frames:7,loops:!0},speech:{index:1,frames:7,loops:!0}}}})),Module((function KeyRobotAnimation(){this.exports={src:"assets/images/npcs/robot-key.png",frameSize:90,textureSize:900,animations:{idle:{index:0,frames:7,loops:!0},speech:{index:1,frames:7,loops:!0}}}})),Module((function PlayerAnimation(){this.exports={src:"assets/images/player/main_character_sprites.png",frameSize:32,textureSize:512,animations:{walk:{index:1,frames:6,loops:!0},idle:{index:0,frames:4,loops:!0}}}})),Module((function PCLvl1End(){let dialog=[{message:player=>{let remaining=5-player.inventory.items.keys;switch(remaining){case 0:return Data.LEVELS["gummi-leaks"].levelDialogue2;default:let str=Data.LEVELS["gummi-leaks"].levelDialogue1;return str=str.replaceAll("<$>",remaining),1===remaining&&(str=str.replaceAll("sticks","stick")),str}},response:"..."}];this.exports={name:"PC",dialog:dialog,animation:"KeyRobot",behavior:function(mesh,player){if(!mesh.transform||!player.transform)return;let direction=player.transform.x>mesh.transform.x?-1:1;mesh.shader.set("uDirection",direction)}}})),Module((function PCLvl1Start(){let dialog=[{message:player=>function parseDesktopString(str){let parts=[],pieces=str.split("<d>"),enclosed=!1;for(let piece of pieces)(!enclosed||enclosed&&!Device.mobile)&&parts.push(piece),enclosed=!enclosed;return parts.join("")}(Data.LEVELS["gummi-leaks"].levelDialogue0),response:"..."}];this.exports={name:"PC",dialog:dialog,animation:"KeyRobot",behavior:function(mesh,player){if(!mesh.transform||!player.transform)return;let direction=player.transform.x>mesh.transform.x?-1:1;mesh.shader.set("uDirection",direction)}}})),Module((function PCLvl2(){let dialog=[{message:player=>Data.LEVELS["data-mine"].levelDialogue0,response:"..."}];this.exports={name:"PC",dialog:dialog,animation:"DialogRobot",behavior:function(mesh,player){if(!mesh.transform||!player.transform)return;let direction=player.transform.x>mesh.transform.x?-1:1;mesh.shader.set("uDirection",direction)}}})),Module((function PCLvl3(){let dialog=[{message:player=>Data.LEVELS["citric-alley"].levelDialogue0,response:"..."}];this.exports={name:"PC",dialog:dialog,animation:"DialogRobot",behavior:function(mesh,player){if(!mesh.transform||!player.transform)return;let direction=player.transform.x>mesh.transform.x?-1:1;mesh.shader.set("uDirection",direction)}}})),Module((function PCLvl4(){let dialog=[{message:player=>Data.LEVELS["sugar-road"].levelDialogue0,response:"..."}];this.exports={name:"PC",dialog:dialog,animation:"DialogRobot",behavior:function(mesh,player){if(!mesh.transform||!player.transform)return;let direction=player.transform.x>mesh.transform.x?-1:1;mesh.shader.set("uDirection",direction)}}})),Module((function PCLvl5End(){let dialog=[{message:player=>{let remaining=5-player.level.doors.unlocked;switch(remaining){case 0:return Data.LEVELS["the-exotic-pet-shop"].levelDialogue2;default:let str=Data.LEVELS["the-exotic-pet-shop"].levelDialogue1;return str=str.replaceAll("<$>",remaining),1===remaining&&(str=str.replaceAll("friends","friend")),str}},response:"..."}];this.exports={name:"PC",dialog:dialog,animation:"KeyRobot",behavior:function(mesh,player){if(!mesh.transform||!player.transform)return;let direction=player.transform.x>mesh.transform.x?-1:1;mesh.shader.set("uDirection",direction)}}})),Module((function PCLvl5Start(){let dialog=[{message:player=>Data.LEVELS["the-exotic-pet-shop"].levelDialogue0,response:"..."}];this.exports={name:"PC",dialog:dialog,animation:"KeyRobot",behavior:function(mesh,player){if(!mesh.transform||!player.transform)return;let direction=player.transform.x>mesh.transform.x?-1:1;mesh.shader.set("uDirection",direction)}}})),Module((function Buddy(){this.exports={name:"Buddy",dialog:[{message:"Hello friend!",response:"hi pal"},{message:"Dont touch the ghosts",response:"why not?"},{message:"They are too scary",response:"ok thanks"},{message:"Good talk, see you later",response:"see ya"}]}})),Module((function Demo(){this.exports={name:"Demo NPC",dialog:[{message:"Hello friend!",response:"hi pal"},{message:"Dont touch the ghosts",response:"why not?"},{message:"They are too scary",response:"ok thanks"},{message:"Good talk, see you later",response:"see ya"}]}})),Module((function Robot(){this.exports={name:"Robot NPC",dialog:[{message:player=>"You'll need 5 keys to open the gate and complete the level",response:"..."}],animation:"Robot",behavior:function(mesh,player){if(!mesh.transform||!player.transform)return;let direction=player.transform.x>mesh.transform.x?-1:1;mesh.shader.set("uDirection",direction)}}})),Mobile.Class((function Accelerometer(){var _this=this;function updateAccel(e){switch(window.orientation){case 0:_this.x=-e.accelerationIncludingGravity.x,_this.y=e.accelerationIncludingGravity.y,_this.z=e.accelerationIncludingGravity.z,e.rotationRate&&(_this.rotationRate.alpha=e.rotationRate.beta*_this.toRadians,_this.rotationRate.beta=-e.rotationRate.alpha*_this.toRadians,_this.rotationRate.gamma=e.rotationRate.gamma*_this.toRadians);break;case 180:_this.x=e.accelerationIncludingGravity.x,_this.y=-e.accelerationIncludingGravity.y,_this.z=e.accelerationIncludingGravity.z,e.rotationRate&&(_this.rotationRate.alpha=-e.rotationRate.beta*_this.toRadians,_this.rotationRate.beta=e.rotationRate.alpha*_this.toRadians,_this.rotationRate.gamma=e.rotationRate.gamma*_this.toRadians);break;case 90:_this.x=e.accelerationIncludingGravity.y,_this.y=e.accelerationIncludingGravity.x,_this.z=e.accelerationIncludingGravity.z,e.rotationRate&&(_this.rotationRate.alpha=e.rotationRate.alpha*_this.toRadians,_this.rotationRate.beta=e.rotationRate.beta*_this.toRadians,_this.rotationRate.gamma=e.rotationRate.gamma*_this.toRadians);break;case-90:_this.x=-e.accelerationIncludingGravity.y,_this.y=-e.accelerationIncludingGravity.x,_this.z=e.accelerationIncludingGravity.z,e.rotationRate&&(_this.rotationRate.alpha=-e.rotationRate.alpha*_this.toRadians,_this.rotationRate.beta=-e.rotationRate.beta*_this.toRadians,_this.rotationRate.gamma=e.rotationRate.gamma*_this.toRadians)}"android"==Device.system.os&&(_this.x*=-1,_this.y*=-1,_this.z*=-1)}function updateOrientation(e){for(var key in e)key.toLowerCase().includes("heading")&&(_this.heading=e[key]);switch(window.orientation){case 0:_this.alpha=e.beta*_this.toRadians,_this.beta=-e.alpha*_this.toRadians,_this.gamma=e.gamma*_this.toRadians;break;case 180:_this.alpha=-e.beta*_this.toRadians,_this.beta=e.alpha*_this.toRadians,_this.gamma=e.gamma*_this.toRadians;break;case 90:_this.alpha=e.alpha*_this.toRadians,_this.beta=e.beta*_this.toRadians,_this.gamma=e.gamma*_this.toRadians;break;case-90:_this.alpha=-e.alpha*_this.toRadians,_this.beta=-e.beta*_this.toRadians,_this.gamma=e.gamma*_this.toRadians}_this.tilt=e.beta*_this.toRadians,_this.yaw=e.alpha*_this.toRadians,_this.roll=-e.gamma*_this.toRadians,"android"==Device.system.os&&(_this.heading=function compassHeading(alpha,beta,gamma){var degtorad=Math.PI/180,_x=beta?beta*degtorad:0,_y=gamma?gamma*degtorad:0,_z=alpha?alpha*degtorad:0,cY=(Math.cos(_x),Math.cos(_y)),cZ=Math.cos(_z),sX=Math.sin(_x),sY=Math.sin(_y),sZ=Math.sin(_z),Vx=-cZ*sY-sZ*sX*cY,Vy=-sZ*sY+cZ*sX*cY,compassHeading=Math.atan(Vx/Vy);Vy<0?compassHeading+=Math.PI:Vx<0&&(compassHeading+=2*Math.PI);return compassHeading*(180/Math.PI)}(e.alpha,e.beta,e.gamma))}this.x=0,this.y=0,this.z=0,this.alpha=0,this.beta=0,this.gamma=0,this.heading=0,this.rotationRate={},this.rotationRate.alpha=0,this.rotationRate.beta=0,this.rotationRate.gamma=0,this.toRadians="ios"==Device.system.os?Math.PI/180:1,this.capture=function(){this.active||(this.active=!0,window.ondevicemotion=updateAccel,window.addEventListener("deviceorientation",updateOrientation))},this.stop=function(){this.active=!1,window.ondevicemotion=null,_this.x=_this.y=_this.z=0,window.removeEventListener("deviceorientation",updateOrientation)}}),"Static"),Class((function Antimatter(_num,_config,_renderer=World.RENDERER){Inherit(this,AntimatterFBO);var _geometry,_this=this,_drawLimit=_num,_size=function findSize(){var values=[2,4,8,16,32,64,128,256,512,1024,2048,4096];for(let i=0;i<values.length;i++){var p2=values[i];if(p2*p2>=_num)return p2}}();async function createBuffer(){let{geometry:geometry,vertices:vertices,attribs:attribs,usedDepth:usedDepth}=await AntimatterUtil.createBufferArray(_size,_num,_config);_this.vertices=_this.cloneVertices?vertices.clone():vertices,(_geometry=geometry.clone(!0)).drawRange.end=_drawLimit,_this.vertices.geometry=_geometry,_this.attribs=_this.random=attribs,_this.textureUsedDepth=usedDepth,_this.init(_geometry,_renderer,_size)}defer(createBuffer),this.createFloatArray=function(components=3){return new Float32Array(_size*_size*components)},this.createFloatArrayAsync=async function(components=3,freshCopy){let{array:array}=await AntimatterUtil.createFloatArray(_size*_size*components,freshCopy);return array},this.ready=function(callback){return _this.wait(_this,"vertices")},this.useShader=function(vs,fs,params){"object"==typeof fs&&(params=fs,fs=null),this.vertexShader=vs,this.fragmentShader=fs||vs,this.uniforms=params},this.createMesh=this.getMesh=function(){let shader=_this.createShader(_this.fragmentShader||"AntimatterBasicFrag");return _this.mesh=new Points(_geometry,shader),_this.mesh.frustumCulled=!1,_this.shader=shader,_this.geometry=_geometry,_this.mesh},this.createShader=function(fs){let uniforms=_this.uniforms||{},obj={tPos:{type:"t",value:_this.vertices.texture,ignoreUIL:!0},tPrevPos:{type:"t",value:_this.vertices.texture,ignoreUIL:!0}};for(let key in uniforms)obj[key]=uniforms[key];let shader=new Shader(_this.vertexShader||"AntimatterPosition",fs,obj),vs=shader.vertexShader;if(vs&&!vs.includes("uniform sampler2D tPos")){let split=vs.split("__ACTIVE_THEORY_LIGHTS__"),defined="uniform sampler2D tPos;";shader.vertexShader=split[0]+"\n"+defined+"\n__ACTIVE_THEORY_LIGHTS__\n"+split[1]}return shader},this.getLookupArray=function(){return new Float32Array(_this.vertices.geometry.attributes.position.array)},this.getRandomArray=function(){return _geometry.attributes.random.array},this.overrideShader=function(original){let shader=original.clone();original.copyUniformsTo(shader),shader.uniforms.tPos={type:"t",value:_this.vertices.texture,ignoreUIL:!0},shader.uniforms.tPrevPos={type:"t",value:_this.vertices.texture,ignoreUIL:!0},_this.shader=shader,_this.mesh.shader=shader},this.upload=async function(){_this.preventRender=!0,_geometry.distributeBufferData=!0,await _this.ready(),await _this.vertices.uploadAsync(),await defer(),await _this.random.uploadAsync(),await defer(),_this.mesh&&(_this.mesh.upload(),await _geometry.uploadBuffersAsync());for(let key in _this.shader.uniforms){let uniform=_this.shader.uniforms[key];uniform.value&&(uniform.value.uploadAsync?await uniform.value.uploadAsync():uniform.value.upload&&(uniform.value.upload(),await defer()))}await _this.wait(100);for(let i=0;i<_this.passes.length;i++)await _this.passes[i].upload();_this.preventRender=!1},this.uploadSync=async function(){await _this.ready(),_this.customClass&&_this.customClass.loaded&&await _this.customClass.loaded(),_this.mesh&&_this.mesh.upload();for(let i=0;i<4;i++)_this.update()},this.get("particleCount",_=>_size*_size)})),Class((function AntimatterAttribute(_data,_components){Inherit(this,Component);var _this=this,_size=Math.sqrt(_data.length/(_components||3));this.size=_size,this.count=_size*_size,this.buffer=_data,this.texture=new DataTexture(_data,_size,_size,4==_components?Texture.RGBAFormat:Texture.RGBFormat,Texture.FLOAT),this.set("needsUpdate",(function(){_this.texture.needsUpdate=!0})),this.bufferData=function(data,components){_this.buffer=data,components!=_components?(_this.texture.destroy(),_this.texture=new DataTexture(data,_size,_size,4==components?Texture.RGBAFormat:Texture.RGBFormat,Texture.FLOAT)):(_this.texture.data=data,_this.texture.needsUpdate=!0),_components=components,_data=data},this.upload=function(){_this.texture.upload()},this.uploadAsync=function(){return _this.texture.distributeTextureData=!0,_this.texture.upload(),_this.texture.uploadAsync()},this.clone=function(){return new AntimatterAttribute(_data,_components)},this.onDestroy=function(){_this.texture&&_this.texture.destroy&&_this.texture.destroy()}})),Class((function AntimatterFBO(){var _this,_gpuGeom,_renderer,_size,_prevRT,_scene,_mesh,_camera,_copy,_geometry;Inherit(this,Component);var _output={type:"t",value:null,ignoreUIL:!0},_prevOutput={type:"t",value:null,ignoreUIL:!0};function copy(input,output){World.RENDERER.blit(input,output)||(_copy.visible=!0,_mesh.visible=!1,_copy.shader.uniforms.tMap.value=input,_renderer.renderSingle(_copy,_camera,output),_copy.visible=!1,_mesh.visible=!0)}this.passes=[],this.init=function(geometry,renderer,size){_this=this,_gpuGeom=geometry.attributes.position.array,_renderer=renderer,_size=size,function initPasses(){_camera=World.CAMERA,_geometry=World.QUAD,_scene=new Scene,(_mesh=new Mesh(_geometry,null)).frustumCulled=!1,_mesh.noMatrices=!0,_mesh.transient=!0,_scene.add(_mesh);let copyShader=AntimatterFBO.getCopyShader();(_copy=new Mesh(_geometry,copyShader)).noMatrices=!0,_scene.add(_copy),_copy.visible=!1}()},this.getGPUGeom=function(){return _gpuGeom},this.addPass=function(pass,index){_this=this,pass.init||pass.initialize(_size),"number"!=typeof index?_this.passes.push(pass):_this.passes.splice(index,0,pass)},this.findPass=function(name){_this=this;for(var i=0;i<_this.passes.length;i++){var pass=_this.passes[i];if(pass.name==name)return pass}},this.removePass=function(pass){_this=this,"number"==typeof pass?_this.passes.splice(pass):_this.passes.remove(pass)},this.update=function(){if((_this=this).mesh&&!_this.preventRender){var output=_output.value||_this.vertices.texture;_this.storeVelocity&&(_prevRT?(copy(_output.value,_prevRT),_prevOutput.value=_prevRT):(_prevOutput.value=output,(_prevRT=_this.passes[0].getRT(0).clone()).upload()));for(var i=0;i<_this.passes.length;i++){var pass=_this.passes[i],needsInit=!pass.init,firstRender=!pass.first;needsInit&&pass.initialize(_size),pass.first=!0,_mesh.shader=pass.shader,_mesh.shader.uniforms.tInput.value=firstRender?_this.vertices.texture:pass.output,pass.ready||(_mesh.shader.uniforms.tInput.value=_this.vertices.texture);var rt=firstRender?pass.getRT(0):pass.getWrite();output=pass.output;_renderer.renderSingle(_scene.children[0],_camera,rt),copy(rt,output),pass.swap()}output&&(_output.value=output,_this.mesh.shader.uniforms.tPos.value=_output.value,_this.mesh.shader.uniforms.tPrevPos.value=_prevOutput.value)}},this.onDestroy=function(){_this.vertices&&_this.vertices.destroy&&_this.vertices.destroy(),_this.attribs&&_this.attribs.destroy&&_this.attribs.destroy(),_this.passes.forEach((function(pass){pass.first=!1,_this.persistPasses||pass&&pass.destroy&&pass.destroy()})),_this.mesh.destroy()},this.getOutput=function(){return _output},this.getPrevOutput=function(){return _prevOutput}}),(function(){var _shader;AntimatterFBO.getCopyShader=function(){return _shader||((_shader=new Shader("ScreenQuad")).uniforms={tMap:{type:"t",value:null}},_shader._attachmentData={format:Texture.RGBAFormat,type:Texture.FLOAT,attachments:1}),_shader}})),Class((function AntimatterPass(_shader,_uni,_clone){var _this=this;this.UILPrefix="am_"+_shader;const _uniforms={tInput:{type:"t",value:null,ignoreUIL:!0},fSize:{type:"f",value:64,ignoreUIL:!0}};var _rts=[],_read=0,_write=0;function prepareShader(code,type){if("vs"==type)return code;let header=["uniform sampler2D tInput;","uniform float fSize;","varying vec2 vUv;",Shaders.getShader("antimatter.glsl")].join("\n"),mainAt=code.indexOf("void main()"),before=code.slice(0,mainAt),after=code.slice(mainAt);return code=before+header+after,_this.onCreateShader&&(code=_this.onCreateShader(code)),code}function initRT(size){var type="ios"==Device.system.os?Texture.HALF_FLOAT:Texture.FLOAT,parameters={minFilter:Texture.NEAREST,magFilter:Texture.NEAREST,format:Texture.RGBAFormat,type:type},rt=new RenderTarget(size,size,parameters);return rt.texture.generateMipmaps=!1,rt}this.uniforms=_uniforms,this.output=initRT(64),this.name=_shader,this.id=Utils.timestamp(),this.ready=!1,function(){if(_uni)for(var key in _uni.unique&&(_this.UILPrefix+="_"+_uni.unique.replace("/","_"),delete _uni.unique),_uni.customCompile&&(_this.customCompile=_uni.customCompile||"",delete _uni.customCompile),_uni)_uniforms[key]=_uni[key]}(),this.addInput=function(name,attribute){var uniform="object"!=typeof attribute||attribute.height||"string"!=typeof attribute.type?attribute instanceof AntimatterAttribute?{type:"t",value:attribute.texture,ignoreUIL:!0}:attribute instanceof AntimatterPass?{type:"t",value:attribute.output,ignoreUIL:!0}:{type:"t",value:attribute,ignoreUIL:!0}:attribute;let lookup=UILStorage.parse(_this.UILPrefix+name);return lookup&&(uniform.value=lookup.value),_uniforms[name]=uniform,uniform.ignoreUIL=!0,_uniforms[name]},this.addUniforms=function(object){for(let key in object){let uniform=object[key],lookup=UILStorage.parse(_this.UILPrefix+key);if(lookup){if(Array.isArray(lookup.value))switch(lookup.value.length){case 2:lookup.value=(new Vector2).fromArray(lookup.value);break;case 3:lookup.value=(new Vector3).fromArray(lookup.value);break;case 4:lookup.value=(new Vector4).fromArray(lookup.value)}uniform.value=lookup.value}_uniforms[key]=uniform}},this.getRT=function(index){return _rts[index]},this.getRead=function(){return _rts[_read]},this.getWrite=function(){return _rts[_write]},this.setRead=function(index){_read=index},this.setWrite=function(index){_write=index},this.swap=function(){++_write>2&&(_write=0,_this.ready=!0),++_read>2&&(_this.onInit&&(_this.onInit(),_this.onInit=null),_read=0)},this.initialize=function(size){if(!_this.init){_this.init=!0;for(var i=0;i<3;i++)_rts.push(initRT(size));_this.output.setSize(size,size),_shader instanceof Shader||((_shader=new Shader("AntimatterPass",_shader,{customCompile:_this.customCompile}))._attachmentData={format:Texture.RGBAFormat,type:Texture.FLOAT,attachments:1},_shader.preCompile=prepareShader,_shader.uniforms=_uniforms,_shader.UILPrefix=_this.UILPrefix,_shader.id=Utils.timestamp()),_this.shader=_shader,_shader.uniforms.fSize.value=size}},this.setUniform=function(key,value){_uniforms[key]||(_uniforms[key]={value:value}),_uniforms[key].value=value,_shader&&_shader.uniforms&&(_shader.uniforms[key].value=value)},this.getUniform=function(key){return _shader&&_shader.uniforms?_shader.uniforms[key].value:null},this.tween=function(key,value,time,ease,delay,callback,update){return tween(_shader.uniforms[key],{value:value},time,ease,delay,callback,update)},this.clone=function(){return new AntimatterPass(_shader,_uni)},this.destroy=function(){_rts.forEach((function(rt){rt&&rt.destroy&&rt.destroy()}))},this.upload=async function(){_shader.upload(),await defer();for(let i=0;i<_rts.length;i++)_rts[i].upload(),await defer();for(let key in _shader.uniforms){let uniform=_shader.uniforms[key];uniform.value&&(uniform.value.uploadAsync?await uniform.value.uploadAsync():uniform.value.upload&&(uniform.value.upload(),await defer()))}}})),Class((function AntimatterSpawn(_proton,_group,_input){Inherit(this,Component);const _this=this;var _life,_pass,_velocity,_color,_index=-1,_total=_proton.particleCount,_releasedA=[],_releasedB=[];function loop(){let count=_releasedA.length;for(let i=count-1;i>-1;i--){let index=_releasedA[i];_life.buffer[4*index+0]=0}_releasedA.length=0,count&&(_life.needsUpdate=!0);let hold=_releasedA;_releasedA=_releasedB,_releasedB=hold}!async function(){await async function initPass(){let[lifeBuffer,velocityBuffer]=await Promise.all([_proton.antimatter.createFloatArrayAsync(4,!0),_proton.antimatter.createFloatArrayAsync(3,!0)]);_life=_this.initClass(AntimatterAttribute,lifeBuffer,4),_velocity=_this.initClass(AntimatterAttribute,velocityBuffer,3),_pass=_this.initClass(AntimatterPass,"AntimatterSpawn",{unique:_input.prefix,uMaxCount:_proton.behavior.uniforms.uMaxCount,tAttribs:_proton.behavior.uniforms.tAttribs,tLife:{value:_life,ignoreUIL:!0},uSetup:{value:1,ignoreUIL:!0},decay:{value:1},decayRandom:{value:new Vector2(1,1)}}),ShaderUIL.add(_pass,_group).setLabel("Life Shader"),_pass.onInit=_=>{_pass.setUniform("uSetup",0),_this.canEmit=!0},_proton.behavior.addInput("tSpawn",_pass),_proton.behavior.addInput("tVelocity",_velocity),_proton.shader.addUniforms({tLife:{value:_pass.output}}),_proton.antimatter.addPass(_pass,0),_this.lifeOutput=_pass.output}(),_this.startRender(loop)}(),this.emit=function(position,velocity,color){if(!_this.canEmit)return;if(velocity&&position.length!=velocity.length)throw"Position and velocity need to be the same length";if(color&&position.length!=color.length)throw"Position and color need to be the same length";let count=position.length/3;for(let i=0;i<count;i++){let index=++_index;_index>=_total&&(_index=-1),_life.buffer[4*index+0]=1,_life.buffer[4*index+1]=position[3*i+0],_life.buffer[4*index+2]=position[3*i+1],_life.buffer[4*index+3]=position[3*i+2],velocity&&(_velocity.buffer[3*index+0]=velocity[3*i+0],_velocity.buffer[3*index+1]=velocity[3*i+1],_velocity.buffer[3*index+2]=velocity[3*i+2]),color&&_color&&(_color.buffer[3*index+0]=color[3*i+0],_color.buffer[3*index+1]=color[3*i+1],_color.buffer[3*index+2]=color[3*i+2]),_releasedB.push(index)}_life.needsUpdate=!0,velocity&&(_velocity.needsUpdate=!0),color&&_color&&(_color.needsUpdate=!0)},this.release=function(pos,count=1,radius=0,velocity){if(!_this.canEmit)return;let positions=[],velocities=velocity?[]:null;for(let i=0;i<count;i++)positions[3*i+0]=pos.x+Math.random(-1,1,4)*radius,positions[3*i+1]=pos.y+Math.random(-1,1,4)*radius,positions[3*i+2]=pos.z+Math.random(-1,1,4)*radius,velocities&&(velocities[3*i+0]=velocity.x,velocities[3*i+1]=velocity.y,velocities[3*i+2]=velocity.z);_this.emit(positions,velocities)},this.upload=async function(){await _life.uploadAsync(),await _velocity.uploadAsync()},this.useColor=async function(shader){let colorBuffer=await _proton.antimatter.createFloatArrayAsync(3,!0);_color=_this.initClass(AntimatterAttribute,colorBuffer,3),shader||(shader=_proton.shader),shader.addUniforms({tColor:{value:_color}})},this.get("total",_=>_total),this.get("index",_=>_index),this.set("index",i=>_index=i)})),Class((function AntimatterUtil(){Inherit(this,Component);var _thread,_this=this,_promises={};function createBufferArrayAntimatter(e,id){let size=e.size,num=e.num,position=new Float32Array(size*size*3);if(window.NativeUtils)NativeUtils.fillBufferUV(position,num,size);else for(let i=0;i<num;i++)position[3*i+0]=i%size/size,position[3*i+1]=Math.floor(i/size)/size,position[3*i+2]=i;let{w:w,h:h,d:d}=e.dimensions,usedDepth=num/(size*size),grid=0==w[0]&&0==w[1]&&0==h[0]&&0==h[1];var vertices=new Float32Array(size*size*4);if(window.NativeUtils)grid?NativeUtils.fillBufferGrid(vertices,num,size,usedDepth):NativeUtils.fillBufferRange(vertices,num,w[0],w[1],h[0],h[1],d[0],d[1]);else for(let i=0;i<num;i++)grid?(vertices[4*i+0]=Math.range(i%size,0,size,-1,1),vertices[4*i+1]=Math.range(i/size,size*usedDepth*usedDepth,0,-1,1)):(vertices[4*i+0]=Math.random(w[0],w[1],10),vertices[4*i+1]=Math.random(h[0],h[1],10),vertices[4*i+2]=Math.random(d[0],d[1],10)),vertices[4*i+3]=1;var attribs=new Float32Array(size*size*4);if(window.NativeUtils)NativeUtils.fillBufferRandom(attribs,attribs.length);else for(let i=0;i<num;i++)attribs[4*i+0]=Math.random(0,1,10),attribs[4*i+1]=Math.random(0,1,10),attribs[4*i+2]=Math.random(0,1,10),attribs[4*i+3]=Math.random(0,1,10);resolve({geometry:position,vertices:vertices,attribs:attribs,usedDepth:usedDepth},id,[position.buffer,vertices.buffer,attribs.buffer])}function createFloatArrayAntimatter({size:size},id){let array=new Float32Array(size);resolve({array:array},id,[array.buffer])}this.cache=!0,this.createBufferArray=function(size,num,config={}){let key;if(_thread||function initThread(){_thread=!0,Thread.upload(createBufferArrayAntimatter),Thread.upload(createFloatArrayAntimatter)}(),_this.cache&&(key=`buffer_${JSON.stringify(config)}_${size}_${num}`,_promises[key]))return _promises[key];let promise=Promise.create();return key&&(_promises[key]=promise),Thread.shared().createBufferArrayAntimatter({size:size,num:num,dimensions:config}).then(data=>{data.attribs=new AntimatterAttribute(data.attribs,4),data.vertices=new AntimatterAttribute(data.vertices,4);let geometry=data.geometry;data.geometry=new Geometry,data.geometry.addAttribute("position",new GeometryAttribute(geometry,3)),data.geometry.addAttribute("random",new GeometryAttribute(data.attribs.buffer,4)),promise.resolve(data)}),promise},this.createFloatArray=function(size,freshCopy){if(freshCopy||!_this.cache)return Thread.shared().createFloatArrayAntimatter({size:size});if(_promises["float_size"+size])return _promises["float_size"+size];return _promises["float_size"+size]=Thread.shared().createFloatArrayAntimatter({size:size})}}),"static"),Class((function Audio3D(_options){Inherit(this,Component);const _this=this,_config=require("Audio3DConfig");function onVisibility(e){_this.context&&GlobalAudio3D.blurs&&(_this.context.visibilityMuted="focus"!==e.type)}!function initContext(){_options||(_options={}),GlobalAudio3D.native?(window._al&&(_this.context=_this.initClass(Audio3DALBuffer)),window.AVFSound&&(_this.context=_this.initClass(Audio3DNBuffer,"AVF")),window.MPAudio&&(_options.stream?_this.context=_this.initClass(Audio3DNBuffer,"MP"):_this.context=_this.initClass(Audio3DNBuffer,"GVR"))):_options.fallback||GlobalAudio3D.fallback?_this.context=_this.initClass(Audio3DFallback):_options.simpleBuffer&&"ie"!==Device.system.browser?_this.context=_this.initClass(Audio3DWASimpleBuffer):!0!==_options.stream&&"ie"!==Device.system.browser?_this.context=_this.initClass(Audio3DWABuffer):_this.context=_this.initClass(Audio3DWAStream),window.ResonanceAudio&&(_this.context=_this.initClass(Audio3DResonanceAudio))}(),function initInterface(){for(let command of _config.commands)_this[command]=e=>_this.context[command](e);for(let setter of _config.setters)_this.set(setter,e=>_this.context[setter]=e);for(let getter of _config.getters)_this.get(getter,_=>_this.context[getter])}(),function addHandlers(){_this.events.sub(_this.context,Events.END,e=>_this.events.fire(Events.END,e)),_this.events.sub(_this.context,Events.LOADED,e=>_this.events.fire(Events.LOADED,e)),_this.events.sub(Events.VISIBILITY,onVisibility)}(),function initOptions(){if(_options)for(let option in _options)_config.setters.includes(option)&&(_this.context[option]=_options[option])}(),this.tween=function(){return tween(_this,...arguments)},this.clone=function(){return new Audio3D(_options)},this.onDestroy=function(){_this.context.unload()}})),Class((function Audio3DLayer(...args){Inherit(this,Component);const _this=this;var _group,_input,_mesh,_audio3D,_config,_key,_autoplay,_volume={value:0};async function fadeIn(){await _this.wait("init"),_this.delayedCall(()=>{if(_audio3D.play(),0!=_config.getNumber("fadeInTime")){_volume.value=0,_audio3D.volume=0,tween(_volume,{value:_config.getNumber("volume")},_config.getNumber("fadeInTime"),"easeOutExpo").onUpdate(()=>{_audio3D.volume=_volume.value})}},_config.getNumber("delay"))}async function fadeOut(){if(await _this.wait("init"),0!=_config.getNumber("fadeOutTime")){_volume.value=_config.getNumber("volume"),tween(_volume,{value:0},_config.getNumber("fadeOutTime"),"easeOutExpo",0,()=>{_audio3D.pause()}).onUpdate(()=>{_audio3D.volume=_volume.value})}else _audio3D.pause()}_this.startRender(()=>{}),function parseArgs(){args.forEach(arg=>{switch(Utils.getConstructorName(arg)){case"InputUILConfig":_input=arg;break;case"UILFolder":_group=arg;break;case"Mesh":_mesh=arg,_this.parent=_mesh,_mesh.audioCount?_mesh.audioCount++:_mesh.audioCount=1,_mesh.findSound||(_mesh.findSound=async function(key){if(Array.isArray(_mesh.scriptClass))for(let scriptClass of _mesh.scriptClass)if(await scriptClass.key==key)return scriptClass})}}),_this.visible=_input.get("visible")}(),function initConfig(){let config=InputUIL.create(_input.prefix+"audio3dLayer"+(_mesh?_mesh.audioCount:""),_group);config.add("path").add("key").addToggle("autoplay",!1).addToggle("loop",!1).addToggle("stream",!1).addNumber("volume",1).addNumber("fadeInTime",0).addNumber("fadeOutTime",0).addNumber("delay",0).setLabel("Audio"),config.addButton("preview",{label:"Preview",actions:[{title:"Play",callback:fadeIn},{title:"Stop",callback:fadeOut}]}),_config=config}(),function initAudio(){_key=_config.get("key"),_autoplay=_config.get("autoplay");let path=_config.get("path");path&&(_audio3D=_this.initClass(Audio3D,{src:path,autoplay:!1,volume:_config.getNumber("volume"),loop:_config.get("loop"),stream:_config.get("stream")}),_mesh&&_mesh.add(_audio3D.group),_this.flag("init",!0))}(),this.get("audio",()=>_audio3D),this.play=function(){fadeIn()},this.stop=function(){fadeOut()},this.get("key",async()=>(await _this.wait("init"),_key)),this.onVisible=function(){_audio3D&&_autoplay&&fadeIn()},this.onInvisible=async function(){_audio3D&&fadeOut()}})),Class((function GlobalAudio3D(){Inherit(this,Component);const _this=this;var _volume=1,_muted=!1,_blurs=!0,_playbackRate=1,_poolSize=3;function initInteraction(e){e&&e.preventDefault&&e.preventDefault(),document.removeEventListener(Device.mobile?"touchend":"mouseup",initInteraction,{passive:!1}),Audio3DWA.createPool(_poolSize),Audio3DWA.purge(),_this.initialized=!0,_this.events.fire(Events.READY)}this.native=!1,this.TRANSPARENT=0,this.ACOUSTIC_CEILING_TILES=1,this.BRICK_BARE=2,this.BRICK_PAINTED=3,this.CONCRETE_BLOCK_COARSE=4,this.CONCRETE_BLOCK_PAINTED=5,this.CURTAIN_HEAVY=6,this.FIBER_GLASS_INSULATION=7,this.GLASS_THICK=8,this.GLASS_THIN=9,this.GRASS=10,this.LINOLEUM_ON_CONCRETE=11,this.MARBLE=12,this.METAL=13,this.PARQUET_ON_CONCRETE=14,this.PLASTER_ROUGH=15,this.PLASTER_SMOOTH=16,this.PLYWOOD_PANEL=17,this.POLISHED_CONCRETE_OR_TILE=18,this.SHEET_ROCK=19,this.WATER_OR_ICE_SURFACE=20,this.WOOD_CEILING=21,this.WOOD_PANEL=22,this.LOW=0,this.MED=1,this.HIGH=2,this.quality=this.HIGH,async function(){await defer(),window.AURA&&function initNative(){_this.native=!0,!window._al||Audio3DAL.init();_this.initialized=!0}(),function initDebug(){Hydra.LOCAL&&Utils.query("audioDebug")&&(AudioNode.prototype.connect=(func=AudioNode.prototype.connect,function(){var target=arguments[0];return(this.outputs||(this.outputs=[])).push(arguments[0]),(target.inputs||(target.inputs=[])).push(this),func.apply(this,arguments)}));var func}()}(),this.set("volume",v=>{_volume=v,_this.events.fire(Events.UPDATE,{volume:_volume})}),this.get("volume",_=>_volume),this.set("muted",v=>{_muted=v,_this.events.fire(Events.UPDATE,{muted:_muted})}),this.get("muted",_=>_muted),this.set("blurs",v=>{_blurs=v,_this.events.fire(Events.UPDATE,{blurs:_blurs})}),this.get("blurs",_=>_blurs),this.set("playbackRate",v=>{_playbackRate=v,_this.events.fire(Events.UPDATE,{playbackRate:_playbackRate})}),this.get("playbackRate",_=>_playbackRate),this.get("pool",_=>_poolSize),this.set("pool",n=>{_poolSize=n}),this.get("fallback",_=>"ie"===Device.system.browser&&Device.system.browserVersion<=11||!!Device.agent.includes("samsung")),this.setup=function(){Utils.query("muted")&&Hydra.LOCAL&&(_muted=!0),document.addEventListener(Device.mobile?"touchend":"mouseup",initInteraction,{passive:!1})},this.ready=function(){return _this.wait(_this,"initialized")},this.enableRoom=function(bool){window.GVRAudio&&GVRAudio.enableRoom(bool)},this.setRoomProperties=function(x,y,z,wall,ceiling,floor){window.GVRAudio&&GVRAudio.setRoomProperties(x,y,z,wall,ceiling,floor)},this.setRoomReverbAdjustments=function(gain,time,brightness){window.GVRAudio&&GVRAudio.setRoomReverbAdjustments(gain,time,brightness)}}),"static"),Module((function Audio3DConfig(){this.exports={getters:["playbackRate","loop","autoplay","volume","rolloff","preload","visibilityMuted","selfDestruct","src","frequency","group","duration","currentTime","activity","playing","filter","panner","delay","progress","reverb"],setters:["playbackRate","loop","autoplay","volume","rolloff","preload","visibilityMuted","selfDestruct","src"],commands:["play","pause","stop","seek","load","unload","convolve"]}})),Module((function Audio3DSilence(){this.exports="data:audio/mpeg;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAADAAAGhgBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr///////////////////////////////////////////8AAAA5TEFNRTMuOThyAc0AAAAAAAAAABSAJAiqQgAAgAAABobxtI73AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAACFEII9ACZ/sJZwWEoEb8w/////N//////JcxjHjf+7/v/H2PzCCFAiDtGeyBCIx7bJJ1mmEEMy6g8mm2c8nrGABB4h2Mkmn//4z/73u773R5qHHu/j/w7Kxkzh5lWRWdsifCkNAnY9Zc1HvDAhjhSHdFkHFzLmabt/AQxSg2wwzLhHIJOBnAWwVY4zrhIYhhc2kvhYDfQ4hDi2Gmh5KyFn8EcGIrHAngNgIwVIEMf5bzbAiTRoAD///8z/KVhkkWEle6IX+d/z4fvH3BShK1e5kmjkCMoxVmXhd4ROlTKo3iipasvTilY21q19ta30/v/0/idPX1v8PNxJL6ramnOVsdvMv2akO0iSYIzdJFirtzWXCZicS9vHqvSKyqm5XJBdqBwPxyfJdykhWTZ0G0ZyTZGpLKxsNwwoRhsx3tZfhwmeOBVISm3impAC/IT/8hP/EKEM1KMdVdVKM2rHV4x7HVXZvbVVKN/qq8CiV9VL9jjH/6l6qf7MBCjZmOqsAibjcP+qqqv0oxqpa/NVW286hPo1nz2L/h8+jXt//uSxCmDU2IK/ECN98KKtE5IYzNoCfbw+u9i5r8PoadUMFPKqWL4LK3T/LCraMSHGkW4bpLXR/E6LlHOVQxmslKVJ8IULktMN06N0FKCpHCoYsjC4F+Z0NVqdNFoGSTjSiyjzLdnZ2fNqTi2eHKONONKLMPMKLONKLMPQRJGlFxZRoKcJFAYEeIFiRQkUWUeYfef//Ko04soswso40UJAgMw8wosososy0EalnZyjQUGBRQGIFggOWUacWUeYmuadrZziQKKEgQsQLAhQkUJAgMQDghltLO1onp0cpkNInSFMqlYeSEJ5AHsqFdOwy1DA2sRmRJKxdKRfLhfLw5BzUxBTUUzLjk4LjJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVUxBTUUzLjk4LjJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/7ksRRA8AAAaQAAAAgAAA0gAAABFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU="})),Class((function Audio3DBase(){Inherit(this,Object3D);const _this=this;var _quaternion,_euler,_position=new Vector3;this.audioPosition=function(){return _position=_this.group._parent?_this.group.getWorldPosition():World.CAMERA.getWorldPosition()},this.audioPositionInverse=function(){return _position=_this.audioPosition(),_this.group._parent&&_position.applyMatrix4(World.CAMERA.matrixWorldInverse),_position},this.audioOrientationInverse=function(){return _quaternion||(_quaternion=new Quaternion,_euler=new Euler),_this.group.parent?(_this.group.getWorldQuaternion(_quaternion),_euler.setFromQuaternion(_quaternion)):_euler.set(0,0,0),_euler},this.listenerPosition=function(){return _this.group._parent&&(_position=World.CAMERA.getWorldPosition()),_position}})),Class((function Audio3DAL(){Inherit(this,Component);const _this=this;var _cam,_vec,_map={},_orientation=[];function loop(){_vec&&_cam&&(_vec.set(0,0,-1).applyQuaternion(_cam.quaternion),_orientation[0]=_vec.x,_orientation[1]=_vec.y,_orientation[2]=_vec.z,_orientation[3]=_cam.up.x,_orientation[4]=_cam.up.y,_orientation[5]=_cam.up.z,_al.Listener3f(_al.AL_POSITION,_cam.position.x,_cam.position.y,_cam.position.z),_al.Listener3f(_al.AL_VELOCITY,0,0,0),_al.Listenerfv(_al.AL_ORIENTATION,_orientation))}function getLengthInSec(buffer){let size=_al.GetBufferi(buffer,_al.AL_SIZE),bits=_al.GetBufferi(buffer,_al.AL_BITS);return size/_al.GetBufferi(buffer,_al.AL_CHANNELS)/(bits/8)/_al.GetBufferi(buffer,_al.AL_FREQUENCY)}this.init=function(){},this.audioContext=function(){_vec=new Vector3,_cam=World.CAMERA,_this.startRender(loop)},this.loadBuffer=async function(url){if(_map[url]){let obj=_map[url];return obj.count++,obj}let buffer=await _al.convertToBuffer(url);return _map[url]={buffer:buffer,length:getLengthInSec(buffer),count:1},_map[url]},this.deleteBuffer=function(url){let obj=_map[url];obj&&(obj.count--,obj.count<=0&&delete _map[url])}}),"static"),Class((function Audio3DALBuffer(){Inherit(this,Audio3DBase);const _this=this;var _source,_length,_filter,_convolver,_delay,_reverb,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(t,dt){if(_source){if((_currentTime+=dt/1e3)>=_length)return void(_options.loop?_this.seek(0):(_this.events.fire(Events.END),_this.stop(),_options.selfDestruct&&_this.parent.destroy()));let pos=_this.audioPosition();_al.Source3f(_source,_al.AL_POSITION,pos.x,pos.y,pos.z)}}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}Audio3DAL.audioContext(),function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_filter||(_filter=_this.initClass(Audio3DALFilter)),_delay||(_delay=_this.initClass(Audio3DALDelay)),_convolver||(_convolver=_this.initClass(Audio3DALConvolver)),_reverb||(_reverb=_this.initClass(Audio3DALReverb))}(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update)}(),this.set("src",src=>{_this.stop(),_settings.src=src,defer(_=>{if(_options.autoplay)return _this.play();_this.volume=_options.volume})}),this.get("src",_=>_settings.src),this.get("selfDestruct",_=>_options.selfDestruct),this.set("selfDestruct",d=>{_options.selfDestruct=d}),this.set("volume",v=>(_options.volume=v,void 0!==_source&&_al.Sourcef(_source,_al.AL_GAIN,v),_options.volume)),this.get("volume",_=>_options.volume),this.set("loop",l=>(l=!!l,void 0!==_source&&_al.Sourcei(_source,_al.AL_LOOPING,l),_options.loop=l)),this.get("loop",_=>_options.loop),this.set("autoplay",autoplay=>{_options.autoplay=autoplay}),this.get("autoplay",_=>_options.autoplay),this.set("preload",preload=>{_options.preload=preload}),this.get("preload",_=>_options.preload),this.get("ready",_=>_this.ready),this.get("frequency",_=>[]),this.get("activity",_=>0),this.get("playing",_=>_settings.playing),this.set("rolloff",r=>{_options.rolloff=r}),this.get("rolloff",_=>_options.rolloff),this.get("loaded",_=>_settings.loaded),this.get("currentTime",_=>_currentTime),this.set("currentTime",t=>{_this.seek(t)}),this.get("duration",_=>_length||0),this.get("progress",_=>_this.currentTime/_this.duration),this.get("visibilityMuted",_=>_options.muted),this.set("visibilityMuted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.get("muted",_=>_options.muted),this.set("muted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.set("playbackRate",v=>{_options.playbackRate=v,void 0!==_source&&_al.Sourcef(_source,_al.AL_PITCH,v)}),this.get("playbackRate",_=>_options.playbackRate),this.get("filter",_=>_filter),this.get("delay",_=>_delay),this.get("reverb",_=>_reverb),this.play=async function(){_settings.autoplay=!0,_settings.src&&(_settings.loadingPlay=!0,_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),_settings.playing=!0,_this.volume=_options.volume,_this.playbackRate=_options.playbackRate,_this.startRender(loop),_al.SourcePlay(_source),_al.Sourcei(_source,_al.AL_SEC_OFFSET,_currentTime),_reverb&&(_reverb.source=_source),_convolver&&(_convolver.source=_source),_filter&&(_filter.source=_source),_delay&&(_delay.source=_source)))},this.pause=function(){_settings.autoplay=!1,_settings.src&&_settings.loaded&&_settings.playing&&(_settings.loadingPlay=!1,_settings.playing=!1,void 0!==_source&&_al.SourcePause(_source),_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.loaded&&(_currentTime=0,void 0!==_source&&_al.SourceStop(_source),_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_currentTime=Math.min(_length,Math.max(0,time)),_this.stop(),wasPlaying&&_this.play()}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){_al.Listener3f(_al.AL_POSITION,0,0,0),_al.Listener3f(_al.AL_VELOCITY,0,0,0),_source=_al.GenSources(1)[0];let{buffer:buffer,length:length}=await Audio3DAL.loadBuffer(_settings.src);_al.Sourcei(_source,_al.AL_BUFFER,buffer),_length=length}(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),_al.DeleteSources([_source]),Audio3DAL.deleteBuffer(_settings.src))},this.convolve=async function(src){return _convolver||(_convolver=_this.initClass(Audio3DALConvolver)),_source&&(_convolver.source=_source),_convolver.src=src,_convolver}})),Class((function Audio3DALParam(_config={}){Inherit(this,Component);const _this=this,PROPS=["automationRate","defaultValue","maxValue","minValue","value"];!function initGetters(){for(let prop of PROPS)_this.get(prop,_=>_this["_"+prop])}(),function initSetters(){for(let prop of PROPS)_this.set(prop,value=>{if(_this["_"+prop]===value)return;_this["_"+prop]=value;let e={};e[prop]=value,_this.events.fire(Events.UPDATE,e)})}(),function initDefaults(){for(let prop in _config)PROPS.includes(prop)&&(_this[prop]=_config[prop])}(),this.update=function(){let obj={};for(let prop of PROPS)obj[prop]=_this[prop];_this.events.fire(Events.UPDATE,obj)}})),Class((function Audio3DALConvolver(){Inherit(this,Component);this.get("numberOfInputs",_=>1),this.get("numberOfOutputs",_=>1),this.get("channelCount",_=>2),this.get("channelCountMode",_=>"max"),this.get("channelInterpretation",_=>"speakers")})),Class((function Audio3DALDelay(){Inherit(this,Component);const _this=this;var _source;function onDelayTimeUpdate(e){}!function initDelayTime(){_this.delayTime=_this.initClass(Audio3DALParam,{automationRate:"a-rate",defaultValue:0,maxValue:1,minValue:0,value:0})}(),function addHandlers(){_this.events.sub(_this.delayTime,Events.UPDATE,onDelayTimeUpdate)}(),this.get("numberOfInputs",_=>1),this.get("numberOfOutputs",_=>1),this.get("channelCount",_=>2),this.get("channelCountMode",_=>"max"),this.get("channelInterpretation",_=>"speakers"),this.set("source",source=>{_source=source}),this.get("source",_=>_source)})),Class((function Audio3DALFilter(){Inherit(this,Component);const _this=this;var _type,_source,_filter;const ENABLED=_al.EFXEnabled();function onUpdate(){!function initFilter(){_filter||(_filter=_al.GenFilters(1)[0])}(),function applyType(){let t;t=_al.AL_FILTER_LOWPASS;t&&_al.Filteri(_filter,_al.AL_FILTER_TYPE,t)}(),function applyFrequency(){let type,v=_this.frequency.value,value=1;value=Math.range(v,_this.frequency.minValue,_this.frequency.maxValue,0,1,!0),type=_al.AL_LOWPASS_GAINHF;type&&_al.Filterf(_filter,type,value)}(),function applyGain(){let type,value=Math.range(_this.gain.value,_this.gain.minValue,_this.gain.maxValue,0,1,!0);type=_al.AL_LOWPASS_GAIN;type&&_al.Filterf(_filter,type,value)}(),function applyFilter(){_source&&ENABLED&&_al.Sourcei(_source,_al.AL_DIRECT_FILTER,_filter)}()}!function initDetune(){_this.detune=_this.initClass(Audio3DALParam,{automationRate:"a-rate",defaultValue:0,maxValue:Math.pow(2,128),minValue:-Math.pow(2,128),value:0})}(),function initFrequency(){_this.frequency=_this.initClass(Audio3DALParam,{automationRate:"a-rate",defaultValue:350,maxValue:24e3,minValue:0,value:350})}(),function initGain(){_this.gain=_this.initClass(Audio3DALParam,{automationRate:"a-rate",defaultValue:0,maxValue:Math.pow(2,128),minValue:-Math.pow(2,128),value:0})}(),function addHandlers(){_this.events.sub(_this.detune,Events.UPDATE,onUpdate),_this.events.sub(_this.frequency,Events.UPDATE,onUpdate),_this.events.sub(_this.gain,Events.UPDATE,onUpdate)}(),this.set("type",type=>{_type=type,onUpdate()}),this.get("type",_=>_type),this.get("numberOfInputs",_=>1),this.get("numberOfOutputs",_=>1),this.get("channelCount",_=>2),this.get("channelCountMode",_=>"max"),this.get("channelInterpretation",_=>"speakers"),this.set("source",source=>{_source=source;for(let prop of["detune","frequency","gain"])_this[prop].update()}),this.get("source",_=>_source),this.onDestroy=function(){_filter&&_al.DeleteFilters([_filter])}})),Class((function Audio3DALReverb(){Inherit(this,Component);const _this=this,MAP=[{prop:"density",al:"AL_REVERB_DENSITY",update:"Effectf",value:1,min:0,max:1},{prop:"diffusion",al:"AL_REVERB_DIFFUSION",update:"Effectf",value:1,min:0,max:1},{prop:"gain",al:"AL_REVERB_GAIN",update:"Effectf",value:.83,min:0,max:1},{prop:"gainHF",al:"AL_REVERB_GAINHF",update:"Effectf",value:.83,min:.1,max:2},{prop:"decayTime",al:"AL_REVERB_DECAY_TIME",update:"Effectf",value:1.49,min:.1,max:20},{prop:"decayHF",al:"AL_REVERB_DECAY_HFRATIO",update:"Effectf",value:.83,min:.1,max:2},{prop:"reflectionsGain",al:"AL_REVERB_REFLECTIONS_GAIN",update:"Effectf",value:.05,min:0,max:3.16},{prop:"reflectionsDelay",al:"AL_REVERB_REFLECTIONS_DELAY",update:"Effectf",value:.007,min:0,max:.3},{prop:"lateGain",al:"AL_REVERB_LATE_REVERB_GAIN",update:"Effectf",value:1.26,min:0,max:10},{prop:"lateDelay",al:"AL_REVERB_LATE_REVERB_DELAY",update:"Effectf",value:.011,min:0,max:.1},{prop:"airAbsorptionGainHF",al:"AL_REVERB_AIR_ABSORPTION_GAINHF",update:"Effectf",value:.994,min:.892,max:1},{prop:"roomRolloff",al:"AL_REVERB_ROOM_ROLLOFF_FACTOR",update:"Effectf",value:0,min:0,max:10}];var _slot,_effect,_source,_enabled=_al.EFXEnabled&&_al.EFXEnabled();function onUpdate(){!function initEffect(){_enabled&&(_slot||(_slot=_al.GenAuxiliaryEffectSlots(1)[0]),_effect||(_effect=_al.GenEffects(1)[0]),_al.Effecti(_effect,_al.AL_EFFECT_TYPE,_al.AL_EFFECT_REVERB))}(),function applyProps(){if(!_enabled)return;for(let item of MAP){let i=_this[item.prop],v=Math.clamp(i.value,i.minValue,i.maxValue);_al[item.update](_effect,_al[item.al],v)}}(),function applyEffect(){if(!_enabled)return;_al.AuxiliaryEffectSloti(_slot,_al.AL_EFFECTSLOT_EFFECT,_effect),_source&&_al.Source3i(_source,_al.AL_AUXILIARY_SEND_FILTER,_slot,0,_al.AL_FILTER_NULL)}()}!function initProps(){for(let item of MAP)_this[item.prop]=_this.initClass(Audio3DALParam,{value:item.value,maxValue:item.max,minValue:item.min})}(),function addHandlers(){for(let item of MAP)_this.events.sub(_this[item.prop],Events.UPDATE,onUpdate)}(),this.set("source",source=>{_source=source,onUpdate()}),this.get("source",_=>_source),this.onDestroy=function(){_effect&&_al.DeleteEffects([_effect]),_slot&&_al.AuxiliaryEffectSlots([_slot])}})),Class((function Audio3DFallback(){Inherit(this,Audio3DBase);const _this=this;var _stream,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){initOptions(),(_settings.autoplay||_options.autoplay)&&_this.play()}initOptions(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}(),this.set("src",src=>{_this.unload(),function destroyStream(){_stream&&_stream.element&&GlobalAudio3D.ready&&(Audio3DWA.unloadStream(_settings.src),_stream=null)}(),_settings.src=src}),this.get("src",_=>_settings.src),this.set("volume",v=>(v=Math.clamp(v,0,1),_options.volume=v,_stream&&_stream.element&&(_stream.element.volume=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume)),this.get("volume",_=>_options.volume),this.set("loop",l=>(l=!!l,_stream&&(_stream.element.loop=l),_options.loop=l)),this.get("loop",_=>_options.loop),this.set("autoplay",autoplay=>{_options.autoplay=autoplay}),this.get("autoplay",_=>_options.autoplay),this.set("preload",preload=>{_options.preload=preload}),this.get("preload",_=>_options.preload),this.get("ready",_=>_this.ready),this.get("frequency",_=>0),this.get("activity",_=>0),this.get("playing",_=>_settings.playing),this.set("rolloff",r=>{}),this.get("rolloff",_=>0),this.get("loaded",_=>!0),this.get("duration",_=>_stream?_stream.element.duration:0),this.get("currentTime",_=>_stream?_stream.element.currentTime:0),this.set("currentTime",t=>{_this.seek(t)}),this.get("progress",_=>_this.currentTime/_this.duration),this.set("playbackRate",v=>{_options.playbackRate=v,_stream&&_stream.element&&(_stream.element.playbackRate=v*_options.globalPlaybackRate)}),this.get("playbackRate",_=>_options.playbackRate),this.get("visibilityMuted",_=>_options.muted),this.set("visibilityMuted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.get("muted",_=>_options.muted),this.set("muted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.play=function(){if(_settings.autoplay=!0,_settings.src&&GlobalAudio3D.ready&&(function createStream(){!_stream&&GlobalAudio3D.ready&&((_stream=Audio3DWA.loadStream(_settings.src)).element.onended=_=>{_this.unload(),_this.events.fire(Events.END)},_this.loop=_this.loop,_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,(_options.autoplay||_settings.autoplay)&&_this.play())}(),!0!==_settings.playing&&(_settings.playing=!0,_this.volume=_options.volume,_stream))){_stream.element.playbackRate=_options.playbackRate,_stream.element.play();try{_stream.element.currentTime=_currentTime}catch(e){}}},this.pause=function(){if(_settings.autoplay=!1,_stream&&GlobalAudio3D.ready&&_settings.src&&_settings.playing){try{_currentTime=_stream.element.currentTime}catch(e){}_stream.element.pause(),_settings.playing=!1}},this.stop=function(){if(_settings.autoplay=!1,_settings.src&&GlobalAudio3D.ready&&(_currentTime=0,_settings.playing=!1,_stream&&_stream.element&&_stream.element.stop)){_stream.element.stop();try{_stream.element.currentTime=0}catch(e){}}},this.seek=function(time){if(_settings.src&&(_currentTime=time,_stream&&_stream.element))try{_stream.element.currentTime=time}catch(e){}},this.load=function(){return!0},this.unload=function(){_settings.autoplay=!1,_stream&&GlobalAudio3D.ready&&_settings.src&&_this.stop()},this.convolve=function(src){}})),Class((function Audio3DN(){Inherit(this,Component);const _this=this;var _init;function loop(){window.GVRAudio&&(GVRAudio.setHeadPos(World.CAMERA.position.x,World.CAMERA.position.y,World.CAMERA.position.z),GVRAudio.setHeadRotation(World.CAMERA.quaternion.x,World.CAMERA.quaternion.y,World.CAMERA.quaternion.z,World.CAMERA.quaternion.w))}this.audioContext=function(){window.GVRAudio&&!_init&&(GVRAudio.initEngine(GlobalAudio3D.quality),_init=!0,_this.startRender(loop))}}),"static"),Class((function Audio3DNBuffer(_backingType){Inherit(this,Audio3DBase);const _this=this;var _backing,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){let pos,orientation;switch(_backingType){case"AVF":pos=_this.audioPositionInverse(),orientation=_this.audioOrientationInverse();break;case"GVR":pos=_this.audioPosition()}pos&&_backing&&(_backing.setPos(pos.x,pos.y,pos.z),orientation&&_backing.setOrientation(orientation.x,orientation.y,orientation.z,0,1,0))}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}Audio3DN.audioContext(),function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update)}(),this.set("src",src=>{_this.stop(),_settings.src=src,defer(_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume})}),this.get("src",_=>_settings.src),this.get("selfDestruct",_=>_options.selfDestruct),this.set("selfDestruct",d=>{_options.selfDestruct=d}),this.set("volume",v=>(_options.volume=v,_backing&&_backing.volume(v),_options.volume)),this.get("volume",_=>_options.volume),this.set("loop",l=>(l=!!l,_backing&&_backing.loop(l),_options.loop=l)),this.get("loop",_=>_options.loop),this.set("autoplay",autoplay=>{_options.autoplay=autoplay}),this.get("autoplay",_=>_options.autoplay),this.set("preload",preload=>{_options.preload=preload}),this.get("preload",_=>_options.preload),this.get("ready",_=>_this.ready),this.get("frequency",_=>[]),this.get("activity",_=>0),this.get("playing",_=>_settings.playing),this.set("rolloff",r=>{_options.rolloff=r}),this.get("rolloff",_=>_options.rolloff),this.get("loaded",_=>_settings.loaded),this.get("currentTime",_=>_currentTime),this.set("currentTime",t=>{_this.seek(t)}),this.get("duration",_=>0),this.get("progress",_=>_this.currentTime/_this.duration),this.get("visibilityMuted",_=>_options.muted),this.set("visibilityMuted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.get("muted",_=>_options.muted),this.set("muted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.set("playbackRate",v=>{_options.playbackRate=v,_backing&&_backing.setRate(v)}),this.get("playbackRate",_=>_options.playbackRate),this.play=async function(){_settings.autoplay=!0,_settings.src&&(_settings.loadingPlay=!0,_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),_settings.playing=!0,_this.volume=_options.volume,_this.playbackRate=_options.playbackRate,_this.startRender(loop),_backing.seek(_currentTime),_backing.play(_options.loop)))},this.pause=function(){_settings.autoplay=!1,_settings.src&&_settings.loaded&&_settings.playing&&(_currentTime=_currentTime,_settings.loadingPlay=!1,_settings.playing=!1,_backing&&_backing.pause(),_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.loaded&&(_currentTime=0,_backing&&_backing.stop(),_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_currentTime=time,_backing&&(_backing.seek(_currentTime),wasPlaying&&_backing.play())}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await function createBuffer(){let promise=Promise.create(),url=_settings.src;switch(url.includes("http")||(url=AURA.rootPath+url),_backingType){case"AVF":_backing=AVFSound.create(url);break;case"MP":_backing=new MPAudio(url);break;case"GVR":_backing=new GVRAudio(url)}return _backing.onComplete=_=>{_this.events.fire(Events.END),_options.selfDestruct&&_this.parent.destroy()},_backing.onUpdate=t=>{_currentTime=t},_backing.onReady=promise.resolve,promise}(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),_backing.destroy())},this.convolve=async function(src){}})),Class((function Audio3DResonance(){Inherit(this,Component);require("Audio3DSilence");var _context,_resonance,_orientation,_cam,_streams={};function loop(){(_cam=World.CAMERA)&&_context&&_context.listener&&(_orientation.set(0,0,-1).applyQuaternion(_cam.quaternion),_resonance.setListenerOrientation(_orientation.x,_orientation.y,_orientation.z,_cam.up.x,_cam.up.y,_cam.up.z),_resonance.setListenerPosition(_cam.position.x,_cam.position.y,_cam.position.z))}this.createAudioInput=async function(url){let isElement="string"!=typeof url,element=null;if(isElement&&(element=url,url=element.src?element.src:element.srcObject?element.srcObject.id:""),!_streams[url]){let stream={};isElement?(stream.element=element,element.setAttribute("muted",!0),element.muted=!0):(stream.element=await Audio3DWA.getElement(),stream.element.crossOrigin="anonymous",stream.element.src=url);let audioElementSource=_context.createMediaElementSource(stream.element),source=_resonance.createSource();audioElementSource.connect(source.input),stream.source=source,_streams[url]=stream}return _streams[url]},this.resonance=async function(refresh){return await GlobalAudio3D.ready(),_context&&!refresh||(_context&&(_context.close(),_context=null),_orientation=new Vector3,(_context=new(window.AudioContext||window.webkitAudioContext)).dest=_context.createMediaStreamDestination(),(_resonance=new ResonanceAudio(_context)).output.connect(_context.destination),Render.start(loop)),_resonance},this.setRoomProperties=function(dimensions,materials){_resonance.setRoomProperties(dimensions,materials)}}),"static"),Class((function Audio3DResonanceAudio(){Inherit(this,Audio3DBase);const _this=this;var _stream,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){let pos;pos=_this.audioPosition(),pos&&_stream&&_stream.source.setPosition(pos.x,pos.y,pos.z)}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}!async function(){await Audio3DResonance.resonance(),function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update)}()}(),this.set("src",src=>{_this.stop(),_settings.src=src,defer(_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume,_stream&&(_stream.element.volume=_this.volume)})}),this.get("src",_=>_settings.src),this.get("selfDestruct",_=>_options.selfDestruct),this.set("selfDestruct",d=>{_options.selfDestruct=d}),this.set("volume",v=>(_options.volume=v,_stream&&(_stream.element.volume=v),_options.volume)),this.get("volume",_=>_options.volume),this.set("loop",l=>(l=!!l,_stream&&(_stream.element.loop=l),_options.loop=l)),this.get("loop",_=>_options.loop),this.set("autoplay",autoplay=>{_options.autoplay=autoplay}),this.get("autoplay",_=>_options.autoplay),this.set("preload",preload=>{_options.preload=preload}),this.get("preload",_=>_options.preload),this.get("ready",_=>_this.ready),this.get("frequency",_=>[]),this.get("activity",_=>0),this.get("playing",_=>_settings.playing),this.set("rolloff",r=>{_options.rolloff=r}),this.get("rolloff",_=>_options.rolloff),this.get("loaded",_=>_settings.loaded),this.get("currentTime",_=>_currentTime),this.set("currentTime",t=>{_this.seek(t)}),this.get("duration",_=>_stream?_stream.element.duration:0),this.get("progress",_=>_this.currentTime/_this.duration),this.get("visibilityMuted",_=>_options.muted),this.set("visibilityMuted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.get("muted",_=>_options.muted),this.set("muted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.set("playbackRate",v=>{_options.playbackRate=v}),this.get("playbackRate",_=>_options.playbackRate),this.play=async function(){_settings.autoplay=!0,_settings.src&&(_settings.loadingPlay=!0,_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),_settings.playing=!0,_this.volume=_options.volume,_this.playbackRate=_options.playbackRate,_this.startRender(loop),_stream.element.currentTime=_currentTime,_stream.element.play()))},this.pause=function(){_settings.autoplay=!1,_settings.src&&_settings.loaded&&_settings.playing&&(_currentTime=_currentTime,_settings.loadingPlay=!1,_settings.playing=!1,_stream&&_stream.element.pause(),_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.loaded&&(_currentTime=0,_stream&&(_stream.element.pause(),_stream.element.currentTime=0),_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_currentTime=time,_stream&&(_stream.element.seek(_currentTime),wasPlaying&&_stream.element.play())}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){let promise=Promise.create(),url=_settings.src;return(_stream=await Audio3DResonance.createAudioInput(url)).element.onended=_=>{_this.unload(),_this.events.fire(Events.END)},_this.loop=_this.loop,_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.element.currentTime=_currentTime,_stream.element.volume=_this.volume,_stream.element.onloadeddata=promise.resolve,(_options.autoplay||_settings.autoplay)&&_this.play(),promise}(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&_this.stop()}})),Class((function Audio3DWA(){Inherit(this,Component);const _this=this,_silence=require("Audio3DSilence");var _context,_orientation,_cam,_pool,_streams={},_buffers={};function loop(){(_cam=Camera.instance().worldCamera)&&_context&&_context.listener&&(_orientation.set(0,0,-1).applyQuaternion(_cam.quaternion),_context.listener.forwardX?(_context.listener.forwardX.setValueAtTime(_orientation.x,_context.currentTime),_context.listener.forwardY.setValueAtTime(_orientation.y,_context.currentTime),_context.listener.forwardZ.setValueAtTime(_orientation.z,_context.currentTime),_context.listener.upX.setValueAtTime(_cam.up.x,_context.currentTime),_context.listener.upY.setValueAtTime(_cam.up.y,_context.currentTime),_context.listener.upZ.setValueAtTime(_cam.up.z,_context.currentTime)):(_context.listener.setOrientation&&_context.listener.setOrientation(_orientation.x,_orientation.y,_orientation.z,_cam.up.x,_cam.up.y,_cam.up.z),_context.listener.setPosition&&_context.listener.setPosition(_cam.position.x,_cam.position.y,_cam.position.z),_context.listener.setVelocity&&_context.listener.setVelocity(0,0,0)))}function createAudioElement(){let audio;return GlobalAudio3D.fallback?(audio=document.createElement("audio"),document.body.appendChild(audio),audio.source=document.createElement("source"),audio.appendChild(audio.source),audio.setAttribute("controls","controls"),audio.source.setAttribute("src",""),audio.source.setAttribute("type","audio/mp3"),audio.src="",audio.play()):(audio=new Audio,audio.src=_silence,audio.play().catch(e=>{})),audio}this.createPool=function(n=10){_pool=_this.initClass(ObjectPool,createAudioElement,n),_this.flag("init",!0)},this.audioContext=function(refresh){return _context&&!refresh||(_context&&(_context.close(),_context=null),_orientation=new Vector3,(_context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3})).dest=_context.createMediaStreamDestination(),Render.start(loop)),_context},this.unloadBuffer=function(url){_buffers[url]&&delete _buffers[url]},this.loadBuffer=async function(url){if(!_buffers[url]){_buffers[url]={loaded:Promise.create(),data:null};var response=await fetch(url),buffer=await response.arrayBuffer();_this.audioContext().decodeAudioData(buffer,data=>{_buffers[url].data=data,_buffers[url].loaded.resolve()})}return await _buffers[url].loaded,_buffers[url].data},this.unloadStream=function(url){_streams[url]&&(_streams[url].stream.element.src=_silence,_streams[url].stream.element.load(),_pool.put(_streams[url].stream.element),defer(_=>{delete _streams[url]}))},this.loadStream=function(url){let isElement="string"!=typeof url&&void 0!==url,element=null;if(isElement&&(element=url,url=element.src?element.src:element.srcObject?element.srcObject.id:""),!_streams[url]){let stream={};_streams[url]={stream:null},isElement?(stream.element=element,element.setAttribute("muted",!0),element.muted=!0):(stream.element=_this.getElement(),stream.element.crossOrigin="anonymous",stream.element.src=url),GlobalAudio3D.fallback?stream.element.setAttribute("src",url):(stream.element.mediaSrc?stream.source=stream.element.mediaSrc:stream.element.srcObject?(stream.source=_this.audioContext().createMediaStreamSource(stream.element.srcObject),(new Audio).srcObject=element.srcObject):stream.source=_this.audioContext().createMediaElementSource(stream.element),stream.element.mediaSrc=stream.source),isElement||stream.element.load(),_streams[url].stream=stream}return _streams[url].stream},this.purge=function(){for(let stream in _streams)_this.unloadStream(stream);for(let buffer in _buffers)_this.unloadBuffer(buffer)},this.getElement=function(){return _pool.get()}}),"static"),Class((function Audio3DWABuffer(){Inherit(this,Audio3DBase);const _this=this;var _context,_buffer,_stream,_gain,_panner,_analyser,_filter,_delay,_convolver,_position,_frequency,_convolution,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){_context&&(_position=_context.listener.forwardX?_this.audioPosition().sub(_this.listenerPosition()):_this.audioPosition(),_panner.setPosition(_position.x,_position.y,_position.z))}async function initContext(){await GlobalAudio3D.ready(),_context=Audio3DWA.audioContext(),_gain=_context.createGain?_context.createGain():_context.createGainNode(),_panner=_context.createPanner(),(_filter=_context.createBiquadFilter()).type="lowshelf",_filter.frequency.value=0,_filter.gain.value=1,_analyser=_context.createAnalyser(),(_delay=_context.createDelay(10)).delayTime.value=0,_analyser.fftSize=32,_frequency=new Uint8Array(_analyser.frequencyBinCount),_analyser.connect(_context.destination),_delay.connect(_analyser),_filter.connect(_delay),_convolver?(_convolver.connect(_filter),_gain.connect(_convolver)):_gain.connect(_filter),_panner.connect(_gain)}function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function destroyBuffer(){if(_buffer&&_stream){_settings.loaded=!1;try{_stream.disconnect(_panner),_convolver?(_convolver.disconnect(_filter),_gain.disconnect(_convolver)):_gain.disconnect(_filter),_analyser.disconnect(_context.destination),_buffer.stop(),_buffer=null,Audio3DWA.unloadBuffer(_settings.src)}catch(e){}}}async function createStream(){_stream||((_stream=_context.createBufferSource()).buffer=_buffer.buffer,_stream.loop=_options.loop,_stream.playbackRate=_options.playbackRate,_stream.onended=_=>{_this&&_this.stop&&(_this.stop(),_this.events.fire(Events.END),_options.selfDestruct&&_this.parent.destroy())},_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.connect(_panner),_stream.start(0,_currentTime))}function destroyStream(){if(_stream)try{_stream.disconnect(_panner),_stream.stop(),_stream=null}catch(e){}}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){destroyBuffer(),destroyStream(),_context=null,_gain=null,_panner=null,_analyser=null,_delay=null,_frequency=null,_filter=null,initContext(),initOptions(),_convolution&&_this.convolve(_convolution),(_options.autoplay||_settings.autoplay)&&_this.play()}!async function(){await initContext(),initOptions(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}()}(),this.set("src",src=>{_this.stop(),_settings.src=src,defer(_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume})}),this.get("src",_=>_settings.src),this.get("selfDestruct",_=>_options.selfDestruct),this.set("selfDestruct",d=>{_options.selfDestruct=d}),this.set("volume",v=>(_options.volume=v,_gain&&(_gain.gain.value=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume)),this.get("volume",_=>_options.volume),this.set("loop",l=>(l=!!l,_stream&&(_stream.loop=l),_options.loop=l)),this.get("loop",_=>_options.loop),this.set("autoplay",autoplay=>{_options.autoplay=autoplay}),this.get("autoplay",_=>_options.autoplay),this.set("preload",preload=>{_options.preload=preload}),this.get("preload",_=>_options.preload),this.get("ready",_=>_this.ready),this.get("frequency",_=>_analyser?(_analyser.getByteFrequencyData(_frequency),_frequency):[]),this.get("activity",_=>_analyser?(_analyser.getByteFrequencyData(_frequency),Math.clamp(_frequency.slice(3,13).reduce((n1,n2)=>n1+n2,0)/2560,0,1)):0),this.get("playing",_=>_settings.playing),this.set("rolloff",r=>{_options.rolloff=r,_panner&&(_panner.rolloffFactor=r)}),this.get("rolloff",_=>_options.rolloff),this.get("loaded",_=>_settings.loaded),this.get("currentTime",_=>_context&&_buffer?_context.currentTime%_buffer.buffer.duration:0),this.set("currentTime",t=>{_this.seek(t)}),this.get("visibilityMuted",_=>_options.muted),this.set("visibilityMuted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.get("muted",_=>_options.muted),this.set("muted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.set("playbackRate",v=>{_options.playbackRate=v,_stream&&(_stream.playbackRate.value=v*_options.globalPlaybackRate)}),this.get("playbackRate",_=>_options.playbackRate),this.get("filter",_=>_filter),this.get("delay",_=>_delay),this.get("panner",_=>_panner),this.get("duration",_=>_buffer?_buffer.buffer.duration:0),this.get("progress",_=>_this.currentTime/_this.duration),this.play=async function(){_settings.autoplay=!0,_settings.src&&GlobalAudio3D.ready&&(_settings.loadingPlay=!0,_stream||_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),await createStream(),_settings.playing=!0,_this.volume=_options.volume,_this.startRender(loop)))},this.pause=function(){_settings.autoplay=!1,_stream&&GlobalAudio3D.ready&&_settings.src&&_settings.loaded&&_settings.playing&&(_currentTime=_context.currentTime,destroyStream(),_settings.loadingPlay=!1,_settings.playing=!1,_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.src&&GlobalAudio3D.ready&&_settings.loaded&&(_currentTime=0,destroyStream(),_settings.loading=!1,_settings.loaded=!1,_settings.loadingPlay=!1,_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_this.stop(),_currentTime=time,wasPlaying&&_this.play()}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){await GlobalAudio3D.ready(),(_buffer=_context.createBufferSource()).buffer=await Audio3DWA.loadBuffer(_settings.src),_settings.loaded=!0}(),await createStream(),_options.autoplay||_settings.loadingPlay||destroyStream(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),destroyBuffer())},this.convolve=async function(src){if(_convolution=src,!GlobalAudio3D.ready)return;if(!1===src)return void(_convolver&&(_convolver.disconnect(),_gain.disconnect(),_gain.connect(_filter),_convolver=null));let buffer=await Audio3DWA.loadBuffer(src);_convolver||(_convolver=_context.createConvolver(),_gain.disconnect(),_convolver.connect(_filter),_gain.connect(_convolver)),_convolver.buffer=buffer}})),Class((function Audio3DWASimpleBuffer(){Inherit(this,Audio3DBase);const _this=this;var _context,_buffer,_stream,_gain,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function initContext(){GlobalAudio3D.ready&&(_context=Audio3DWA.audioContext(),(_gain=_context.createGain?_context.createGain():_context.createGainNode()).connect(_context.destination))}function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function destroyBuffer(){_buffer&&_stream&&(_settings.loaded=!1,_stream.disconnect(_gain),_gain.disconnect(_context.destination),_buffer.stop(),_buffer=null,Audio3DWA.unloadBuffer(_settings.src))}async function createStream(){!_stream&&GlobalAudio3D.ready&&((_stream=_context.createBufferSource()).buffer=_buffer.buffer,_stream.loop=_options.loop,_stream.playbackRate=_options.playbackRate,_stream.onended=_=>{_this.stop(),_this.events.fire(Events.END),_options.selfDestruct&&_this.parent.destroy()},_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.connect(_gain),_stream.start(0,_currentTime))}function destroyStream(){_stream&&(_stream.disconnect(_gain),_stream.stop(),_stream=null)}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){destroyBuffer(),destroyStream(),_context=null,_gain=null,initContext(),initOptions(),(_options.autoplay||_settings.autoplay)&&_this.play()}initContext(),initOptions(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}(),this.set("src",src=>{_this.stop(),_settings.src=src,defer(_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume})}),this.get("src",_=>_settings.src),this.get("selfDestruct",_=>_options.selfDestruct),this.set("selfDestruct",d=>{_options.selfDestruct=d}),this.set("volume",v=>(_options.volume=v,_gain&&(_gain.gain.value=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume)),this.get("volume",_=>_options.volume),this.set("loop",l=>(l=!!l,_stream&&(_stream.loop=l),_options.loop=l)),this.get("loop",_=>_options.loop),this.set("autoplay",autoplay=>{_options.autoplay=autoplay}),this.get("autoplay",_=>_options.autoplay),this.set("preload",preload=>{_options.preload=preload}),this.get("preload",_=>_options.preload),this.get("ready",_=>_this.ready),this.get("playing",_=>_settings.playing),this.get("loaded",_=>_settings.loaded),this.get("currentTime",_=>_context&&_buffer?_context.currentTime%_buffer.buffer.duration:0),this.set("currentTime",t=>{_this.seek(t)}),this.get("visibilityMuted",_=>_options.muted),this.set("visibilityMuted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.get("muted",_=>_options.muted),this.set("muted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.set("playbackRate",v=>{_options.playbackRate=v,_stream&&(_stream.playbackRate.value=v*_options.globalPlaybackRate)}),this.get("playbackRate",_=>_options.playbackRate),this.get("duration",_=>_buffer?_buffer.buffer.duration:0),this.get("progress",_=>_this.currentTime/_this.duration),this.play=async function(){_settings.autoplay=!0,_settings.src&&GlobalAudio3D.ready&&(_settings.loadingPlay=!0,_stream||_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),await createStream(),_settings.playing=!0,_this.volume=_options.volume))},this.pause=function(){_settings.autoplay=!1,_stream&&GlobalAudio3D.ready&&_settings.src&&_settings.loaded&&_settings.playing&&(_currentTime=_context.currentTime,destroyStream(),_settings.loadingPlay=!1,_settings.playing=!1)},this.stop=function(){_settings.autoplay=!1,_settings.src&&GlobalAudio3D.ready&&_settings.loaded&&(_currentTime=0,destroyStream(),_settings.loading=!1,_settings.loaded=!1,_settings.loadingPlay=!1,_settings.playing=!1)},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_this.stop(),_currentTime=time,wasPlaying&&_this.play()}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){GlobalAudio3D.ready&&((_buffer=_context.createBufferSource()).buffer=await Audio3DWA.loadBuffer(_settings.src),_settings.loaded=!0)}(),await createStream(),_options.autoplay||_settings.loadingPlay||destroyStream(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),destroyBuffer())},this.convolve=async function(src){}})),Class((function Audio3DWAStream(){Inherit(this,Audio3DBase);const _this=this;var _context,_stream,_gain,_panner,_analyser,_filter,_delay,_convolver,_position,_frequency,_convolution,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){_context&&(_position=_context.listener.forwardX?_this.audioPosition().sub(_this.listenerPosition()):_this.audioPosition(),_panner.setPosition(_position.x,_position.y,_position.z))}function initContext(){_context=Audio3DWA.audioContext(),_gain=_context.createGain?_context.createGain():_context.createGainNode(),_panner=_context.createPanner(),(_analyser=_context.createAnalyser()).fftSize=32,_frequency=new Uint8Array(_analyser.frequencyBinCount),(_filter=_context.createBiquadFilter()).type="lowshelf",_filter.frequency.value=0,_filter.gain.value=1,(_delay=_context.createDelay(10)).delayTime.value=0}function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function createStream(){_stream||((_stream=Audio3DWA.loadStream(_settings.src)).element.onended=_=>{_this.unload(),_this.events.fire(Events.END)},_this.loop=_this.loop,_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.source.connect(_panner),_panner.connect(_gain),_convolver?(_gain.connect(_convolver),_convolver.connect(_filter)):_gain.connect(_filter),_filter.connect(_delay),_delay.connect(_analyser),_analyser.connect(_context.destination),_stream.element.currentTime=_currentTime,(_options.autoplay||_settings.autoplay)&&_this.play())}function destroyStream(){_stream&&(_stream.source.disconnect(_panner),_stream=null)}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){destroyStream(),_context=null,_gain=null,_panner=null,_analyser=null,_delay=null,_filter=null,_frequency=null,initContext(),initOptions(),_convolution&&_this.convolve(_convolution),(_settings.autoplay||_options.autoplay)&&_this.play()}initOptions(),initContext(),createStream(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}(),this.set("src",src=>{if(destroyStream(),_settings.src=src,_options.autoplay)return _this.play();_options.preload&&_this.load()}),this.get("src",_=>_settings.src),this.set("volume",v=>(v=Math.clamp(v,0,1),_options.volume=v,_gain&&(_gain.gain.value=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume)),this.get("volume",_=>_options.volume),this.set("loop",l=>(l=!!l,_stream&&(_stream.element.loop=l),_options.loop=l)),this.get("loop",_=>_options.loop),this.set("autoplay",autoplay=>{_options.autoplay=autoplay}),this.get("autoplay",_=>_options.autoplay),this.set("preload",preload=>{_options.preload=preload}),this.get("preload",_=>_options.preload),this.get("ready",_=>_this.ready),this.get("frequency",_=>(_analyser&&_analyser.getByteFrequencyData(_frequency),_frequency)),this.get("activity",_=>_analyser?(_analyser.getByteFrequencyData(_frequency),Math.clamp(_frequency.slice(3,13).reduce((n1,n2)=>n1+n2,0)/2560,0,1)):0),this.get("playing",_=>_settings.playing),this.set("rolloff",r=>{_options.rolloff=r,_panner&&(_panner.rolloffFactor=r)}),this.get("rolloff",_=>_options.rolloff),this.get("loaded",_=>!0),this.get("duration",_=>_stream?_stream.element.duration:0),this.get("currentTime",_=>_stream?_stream.element.currentTime:0),this.set("currentTime",t=>{_this.seek(t)}),this.get("progress",_=>_this.currentTime/_this.duration),this.set("playbackRate",v=>{_options.playbackRate=v,_stream&&_stream.element&&(_stream.element.playbackRate=v*_options.globalPlaybackRate)}),this.get("playbackRate",_=>_options.playbackRate),this.get("visibilityMuted",_=>_options.muted),this.set("visibilityMuted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.get("muted",_=>_options.muted),this.set("muted",muted=>{_options.muted=muted,_this.volume=_this.volume}),this.get("filter",_=>_filter),this.get("delay",_=>_delay),this.get("panner",_=>_panner),this.play=function(){_settings.autoplay=!0,_settings.src&&(createStream(),_stream&&!0!==_settings.playing&&(_settings.playing=!0,_this.volume=_this.volume,_this.startRender(loop),_stream.element.playbackRate=_options.playbackRate?_options.playbackRate:1,_stream.element.play().catch(e=>{})))},this.pause=function(){_settings.autoplay=!1,_stream&&_settings.src&&_settings.playing&&(_currentTime=_stream.element.currentTime,_stream.element.pause(),_settings.playing=!1,_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.src&&(_currentTime=0,_settings.playing=!1,_this.stopRender(loop),_stream&&_stream.element&&_stream.element.stop&&(_stream.element.stop(),_stream.element.currentTime=0))},this.seek=function(time){_settings.src&&(_currentTime=time,_stream&&(_stream.element.currentTime=time))},this.load=function(){_settings.src&&(_settings.playing||(createStream(),_stream.element.load()))},this.unload=function(){_settings.autoplay=!1,_settings.src&&(_this.stop&&_this.stop(),destroyStream(),Audio3DWA.unloadStream(_settings.src))},this.convolve=async function(src){if(_convolution=src,!1===src)return void(_convolver&&(_convolver.disconnect(),_gain.disconnect(),_gain.connect(_analyser),_convolver=null));let buffer=await Audio3DWA.loadBuffer(src);_convolver||(_convolver=_context.createConvolver(),_gain.disconnect(),_convolver.connect(_analyser),_gain.connect(_convolver)),_convolver.buffer=buffer}})),Namespace("FX"),FX.Class((function Bloom(_nuke=World.NUKE,_unique){Inherit(this,Component);var _mesh,_shader,_texture,_this=this,_scenes=[],_blurs=[],_dpr=World.DPR;function render(e){if(!_this.enabled)return;_shader.set("tMap",_texture||World.NUKE.rttBuffer.texture),_shader.set("uBloomMinLuma",_this.shader.uniforms.uBloomMinLuma.value);let strength=_this.shader.uniforms.uBloomBlurStrength.value,radius=_this.shader.uniforms.uBloomBlurRadius.value;for(let i=_blurs.length-1;i>-1;i--){let blur=_blurs[i];blur.set("uStrength",strength),blur.uniforms.uDir.value.x=blur.uniforms.uDir.value.x>0?radius*_dpr:0,blur.uniforms.uDir.value.y=blur.uniforms.uDir.value.y>0?radius*_dpr:0}for(let i=0;i<_scenes.length;i++){let scene=_scenes[i];scene.nuke.camera=e.camera,scene.nuke.stage=e.stage,scene.render()}}function resizeHandler(){for(let i=0;i<_scenes.length;i++){let w=Math.round(Stage.width/(2*(i+1))),h=Math.round(Stage.height/(2*(i+1)));_scenes[i].setSize(w,h)}}this.uniforms={},this.enabled=!0,function initMesh(){_this.shader=new Shader("TextureMaterial",{unique:"Bloom_"+_unique,uBloomMinLuma:{value:0},uBloomBlurStrength:{value:1},uBloomBlurRadius:{value:2.5}}),_shader=_this.initClass(Shader,"BloomQuad",{tMap:{value:null},uBloomMinLuma:{value:0}}),(_mesh=new Mesh(World.QUAD,_shader)).frustumCulled=!1}(),function initRTs(){let addBlur=nuke=>{[new Vector2(2.5*_dpr,0),new Vector2(0,2.5*_dpr)].forEach(dir=>{let pass=new NukePass("BloomBlur",{uDir:{value:dir},uStrength:{value:.5}});nuke.add(pass),_blurs.push(pass)})};for(let i=0;i<4;i++){let w=Math.round(Stage.width/(2*(i+1))),h=Math.round(Stage.height/(2*(i+1))),scene=_this.initClass(FXScene,World.NUKE);scene.setSize(w,h),scene.scene.add(_mesh.clone()),_scenes.push(scene),addBlur(scene.nuke)}}(),function initPass(){for(let i=0;i<_scenes.length;i++)_this.uniforms["tBloom"+i]={value:_scenes[i].rt.texture,ignoreUIL:!0};_this.uniforms.uBloomAddStrength={value:1},_this.pass=_this.initClass(NukePass,"BloomPass",_this.uniforms)}(),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler),_this.events.sub(RenderManager.RENDER,render)}(),ShaderUIL.add(_this.shader).setLabel("Bloom"),this.set("dpr",dpr=>{_dpr=dpr;for(let i=0;i<_scenes.length;i++)_scenes[i].setDPR(dpr)}),this.set("texture",texture=>{_texture=texture})})),Class((function CloudFog(_config={}){Inherit(this,FXScene);const _this=this;var _input,_shader,_batch;function loop(){_this.enabled&&_batch.mesh&&_this.nuke.renderer.renderSingle(_batch.mesh,_this.nuke.camera,_this.rt)}this.enabled=!0,_this.create(),_config.dpr&&_this.setDPR(_config.dpr),_config.resolution&&_this.setResolution(_config.resolution),_config.camera&&_this.useCamera(_config.camera),(_input=InputUIL.create("CloudFog"+(_config.name||""))).add("planes",20),_input.addVector("width",[-1,1]),_input.addVector("height",[-1,1]),_input.addVector("depth",[-1,1]),_input.addNumber("scale",1,.05),_input.addNumber("alpha",1,.05),_input.addNumber("speed",1,.05),_input.addNumber("noise",0,.05),_input.addNumber("cullDistance",999),_shader=_this.initClass(Shader,"CloudFogShader",{tMap:{value:Utils3D.getTexture("assets/images/fog/cloud.jpg"),ignoreUIL:!0},uColor:{value:new Color},uQuaternion:{value:_this.nuke.camera.quaternion},uAlpha:{value:1},uScale:{value:1},uSpeed:{value:1},uNoiseScale:{value:.55},uNoiseTime:{value:.15},uNoiseStrength:{value:1},uCullDistance:{value:999},transparent:!0,depthWrite:!1}),_input.onUpdate=_=>{_shader.set("uScale",_input.getNumber("scale")),_shader.set("uAlpha",_input.getNumber("alpha")),_shader.set("uSpeed",_input.getNumber("speed")),_shader.set("uNoiseStrength",_config.disableNoise?0:_input.getNumber("noise")),_shader.set("uCullDistance",_input.getNumber("cullDistance"))},_input.onUpdate(),function initMesh(){let total=_input.getNumber("planes"),width=_input.get("width"),height=_input.get("height"),depth=_input.get("depth");(_batch=_this.initClass(MeshBatch)).static=!0,_this.scene.add(_batch.group);for(let i=0;i<total;i++){let mesh=new Mesh(World.PLANE,_shader);mesh.position.x=Math.random(width[0],width[1],4),mesh.position.y=Math.random(height[0],height[1],4),mesh.position.z=Math.random(depth[0],depth[1],4),mesh.attributes={random:new Vector4(Math.random(),Math.random(),Math.random(),Math.random())},_batch.add(mesh)}}(),!1!==_config.enabled&&_this.startRender(loop,World.NUKE)})),Module((function ConsoleSecurity(){this.exports=function(){let err=new Error;if(err.stack){let stack=err.stack.toString().toLowerCase();if(stack.includes(["@debugger","_evaluateandwrap","eval code:1:1)"]))return!0;if(stack.includes("<anonymous>:1"))return!stack.includes("eval at")}return!1}})),Class((function ImageDecoder(){Inherit(this,Component);var _compressed,_this=this;const ACTIVE=!(!(window.fetch&&window.createImageBitmap&&Device.system.browser.includes("chrome"))||window.AURA);function decodeImage(data,id){(async _=>{try{let e=await fetch(data.path,{mode:"cors"});if(200!=e.status)throw resolve({fail:!0},id),"Image not found :: "+data.path;let blob=await e.blob(),obj={imageOrientation:"flipY",crossOrigin:"anonymous"};data.params&&!1===data.params.premultiplyAlpha&&(obj.premultiplyAlpha="none"),obj.imageOrientation=data.params&&!1===data.params.flipY?void 0:"flipY";let bitmap=await createImageBitmap(blob,obj),message={post:!0,id:id,message:bitmap};self.postMessage(message,[bitmap])}catch(e){throw resolve({fail:!0},id),e}})()}function decodeCompressedImage(data,id){(async _=>{let ext;data.settings.dxt?ext="dxt":data.settings.etc?ext="astc":data.settings.pvrtc?ext="pvrtc":data.settings.astc&&(ext="astc");let fileName=data.path.split("/");fileName=fileName[fileName.length-1];let e=await fetch(`${data.path}/${fileName}-${ext}.ktx`);if(200!=e.status)throw"Image not found :: "+data.path;try{let arrayBuffer=await e.arrayBuffer(),header=new Int32Array(arrayBuffer,12,13),gliFormat=(header[1],header[2],header[3],header[4]),width=(header[5],header[6]),height=header[7],miplevels=header[11],bytesOfKeyValueData=header[12],buffers=[],compressedData=[],sizes=[],dataOffset=64+bytesOfKeyValueData;for(let level=0;level<miplevels;level++){let imageSize=new Int32Array(arrayBuffer,dataOffset,1)[0];dataOffset+=4;let byteArray=new Uint8Array(arrayBuffer,dataOffset,imageSize);dataOffset+=imageSize,dataOffset+=3-(imageSize+3)%4,sizes.push(width),width=Math.max(1,.5*width),height=Math.max(1,.5*height);let clone=new Uint8Array(byteArray);compressedData.push(clone),buffers.push(clone.buffer)}resolve({gliFormat:gliFormat,compressedData:compressedData,sizes:sizes,width:width,height:height},id,buffers)}catch(e){throw data.path+" could not be decoded"}})()}this.scale=1,async function(){await Hydra.ready(),Thread.upload(decodeImage),Thread.upload(decodeCompressedImage)}(),this.decode=async function(path,params={}){if(path=Thread.absolutePath(Assets.getPath(path)),!_compressed){_compressed={dxt:!!Renderer.extensions.s3tc,etc:!!Renderer.extensions.etc1,pvrtc:!!Renderer.extensions.pvrtc,astc:!!Renderer.extensions.astc};let found=!1;for(let key in _compressed)1==_compressed[key]&&(found=!0);found||(_compressed=null)}if(!_compressed&&path.includes("-compressedKtx")&&(path=path.replace("-compressedKtx","")),path.includes("-compressedKtx")){return path=path.substring(0,path.lastIndexOf(".")),await Thread.shared().decodeCompressedImage({path:path,params:params,settings:_compressed})}try{let bitmap=await(ACTIVE?Thread.shared().decodeImage({path:path,params:params}):Assets.decodeImage(path,params));if(bitmap.fail)throw"could not decode "+path;return function process(bitmap,scale){if(1==scale*_this.scale)return bitmap;let pow2=Math.isPowerOf2(bitmap.width,bitmap.height),canvas=document.createElement("canvas");return canvas.context=canvas.getContext("2d"),canvas.width=Math.round(bitmap.width*_this.scale*scale),canvas.height=Math.round(bitmap.height*_this.scale*scale),pow2&&scale*_this.scale<1&&(canvas.width=canvas.height=Math.floorPowerOf2(Math.max(canvas.width,canvas.height))),canvas.context.drawImage(bitmap,0,0,canvas.width,canvas.height),canvas}(bitmap,params.scale||1)}catch(e){throw"could not decode "+path}}}),"static"),Class((function BaseCamera(_input,_group){Inherit(this,Object3D);const _this=this;var _type="perspective";function resize(){switch(_type){case"perspective":_this.camera.aspect=Stage.width/Stage.height,_this.camera.updateProjectionMatrix();break;case"orthographic":if(_this.width||_this.height)_this.camera.setViewport(_this.width,_this.height);else{let m=900/Stage.height/100;_this.camera.setViewport(Stage.width*m,Stage.height*m)}}}this.camera=new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),this.group.add(this.camera),this.startRender(_=>{_this.group.updateMatrixWorld(!0)}),this.onResize(_=>{resize()}),_input&&(_this.prefix=_input.prefix,CameraUIL.add(_this,_group).setLabel("Camera")),this.playgroundLock=function(camera=Camera.instance()){if(!Global.PLAYGROUND)return;Utils.getConstructorName(_this.parent).includes(Global.PLAYGROUND.split("/")[0])&&RenderManager.type==RenderManager.NORMAL&&camera.lock(_this.camera)},this.lock=function(camera=Camera.instance()){if("orthographic"==_type)return console.error("You can't lock an orthographic camera to the main camera. Use an FXScene .setCamera");RenderManager.type==RenderManager.NORMAL&&camera.lock(_this.camera)},this.transition=function(time,ease,delay,camera=Camera.instance()){"object"==typeof delay&&(camera=delay,delay=0);let p=Promise.create();return camera.transition(_this.camera,time,ease,delay||0),_this.delayedCall(_=>p.resolve(),time+(delay||0)),p},this.setFOV=function(fov){fov!=this.camera.fov&&(this.camera.fov=fov,this.camera.updateProjectionMatrix())},this.getFOV=function(){return this.camera.fov},this.useOrthographic=function(w,h){"orthographic"!==_type&&(isNaN(w)||(this.width=w),isNaN(h)||(this.height=h),this.camera&&this.group.remove(this.camera),this.camera=new OrthographicCamera,this.group.add(this.camera),this.camera.position.z=1,_type="orthographic",resize())},this.usePerspective=function(){"perspective"!==_type&&(this.camera&&this.group.remove(this.camera),this.camera=new PerspectiveCamera,this.group.add(this.camera),_type="perspective",resize())},this.useCurve=function(curve){return _this.camera.curve=curve,this}})),Class((function Camera(_worldCamera){Inherit(this,Component);const _this=this;var _debug,_prevCamera,_lockCamera,_curve,_calc=new Vector3,_target=new Group,_anim={weight:0,weight2:0},_center=new Vector3;function loop(){if(_debug&&(_debug.visible=!_debug.position.equals(_center)),_anim.weight+=(_anim.weight2-_anim.weight)*_this.lerp,_prevCamera){if(_prevCamera.updateMatrixWorld(),_lockCamera.updateMatrixWorld(),_curve){let pos=_curve.getPoint(_anim.weight);pos.lerp(_prevCamera.getWorldPosition(),Math.range(_anim.weight,0,.1,1,0,!0),!1),pos.lerp(_lockCamera.getWorldPosition(),Math.range(_anim.weight,.6,1,0,1,!0),!1),_curve.lerpPos||(_curve.lerpPos=(new Vector3).copy(_prevCamera.getWorldPosition()),_curve.lerpBlend={value:0});let lerp=Math.mix(_curve.lerp||.02,1,_curve.lerpBlend.value);_curve.lerpPos.lerp(pos,lerp,!1),0==_curve.lerpBlend.value&&_calc.subVectors(_worldCamera.position,_lockCamera.getWorldPosition()).length()<.01&&(_curve.lerpBlend.value=.001,tween(_curve.lerpBlend,{value:1},1e3,"linear"),_this.onCurveComplete&&_this.onCurveComplete()),_target.position.copy(_curve.lerpPos)}else _target.position.copy(_prevCamera.getWorldPosition()).lerp(_lockCamera.getWorldPosition(),_anim.weight,!1);_target.quaternion.copy(_prevCamera.getWorldQuaternion()).slerp(_lockCamera.getWorldQuaternion(),_anim.weight,!1),_worldCamera.fov!=_lockCamera.fov&&(_worldCamera.fov+=(_lockCamera.fov-_worldCamera.fov)*_anim.weight,_worldCamera.updateProjectionMatrix()),_worldCamera.position.lerp(_target.position,_this.lerp2,!1),_worldCamera.quaternion.slerp(_target.quaternion,_this.lerp2,!1)}else _lockCamera&&(_lockCamera.updateMatrixWorld(),Utils3D.decompose(_lockCamera,_worldCamera),_worldCamera.fov!=_lockCamera.fov&&(_worldCamera.fov=_lockCamera.fov,_worldCamera.updateProjectionMatrix()));_worldCamera.updateMatrixWorld(),_debug&&(_debug.position.copy(_worldCamera.position),_debug.quaternion.copy(_worldCamera.quaternion)),_this.postLoop()}this.lerp=1,this.lerp2=1,this.worldCamera=_worldCamera,RenderManager.type==RenderManager.NORMAL&&(Utils.query("orbit")||Utils.query("wasd")?function initDebug(){(_debug=new Mesh(new BoxGeometry(.25,.25,.5,1,1,5),new Shader("DebugCamera",{uColor:{value:new Color,transparent:!0,depthTest:!1}}))).renderOrder=9999,World.SCENE.add(_debug),_worldCamera=new PerspectiveCamera;let p=Global.PLAYGROUND||"m";p+=Utils.query("wasd")?"wasd":"orbit";let pos=Storage.get("debugCameraPos_"+p)||World.CAMERA.position.toArray();World.CAMERA.position.fromArray(pos),World.CAMERA.position.debug=!0,Global.DEBUG_CAMERA_POS=pos,World.CONTROLS.onChange=_=>Storage.set("debugCameraPos_"+p,World.CAMERA.position.toArray())}():World.CONTROLS&&(World.CONTROLS.enabled=!1),_this.startRender(loop)),this.lock=function(camera){_lockCamera=camera,_worldCamera.fov=_lockCamera.fov,_worldCamera.updateProjectionMatrix(),_prevCamera=null,loop()},this.transition=function(camera,duration=1e3,ease="easeInOutCubic"){return _curve&&(_curve.lerpPos=_curve.lerpBlend=null),camera.curve&&((_curve=camera.curve).lerpPos=camera.lerpPos),_prevCamera===camera?(duration*=.5*Math.smoothStep(.5,1,_anim.weight)+.5,_anim.weight=1-_anim.weight):_anim.weight=0,_anim.weight2=_anim.weight,_prevCamera=_lockCamera,_lockCamera=camera,tween(_anim,{weight2:1},duration,ease)},this.get("worldCamera",_=>_worldCamera),this.get("lockCamera",_=>_lockCamera),this.set("debugScale",s=>{_debug&&_debug.scale.setScalar(s)}),this.createLocal=function(camera){return camera||(camera=World.CAMERA.clone(),_this.onResize(_=>{camera.aspect=Stage.width/Stage.height,camera.updateProjectionMatrix()})),new Camera(camera.camera||camera)}}),"singleton"),Class((function GazeCamera(_input,_group){Inherit(this,BaseCamera);const _this=this;var _strength={v:1},_move=new Vector3,_position=new Vector3,_wobble=new Vector3,_rotation=0,_wobbleAngle=Math.radians(Math.rand(0,360)),_innerGroup=new Group;function loop(){if(_this.useAccelerometer&&Device.mobile)_move.x=_this.position.x+Math.range(Mobile.Accelerometer.x,-2,2,-1,1,!0)*_strength.v*_this.moveXY.x*_this.strength,_move.y=0;else{_move.x=_this.position.x+Math.range(Mouse.x,0,Stage.width,-1,1,!0)*_strength.v*_this.moveXY.x*_this.strength,_move.y=_this.position.y+Math.range(Mouse.y,0,Stage.height,-1,1,!0)*_strength.v*_this.moveXY.y*_this.strength;let rotateStrength=Math.range(Math.abs(Mouse.delta.x)/Stage.width,0,.02,0,1,!0);_rotation=Math.lerp(Math.radians(_this.deltaRotate)*rotateStrength*Math.sign(Mouse.delta.x),_rotation,.02*_this.deltaLerp*_strength.v),_this.group.rotation.z=Math.lerp(_rotation,_this.group.rotation.z,.07*_this.deltaLerp)}if(_move.z=_this.position.z,_position.lerp(_move,_this.lerpSpeed2),_this.camera.position.lerp(_position,_this.lerpSpeed),_this.camera.lookAt(_this.lookAt),_this.wobbleStrength>0){let t=Render.TIME;_wobble.x=Math.cos(_wobbleAngle+t*(75e-5*_this.wobbleSpeed))*(_wobbleAngle+200*Math.sin(t*(95e-5*_this.wobbleSpeed))),_wobble.y=Math.sin(Math.asin(Math.cos(_wobbleAngle+t*(85e-5*_this.wobbleSpeed))))*(150*Math.sin(_wobbleAngle+t*(75e-5*_this.wobbleSpeed))),_wobble.x*=2*Math.sin(_wobbleAngle+t*(75e-5*_this.wobbleSpeed)),_wobble.y*=1.75*Math.cos(_wobbleAngle+t*(65e-5*_this.wobbleSpeed)),_wobble.x*=1.1*Math.cos(_wobbleAngle+t*(75e-5*_this.wobbleSpeed)),_wobble.y*=1.15*Math.sin(_wobbleAngle+t*(25e-5*_this.wobbleSpeed)),_wobble.z=Math.sin(_wobbleAngle+.0025*_wobble.x)*(100*_this.wobbleZ),_wobble.multiplyScalar(.001*_this.wobbleStrength*_strength.v),_innerGroup.position.lerp(_wobble,.07)}}this.strength=1,this.moveXY=new Vector2(4,4),this.position=new function Position(){Inherit(this,Component);var _x=0,_y=0,_z=0;this.get("x",_=>_x),this.get("y",_=>_y),this.get("z",_=>_z),this.set("x",x=>{_x=x}),this.set("y",y=>{_y=y}),this.set("z",z=>{_z=z,_move.z=_z,_this.camera.position.copy(_move),_position.copy(_move)}),this.set=function(x,y,z,noCopy){_x=x,_y=y,_z=z,_move.z=z,noCopy||_this.camera.position.copy(_move),_position.copy(_move)},this.toArray=function(){return[_x,_y,_z]},this.fromArray=function(array){_x=array[0],_y=array[1],_z=array[2],_move.set(_x,_y,_z),_this.camera.position.copy(_move),_position.copy(_move)}},this.lerpSpeed=.04,this.lerpSpeed2=1,this.lookAt=new Vector3(0,0,0),this.deltaRotate=10,this.deltaLerp=1,this.wobbleSpeed=1,this.wobbleStrength=0,this.wobbleZ=1,_input&&(_this.prefix=_input.prefix,CameraUIL.add(_this,_group).setLabel("Camera")),Mobile.Accelerometer.capture(),_this.startRender(loop),_innerGroup.add(_this.camera),_this.group.add(_innerGroup),this.orbit=function(time=1e3,ease="easeInOutSine"){return tween(_strength,{v:1},time,ease)},this.still=function(time=300,ease="easeInOutSine"){return tween(_strength,{v:0},time,ease)}}));class Base3D{constructor(){this.position=new Vector3D,this.rotation=new Euler,this.quaternion=new Quaternion,this.scale=new Vector3D(1,1,1),this._parent=null,this.up=new Vector3(0,1,0),this.isObject3D=!0,this.children=[],this.childrenLength=0,this.modelViewMatrix=new Matrix4,this.normalMatrix=new Matrix3,this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=!0,this.matrixWorldNeedsUpdate=!1,this.matrixDirty=!0,this.visible=!0,this.castShadow=!1,this.frustumCulled=!0,this._renderOrder=0,this.worldPos=new Vector3;const _this=this;this.quaternion.onChange(_=>{_this.matrixDirty=!0,_this.rotation.setFromQuaternion(_this.quaternion,void 0,!1)}),this.rotation.onChange(_=>{_this.matrixDirty=!0,_this.quaternion.setFromEuler(_this.rotation,!1)}),this.scale.onChange(_=>{_this.matrixDirty=!0}),this.position.onChange(_=>{_this.matrixDirty=!0})}get renderOrder(){return this._renderOrder}set renderOrder(value){this._renderOrder=value;let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent;for(let i=0;i<this.children.length;i++)this.children[i].renderOrder+=value}applyMatrix(matrix){return this.matrix.multiplyMatrices(matrix,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale),this}applyQuaternion(q){return this.quaternion.premultiply(q),this}setRotationFromAxisAngle(axis,angle){this.quaternion.setFromAxisAngle(axis,angle)}setRotationFromMatrix(m){this.quaternion.setFromRotationMatrix(m)}setRotationFromQuaternion(q){this.quaternion.copy(q)}localToWorld(v){return v.applyMatrix4(this.matrixWorld)}worldToLocal(v){let m1=this.M1||new Matrix4;this.M1=m1,v.applyMatrix4(m1.getInverse(this.matrixWorld))}lookAt(x,y,z){let m1=this.M1||new Matrix4;this.M1=m1;let v=this.V1||new Vector3;this.V1=v,x.isVector3?v.copy(x):v.set(x,y,z),this.isCamera?m1.lookAt(this.position,v,this.up):m1.lookAt(v,this.position,this.up),this.quaternion.setFromRotationMatrix(m1)}add(object){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.add(arguments[i]);return this}if(object===this)return this;if(object&&object.isObject3D?(null!==object._parent&&object._parent.remove(object),object._parent=this,this.children.push(object),this.childrenLength=this.children.length):console.error("Object is not instance of Object3D",object),this.isScene)this.displayNeedsUpdate=!0;else{let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent}return this}remove(object){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.remove(arguments[i]);return this}if(this.isScene)this.displayNeedsUpdate=!0;else{let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent}this.children.remove(object),this.childrenLength=this.children.length}getWorldPosition(target){let v=this.V1||new Vector3;return this.V1=v,target||(target=v),this.updateMatrixWorld(),target.setFromMatrixPosition(this.matrixWorld)}getWorldScale(target){let v=this.V1S||new Vector3;this.V1S=v;let v2=this.V12||new Vector3;this.V2=v2;let q=this.Q1||new Quaternion;return this.Q1=q,target||(target=v2),this.updateMatrixWorld(),this.matrixWorld.decompose(v,q,target),target}getWorldQuaternion(target){let v=this.V1Q||new Vector3;this.V1Q=v;let q=this.Q1||new Quaternion;return this.Q1=q,target||(target=q),this.updateMatrixWorld(),this.matrixWorld.decompose(v,target,v),target}traverse(callback){callback(this);let children=this.children;for(let i=0;i<children.length;i++)children[i].traverse(callback)}updateMatrix(){!1!==this.matrixAutoUpdate&&(this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0)}updateMatrixWorld(force){if(!1===this.matrixAutoUpdate)return;if(!force&&!this.determineVisible())return;(this.determineDirty()||force)&&!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==force||(null===this._parent||this.determineNoTransform()?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this._parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1),this.children.forEach(c=>c.updateMatrixWorld(force)),this.matrixDirty=!1}clone(recursive){(new this.constructor).copy(this,recursive)}copy(source,recursive){if(this.name=source.name,this.up.copy(source.up),this.position.copy(source.position),this.quaternion.copy(source.quaternion),this.scale.copy(source.scale),this.matrix.copy(source.matrix),this.matrixWorld.copy(source.matrixWorld),this.matrixAutoUpdate=source.matrixAutoUpdate,this.matrixWorldNeedsUpdate=source.matrixWorldNeedsUpdate,this.visible=source.visible,this.castShadow=source.castShadow,this.receiveShadow=source.receiveShadow,this.frustumCulled=source.frustumCulled,this.renderOrder=source.renderOrder,!0===recursive)for(let i=0;i<source.children.length;i++){let child=source.children[i];this.add(child.clone())}return this}render(){}determineVisible(){if(this.determineVisibleCacheTime>0&&Render.TIME-this.determineVisibleCacheTime<8)return this.determineVisibleCache;if(this.determineVisibleCacheTime=Render.TIME,!this.visible)return this.determineVisibleCache=!1,!1;let p=this._parent;for(;p;){if(!p.visible)return this.determineVisibleCache=!1,!1;p=p._parent}return this.determineVisibleCache=!0,!0}determineDirty(){let p=this._parent;for(;p;){if(p.matrixDirty)return!0;p=p._parent}return this.matrixDirty}determineNoTransform(){return this._parent?this._parent.determineNoTransform()&&this.matrix.isIdentity():this.matrix.isIdentity()}translateX(distance){this.xAxis||(this.xAxis=new Vector3(1,0,0)),this.translateOnAxis(this.xAxis,distance)}translateY(distance){this.yAxis||(this.yAxis=new Vector3(0,1,0)),this.translateOnAxis(this.yAxis,distance)}translateZ(distance){this.zAxis||(this.zAxis=new Vector3(0,0,1)),this.translateOnAxis(this.zAxis,distance)}translateOnAxis(axis,distance){let v=this.V1||new Vector3;return this.V1=v,v.copy(axis).applyQuaternion(this.quaternion),this.position.add(v.multiplyScalar(distance)),this}upload(){this.shader&&(this.shader.upload(this,this.geometry),this.shader.shadow&&this.shader.shadow.upload(this,this.geometry)),this.geometry&&this.geometry.upload(this,this.shader)}destroy(){this.geometry&&this.geometry.destroy&&this.geometry.destroy(this),this.shader&&this.shader.destroy&&this.shader.destroy(this),this.hitDestroy&&this.hitDestroy(),this._gl&&this._gl.ubo&&this._gl.ubo.destroy(),this._gl&&this._gl.vao&&this._gl.vao.destroy(),this._gl&&(this._gl=null),this._parent&&this._parent.remove(this),this.parent&&this.parent.__destroyChild&&this.parent.__destroyChild(this.__id)}}Class((function Renderer(_params={}){Inherit(this,Component);const _this=this;var _canvas,_gl,_width,_height,_anisotropy,_clearColor,_projScreenMatrix,_frustum,_ubo,_dpr=1,_resolution=new Vector2,_m0=new Matrix4,_m1=new Matrix4,_time={value:0},_stencilActive=!1;function initCameraUBO(camera){camera._ubo=new UBO(0,_gl),camera._ubo.push({value:camera.projectionMatrix}),camera._ubo.push({value:camera.matrixWorldInverse}),camera._ubo.push({value:camera.worldPos}),camera._ubo.push({value:_resolution}),camera._ubo.push(_time),camera._ubo.push(Render.timeScaleUniform),camera._ubo.upload()}function attachSceneUniforms(object,scene,camera){if(Shader.renderer.appendUniform(object.shader,"normalMatrix",object.normalMatrix),Shader.renderer.appendUniform(object.shader,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader,"modelViewMatrix",object.modelViewMatrix),_ubo?camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader,"projectionMatrix",camera.projectionMatrix),Shader.renderer.appendUniform(object.shader,"viewMatrix",camera.matrixWorldInverse),Shader.renderer.appendUniform(object.shader,"cameraPosition",camera.worldPos),Shader.renderer.appendUniform(object.shader,"resolution",_resolution),Shader.renderer.appendUniform(object.shader,"time",_time.value),Shader.renderer.appendUniform(object.shader,"timeScale",Render.timeScaleUniform.value)),_this.shadows&&object.shader.receiveShadow&&!_this.overridePreventShadows){let lights=Lighting.getShadowLights();object._gl||(object._gl={}),object._gl.shadowData||(object._gl.shadowData={combined:new Float32Array(16*lights.length)});for(let i=0;i<lights.length;i++){let light=lights[i];_m1.multiplyMatrices(light.shadow.camera.matrixWorldInverse,object.matrixWorld),_m0.multiplyMatrices(light.shadow.camera.projectionMatrix,_m1),_m0.toArray(object._gl.shadowData.combined,16*i)}scene._shadowData&&scene._shadowData.count&&(object.shader.uniforms.shadowMap.value=scene._shadowData[_this.overridePreventShadows?"emptyMaps":"maps"],Shader.renderer.appendUniform(object.shader,"shadowMatrix",object._gl.shadowData.combined,"matrix"),Shader.renderer.appendUniform(object.shader,"shadowLightPos",scene._shadowData.pos,"vec3"),Shader.renderer.appendUniform(object.shader,"shadowSize",scene._shadowData.size,"float"))}}function attachShadowUniforms(object,scene,light){light._mvm||(light._mvm=new Matrix4),light._nm||(light._nm=new Matrix3),light._mvm.multiplyMatrices(light.shadow.camera.matrixWorldInverse,object.matrixWorld),light._nm.getNormalMatrix(object.modelViewMatrix),Shader.renderer.appendUniform(object.shader.shadow,"normalMatrix",light._nm),Shader.renderer.appendUniform(object.shader.shadow,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader.shadow,"modelViewMatrix",light._mvm),_ubo?light.shadow.camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader.shadow,"projectionMatrix",light.shadow.camera.projectionMatrix),Shader.renderer.appendUniform(object.shader.shadow,"viewMatrix",light.shadow.camera.matrixWorldInverse))}function loop(t,dt){_time.value+=.001*dt}function render(scene,camera,rt){rt&&rt.width?(_resolution.set(rt.width,rt.height),RenderTarget.renderer.bind(rt)):(Renderer.overrideViewport||(_gl.viewport(0,0,_width*_dpr,_height*_dpr),_resolution.set(_canvas.width,_canvas.height)),_this.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))),camera.parent||camera.updateMatrixWorld(),camera.getWorldPosition(camera.worldPos),_frustum.setFromCamera(camera),_ubo&&(camera._ubo?camera._ubo.update():initCameraUBO(camera));for(let l=0;l<2;l++){let len=scene.toRender[l].length;for(let i=0;i<len;i++){let object=scene.toRender[l][i];object.onBeforeRender&&object.onBeforeRender(),object.determineVisible()&&object.shader.visible&&!object.shader.neverRender&&(!1!==object.frustumCulled&&!0!==_frustum.intersectsObject(object)||(object.shader.draw(object,object.geometry),attachSceneUniforms(object,scene,camera),object.geometry.draw(object,object.shader)))}}rt&&rt.width&&RenderTarget.renderer.unbind(rt)}this.autoClear=!0,this.shadows=Renderer.SHADOWS_MED,Renderer.instance=_this,Renderer.CLEAR=[0,0,0,1],function initContext(){let contextAttributes={antialias:void 0!==_params.antialias&&_params.antialias,powerPreference:_params.powerPreference,preserveDrawingBuffer:_params.preserveDrawingBuffer,xrCompatible:_params.xrCompatible,alpha:void 0!==_params.alpha&&_params.alpha,stencil:_params.stencil};if(_this.stencil=!!_params.stencil,_canvas=_params.canvas||document.createElement("canvas"),_params.gl?(_gl=_params.gl,_this.type=Device.graphics.webgl.version.includes(["webgl 2","webgl2"])?Renderer.WEBGL2:Renderer.WEBGL1):Device.graphics.webgl?["webgl2","webgl","experimental-webgl"].forEach(name=>{_gl||"webgl2"==name&&_params.forceWebGL1||(_gl=_canvas.getContext(name,contextAttributes),_this.type=_gl&&"webgl2"==name?Renderer.WEBGL2:Renderer.WEBGL1)}):(_gl=new NoGLPolyfill,_this.type=Renderer.WEBGL2),!_gl)throw"Error! Could not create WebGL context";_this.domElement=_canvas,_canvas.style.background="black",Renderer.type=_this.type,Renderer.context=_this.context=_gl}(),function setExtensions(){_this.extensions={},_this.type!=Renderer.WEBGL2?(_this.extensions.VAO=_gl.getExtension("OES_vertex_array_object"),_this.extensions.instancedArrays=_gl.getExtension("ANGLE_instanced_arrays"),_this.extensions.standardDerivatives=_gl.getExtension("OES_standard_derivatives"),_this.extensions.depthTextures=_gl.getExtension("WEBGL_depth_texture"),_this.extensions.drawBuffers=_gl.getExtension("WEBGL_draw_buffers"),_this.extensions.halfFloat=_gl.getExtension("OES_texture_half_float"),_this.extensions.float=_gl.getExtension("OES_texture_float"),_this.extensions.colorBufferFloat=_gl.getExtension("WEBGL_color_buffer_float")):_this.extensions.colorBufferFloat=_gl.getExtension("EXT_color_buffer_float"),_this.extensions.filterFloat=_gl.getExtension("OES_texture_float_linear"),_this.extensions.anisotropy=_gl.getExtension("EXT_texture_filter_anisotropic")||_gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),_this.extensions.astc=_gl.getExtension("WEBGL_compressed_texture_astc"),_this.extensions.atc=_gl.getExtension("WEBGL_compressed_texture_atc"),_this.extensions.etc=_gl.getExtension("WEBGL_compressed_texture_etc"),_this.extensions.etc1=_gl.getExtension("WEBGL_compressed_texture_etc1"),_this.extensions.pvrtc=_gl.getExtension("WEBGL_compressed_texture_pvrtc")||_gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),_this.extensions.s3tc=_gl.getExtension("WEBGL_compressed_texture_s3tc")||_gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),_this.extensions.s3tc_srgb=_gl.getExtension("WEBGL_compressed_texture_s3tc_srgb"),Renderer.extensions=_this.extensions}(),function initRenderers(){Geometry.renderer=new GeometryRendererWebGL(_gl),Texture.renderer=new TextureRendererWebGL(_gl),Shader.renderer=new ShaderRendererWebGL(_gl),RenderTarget.renderer=new FBORendererWebGL(_gl)}(),function initMath(){_projScreenMatrix=new Matrix4,new Vector3,_frustum=new Frustum}(),function initUBO(){_this.type==Renderer.WEBGL2&&(_ubo=!0),Renderer.UBO=_ubo}(),_this.startRender(loop),this.render=function(scene,camera,rt,forceToScreen){scene.displayNeedsUpdate&&(scene.toRender[0].length=0,scene.toRender[1].length=0),scene.updateMatrixWorld(),function projectObject(object,camera,scene){if(void 0!==object.shader){let visible=object.determineVisible()&&object.shader.visible&&!object.shader.neverRender;visible&&(object.modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix)),(scene.displayNeedsUpdate||object.shader.transparent&&!scene.disableAutoSort&&visible)&&object.getWorldPosition(object.worldPos),scene.displayNeedsUpdate&&scene.toRender[object.shader.transparent?1:0].push(object)}if(!0===object.visible||scene.displayNeedsUpdate)for(let i=object.childrenLength-1;i>-1;i--)projectObject(object.children[i],camera,scene)}(scene,camera,scene),scene.displayNeedsUpdate&&function sortOpaque(array){for(let i=array.length-1;i>-1;i--){let obj=array[i];obj.shader._gl||obj.shader.upload()}array.sort((a,b)=>{if(a.renderOrder!==b.renderOrder)return a.renderOrder-b.renderOrder;let aid=a.shader._gl._id,bid=b.shader._gl._id;return aid!==bid?aid-bid:a.id-b.id})}(scene.toRender[0]),(scene.displayNeedsUpdate||scene.toRender[1].length&&!scene.disableAutoSort)&&function sortTransparent(array){RenderStats.update("SortTransparent",array.length),array.sort((a,b)=>a.renderOrder!==b.renderOrder?a.renderOrder-b.renderOrder:a.worldPos.z!==b.worldPos.z?a.worldPos.z-b.worldPos.z:a.id-b.id)}(scene.toRender[1]),_this.shadows&&!_this.overridePreventShadows&&!_this.pauseShadowRendering&&scene.hasShadowLight&&function renderShadows(scene,camera){let render=light=>{RenderTarget.renderer.bind(light.shadow.rt),RenderStats.update("ShadowLights"),light.shadow.camera.updateMatrixWorld(),camera.getWorldPosition(camera.worldPos),_frustum.setFromCamera(camera),_ubo&&(light.shadow.camera._ubo?light.shadow.camera._ubo.update():initCameraUBO(light.shadow.camera));for(let l=0;l<2;l++)for(let i=0;i<scene.toRender[l].length;i++){let object=scene.toRender[l][i];!0===object.castShadow&&object.determineVisible()&&object.shader.visible&&!object.shader.neverRender&&(!1!==object.frustumCulled&&!0!==_frustum.intersectsObject(object)||(object.shader.shadow||Lighting.initShadowShader(object),object.shader.shadow.draw(object,object.geometry),attachShadowUniforms(object,0,light),object.geometry.draw(object,object.shader),_ubo&&light.shadow.camera._ubo.unbind(),RenderStats.update("ShadowMesh")))}RenderTarget.renderer.unbind(light.shadow.rt)},lights=Lighting.getShadowLights();scene._shadowData||(scene._shadowData={maps:[],emptyMaps:[],size:new Float32Array(lights.length),pos:new Float32Array(3*lights.length),count:lights.length}),scene._shadowData.count!=lights.length&&(scene._shadowData.size=new Float32Array(lights.length),scene._shadowData.pos=new Float32Array(3*lights.length),scene._shadowData.count=lights.length);for(let i=0;i<lights.length;i++){let light=lights[i];light.prepareRender(),scene._shadowData.maps[i]=light.shadow.rt.depth,scene._shadowData.emptyMaps[i]=Utils3D.getEmptyTexture(),scene._shadowData.size[i]=light.shadow.size,light.position.toArray(scene._shadowData.pos,3*i)}for(let i=0;i<lights.length;i++){let light=lights[i];!light.shadow.frozen&&light.determineVisible()&&render(light)}}(scene,camera),rt||!_this.vrRenderingPath||forceToScreen?rt||!_this.arRenderingPath||forceToScreen?render(scene,camera,rt):_this.arRenderingPath(render,scene,camera):_this.vrRenderingPath(scene,camera,_projScreenMatrix,_frustum,attachSceneUniforms),scene.displayNeedsUpdate=!1,Shader.renderer.resetState()},this.renderSingle=function(object,camera,rt){rt?(_resolution.set(rt.width,rt.height),RenderTarget.renderer.bind(rt)):(Renderer.overrideViewport||(_gl.viewport(0,0,_width*_dpr,_height*_dpr),_resolution.set(_canvas.width,_canvas.height)),_this.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))),camera.getWorldPosition(camera.worldPos),object.modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix),object.getWorldPosition(object.worldPos),_ubo&&(camera._ubo||initCameraUBO(camera)),object.shader.draw(object,object.geometry),object.noMatrices||(Shader.renderer.appendUniform(object.shader,"normalMatrix",object.normalMatrix),Shader.renderer.appendUniform(object.shader,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader,"modelViewMatrix",object.modelViewMatrix)),_ubo?camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader,"projectionMatrix",camera.projectionMatrix),Shader.renderer.appendUniform(object.shader,"viewMatrix",camera.matrixWorldInverse),Shader.renderer.appendUniform(object.shader,"cameraPosition",camera.worldPos),Shader.renderer.appendUniform(object.shader,"resolution",_resolution),Shader.renderer.appendUniform(object.shader,"time",_time.value),Shader.renderer.appendUniform(object.shader,"timeScale",Render.timeScaleUniform.value)),object.geometry.draw(object,object.shader),_ubo&&camera._ubo.unbind(),rt&&RenderTarget.renderer.unbind(rt),Shader.renderer.resetState()},this.setClearColor=function(color,alpha=1){_clearColor=new Color(color),Renderer.CLEAR=[_clearColor.r,_clearColor.g,_clearColor.b,alpha]},this.setClearAlpha=function(alpha){Renderer.CLEAR[3]=alpha},this.getClearColor=function(){return _clearColor||(_clearColor=new Color(0,0,0)),_clearColor},this.getClearAlpha=function(){return Renderer.CLEAR[3]},this.setPixelRatio=function(dpr){_dpr=dpr,this.setSize(_width,_height)},this.setSize=function(width,height){_width=width,_height=height,_canvas.width=width*_dpr,_canvas.height=height*_dpr,_canvas.style.width=width+"px",_canvas.style.height=height+"px",_resolution.set(_canvas.width,_canvas.height)},this.getMaxAnisotropy=function(){return Device.graphics.webgl&&_this.extensions.anisotropy?(_anisotropy||(_anisotropy=_gl.getParameter(_this.extensions.anisotropy.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),_anisotropy):0},this.readPixels=function(rt,x=0,y=0,width,height){width||(width=rt?rt.width:1),height||(height=rt?rt.height:1),width=Math.round(width),height=Math.round(height);let w=Math.round(width-x),h=Math.round(height-y),array=new Uint8Array(w*h*4);return _gl.bindFramebuffer(_gl.FRAMEBUFFER,rt?rt._gl:null),_gl.readPixels(x,y,width,height,_gl.RGBA,_gl.UNSIGNED_BYTE,array),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),array},this.blit=function(input,output){return _this.type==Renderer.WEBGL2&&(input._gl||input.upload(),output._gl||output.upload(),_gl.bindFramebuffer(_gl.READ_FRAMEBUFFER,input._gl),_gl.bindFramebuffer(_gl.DRAW_FRAMEBUFFER,output._gl),_gl.blitFramebuffer(0,0,input.width,input.height,0,0,output.width,output.height,_gl.COLOR_BUFFER_BIT,_gl.NEAREST),_gl.bindFramebuffer(_gl.READ_FRAMEBUFFER,null),_gl.bindFramebuffer(_gl.DRAW_FRAMEBUFFER,null),!0)},this.setupStencilMask=function(ref=1){_stencilActive||(_gl.enable(_gl.STENCIL_TEST),_gl.clear(_gl.STENCIL_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT)),_stencilActive=!0,_gl.stencilFunc(_gl.ALWAYS,ref,255),_gl.stencilOp(_gl.KEEP,_gl.KEEP,_gl.REPLACE),_gl.stencilMask(255),_gl.colorMask(!1,!1,!1,!1),_gl.disable(_gl.DEPTH_TEST)},this.setupStencilDraw=function(mode,ref=1){_gl.colorMask(!0,!0,!0,!0),_gl.enable(_gl.DEPTH_TEST),_gl.stencilFunc("inside"==mode?_gl.EQUAL:_gl.NOTEQUAL,ref,255),_gl.stencilOp(_gl.KEEP,_gl.KEEP,_gl.KEEP)},this.clearStencil=function(){_gl.disable(_gl.STENCIL_TEST),_stencilActive=!1},this.clearDepth=function(rt){rt&&!rt._gl&&rt.upload(),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),_gl.clear(_gl.DEPTH_BUFFER_BIT),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},this.clearColor=function(rt){rt&&!rt._gl&&rt.upload(),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),_gl.clear(_gl.COLOR_BUFFER_BIT),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},this.get("resolution",_=>_resolution),this.get("time",_=>_time),this.get("canvas",_=>_canvas)}),_=>{Renderer.WEBGL1="webgl1",Renderer.WEBGL2="webgl2",Renderer.STATIC_SHADOWS="static_shadows",Renderer.SHADOWS_LOW="shadows_low",Renderer.SHADOWS_MED="shadows_med",Renderer.SHADOWS_HIGH="shadows_high",Renderer.ID=0});class CameraBase3D extends Base3D{constructor(){super(),this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4,this.isCamera=!0}copy(source,recursive){return Base3D.prototype.copy.call(this,source,recursive),this.matrixWorldInverse.copy(source.matrixWorldInverse),this.projectionMatrix.copy(source.projectionMatrix),this}updateMatrixWorld(force){Base3D.prototype.updateMatrixWorld.call(this,force),this.matrixWorldInverse.getInverse(this.matrixWorld)}clone(){return(new this.constructor).copy(this)}}class CubeCamera extends Base3D{constructor(near=.1,far=1e3,cubeResolution=512){super();this.px=new PerspectiveCamera(90,1,near,far),this.px.up.set(0,-1,0),this.px.lookAt(new Vector3(1,0,0)),this.add(this.px),this.nx=new PerspectiveCamera(90,1,near,far),this.nx.up.set(0,-1,0),this.nx.lookAt(new Vector3(-1,0,0)),this.add(this.nx),this.py=new PerspectiveCamera(90,1,near,far),this.py.up.set(0,0,1),this.py.lookAt(new Vector3(0,1,0)),this.add(this.py),this.ny=new PerspectiveCamera(90,1,near,far),this.ny.up.set(0,0,-1),this.ny.lookAt(new Vector3(0,-1,0)),this.add(this.ny),this.pz=new PerspectiveCamera(90,1,near,far),this.pz.up.set(0,-1,0),this.pz.lookAt(new Vector3(0,0,1)),this.add(this.pz),this.nz=new PerspectiveCamera(90,1,near,far),this.nz.up.set(0,-1,0),this.nz.lookAt(new Vector3(0,0,-1)),this.add(this.nz),this.rt=new CubeRenderTarget(cubeResolution,cubeResolution)}render(scene=World.SCENE,renderer=World.RENDERER){let rt=this.rt;this.updateMatrixWorld(!0),this.beforeRender&&this.beforeRender(this.px),rt.activeFace=0,renderer.render(scene,this.px,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.nx),rt.activeFace=1,renderer.render(scene,this.nx,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.py),rt.activeFace=2,renderer.render(scene,this.py,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.ny),rt.activeFace=3,renderer.render(scene,this.ny,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.pz),rt.activeFace=4,renderer.render(scene,this.pz,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.nz),rt.activeFace=5,renderer.render(scene,this.nz,rt),this.afterRender&&this.afterRender(rt)}}class OrthographicCamera extends CameraBase3D{constructor(left,right,top,bottom,near,far){super(),this.isOrthographicCamera=!0,this.zoom=1,this.left=left,this.right=right,this.top=top,this.bottom=bottom,this.near=void 0!==near?near:.1,this.far=void 0!==far?far:2e3,this.position.z=1,this.updateProjectionMatrix()}clone(){return(new OrthographicCamera).copy(this)}copy(source,recursive){return CameraBase3D.prototype.copy.call(this,source,recursive),this.left=source.left,this.right=source.right,this.top=source.top,this.bottom=source.bottom,this.near=source.near,this.far=source.far,this.zoom=source.zoom,this.view=null===source.view?null:Object.assign({},source.view),this}updateProjectionMatrix(){let dx=(this.right-this.left)/(2*this.zoom),dy=(this.top-this.bottom)/(2*this.zoom),cx=(this.right+this.left)/2,cy=(this.top+this.bottom)/2,left=cx-dx,right=cx+dx,top=cy+dy,bottom=cy-dy;this.projectionMatrix.makeOrthographic(left,right,top,bottom,this.near,this.far)}setViewport(width,height){this.left=width/-2,this.right=width/2,this.top=height/2,this.bottom=height/-2,this.updateProjectionMatrix()}}class PerspectiveCamera extends CameraBase3D{constructor(fov,aspect,near,far){super(),this.type="PerspectiveCamera",this.fov=fov||50,this.zoom=1,this.near=near||.1,this.far=far||2e3,this.focus=10,this.aspect=aspect||1,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}clone(){return(new PerspectiveCamera).copy(this)}copy(source,recursive){return CameraBase3D.prototype.copy.call(this,source,recursive),this.fov=source.fov,this.zoom=source.zoom,this.near=source.near,this.far=source.far,this.focus=source.focus,this.aspect=source.aspect,this.filmGauge=source.filmGauge,this.filmOffset=source.filmOffset,this}setFocalLength(focalLength){let vExtentSlope=.5*this.getFilmHeight()/focalLength;this.fov=Math.degrees(2*Math.atan(vExtentSlope)),this.updateProjectionMatrix()}getFocalLength(){let vExtentSlope=Math.tan(Math.radians(.5*this.fov));return.5*this.getFilmHeight()/vExtentSlope}getEffectiveFOV(){return Math.degrees(2*Math.atan(Math.tan(Math.radians(.5*this.fov))/this.zoom))}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}updateProjectionMatrix(){let near=this.near,top=near*Math.tan(Math.radians(.5*this.fov))/this.zoom,height=2*top,width=this.aspect*height,left=-.5*width,skew=(this.view,this.filmOffset);0!==skew&&(left+=near*skew/this.getFilmWidth()),this.projectionMatrix.makePerspective(left,left+width,top,top-height,near,this.far)}}class Geometry{constructor(){this.attributes={},this.drawRange={start:0,end:0},this.boundingBox=null,this.boundingSphere=null,this.index=null,this.maxInstancedCount=void 0,this.keepAlive=!1,this.id=Utils.timestamp()}draw(mesh,shader){Geometry.renderer.draw(this,mesh,shader)}upload(mesh,shader){Geometry.renderer.upload(this,mesh,shader)}destroy(mesh){this.keepAlive||Geometry.renderer.destroy(this,mesh)}addAttribute(name,attribute){attribute.meshPerAttribute>=1&&(this.isInstanced=!0,this.maxInstancedCount=attribute.count),this.attributes[name]=attribute}setIndex(attribute){this.index=attribute.array||attribute}toNonIndexed(){let geometry2=new Geometry,indices=this.index,attributes=this.attributes;for(let name in attributes){let attribute=attributes[name],array=attribute.array,itemSize=attribute.itemSize,array2=new array.constructor(indices.length*itemSize),index=0,index2=0;for(let i=0,l=indices.length;i<l;i++){index=indices[i]*itemSize;for(let j=0;j<itemSize;j++)array2[index2++]=array[index++]}geometry2.addAttribute(name,new GeometryAttribute(array2,itemSize))}return geometry2}normalizeNormals(){let vector=this._V1||new Vector3;this._V1=vector;let x,y,z,normals=this.attributes.normal;for(let i=0,il=normals.count;i<il;i++)x=3*i+0,y=3*i+1,z=3*i+2,vector.x=normals.array[x],vector.y=normals.array[y],vector.z=normals.array[z],vector.normalize(),normals.array[x]=vector.x,normals.array[y]=vector.y,normals.array[z]=vector.z}computeFaceNormals(){let cb=new Vector3,ab=new Vector3;for(let f=0,fl=this.faces.length;f<fl;f++){let face=this.faces[f],vA=this.vertices[face.a],vB=this.vertices[face.b],vC=this.vertices[face.c];cb.subVectors(vC,vB),ab.subVectors(vA,vB),cb.cross(ab),cb.normalize(),face.normal.copy(cb)}}computeVertexNormals(){let index=this.index,attributes=this.attributes,groups=this.groups;if(attributes.position){let positions=attributes.position.array;if(void 0===attributes.normal)this.addAttribute("normal",new BufferAttribute(new Float32Array(positions.length),3));else{let array=attributes.normal.array;for(let i=0,il=array.length;i<il;i++)array[i]=0}let vA,vB,vC,normals=attributes.normal.array,pA=new Vector3,pB=new Vector3,pC=new Vector3,cb=new Vector3,ab=new Vector3;if(index){let indices=index.array;0===groups.length&&this.addGroup(0,indices.length);for(let j=0,jl=groups.length;j<jl;++j){let group=groups[j],start=group.start;for(let i=start,il=start+group.count;i<il;i+=3)vA=3*indices[i+0],vB=3*indices[i+1],vC=3*indices[i+2],pA.fromArray(positions,vA),pB.fromArray(positions,vB),pC.fromArray(positions,vC),cb.subVectors(pC,pB),ab.subVectors(pA,pB),cb.cross(ab),normals[vA]+=cb.x,normals[vA+1]+=cb.y,normals[vA+2]+=cb.z,normals[vB]+=cb.x,normals[vB+1]+=cb.y,normals[vB+2]+=cb.z,normals[vC]+=cb.x,normals[vC+1]+=cb.y,normals[vC+2]+=cb.z}}else for(let i=0,il=positions.length;i<il;i+=9)pA.fromArray(positions,i),pB.fromArray(positions,i+3),pC.fromArray(positions,i+6),cb.subVectors(pC,pB),ab.subVectors(pA,pB),cb.cross(ab),normals[i]=cb.x,normals[i+1]=cb.y,normals[i+2]=cb.z,normals[i+3]=cb.x,normals[i+4]=cb.y,normals[i+5]=cb.z,normals[i+6]=cb.x,normals[i+7]=cb.y,normals[i+8]=cb.z;this.normalizeNormals(),attributes.normal.needsUpdate=!0}}computeBoundingBox(){this.boundingBox||(this.boundingBox=new Box3);let position=this.attributes.position;position?this.boundingBox.setFromBufferAttribute(position):this.boundingBox.makeEmpty()}computeBoundingSphere(){let box=new Box3,vector=new Vector3;this.boundingSphere||(this.boundingSphere=new Sphere);let position=this.attributes.position;if(position){let center=this.boundingSphere.center;box.setFromBufferAttribute(position),box.getCenter(center);let maxRadiusSq=0;for(let i=0,il=position.count;i<il;i++)vector.x=position.array[3*i+0],vector.y=position.array[3*i+1],vector.z=position.array[3*i+2],maxRadiusSq=Math.max(maxRadiusSq,center.distanceToSquared(vector));this.boundingSphere.radius=Math.sqrt(maxRadiusSq),isNaN(this.boundingSphere.radius)&&console.error("Bounding Sphere came up NaN, broken position buffer.",this)}}merge(geometry){let Float32ArrayConcat=(first,second)=>{let firstLength=first.length,result=new Float32Array(firstLength+second.length);return result.set(first),result.set(second,firstLength),result},attributes=this.attributes;if(this.index){let indices=geometry.index,offset=attributes.position.count;for(let i=0,il=indices.length;i<il;i++)indices[i]=offset+indices[i];this.index=((first,second)=>{let firstLength=first.length,result=new Uint16Array(firstLength+second.length);return result.set(first),result.set(second,firstLength),result})(this.index,indices)}for(let key in attributes)void 0!==geometry.attributes[key]&&(attributes[key].array=Float32ArrayConcat(attributes[key].array,geometry.attributes[key].array),attributes[key].count=attributes[key].array.length/attributes[key].itemSize);return this}clone(noCopy){return(new Geometry).copy(this,noCopy)}copy(source,noCopy){this.index=null,this.attributes={},this.boundingBox=null,this.boundingSphere=null,this.index=source.index;let attributes=source.attributes;for(let name in attributes)this.addAttribute(name,attributes[name].clone(noCopy));let boundingBox=source.boundingBox;boundingBox&&boundingBox.clone&&(this.boundingBox=boundingBox.clone());let boundingSphere=source.boundingSphere;return boundingSphere&&boundingSphere.clone&&(this.boundingSphere=boundingSphere.clone()),this}center(){let offset=new Vector3;return this.computeBoundingBox(),this.boundingBox.getCenter(offset).negate(),this.applyMatrix((new Matrix4).makeTranslation(offset.x,offset.y,offset.z)),this}applyMatrix(matrix){let position=this.attributes.position;position&&(matrix.applyToBufferAttribute(position),position.needsUpdate=!0);let normal=this.attributes.normal;if(normal){(new Matrix3).getNormalMatrix(matrix).applyToBufferAttribute(normal),normal.needsUpdate=!0}return this.boundingBox&&this.computeBoundingBox(),this.boundingSphere&&this.computeBoundingSphere(),this}scale(x,y,z){this.applyMatrix((new Matrix4).makeScale(x,y,z))}setFromPoints(points){let position=[];for(let i=0,l=points.length;i<l;i++){let point=points[i];position.push(point.x,point.y,point.z||0)}return this.addAttribute("position",new GeometryAttribute(new Float32Array(position),3)),this}instanceFrom(geom){geom.index&&(geom=geom.toNonIndexed());for(let key in geom.attributes)this.addAttribute(key,geom.attributes[key]);return this}uploadBuffersAsync(){return Geometry.renderer.uploadBuffersAsync(this)}toJSON(){let geom=this.index?this.toNonIndexed():this;return JSON.stringify({position:Array.from(geom.attributes.position.array).map(val=>parseFloat(val.toFixed(3))),uv:Array.from(geom.attributes.uv.array).map(val=>parseFloat(val.toFixed(3)))})}}class GeometryAttribute{constructor(_array,_itemSize,_meshPerAttribute){this.array=_array,this.itemSize=_itemSize,this.count=void 0!==_array?_array.length/_itemSize:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.meshPerAttribute=_meshPerAttribute}setArray(array){let newCount=void 0!==array?array.length/this.itemSize:0;newCount!=this.count&&(this.needsNewBuffer=!0),this.array=array,this.count=newCount,this.needsUpdate=!0}clone(noCopy){return noCopy?this:new GeometryAttribute(new Float32Array(this.array),this.itemSize,this.meshPerAttribute)}getX(index){return this.array[index*this.itemSize]}setX(index,x){return this.array[index*this.itemSize]=x,this}getY(index){return this.array[index*this.itemSize+1]}setY(index,y){return this.array[index*this.itemSize+1]=y,this}getZ(index){return this.array[index*this.itemSize+2]}setZ(index,z){return this.array[index*this.itemSize+2]=z,this}getW(index){return this.array[index*this.itemSize+3]}setW(index,w){return this.array[index*this.itemSize+3]=w,this}setXY(index,x,y){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this}setXYZ(index,x,y,z){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this.array[index+2]=z,this}setXYZW(index,x,y,z,w){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this.array[index+2]=z,this.array[index+3]=w,this}}class InterleavedBuffer{constructor(array,stride){this.array=array,this.stride=stride,this.count=array?array.length/stride:0,this.isInterleaved=!0,this.needsUpdate=!1,this.dynamic=!1,this.updateRange={offset:0,count:-1}}}class InterleavedGeometryAttribute{constructor(interleavedBuffer,itemSize,offset){this.data=interleavedBuffer,this.itemSize=itemSize,this.offset=offset,this.isInterleaved=!0}}class Group extends Base3D{constructor(){super(),this.isGroup=!0}}class BaseLight extends Base3D{constructor(color=16777215,intensity=1,distance=9999){super(),this.color=new Color(color),this.data=new Vector4,this.data2=new Vector4,this.data3=new Vector4,this.properties=new Vector4(intensity,distance,0,0)}destroy(){this.shadow&&(Lighting.removeFromShadowGroup(this),this.shadow.destroy())}prepareRender(){this.shadow.camera.position.copy(this.position),this.shadow.camera.lookAt(this.shadow.target)}set castShadow(bool){(this.shadow||bool)&&(this.shadow||(this.shadow=new Shadow(this)),this.shadow.enabled=bool,this.silentShadow||(bool?Lighting.addToShadowGroup(this):Lighting.removeFromShadowGroup(this)))}set intensity(v){this.properties.x=v}get intensity(){return this.properties.x}set distance(v){this.properties.y=v}get distance(){return this.properties.y}set bounce(v){this.properties.z=v}get bounce(){return this.properties.z}}class Line extends Base3D{constructor(geometry,shader){super(),this.geometry=geometry,this.shader=shader,this.isLine=!0,this.id=Renderer.ID++}clone(){return new Line(this.geometry,this.shader).copy(this)}}class Mesh extends Base3D{constructor(geometry,shader){super(),this._geometry=geometry,this._shader=shader&&shader.shader?shader.shader:shader,this.isMesh=!0,this.id=Utils.timestamp(),shader&&(this._shader.mesh=this)}clone(){return new Mesh(this._geometry,this.shader).copy(this)}set geometry(g){Geometry.renderer.resetMeshGeom(this),this._geometry=g}get geometry(){return this._geometry}set shader(shader){this._shader=shader&&shader.shader?shader.shader:shader}get shader(){return this._shader}isInsideOf(mesh){return this.box3||(this.box3=new Box3),this.box3.setFromObject(this),mesh.isMeshInside(this)}isMeshInside(mesh){return this.box3||(this.box3=new Box3),this.box3.setFromObject(this),mesh.box3.intersectsBox(this.box3)}}class Points extends Base3D{constructor(geometry,shader){super(),this._geometry=geometry,this.shader=shader,this.isPoints=!0,this.id=Renderer.ID++,shader&&(this.shader.mesh=this)}clone(){return new Points(this._geometry,this.shader).copy(this)}set geometry(g){Geometry.renderer.resetMeshGeom(this),this._geometry=g}get geometry(){return this._geometry}}class Scene extends Base3D{constructor(){super(),this.autoUpdate=!0,this.toRender=[[],[]],this._displayNeedsUpdate=!0,this.isScene=!0,this.changes=[]}set displayNeedsUpdate(v){!0===v&&this.changes.forEach(cb=>cb()),this._displayNeedsUpdate=v}get displayNeedsUpdate(){return this._displayNeedsUpdate}bindSceneChange(cb){this.changes.push(cb)}}Class((function FBORendererWebGL(_gl){const WEBGL2=Renderer.type==Renderer.WEBGL2,{getFormat:getFormat,getProperty:getProperty,getType:getType,getFloatParams:getFloatParams}=require("GLTypes");function prepareTexture(texture){texture._gl=_gl.createTexture(),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),texture.needsUpdate=!1}function texImageDB(rt,texture){if(texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),getType(texture),null);_gl.bindTexture(_gl.TEXTURE_2D,null)}this.upload=function(rt){if(!rt._gl){if(rt.cube)return function uploadCube(rt){rt._gl=_gl.createFramebuffer(),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl);let texture=rt.texture;texture._gl=_gl.createTexture(),texture.cube=!0,texture.needsUpdate=!1,_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl);for(let i=0;i<6;i++)_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),_gl.UNSIGNED_BYTE,null);_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),rt._depthBuffer=_gl.createRenderbuffer(),_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,rt.width,rt.height),_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,rt._depthBuffer),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}(rt);if(rt._gl=_gl.createFramebuffer(),rt.depth||rt.disableDepth||(rt._depthBuffer=_gl.createRenderbuffer(),_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),_gl.renderbufferStorage(_gl.RENDERBUFFER,Renderer.instance.stencil?_gl.DEPTH_STENCIL:_gl.DEPTH_COMPONENT16,rt.width,rt.height)),RenderCount.add(`fbo_${rt.width}x${rt.height}`,rt),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.multi)if(WEBGL2){let colorAttachments=[];for(let i=0;i<rt.attachments.length;i++){let key="COLOR_ATTACHMENT"+i,texture=rt.attachments[i];colorAttachments.push(_gl[key]),prepareTexture(texture),texImageDB(rt,texture),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl[key],_gl.TEXTURE_2D,texture._gl,0)}_gl.drawBuffers(colorAttachments)}else{let ext=Renderer.extensions.drawBuffers,colorAttachments=[];for(let i=0;i<rt.attachments.length;i++){let key="COLOR_ATTACHMENT"+i+"_WEBGL",texture=rt.attachments[i];colorAttachments.push(ext[key]),prepareTexture(texture),texImageDB(rt,texture),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,ext[key],_gl.TEXTURE_2D,texture._gl,0)}ext.drawBuffersWEBGL(colorAttachments)}else{if(prepareTexture(rt.texture),rt.texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(rt.texture),rt.width,rt.height,0,getFormat(rt.texture),getType(rt.texture),null);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.TEXTURE_2D,rt.texture._gl,0)}if(rt.depth){prepareTexture(rt.depth);let iformat=WEBGL2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT;_gl.texImage2D(_gl.TEXTURE_2D,0,iformat,rt.width,rt.height,0,_gl.DEPTH_COMPONENT,_gl.UNSIGNED_INT,null),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,Renderer.instance.stencil?_gl.DEPTH_STENCIL_ATTACHMENT:_gl.DEPTH_ATTACHMENT,_gl.TEXTURE_2D,rt.depth._gl,0)}else rt.disableDepth||_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,Renderer.instance.stencil?_gl.DEPTH_STENCIL_ATTACHMENT:_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,rt._depthBuffer);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}},this.bind=function(rt){rt._gl||this.upload(rt),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.cube&&_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.TEXTURE_CUBE_MAP_POSITIVE_X+rt.activeFace,rt.texture._gl,0),rt.scissor&&(_gl.enable(_gl.SCISSOR_TEST),_gl.scissor(rt.scissor.x,rt.scissor.y,rt.scissor.width,rt.scissor.height)),_gl.viewport(rt.viewport.x,rt.viewport.y,rt.width,rt.height),Renderer.instance.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))},this.unbind=function(rt){rt.scissor&&_gl.disable(_gl.SCISSOR_TEST),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},this.resize=function(rt){if(rt.texture._gl&&rt._gl){if(_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.multi)for(let i=0;i<rt.attachments.length;i++){let texture=rt.attachments[i];if(_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),getType(texture),null)}else if(_gl.bindTexture(_gl.TEXTURE_2D,rt.texture._gl),rt.texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(rt.texture),rt.width,rt.height,0,getFormat(rt.texture),getType(rt.texture),null);if(rt.depth){_gl.bindTexture(_gl.TEXTURE_2D,rt.depth._gl);let iformat=WEBGL2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT;_gl.texImage2D(_gl.TEXTURE_2D,0,iformat,rt.width,rt.height,0,_gl.DEPTH_COMPONENT,_gl.UNSIGNED_INT,null),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,Renderer.instance.stencil?_gl.DEPTH_STENCIL_ATTACHMENT:_gl.DEPTH_ATTACHMENT,_gl.TEXTURE_2D,rt.depth._gl,0)}else rt.disableDepth||(_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),_gl.renderbufferStorage(_gl.RENDERBUFFER,Renderer.instance.stencil?_gl.DEPTH_STENCIL:_gl.DEPTH_COMPONENT16,rt.width,rt.height));_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}},this.destroy=function(rt){_gl.deleteFramebuffer(rt._gl),rt._depthBuffer&&_gl.deleteRenderbuffer(rt._depthBuffer),Texture.renderer.destroy(rt.texture),RenderCount.remove(`fbo_${rt.width}x${rt.height}`),rt.multi&&rt.attachments.forEach(t=>Texture.renderer.destroy(t)),rt._gl=null}})),Class((function GeometryRendererWebGL(_gl){var _cache={};const WEBGL2=Renderer.type==Renderer.WEBGL2;function updateBuffer(attrib){if(!attrib._gl)return;attrib.needsUpdate=!1,_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),RenderStats.update("BufferUpdates");let array=attrib.array,updateRange=attrib.updateRange;if(-1===updateRange.count)attrib.needsNewBuffer?(_gl.bufferData(_gl.ARRAY_BUFFER,attrib.array,_gl.DYNAMIC_DRAW),attrib.needsNewBuffer=!1):_gl.bufferSubData(_gl.ARRAY_BUFFER,0,array);else if(Array.isArray(updateRange)){for(let i=updateRange.length-1;i>-1;i--){let{offset:offset,count:count}=updateRange[i];_gl.bufferSubData(_gl.ARRAY_BUFFER,offset*array.BYTES_PER_ELEMENT,array.subarray(offset,offset+count))}updateRange.length=0}else _gl.bufferSubData(_gl.ARRAY_BUFFER,updateRange.offset*array.BYTES_PER_ELEMENT,array.subarray(updateRange.offset,updateRange.offset+updateRange.count));_gl.bindBuffer(_gl.ARRAY_BUFFER,null)}this.draw=function(geom,mesh,shader){geom._gl&&!geom.needsUpdate&&mesh._gl&&mesh._gl.geomInit||this.upload(geom,mesh,shader),RenderStats.active&&RenderStats.update("DrawCalls",1,shader.vsName+"|"+shader.fsName,mesh);for(let key in geom.attributes){let attrib=geom.attributes[key];mesh._gl.program!=shader._gl.program?(mesh._gl[key]=_gl.getAttribLocation(shader._gl.program,key),mesh._gl.program=shader._gl.program):void 0===mesh._gl[key]&&(mesh._gl[key]=_gl.getAttribLocation(shader._gl.program,key)),-1!==mesh._gl[key]&&(attrib.isInterleaved&&attrib.data.needsUpdate?updateBuffer(attrib.data):(attrib.needsUpdate||attrib.dynamic)&&updateBuffer(attrib))}if(geom.indexNeedsUpdate){if(_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),geom.indexUpdateRange){let updateRange=geom.indexUpdateRange;_gl.bufferSubData(_gl.ELEMENT_ARRAY_BUFFER,updateRange.offset*geom.index.BYTES_PER_ELEMENT,geom.index.subarray(updateRange.offset,updateRange.offset+updateRange.count))}else _gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,geom.index,_gl.STATIC_DRAW);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,null),geom.indexNeedsUpdate=!1}mesh._gl.vao.bind();let mode=mesh._gl.mode;mode||(mesh._gl.mode=mode=function getMode(mesh,shader){return mesh.isPoints?_gl.POINTS:mesh.isLine?_gl.LINE_STRIP:shader.wireframe?_gl.LINES:_gl.TRIANGLES}(mesh,shader));let drawStart=geom.drawRange.start||0,drawEnd=geom.drawRange.end||geom.attributes.position.count;if(geom.isInstanced){let maxInstancedCount=mesh.maxInstancedCount?Math.min(mesh.maxInstancedCount,geom.maxInstancedCount):geom.maxInstancedCount;WEBGL2?geom.index?_gl.drawElementsInstanced(mode,geom.index.length,_gl.UNSIGNED_SHORT,0,maxInstancedCount):_gl.drawArraysInstanced(mode,drawStart,drawEnd,maxInstancedCount):geom.index?Renderer.extensions.instancedArrays.drawElementsInstancedANGLE(mode,geom.index.length,_gl.UNSIGNED_SHORT,0,maxInstancedCount):Renderer.extensions.instancedArrays.drawArraysInstancedANGLE(mode,drawStart,drawEnd,maxInstancedCount)}else geom.index?_gl.drawElements(mode,geom.index.length,_gl.UNSIGNED_SHORT,0):_gl.drawArrays(mode,drawStart,drawEnd);mesh._gl.vao.unbind()},this.upload=function(geom,mesh,shader){if(!mesh)return;geom._gl||(geom._gl={id:Utils.timestamp()}),mesh._gl||(mesh._gl={}),mesh._gl.geomInit=!0,geom.uploaded=!0;const KEY=`${geom._gl.id}_${shader._gl._id}`;let cached=_cache[KEY];if(cached)return cached.count++,mesh._gl.vao=cached.vao,void(mesh._gl.lookup=KEY);RenderCount.add("geometry"),mesh._gl.vao&&mesh._gl.vao.destroy(),mesh._gl.vao=new VAO(_gl),geom.distributeBufferData||RenderCount.add("geom_upload",geom);for(let key in geom.attributes){let attrib=geom.attributes[key],location=mesh._gl[key]||_gl.getAttribLocation(shader._gl.program,key);if(mesh._gl[key]=location,attrib._gl)continue;attrib._gl={};let{array:array,dynamic:dynamic}=attrib;attrib.isInterleaved&&(attrib.data._gl||(attrib.data._gl=attrib._gl),attrib._gl=attrib.data._gl,array=attrib.data.array,dynamic=attrib.data.dynamic),attrib._gl.buffer||(attrib._gl.buffer=_gl.createBuffer(),attrib._gl.bufferUploaded=!geom.distributeBufferData,_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.bufferData(_gl.ARRAY_BUFFER,geom.distributeBufferData?array.length*array.BYTES_PER_ELEMENT:array,dynamic?_gl.DYNAMIC_DRAW:_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ARRAY_BUFFER,null)),attrib.needsUpdate=!1}geom.index&&(geom._gl.index||(geom._gl.index=_gl.createBuffer(),_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,geom.index,_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,null))),mesh._gl.vao.bind();for(let key in geom.attributes){let attrib=geom.attributes[key],location=mesh._gl[key];if(-1==location)continue;let stride=0,offset=0;if(attrib.isInterleaved){let bytes=attrib.data.array.BYTES_PER_ELEMENT;stride=attrib.data.stride*bytes,offset=attrib.offset*bytes}_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.vertexAttribPointer(location,attrib.itemSize,_gl.FLOAT,!1,stride,offset),_gl.enableVertexAttribArray(location),geom.isInstanced&&(WEBGL2?_gl.vertexAttribDivisor(location,attrib.meshPerAttribute):Renderer.extensions.instancedArrays.vertexAttribDivisorANGLE(location,attrib.meshPerAttribute))}geom.index&&_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),mesh._gl.vao.unbind(),_cache[KEY]={count:1,vao:mesh._gl.vao}},this.destroy=function(geom,mesh){for(let key in geom.attributes){let attrib=geom.attributes[key];attrib._gl&&(_gl.deleteBuffer(attrib._gl.buffer),attrib._gl=null)}if(mesh&&mesh._gl&&mesh._gl.vao){let cache=_cache[mesh._gl.lookup];cache?(cache.count--,0==cache.count&&(cache.vao.destroy(),delete _cache[mesh._gl.lookup])):mesh._gl.vao.destroy(),delete mesh._gl.vao}delete geom._gl},this.resetMeshGeom=function(mesh){mesh._gl&&(mesh._gl.geomInit=!1)},this.uploadBuffersAsync=async function(geom){if(geom._gl&&geom._gl.uploadedAsync)return;let upload=attrib=>{let array=attrib.array,buffer=attrib._gl.buffer,promise=Promise.create(),amt=4,match=!1;for(;!match;)amt--,array.length%amt==0&&(match=!0);let chunk=array.length/amt,i=0,worker=new Render.Worker((function uploadBuffersAsync(){let offset=i*chunk,subarray=array.subarray(offset,offset+chunk);if(!attrib._gl)return worker.stop(),promise.resolve();subarray.length&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,buffer),_gl.bufferSubData(_gl.ARRAY_BUFFER,offset*array.BYTES_PER_ELEMENT,subarray),_gl.bindBuffer(_gl.ARRAY_BUFFER,null)),++i==amt&&(promise.resolve(),worker.stop())}));return promise},uploaded=!1;for(let key in geom.attributes){let attrib=geom.attributes[key];if(!attrib._gl){geom.distributeBufferData=!0;let{array:array,dynamic:dynamic}=attrib;attrib._gl={},attrib.isInterleaved&&(attrib.data._gl||(attrib.data._gl=attrib._gl),attrib._gl=attrib.data._gl,array=attrib.data.array,dynamic=attrib.data.dynamic),attrib._gl.buffer||(attrib._gl.buffer=_gl.createBuffer(),attrib._gl.bufferUploaded=!geom.distributeBufferData,attrib.array.length&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.bufferData(_gl.ARRAY_BUFFER,array.length*array.BYTES_PER_ELEMENT,dynamic?_gl.DYNAMIC_DRAW:_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ARRAY_BUFFER,null))),attrib.needsUpdate=!1,geom.needsUpdate=!0}attrib._gl.bufferUploaded||(attrib._gl.bufferUploaded=!0,uploaded=!0,await upload(attrib),attrib.needsUpdate=!1)}geom._gl.uploadedAsync=!0,uploaded&&RenderCount.add("geom_uploadAsync",geom)}})),Class((function ShaderRendererWebGL(_gl){var _pool={},_programID=0,_cached={},_uboCache={};const WEBGL2=Renderer.type==Renderer.WEBGL2,GLOBAL_UNIFORMS=["normalMatrix","modelMatrix","modelViewMatrix","projectionMatrix","viewMatrix","cameraPosition","resolution","time","shadowMatrix","shadowLightPos","shadowSize"];function toTypedArray(uni){uni.value;return uni._gl||(uni._gl={}),uni._gl.array&&uni._gl.array.length==uni.value.length?uni._gl.array.set(uni.value):uni._gl.array=new Float32Array(uni.value),uni._gl.array}function createShader(str,type){let shader=_gl.createShader(type);if(_gl.shaderSource(shader,str),_gl.compileShader(shader),Hydra.LOCAL&&!_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)){let error=_gl.getShaderInfoLog(shader);_gl.deleteShader(shader);let split=str.split("\n"),errorString="";split.forEach((line,index)=>{index=function(){switch(index.toString().length){case 1:return"00"+index;case 2:return"0"+index}return index}(),errorString+=`${index}: ${line}\n`}),console.warn(error,errorString)}return shader}function setupShaders(shader){for(let key in shader.uniforms){let uniform=shader.uniforms[key];if(void 0===shader._gl[key]&&uniform)if(uniform.ubo)if(WEBGL2){if(_uboCache[shader.UILPrefix]&&!shader.ubo&&(shader.ubo=_uboCache[shader.UILPrefix]),_uboCache[shader.UILPrefix]){shader._gl[key]="U";continue}shader.ubo||(shader.ubo=new UBO(1,_gl)),shader.ubo.push(uniform),shader._gl[key]="U"}else shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key);else WEBGL2&&uniform.lightUBO?(shader._gl[key]="U",shader.uboLight=!0):shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key)}shader.ubo&&!_uboCache[shader.UILPrefix]&&(_uboCache[shader.UILPrefix]=shader.ubo),shader._gl.setupGlobals||(shader._gl.setupGlobals=!0,GLOBAL_UNIFORMS.forEach(key=>{shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key)})),shader.uboLight&&_gl.getUniformBlockIndex(shader._gl.program,"lights"),WEBGL2&&_gl.getUniformBlockIndex(shader._gl.program,"global")}function uniformTextureArray(uni,uLoc,shader){let array=shader._gl.texArray||[];array.length=0,shader._gl.texArray=array;for(let i=0;i<uni.value.length;i++){array.push(shader._gl.texIndex);let texture=uni.value[i];!1===texture.loaded&&(texture=Utils3D.getEmptyTexture()),(void 0===texture._gl||texture.needsReupload)&&Texture.renderer.upload(texture),_gl.activeTexture(_gl["TEXTURE"+shader._gl.texIndex++]),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl)}_gl.uniform1iv(uLoc,array)}this.upload=function(shader){if(!shader._gl){shader._gl={};let key=`${shader.vsName}_${shader.fsName}_${shader.customCompile}`,cached=_pool[key];cached?(shader._gl.program=cached.program,shader._gl._id=cached.id,cached.count++):(shader._gl.program=function createProgram(shader){let vsCode=shader.onBeforeCompile(shader.vertexShader,"vs"),fsCode=shader.onBeforeCompile(shader.fragmentShader,"fs");RenderCount.add("shader",shader);let vs=createShader(vsCode,_gl.VERTEX_SHADER),fs=createShader(fsCode,_gl.FRAGMENT_SHADER);Hydra.LOCAL&&window.GLSLLinter&&GLSLLinter.lint(shader,vsCode,fsCode);let program=_gl.createProgram();return _gl.attachShader(program,vs),_gl.attachShader(program,fs),_gl.linkProgram(program),Hydra.LOCAL&&(_gl.getProgramParameter(program,_gl.LINK_STATUS)||(console.warn(`Shader: ${shader.vsName} | ${shader.vsName}`),console.warn(vsCode),console.warn(fsCode),console.error(`Could not compile WebGL program. ${shader.vsName} ${shader.fsName} \n\n`+_gl.getProgramInfoLog(program)))),_gl.deleteShader(vs),_gl.deleteShader(fs),program}(shader),shader._gl._id=_programID++,_pool[key]={count:1,program:shader._gl.program,id:shader._gl._id})}setupShaders(shader),shader.ubo&&shader.ubo.upload(),shader.vertexShader=shader.fragmentShader=""},this.findCachedProgram=function(shader){let key=`${shader.vsName}_${shader.fsName}_${shader.customCompile}`,cached=_pool[key];return!!cached&&(shader._gl={},shader._gl.program=cached.program,shader._gl._id=cached.id,_uboCache[shader.UILPrefix]&&(shader.ubo=shader.UILPrefix),cached.count++,!0)},this.draw=function(shader){void 0===shader._gl&&this.upload(shader),shader._gl.texIndex=0,shader._gl.program!=_cached.program&&(_gl.useProgram(shader._gl.program),_cached.program=shader._gl.program),shader.ubo&&shader.ubo.bind(shader._gl.program,"ubo"),shader.uboLight&&Lighting.bindUBO(shader._gl.program);for(let key in shader.uniforms){let uni=shader.uniforms[key];void 0===shader._gl[key]&&setupShaders(shader);let uLoc=shader._gl[key];if(uni&&(null===uni.value&&(uni.value=Utils3D.getEmptyTexture()),null!==uLoc&&-1!==uLoc&&"U"!==uLoc)){if(void 0===uni.value)throw`Uniform ${key} value is undefined. | ${shader.vsName} ${shader.fsName}`;switch(uni.type||(uni.type="string"==typeof(uniform=uni).type?uniform.type:null===uniform.value||uniform.value instanceof Texture||uniform.value.texture||uniform.value.rt&&uniform.value.rt.texture?"t":uniform.value instanceof Vector2?"v2":uniform.value instanceof Vector3||uniform.value instanceof Vector3D?"v3":uniform.value instanceof Vector4?"v4":uniform.value instanceof Matrix4?"m4":uniform.value instanceof Matrix3?"m3":uniform.value instanceof Color?"c":uniform.value instanceof Quaternion?"q":Array.isArray(uniform.value)&&uniform.value[0]instanceof Texture?"tv":"f"),uni.type){case"f":_gl.uniform1f(uLoc,uni.value);break;case"v2":_gl.uniform2f(uLoc,uni.value.x,uni.value.y);break;case"v3":_gl.uniform3f(uLoc,uni.value.x,uni.value.y,uni.value.z);break;case"c":_gl.uniform3f(uLoc,uni.value.r,uni.value.g,uni.value.b);break;case"q":case"v4":_gl.uniform4f(uLoc,uni.value.x,uni.value.y,uni.value.z,uni.value.w);break;case"v3v":_gl.uniform3fv(uLoc,toTypedArray(uni));break;case"v4v":_gl.uniform4fv(uLoc,toTypedArray(uni));break;case"v2v":_gl.uniform2fv(uLoc,toTypedArray(uni));break;case"fv":_gl.uniform1fv(uLoc,toTypedArray(uni));break;case"m4":_gl.uniformMatrix4fv(uLoc,!1,uni.value.elements);break;case"m3":_gl.uniformMatrix3fv(uLoc,!1,uni.value.elements);break;case"tv":uniformTextureArray(uni,uLoc,shader);break;case"t":let texture=uni.value;texture.isTexture||(uni.value.rt&&(texture=uni.value.rt.overrideTexture||uni.value.rt.texture),uni.value.texture&&(texture=uni.value.texture)),!1===texture.loaded&&(texture=Utils3D.getEmptyTexture());let texIndex=shader._gl.texIndex++;uni.value.vrRT&&(shader._gl.vrRT=!0,uni.value._glTexIndex=texIndex),Texture.renderer.draw(texture,uLoc,key,texIndex)}}}var uniform;if(shader.polygonOffset){let key=shader.polygonOffsetFactor+"_"+shader.polygonOffsetUnits;_cached.polygonOffset!=key&&(_gl.enable(_gl.POLYGON_OFFSET_FILL),_gl.polygonOffset(shader.polygonOffsetFactor,shader.polygonOffsetUnits)),_cached.polygonOffset=key}else _cached.polygonOffset&&_gl.disable(_gl.POLYGON_OFFSET_FILL),_cached.polygonOffset=!1;if(shader.transparent?(_cached.transparent||_gl.enable(_gl.BLEND),_cached.transparent=!0):(_cached.transparent&&_gl.disable(_gl.BLEND),_cached.transparent=!1),_cached.blending!=shader.blending){switch(shader.blending){case Shader.ADDITIVE_BLENDING:_gl.blendEquation(_gl.FUNC_ADD),_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE);break;default:_gl.blendEquationSeparate(_gl.FUNC_ADD,_gl.FUNC_ADD),_gl.blendFuncSeparate(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA,_gl.ONE,_gl.ONE_MINUS_SRC_ALPHA)}_cached.blending=shader.blending}switch(shader.depthTest?(_cached.depthTest||_gl.enable(_gl.DEPTH_TEST),_cached.depthTest=!0):(_cached.depthTest&&_gl.disable(_gl.DEPTH_TEST),_cached.depthTest=!1),shader.side){case Shader.BACK_SIDE:_cached.side!=Shader.BACK_SIDE&&(_gl.enable(_gl.CULL_FACE),_gl.cullFace(_gl.FRONT),_cached.side=Shader.BACK_SIDE);break;case Shader.DOUBLE_SIDE:_cached.side!=Shader.DOUBLE_SIDE&&(_gl.disable(_gl.CULL_FACE),_cached.side=Shader.DOUBLE_SIDE);break;default:_cached.side!=Shader.FRONT_SIDE&&(_gl.enable(_gl.CULL_FACE),_gl.cullFace(_gl.BACK),_cached.side=Shader.FRONT_SIDE)}switch(_cached.depthMask!=shader.depthWrite&&(_gl.depthMask(!!shader.depthWrite),_cached.depthMask=shader.depthWrite),shader.colorMask){case Shader.COLOR_MASK_NONE:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!0,!0,!0,!0),_cached.colorMask=shader.colorMask);break;case Shader.COLOR_MASK_RGB:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!1,!1,!1,!0),_cached.colorMask=shader.colorMask);break;case Shader.COLOR_MASK_RGBA:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!1,!1,!1,!1),_cached.colorMask=shader.colorMask)}},this.destroy=function(shader){delete shader._gl,shader.ubo&&shader.ubo.destroy()},this.appendUniform=function(shader,key,value,hint){let loc=shader._gl[key];if(void 0===loc&&(loc=loc=_gl.getUniformLocation(shader._gl.program,key)),null!==loc)if(value.isMatrix4)_gl.uniformMatrix4fv(loc,!1,value.elements);else if(value.isMatrix3)_gl.uniformMatrix3fv(loc,!1,value.elements);else if(value.isVector3)_gl.uniform3f(loc,value.x,value.y,value.z);else if(value.isVector2)_gl.uniform2f(loc,value.x,value.y);else if(value instanceof Float32Array)switch(hint){case"matrix":_gl.uniformMatrix4fv(loc,!1,value);break;case"float":_gl.uniform1fv(loc,value);break;case"vec3":_gl.uniform3fv(loc,value)}else if(Array.isArray(value)){let array=shader._gl.texArray||[];array.length=0,shader._gl.texArray=array;for(let i=0;i<value.length;i++)array.push(shader._gl.texIndex),_gl.activeTexture(_gl["TEXTURE"+shader._gl.texIndex++]),_gl.bindTexture(_gl.TEXTURE_2D,value[i]._gl);_gl.uniform1iv(loc,array)}else _gl.uniform1f(loc,value)},this.resetState=function(){_cached.depthMask||(_gl.depthMask(!0),_cached.depthMask=!0),_cached.depthTest||_gl.enable(_gl.DEPTH_TEST),_cached.depthTest=!0,_cached.colorMask!=Shader.COLOR_MASK_NONE&&(_gl.colorMask(!0,!0,!0,!0),_cached.colorMask=Shader.COLOR_MASK_NONE),_cached.program=null},this.clearState=function(){_cached={}}})),Class((function TextureRendererWebGL(_gl){const _this=this;var _state={};const DATA=new Uint8Array([0,0,0,0]),{getFormat:getFormat,getProperty:getProperty,getType:getType,getFloatParams:getFloatParams}=require("GLTypes");function setTextureParams(texture,textureType=_gl.TEXTURE_2D){let format=getFormat(texture);textureType!=_gl.TEXTURE_2D||texture.compressed||_gl.texImage2D(textureType,0,format,1,1,0,format,_gl.UNSIGNED_BYTE,DATA),_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(textureType,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(textureType,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),texture.data||texture.format!=Texture.RGBAFormat?1==_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):!1===texture.premultiplyAlpha?(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),_state.premultiply=!0),texture.anisotropy>1&&_gl.texParameterf(_gl.TEXTURE_2D,Renderer.extensions.anisotropy.TEXTURE_MAX_ANISOTROPY_EXT,texture.anisotropy)}this.draw=function(texture,loc,key,id){if((void 0===texture._gl||texture.needsReupload)&&this.upload(texture),_gl.activeTexture(_gl["TEXTURE"+id]),texture.cube)_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl);else{let texType=texture.EXT_OES?_gl.TEXTURE_EXTERNAL_OES:_gl.TEXTURE_2D;_gl.bindTexture(texType,texture._gl)}_gl.uniform1i(loc,id),(texture.dynamic||texture.needsUpdate)&&function updateDynamic(texture){if(texture.isDataTexture){if(!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1),!texture.glFormat){let{format:format,type:type}=getFloatParams(texture);texture.glFormat=format,texture.glType=type}_gl.texSubImage2D(_gl.TEXTURE_2D,0,0,0,texture.width,texture.height,texture.glFormat,texture.glType,texture.data)}else _state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0),texture.format==Texture.RGBAFormat?!1===texture.premultiplyAlpha?(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),_state.premultiply=!0):_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1),texture.glFormat||(texture.glFormat=getFormat(texture)),_gl.texImage2D(_gl.TEXTURE_2D,0,texture.glFormat,texture.glFormat,getType(texture),texture.image)}(texture),texture.needsUpdate=!1},this.upload=function(texture){if(texture._gl&&!texture.needsReupload&&!texture.needsUpdate)return;let format=getFormat(texture);if(RenderCount.add("texture"),texture.distributeTextureData||RenderCount.add("tex_upload",texture),texture.cube){if(6!=texture.cube.length)throw"Cube texture requires 6 images";return function uploadCube(texture){void 0===texture._gl&&(texture._gl=_gl.createTexture(),_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl),_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0),setTextureParams(texture,_gl.TEXTURE_CUBE_MAP));let format=getFormat(texture);for(let i=0;i<6;i++)_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,format,format,getType(texture),texture.cube[i]);_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP),texture.needsUpdate=texture.needsReupload=!1,texture.onUpdate&&texture.onUpdate()}(texture)}let texType=texture.EXT_OES?_gl.TEXTURE_EXTERNAL_OES:_gl.TEXTURE_2D;if(void 0===texture._gl?(texture._gl=_gl.createTexture(),_gl.bindTexture(texType,texture._gl),setTextureParams(texture,texType)):_gl.bindTexture(texType,texture._gl),texture.isDataTexture||texture.type&&texture.type.includes("float")){!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_gl.pixelStorei(_gl.UNPACK_ALIGNMENT,1);let{internalformat:internalformat,format:format,type:type}=getFloatParams(texture);if("ie"===Device.system.browser)try{_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,texture.width,texture.height,0,format,type,texture.distributeTextureData?null:texture.data)}catch(e){console.log(e)}else _gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,texture.width,texture.height,0,format,type,texture.distributeTextureData?null:texture.data)}else if(_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0),texture.image&&texture.compressed){let data=texture.image.compressedData;for(let i=0;i<data.length;i++){let size=texture.image.sizes[i];_gl.compressedTexImage2D(_gl.TEXTURE_2D,i,texture.image.gliFormat,size,size,0,data[i])}data.length=0}else if(texture.image&&!(texture.image instanceof HTMLVideoElement))try{_gl.texImage2D(_gl.TEXTURE_2D,0,format,format,getType(texture),texture.image)}catch(e){console.log("error loading texture",e,texture.image)}(texture.image||texture.data)&&texture.generateMipmaps&&!texture.compressed&&_gl.generateMipmap(_gl.TEXTURE_2D),texture.needsUpdate=texture.needsReupload=!1,texture.onUpdate&&texture.onUpdate()},this.uploadAsync=function(texture){let{format:format,type:type}=getFloatParams(texture);if(texture._uploadAsyncPromise)return texture._uploadAsyncPromise;texture._uploadAsyncPromise=Promise.create(),RenderCount.add("tex_uploadAsync",texture),texture._gl||(texture.distributeTextureData=!0,_this.upload(texture));let pixelsPerChunk=texture.height/4,dataPerChunk=texture.data.length/4,i=0,worker=new Render.Worker((function workerUploadAsync(){let pixelOffset=pixelsPerChunk*i,dataOffset=dataPerChunk*i,subarray=texture.data.subarray(dataOffset,dataOffset+dataPerChunk);!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),_gl.texSubImage2D(_gl.TEXTURE_2D,0,0,pixelOffset,texture.width,pixelsPerChunk,format,type,subarray),_gl.bindTexture(_gl.TEXTURE_2D,null),4==++i&&(worker.stop(),texture._uploadAsyncPromise.resolve())}));return texture._uploadAsyncPromise},this.destroy=function(texture){texture._gl&&(_gl.deleteTexture(texture._gl),RenderCount.remove("texture"),RenderCount.add("tex_destroy",texture)),delete texture._gl}}));class RenderTarget{constructor(width,height,options={}){this.width=width,this.height=height,this.viewport=new Vector2(0,0),void 0===options.minFilter&&(options.minFilter=Texture.LINEAR),this.texture=new Texture(null),this.texture.generateMipmaps=options.generateMipmaps,this.texture.width=width,this.texture.height=height,this.texture.minFilter=options.minFilter||Texture.LINEAR,this.texture.magFilter=options.magFilter||Texture.LINEAR,this.texture.wrapS=options.wrapS||Texture.CLAMP_TO_EDGE,this.texture.wrapT=options.wrapT||Texture.CLAMP_TO_EDGE,this.texture.format=options.format||Texture.RGBFormat,options.type&&(this.texture.type=options.type),this.isRT=!0}setSize(width,height){this.width=width,this.height=height,this.texture.width=width,this.texture.height=height,this.viewport.set(0,0),RenderTarget.renderer.resize(this)}clone(){return(new RenderTarget).copy(this)}copy(source){return this.width=source.width,this.height=source.height,this.viewport.copy(source.viewport),this.texture=source.texture.clone(),this}createDepthTexture(){return this.depth=new Texture(null),this.depth.generateMipmaps=!1,this.depth.minFilter=Texture.NEAREST,this.depth.magFilter=Texture.NEAREST,this.depth.wrapS=Texture.CLAMP_TO_EDGE,this.depth.wrapT=Texture.CLAMP_TO_EDGE,this.depth}destroy(){RenderTarget.renderer.destroy(this)}upload(){this._gl||RenderTarget.renderer.upload(this)}}class MultiRenderTarget extends RenderTarget{constructor(width,height,options={}){super(width,height,options),this.multi=!0,this.attachments=[this.texture]}}class CubeRenderTarget extends RenderTarget{constructor(width,height,options={}){super(width,height,options),this.activeFace=0,this.cube=!0}}Class((function Shader(_vertexShader,_fragmentShader,_params,_onBeforeBuild,_postfix){const _this=this;this.uniforms={},this.side=Shader.FRONT_SIDE,this.blending=Shader.NORMAL_BLENDING,this.colorMask=Shader.COLOR_MASK_NONE,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=1,this.depthTest=!0,this.depthWrite=!0,this.wireframe=!1,this.transparent=!1,this.visible=!0,this.persists=!1,this.precision="high",this.customCompile="","string"!=typeof _fragmentShader&&(_params=_fragmentShader,_fragmentShader=_vertexShader),_params=_params||{},_this.vsParam=_vertexShader,_this.fsParam=_fragmentShader,_this.params=_params,_this.vsName=_vertexShader,_this.fsName=(_fragmentShader||_vertexShader)+(_postfix||""),_params.vsName&&(_this.vsName=_params.vsName,delete _params.vsName),_params.precision&&(_this.precision=_params.precision),_params.receiveShadow&&(_this.receiveLight=!0,World.RENDERER.shadows&&(_this.precision="high"));let vs=_vertexShader,fs=_fragmentShader;_params.uilFrom&&(vs=_params.uilFrom,fs=_params.uilFrom,delete _params.uilFrom),_this.UILPrefix=_params.UILPrefix||`${vs}/${fs}/${_params.unique?_params.unique+"/":""}`,Shader.parseParams(_params,_this),Shader.renderer.findCachedProgram(_this)||(_this.vertexShader=Shader.process(Shaders.getShader(_vertexShader+".vs"),"vs",_this,_onBeforeBuild),_this.fragmentShader=Shader.process(Shaders.getShader(_fragmentShader+".fs"),"fs",_this,_onBeforeBuild))}),_=>{Shader.FRONT_SIDE="shader_front_side",Shader.BACK_SIDE="shader_back_side",Shader.DOUBLE_SIDE="shader_double_side",Shader.ADDITIVE_BLENDING="shader_additive_blending",Shader.NORMAL_BLENDING="shader_normal_blending",Shader.CUSTOM_DEPTH="shader_custom_depth",Shader.COLOR_MASK_RGB="shader_colormask_rgb",Shader.COLOR_MASK_RGBA="shader_colormask_rgba",Shader.COLOR_MASK_NONE="shader_colormask_none",Shader.parseParams=function(_params,_this){for(let key in _params)if("receiveShadow"==key)_this.receiveShadow=_params[key];else if("receiveLight"==key)_this.receiveLight=_params[key];else if(_params[key]&&void 0!==_params[key].value)window.UILStorage?(_this.uniforms[key]=UILStorage.parse(_this.UILPrefix+key,_params[key].value)||_params[key],_params[key].ubo&&(_this.uniforms[key].ubo=!0)):_this.uniforms[key]=_params[key];else{if("unique"==key)continue;_this[key]=_params[key]}},Shader.process=function(code,type,_this,_onBeforeBuild){const WEBGL2=Renderer.type==Renderer.WEBGL2;if(!code)throw"No shader found! "+_this.vsName+" | "+_this.fsName;const externalOES=code.includes("samplerExternalOES")&&window.AURA&&"android"==Device.system.os,standardDeriv=!WEBGL2&&code.includes(["fwidth","dFdx"]),drawBuffers=!WEBGL2&&code.includes(["gl_FragData","#drawbuffer"])&&window.World&&World.NUKE.useDrawBuffers;return header="vs"==type?["#version 300 es",externalOES?"#extension GL_OES_EGL_image_external_essl3 : require":"",`precision ${_this.precision}p float;`,`precision ${_this.precision}p int;`,"attribute vec2 uv;","attribute vec3 position;","attribute vec3 normal;","uniform mat3 normalMatrix;","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform global {","mat4 projectionMatrix;","mat4 viewMatrix;","vec3 cameraPosition;","vec2 resolution;","float time;","float timeScale;","};"].join("\n"):["#version 300 es",externalOES?"#extension GL_OES_EGL_image_external_essl3 : require":"",standardDeriv?"#extension GL_OES_standard_derivatives : enable":"",drawBuffers?"#extension GL_EXT_draw_buffers : require":"",`precision ${_this.precision}p float;`,`precision ${_this.precision}p int;`,"uniform mat3 normalMatrix;","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform global {","mat4 projectionMatrix;","mat4 viewMatrix;","vec3 cameraPosition;","vec2 resolution;","float time;","float timeScale;","};","out vec4 FragColor;"].join("\n"),header+="\n__ACTIVE_THEORY_LIGHTS__\n\n",window.AURA&&(header+="#define AURA\n"),_onBeforeBuild&&(code=_onBeforeBuild(code,type)),code=header+code};const prototype=Shader.prototype;var _emptyShadowMap;prototype.copyUniformsTo=function(shader,linked){if(linked)shader.uniforms=this.uniforms;else for(let key in this.uniforms)shader.uniforms[key]={type:this.uniforms[key].type,value:this.uniforms[key].value}},prototype.addUniforms=function(uniforms){uniforms.UILPrefix&&(this.UILPrefix=uniforms.UILPrefix,delete uniforms.UILPrefix);for(let key in uniforms)this.uniforms[key]=uniforms[key]},prototype.draw=function(mesh,geom){this.receiveLight&&!this.__lighting&&Lighting.getLighting(this),Shader.renderer.draw(this,mesh,geom)},prototype.upload=function(mesh,geom){let p=this.mesh,scene=World.SCENE;for(;p;)p instanceof Scene&&(scene=p),p=p._parent;scene.nuke&&scene.nuke.onBeforeShaderCompile(this.mesh),Shader.renderer.upload(this,mesh,geom),this.receiveShadow&&!this.shadow&&Lighting.initShadowShader(this,mesh)},prototype.destroy=function(){this.persists||(Shader.renderer.destroy(this),this.shadow&&this.shadow.destroy()),this.receiveLight&&Lighting.destroyShader(this)},prototype.onBeforeCompile=function(code,type){const WEBGL2=Renderer.type==Renderer.WEBGL2;this.receiveShadow&&(this.receiveLight=!0);let replace,varyings=[],counts=[];(code=code.split("\n")).forEach((line,index)=>{"fs"==type&&line.includes("#drawbuffer")&&(line.includes("#drawbuffer Color")?code[index]=line.replace("#drawbuffer Color",""):code[index]=""),line.includes("varying")&&varyings.push(line)}),code=code.join("\n"),varyings.length&&varyings.forEach(varying=>{let count=0;varyings.forEach(v2=>{varying==v2&&count++}),count>1&&(replace||(replace=[]),replace.includes(varying)||(replace.push(varying),counts.push(count)))}),replace&&replace.forEach((varying,i)=>{let count=counts[i];for(let j=0;j<count-1;j++){let index=code.lastIndexOf(varying);code=code.substring(0,index)+code.substring(index+varying.length)}}),"fs"==type&&(WEBGL2?code.includes("gl_FragColor")&&(code=code.replace(/gl_FragColor/g,"FragColor")):code.includes("#applyShadow")&&(code=code.replace("#applyShadow",""))),code=code.replace("__ACTIVE_THEORY_LIGHTS__",function getLightingCode(_this){if(!_this.receiveLight||_this.isShadow)return"";let numLights=Lighting.getLighting(_this).position.length/4;return 0==numLights?Lighting.getShadowUniforms(_this):["#define NUM_LIGHTS "+numLights,"uniform lights {",`vec4 lightPos[${numLights}];`,`vec4 lightColor[${numLights}];`,`vec4 lightData[${numLights}];`,`vec4 lightData2[${numLights}];`,`vec4 lightData3[${numLights}];`,`vec4 lightProperties[${numLights}];`,"};"].join("\n")+Lighting.getShadowUniforms(_this)}(this)),"fs"==type&&code.includes("SHADOW_MAPS")&&(code=require("GLSLOptimizer")(code.replace("SHADOW_COUNT",Lighting.getShadowCount(this)))),this.preCompile&&(code=this.preCompile(code,type));let converter=require("ShaderCode");return code=WEBGL2?converter.convertWebGL2(code,type):converter.convertWebGL1(code)},prototype.set=function(key,value,ref){let _this=ref||this;return _this.uniforms[key]?(void 0!==value&&(TweenManager.clearTween(_this.uniforms[key]),_this.uniforms[key].value=value,_this.ubo&&(_this.ubo.needsUpdate=!0)),_this.uniforms[key].value):console.warn(`No key ${key} found on shader`,_this)},prototype.get=function(key,ref){let _this=ref||this;return _this.uniforms[key]&&_this.uniforms[key].value},prototype.tween=function(key,value,time,ease,delay,callback,update,scaledTime){return"number"==typeof value?tween(this.uniforms[key],{value:value},time,ease,delay,callback,update,null,scaledTime):tween(this.uniforms[key].value,value,time,ease,delay,callback,update,null,scaledTime)},prototype.clone=function(noShadows,postfix){const _this=this;noShadows&&(_this.params.receiveShadow=!1);let shader=new Shader(_this.vsParam,_this.fsParam,_this.params,null,postfix);for(let key in _this)key.includes(["vsName","fsName","uniforms"])||"function"==typeof _this[key]||(shader[key]=_this[key]);for(let key in _this.uniforms)shader.uniforms[key]={type:_this.uniforms[key].type,value:_this.uniforms[key].value};return shader},prototype.resetProgram=function(){this.destroy(),this.vertexShader=this.restoreVS||Shader.process(Shaders.getShader(this.vsName+".vs"),"vs",this),this.fragmentShader=this.restoreFS||Shader.process(Shaders.getShader(this.fsName+".fs"),"fs",this)},Object.defineProperty(prototype,"receiveShadow",{set:function(v){this._receiveShadow=v,v&&(_emptyShadowMap||(_emptyShadowMap=[Utils3D.getEmptyTexture()]),this.uniforms.shadowMap={value:_emptyShadowMap})},get:function(){return this._receiveShadow}})});class Texture{constructor(img){this.magFilter=Texture.LINEAR,this.minFilter=Texture.LINEAR_MIPMAP,this.format=Texture.RGBAFormat,this.wrapS=this.wrapT=Texture.CLAMP_TO_EDGE,this._image=img,this.needsUpdate=!0,this.generateMipmaps=!0,this.anisotropy=1,this.type=Texture.UNSIGNED_BYTE,this.isTexture=!0,img&&img.onCreateTexture&&img.onCreateTexture(this)}set image(img){this._image=img,img&&img.onCreateTexture&&img.onCreateTexture(this)}get image(){return this._image}upload(){this._gl||Texture.renderer.upload(this)}destroy(){Texture.renderer.destroy(this),this._image=null}clone(){let texture=new Texture(this.img);return texture.format=this.format,texture.type=this.type,texture.anisotropy=this.anisotropy,texture.wrapS=this.wrapS,texture.wrapT=this.wrapT,texture.generateMipmaps=this.generateMipmaps,texture.minFilter=this.minFilter,texture.magFilter=this.magFilter,texture}}class DataTexture extends Texture{constructor(data,width,height,format,type){super(),format&&(this.format=format),this.width=width,this.height=height,this.data=data,this.minFilter=this.magFilter=Texture.NEAREST,this.generateMipmaps=!1,this.type=type||Texture.FLOAT,this.isDataTexture=!0}uploadAsync(){return Texture.renderer.uploadAsync(this)}}Texture.NEAREST="texture_nearest",Texture.CLAMP_TO_EDGE="texture_clamp",Texture.REPEAT="texture_repeat",Texture.MIRROR_REPEAT="texture_mirror_repeat",Texture.LINEAR="texture_linear",Texture.LINEAR_MIPMAP="texture_linear_mip",Texture.LINEAR_MIPMAP_NEAREST="texture_linear_mip_nearest",Texture.NEAREST_MIPMAP="texture_nearest_mip",Texture.RGBFormat="texture_rgbFormat",Texture.RGBAFormat="texture_rgbaFormat",Texture.UNSIGNED_BYTE="texture_unsigned_byte",Texture.DEPTH="texture_depth",Texture.FLOAT="texture_float",Texture.HALF_FLOAT="texture_half_float",Module((function GLSLOptimizer(){this.exports=function(code){return function unrollLoops(string){return string.replace(/#pragma unroll_loop[\s]+?for \(int i \= (\d+)\; i < (\d+)\; i\+\+\) \{([\s\S]+?)(?=\})\}/g,(function replace(match,start,end,snippet){let unroll="";for(let i=parseInt(start);i<parseInt(end);i++)unroll+=snippet.replace(/\[i\]/g,"["+i+"]");return unroll}))}(code)}})),Module((function GLTypes(){function getType(texture){let _gl=Renderer.context;switch(texture.type){case Texture.FLOAT:return _gl.FLOAT;case Texture.HALF_FLOAT:return Renderer.type==Renderer.WEBGL2?_gl.HALF_FLOAT:Renderer.extensions.halfFloat.HALF_FLOAT_OES;default:return _gl.UNSIGNED_BYTE}}this.exports={getFormat:function getFormat(texture){let _gl=Renderer.context;return texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB},getProperty:function getProperty(property){let _gl=Renderer.context;switch(property){case Texture.NEAREST:return _gl.NEAREST;case Texture.LINEAR:return _gl.LINEAR;case Texture.LINEAR_MIPMAP:return _gl.LINEAR_MIPMAP_LINEAR;case Texture.NEAREST_MIPMAP:return _gl.NEAREST_MIPMAP_LINEAR;case Texture.LINEAR_MIPMAP_NEAREST:return _gl.LINEAR_MIPMAP_NEAREST;case Texture.CLAMP_TO_EDGE:return _gl.CLAMP_TO_EDGE;case Texture.REPEAT:return _gl.REPEAT;case Texture.MIRROR_REPEAT:return _gl.MIRRORED_REPEAT}},getType:getType,getFloatParams:function getFloatParams(texture){let _gl=Renderer.context;return{internalformat:function(){if(Renderer.type==Renderer.WEBGL2){switch(texture.type){case Texture.HALF_FLOAT:return texture.format==Texture.RGBAFormat?_gl.RGBA16F:_gl.RGB16F;case Texture.FLOAT:return texture.format==Texture.RGBAFormat?_gl.RGBA32F:_gl.RGB32F}return texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB}return texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB}(),format:texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB,type:getType(texture)}}}})),Module((function ShaderCode(){function removeUBO(code,name){let uniforms=code.split(`uniform ${name} {`)[1];uniforms=uniforms.split("};")[0],uniforms=uniforms.split("\n"),uniforms.forEach(u=>{(u=u.trim()).length&&(code=code.replace(u,"uniform "+u))});let split=code.split(`uniform ${name} {`);return split[1]=split[1].replace("};",""),code=(code=split.join("")).replace(`uniform ${name} {`,"")}this.exports={convertWebGL1:function convertWebGL1(code){return(code=(code=code.replace("#version 300 es","")).replace("out vec4 FragColor;","")).includes("samplerExternalOES")&&(code=code.replace("samplerExternalOES","sampler2D")),code.includes("uniform global {")&&(code=removeUBO(code,"global")),code.includes("uniform ubo {")&&(code=removeUBO(code,"ubo")),code.includes("uniform lights {")&&(code=removeUBO(code,"lights")),code},convertWebGL2:function convertWebGL2(code,type){return code=code.replace(/texture2D/g,"texture"),!(code="vs"==type?(code=code.replace(/attribute/g,"in")).replace(/varying/g,"out"):(code=code.replace(/varying/g,"in")).replace(/textureCube/g,"texture")).includes("samplerExternalOES")||"android"==Device.system.os&&window.AURA||(code=code.replace("samplerExternalOES","sampler2D")),Renderer.UBO?(code.includes("uniform global {")&&(code=code.replace("uniform global","layout(std140) uniform global")),code.includes("uniform ubo {")&&(code=code.replace("uniform ubo","layout(std140) uniform ubo")),Lighting.UBO?code.includes("uniform lights {")&&(code=code.replace("uniform lights","layout(std140) uniform lights")):code.includes("uniform lights {")&&(code=removeUBO(code,"lights"))):(code.includes("uniform global {")&&(code=removeUBO(code,"global")),code.includes("uniform ubo {")&&(code=removeUBO(code,"ubo")),code.includes("uniform lights {")&&(code=removeUBO(code,"lights"))),code}}}));class UBO{constructor(location,gl=Renderer.context){this.gl=gl,this.arrays=[];for(let i=0;i<30;i++)this.arrays.push([]);this.arrayIndex=0,this.objects=[],this.location=location,this.data=null,this.lastUpdate=0}_getSize(uniform){let obj=uniform.value;return Array.isArray(obj)?uniform.components?obj.length/uniform.components*16:16*obj.length:obj instanceof Vector2?8:obj instanceof Vector3||obj instanceof Vector4||obj instanceof Color?16:obj instanceof Matrix4?64:obj instanceof Matrix3?48:obj instanceof Quaternion?16:4}_getValues(uniform){let obj=uniform.value;return Array.isArray(obj)?obj:obj instanceof Vector2?this._array(obj.x,obj.y):obj instanceof Vector3?this._array(obj.x,obj.y,obj.z):obj instanceof Matrix4||obj instanceof Matrix3?obj.elements:obj instanceof Color?this._array(obj.r,obj.g,obj.b):obj instanceof Quaternion?this._array(obj.x,obj.y,obj.z,obj.w):this._array(obj)}_array(){this.arrayIndex++>=this.arrays.length-1&&(this.arrayIndex=0);let array=this.arrays[this.arrayIndex];return array.length=0,array.push.apply(array,arguments),array}clear(){for(let i=0;i<this.arrays.length;i++)this.arrays[i].length=0}calculate(){let len=this.objects.length,chunk=16,tsize=0,offset=0,size=0;for(let i=0;i<len;i++){let obj=this.objects[i];size=this._getSize(obj),tsize=chunk-size,tsize<0&&chunk<16?(offset+=chunk,i>0&&(this.objects[i-1].chunkLen+=chunk),chunk=16):tsize<0&&16==chunk||(0==tsize?chunk=16:chunk-=size),obj.offset=offset/4,obj.chunkLen=size/4,obj.dataLen=size/4,offset+=size}return offset%16!=0&&(this.objects[this.objects.length-1].chunkLen+=chunk/4,offset+=chunk),offset/4}compileData(){let i,array=this._array(),len=this.calculate();for(i=0;i<len;i++)array[i]=0;for(i=0;i<this.objects.length;i++){let obj=this.objects[i],values=this._getValues(obj);for(let j=0;j<values.length;j++)array[obj.offset+j]=values[j]}return array}upload(){if(this.data)return;let gl=Renderer.context,array=this.compileData();array.length&&(this.data=new Float32Array(array),this.buffer=gl.createBuffer(),gl.bindBuffer(gl.UNIFORM_BUFFER,this.buffer),gl.bufferData(gl.UNIFORM_BUFFER,this.data,gl.DYNAMIC_DRAW),gl.bindBuffer(gl.UNIFORM_BUFFER,null),gl.bindBufferBase(gl.UNIFORM_BUFFER,this.location,this.buffer))}bind(program,name){this.data||this.upload(),this.needsUpdate&&this.update();let location,gl=Renderer.context;location=program==this.lastProgram&&name==this.lastName&&void 0!==this.lastLocation?this.lastLocation:gl.getUniformBlockIndex(program,name),location>99999||-1==location||(gl.uniformBlockBinding(program,location,this.location),gl.bindBufferBase(gl.UNIFORM_BUFFER,this.location,this.buffer),this.lastProgram=program,this.lastName=name,this.lastLocation=location)}update(){if(this.data||this.upload(),!this.data)return;let gl=Renderer.context,array=this.compileData();this.data.set(array),gl.bindBuffer(gl.UNIFORM_BUFFER,this.buffer),gl.bufferSubData(gl.UNIFORM_BUFFER,0,this.data),gl.bindBuffer(gl.UNIFORM_BUFFER,null),this.needsUpdate=!1}unbind(){}push(){if(this.data)throw"Can't modify UBO after initial upload!";for(let i=0;i<arguments.length;i++)this.objects.push(arguments[i])}destroy(){this.gl.deleteBuffer(this.buffer)}}class VAO{constructor(gl){this.gl=gl,this.WEBGL2=Renderer.type==Renderer.WEBGL2,this.WEBGL2?this.vao=gl.createVertexArray():this.vao=Renderer.extensions.VAO.createVertexArrayOES()}bind(){const gl=this.gl;this.WEBGL2?gl.bindVertexArray(this.vao):Renderer.extensions.VAO.bindVertexArrayOES(this.vao)}unbind(){const gl=this.gl;this.WEBGL2?gl.bindVertexArray(null):Renderer.extensions.VAO.bindVertexArrayOES(null)}destroy(){const gl=this.gl;this.WEBGL2?gl.deleteVertexArray(this.vao):Renderer.extensions.VAO.deleteVertexArrayOES(this.vao),this.vao=null}}class BoxGeometry extends Geometry{constructor(width=1,height=1,depth=1,widthSegments=1,heightSegments=1,depthSegments=1){super(),widthSegments=Math.floor(widthSegments),heightSegments=Math.floor(heightSegments),depthSegments=Math.floor(depthSegments);let indices=[],vertices=[],normals=[],uvs=[],numberOfVertices=0;function buildPlane(u,v,w,udir,vdir,width,height,depth,gridX,gridY,materialIndex){let ix,iy,segmentWidth=width/gridX,segmentHeight=height/gridY,widthHalf=width/2,heightHalf=height/2,depthHalf=depth/2,gridX1=gridX+1,gridY1=gridY+1,vertexCounter=0,vector=new Vector3;for(iy=0;iy<gridY1;iy++){let y=iy*segmentHeight-heightHalf;for(ix=0;ix<gridX1;ix++){let x=ix*segmentWidth-widthHalf;vector[u]=x*udir,vector[v]=y*vdir,vector[w]=depthHalf,vertices.push(vector.x,vector.y,vector.z),vector[u]=0,vector[v]=0,vector[w]=depth>0?1:-1,normals.push(vector.x,vector.y,vector.z),uvs.push(ix/gridX),uvs.push(1-iy/gridY),vertexCounter+=1}}for(iy=0;iy<gridY;iy++)for(ix=0;ix<gridX;ix++){let a=numberOfVertices+ix+gridX1*iy,b=numberOfVertices+ix+gridX1*(iy+1),c=numberOfVertices+(ix+1)+gridX1*(iy+1),d=numberOfVertices+(ix+1)+gridX1*iy;indices.push(a,b,d),indices.push(b,c,d)}numberOfVertices+=vertexCounter}buildPlane("z","y","x",-1,-1,depth,height,width,depthSegments,heightSegments,0),buildPlane("z","y","x",1,-1,depth,height,-width,depthSegments,heightSegments,1),buildPlane("x","z","y",1,1,width,depth,height,widthSegments,depthSegments,2),buildPlane("x","z","y",1,-1,width,depth,-height,widthSegments,depthSegments,3),buildPlane("x","y","z",1,-1,width,height,depth,widthSegments,heightSegments,4),buildPlane("x","y","z",-1,-1,width,height,-depth,widthSegments,heightSegments,5),this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class CircleGeometry extends Geometry{constructor(radius=1,segments=8,thetaStart=0,thetaLength=2*Math.PI){super();var i,s,indices=[],vertices=[],normals=[],uvs=[],vertex=new Vector3,uv=new Vector2;for(vertices.push(0,0,0),normals.push(0,0,1),uvs.push(.5,.5),s=0,i=3;s<=segments;s++,i+=3){var segment=thetaStart+s/segments*thetaLength;vertex.x=radius*Math.cos(segment),vertex.y=radius*Math.sin(segment),vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,0,1),uv.x=(vertices[i]/radius+1)/2,uv.y=(vertices[i+1]/radius+1)/2,uvs.push(uv.x,uv.y)}for(i=1;i<=segments;i++)indices.push(i,i+1,0);this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class CylinderGeometry extends Geometry{constructor(radiusTop=1,radiusBottom=1,height=1,radialSegments=8,heightSegments=1,openEnded=!1,thetaStart=0,thetaLength=2*Math.PI){super(),radialSegments=Math.floor(radialSegments),heightSegments=Math.floor(heightSegments);let indices=[],vertices=[],normals=[],uvs=[],index=0,indexArray=[],halfHeight=height/2;function generateCap(top){let x,centerIndexStart,centerIndexEnd,uv=new Vector2,vertex=new Vector3,radius=!0===top?radiusTop:radiusBottom,sign=!0===top?1:-1;for(centerIndexStart=index,x=1;x<=radialSegments;x++)vertices.push(0,halfHeight*sign,0),normals.push(0,sign,0),uvs.push(.5,.5),index++;for(centerIndexEnd=index,x=0;x<=radialSegments;x++){let theta=x/radialSegments*thetaLength+thetaStart,cosTheta=Math.cos(theta),sinTheta=Math.sin(theta);vertex.x=radius*sinTheta,vertex.y=halfHeight*sign,vertex.z=radius*cosTheta,vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,sign,0),uv.x=.5*cosTheta+.5,uv.y=.5*sinTheta*sign+.5,uvs.push(uv.x,uv.y),index++}for(x=0;x<radialSegments;x++){let c=centerIndexStart+x,i=centerIndexEnd+x;!0===top?indices.push(i,i+1,c):indices.push(i+1,i,c)}}!function generateTorso(){let x,y,normal=new Vector3,vertex=new Vector3,slope=(radiusBottom-radiusTop)/height;for(y=0;y<=heightSegments;y++){let indexRow=[],v=y/heightSegments,radius=v*(radiusBottom-radiusTop)+radiusTop;for(x=0;x<=radialSegments;x++){let u=x/radialSegments,theta=u*thetaLength+thetaStart,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta);vertex.x=radius*sinTheta,vertex.y=-v*height+halfHeight,vertex.z=radius*cosTheta,vertices.push(vertex.x,vertex.y,vertex.z),normal.set(sinTheta,slope,cosTheta).normalize(),normals.push(normal.x,normal.y,normal.z),uvs.push(u,1-v),indexRow.push(index++)}indexArray.push(indexRow)}for(x=0;x<radialSegments;x++)for(y=0;y<heightSegments;y++){let a=indexArray[y][x],b=indexArray[y+1][x],c=indexArray[y+1][x+1],d=indexArray[y][x+1];indices.push(a,b,d),indices.push(b,c,d)}}(),!1===openEnded&&(radiusTop>0&&generateCap(!0),radiusBottom>0&&generateCap(!1)),this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class ConeGeometry extends CylinderGeometry{constructor(radius,height,radialSegments,heightSegments,openEnded,thetaStart,thetaLength){super(0,radius,height,radialSegments,heightSegments,openEnded,thetaStart,thetaLength)}}class PlaneGeometry extends Geometry{constructor(width=1,height=1,widthSegments=1,heightSegments=1){super();let ix,iy,width_half=width/2,height_half=height/2,gridX=Math.floor(widthSegments)||1,gridY=Math.floor(heightSegments)||1,gridX1=gridX+1,gridY1=gridY+1,segment_width=width/gridX,segment_height=height/gridY,indices=[],vertices=[],normals=[],uvs=[];for(iy=0;iy<gridY1;iy++){let y=iy*segment_height-height_half;for(ix=0;ix<gridX1;ix++){let x=ix*segment_width-width_half;vertices.push(x,-y,0),normals.push(0,0,1),uvs.push(ix/gridX),uvs.push(1-iy/gridY)}}for(iy=0;iy<gridY;iy++)for(ix=0;ix<gridX;ix++){let a=ix+gridX1*iy,b=ix+gridX1*(iy+1),c=ix+1+gridX1*(iy+1),d=ix+1+gridX1*iy;indices.push(a,b,d),indices.push(b,c,d)}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class PolyhedronGeometry extends Geometry{constructor(vertices,indices=[],radius=1,detail=0){super();let vertexBuffer=[],uvBuffer=[];function subdivideFace(a,b,c,detail){var i,j,cols=Math.pow(2,detail),v=[];for(i=0;i<=cols;i++){v[i]=[];var aj=a.clone().lerp(c,i/cols),bj=b.clone().lerp(c,i/cols),rows=cols-i;for(j=0;j<=rows;j++)v[i][j]=0===j&&i===cols?aj:aj.clone().lerp(bj,j/rows)}for(i=0;i<cols;i++)for(j=0;j<2*(cols-i)-1;j++){var k=Math.floor(j/2);j%2==0?(pushVertex(v[i][k+1]),pushVertex(v[i+1][k]),pushVertex(v[i][k])):(pushVertex(v[i][k+1]),pushVertex(v[i+1][k+1]),pushVertex(v[i+1][k]))}}function pushVertex(vertex){vertexBuffer.push(vertex.x,vertex.y,vertex.z)}function getVertexByIndex(index,vertex){let stride=3*index;vertex.x=vertices[stride+0],vertex.y=vertices[stride+1],vertex.z=vertices[stride+2]}function correctUV(uv,stride,vector,azimuth){azimuth<0&&1===uv.x&&(uvBuffer[stride]=uv.x-1),0===vector.x&&0===vector.z&&(uvBuffer[stride]=azimuth/2/Math.PI+.5)}function azimuth(vector){return Math.atan2(vector.z,-vector.x)}!function subdivide(detail){let a=new Vector3,b=new Vector3,c=new Vector3;for(let i=0;i<indices.length;i+=3)getVertexByIndex(indices[i+0],a),getVertexByIndex(indices[i+1],b),getVertexByIndex(indices[i+2],c),subdivideFace(a,b,c,detail)}(detail),function appplyRadius(radius){for(var vertex=new Vector3,i=0;i<vertexBuffer.length;i+=3)vertex.x=vertexBuffer[i+0],vertex.y=vertexBuffer[i+1],vertex.z=vertexBuffer[i+2],vertex.normalize().multiplyScalar(radius),vertexBuffer[i+0]=vertex.x,vertexBuffer[i+1]=vertex.y,vertexBuffer[i+2]=vertex.z}(radius),function generateUVs(){let vertex=new Vector3;for(let i=0;i<vertexBuffer.length;i+=3){vertex.x=vertexBuffer[i+0],vertex.y=vertexBuffer[i+1],vertex.z=vertexBuffer[i+2];let u=azimuth(vertex)/2/Math.PI+.5,v=(vector=vertex,Math.atan2(-vector.y,Math.sqrt(vector.x*vector.x+vector.z*vector.z))/Math.PI+.5);uvBuffer.push(u,1-v)}var vector;(function correctUVs(){let a=new Vector3,b=new Vector3,c=new Vector3,centroid=new Vector3,uvA=new Vector2,uvB=new Vector2,uvC=new Vector2;for(let i=0,j=0;i<vertexBuffer.length;i+=9,j+=6){a.set(vertexBuffer[i+0],vertexBuffer[i+1],vertexBuffer[i+2]),b.set(vertexBuffer[i+3],vertexBuffer[i+4],vertexBuffer[i+5]),c.set(vertexBuffer[i+6],vertexBuffer[i+7],vertexBuffer[i+8]),uvA.set(uvBuffer[j+0],uvBuffer[j+1]),uvB.set(uvBuffer[j+2],uvBuffer[j+3]),uvC.set(uvBuffer[j+4],uvBuffer[j+5]),centroid.copy(a).add(b).add(c).divideScalar(3);let azi=azimuth(centroid);correctUV(uvA,j+0,a,azi),correctUV(uvB,j+2,b,azi),correctUV(uvC,j+4,c,azi)}})(),function correctSeam(){for(let i=0;i<uvBuffer.length;i+=6){let x0=uvBuffer[i+0],x1=uvBuffer[i+2],x2=uvBuffer[i+4],max=Math.max(x0,x1,x2),min=Math.min(x0,x1,x2);max>.9&&min<.1&&(x0<.2&&(uvBuffer[i+0]+=1),x1<.2&&(uvBuffer[i+2]+=1),x2<.2&&(uvBuffer[i+4]+=1))}}()}(),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertexBuffer),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(vertexBuffer.slice()),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvBuffer),2)),0===detail?this.computeVertexNormals():this.normalizeNormals()}}class IcosahedronGeometry extends PolyhedronGeometry{constructor(radius,detail){let t=(1+Math.sqrt(5))/2;super([-1,t,0,1,t,0,-1,-t,0,1,-t,0,0,-1,t,0,1,t,0,-1,-t,0,1,-t,t,0,-1,t,0,1,-t,0,-1,-t,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],radius,detail)}}class RingGeometry extends Geometry{constructor(innerRadius=.5,outerRadius=1,thetaSegments=8,phiSegments=1,thetaStart=0,thetaLength=2*Math.PI){super();var segment,j,i,indices=[],vertices=[],normals=[],uvs=[],radius=innerRadius,radiusStep=(outerRadius-innerRadius)/phiSegments,vertex=new Vector3,uv=new Vector2;for(j=0;j<=phiSegments;j++){for(i=0;i<=thetaSegments;i++)segment=thetaStart+i/thetaSegments*thetaLength,vertex.x=radius*Math.cos(segment),vertex.y=radius*Math.sin(segment),vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,0,1),uv.x=(vertex.x/outerRadius+1)/2,uv.y=(vertex.y/outerRadius+1)/2,uvs.push(uv.x,uv.y);radius+=radiusStep}for(j=0;j<phiSegments;j++){var thetaSegmentLevel=j*(thetaSegments+1);for(i=0;i<thetaSegments;i++){var a=segment=i+thetaSegmentLevel,b=segment+thetaSegments+1,c=segment+thetaSegments+2,d=segment+1;indices.push(a,b,d),indices.push(b,c,d)}}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class SphereGeometry extends Geometry{constructor(radius=1,widthSegments=8,heightSegments=6,phiStart=0,phiLength=2*Math.PI,thetaStart=0,thetaLength=Math.PI){super(),widthSegments=Math.max(3,Math.floor(widthSegments)),heightSegments=Math.max(2,Math.floor(heightSegments));let ix,iy,thetaEnd=thetaStart+thetaLength,index=0,grid=[],vertex=new Vector3,normal=new Vector3,indices=[],vertices=[],normals=[],uvs=[];for(iy=0;iy<=heightSegments;iy++){let verticesRow=[],v=iy/heightSegments;for(ix=0;ix<=widthSegments;ix++){let u=ix/widthSegments;vertex.x=-radius*Math.cos(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertex.y=radius*Math.cos(thetaStart+v*thetaLength),vertex.z=radius*Math.sin(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertices.push(vertex.x,vertex.y,vertex.z),normal.set(vertex.x,vertex.y,vertex.z).normalize(),normals.push(normal.x,normal.y,normal.z),uvs.push(u,1-v),verticesRow.push(index++)}grid.push(verticesRow)}for(iy=0;iy<heightSegments;iy++)for(ix=0;ix<widthSegments;ix++){let a=grid[iy][ix+1],b=grid[iy][ix],c=grid[iy+1][ix],d=grid[iy+1][ix+1];(0!==iy||thetaStart>0)&&indices.push(a,b,d),(iy!==heightSegments-1||thetaEnd<Math.PI)&&indices.push(b,c,d)}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class TorusKnotGeometry extends Geometry{constructor(radius=1,tube=.4,tubularSegments=64,radialSegments=8,p=2,q=3){super();let i,j,indices=[],vertices=[],normals=[],uvs=[],vertex=new Vector3,normal=new Vector3,P1=new Vector3,P2=new Vector3,B=new Vector3,T=new Vector3,N=new Vector3;for(i=0;i<=tubularSegments;++i){let u=i/tubularSegments*p*Math.PI*2;for(calculatePositionOnCurve(u,p,q,radius,P1),calculatePositionOnCurve(u+.01,p,q,radius,P2),T.subVectors(P2,P1),N.addVectors(P2,P1),B.crossVectors(T,N),N.crossVectors(B,T),B.normalize(),N.normalize(),j=0;j<=radialSegments;++j){let v=j/radialSegments*Math.PI*2,cx=-tube*Math.cos(v),cy=tube*Math.sin(v);vertex.x=P1.x+(cx*N.x+cy*B.x),vertex.y=P1.y+(cx*N.y+cy*B.y),vertex.z=P1.z+(cx*N.z+cy*B.z),vertices.push(vertex.x,vertex.y,vertex.z),normal.subVectors(vertex,P1).normalize(),normals.push(normal.x,normal.y,normal.z),uvs.push(i/tubularSegments),uvs.push(j/radialSegments)}}for(j=1;j<=tubularSegments;j++)for(i=1;i<=radialSegments;i++){let a=(radialSegments+1)*(j-1)+(i-1),b=(radialSegments+1)*j+(i-1),c=(radialSegments+1)*j+i,d=(radialSegments+1)*(j-1)+i;indices.push(a,b,d),indices.push(b,c,d)}function calculatePositionOnCurve(u,p,q,radius,position){let cu=Math.cos(u),su=Math.sin(u),quOverP=q/p*u,cs=Math.cos(quOverP);position.x=radius*(2+cs)*.5*cu,position.y=radius*(2+cs)*su*.5,position.z=radius*Math.sin(quOverP)*.5}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}Class((function Interaction3D(_camera){Inherit(this,Component);const _this=this;let _hover,_click;var _lastOnUpdate,_v3=new Vector3,_input={},_cacheHits=[],_enabled=!0;_this.ID=Utils.timestamp(),_camera=_camera||World.CAMERA;var _ray=_this.initClass(Raycaster,_camera),_meshes=[],_test=[],_event={};const PROHIBITED_ELEMENTS=["hit","prevent_interaction3d"];function checkIfProhibited(element){let el=element;for(;el;){if(el.classList&&el.classList.contains(PROHIBITED_ELEMENTS))return!0;el=el.parentNode}return!1}function parseMeshes(meshes){Array.isArray(meshes)||(meshes=[meshes]);let output=[];return meshes.forEach((function checkMesh(obj){obj.hitArea&&(obj=function initHitMesh(obj){obj.hitMesh||(obj.hitMesh=new Mesh(obj.hitArea),obj.add(obj.hitMesh));return(obj=obj.hitMesh).isHitMesh=!0,obj.testVisibility=!1,obj.visible=!1,obj}(obj));"boolean"==typeof obj.isHitMesh?(obj.mouseEnabled=function(visible){visible?~_meshes.indexOf(obj)||_meshes.push(obj):_meshes.remove(obj)},output.push(obj)):output.push(obj);obj.children.length&&obj.children.forEach(checkMesh)})),output}function testObjects(){_test.length=0;for(let i=_meshes.length-1;i>-1;i--){let obj=_meshes[i];obj.determineVisible()&&_test.push(obj)}return _test}function start(e){let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(element&&checkIfProhibited(element)||GLUI.HIT)return;if(!_enabled)return;let hit=move(e);"3d"==_input.type&&_this.events.fire(Interaction3D.EXTERNAL_PRESS),hit?(_click=hit.object,_click.time=Render.TIME):_click=null}function moveHand(e){if(!_enabled)return;_cacheHits.length=0;for(let i=0;i<_input.obj.length;i++){let obj=_input.obj[i];_v3.set(0,0,-1).applyQuaternion(obj.quaternion);let hit=_ray.checkFromValues(testObjects(),obj.position,_v3)[0];hit&&_cacheHits.push(hit)}_cacheHits.sort((a,b)=>a.distance-b.distance);let hit=_cacheHits[0];if(hit&&hit.object==_lastOnUpdate||(_lastOnUpdate&&_lastOnUpdate.onMissUpdate&&_lastOnUpdate.onMissUpdate(),_lastOnUpdate=null),hit){let mesh=hit.object;if(mesh.onHitUpdate)return hit.usingFinger=!0,_lastOnUpdate=mesh,mesh.onHitUpdate(hit),!1;!mesh._debounceFingerClick||Render.TIME-mesh._debounceFingerClick>1e3?hit.distance<.01?(_click=mesh,triggerClick(mesh,hit),mesh._debounceFingerClick=Render.TIME):_hover||(_hover=mesh,triggerHover("over",mesh,hit)):_hover&&(triggerHover("out",_hover),_hover=null)}else _hover&&(triggerHover("out",_hover),_hover=null)}function move(e){let hit,element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(!element||!checkIfProhibited(element)){if(_enabled){if("2d"==_input.type?hit=_ray.checkHit(testObjects(),_input.position,_input.rect||Stage)[0]:(_v3.set(0,0,-1).applyQuaternion(_input.quaternion),hit=_ray.checkFromValues(testObjects(),_input.position,_v3)[0]),hit&&hit.object==_lastOnUpdate||(_lastOnUpdate&&_lastOnUpdate.onMissUpdate&&_lastOnUpdate.onMissUpdate(),_lastOnUpdate=null),hit){let mesh=hit.object;return mesh.onHitUpdate?(mesh.onHitUpdate(hit),_lastOnUpdate=mesh,!1):(_input.obj&&_input.obj.setHitPosition&&_input.obj.setHitPosition(hit),_hover!==mesh?(_hover&&triggerHover("out",_hover,hit),_hover=mesh,triggerHover("over",_hover,hit),_hover.__clickCallback?Interaction3D.requestCursor("pointer",_this):Interaction3D.requestCursor("auto",_this)):function triggerMove(mesh,hit){_event.action="move",_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.MOVE,_event,!0),mesh["__moveCallback"+_this.ID]&&mesh["__moveCallback"+_this.ID](_event)}(_hover,hit),hit)}return end(),_input.obj&&_input.obj.setHitPosition&&_input.obj.setHitPosition(!1),!1}Interaction3D.requestCursor("auto",_this)}}function end(){_hover&&(triggerHover("out",_hover,null),_hover=null,Interaction3D.requestCursor(_this.cursor,_this))}function click(e){if("3d"==_input.type&&_this.events.fire(Interaction3D.EXTERNAL_RELEASE),!_this.enabled)return;if(!_click)return;let hit,element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(!element||!checkIfProhibited(element)){if("2d"==_input.type){if(GLUI.HIT)return;hit=_ray.checkHit(testObjects(),_input.position,_input.rect)[0]}else _v3.set(0,0,-1).applyQuaternion(_input.quaternion),hit=_ray.checkFromValues(testObjects(),_input.position,_v3)[0];hit&&hit.object===_click&&triggerClick(_click,hit),_click=null}}function triggerHover(action,mesh,hit){_event.action=action,_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.HOVER,_event,!0),_hover.__hoverCallback&&_hover.__hoverCallback(_event)}function triggerClick(mesh,hit){_event.action="click",_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.CLICK,_event,!0),_click.__clickCallback&&_click.__clickCallback(_event)}function vrInputButton(e){"trigger"==e.label&&(e.pressed?start(e):click(e))}this.cursor="auto",_ray.testVisibility=!0,this.set("camera",c=>{_ray.camera=c}),this.add=function(meshes,hover,click,move,seo){let seoRoot;Array.isArray(meshes)||(meshes=parseMeshes(meshes)),move&&"function"!=typeof move&&(seo=move,move=null),seo&&seo.root&&(seoRoot=seo.root,seo=seo.seo),meshes.forEach((mesh,i)=>{if(seo)try{mesh._divFocus=_=>hover({action:"over",seo:!0,mesh:mesh}),mesh._divBlur=_=>hover({action:"out",seo:!0,mesh:mesh}),mesh._divSelect=_=>click({action:"click",seo:!0,mesh:mesh});let{url:url,label:label}=Array.isArray(seo)?seo[i]:seo;GLSEO.objectNode(mesh,seoRoot),mesh.seo.aLink(url,label)}catch(e){Hydra.LOCAL&&console.warn("Could not add SEO to Interaction3D meshes",e)}mesh.hitDestroy=_=>_meshes.remove(mesh),hover&&(mesh.__hoverCallback=hover),click&&(mesh.__clickCallback=click),move&&(mesh["__moveCallback"+_this.ID]=move),_meshes.push(mesh)})},this.remove=function(meshes){Array.isArray(meshes)||(meshes=parseMeshes(meshes)),meshes.forEach(mesh=>{mesh===_hover&&(_hover=null,Interaction3D.requestCursor(_this.cursor,_this)),mesh.seo&&mesh.seo.unlink();for(let i=_meshes.length-1;i>=0;i--)mesh===_meshes[i]&&_meshes.splice(i,1)})},this.set("testVisibility",v=>_ray.testVisibility=v),this.set("input",obj=>{_input&&_input.obj&&_input.obj.isVrController&&_this.events.unsub(_input.obj,VRInput.BUTTON,vrInputButton),(_input={}).obj=obj,_input.position=obj.group?obj.group.position:obj,_input.quaternion=obj.group?obj.group.quaternion:null,_input.type="number"==typeof _input.position.z||Array.isArray(obj)?"3d":"2d",_input.rect=obj.rect,"3d"==_input.type?(new Vector3,new Vector3):(new Vector2,new Vector2),obj==Mouse?function addHandlers(){_this.events.sub(Mouse.input,Interaction.START,start),Device.mobile&&_this.events.sub(Mouse.input,Interaction.END,end),_this.events.sub(Mouse.input,Interaction.MOVE,move),_this.events.sub(Mouse.input,Interaction.CLICK,click)}():(!function removeHandlers(){_this.events.unsub(Mouse.input,Interaction.START,start),Device.mobile&&_this.events.unsub(Mouse.input,Interaction.END,end),_this.events.unsub(Mouse.input,Interaction.MOVE,move),_this.events.unsub(Mouse.input,Interaction.CLICK,click)}(),Array.isArray(obj)?(_this.startRender(moveHand),_this.stopRender(move)):(_this.events.sub(obj,VRInput.BUTTON,vrInputButton),_this.startRender(move,24),_this.stopRender(moveHand)))}),this.get("input",_=>_input),this.get("enabled",_=>_enabled),this.set("enabled",v=>{(_enabled=v)||(_hover&&triggerHover("out",_hover,null),_hover=null)})}),()=>{Interaction3D.HOVER="interaction3d_hover",Interaction3D.CLICK="interaction3d_click",Interaction3D.MOVE="interaction3d_move",Interaction3D.EXTERNAL_PRESS="interaction3d_ext_press",Interaction3D.EXTERNAL_RELEASE="interaction3d_ext_release";var _cursorObj,_map=new Map,_input=Mouse;Interaction3D.find=function(camera){if(camera=camera.camera||camera,!_map.has(camera)){let interaction=new Interaction3D(camera);interaction.input=_input,_map.set(camera,interaction)}return _map.get(camera)},Interaction3D.useInput=function(obj){if(_input!=obj){for(let[camera,interaction]of _map)interaction.input=obj;_input=obj}},Interaction3D.requestCursor=function(cursor,obj){"pointer"==cursor&&(_cursorObj=obj,Stage.cursor(cursor)),"auto"==cursor&&_cursorObj==obj&&(Stage.cursor(cursor),_cursorObj=null)}}),Class((function Lighting(){Inherit(this,Component);const _this=this;var _activeScene,_scenes={};function loop(){if(decomposeLights(_activeScene.lights),_this.UBO){let shader=_activeScene.shaders.start();shader&&(updateArrays(shader),_activeScene.ubo.created?_activeScene.ubo.update():createUBO(shader.uniforms))}else{let shader=_activeScene.shaders.start();for(;shader;)updateArrays(shader),shader=_activeScene.shaders.next()}}function createUBO(uniforms){_activeScene.ubo.created=!0,_activeScene.ubo.push(uniforms.lightPos),_activeScene.ubo.push(uniforms.lightColor),_activeScene.ubo.push(uniforms.lightData),_activeScene.ubo.push(uniforms.lightData2),_activeScene.ubo.push(uniforms.lightData3),_activeScene.ubo.push(uniforms.lightProperties),_activeScene.ubo.upload()}function decomposeLights(lights){for(let i=lights.length-1;i>-1;i--){let light=lights[i];light._decomposedTime&&Render.TIME-light._decomposedTime<8||(light._decomposedTime=Render.TIME,light._parent||light.updateMatrixWorld(),light._world||(light._world=new Vector3),light.lockToLocal?light._world.copy(light.position):light.getWorldPosition(light._world))}}function updateArrays(shader){let lighting=shader.__lighting;lighting.position.length=0,lighting.color.length=0,lighting.data.length=0,lighting.data2.length=0,lighting.data3.length=0,lighting.properties.length=0;for(let i=0;i<_activeScene.lights.length;i++){let light=_activeScene.lights[i];light._world||decomposeLights(_activeScene.lights),lighting.position.push(light._world.x,light._world.y,light._world.z,0),lighting.color.push(light.color.r,light.color.g,light.color.b,0),lighting.data.push(light.data.x,light.data.y,light.data.z,light.data.w),lighting.data2.push(light.data2.x,light.data2.y,light.data2.z,light.data2.w),lighting.data3.push(light.data3.x,light.data3.y,light.data3.z,light.data3.w),lighting.properties.push(light.properties.x,light.properties.y,light.properties.z,light.properties.w)}}function findParentScene(obj3d){if(!obj3d)return _activeScene;if(obj3d._lightingData)return obj3d._lightingData;let scene,p=obj3d._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent;return scene||(scene=_activeScene),scene}this.fallbackAreaToPoint=!1,this.scenes=_scenes,async function(){await Hydra.ready(),_this.createScene("default"),_this.useScene("default")}(),this.createScene=function(name,scene){if(_scenes[name])return this;let obj={lights:[],renderShadows:[],ubo:new(window.Metal?MetalUBO:UBO)(2),shaders:new LinkedList,name:name};return scene&&(scene._lightingData=obj),_scenes[name]=obj,this},this.useScene=function(name){if(!(_activeScene=_scenes[name]))throw`Scene ${name} not found`;return loop(),this},this.destroyScene=function(name){delete _scenes[name]},this.push=this.add=function(light){_this.UBO=Renderer.UBO&&!(window.AURA||RenderManager.type==RenderManager.WEBVR),window.Metal&&(_this.UBO=!0);let scene=findParentScene(light);scene.lights.push(light),light.isAreaLight&&(scene.hasAreaLight=!0),_this.startedLoop||(_this.startedLoop=!0,RenderManager.type==RenderManager.WEBVR?_this.events.sub(RenderManager.BEFORE_RENDER,_=>loop()):Render.onDrawFrame(loop))},this.remove=function(light){_activeScene.lights.remove(light)},this.getLighting=function(shader,force){if(shader.__lighting&&!force)return shader.__lighting;let scene=findParentScene(shader.mesh);scene.shaders.push(shader),window.AreaLightUtil&&scene.hasAreaLight&&AreaLightUtil.append(shader);let lighting=shader.__lighting={position:[],color:[],data:[],data2:[],data3:[],properties:[]},lightUBO=_this.UBO;return shader.uniforms.lightPos={type:"v4v",value:lighting.position,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightColor={type:"v4v",value:lighting.color,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData={type:"v4v",value:lighting.data,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData2={type:"v4v",value:lighting.data2,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData3={type:"v4v",value:lighting.data3,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightProperties={type:"v4v",value:lighting.properties,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},updateArrays(shader),_this.UBO&&!_activeScene.ubo.created&&createUBO(shader.uniforms),shader.__lighting},this.destroyShader=function(shader){findParentScene(shader.mesh);_activeScene.shaders.remove(shader)},this.sort=function(callback){_activeScene.lights.sort(callback)},this.addToShadowGroup=function(light){findParentScene(light).renderShadows.push(light)},this.removeFromShadowGroup=function(light){findParentScene(light);_activeScene.renderShadows.remove(light)},this.getShadowLights=function(){return _activeScene.renderShadows},this.getShadowCount=function(){return _activeScene.renderShadows.length},this.initShadowShader=function(object,mesh){let scene,shader=object.shader||object;if(shader.mesh){let p=shader.mesh._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent}if(scene||(scene=_activeScene),!World.RENDERER.shadows||0==scene.renderShadows.length)return"";shader._gl||shader.upload();let vsName=shader.vsName,fsName="ShadowDepth";shader.customShadowShader&&(fsName=shader.customShadowShader),shader.shadow=new Shader(vsName,fsName,{receiveLight:shader.receiveLight,UILPrefix:shader.UILPrefix,precision:"high"}),shader.vertexShader&&(shader.shadow.vertexShader=shader.vertexShader),shader.shadow.lights=shader.lights,shader.shadow.isShadow=!0,shader.copyUniformsTo(shader.shadow,!0),shader.shadow.upload()},this.getShadowUniforms=function(shader){let scene;if(shader.mesh){let p=shader.mesh._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent}return scene||(scene=_activeScene),World.RENDERER.shadows&&0!=scene.renderShadows.length?["\n#define SHADOW_MAPS "+scene.renderShadows.length,World.RENDERER.shadows==Renderer.SHADOWS_LOW?"#define SHADOWS_LOW":"",World.RENDERER.shadows==Renderer.SHADOWS_MED?"#define SHADOWS_MED":"",World.RENDERER.shadows==Renderer.SHADOWS_HIGH?"#define SHADOWS_HIGH":"",`uniform sampler2D shadowMap[${scene.renderShadows.length}];`,`uniform mat4 shadowMatrix[${scene.renderShadows.length}];`,`uniform vec3 shadowLightPos[${scene.renderShadows.length}];`,`uniform float shadowSize[${scene.renderShadows.length}];`].join("\n"):""},this.bindUBO=function(shader){_activeScene.ubo.created&&_activeScene.ubo.bind(shader,"lights")},this.fallbackAreaToPointTest=function(){return _this.fallbackAreaToPoint},this.get("activeScene",_=>_activeScene)}),"static");class Shadow{constructor(light){this.light=light,this.camera=new PerspectiveCamera(60,1,.1,50),this.target=new Vector3,this.rt=new RenderTarget(1024,1024),this.rt.createDepthTexture(),this.enabled=!0,this._size=1024,this._fov=60,this._far=50,this._near=.1,light.add(this.camera)}destroy(){this.rt.destroy()}set fov(value){this._fov=value,this.camera.fov=value,this.camera.updateProjectionMatrix(),-1==value&&(this.camera=new OrthographicCamera(-5,5,5,-5,.1,50))}get fov(){return this._fov}set area(value){this._area=value,this.camera.left=-value,this.camera.right=value,this.camera.top=value,this.camera.bottom=-value,this.camera.updateProjectionMatrix()}get area(){return this._area}set far(value){this._far=value,this.camera.far=value,this.camera.updateProjectionMatrix()}get far(){return this._far}set near(value){this._near=value,this.camera.near=value,this.camera.updateProjectionMatrix()}get near(){return this._near}set size(value){this._size=value,this.rt.setSize(value,value)}get size(){return this._size}}class Box2{constructor(min,max){this.min=void 0!==min?min:new Vector2(1/0,1/0),this.max=void 0!==max?max:new Vector2(-1/0,-1/0)}set(min,max){return this.min.copy(min),this.max.copy(max),this}setFromPoints(points){this.makeEmpty();for(let i=0,il=points.length;i<il;i++)this.expandByPoint(points[i]);return this}setFromCenterAndSize(center,size){let v1=this.V1||new Vector2;this.V1=v1;let halfSize=v1.copy(size).multiplyScalar(.5);return this.min.copy(center).sub(halfSize),this.max.copy(center).add(halfSize),this}clone(){return(new Box2).copy(this)}copy(box){return this.min.copy(box.min),this.max.copy(box.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(target){return this.isEmpty()?target.set(0,0):target.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(target){return this.isEmpty()?target.set(0,0):target.subVectors(this.max,this.min)}expandByPoint(point){return this.min.min(point),this.max.max(point),this}expandByVector(vector){return this.min.sub(vector),this.max.add(vector),this}expandByScalar(scalar){return this.min.addScalar(-scalar),this.max.addScalar(scalar),this}containsPoint(point){return!(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y)}containsBox(box){return this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y}getParameter(point,target){return target.set((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(box){return!(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y)}clampPoint(point,target){return target.copy(point).clamp(this.min,this.max)}distanceToPoint(point){let v1=this.V1||new Vector2;return this.V1=v1,v1.copy(point).clamp(this.min,this.max).sub(point).length()}intersect(box){return this.min.max(box.min),this.max.min(box.max),this}union(box){return this.min.min(box.min),this.max.max(box.max),this}translate(offset){return this.min.add(offset),this.max.add(offset),this}equals(box){return box.min.equals(this.min)&&box.max.equals(this.max)}}class Box3{constructor(min,max){this.min=void 0!==min?min:new Vector3(1/0,1/0,1/0),this.max=void 0!==max?max:new Vector3(-1/0,-1/0,-1/0)}set(min,max){return this.min.copy(min),this.max.copy(max),this}setFromArray(array){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=array.length;i<l;i+=3){let x=array[i],y=array[i+1],z=array[i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}setFromBufferAttribute(attribute){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=attribute.count;i<l;i++){let x=attribute.array[3*i+0],y=attribute.array[3*i+1],z=attribute.array[3*i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}setFromPoints(points){this.makeEmpty();for(let i=0,il=points.length;i<il;i++)this.expandByPoint(points[i]);return this}setFromCenterAndSize(center,size){let v1=this.V1||new Vector3;this.V1=v1;let halfSize=v1.copy(size).multiplyScalar(.5);return this.min.copy(center).sub(halfSize),this.max.copy(center).add(halfSize),this}setFromObject(object){return this.makeEmpty(),this.expandByObject(object)}clone(){return(new Box3).copy(this)}copy(box){return this.min.copy(box.min),this.max.copy(box.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(target){return this.isEmpty()?target.set(0,0,0):target.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(target){return this.isEmpty()?target.set(0,0,0):target.subVectors(this.max,this.min)}expandByPoint(point){return this.min.min(point),this.max.max(point),this}expandByVector(vector){return this.min.sub(vector),this.max.add(vector),this}expandByScalar(scalar){return this.min.addScalar(-scalar),this.max.addScalar(scalar),this}expandByObject(object,local){let scope,i,l,v1=this.V1||new Vector3;return this.V1=v1,scope=this,object.updateMatrixWorld(!0),object.traverse(node=>{let geometry=node.geometry;if(!geometry)return;let attribute=geometry.attributes.position;if(void 0!==attribute)for(i=0,l=attribute.count;i<l;i++)v1.fromBufferAttribute(attribute,i).applyMatrix4(local?node.matrix:node.matrixWorld),scope.expandByPoint(v1)}),this}containsPoint(point){return!(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y||point.z<this.min.z||point.z>this.max.z)}containsBox(box){return this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y&&this.min.z<=box.min.z&&box.max.z<=this.max.z}getParameter(point,target){return target.set((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y),(point.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(box){return!(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y||box.max.z<this.min.z||box.min.z>this.max.z)}intersectsSphere(sphere){let closestPoint=this.V1||new Vector3;return this.V1=closestPoint,this.clampPoint(sphere.center,closestPoint),closestPoint.distanceToSquared(sphere.center)<=sphere.radius*sphere.radius}intersectsPlane(plane){let min,max;return plane.normal.x>0?(min=plane.normal.x*this.min.x,max=plane.normal.x*this.max.x):(min=plane.normal.x*this.max.x,max=plane.normal.x*this.min.x),plane.normal.y>0?(min+=plane.normal.y*this.min.y,max+=plane.normal.y*this.max.y):(min+=plane.normal.y*this.max.y,max+=plane.normal.y*this.min.y),plane.normal.z>0?(min+=plane.normal.z*this.min.z,max+=plane.normal.z*this.max.z):(min+=plane.normal.z*this.max.z,max+=plane.normal.z*this.min.z),min<=plane.constant&&max>=plane.constant}intersectsTriangle(triangle){let v0=this.V0||new Vector3;this.V0=v0;let v1=this.V1||new Vector3;this.V1=v1;let v2=this.V2||new Vector3;this.V2=v2;let f0=this.F0||new Vector3;this.F0=f0;let f1=this.F1||new Vector3;this.F1=f1;let f2=this.F2||new Vector3;this.F2=f2;let testAxis=this.V3||new Vector3;this.V3=testAxis;let center=this.V4||new Vector3;this.V4=center;let extents=this.V5||new Vector3;this.V5=extents;let triangleNormal=this.V6||new Vector3;function satForAxes(axes){let i,j;for(i=0,j=axes.length-3;i<=j;i+=3){testAxis.fromArray(axes,i);let r=extents.x*Math.abs(testAxis.x)+extents.y*Math.abs(testAxis.y)+extents.z*Math.abs(testAxis.z),p0=v0.dot(testAxis),p1=v1.dot(testAxis),p2=v2.dot(testAxis);if(Math.max(-Math.max(p0,p1,p2),Math.min(p0,p1,p2))>r)return!1}return!0}if(this.V6=triangleNormal,this.isEmpty())return!1;this.getCenter(center),extents.subVectors(this.max,center),v0.subVectors(triangle.a,center),v1.subVectors(triangle.b,center),v2.subVectors(triangle.c,center),f0.subVectors(v1,v0),f1.subVectors(v2,v1),f2.subVectors(v0,v2);let axes=[0,-f0.z,f0.y,0,-f1.z,f1.y,0,-f2.z,f2.y,f0.z,0,-f0.x,f1.z,0,-f1.x,f2.z,0,-f2.x,-f0.y,f0.x,0,-f1.y,f1.x,0,-f2.y,f2.x,0];return!!satForAxes(axes)&&(axes=[1,0,0,0,1,0,0,0,1],!!satForAxes(axes)&&(triangleNormal.crossVectors(f0,f1),axes=[triangleNormal.x,triangleNormal.y,triangleNormal.z],satForAxes(axes)))}clampPoint(point,target){return target.copy(point).clamp(this.min,this.max)}distanceToPoint(point){let v1=this.V1||new Vector3;return this.V1=v1,v1.copy(point).clamp(this.min,this.max).sub(point).length()}getBoundingSphere(target=new Sphere){let v1=this.V1||new Vector3;return this.V1=v1,this.getCenter(target.center),target.radius=.5*this.getSize(v1).length(),target}intersect(box){return this.min.max(box.min),this.max.min(box.max),this.isEmpty()&&this.makeEmpty(),this}union(box){return this.min.min(box.min),this.max.max(box.max),this}applyMatrix4(matrix){if(this.isEmpty())return this;let m=matrix.elements,xax=m[0]*this.min.x,xay=m[1]*this.min.x,xaz=m[2]*this.min.x,xbx=m[0]*this.max.x,xby=m[1]*this.max.x,xbz=m[2]*this.max.x,yax=m[4]*this.min.y,yay=m[5]*this.min.y,yaz=m[6]*this.min.y,ybx=m[4]*this.max.y,yby=m[5]*this.max.y,ybz=m[6]*this.max.y,zax=m[8]*this.min.z,zay=m[9]*this.min.z,zaz=m[10]*this.min.z,zbx=m[8]*this.max.z,zby=m[9]*this.max.z,zbz=m[10]*this.max.z;return this.min.x=Math.min(xax,xbx)+Math.min(yax,ybx)+Math.min(zax,zbx)+m[12],this.min.y=Math.min(xay,xby)+Math.min(yay,yby)+Math.min(zay,zby)+m[13],this.min.z=Math.min(xaz,xbz)+Math.min(yaz,ybz)+Math.min(zaz,zbz)+m[14],this.max.x=Math.max(xax,xbx)+Math.max(yax,ybx)+Math.max(zax,zbx)+m[12],this.max.y=Math.max(xay,xby)+Math.max(yay,yby)+Math.max(zay,zby)+m[13],this.max.z=Math.max(xaz,xbz)+Math.max(yaz,ybz)+Math.max(zaz,zbz)+m[14],this}translate(offset){return this.min.add(offset),this.max.add(offset),this}equals(box){return box.min.equals(this.min)&&box.max.equals(this.max)}setFromBufferAttribute(attribute){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=attribute.count;i<l;i++){let x=attribute.array[3*i+0],y=attribute.array[3*i+1],z=attribute.array[3*i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}}class Color{constructor(r,g,b){return null==r&&null==g&&null==b?this.setRGB(1,1,1):void 0===g&&void 0===b?this.set(r):void this.setRGB(r,g,b)}set(value){return value&&value instanceof Color?this.copy(value):"number"==typeof value?this.setHex(value):"string"==typeof value&&this.setStyle(value),this}setScalar(scalar){return this.r=scalar,this.g=scalar,this.b=scalar,this}setHex(hex){return hex=Math.floor(hex),this.r=(hex>>16&255)/255,this.g=(hex>>8&255)/255,this.b=(255&hex)/255,this}setStyle(string){return this.setHex(Number(string.replace("#","0x")))}setRGB(r,g,b){return this.r=r,this.g=g,this.b=b,this}setHSL(h,s,l){function hue2rgb(p,q,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?p+6*(q-p)*t:t<.5?q:t<2/3?p+6*(q-p)*(2/3-t):p}if(h=Math.euclideanModulo(h,1),s=Math.clamp(s,0,1),l=Math.clamp(l,0,1),0===s)this.r=this.g=this.b=l;else{let p=l<=.5?l*(1+s):l+s-l*s,q=2*l-p;this.r=hue2rgb(q,p,h+1/3),this.g=hue2rgb(q,p,h),this.b=hue2rgb(q,p,h-1/3)}return this}clone(){return new Color(this.r,this.g,this.b)}copy(color){return this.r=color.r,this.g=color.g,this.b=color.b,this}copyGammaToLinear(color,gammaFactor){return void 0===gammaFactor&&(gammaFactor=2),this.r=Math.pow(color.r,gammaFactor),this.g=Math.pow(color.g,gammaFactor),this.b=Math.pow(color.b,gammaFactor),this}copyLinearToGamma(color,gammaFactor){void 0===gammaFactor&&(gammaFactor=2);let safeInverse=gammaFactor>0?1/gammaFactor:1;return this.r=Math.pow(color.r,safeInverse),this.g=Math.pow(color.g,safeInverse),this.b=Math.pow(color.b,safeInverse),this}convertGammaToLinear(gammaFactor){return this.copyGammaToLinear(this,gammaFactor),this}convertLinearToGamma(gammaFactor){return this.copyLinearToGamma(this,gammaFactor),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return"#"+("000000"+this.getHex().toString(16)).slice(-6)}getHSL(){let target=this.target||{};this.target=target;let hue,saturation,r=this.r,g=this.g,b=this.b,max=Math.max(r,g,b),min=Math.min(r,g,b),lightness=(min+max)/2;if(min===max)hue=0,saturation=0;else{let delta=max-min;switch(saturation=lightness<=.5?delta/(max+min):delta/(2-max-min),max){case r:hue=(g-b)/delta+(g<b?6:0);break;case g:hue=(b-r)/delta+2;break;case b:hue=(r-g)/delta+4}hue/=6}return target.h=hue,target.s=saturation,target.l=lightness,target}tween(color,time,ease,delay){const _this=this;_this.tweenObj||(_this.tweenObj={v:0}),_this.tweenObj.v=0;let clone=this.clone();return TweenManager.tween(_this.tweenObj,{v:1},time,ease,delay).onUpdate(_=>{_this.copy(clone).lerp(color,_this.tweenObj.v)})}offsetHSL(h,s,l){let hsl=this.getHSL();return hsl.h+=h,hsl.s+=s,hsl.l+=l,this.setHSL(hsl.h,hsl.s,hsl.l),this}add(color){return this.r+=color.r,this.g+=color.g,this.b+=color.b,this}addColors(color1,color2){return this.r=color1.r+color2.r,this.g=color1.g+color2.g,this.b=color1.b+color2.b,this}addScalar(s){return this.r+=s,this.g+=s,this.b+=s,this}sub(color){return this.r=Math.max(0,this.r-color.r),this.g=Math.max(0,this.g-color.g),this.b=Math.max(0,this.b-color.b),this}multiply(color){return this.r*=color.r,this.g*=color.g,this.b*=color.b,this}multiplyScalar(s){return this.r*=s,this.g*=s,this.b*=s,this}invert(){return this.r=1-this.r,this.g=1-this.g,this.b=1-this.b,this}lerp(color,alpha){return this.r+=(color.r-this.r)*alpha,this.g+=(color.g-this.g)*alpha,this.b+=(color.b-this.b)*alpha,this}equals(c){return c.r===this.r&&c.g===this.g&&c.b===this.b}fromArray(array,offset){return void 0===offset&&(offset=0),this.r=array[offset],this.g=array[offset+1],this.b=array[offset+2],this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.r,array[offset+1]=this.g,array[offset+2]=this.b,array}toRGBA(alpha=1){return`rgba(${Math.floor(255*this.r)}, ${Math.floor(255*this.g)}, ${Math.floor(255*this.b)}, ${alpha})`}}class Cylindrical{constructor(radius=1,theta=0,y=0){this.radius=radius,this.theta=theta,this.y=y}set(radius,theta,y){return this.radius=radius,this.theta=theta,this.y=y,this}clone(){return(new this.constructor).copy(this)}copy(other){return this.radius=other.radius,this.theta=other.theta,this.y=other.y,this}setFromVector3(vec3){return this.radius=Math.sqrt(vec3.x*vec3.x+vec3.z*vec3.z),this.theta=Math.atan2(vec3.x,vec3.z),this.y=vec3.y,this}}class Euler{constructor(x,y,z,order){this._x=x||0,this._y=y||0,this._z=z||0,this._order=order||"XYZ",this.isEuler=!0}set x(value){this._x=value,this.onChangeCallback()}get x(){return this._x}set y(value){this._y=value,this.onChangeCallback()}get y(){return this._y}set z(value){this._z=value,this.onChangeCallback()}get z(){return this._z}set order(value){this._order=value,this.onChangeCallback()}get order(){return this._order}set(x,y,z,order){return this._x=x,this._y=y,this._z=z,this._order=order||this._order,this.onChangeCallback(),this}clone(){return new Euler(this._x,this._y,this._z,this._order)}copy(euler){return this._x=euler._x,this._y=euler._y,this._z=euler._z,this._order=euler._order,this.onChangeCallback(),this}setFromRotationMatrix(m,order,update){let clamp=Math.clamp,te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10];return"XYZ"===(order=order||this._order)?(this._y=Math.asin(clamp(m13,-1,1)),Math.abs(m13)<.99999?(this._x=Math.atan2(-m23,m33),this._z=Math.atan2(-m12,m11)):(this._x=Math.atan2(m32,m22),this._z=0)):"YXZ"===order?(this._x=Math.asin(-clamp(m23,-1,1)),Math.abs(m23)<.99999?(this._y=Math.atan2(m13,m33),this._z=Math.atan2(m21,m22)):(this._y=Math.atan2(-m31,m11),this._z=0)):"ZXY"===order?(this._x=Math.asin(clamp(m32,-1,1)),Math.abs(m32)<.99999?(this._y=Math.atan2(-m31,m33),this._z=Math.atan2(-m12,m22)):(this._y=0,this._z=Math.atan2(m21,m11))):"ZYX"===order?(this._y=Math.asin(-clamp(m31,-1,1)),Math.abs(m31)<.99999?(this._x=Math.atan2(m32,m33),this._z=Math.atan2(m21,m11)):(this._x=0,this._z=Math.atan2(-m12,m22))):"YZX"===order?(this._z=Math.asin(clamp(m21,-1,1)),Math.abs(m21)<.99999?(this._x=Math.atan2(-m23,m22),this._y=Math.atan2(-m31,m11)):(this._x=0,this._y=Math.atan2(m13,m33))):"XZY"===order&&(this._z=Math.asin(-clamp(m12,-1,1)),Math.abs(m12)<.99999?(this._x=Math.atan2(m32,m22),this._y=Math.atan2(m13,m11)):(this._x=Math.atan2(-m23,m33),this._y=0)),this._order=order,!1!==update&&this.onChangeCallback(),this}setFromQuaternion(q,order,update){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.makeRotationFromQuaternion(q),this.setFromRotationMatrix(matrix,order,update)}setFromVector3(v,order){return this.set(v.x,v.y,v.z,order||this._order)}reorder(newOrder){let q=this.Q1||new Quaternion;return this.Q1=q,q.setFromEuler(this),this.setFromQuaternion(q,newOrder)}lerp(euler,alpha){this._x+=(euler._x-this._x)*alpha,this._y+=(euler._y-this._y)*alpha,this._z+=(euler._z-this._z)*alpha,this.onChangeCallback()}equals(euler){return euler._x===this._x&&euler._y===this._y&&euler._z===this._z&&euler._order===this._order}fromArray(array){return this._x=array[0],this._y=array[1],this._z=array[2],void 0!==array[3]&&(this._order=array[3]),this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array[offset+3]=this._order,array}toVector3(optionalResult){return optionalResult?optionalResult.set(this._x,this._y,this._z):new Vector3(this._x,this._y,this._z)}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}Euler.DefaultOrder="XYZ",Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class Frustum{constructor(p0,p1,p2,p3,p4,p5){this.planes=[void 0!==p0?p0:new Plane,void 0!==p1?p1:new Plane,void 0!==p2?p2:new Plane,void 0!==p3?p3:new Plane,void 0!==p4?p4:new Plane,void 0!==p5?p5:new Plane]}set(p0,p1,p2,p3,p4,p5){let planes=this.planes;return planes[0].copy(p0),planes[1].copy(p1),planes[2].copy(p2),planes[3].copy(p3),planes[4].copy(p4),planes[5].copy(p5),this}clone(){return(new Frustum).copy(this)}copy(frustum){let planes=this.planes;for(let i=0;i<6;i++)planes[i].copy(frustum.planes[i]);return this}setFromMatrix(m){let planes=this.planes,me=m.elements,me0=me[0],me1=me[1],me2=me[2],me3=me[3],me4=me[4],me5=me[5],me6=me[6],me7=me[7],me8=me[8],me9=me[9],me10=me[10],me11=me[11],me12=me[12],me13=me[13],me14=me[14],me15=me[15];return planes[0].setComponents(me3-me0,me7-me4,me11-me8,me15-me12).normalize(),planes[1].setComponents(me3+me0,me7+me4,me11+me8,me15+me12).normalize(),planes[2].setComponents(me3+me1,me7+me5,me11+me9,me15+me13).normalize(),planes[3].setComponents(me3-me1,me7-me5,me11-me9,me15-me13).normalize(),planes[4].setComponents(me3-me2,me7-me6,me11-me10,me15-me14).normalize(),planes[5].setComponents(me3+me2,me7+me6,me11+me10,me15+me14).normalize(),this}setFromCamera(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse),this.setFromMatrix(matrix)}intersectsObject(object){let sphere=this.S1||new Sphere;this.S1=sphere;let geometry=object.geometry;return null===geometry.boundingSphere&&geometry.computeBoundingSphere(),sphere.copy(geometry.boundingSphere).applyMatrix4(object.matrixWorld),this.intersectsSphere(sphere)}intersectsSphere(sphere){let planes=this.planes,center=sphere.center,negRadius=-sphere.radius;for(let i=0;i<6;i++){if(planes[i].distanceToPoint(center)<negRadius)return!1}return!0}intersectsBox(box){let p1=this.V1||new Vector3,p2=this.V2||new Vector3;this.V1=p1,this.V2=p2;let planes=this.planes;for(let i=0;i<6;i++){let plane=planes[i];p1.x=plane.normal.x>0?box.min.x:box.max.x,p2.x=plane.normal.x>0?box.max.x:box.min.x,p1.y=plane.normal.y>0?box.min.y:box.max.y,p2.y=plane.normal.y>0?box.max.y:box.min.y,p1.z=plane.normal.z>0?box.min.z:box.max.z,p2.z=plane.normal.z>0?box.max.z:box.min.z;let d1=plane.distanceToPoint(p1),d2=plane.distanceToPoint(p2);if(d1<0&&d2<0)return!1}return!0}containsPoint(point){let planes=this.planes;for(let i=0;i<6;i++)if(planes[i].distanceToPoint(point)<0)return!1;return!0}}class Line3{constructor(start=new Vector3,end=new Vector3){this.start=start,this.end=end}set(start,end){return this.start.copy(start),this.end.copy(end),this}clone(){return(new this.constructor).copy(this)}copy(line){return this.start.copy(line.start),this.end.copy(line.end),this}getCenter(target=new Vector3){return target.addVectors(this.start,this.end).multiplyScalar(.5)}delta(target=new Vector3){return target.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,target=new Vector3){return this.delta(target).multiplyScalar(t).add(this.start)}closestPointToPointParameter(point,clampToLine){let startP=this.V1||new Vector3,startEnd=this.V2||new Vector3;this.V1=startP,this.V2=startEnd,startP.subVectors(point,this.start),startEnd.subVectors(this.end,this.start);let startEnd2=startEnd.dot(startEnd),t=startEnd.dot(startP)/startEnd2;return clampToLine&&(t=Math.clamp(t,0,1)),t}closestPointToPoint(point,clampToLine,target=new Vector3){let t=this.closestPointToPointParameter(point,clampToLine);return this.delta(target).multiplyScalar(t).add(this.start)}applyMatrix4(matrix){return this.start.applyMatrix4(matrix),this.end.applyMatrix4(matrix),this}equals(line){return line.start.equals(this.start)&&line.end.equals(this.end)}}class Matrix3{constructor(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}set(n11,n12,n13,n21,n22,n23,n31,n32,n33){let te=this.elements;return te[0]=n11,te[1]=n21,te[2]=n31,te[3]=n12,te[4]=n22,te[5]=n32,te[6]=n13,te[7]=n23,te[8]=n33,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}clone(){return(new Matrix3).fromArray(this.elements)}copy(m){let te=this.elements,me=m.elements;return te[0]=me[0],te[1]=me[1],te[2]=me[2],te[3]=me[3],te[4]=me[4],te[5]=me[5],te[6]=me[6],te[7]=me[7],te[8]=me[8],this}setFromMatrix4(m){let me=m.elements;return this.set(me[0],me[4],me[8],me[1],me[5],me[9],me[2],me[6],me[10]),this}multiply(m){return this.multiplyMatrices(this,m)}premultiply(m){return this.multiplyMatrices(m,this)}multiplyMatrices(a,b){let ae=a.elements,be=b.elements,te=this.elements,a11=ae[0],a12=ae[3],a13=ae[6],a21=ae[1],a22=ae[4],a23=ae[7],a31=ae[2],a32=ae[5],a33=ae[8],b11=be[0],b12=be[3],b13=be[6],b21=be[1],b22=be[4],b23=be[7],b31=be[2],b32=be[5],b33=be[8];return te[0]=a11*b11+a12*b21+a13*b31,te[3]=a11*b12+a12*b22+a13*b32,te[6]=a11*b13+a12*b23+a13*b33,te[1]=a21*b11+a22*b21+a23*b31,te[4]=a21*b12+a22*b22+a23*b32,te[7]=a21*b13+a22*b23+a23*b33,te[2]=a31*b11+a32*b21+a33*b31,te[5]=a31*b12+a32*b22+a33*b32,te[8]=a31*b13+a32*b23+a33*b33,this}multiplyScalar(s){let te=this.elements;return te[0]*=s,te[3]*=s,te[6]*=s,te[1]*=s,te[4]*=s,te[7]*=s,te[2]*=s,te[5]*=s,te[8]*=s,this}determinant(){let te=this.elements,a=te[0],b=te[1],c=te[2],d=te[3],e=te[4],f=te[5],g=te[6],h=te[7],i=te[8];return a*e*i-a*f*h-b*d*i+b*f*g+c*d*h-c*e*g}getInverse(matrix,throwOnDegenerate){let me=matrix.elements,te=this.elements,n11=me[0],n21=me[1],n31=me[2],n12=me[3],n22=me[4],n32=me[5],n13=me[6],n23=me[7],n33=me[8],t11=n33*n22-n32*n23,t12=n32*n13-n33*n12,t13=n23*n12-n22*n13,det=n11*t11+n21*t12+n31*t13;if(0===det){let msg=".getInverse() can't invert matrix, determinant is 0";if(!0===throwOnDegenerate)throw new Error(msg);return this.identity()}let detInv=1/det;return te[0]=t11*detInv,te[1]=(n31*n23-n33*n21)*detInv,te[2]=(n32*n21-n31*n22)*detInv,te[3]=t12*detInv,te[4]=(n33*n11-n31*n13)*detInv,te[5]=(n31*n12-n32*n11)*detInv,te[6]=t13*detInv,te[7]=(n21*n13-n23*n11)*detInv,te[8]=(n22*n11-n21*n12)*detInv,this}transpose(){let tmp,m=this.elements;return tmp=m[1],m[1]=m[3],m[3]=tmp,tmp=m[2],m[2]=m[6],m[6]=tmp,tmp=m[5],m[5]=m[7],m[7]=tmp,this}getNormalMatrix(matrix4){return this.setFromMatrix4(matrix4).getInverse(this).transpose()}setUvTransform(tx,ty,sx,sy,rotation,cx,cy){let c=Math.cos(rotation),s=Math.sin(rotation);this.set(sx*c,sx*s,-sx*(c*cx+s*cy)+cx+tx,-sy*s,sy*c,-sy*(-s*cx+c*cy)+cy+ty,0,0,1)}scale(sx,sy){let te=this.elements;return te[0]*=sx,te[3]*=sx,te[6]*=sx,te[1]*=sy,te[4]*=sy,te[7]*=sy,this}rotate(theta){let c=Math.cos(theta),s=Math.sin(theta),te=this.elements,a11=te[0],a12=te[3],a13=te[6],a21=te[1],a22=te[4],a23=te[7];return te[0]=c*a11+s*a21,te[3]=c*a12+s*a22,te[6]=c*a13+s*a23,te[1]=-s*a11+c*a21,te[4]=-s*a12+c*a22,te[7]=-s*a13+c*a23,this}translate(tx,ty){let te=this.elements;return te[0]+=tx*te[2],te[3]+=tx*te[5],te[6]+=tx*te[8],te[1]+=ty*te[2],te[4]+=ty*te[5],te[7]+=ty*te[8],this}equals(matrix){let te=this.elements,me=matrix.elements;for(let i=0;i<9;i++)if(te[i]!==me[i])return!1;return!0}fromArray(array,offset){void 0===offset&&(offset=0);for(let i=0;i<9;i++)this.elements[i]=array[i+offset];return this}toArray(array,offset){void 0===array&&(array=[]),void 0===offset&&(offset=0);let te=this.elements;return array[offset]=te[0],array[offset+1]=te[1],array[offset+2]=te[2],array[offset+3]=te[3],array[offset+4]=te[4],array[offset+5]=te[5],array[offset+6]=te[6],array[offset+7]=te[7],array[offset+8]=te[8],array}applyToBufferAttribute(attribute){let v1=this.V1||new Vector3;this.V1=v1;for(let i=0,l=attribute.count;i<l;i++)v1.x=attribute.array[3*i+0],v1.y=attribute.array[3*i+1],v1.z=attribute.array[3*i+2],v1.applyMatrix3(this),attribute.array[3*i+0]=v1.x,attribute.array[3*i+1]=v1.y,attribute.array[3*i+2]=v1.z;return attribute}}class Matrix4{constructor(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}set(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){let te=this.elements;return te[0]=n11,te[4]=n12,te[8]=n13,te[12]=n14,te[1]=n21,te[5]=n22,te[9]=n23,te[13]=n24,te[2]=n31,te[6]=n32,te[10]=n33,te[14]=n34,te[3]=n41,te[7]=n42,te[11]=n43,te[15]=n44,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Matrix4).fromArray(this.elements)}copy(m){let te=this.elements,me=m.elements;return te[0]=me[0],te[1]=me[1],te[2]=me[2],te[3]=me[3],te[4]=me[4],te[5]=me[5],te[6]=me[6],te[7]=me[7],te[8]=me[8],te[9]=me[9],te[10]=me[10],te[11]=me[11],te[12]=me[12],te[13]=me[13],te[14]=me[14],te[15]=me[15],this}copyPosition(m){let te=this.elements,me=m.elements;return te[12]=me[12],te[13]=me[13],te[14]=me[14],this}extractBasis(xAxis,yAxis,zAxis){return xAxis.setFromMatrixColumn(this,0),yAxis.setFromMatrixColumn(this,1),zAxis.setFromMatrixColumn(this,2),this}makeBasis(xAxis,yAxis,zAxis){return this.set(xAxis.x,yAxis.x,zAxis.x,0,xAxis.y,yAxis.y,zAxis.y,0,xAxis.z,yAxis.z,zAxis.z,0,0,0,0,1),this}extractRotation(m){let v1=this.V1||new Vector3;this.V1=v1;let te=this.elements,me=m.elements,scaleX=1/v1.setFromMatrixColumn(m,0).length(),scaleY=1/v1.setFromMatrixColumn(m,1).length(),scaleZ=1/v1.setFromMatrixColumn(m,2).length();return te[0]=me[0]*scaleX,te[1]=me[1]*scaleX,te[2]=me[2]*scaleX,te[4]=me[4]*scaleY,te[5]=me[5]*scaleY,te[6]=me[6]*scaleY,te[8]=me[8]*scaleZ,te[9]=me[9]*scaleZ,te[10]=me[10]*scaleZ,this}makeRotationFromEuler(euler){let te=this.elements,x=euler.x,y=euler.y,z=euler.z,a=Math.cos(x),b=Math.sin(x),c=Math.cos(y),d=Math.sin(y),e=Math.cos(z),f=Math.sin(z);if("XYZ"===euler.order){let ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e,te[4]=-c*f,te[8]=d,te[1]=af+be*d,te[5]=ae-bf*d,te[9]=-b*c,te[2]=bf-ae*d,te[6]=be+af*d,te[10]=a*c}else if("YXZ"===euler.order){let ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce+df*b,te[4]=de*b-cf,te[8]=a*d,te[1]=a*f,te[5]=a*e,te[9]=-b,te[2]=cf*b-de,te[6]=df+ce*b,te[10]=a*c}else if("ZXY"===euler.order){let ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce-df*b,te[4]=-a*f,te[8]=de+cf*b,te[1]=cf+de*b,te[5]=a*e,te[9]=df-ce*b,te[2]=-a*d,te[6]=b,te[10]=a*c}else if("ZYX"===euler.order){let ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e,te[4]=be*d-af,te[8]=ae*d+bf,te[1]=c*f,te[5]=bf*d+ae,te[9]=af*d-be,te[2]=-d,te[6]=b*c,te[10]=a*c}else if("YZX"===euler.order){let ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e,te[4]=bd-ac*f,te[8]=bc*f+ad,te[1]=f,te[5]=a*e,te[9]=-b*e,te[2]=-d*e,te[6]=ad*f+bc,te[10]=ac-bd*f}else if("XZY"===euler.order){let ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e,te[4]=-f,te[8]=d*e,te[1]=ac*f+bd,te[5]=a*e,te[9]=ad*f-bc,te[2]=bc*f-ad,te[6]=b*e,te[10]=bd*f+ac}return te[3]=0,te[7]=0,te[11]=0,te[12]=0,te[13]=0,te[14]=0,te[15]=1,this}makeRotationFromQuaternion(q){let te=this.elements,x=q._x,y=q._y,z=q._z,w=q._w;if(window.NativeUtils&&NativeUtils.makeRotationFromQuaternion)NativeUtils.makeRotationFromQuaternion(te,x,y,z,w);else{let x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;te[0]=1-(yy+zz),te[4]=xy-wz,te[8]=xz+wy,te[1]=xy+wz,te[5]=1-(xx+zz),te[9]=yz-wx,te[2]=xz-wy,te[6]=yz+wx,te[10]=1-(xx+yy),te[3]=0,te[7]=0,te[11]=0,te[12]=0,te[13]=0,te[14]=0,te[15]=1}return this}lookAt(eye,target,up){let x=this.V1||new Vector3,y=this.V2||new Vector3,z=this.V3||new Vector3;this.V1=x,this.V2=y,this.V3=z;let te=this.elements;return z.subVectors(eye,target),0===z.lengthSq()&&(z.z=1),z.normalize(),x.crossVectors(up,z),0===x.lengthSq()&&(1===Math.abs(up.z)?z.x+=1e-4:z.z+=1e-4,z.normalize(),x.crossVectors(up,z)),x.normalize(),y.crossVectors(z,x),te[0]=x.x,te[4]=y.x,te[8]=z.x,te[1]=x.y,te[5]=y.y,te[9]=z.y,te[2]=x.z,te[6]=y.z,te[10]=z.z,this}multiply(m){return this.multiplyMatrices(this,m)}premultiply(m){return this.multiplyMatrices(m,this)}multiplyMatrices(a,b){let ae=a.elements,be=b.elements,te=this.elements;if(window.NativeUtils&&NativeUtils.multiplyMatrices)NativeUtils.multiplyMatrices(ae,be,te);else{let a11=ae[0],a12=ae[4],a13=ae[8],a14=ae[12],a21=ae[1],a22=ae[5],a23=ae[9],a24=ae[13],a31=ae[2],a32=ae[6],a33=ae[10],a34=ae[14],a41=ae[3],a42=ae[7],a43=ae[11],a44=ae[15],b11=be[0],b12=be[4],b13=be[8],b14=be[12],b21=be[1],b22=be[5],b23=be[9],b24=be[13],b31=be[2],b32=be[6],b33=be[10],b34=be[14],b41=be[3],b42=be[7],b43=be[11],b44=be[15];te[0]=a11*b11+a12*b21+a13*b31+a14*b41,te[4]=a11*b12+a12*b22+a13*b32+a14*b42,te[8]=a11*b13+a12*b23+a13*b33+a14*b43,te[12]=a11*b14+a12*b24+a13*b34+a14*b44,te[1]=a21*b11+a22*b21+a23*b31+a24*b41,te[5]=a21*b12+a22*b22+a23*b32+a24*b42,te[9]=a21*b13+a22*b23+a23*b33+a24*b43,te[13]=a21*b14+a22*b24+a23*b34+a24*b44,te[2]=a31*b11+a32*b21+a33*b31+a34*b41,te[6]=a31*b12+a32*b22+a33*b32+a34*b42,te[10]=a31*b13+a32*b23+a33*b33+a34*b43,te[14]=a31*b14+a32*b24+a33*b34+a34*b44,te[3]=a41*b11+a42*b21+a43*b31+a44*b41,te[7]=a41*b12+a42*b22+a43*b32+a44*b42,te[11]=a41*b13+a42*b23+a43*b33+a44*b43,te[15]=a41*b14+a42*b24+a43*b34+a44*b44}return this}multiplyScalar(s){let te=this.elements;return te[0]*=s,te[4]*=s,te[8]*=s,te[12]*=s,te[1]*=s,te[5]*=s,te[9]*=s,te[13]*=s,te[2]*=s,te[6]*=s,te[10]*=s,te[14]*=s,te[3]*=s,te[7]*=s,te[11]*=s,te[15]*=s,this}determinant(){let te=this.elements,n11=te[0],n12=te[4],n13=te[8],n14=te[12],n21=te[1],n22=te[5],n23=te[9],n24=te[13],n31=te[2],n32=te[6],n33=te[10],n34=te[14];return te[3]*(+n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34)+te[7]*(+n11*n23*n34-n11*n24*n33+n14*n21*n33-n13*n21*n34+n13*n24*n31-n14*n23*n31)+te[11]*(+n11*n24*n32-n11*n22*n34-n14*n21*n32+n12*n21*n34+n14*n22*n31-n12*n24*n31)+te[15]*(-n13*n22*n31-n11*n23*n32+n11*n22*n33+n13*n21*n32-n12*n21*n33+n12*n23*n31)}transpose(){let tmp,te=this.elements;return tmp=te[1],te[1]=te[4],te[4]=tmp,tmp=te[2],te[2]=te[8],te[8]=tmp,tmp=te[6],te[6]=te[9],te[9]=tmp,tmp=te[3],te[3]=te[12],te[12]=tmp,tmp=te[7],te[7]=te[13],te[13]=tmp,tmp=te[11],te[11]=te[14],te[14]=tmp,this}setPosition(v){let te=this.elements;return te[12]=v.x,te[13]=v.y,te[14]=v.z,this}getInverse(m,throwOnDegenerate){let te=this.elements,me=m.elements,n11=me[0],n21=me[1],n31=me[2],n41=me[3],n12=me[4],n22=me[5],n32=me[6],n42=me[7],n13=me[8],n23=me[9],n33=me[10],n43=me[11],n14=me[12],n24=me[13],n34=me[14],n44=me[15],t11=n23*n34*n42-n24*n33*n42+n24*n32*n43-n22*n34*n43-n23*n32*n44+n22*n33*n44,t12=n14*n33*n42-n13*n34*n42-n14*n32*n43+n12*n34*n43+n13*n32*n44-n12*n33*n44,t13=n13*n24*n42-n14*n23*n42+n14*n22*n43-n12*n24*n43-n13*n22*n44+n12*n23*n44,t14=n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34,det=n11*t11+n21*t12+n31*t13+n41*t14;if(0===det){let msg=".getInverse() can't invert matrix, determinant is 0";if(!0===throwOnDegenerate)throw new Error(msg);return this.identity()}let detInv=1/det;return te[0]=t11*detInv,te[1]=(n24*n33*n41-n23*n34*n41-n24*n31*n43+n21*n34*n43+n23*n31*n44-n21*n33*n44)*detInv,te[2]=(n22*n34*n41-n24*n32*n41+n24*n31*n42-n21*n34*n42-n22*n31*n44+n21*n32*n44)*detInv,te[3]=(n23*n32*n41-n22*n33*n41-n23*n31*n42+n21*n33*n42+n22*n31*n43-n21*n32*n43)*detInv,te[4]=t12*detInv,te[5]=(n13*n34*n41-n14*n33*n41+n14*n31*n43-n11*n34*n43-n13*n31*n44+n11*n33*n44)*detInv,te[6]=(n14*n32*n41-n12*n34*n41-n14*n31*n42+n11*n34*n42+n12*n31*n44-n11*n32*n44)*detInv,te[7]=(n12*n33*n41-n13*n32*n41+n13*n31*n42-n11*n33*n42-n12*n31*n43+n11*n32*n43)*detInv,te[8]=t13*detInv,te[9]=(n14*n23*n41-n13*n24*n41-n14*n21*n43+n11*n24*n43+n13*n21*n44-n11*n23*n44)*detInv,te[10]=(n12*n24*n41-n14*n22*n41+n14*n21*n42-n11*n24*n42-n12*n21*n44+n11*n22*n44)*detInv,te[11]=(n13*n22*n41-n12*n23*n41-n13*n21*n42+n11*n23*n42+n12*n21*n43-n11*n22*n43)*detInv,te[12]=t14*detInv,te[13]=(n13*n24*n31-n14*n23*n31+n14*n21*n33-n11*n24*n33-n13*n21*n34+n11*n23*n34)*detInv,te[14]=(n14*n22*n31-n12*n24*n31-n14*n21*n32+n11*n24*n32+n12*n21*n34-n11*n22*n34)*detInv,te[15]=(n12*n23*n31-n13*n22*n31+n13*n21*n32-n11*n23*n32-n12*n21*n33+n11*n22*n33)*detInv,this}scale(v){let te=this.elements,x=v.x,y=v.y,z=v.z;return window.NativeUtils&&NativeUtils.scaleMatrix?NativeUtils.scaleMatrix(te,x,y,z):(te[0]*=x,te[4]*=y,te[8]*=z,te[1]*=x,te[5]*=y,te[9]*=z,te[2]*=x,te[6]*=y,te[10]*=z,te[3]*=x,te[7]*=y,te[11]*=z),this}getMaxScaleOnAxis(){let te=this.elements;if(window.NativeUtils&&NativeUtils.getMaxScaleOnAxis)return NativeUtils.getMaxScaleOnAxis(te);{let scaleXSq=te[0]*te[0]+te[1]*te[1]+te[2]*te[2],scaleYSq=te[4]*te[4]+te[5]*te[5]+te[6]*te[6],scaleZSq=te[8]*te[8]+te[9]*te[9]+te[10]*te[10];return Math.sqrt(Math.max(scaleXSq,scaleYSq,scaleZSq))}}makeTranslation(x,y,z){return this.set(1,0,0,x,0,1,0,y,0,0,1,z,0,0,0,1),this}makeRotationX(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1),this}makeRotationY(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1),this}makeRotationZ(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(c,-s,0,0,s,c,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(axis,angle){let c=Math.cos(angle),s=Math.sin(angle),t=1-c,x=axis.x,y=axis.y,z=axis.z,tx=t*x,ty=t*y;return this.set(tx*x+c,tx*y-s*z,tx*z+s*y,0,tx*y+s*z,ty*y+c,ty*z-s*x,0,tx*z-s*y,ty*z+s*x,t*z*z+c,0,0,0,0,1),this}makeScale(x,y,z){return this.set(x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1),this}makeShear(x,y,z){return this.set(1,y,z,0,x,1,z,0,x,y,1,0,0,0,0,1),this}compose(position,quaternion,scale){return this.makeRotationFromQuaternion(quaternion),this.scale(scale),this.setPosition(position),this}decompose(position,quaternion,scale){let vector=this.V1||new Vector3;this.V1=vector;let matrix=this.M1||new Matrix4;this.M1=matrix;let te=this.elements,sx=vector.set(te[0],te[1],te[2]).length(),sy=vector.set(te[4],te[5],te[6]).length(),sz=vector.set(te[8],te[9],te[10]).length();this.determinant()<0&&(sx=-sx),position.x=te[12],position.y=te[13],position.z=te[14],matrix.copy(this);let invSX=1/sx,invSY=1/sy,invSZ=1/sz;return matrix.elements[0]*=invSX,matrix.elements[1]*=invSX,matrix.elements[2]*=invSX,matrix.elements[4]*=invSY,matrix.elements[5]*=invSY,matrix.elements[6]*=invSY,matrix.elements[8]*=invSZ,matrix.elements[9]*=invSZ,matrix.elements[10]*=invSZ,quaternion.setFromRotationMatrix(matrix),scale.x=sx,scale.y=sy,scale.z=sz,this}makePerspective(left,right,top,bottom,near,far){let te=this.elements,x=2*near/(right-left),y=2*near/(top-bottom),a=(right+left)/(right-left),b=(top+bottom)/(top-bottom),c=-(far+near)/(far-near),d=-2*far*near/(far-near);return te[0]=x,te[4]=0,te[8]=a,te[12]=0,te[1]=0,te[5]=y,te[9]=b,te[13]=0,te[2]=0,te[6]=0,te[10]=c,te[14]=d,te[3]=0,te[7]=0,te[11]=-1,te[15]=0,this}makeOrthographic(left,right,top,bottom,near,far){let te=this.elements,w=1/(right-left),h=1/(top-bottom),p=1/(far-near),x=(right+left)*w,y=(top+bottom)*h,z=(far+near)*p;return te[0]=2*w,te[4]=0,te[8]=0,te[12]=-x,te[1]=0,te[5]=2*h,te[9]=0,te[13]=-y,te[2]=0,te[6]=0,te[10]=-2*p,te[14]=-z,te[3]=0,te[7]=0,te[11]=0,te[15]=1,this}equals(matrix){let te=this.elements,me=matrix.elements;if(window.NativeUtils&&NativeUtils.arrayEquals)return NativeUtils.arrayEquals(te,me);for(let i=0;i<16;i++)if(te[i]!==me[i])return!1;return!0}fromArray(array,offset){void 0===offset&&(offset=0);for(let i=0;i<16;i++)this.elements[i]=array[i+offset];return this}toArray(array,offset){void 0===array&&(array=[]),void 0===offset&&(offset=0);let te=this.elements;return array[offset]=te[0],array[offset+1]=te[1],array[offset+2]=te[2],array[offset+3]=te[3],array[offset+4]=te[4],array[offset+5]=te[5],array[offset+6]=te[6],array[offset+7]=te[7],array[offset+8]=te[8],array[offset+9]=te[9],array[offset+10]=te[10],array[offset+11]=te[11],array[offset+12]=te[12],array[offset+13]=te[13],array[offset+14]=te[14],array[offset+15]=te[15],array}applyToBufferAttribute(attribute){let v1=this.V1||new Vector3;this.V1=v1;for(let i=0,l=attribute.count;i<l;i++)v1.x=attribute.array[3*i+0],v1.y=attribute.array[3*i+1],v1.z=attribute.array[3*i+2],v1.applyMatrix4(this),attribute.array[3*i+0]=v1.x,attribute.array[3*i+1]=v1.y,attribute.array[3*i+2]=v1.z;return attribute}isIdentity(){return this.equals(Matrix4.__IDENTITY__)}}Matrix4.__IDENTITY__=new Matrix4;class Plane{constructor(normal,constant){this.normal=void 0!==normal?normal:new Vector3(1,0,0),this.constant=void 0!==constant?constant:0}set(normal,constant){return this.normal.copy(normal),this.constant=constant,this}setComponents(x,y,z,w){return this.normal.set(x,y,z),this.constant=w,this}setFromNormalAndCoplanarPoint(normal,point){return this.normal.copy(normal),this.constant=-point.dot(this.normal),this}setFromCoplanarPoints(a,b,c){let v1=this.V1||new Vector3,v2=this.V2||new Vector3;this.V1=v1,this.V2=v2;var normal=v1.subVectors(c,b).cross(v2.subVectors(a,b)).normalize();return this.setFromNormalAndCoplanarPoint(normal,a),this}clone(){return(new Plane).copy(this)}copy(plane){return this.normal.copy(plane.normal),this.constant=plane.constant,this}normalize(){var inverseNormalLength=1/this.normal.length();return this.normal.multiplyScalar(inverseNormalLength),this.constant*=inverseNormalLength,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(point){return this.normal.dot(point)+this.constant}distanceToSphere(sphere){return this.distanceToPoint(sphere.center)-sphere.radius}projectPoint(point,target){return target.copy(this.normal).multiplyScalar(-this.distanceToPoint(point)).add(point)}intersectLine(line,target){let v1=this.V1||new Vector3;this.V1=v1;var direction=line.delta(v1),denominator=this.normal.dot(direction);if(0===denominator)return 0===this.distanceToPoint(line.start)?target.copy(line.start):void 0;var t=-(line.start.dot(this.normal)+this.constant)/denominator;return t<0||t>1?void 0:target.copy(direction).multiplyScalar(t).add(line.start)}intersectsLine(line){var startSign=this.distanceToPoint(line.start),endSign=this.distanceToPoint(line.end);return startSign<0&&endSign>0||endSign<0&&startSign>0}intersectsBox(box){return box.intersectsPlane(this)}intersectsSphere(sphere){return sphere.intersectsPlane(this)}coplanarPoint(target){return target.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(matrix,optionalNormalMatrix){let v1=this.V1||new Vector3;this.V1=v1;let m1=this.M1||new Matrix3;this.M1=m1;var normalMatrix=optionalNormalMatrix||m1.getNormalMatrix(matrix),referencePoint=this.coplanarPoint(v1).applyMatrix4(matrix),normal=this.normal.applyMatrix3(normalMatrix).normalize();return this.constant=-referencePoint.dot(normal),this}translate(offset){return this.constant-=offset.dot(this.normal),this}equals(plane){return plane.normal.equals(this.normal)&&plane.constant===this.constant}}class Quaternion{constructor(x,y,z,w){this._x=x||0,this._y=y||0,this._z=z||0,this._w=void 0!==w?w:1}set x(v){this._x=v,this.onChangeCallback&&this.onChangeCallback()}get x(){return this._x}set y(v){this._y=v,this.onChangeCallback&&this.onChangeCallback()}get y(){return this._y}set z(v){this._z=v,this.onChangeCallback&&this.onChangeCallback()}get z(){return this._z}set w(v){this._w=v,this.onChangeCallback&&this.onChangeCallback()}get w(){return this._w}clone(){return new Quaternion(this._x,this._y,this._z,this._w)}copy(quaternion){return this._x=quaternion.x,this._y=quaternion.y,this._z=quaternion.z,this._w=quaternion.w,this.onChangeCallback(),this}set(x,y,z,w){this._x=x,this._y=y,this._z=z,this._w=w,this.onChangeCallback()}setFromEuler(euler,update){let x=euler._x,y=euler._y,z=euler._z,order=euler.order,cos=Math.cos,sin=Math.sin,c1=cos(x/2),c2=cos(y/2),c3=cos(z/2),s1=sin(x/2),s2=sin(y/2),s3=sin(z/2);return"XYZ"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"YXZ"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3):"ZXY"===order?(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"ZYX"===order?(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3):"YZX"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"XZY"===order&&(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3),!1!==update&&this.onChangeCallback(),this}setFromAxisAngle(axis,angle){let halfAngle=angle/2,s=Math.sin(halfAngle);return this._x=axis.x*s,this._y=axis.y*s,this._z=axis.z*s,this._w=Math.cos(halfAngle),this.onChangeCallback(),this}setFromRotationMatrix(m){let s,te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10],trace=m11+m22+m33;return trace>0?(s=.5/Math.sqrt(trace+1),this._w=.25/s,this._x=(m32-m23)*s,this._y=(m13-m31)*s,this._z=(m21-m12)*s):m11>m22&&m11>m33?(s=2*Math.sqrt(1+m11-m22-m33),this._w=(m32-m23)/s,this._x=.25*s,this._y=(m12+m21)/s,this._z=(m13+m31)/s):m22>m33?(s=2*Math.sqrt(1+m22-m11-m33),this._w=(m13-m31)/s,this._x=(m12+m21)/s,this._y=.25*s,this._z=(m23+m32)/s):(s=2*Math.sqrt(1+m33-m11-m22),this._w=(m21-m12)/s,this._x=(m13+m31)/s,this._y=(m23+m32)/s,this._z=.25*s),this.onChangeCallback(),this}setFromUnitVectors(vFrom,vTo){let v1=this.V1||new Vector3;this.V1=v1;let r=vFrom.dot(vTo)+1;return r<1e-6?(r=0,Math.abs(vFrom.x)>Math.abs(vFrom.z)?v1.set(-vFrom.y,vFrom.x,0):v1.set(0,-vFrom.z,vFrom.y)):v1.crossVectors(vFrom,vTo),this._x=v1.x,this._y=v1.y,this._z=v1.z,this._w=r,this.normalize()}inverse(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this}dot(v){return this._x*v._x+this._y*v._y+this._z*v._z+this._w*v._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let l=this.length();return 0===l?(this._x=0,this._y=0,this._z=0,this._w=1):(l=1/l,this._x=this._x*l,this._y=this._y*l,this._z=this._z*l,this._w=this._w*l),this.onChangeCallback(),this}multiply(q){return this.multiplyQuaternions(this,q)}premultiply(q){return this.multiplyQuaternions(q,this)}multiplyQuaternions(a,b){let qax=a._x,qay=a._y,qaz=a._z,qaw=a._w,qbx=b._x,qby=b._y,qbz=b._z,qbw=b._w;return this._x=qax*qbw+qaw*qbx+qay*qbz-qaz*qby,this._y=qay*qbw+qaw*qby+qaz*qbx-qax*qbz,this._z=qaz*qbw+qaw*qbz+qax*qby-qay*qbx,this._w=qaw*qbw-qax*qbx-qay*qby-qaz*qbz,this.onChangeCallback(),this}slerp(qb,t,hz=!0){if(0===(t=Math.clamp(t*(hz?Render.HZ_MULTIPLIER:1),0,1)))return this;if(1===t)return this.copy(qb);let x=this._x,y=this._y,z=this._z,w=this._w,cosHalfTheta=w*qb._w+x*qb._x+y*qb._y+z*qb._z;if(cosHalfTheta<0?(this._w=-qb._w,this._x=-qb._x,this._y=-qb._y,this._z=-qb._z,cosHalfTheta=-cosHalfTheta):this.copy(qb),cosHalfTheta>=1)return this._w=w,this._x=x,this._y=y,this._z=z,this;let sinHalfTheta=Math.sqrt(1-cosHalfTheta*cosHalfTheta);if(Math.abs(sinHalfTheta)<.001)return this._w=.5*(w+this._w),this._x=.5*(x+this._x),this._y=.5*(y+this._y),this._z=.5*(z+this._z),this;let halfTheta=Math.atan2(sinHalfTheta,cosHalfTheta),ratioA=Math.sin((1-t)*halfTheta)/sinHalfTheta,ratioB=Math.sin(t*halfTheta)/sinHalfTheta;return this._w=w*ratioA+this._w*ratioB,this._x=x*ratioA+this._x*ratioB,this._y=y*ratioA+this._y*ratioB,this._z=z*ratioA+this._z*ratioB,this.onChangeCallback(),this}equals(quaternion){return quaternion._x===this._x&&quaternion._y===this._y&&quaternion._z===this._z&&quaternion._w===this._w}fromArray(array,offset){return void 0===offset&&(offset=0),this._x=array[offset],this._y=array[offset+1],this._z=array[offset+2],this._w=array[offset+3],this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array[offset+3]=this._w,array}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}class RayManager{constructor(origin,direction,near=0,far=1/0){this.ray=new Ray(origin,direction),this.near=near,this.far=far,this.params={Mesh:{},Points:{threshold:1}}}set(origin,direction){return this.ray.set(origin,direction),this}setFromCamera(coords,camera){camera.isPerspective?(this.ray.origin.setFromMatrixPosition(camera.matrixWorld),this.ray.direction.set(coords.x,coords.y,.5).unproject(camera).sub(this.ray.origin).normalize()):(this.ray.origin.set(coords.x,coords.y,(camera.near+camera.far)/(camera.near-camera.far)).unproject(camera),this.ray.direction.set(0,0,-1).transformDirection(camera.matrixWorld))}_ascSort(a,b){return a.distance-b.distance}_intersectObject(object,raycaster,intersects,recursive){if(!1!==object.visible&&(object.raycast(raycaster,intersects),!0===recursive)){let children=object.children;for(let i=0,l=children.length;i<l;i++)this._intersectObject(children[i],raycaster,intersects,!0)}}intersectObject(object,recursive,optionalTarget){let intersects=optionalTarget||[];return this._intersectObject(object,this,intersects,recursive),intersects.sort(this._ascSort),intersects}intersectObjects(objects,recursive,optionalTarget){let intersects=optionalTarget||[];for(let i=0,l=objects.length;i<l;i++)this._intersectObject(objects[i],this,intersects,recursive);return intersects.sort(this._ascSort),intersects}}class Ray{constructor(origin=new Vector3,direction=new Vector3){this.origin=origin,this.direction=direction}set(origin,direction){return this.origin.copy(origin),this.direction.copy(direction),this}clone(){return(new Ray).copy(this)}copy(ray){return this.origin.copy(ray.origin),this.direction.copy(ray.direction),this}at(t,target=new Vector3){return target.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(v){return this.direction.copy(v).sub(this.origin).normalize(),this}recast(t){let v1=this.V1||new Vector3;this.V1=v1,this.origin.copy(this.at(t,v1))}closestPointToPoint(point,target=new Vector3){target.subVectors(point,this.origin);let directionDistance=target.dot(this.direction);return directionDistance<0?target.copy(this.origin):target.copy(this.direction).multiplyScalar(directionDistance).add(this.origin)}distanceToPoint(point){return Math.sqrt(this.distanceSqToPoint(point))}distanceSqToPoint(point){let v1=this.V1||new Vector3;this.V1=v1;let directionDistance=v1.subVectors(point,this.origin).dot(this.direction);return directionDistance<0?this.origin.distanceToSquared(point):(v1.copy(this.direction).multiplyScalar(directionDistance).add(this.origin),v1.distanceToSquared(point))}distanceSqToSegment(v0,v1,optionalPointOnRay,optionalPointOnSegment){let segCenter=this.V1||new Vector3,segDir=this.V2||new Vector3,diff=this.V3||new Vector3;this.V1=segCenter,this.V2=segDir,this.V3=diff,segCenter.copy(v0).add(v1).multiplyScalar(.5),segDir.copy(v1).sub(v0).normalize(),diff.copy(this.origin).sub(segCenter);let s0,s1,sqrDist,extDet,segExtent=.5*v0.distanceTo(v1),a01=-this.direction.dot(segDir),b0=diff.dot(this.direction),b1=-diff.dot(segDir),c=diff.lengthSq(),det=Math.abs(1-a01*a01);if(det>0)if(s0=a01*b1-b0,s1=a01*b0-b1,extDet=segExtent*det,s0>=0)if(s1>=-extDet)if(s1<=extDet){let invDet=1/det;s0*=invDet,s1*=invDet,sqrDist=s0*(s0+a01*s1+2*b0)+s1*(a01*s0+s1+2*b1)+c}else s1=segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;else s1=-segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;else s1<=-extDet?(s0=Math.max(0,-(-a01*segExtent+b0)),s1=s0>0?-segExtent:Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=-s0*s0+s1*(s1+2*b1)+c):s1<=extDet?(s0=0,s1=Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=s1*(s1+2*b1)+c):(s0=Math.max(0,-(a01*segExtent+b0)),s1=s0>0?segExtent:Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=-s0*s0+s1*(s1+2*b1)+c);else s1=a01>0?-segExtent:segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;return optionalPointOnRay&&optionalPointOnRay.copy(this.direction).multiplyScalar(s0).add(this.origin),optionalPointOnSegment&&optionalPointOnSegment.copy(segDir).multiplyScalar(s1).add(segCenter),sqrDist}intersectSphere(sphere,target){let v1=this.V1||new Vector3;this.V1=v1,v1.subVectors(sphere.center,this.origin);let tca=v1.dot(this.direction),d2=v1.dot(v1)-tca*tca,radius2=sphere.radius*sphere.radius;if(d2>radius2)return null;let thc=Math.sqrt(radius2-d2),t0=tca-thc,t1=tca+thc;return t0<0&&t1<0?null:t0<0?this.at(t1,target):this.at(t0,target)}intersectsSphere(sphere){return this.distanceSqToPoint(sphere.center)<=sphere.radius*sphere.radius}distanceToPlane(plane){let denominator=plane.normal.dot(this.direction);if(0===denominator)return 0===plane.distanceToPoint(this.origin)?0:null;let t=-(this.origin.dot(plane.normal)+plane.constant)/denominator;return t>=0?t:null}intersectPlane(plane,target){let t=this.distanceToPlane(plane);return null===t?null:this.at(t,target)}intersectsPlane(plane){let distToPoint=plane.distanceToPoint(this.origin);return 0===distToPoint||plane.normal.dot(this.direction)*distToPoint<0}intersectBox(box,target){let tmin,tmax,tymin,tymax,tzmin,tzmax,invdirx=1/this.direction.x,invdiry=1/this.direction.y,invdirz=1/this.direction.z,origin=this.origin;return invdirx>=0?(tmin=(box.min.x-origin.x)*invdirx,tmax=(box.max.x-origin.x)*invdirx):(tmin=(box.max.x-origin.x)*invdirx,tmax=(box.min.x-origin.x)*invdirx),invdiry>=0?(tymin=(box.min.y-origin.y)*invdiry,tymax=(box.max.y-origin.y)*invdiry):(tymin=(box.max.y-origin.y)*invdiry,tymax=(box.min.y-origin.y)*invdiry),tmin>tymax||tymin>tmax?null:((tymin>tmin||tmin!=tmin)&&(tmin=tymin),(tymax<tmax||tmax!=tmax)&&(tmax=tymax),invdirz>=0?(tzmin=(box.min.z-origin.z)*invdirz,tzmax=(box.max.z-origin.z)*invdirz):(tzmin=(box.max.z-origin.z)*invdirz,tzmax=(box.min.z-origin.z)*invdirz),tmin>tzmax||tzmin>tmax?null:((tzmin>tmin||tmin!=tmin)&&(tmin=tzmin),(tzmax<tmax||tmax!=tmax)&&(tmax=tzmax),tmax<0?null:this.at(tmin>=0?tmin:tmax,target)))}intersectsBox(box){let v=this.V1||new Vector3;return this.V1=v,null!==this.intersectBox(box,v)}intersectsTriangle(a,b,c,backfaceCulling,target){let diff=this.V1||new Vector3,edge1=this.V2||new Vector3,edge2=this.V3||new Vector3,normal=this.V4||new Vector3;this.V1=diff,this.V2=edge1,this.V3=edge2,this.V4=normal,edge1.subVectors(b,a),edge2.subVectors(c,a),normal.crossVectors(edge1,edge2);let sign,DdN=this.direction.dot(normal);if(DdN>0){if(backfaceCulling)return null;sign=1}else{if(!(DdN<0))return null;sign=-1,DdN=-DdN}diff.subVectors(this.origin,a);let DdQxE2=sign*this.direction.dot(edge2.crossVectors(diff,edge2));if(DdQxE2<0)return null;let DdE1xQ=sign*this.direction.dot(edge1.cross(diff));if(DdE1xQ<0)return null;if(DdQxE2+DdE1xQ>DdN)return null;let QdN=-sign*diff.dot(normal);return QdN<0?null:this.at(QdN/DdN,target)}applyMatrix4(matrix4){return this.origin.applyMatrix4(matrix4),this.direction.transformDirection(matrix4),this}equals(ray){return ray.origin.equals(this.origin)&&ray.direction.equals(this.direction)}}class Sphere{constructor(center=new Vector3,radius=0){this.center=center,this.radius=radius}set(center,radius){return this.center.copy(center),this.radius=radius,this}setFromPoints(points,optionalCenter){let box=this.V1||new Box3;this.V1=box;let center=this.center;void 0!==optionalCenter?center.copy(optionalCenter):box.setFromPoints(points).getCenter(center);let maxRadiusSq=0;for(let i=0,il=points.length;i<il;i++)maxRadiusSq=Math.max(maxRadiusSq,center.distanceToSquared(points[i]));return this.radius=Math.sqrt(maxRadiusSq),this}clone(){return(new this.constructor).copy(this)}copy(sphere){return this.center.copy(sphere.center),this.radius=sphere.radius,this}empty(){return this.radius<=0}containsPoint(point){return point.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(point){return point.distanceTo(this.center)-this.radius}intersectsSphere(sphere){let radiusSum=this.radius+sphere.radius;return sphere.center.distanceToSquared(this.center)<=radiusSum*radiusSum}intersectsBox(box){return box.intersectsSphere(this)}intersectsPlane(plane){return Math.abs(plane.distanceToPoint(this.center))<=this.radius}clampPoint(point,target=new Vector3){let deltaLengthSq=this.center.distanceToSquared(point);return target.copy(point),deltaLengthSq>this.radius*this.radius&&(target.sub(this.center).normalize(),target.multiplyScalar(this.radius).add(this.center)),target}getBoundingBox(target=new Box3){return target.set(this.center,this.center),target.expandByScalar(this.radius),target}applyMatrix4(matrix){return this.center.applyMatrix4(matrix),this.radius=this.radius*matrix.getMaxScaleOnAxis(),this}translate(offset){return this.center.add(offset),this}equals(sphere){return sphere.center.equals(this.center)&&sphere.radius===this.radius}}class Spherical{constructor(radius=1,phi=0,theta=0){this.radius=radius,this.phi=phi,this.theta=theta}set(radius,phi,theta){return this.radius=radius,this.phi=phi,this.theta=theta,this}clone(){return(new Spherical).copy(this)}copy(other){return this.radius=other.radius,this.phi=other.phi,this.theta=other.theta,this}makeSafe(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this}setFromVector3(vec3){return this.radius=vec3.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(vec3.x,vec3.z),this.phi=Math.acos(Math.clamp(vec3.y/this.radius,-1,1))),this}}class Triangle{constructor(a=new Vector3,b=new Vector3,c=new Vector3){this.a=a,this.b=b,this.c=c}set(a,b,c){return this.a.copy(a),this.b.copy(b),this.c.copy(c),this}setFromPointsAndIndices(points,i0,i1,i2){return this.a.copy(points[i0]),this.b.copy(points[i1]),this.c.copy(points[i2]),this}clone(){return(new Triangle).copy(this)}copy(triangle){return this.a.copy(triangle.a),this.b.copy(triangle.b),this.c.copy(triangle.c),this}getArea(){let v0=this.V0||new Vector3,v1=this.V1||new Vector3;return this.V0=v0,this.V1=v1,v0.subVectors(this.c,this.b),v1.subVectors(this.a,this.b),.5*v0.cross(v1).length()}getMidpoint(target=new Vector3){return target.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(target){return Triangle.getNormal(this.a,this.b,this.c,target)}getPlane(target=new Vector3){return target.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(point,target){return Triangle.getBarycoord(point,this.a,this.b,this.c,target)}containsPoint(point){return Triangle.containsPoint(point,this.a,this.b,this.c)}intersectsBox(box){return box.intersectsTriangle(this)}equals(triangle){return triangle.a.equals(this.a)&&triangle.b.equals(this.b)&&triangle.c.equals(this.c)}}class Vector2{constructor(x=0,y=0){this.x=x,this.y=y}set(x,y){return this.x=x,this.y=y,this}get width(){return this.x}get height(){return this.y}setScalar(s){return this.x=this.y=s,this}clone(){return new Vector2(this.x,this.y)}copy(v){return this.x=v.x,this.y=v.y,this}add(v){return this.x+=v.x,this.y+=v.y,this}addScalar(s){return this.x+=s,this.y+=s,this}addVectors(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this}addScaledVector(v,s){return this.x+=v.x*s,this.y+=v.y*s,this}sub(v){return this.x-=v.x,this.y-=v.y,this}subScalar(s){return this.x-=s,this.y-=s,this}subVectors(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this}multiply(v){return this.x*=v.x,this.y*=v.y,this}multiplyScalar(scalar){return this.x*=scalar,this.y*=scalar,this}divide(v){return this.x/=v.x,this.y/=v.y,this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}applyMatrix3(m){let x=this.x,y=this.y,e=m.elements;return this.x=e[0]*x+e[3]*y+e[6],this.y=e[1]*x+e[4]*y+e[7],this}min(v){return this.x=Math.min(this.x,v.x),this.y=Math.min(this.y,v.y),this}max(v){return this.x=Math.max(this.x,v.x),this.y=Math.max(this.y,v.y),this}clamp(min,max){return this.x=Math.max(min.x,Math.min(max.x,this.x)),this.y=Math.max(min.y,Math.min(max.y,this.y)),this}clampScalar(minVal,maxVal){let min=new Vector2,max=new Vector2;return min.set(minVal,minVal),max.set(maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(v){return this.x*v.x+this.y*v.y}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){let angle=Math.atan2(this.y,this.x);return angle<0&&(angle+=2*Math.PI),angle}angleTo(a,b){return b||(b=this),Math.atan2(a.y-b.y,a.x-b.x)}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this.x-v.x,dy=this.y-v.y;return dx*dx+dy*dy}manhattanDistanceTo(v){return Math.abs(this.x-v.x)+Math.abs(this.y-v.y)}setLength(length){return this.normalize().multiplyScalar(length)}lerp(v,alpha,hz){return this.x=Math.lerp(v.x,this.x,alpha,hz),this.y=Math.lerp(v.y,this.y,alpha,hz),this}lerpVectors(v1,v2,alpha){return this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}equals(v){return v.x===this.x&&v.y===this.y}setAngleRadius(a,r){return this.x=Math.cos(a)*r,this.y=Math.sin(a)*r,this}addAngleRadius(a,r){return this.x+=Math.cos(a)*r,this.y+=Math.sin(a)*r,this}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=array[offset],this.y=array[offset+1],this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array}rotateAround(center,angle){let c=Math.cos(angle),s=Math.sin(angle),x=this.x-center.x,y=this.y-center.y;return this.x=x*c-y*s+center.x,this.y=x*s+y*c+center.y,this}fromBufferAttribute(attribute,index){this.x=attribute.array[2*index+0],this.y=attribute.array[2*index+1]}}class Vector3{constructor(x,y,z){this.x=x||0,this.y=y||0,this.z=z||0}set(x,y,z){return this.x=x||0,this.y=y||0,this.z=z||0,this}setScalar(scalar){return this.x=scalar,this.y=scalar,this.z=scalar,this}clone(){return new Vector3(this.x,this.y,this.z)}copy(v){return this.x=v.x,this.y=v.y,this.z=v.z,this}add(v){return this.x+=v.x,this.y+=v.y,this.z+=v.z,this}addScalar(s){return this.x+=s,this.y+=s,this.z+=s,this}addVectors(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this}addScaledVector(v,s){return this.x+=v.x*s,this.y+=v.y*s,this.z+=v.z*s,this}sub(v){return this.x-=v.x,this.y-=v.y,this.z-=v.z,this}subScalar(s){return this.x-=s,this.y-=s,this.z-=s,this}subVectors(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this}multiply(v){return this.x*=v.x,this.y*=v.y,this.z*=v.z,this}multiplyScalar(scalar){return this.x*=scalar,this.y*=scalar,this.z*=scalar,this}multiplyVectors(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this}applyEuler(euler){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromEuler(euler))}applyAxisAngle(axis,angle){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromAxisAngle(axis,angle))}applyMatrix3(m){let x=this.x,y=this.y,z=this.z,e=m.elements;return this.x=e[0]*x+e[3]*y+e[6]*z,this.y=e[1]*x+e[4]*y+e[7]*z,this.z=e[2]*x+e[5]*y+e[8]*z,this}applyMatrix4(m){let x=this.x,y=this.y,z=this.z,e=m.elements,w=1/(e[3]*x+e[7]*y+e[11]*z+e[15]);return this.x=(e[0]*x+e[4]*y+e[8]*z+e[12])*w,this.y=(e[1]*x+e[5]*y+e[9]*z+e[13])*w,this.z=(e[2]*x+e[6]*y+e[10]*z+e[14])*w,this}applyQuaternion(q){let x=this.x,y=this.y,z=this.z,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this.z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this}project(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,matrix.getInverse(camera.matrixWorld)),this.applyMatrix4(matrix)}unproject(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.matrixWorld,matrix.getInverse(camera.projectionMatrix)),this.applyMatrix4(matrix)}transformDirection(m){let x=this.x,y=this.y,z=this.z,e=m.elements;return this.x=e[0]*x+e[4]*y+e[8]*z,this.y=e[1]*x+e[5]*y+e[9]*z,this.z=e[2]*x+e[6]*y+e[10]*z,this.normalize()}divide(v){return this.x/=v.x,this.y/=v.y,this.z/=v.z,this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}min(v){return this.x=Math.min(this.x,v.x),this.y=Math.min(this.y,v.y),this.z=Math.min(this.z,v.z),this}max(v){return this.x=Math.max(this.x,v.x),this.y=Math.max(this.y,v.y),this.z=Math.max(this.z,v.z),this}clamp(min,max){return this.x=Math.max(min.x,Math.min(max.x,this.x)),this.y=Math.max(min.y,Math.min(max.y,this.y)),this.z=Math.max(min.z,Math.min(max.z,this.z)),this}clampScalar(minVal,maxVal){let min=new Vector3,max=new Vector3;return min.set(minVal,minVal,minVal),max.set(maxVal,maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(v){return this.x*v.x+this.y*v.y+this.z*v.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(length){return this.normalize().multiplyScalar(length)}lerp(v,alpha,hz){return this.x=Math.lerp(v.x,this.x,alpha,hz),this.y=Math.lerp(v.y,this.y,alpha,hz),this.z=Math.lerp(v.z,this.z,alpha,hz),this}lerpVectors(v1,v2,alpha){return this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}cross(v){return this.crossVectors(this,v)}crossVectors(a,b){let ax=a.x,ay=a.y,az=a.z,bx=b.x,by=b.y,bz=b.z;return this.x=ay*bz-az*by,this.y=az*bx-ax*bz,this.z=ax*by-ay*bx,this}projectOnVector(vector){let scalar=vector.dot(this)/vector.lengthSq();return this.copy(vector).multiplyScalar(scalar)}projectOnPlane(planeNormal){let v1=this.V1||new Vector3;return this.V1=v1,v1.copy(this).projectOnVector(planeNormal),this.sub(v1)}reflect(normal){let v1=this.V1||new Vector3;return this.V1=v1,this.sub(v1.copy(normal).multiplyScalar(2*this.dot(normal)))}angleTo(v){let theta=this.dot(v)/Math.sqrt(this.lengthSq()*v.lengthSq());return Math.acos(Math.clamp(theta,-1,1))}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this.x-v.x,dy=this.y-v.y,dz=this.z-v.z;return dx*dx+dy*dy+dz*dz}manhattanDistanceTo(v){return Math.abs(this.x-v.x)+Math.abs(this.y-v.y)+Math.abs(this.z-v.z)}setFromCylindrical(c){return this.x=c.radius*Math.sin(c.theta),this.y=c.y,this.z=c.radius*Math.cos(c.theta),this}setFromMatrixPosition(m){let e=m.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(m){let sx=this.setFromMatrixColumn(m,0).length(),sy=this.setFromMatrixColumn(m,1).length(),sz=this.setFromMatrixColumn(m,2).length();return this.x=sx,this.y=sy,this.z=sz,this}setFromMatrixColumn(m,index){return this.fromArray(m.elements,4*index)}setAngleRadius(a,r,dir="xy"){return this[dir[0]]=Math.cos(a)*r,this[dir[1]]=Math.sin(a)*r,this}addAngleRadius(a,r,dir="xy"){return this[dir[0]]+=Math.cos(a)*r,this[dir[1]]+=Math.sin(a)*r,this}equals(v){return v.x===this.x&&v.y===this.y&&v.z===this.z}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=array[offset],this.y=array[offset+1],this.z=array[offset+2],this}setFromSpherical(s){this.setFromSphericalCoords(s.radius,s.phi,s.theta)}setFromSphericalCoords(radius,phi,theta){let sinPhiRadius=Math.sin(phi)*radius;return this.x=sinPhiRadius*Math.sin(theta),this.y=Math.cos(phi)*radius,this.z=sinPhiRadius*Math.cos(theta),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array[offset+2]=this.z,array}fromBufferAttribute(attribute,index){return this.x=attribute.array[3*index+0],this.y=attribute.array[3*index+1],this.z=attribute.array[3*index+2],this}}class Vector3D{constructor(x,y,z){this._x=x||0,this._y=y||0,this._z=z||0}get x(){return this._x}set x(v){if(window.Hydra&&Hydra.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");Math.abs(this._x-v)>1e-4&&this.onChangeCallback(),this._x=v}get y(){return this._y}set y(v){if(window.Hydra&&Hydra.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");Math.abs(this._y-v)>1e-4&&this.onChangeCallback(),this._y=v}get z(){return this._z}set z(v){if(window.Hydra&&Hydra.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");Math.abs(this._z-v)>1e-4&&this.onChangeCallback(),this._z=v}onChangeCallback(){}set(x,y,z){return this._x=x||0,this._y=y||0,this._z=z||0,this.onChangeCallback(),this}setScalar(scalar){return this._x=scalar,this._y=scalar,this._z=scalar,this.onChangeCallback(),this}clone(){return new Vector3(this._x,this._y,this._z)}copy(v){let dirty=Math.abs(this._x-v.x)>1e-4||Math.abs(this._y-v.y)>1e-4||Math.abs(this._z-v.z)>1e-4;return this._x=v.x,this._y=v.y,this._z=v.z,dirty&&this.onChangeCallback(),this}add(v){return this._x+=v.x,this._y+=v.y,this._z+=v.z,this.onChangeCallback(),this}addScalar(s){return this._x+=s,this._y+=s,this._z+=s,this.onChangeCallback(),this}addVectors(a,b){return this._x=a.x+b.x,this._y=a.y+b.y,this._z=a.z+b.z,this.onChangeCallback(),this}addScaledVector(v){return this._x+=v.x*s,this._y+=v.y*s,this._z+=v.z*s,this.onChangeCallback(),this}sub(v){return this._x-=v.x,this._y-=v.y,this._z-=v.z,this.onChangeCallback(),this}subScalar(s){return this._x-=s,this._y-=s,this._z-=s,this.onChangeCallback(),this}subVectors(a,b){return this._x=a.x-b.x,this._y=a.y-b.y,this._z=a.z-b.z,this.onChangeCallback(),this}multiply(v){return this._x*=v.x,this._y*=v.y,this._z*=v.z,this.onChangeCallback(),this}multiplyScalar(scalar){return this._x*=scalar,this._y*=scalar,this._z*=scalar,this.onChangeCallback(),this}multiplyVectors(a,b){return this._x=a.x*b.x,this._y=a.y*b.y,this._z=a.z*b.z,this.onChangeCallback(),this}applyEuler(euler){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromEuler(euler))}applyAxisAngle(axis,angle){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromAxisAngle(axis,angle))}applyMatrix3(m){let x=this._x,y=this._y,z=this._z,e=m.elements;return this._x=e[0]*x+e[3]*y+e[6]*z,this._y=e[1]*x+e[4]*y+e[7]*z,this._z=e[2]*x+e[5]*y+e[8]*z,this.onChangeCallback(),this}applyMatrix4(m){let x=this._x,y=this._y,z=this._z,e=m.elements,w=1/(e[3]*x+e[7]*y+e[11]*z+e[15]);return this._x=(e[0]*x+e[4]*y+e[8]*z+e[12])*w,this._y=(e[1]*x+e[5]*y+e[9]*z+e[13])*w,this._z=(e[2]*x+e[6]*y+e[10]*z+e[14])*w,this.onChangeCallback(),this}applyQuaternion(q){let x=this._x,y=this._y,z=this._z,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return this._x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this._y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this._z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this.onChangeCallback(),this}project(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,matrix.getInverse(camera.matrixWorld)),this.applyMatrix4(matrix)}unproject(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.matrixWorld,matrix.getInverse(camera.projectionMatrix)),this.applyMatrix4(matrix)}transformDirection(m){let x=this._x,y=this._y,z=this._z,e=m.elements;return this._x=e[0]*x+e[4]*y+e[8]*z,this._y=e[1]*x+e[5]*y+e[9]*z,this._z=e[2]*x+e[6]*y+e[10]*z,this.onChangeCallback(),this.normalize()}divide(v){return this._x/=v.x,this._y/=v.y,this._z/=v.z,this.onChangeCallback(),this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}min(v){return this._x=Math.min(this._x,v.x),this._y=Math.min(this._y,v.y),this._z=Math.min(this._z,v.z),this.onChangeCallback(),this}max(v){return this._x=Math.max(this._x,v.x),this._y=Math.max(this._y,v.y),this._z=Math.max(this._z,v.z),this}clamp(min,max){return this._x=Math.max(min.x,Math.min(max.x,this._x)),this._y=Math.max(min.y,Math.min(max.y,this._y)),this._z=Math.max(min.z,Math.min(max.z,this._z)),this}clampScalar(minVal,maxVal){let min=new Vector3,max=new Vector3;return min.set(minVal,minVal,minVal),max.set(maxVal,maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this._x=Math.floor(this._x),this._y=Math.floor(this._y),this._z=Math.floor(this._z),this.onChangeCallback(),this}ceil(){return this._x=Math.ceil(this._x),this._y=Math.ceil(this._y),this._z=Math.ceil(this._z),this.onChangeCallback(),this}round(){return this._x=Math.round(this._x),this._y=Math.round(this._y),this._z=Math.round(this._z),this.onChangeCallback(),this}roundToZero(){return this._x=this._x<0?Math.ceil(this._x):Math.floor(this._x),this._y=this._y<0?Math.ceil(this._y):Math.floor(this._y),this._z=this._z<0?Math.ceil(this._z):Math.floor(this._z),this.onChangeCallback(),this}negate(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this.onChangeCallback(),this}dot(v){return this._x*v.x+this._y*v.y+this._z*v.z}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}manhattanLength(){return Math.abs(this._x)+Math.abs(this._y)+Math.abs(this._z)}normalize(){return this.onChangeCallback(),this.divideScalar(this.length()||1)}setLength(length){return this.onChangeCallback(),this.normalize().multiplyScalar(length)}lerp(v,alpha,hz){return this._x=Math.lerp(v.x,this._x,alpha,hz),this._y=Math.lerp(v.y,this._y,alpha,hz),this._z=Math.lerp(v.z,this._z,alpha,hz),this.onChangeCallback(),this}lerpVectors(v1,v2,alpha){return this.onChangeCallback(),this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}cross(v){return this.crossVectors(this,v)}crossVectors(a,b){let ax=a.x,ay=a.y,az=a.z,bx=b.x,by=b.y,bz=b.z;return this._x=ay*bz-az*by,this._y=az*bx-ax*bz,this._z=ax*by-ay*bx,this.onChangeCallback(),this}projectOnVector(vector){let scalar=vector.dot(this)/vector.lengthSq();return this.copy(vector).multiplyScalar(scalar)}projectOnPlane(planeNormal){let v1=this.V1||new Vector3;return this.V1=v1,this.onChangeCallback(),v1.copy(this).projectOnVector(planeNormal),this.sub(v1)}reflect(normal){let v1=this.V1||new Vector3;return this.V1=v1,this.onChangeCallback(),this.sub(v1.copy(normal).multiplyScalar(2*this.dot(normal)))}angleTo(v){let theta=this.dot(v)/Math.sqrt(this.lengthSq()*v.lengthSq());return Math.acos(Math.clamp(theta,-1,1))}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this._x-v.x,dy=this._y-v.y,dz=this._z-v.z;return dx*dx+dy*dy+dz*dz}manhattanDistanceTo(v){return Math.abs(this._x-v.x)+Math.abs(this._y-v.y)+Math.abs(this._z-v.z)}setFromSpherical(s){let sinPhiRadius=Math.sin(s.phi)*s.radius;return this._x=sinPhiRadius*Math.sin(s.theta),this._y=Math.cos(s.phi)*s.radius,this._z=sinPhiRadius*Math.cos(s.theta),this.onChangeCallback(),this}setFromCylindrical(c){return this._x=c.radius*Math.sin(c.theta),this._y=c.y,this._z=c.radius*Math.cos(c.theta),this.onChangeCallback(),this}setFromMatrixPosition(m){let e=m.elements;return this._x=e[12],this._y=e[13],this._z=e[14],this.onChangeCallback(),this}setFromMatrixScale(m){let sx=this.setFromMatrixColumn(m,0).length(),sy=this.setFromMatrixColumn(m,1).length(),sz=this.setFromMatrixColumn(m,2).length();return this.onChangeCallback(),this._x=sx,this._y=sy,this._z=sz,this}setFromMatrixColumn(m,index){return this.onChangeCallback(),this.fromArray(m.elements,4*index)}equals(v){return v.x===this._x&&v.y===this._y&&v.z===this._z}fromArray(array,offset){return void 0===offset&&(offset=0),this._x=array[offset],this._y=array[offset+1],this._z=array[offset+2],this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array}fromBufferAttribute(attribute,index){this._x=attribute.array[3*index+0],this._y=attribute.array[3*index+1],this._z=attribute.array[3*index+2],this.onChangeCallback()}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}class Vector4{constructor(x=0,y=0,z=0,w=0){this.x=x,this.y=y,this.z=z,this.w=w}multiplyScalar(s){return this.x*=s,this.y*=s,this.z*=s,this.w*=s,this}set(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this}copy(v){return this.x=v.x,this.y=v.y,this.z=v.z,this.w=v.w,this}dot(v){return this.x*v.x+this.y*v.y+this.z*v.z+this.w*v.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}equals(v){return v.x===this.x&&v.y===this.y&&v.z===this.z&&v.w===this.w}lerp(v,alpha,hz){return this.x=Math.lerp(v.x,this.x,alpha,hz),this.y=Math.lerp(v.y,this.y,alpha,hz),this.z=Math.lerp(v.z,this.z,alpha,hz),this.w=Math.lerp(v.w,this.w,alpha,hz),this}applyMatrix4(m){let x=this.x,y=this.y,z=this.z,w=this.w,e=m.elements;return this.x=e[0]*x+e[4]*y+e[8]*z+e[12]*w,this.y=e[1]*x+e[5]*y+e[9]*z+e[13]*w,this.z=e[2]*x+e[6]*y+e[10]*z+e[14]*w,this.w=e[3]*x+e[7]*y+e[11]*z+e[15]*w,this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array[offset+2]=this.z,array[offset+3]=this.w,array}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=array[offset],this.y=array[offset+1],this.z=array[offset+2],this.w=array[offset+3],this}set width(v){this.z=v}set height(v){this.w=v}get width(){return this.z}get height(){return this.w}}class Face3{constructor(a,b,c,normal=new Vector3){this.a=a,this.b=b,this.c=c,this.normal=normal}}Class((function zUtils3D(){var diff,edge1,edge2,normal,v1,v0;Math.euclideanModulo=function(n,m){return(n%m+m)%m},Math.isPowerOf2=function(w,h){let test=value=>0==(value&value-1);return test(w)&&test(h)},Math.floorPowerOf2=function(value){return Math.pow(2,Math.floor(Math.log(value)/Math.LN2))},Geometry.TYPES={SphereGeometry:SphereGeometry,IcosahedronGeometry:IcosahedronGeometry,BoxGeometry:BoxGeometry,PlaneGeometry:PlaneGeometry,CylinderGeometry:CylinderGeometry},Matrix4.prototype.isMatrix4=!0,Matrix3.prototype.isMatrix3=!0,Vector3.prototype.isVector3=!0,Vector3D.prototype.isVector3=!0,Vector2.prototype.isVector2=!0,CameraBase3D.prototype.isCamera=!0,PerspectiveCamera.prototype.isPerspective=!0,window.THREAD&&(Shader={FRONT_SIDE:"shader_front_side",BACK_SIDE:"shader_back_side",DOUBLE_SIDE:"shader_double_side"}),Ray.prototype.intersectTriangle=(diff=new Vector3,edge1=new Vector3,edge2=new Vector3,normal=new Vector3,function intersectTriangle(a,b,c,backfaceCulling,target){edge1.subVectors(b,a),edge2.subVectors(c,a),normal.crossVectors(edge1,edge2);var sign,DdN=this.direction.dot(normal);if(DdN>0){if(backfaceCulling)return null;sign=1}else{if(!(DdN<0))return null;sign=-1,DdN=-DdN}diff.subVectors(this.origin,a);var DdQxE2=sign*this.direction.dot(edge2.crossVectors(diff,edge2));if(DdQxE2<0)return null;var DdE1xQ=sign*this.direction.dot(edge1.cross(diff));if(DdE1xQ<0)return null;if(DdQxE2+DdE1xQ>DdN)return null;var QdN=-sign*diff.dot(normal);return QdN<0?null:this.at(QdN/DdN,target)}),Mesh.prototype.raycast=function(){let inverseMatrix=new Matrix4,ray=new Ray,sphere=new Sphere,vA=new Vector3,vB=new Vector3,vC=new Vector3,uvA=(new Vector3,new Vector3,new Vector3,new Vector3,new Vector2),uvB=new Vector2,uvC=new Vector2,barycoord=new Vector3,intersectionPoint=new Vector3,intersectionPointWorld=new Vector3;function checkBufferGeometryIntersection(object,raycaster,ray,position,uv,a,b,c){vA.fromBufferAttribute(position,a),vB.fromBufferAttribute(position,b),vC.fromBufferAttribute(position,c);let intersection=function checkIntersection(object,shader,raycaster,ray,pA,pB,pC,point){let intersect;if(intersect=shader.side===Shader.BACK_SIDE?ray.intersectTriangle(pC,pB,pA,!0,point):ray.intersectTriangle(pA,pB,pC,shader.side!==Shader.DOUBLE_SIDE,point),null===intersect)return null;intersectionPointWorld.copy(point),intersectionPointWorld.applyMatrix4(object.matrixWorld);let distance=raycaster.ray.origin.distanceTo(intersectionPointWorld);return distance<raycaster.near||distance>raycaster.far?null:{distance:distance,point:intersectionPointWorld.clone(),object:object}}(object,object.shader,raycaster,ray,vA,vB,vC,intersectionPoint);if(intersection){uv&&(uvA.fromBufferAttribute(uv,a),uvB.fromBufferAttribute(uv,b),uvC.fromBufferAttribute(uv,c),intersection.uv=function uvIntersection(point,p1,p2,p3,uv1,uv2,uv3){return Triangle.getBarycoord(point,p1,p2,p3,barycoord),uv1.multiplyScalar(barycoord.x),uv2.multiplyScalar(barycoord.y),uv3.multiplyScalar(barycoord.z),uv1.add(uv2).add(uv3),uv1.clone()}(intersectionPoint,vA,vB,vC,uvA,uvB,uvC));let face=new Face3(a,b,c);Triangle.getNormal(vA,vB,vC,face.normal),intersection.face=face}return intersection}return function raycast(raycaster,intersects){let intersection,a,b,c,geometry=this.geometry,shader=this.shader,matrixWorld=this.matrixWorld;if(void 0===shader)return;if(null===geometry.boundingSphere&&geometry.computeBoundingSphere(),0==this.scale.x)return;if(this.staticRaycast){if(this.raySphere||(this.raySphere=new Sphere,this.raySphere.copy(geometry.boundingSphere),this.raySphere.applyMatrix4(matrixWorld)),this.raycastNeedsUpdate&&(this.raySphere.copy(geometry.boundingSphere),this.raySphere.applyMatrix4(matrixWorld),this.raycastNeedsUpdate=!1),!1===raycaster.ray.intersectsSphere(this.raySphere))return}else if(sphere.copy(geometry.boundingSphere),sphere.applyMatrix4(matrixWorld),!1===raycaster.ray.intersectsSphere(sphere))return;if(inverseMatrix.getInverse(matrixWorld),ray.copy(raycaster.ray).applyMatrix4(inverseMatrix),null!==geometry.boundingBox&&!1===ray.intersectsBox(geometry.boundingBox))return;let i,l,index=geometry.index,position=geometry.attributes.position,uv=geometry.attributes.uv;if(null!==index)for(i=0,l=index.length;i<l;i+=3)a=index[i],b=index[i+1],c=index[i+2],intersection=checkBufferGeometryIntersection(this,raycaster,ray,position,uv,a,b,c),intersection&&(intersection.faceIndex=Math.floor(i/3),intersects.push(intersection));else if(void 0!==position)for(i=0,l=position.count;i<l;i+=3)a=i,b=i+1,c=i+2,intersection=checkBufferGeometryIntersection(this,raycaster,ray,position,uv,a,b,c),intersection&&(intersection.faceIndex=Math.floor(i/3),intersects.push(intersection))}}(),Triangle.prototype.closestPointToPoint=function(){let plane=new Plane,edgeList=[new Line3,new Line3,new Line3],projectedPoint=new Vector3,closestPoint=new Vector3;return function closestPointToPoint(point,target=new Vector3){let minDistance=1/0;if(plane.setFromCoplanarPoints(this.a,this.b,this.c),plane.projectPoint(point,projectedPoint),!0===this.containsPoint(projectedPoint))target.copy(projectedPoint);else{edgeList[0].set(this.a,this.b),edgeList[1].set(this.b,this.c),edgeList[2].set(this.c,this.a);for(let i=0;i<edgeList.length;i++){edgeList[i].closestPointToPoint(projectedPoint,!0,closestPoint);let distance=projectedPoint.distanceToSquared(closestPoint);distance<minDistance&&(minDistance=distance,target.copy(closestPoint))}}return target}}(),Points.prototype.raycast=function(){let inverseMatrix=new Matrix4,ray=new Ray,sphere=new Sphere;return function raycast(raycaster,intersects){let object=this,geometry=this.geometry,matrixWorld=this.matrixWorld,threshold=raycaster.params.Points.threshold;if(null===geometry.boundingSphere&&geometry.computeBoundingSphere(),sphere.copy(geometry.boundingSphere),sphere.applyMatrix4(matrixWorld),sphere.radius+=threshold,!1===raycaster.ray.intersectsSphere(sphere))return;inverseMatrix.getInverse(matrixWorld),ray.copy(raycaster.ray).applyMatrix4(inverseMatrix);let localThreshold=threshold/((this.scale.x+this.scale.y+this.scale.z)/3),localThresholdSq=localThreshold*localThreshold,position=new Vector3,intersectPoint=new Vector3;function testPoint(point,index){let rayPointDistanceSq=ray.distanceSqToPoint(point);if(rayPointDistanceSq<localThresholdSq){ray.closestPointToPoint(point,intersectPoint),intersectPoint.applyMatrix4(matrixWorld);let distance=raycaster.ray.origin.distanceTo(intersectPoint);if(distance<raycaster.near||distance>raycaster.far)return;intersects.push({distance:distance,distanceToRay:Math.sqrt(rayPointDistanceSq),point:intersectPoint.clone(),index:index,face:null,object:object})}}let index=geometry.index,positions=geometry.attributes.position.array;if(null!==index){let indices=index.array;for(let i=0,il=indices.length;i<il;i++){let a=indices[i];position.fromArray(positions,3*a),testPoint(position,a)}}else for(let i=0,l=positions.length/3;i<l;i++)position.fromArray(positions,3*i),testPoint(position,i)}}(),Object.assign(Triangle,{getNormal:(v0=new Vector3,function getNormal(a,b,c,target=new Vector3){target.subVectors(c,b),v0.subVectors(a,b),target.cross(v0);var targetLengthSq=target.lengthSq();return targetLengthSq>0?target.multiplyScalar(1/Math.sqrt(targetLengthSq)):target.set(0,0,0)}),getBarycoord:function(){var v0=new Vector3,v1=new Vector3,v2=new Vector3;return function getBarycoord(point,a,b,c,target=new Vector3){v0.subVectors(c,a),v1.subVectors(b,a),v2.subVectors(point,a);var dot00=v0.dot(v0),dot01=v0.dot(v1),dot02=v0.dot(v2),dot11=v1.dot(v1),dot12=v1.dot(v2),denom=dot00*dot11-dot01*dot01;if(0===denom)return target.set(-2,-1,-1);var invDenom=1/denom,u=(dot11*dot02-dot01*dot12)*invDenom,v=(dot00*dot12-dot01*dot02)*invDenom;return target.set(1-u-v,v,u)}}(),containsPoint:(v1=new Vector3,function containsPoint(point,a,b,c){return Triangle.getBarycoord(point,a,b,c,v1),v1.x>=0&&v1.y>=0&&v1.x+v1.y<=1})})}),"static"),Class((function FXLayer(_parentNuke,_type,_preventDrawBuffers=!1){Inherit(this,Component);var _nuke,_rt,_this=this,_scene=new Scene,_objects=[],_textureIndex=-1,_visible=!0,_id=Utils.timestamp(),_name=Utils.getConstructorName(_this),_useDrawBuffers=!_preventDrawBuffers;function resizeHandler(){_rt.setSize&&_rt.setSize(_nuke.stage.width*_this.resolution*_nuke.dpr,_nuke.stage.height*_this.resolution*_nuke.dpr)}this.resolution=1,this.enabled=!0,this.renderShadows=!0,this.set("visible",v=>_this.scene.visible=_visible=v),this.get("visible",_=>_visible),this.onInvisible=function(){_this.scene.visible=!1},this.onVisible=function(){_this.scene.visible=!0},this.create=function(nuke=World.NUKE,type,rt){if(!nuke)return;let format;_useDrawBuffers=nuke.useDrawBuffers,type&&"object"==typeof type&&("boolean"==typeof type.useDrawBuffers&&(_useDrawBuffers=type.useDrawBuffers),format=type.format,type=type.type),_this.rtType=type||Texture.UNSIGNED_BYTE,_this.rtFormat=format||Texture.RGBFormat,(_this=this).scene=_scene,(_nuke=_this.initClass(Nuke,nuke.stage,{renderer:nuke.renderer,camera:nuke.camera,scene:_scene,dpr:nuke.dpr,useDrawBuffers:!1})).parentNuke=nuke,_parentNuke=nuke,_this.nuke=_nuke,function initRT(rt){if(_useDrawBuffers){let texture=new Texture;texture.minFilter=Texture.LINEAR,texture.magFilter=Texture.LINEAR,texture.format=Texture.RGBAFormat,_this.rtType&&(texture.type=_this.rtType),_this.rtFormat&&(texture.format=_this.rtFormat),texture.type==Texture.FLOAT&&(texture.format=Texture.RGBAFormat),texture.wrapS=texture.wrapT=Texture.CLAMP_TO_EDGE,texture.fxLayer=_this,_this.textureIndex=_textureIndex=_parentNuke.attachDrawBuffer(texture),_rt={texture:texture}}else _this.rtType&&_this.rtType==Texture.FLOAT&&"ios"==Device.system.os&&(_this.rtType=Texture.HALF_FLOAT),_rt=rt||Utils3D.createRT(Math.round(_nuke.stage.width*_this.resolution*_nuke.dpr),Math.round(_nuke.stage.height*_this.resolution*_nuke.dpr),_this.rtType,_this.rtFormat);_this.rt=_rt,_this.nuke.setSize(_rt.width,_rt.height)}(rt),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}()},this.addObject=this.add=function(object){if(_nuke)if(_useDrawBuffers)object.shader&&object.shader.fragmentShader&&(!function editDBShader(mesh){const WEBGL2=Renderer.type==Renderer.WEBGL2;let modifyMarker=(fs,name,index)=>{if(WEBGL2&&!fs.includes(`layout(location=${index})`)){let mainAt=(fs=fs.replace("out vec4 FragColor;","")).indexOf("void main()"),before=fs.slice(0,mainAt),after=fs.slice(mainAt);fs=before+`layout(location=${index}) out vec4 ${name};\n`+after}let marker="#drawbuffer "+name;if(fs.includes(marker)){let split=fs.split(marker+" "),finalOut=WEBGL2?name:`gl_FragData[${index}]`;split[1]=split[1].replace("gl_FragColor",finalOut),fs=split[0]+split[1]}for(;fs.includes("#applyShadow");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)fs[i].includes("#applyShadow")&&(fs[i]=fs[i].replace("#applyShadow",""));fs=fs.join("\n")}return fs},shader=mesh.shader,fs=shader.fragmentShader,name=_this.name||_name;WEBGL2&&fs.includes("location=0")||(fs=modifyMarker(fs,"Color",0)),fs=modifyMarker(fs,name,_textureIndex),shader.fragmentShader=fs}(object),object.shader._attachmentData={format:_this.rtFormat,type:_this.rtType,attachments:_parentNuke.attachments});else{let clone=object.clone();for(object["clone_"+_id]=clone,_scene.add(clone),_objects.push(object),object.shader&&function editShader(mesh){let modifyShader=(shader,name)=>{let fs=shader._fragmentShader;if(!fs)return;let marker="#drawbuffer "+name;if(fs.includes(marker)){let split=fs.split(marker+" ");fs=split[0]+split[1]}for(;fs.includes("#drawbuffer");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)fs[i].includes("#drawbuffer")&&(fs[i]="");fs=fs.join("\n")}shader.fragmentShader=fs},applyShadow=(shader,bool)=>{let fs=shader.fragmentShader;if(fs){for(;fs.includes("#applyShadow");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)bool?fs[i].includes("#applyShadow")&&(fs[i]=fs[i].replace("#applyShadow","")):fs[i].includes("#applyShadow")&&(fs[i]="");fs=fs.join("\n")}shader.fragmentShader=fs}};mesh.shader._fragmentShader||(mesh.shader._fragmentShader=mesh.shader.fragmentShader),modifyShader(mesh.shader,"Color");let shader=mesh.shader.clone(!_this.renderShadows,"-"+(_this.name||_name));modifyShader(shader,_this.name||_name),applyShadow(shader,_this.renderShadows),applyShadow(mesh.shader,!0),mesh.shader.copyUniformsTo(shader,!0),mesh.shader=shader}(clone);clone.children.length;)clone.remove(clone.children[0])}},this.removeObject=function(object){_nuke&&(_scene.remove(object["clone_"+_id]),_objects.remove(object),delete object["clone_"+_id])},this.render=this.draw=function(stage,camera){if(_nuke&&_this.enabled&&!_useDrawBuffers&&_parentNuke.enabled&&_objects.length){stage&&(_nuke.stage=stage,_this.setSize(stage.width,stage.height)),_nuke.camera=camera||_nuke.parentNuke.camera,_this.renderShadows||(_nuke.renderer.overridePreventShadows=!0);for(let i=_objects.length-1;i>-1;i--){let obj=_objects[i],clone=obj["clone_"+_id];_this.forceVisible?clone.visible=!0:clone.visible=obj.determineVisible(),clone.visible&&(obj.updateMatrixWorld(),obj.ignoreMatrix||Utils3D.decompose(obj,clone))}_nuke.rtt=_rt,_nuke.render(),RenderStats.update("FXLayer"),_nuke.renderer.overridePreventShadows=!1}},this.addPass=function(pass){_nuke&&_nuke.add(pass)},this.removePass=function(pass){_nuke&&_nuke.remove(pass)},this.setSize=function(width,height){_nuke&&(_rt.width==width&&_rt.height==height||(_this.events.unsub(Events.RESIZE,resizeHandler),_rt&&_rt.setSize(width*_this.resolution*_nuke.dpr,height*_this.resolution*_nuke.dpr),_nuke.setSize(width*_this.resolution*_nuke.dpr,height*_this.resolution*_nuke.dpr)))},this.setDPR=function(dpr){_nuke&&(_nuke.dpr=dpr,resizeHandler())},this.setResolution=function(res){_this.resolution=res,resizeHandler()},this.getObjects=function(){return _objects},this.useRT=function(rt){_rt=_this.rt=rt},this.getName=function(){return _this.name||_name},_parentNuke instanceof Nuke&&this.create(_parentNuke,_type)})),Namespace("FX"),Class((function FXScene(_parentNuke,_type){Inherit(this,Component);var _nuke,_rt,_rtPool,_this=this,_scene=new Scene,_id=Utils.timestamp(),_objects=[],_visible=!0;function resizeHandler(){_rt.setSize&&_rt.setSize(_nuke.stage.width*_this.resolution*_nuke.dpr,_nuke.stage.height*_this.resolution*_nuke.dpr),_this.nuke.setSize(_rt.width,_rt.height),_this.width=_rt.width,_this.height=_rt.height}this.resolution=1,this.autoVisible=!0,this.enabled=!0,this.scene=_scene,this.renderShadows=!0,this.set("visible",v=>{_this.scene&&(_this.scene.visible=_visible=v)}),this.get("visible",_=>_visible),this.onInvisible=function(){this.scene.visible&&(this.scene.visible=!1,_this.flag("needsOnVisible",!0)),_rtPool&&_rtPool.putRT(_this.rt)},this.onVisible=function(){_this.flag("needsOnVisible")&&(this.scene.visible=!0,_this.flag("needsOnVisible",!1)),_rtPool&&_this.useRT(_rtPool.getRT())},this.create=function(nuke=World.NUKE,rt,options){nuke instanceof RTPool?(options=rt,rt=(_rtPool=nuke).nullRT,nuke=World.NUKE):rt&&"object"==typeof rt?rt.isRT||(options=rt,rt=void 0):!nuke||nuke instanceof Nuke||(options=nuke,nuke=World.NUKE),options||(options={}),_this.rtFormat=options.format||Texture.RGBFormat,_this.rtType=options.type||Texture.UNSIGNED_BYTE,(_this=this).scene=_scene,_this.nuke=_nuke=_this.initClass(Nuke,nuke.stage,{renderer:nuke.renderer,camera:nuke.camera,scene:_scene,dpr:nuke.dpr}),_scene.nuke=_nuke,function initRT(rt,options={}){options.type==Texture.FLOAT&&(options.format=Texture.RGBAFormat,"ios"==Device.system.os&&(options.type=Texture.HALF_FLOAT));const RT=_this.nuke.useDrawBuffers&&options.multiRenderTarget?MultiRenderTarget:RenderTarget;_this.width=_nuke.stage.width*_this.resolution*_nuke.dpr,_this.height=_nuke.stage.height*_this.resolution*_nuke.dpr,_rt=rt||new RT(_this.width,_this.height,Object.assign({minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,generateMipmaps:!1},options)),_nuke.rtt=_this.rt=_rt,_rt.fxscene=_this}(rt,options),rt?_this.flag("recycle_rt",!0):function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),FXScene.onCreate&&FXScene.onCreate(_this)},this.onDestroy=this.fxDestroy=function(){_this.scene.deleted=!0,_this.flag("recycle_rt")||_rt&&_rt.destroy&&_rt.destroy()},this.setSize=function(width,height,exact){_nuke&&(_rt.width==width&&_rt.height==height||(_this.events.unsub(Events.RESIZE,resizeHandler),exact?(_this.width=width,_this.height=height):(_this.width=width*_this.resolution*_nuke.dpr,_this.height=height*_this.resolution*_nuke.dpr),_rt&&_rt.setSize(_this.width,_this.height),_nuke.setSize(_this.width,_this.height)))},this.add=this.addObject=function(object){if(!object)return console.error("FXScene addObject undefined!");let clone=object.clone();for(object["clone_"+_id]=clone,_scene.add(clone),_objects.push(object),object.shader._attachmentData={format:_this.rtFormat,type:_this.rtType,attachments:1};clone.children.length;)clone.remove(clone.children[0]);return clone},this.removeObject=function(object){_scene.remove(object["clone_"+_id]),_objects.remove(object),delete object["clone_"+_id]},this.setScissor=function(x,y,w,h){this.scissor||(this.scissor=new Vector4),this.scissor.x=x*_this.width,this.scissor.y=_this.height-h*_this.height-y*_this.height,this.scissor.width=w*_this.width,this.scissor.height=h*_this.height,this.rt.scissor=this.scissor},this.render=this.draw=function(stage,camera){if(_this.isVrWorldMode)return;if(_this.isVrSceneMode){let rt=World.NUKE.enabled&&World.NUKE.passes.length?World.NUKE.rttBuffer:void 0,autoClear=_nuke.renderer.autoClear;return _nuke.renderer.autoClear=!1,_nuke.renderer.clearDepth(rt),_nuke.renderer.render(_scene,_nuke.camera,rt),void(_nuke.renderer.autoClear=autoClear)}stage&&(_this.events.unsub(Events.RESIZE,resizeHandler),_this.setSize(stage.width,stage.height),_this.nuke.stage=stage),camera&&(_this.nuke.camera=camera,RenderManager.type==RenderManager.WEBVR&&(_this.vrRT||(_this.vrRT=new Map),_this.vrRT.get(camera)||_this.vrRT.set(camera,_rt.clone())));let clearColor=null,alpha=1;_this.clearColor&&(clearColor=_nuke.renderer.getClearColor().getHex(),_nuke.renderer.setClearColor(_this.clearColor)),_this.clearAlpha>-1&&(alpha=_nuke.renderer.getClearAlpha(),_nuke.renderer.setClearAlpha(_this.clearAlpha)),_this.renderShadows||(_nuke.renderer.overridePreventShadows=!0);for(let i=_objects.length-1;i>-1;i--){let obj=_objects[i],clone=obj["clone_"+_id];_this.forceVisible||obj.cloneVisible?clone.visible="boolean"!=typeof clone.isVisible||clone.isVisible:clone.visible=obj.determineVisible(),clone.visible&&(obj.updateMatrixWorld(!1===obj.visible||void 0),obj.ignoreMatrix||(Utils3D.decompose(obj,clone),clone.overrideScale&&clone.scale.setScalar(clone.overrideScale)))}_this.preventRTDraw||(RenderStats.update("FXScene",1,_this),_nuke.rtt=_rt,camera&&RenderManager.type==RenderManager.WEBVR&&(_nuke.rtt=_this.vrRT.get(camera)),_nuke.render()),_nuke.renderer.overridePreventShadows=!1,_this.clearColor&&_nuke.renderer.setClearColor(clearColor),_this.clearAlpha>-1&&_nuke.renderer.setClearAlpha(_this.clearAlpha)},this.setDPR=function(dpr){return _nuke?(_nuke.dpr=dpr,resizeHandler(),_this):_this},this.addPass=function(pass){_nuke&&_nuke.add(pass)},this.removePass=function(pass){_nuke&&_nuke.remove(pass)},this.setResolution=function(res){return _this.resolution=res,resizeHandler(),this},this.useRT=function(rt){_rt=_this.rt=rt},this.upload=function(){_rt&&_rt.upload()},this.useCamera=function(camera){_this.nuke.camera=camera.camera||camera},this.useScene=function(scene){_this.nuke.scene=scene},this.vrWorldMode=function(){_this.isVrWorldMode=!0,_this.group=new Group;for(let i=0;i<this.scene.children.length;i++)this.group.add(this.scene.children[i]);_scene=_this.scene=_this.group,World.SCENE.add(_this.group)},this.vrSceneMode=function(){_this.isVrSceneMode=!0,World.NUKE.autoClear=!1,RenderManager.renderer.autoClear=!1},this.createDepthTexture=function(useRTTBuffer){return _this.depthTexture||(_this.nuke.passes.length||useRTTBuffer?(_this.nuke.rttBuffer.createDepthTexture(),_this.depthTexture=_this.nuke.rttBuffer.depth):(_this.rt.createDepthTexture(),_this.depthTexture=_this.rt.depth)),_this.depthTexture},_parentNuke instanceof Nuke&&this.create(_parentNuke,_type)})),Class((function BlitPass(_forceNuke){Inherit(this,NukePass);this.uniforms={},this.init("BlitPass"),_forceNuke||(this.blitFramebuffer=!0)})),Class((function Nuke(_stage,_params){Inherit(this,Component);var _width,_height,_nukeMesh,_this=this;_params.renderer||console.error("Nuke :: Must define renderer"),_this.stage=_stage,_this.renderer=_params.renderer,_this.camera=_params.camera,_this.scene=_params.scene,_this.rtt=_params.rtt,_this.enabled=0!=_params.enabled,_this.passes=_params.passes||[],_this.useDrawBuffers=void 0!==_params.useDrawBuffers?_params.useDrawBuffers:!(Renderer.type!=Renderer.WEBGL2&&!window.Metal)||!Utils.query("noDrawBuffers")&&!Nuke.NO_DRAWBUFFERS&&Device.graphics.webgl&&Device.graphics.webgl.detect("draw_buffers");var _rttPing,_rttPong,_rttBuffer,_dpr=_params.dpr||1,_drawBuffers=[];function resizeHandler(){var width=_this.stage.width*_dpr,height=_this.stage.height*_dpr;_rttPing.setSize(width,height),_rttPong.setSize(width,height),_rttBuffer.setSize(width,height)}_this.scene.nuke=_this,function initNuke(){let width=_this.stage.width*_dpr,height=_this.stage.height*_dpr;_rttPing=Nuke.getRT(width,height,!1,1),_rttPong=Nuke.getRT(width,height,!1,2),_rttBuffer=Nuke.getRT(width,height,_this.useDrawBuffers),(_nukeMesh=new Mesh(World.QUAD,null)).frustumCulled=!1,_nukeMesh.noMatrices=!0,_nukeMesh.transient=!0,_width=width,_height=height}(),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),_this.onBeforeShaderCompile=function(obj){if(!obj)return;let shader=obj.shader;if(!(shader&&shader.fragmentShader&&_this.useDrawBuffers&&_drawBuffers.length))return;const WEBGL2=Renderer.type==Renderer.WEBGL2;let key=WEBGL2?" Color ":"gl_FragData[0]";if(!shader.fragmentShader.includes(key)){let fs=shader.fragmentShader;WEBGL2||(fs="#extension GL_EXT_draw_buffers : require\n"+fs),fs=fs.split("void main() {"),fs=fs[0]+"void main() {\nvec4 tmpFragColor;\n"+fs[1],fs=fs.replace(/gl_FragColor/g,"tmpFragColor");let idx=fs.lastIndexOf("}");fs=fs.slice(0,idx)+"#drawbuffer Color gl_FragColor = tmpFragColor;\n"+fs.slice(idx),shader.fragmentShader=fs}_drawBuffers.forEach((t,i)=>{let name=t.fxLayer.getName(),key=WEBGL2?name+" =":`gl_FragData[${i+1}]`;if(!shader.fragmentShader.includes(key)){let fs=shader.fragmentShader,idx=fs.lastIndexOf("}");fs=fs.slice(0,idx)+`#drawbuffer ${name} gl_FragColor = vec4(0.0);\n`+fs.slice(idx),shader.fragmentShader=fs,t.fxLayer.add(obj)}})},_this.add=function(pass,index){"number"!=typeof index?_this.passes.push(pass):_this.passes.splice(index,0,pass)},_this.remove=function(pass){"number"==typeof pass?_this.passes.splice(pass):_this.passes.remove(pass)},_this.render=function(directCallback){if(RenderStats.update("Nuke"),_this.events.fire(Nuke.RENDER,_this,!0),_this.onBeforeRender&&_this.onBeforeRender(),!_this.enabled||!_this.passes.length){let autoClear=_this.renderer.autoClear;return 0==_this.autoClear&&(_this.renderer.autoClear=!1),_this.renderer.render(_this.scene,_this.camera,_this.rtt,null,directCallback),_this.onBeforeProcess&&_this.onBeforeProcess(),_this.postRender&&_this.postRender(),_this.events.fire(Nuke.POST_RENDER,_this,!0),void(0==_this.autoClear&&(_this.renderer.autoClear=autoClear,_this.renderer.clearColor()))}RenderStats.update("NukePass",_this.passes.length),_this.hasRendered=!0,_this.onBeforeProcess&&_this.onBeforeProcess();let autoClear=_this.renderer.autoClear;0==_this.autoClear&&(_this.renderer.autoClear=!1),_this.renderer.render(_this.scene,_this.camera,_rttBuffer,!0),0==_this.autoClear&&(_this.renderer.autoClear=autoClear);let usedBuffer=!1,pingPong=!0,count=_this.passes.length;for(var i=0;i<count;i++){if(_this.passes[i].disabled)continue;let shader=_this.passes[i].pass,inTexture=usedBuffer?pingPong?_rttPing.texture:_rttPong.texture:_rttBuffer.texture,outTexture=pingPong?_rttPong:_rttPing;i==count-1&&(outTexture=_this.rtt),_nukeMesh.shader=shader,_nukeMesh.shader.depthTest=!1,_nukeMesh.shader.depthWrite=!1,_nukeMesh.shader.uniforms.tDiffuse.value=inTexture,_this.renderer.renderSingle(_nukeMesh,_this.camera||World.CAMERA,outTexture,i==count-1?directCallback:null),usedBuffer=!0,pingPong=!pingPong}_this.postRender&&_this.postRender(),_this.events.fire(Nuke.POST_RENDER,_this,!0),0==_this.autoClear&&_this.renderer.clearColor(_rttBuffer)},_this.setSize=function(width,height){width==_width&&height==_height||(_width=width,_height=height,resizeHandler())},_this.attachDrawBuffer=function(texture){if(_this.hasRendered&&console.warn("Attempt to attach draw buffer after first render! Create FXLayer instance before first render."),_drawBuffers.push(texture),_rttBuffer&&_rttBuffer.attachments){_rttBuffer.attachments=[_this.rtt&&_this.rtt.attachments?_this.rtt.attachments[0]:_rttBuffer.attachments[0]];for(let i=0;i<_drawBuffers.length;i++)_rttBuffer.attachments.push(_drawBuffers[i]),_this.rtt&&_this.rtt.attachments&&_this.rtt.attachments.push(_drawBuffers[i])}return _drawBuffers.length},_this.upload=function(){_this.passes.length&&_this.enabled&&(_rttPing.upload(),_rttPong.upload(),_rttBuffer.upload()),_rttBuffer.depth&&_rttBuffer.depth.upload(),_this.rtt&&_this.rtt.upload()},_this.set("dpr",(function(v){_dpr=v,resizeHandler()})),_this.get("dpr",(function(){return _dpr})),_this.get("output",(function(){return _nukeMesh.shader&&_nukeMesh.shader.uniforms?_nukeMesh.shader.uniforms.tDiffuse.value:null})),_this.get("rttBuffer",(function(){return _rttBuffer})),this.set("rttBuffer",(function(v){_rttBuffer=v})),_this.get("prevFrameRT",(function(){return _rttBuffer&&_rttBuffer.texture?_rttBuffer.texture:null})),_this.get("nukeScene",(function(){return _nukeScene})),_this.get("ping",(function(){return _rttPing})),_this.get("pong",(function(){return _rttPong})),_this.get("attachments",(function(){return _rttBuffer.attachments.length})),this.onDestroy=function(){_rttBuffer.destroy()}}),(function(){Nuke.RENDER="nuke_render",Nuke.POST_RENDER="nuke_post_render";var _rts={};Nuke.getRT=function(width,height,multi,index){let rt,exists=_rts[`${width}_${height}_${multi}_${index}`];return exists||(rt=multi?Utils3D.createMultiRT(width,height):Utils3D.createRT(width,height),index>0&&Nuke.recyclePingPong&&(_rts[`${width}_${height}_${multi}_${index}`]=rt),rt)}})),Class((function NukePass(_fs,_uniforms,_pass){Inherit(this,Component);var _this=this;this.UILPrefix="string"==typeof _fs?_fs:Utils.getConstructorName(_fs),this.init=function(fs,vs){if(_this.pass)return;_this=this;fs||this.constructor.toString().match(/function ([^\(]+)/)[1],Array.isArray(fs)&&fs.join("");if(_this.uniforms=_uniforms||_this.uniforms||{},_this.uniforms.tDiffuse={type:"t",value:null,ignoreUIL:!0},_this.uniforms.unique&&(_this.UILPrefix+="_"+_this.uniforms.unique+"_"),window.UILStorage)for(let key in _this.uniforms)"unique"!==key&&(_this.uniforms[key]=UILStorage.parse(_this.UILPrefix+key,_this.uniforms[key].value)||_this.uniforms[key]);_this.pass=_this.initClass(Shader,vs||"NukePass",fs,Utils.mergeObject(_this.uniforms,{precision:"high"}),(code,type)=>"fs"==type?function prefix(code){if(!code)throw`No shader ${_fs} found`;let pre="";return code.includes("uniform sampler2D tDiffuse")||(pre+="uniform sampler2D tDiffuse;\n",pre+="varying vec2 vUv;\n"),code=pre+code}(code):code),_this.uniforms=_this.pass.uniforms},this.set=function(key,value){TweenManager.clearTween(_this.uniforms[key]),_this.uniforms[key].value=value},this.get=function(key){return void 0===_this.uniforms[key]?null:_this.uniforms[key].value},this.tween=function(key,value,time,ease,delay,callback,update){return tween(_this.uniforms[key],{value:value},time,ease,delay,callback,update)},this.clone=function(){return _this.pass||_this.init(_fs),new NukePass(null,null,_this.pass.clone())},this.upload=function(){_this.pass.upload()},"string"==typeof _fs?_this.init(_fs):_pass&&(_this.pass=_pass,_this.uniforms=_pass.uniforms)})),Class((function Raycaster(_camera){Inherit(this,Component);const _this=this;let _mouse=new Vector3,_raycaster=new RayManager;function ascSort(a,b){return a.distance-b.distance}function intersect(objects){Array.isArray(objects)||(objects=[objects]);let intersects=[];return objects.forEach(object=>{!function intersectObject(object,raycaster,intersects,recursive){let obj=object;for(;obj&&_this.testVisibility;){if(!1===obj.visible&&!obj.forceRayVisible&&!1!==obj.testVisibility)return;obj=obj.parent}if(object.raycast&&(object.raycast(raycaster,intersects),!0===recursive)){let children=object.children;for(let i=0,l=children.length;i<l;i++)intersectObject(children[i],raycaster,intersects,!0)}}(object,_raycaster,intersects,!1)}),intersects.sort(ascSort),intersects}this.testVisibility=!0,this.set("camera",(function(camera){_camera=camera})),this.set("pointsThreshold",(function(value){_raycaster.params.Points.threshold=value})),this.get("ray",()=>_raycaster.ray),this.checkHit=function(objects,mouse,rect=Stage){return mouse=mouse||Mouse,_mouse.x=mouse.x/rect.width*2-1,_mouse.y=-mouse.y/rect.height*2+1,_raycaster.setFromCamera(_mouse,_camera),intersect(objects)},this.checkFromValues=function(objects,origin,direction){return _raycaster.set(origin,direction,0,Number.POSITIVE_INFINITY),intersect(objects)}}),_=>{var _ray,_map=new WeakMap;Raycaster.checkHit=function(objects,mouse){return _ray||(_ray=new Raycaster(World.CAMERA)),_ray.checkHit(objects,mouse)},Raycaster.checkFromValues=function(objects,origin,direction){return _ray||(_ray=new Raycaster(World.CAMERA)),_ray.checkFromValues(objects,origin,direction)},Raycaster.find=function(camera){if(!_map.has(camera)){let ray=new Raycaster(camera);_map.set(camera,ray)}return _map.get(camera)}}),Class((function ScreenProjection(_camera){Inherit(this,Component);var _v3=new Vector3,_v32=new Vector3,_value=new Vector3;_camera=_camera.camera||_camera,this.set("camera",(function(v){_camera=v.camera||v})),this.get("camera",_=>_camera),this.unproject=function(mouse,rect=Stage,distance=1){"number"==typeof rect&&(distance=rect,rect=Stage),_v3.set(mouse.x/rect.width*2-1,-mouse.y/rect.height*2+1,.5),_v3.unproject(_camera);let pos=_camera.getWorldPosition();return _v3.sub(pos).normalize().multiplyScalar(distance),_value.copy(pos).add(_v3),_value},this.project=function(pos,screen){return screen=screen||Stage,pos instanceof Base3D?(pos.updateMatrixWorld(),_v32.set(0,0,0).setFromMatrixPosition(pos.matrixWorld)):_v32.copy(pos),_v32.project(_camera),_v32.x=(_v32.x+1)/2*screen.width,_v32.y=-(_v32.y-1)/2*screen.height,_v32}}),_=>{var _screen,_map=new WeakMap;ScreenProjection.unproject=function(mouse,distance){return _screen||(_screen=new ScreenProjection(World.CAMERA)),_screen.unproject(mouse,distance)},ScreenProjection.project=function(pos,screen){return _screen||(_screen=new ScreenProjection(World.CAMERA)),_screen.project(pos,screen)},ScreenProjection.find=function(camera){if(!_map.has(camera)){let projection=new ScreenProjection(camera);_map.set(camera,projection)}return _map.get(camera)}}),Class((function Object3D(){Inherit(this,Component);var _this=this,_visible=!0;this.__element=!0,this.group=new Group,this.group.classRef=this,this.add=function(child){this.group.add(child.group||child)},this.remove=function(child){this.group.remove(child.group||child)},this.onDestroy=function(){this.group.deleted=!0,this.group.classRef=null,this.group&&this.group.parent&&this.group.parent.remove(this.group)},this.set("visible",v=>_this.group.visible=_visible=v),this.get("visible",_=>_visible)})),Class((function Utils3D(){const _this=this;var _emptyTexture,_q,_textures={};window.Vec2=window.Vector2,window.Vec3=window.Vector3,async function(){await Hydra.ready();let threads=Thread.shared(!0);for(let i=0;i<threads.array.length;i++)_this.loadEngineOnThread(threads.array[i])}(),this.decompose=function(local,world){local.matrixWorld.decompose(world.position,world.quaternion,world.scale)},this.createDebug=function(size=1,color){return new Mesh(new IcosahedronGeometry(size,1),_this.getTestShader(color))},this.getTestShader=function(color){return color?new Shader("ColorMaterial",{color:{value:color instanceof Color?color:new Color(color)},alpha:{value:1}}):new Shader("TestMaterial")},this.createMultiRT=function(width,height,type,format){let rt=new MultiRenderTarget(width,height,{minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:format||Texture.RGBFormat,type:type});return rt.texture.generateMipmaps=!1,rt},this.createRT=function(width,height,type,format){let rt=new RenderTarget(width,height,{minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:format||Texture.RGBFormat,type:type});return rt.texture.generateMipmaps=!1,rt},this.getFloatType=function(){return"android"==Device.system.os?Texture.FLOAT:Texture.HALF_FLOAT},this.getTexture=function(path,params={}){if(!Device.graphics.webgl&&!window.AURA){let texture=new Texture;return texture.promise=Promise.resolve(),texture.dimensions={width:0,height:0},texture}if(path.includes("://")){let guard=path.split("://");guard[1]=guard[1].replace(/\/\//g,"/"),path=guard.join("://")}else path=path.replace(/\/\//g,"/");let cacheBust=path.includes("?");if(cacheBust&&(path=path.split("?")[0]),_textures[path])_textures[path].exists++;else{let texture=new Texture;texture.exists=1,texture.loaded=!1,texture.compressed=path.includes("compressedKtx"),texture.promise=Promise.create(),texture._destroy=texture.destroy,texture.destroy=function(){texture.forcePersist||--texture.exists>0||(delete _textures[path],this._destroy())},_textures[path]=texture,texture.format=path.match(/jpe?g/)?Texture.RGBFormat:Texture.RGBAFormat,texture.src=path,!1===params.premultiplyAlpha&&(texture.premultiplyAlpha=!1),_this.onTextureCreated&&_this.onTextureCreated(texture);let cb=imgBmp=>{imgBmp.crossOrigin="anonymous",texture.image=imgBmp,texture.dimensions={width:imgBmp.width,height:imgBmp.height},texture.loaded=!0,texture.needsReupload=!0,Math.isPowerOf2(imgBmp.width,imgBmp.height)||(texture.minFilter=Texture.LINEAR,texture.generateMipmaps=!1),imgBmp.gliFormat&&(texture.minFilter=Texture.LINEAR),texture.onUpdate=function(){!params.preserveData&&imgBmp.close&&imgBmp.close(),texture.onUpdate=null},texture.promise.resolve(),texture.onload&&(texture.onload(),texture.onload=null)},imgPath=cacheBust?path+"?"+Date.now():path;ImageDecoder.decode(imgPath,params).then(cb).catch(e=>{texture.promise.reject(e)})}return _textures[path]},this.getLookupTexture=function(path){let texture=_this.getTexture(path);return texture.minFilter=texture.magFilter=Texture.NEAREST,texture.generateMipmaps=!1,texture},this.clearTextureCache=function(){for(let key in _textures)_textures[key].destroy();_textures={}},this.loadCurve=function(obj){"string"==typeof obj&&((obj=Assets.JSON[obj]).curves=obj.curves[0]);let data=obj.curves,points=[];for(let j=0;j<data.length;j+=3)points.push(new Vector3(data[j+0],data[j+1],data[j+2]));if(!window.CatmullRomCurve)throw"loadCurve requires curve3d module";return new CatmullRomCurve(points)},this.getEmptyTexture=function(){return _emptyTexture||(_emptyTexture=new Texture),_emptyTexture},this.getRepeatTexture=function(src,scale){let texture=_this.getTexture(src,scale);return texture.wrapS=texture.wrapT=Texture.REPEAT,texture},this.findTexturesByPath=function(path){let array=[];for(let key in _textures)key.includes(path)&&array.push(_textures[key]);return array},this.getHeightFromCamera=function(camera,dist){camera=camera.camera||camera,dist||(dist=camera.position.length());let fov=camera.fov;return 2*dist*Math.tan(.5*Math.radians(fov))},this.getPositionFromCameraSize=function(camera,size){camera=camera.camera||camera;let fov=Math.radians(camera.fov);return Math.abs(size/Math.sin(fov/2))},this.loadEngineOnThread=function(thread){["Base3D","CameraBase3D","Mesh","OrthographicCamera","PerspectiveCamera","Geometry","GeometryAttribute","Points","Scene","BoxGeometry","CylinderGeometry","PlaneGeometry","PolyhedronGeometry","IcosahedronGeometry","SphereGeometry","Box2","Box3","Face3","Color","Cylindrical","Euler","Frustum","Line3","Matrix3","Matrix4","Plane","Quaternion","Ray","Sphere","Spherical","Triangle","Vector2","Vector3","Vector4","RayManager","Vector3D","Group"].forEach(name=>{thread.importES6Class(name)}),thread.importCode(`Class(${zUtils3D.constructor.toString()}, 'static')`)},this.billboard=function(mesh,camera=World.CAMERA){_q||(_q=new Quaternion),mesh._parent?(mesh._parent.getWorldQuaternion(_q).inverse(),_q.multiply(camera.quaternion),mesh.quaternion.copy(_q)):mesh.quaternion.copy(World.CAMERA.quaternion)},this.getQuad=function(){let geom=new Geometry,position=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),uv=new Float32Array([0,0,2,0,0,2]);return geom.addAttribute("position",new GeometryAttribute(position,3)),geom.addAttribute("uv",new GeometryAttribute(uv,2)),geom}}),"static"),window.WebGLRenderingContext&&function(){"use strict";var e={};function r(r,t){var i;e[r]=!0,void 0!==t&&(i=t,window.console&&window.console.error&&window.console.error(i))}var t=function e(r){var t=r.gl;this.ext=r,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(r.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var a=new e.VertexAttrib(t);this.attribs[i]=a}this.maxAttrib=0};(t.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var i=function(r){var t,i,a=this;this.gl=r,i=(t=r).getError,t.getError=function(){do{(r=i.apply(t))!=t.NO_ERROR&&(e[r]=!0)}while(r!=t.NO_ERROR);for(var r in e)if(e[r])return delete e[r],parseInt(r);return t.NO_ERROR};var n=this.original={getParameter:r.getParameter,enableVertexAttribArray:r.enableVertexAttribArray,disableVertexAttribArray:r.disableVertexAttribArray,bindBuffer:r.bindBuffer,getVertexAttrib:r.getVertexAttrib,vertexAttribPointer:r.vertexAttribPointer};r.getParameter=function(e){return e==a.VERTEX_ARRAY_BINDING_OES?a.currentVertexArrayObject==a.defaultVertexArrayObject?null:a.currentVertexArrayObject:n.getParameter.apply(this,arguments)},r.enableVertexAttribArray=function(e){var r=a.currentVertexArrayObject;return r.maxAttrib=Math.max(r.maxAttrib,e),r.attribs[e].enabled=!0,n.enableVertexAttribArray.apply(this,arguments)},r.disableVertexAttribArray=function(e){var r=a.currentVertexArrayObject;return r.maxAttrib=Math.max(r.maxAttrib,e),r.attribs[e].enabled=!1,n.disableVertexAttribArray.apply(this,arguments)},r.bindBuffer=function(e,t){switch(e){case r.ARRAY_BUFFER:a.currentArrayBuffer=t;break;case r.ELEMENT_ARRAY_BUFFER:a.currentVertexArrayObject.elementArrayBuffer=t}return n.bindBuffer.apply(this,arguments)},r.getVertexAttrib=function(e,t){var i=a.currentVertexArrayObject.attribs[e];switch(t){case r.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return i.buffer;case r.VERTEX_ATTRIB_ARRAY_ENABLED:return i.enabled;case r.VERTEX_ATTRIB_ARRAY_SIZE:return i.size;case r.VERTEX_ATTRIB_ARRAY_STRIDE:return i.stride;case r.VERTEX_ATTRIB_ARRAY_TYPE:return i.type;case r.VERTEX_ATTRIB_ARRAY_NORMALIZED:return i.normalized;default:return n.getVertexAttrib.apply(this,arguments)}},r.vertexAttribPointer=function(e,r,t,i,s,A){var o=a.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,e);var c=o.attribs[e];return c.buffer=a.currentArrayBuffer,c.size=r,c.type=t,c.normalized=i,c.stride=s,c.offset=A,c.recache(),n.vertexAttribPointer.apply(this,arguments)},r.instrumentExtension&&r.instrumentExtension(this,"OES_vertex_array_object"),r.canvas.addEventListener("webglcontextrestored",(function(){window.console&&window.console.log&&window.console.log("OESVertexArrayObject emulation library context restored"),a.reset_()}),!0),this.reset_()};i.prototype.VERTEX_ARRAY_BINDING_OES=34229,i.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var r=this.gl;this.maxVertexAttribs=r.getParameter(r.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new t(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},i.prototype.createVertexArrayOES=function(){var e=new t(this);return this.vertexArrayObjects.push(e),e},i.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},i.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof t&&e.hasBeenBound&&e.ext==this)},i.prototype.bindVertexArrayOES=function(e){var t=this.gl;if(!e||e.isAlive){var i=this.original,a=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var n=this.currentVertexArrayObject;if(a!=n){a&&n.elementArrayBuffer==a.elementArrayBuffer||i.bindBuffer.call(t,t.ELEMENT_ARRAY_BUFFER,n.elementArrayBuffer);for(var s=this.currentArrayBuffer,A=Math.max(a?a.maxAttrib:0,n.maxAttrib),o=0;o<=A;o++){var c=n.attribs[o],b=a?a.attribs[o]:null;if(a&&c.enabled==b.enabled||(c.enabled?i.enableVertexAttribArray.call(t,o):i.disableVertexAttribArray.call(t,o)),c.enabled){var u=!1;a&&c.buffer==b.buffer||(s!=c.buffer&&(i.bindBuffer.call(t,t.ARRAY_BUFFER,c.buffer),s=c.buffer),u=!0),(u||c.cached!=b.cached)&&i.vertexAttribPointer.call(t,o,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!=s&&i.bindBuffer.call(t,t.ARRAY_BUFFER,this.currentArrayBuffer)}}else r(t.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},function(){var e=WebGLRenderingContext.prototype.getSupportedExtensions;WebGLRenderingContext.prototype.getSupportedExtensions=function(){var r=e.call(this)||[];return r.indexOf("OES_vertex_array_object")<0&&r.push("OES_vertex_array_object"),r};var r=WebGLRenderingContext.prototype.getExtension;WebGLRenderingContext.prototype.getExtension=function(e){return r.call(this,e)||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new i(this)),this.__OESVertexArrayObject))}}()}(),Class((function GeomThread(){Inherit(this,Component);const _this=this;var _cache={},_cacheWait={},_receive={};function computeBounding(data){let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(data.position,3)),geom.computeBoundingBox(),geom.computeBoundingSphere(),data.boundingBox=geom.boundingBox,data.boundingSphere=geom.boundingSphere}function loadGeometry(e,id){get(e.path).then(data=>{let buffers=[];for(let key in data)Array.isArray(data[key])?(data[key]=new Float32Array(data[key]),buffers.push(data[key].buffer)):data[key].length>0&&buffers.push(data[key].buffer);computeBounding(data),e.custom&&self[e.custom](data),resolve(data,id,buffers)}).catch(er=>{e.preloading||console.error(er)})}function loadSkinnedGeometry(e,id){get(e.path).then(data=>{let buffers=[];for(let key in data)"bones"!=key&&(Array.isArray(data[key])?(data[key]=new Float32Array(data[key]),buffers.push(data[key].buffer)):data[key].length>0&&buffers.push(data[key].buffer));computeBounding(data),e.custom&&self[e.custom](data),resolve(data,id,buffers)})}function geom_useFn(e){Global.FNS||(Global.FNS=[]),Global.FNS.push(e.name)}this.caching=!0,async function(){await Hydra.ready(),Thread.upload(loadGeometry,loadSkinnedGeometry,geom_useFn,computeBounding)}(),this.loadGeometry=function(path,custom,preloading){if(!Device.graphics.gpu)return Promise.resolve(new PlaneGeometry(1,1));if(_cache[path])return Promise.resolve(_cache[path]);if(path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),path=Thread.absolutePath(Assets.getPath(path)),_this.caching){if(_cacheWait[path])return _cacheWait[path];_cacheWait[path]=Promise.create()}return Thread.shared().loadGeometry({path:path,custom:custom,preloading:preloading}).then(data=>{let geometry;if(custom&&_receive[custom])geometry=_receive[custom](data);else{let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(data.position,3)),geom.addAttribute("normal",new GeometryAttribute(data.normal||data.position.length,3)),geom.addAttribute("uv",new GeometryAttribute(data.uv||data.position.length/3*2,2)),data.uv2&&geom.addAttribute("uv2",new GeometryAttribute(data.uv2,2)),geom.boundingBox=new Box3((new Vector3).set(data.boundingBox.min.x,data.boundingBox.min.y,data.boundingBox.min.z),(new Vector3).set(data.boundingBox.max.x,data.boundingBox.max.y,data.boundingBox.max.z)),geom.boundingSphere=new Sphere((new Vector3).set(data.boundingSphere.center.x,data.boundingSphere.center.y,data.boundingSphere.center.z),data.boundingSphere.radius),geometry=geom,geom._src=path}_this.caching&&(_cache[path]=geometry),_cacheWait[path].resolve(geometry)}),_cacheWait[path]},this.loadSkinnedGeometry=function(path,custom){if(!Device.graphics.webgl)return Promise.resolve(new PlaneGeometry(1,1));if(_cache[path])return Promise.resolve(_cache[path]);if(path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),path=Thread.absolutePath(Assets.getPath(path)),_this.caching){if(_cacheWait[path])return _cacheWait[path];_cacheWait[path]=Promise.create()}return Thread.shared().loadSkinnedGeometry({path:path,custom:custom}).then(data=>{let geometry;if(custom&&_receive[custom])geometry=_receive[custom](data);else{let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(data.position,3)),geom.addAttribute("normal",new GeometryAttribute(data.normal||data.position.length,3)),geom.addAttribute("uv",new GeometryAttribute(data.uv||data.position.length/3*2,2)),geom.addAttribute("skinIndex",new GeometryAttribute(data.skinIndex,4)),geom.addAttribute("skinWeight",new GeometryAttribute(data.skinWeight,4)),geom.bones=(data.rig?data.rig.bones:data.bones).slice(0),geom.boundingBox=new Box3((new Vector3).set(data.boundingBox.min.x,data.boundingBox.min.y,data.boundingBox.min.z),(new Vector3).set(data.boundingBox.max.x,data.boundingBox.max.y,data.boundingBox.max.z)),geom.boundingSphere=new Sphere((new Vector3).set(data.boundingSphere.center.x,data.boundingSphere.center.y,data.boundingSphere.center.z),data.boundingSphere.radius),geometry=geom,geom._src=path}_this.caching&&(_cache[path]=geometry),_cacheWait[path].resolve(geometry)}),_cacheWait[path]},this.customFunction=function(fn,receive){let name=Thread.upload(fn);name=name[0],t.geom_useFn({name:name}),_receive[name]=receive}}),"static"),Class((function InstanceMesh(_mesh,_shader,_group,_input){Inherit(this,Component);const _this=this;var _config,_shaderKey;function updateShader(shader){let prefetchCode=Shaders.getShader(shader.vsName+".vs");if(prefetchCode&&prefetchCode.includes("transformPosition(vec3 position"))return;shader.customCompile=`${shader.vsName}|${shader.fsName}|instance`,shader.resetProgram();let cached=MeshBatch.shaders[`${shader.vsName}|${shader.fsName}`];if(cached)return shader.fragmentShader=cached.fragment,void(shader.vertexShader=cached.vertex);let vsSplit=shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__");if(!vsSplit[1].includes("vec3 pos = position;"))throw`Shader ${shader.vsName} needs to have "vec3 pos = position;" in order for batching to work`;vsSplit[1]=vsSplit[1].replace(/vec3 pos = position;/g,"vec3 pos = transformPosition(position, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/vNormal = normalMatrix \* normal;/g,"vNormal = normalMatrix * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vec3 transformedNormal = normal;/g,"vec3 transformedNormal = transformNormal(normal, orientation);"),vsSplit[0]+="\n",vsSplit[0]+="#define INSTANCED 1\n",vsSplit[0]+="attribute vec3 offset;\n",vsSplit[0]+="attribute vec3 scale;\n",vsSplit[0]+="attribute vec4 orientation;\n",vsSplit[0]+=Shaders.getShader("instance.vs")+"\n",vsSplit=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),fsSplit=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=vsSplit,shader.fragmentShader=fsSplit,_shaderKey=`${shader.vsName}|${shader.fsName}`,MeshBatch.shaders[_shaderKey]={fragment:shader.fragmentShader,vertex:shader.vertexShader}}!function(){if((_config=InputUIL.create("im_"+_input.prefix,_group)).add("json"),_config.setLabel("Instance"),!1===_input.get("visible"))return;_mesh.visible=!1,_mesh.instanceMeshReady=Promise.create(),_mesh.instanceMeshBeforeReady=Promise.create();let json=_config.get("json");json&&async function createInstanceMesh(json){json.includes("assets/geometry")||(json="assets/geometry/"+json);json.includes(".json")||(json+=".json");let geom=(new Geometry).instanceFrom(_mesh.geometry),buffers=await Thread.shared().parseInstanceMesh({url:Thread.absolutePath(Assets.getPath(json))});for(let key in buffers){let b=buffers[key];geom.addAttribute(key,new GeometryAttribute(b.buffer,b.components,1))}let shader=_mesh.shader;updateShader(shader);let mesh=new Mesh(geom,shader);mesh.renderOrder=_mesh.renderOrder,mesh.castShadow=_mesh.castShadow,mesh.frustumCulled=!1,_mesh._parent.add(mesh),_mesh.instanceMesh=mesh,_mesh.instanceMeshReady.resolve(),_this.startRender(_=>{mesh.renderOrder=_mesh.renderOrder,mesh.castShadow=_mesh.castShadow},10)}(json)}(),this.applyToShader=function(shader){updateShader(shader)},this.onDestroy=function(){_mesh.instanceMesh&&_mesh.instanceMesh.destroy(),delete MeshBatch.shaders[_shaderKey]}}),_=>{Thread.upload((function parseInstanceMesh({url:url},id){get(url).then(data=>{let buffers=[];for(let key in data)data[key].buffer=new Float32Array(data[key].buffer),buffers.push(data[key].buffer.buffer);resolve(data,id,buffers)})}))}),Class((function MeshBatch(_input,_config){Inherit(this,Object3D);const _this=this;var _geom,_shader,_mesh,_firstRender,_static,_shaderKey,_renderOrder=0,_objects=[],_offset=[],_quaternion=[],_scale=[],_attributes={},_uniformToAttrib=[],_frustumCulled=!0,_v1=new Vector3,_v2=new Vector3,_q=new Quaternion,_list=new LinkedList;async function initFromSceneLayout(){let wildcard=_input.get("wildcard");if(!wildcard||!wildcard.length)return;let groupName=wildcard.split("|")[0],group=await _this.parent.getLayer(groupName);await _this.wait(group.children,"length");let children=[...group.children];children.sort((a,b)=>a.renderOrder-b.renderOrder),children.forEach(mesh=>_this.add(mesh)),wildcard.includes("static")&&(_this.static=!0),_this.group.renderOrder=children[0].renderOrder,group.add(_this.group)}function updateShader(shader){let prefetchCode=Shaders.getShader(shader.vsName+".vs");if(prefetchCode&&prefetchCode.includes("transformPosition(vec3 position"))return;shader.customCompile=`${shader.vsName}|${shader.fsName}|instance`;let cached=MeshBatch.shaders[`${shader.vsName}|${shader.fsName}`];if(cached)return shader.fragmentShader=shader.restoreFS=cached.fragment,shader.vertexShader=shader.restoreVS=cached.vertex,shader.resetProgram();shader.resetProgram();let vsSplit=shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__");if(!vsSplit[1].includes("vec3 pos = position;")&&!vsSplit[1].includes("pos = pos;")&&!shader.vertexShader.includes("vec3 transformPosition"))throw`Shader ${shader.vsName} needs to have "vec3 pos = position;" in order for batching to work`;let definitions=[];vsSplit[1].split("\n").forEach(line=>{if(line.includes("uniform")){if(line.includes("sampler2D"))return;let data=line.split(" "),uni=data[2].replace(";","");(function uniformToAttrib(key){for(let i=0;i<_uniformToAttrib.length;i++){let val=_uniformToAttrib[i];if(key.includes(val)||val.includes(key))return!0}return!1})(uni)&&(definitions.push(`${uni} = a_${data[2]}`),vsSplit[1]=vsSplit[1].replace(line,`attribute ${data[1]} a_${data[2]}\nvarying ${data[1]} ${data[2]}`),fsSplit[1]=fsSplit[1].replace(line,`varying ${data[1]} ${data[2]}`))}}),vsSplit[1]=vsSplit[1].replace(/vec3 pos = position;/g,"vec3 pos = transformPosition(position, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/pos = pos;/g,"pos = transformPosition(pos, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/vNormal = normalMatrix \* normal;/g,"vNormal = normalMatrix * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vec3 transformedNormal = normal;/g,"vec3 transformedNormal = transformNormal(normal, orientation);");let main=vsSplit[1].split("main() {");main[1]="\n"+definitions.join("\n")+main[1],vsSplit[1]=main.join("main() {"),vsSplit[0]+="\n",vsSplit[0]+="attribute vec3 offset;\n",vsSplit[0]+="attribute vec3 scale;\n",vsSplit[0]+="attribute vec4 orientation;\n",shader.vertexShader.includes("vec3 transformPosition")||(vsSplit[0]+=Shaders.getShader("instance.vs")+"\n"),vsSplit=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),fsSplit=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=vsSplit,shader.fragmentShader=fsSplit,_shaderKey=`${shader.vsName}|${shader.fsName}`,MeshBatch.shaders[_shaderKey]={fragment:shader.fragmentShader,vertex:shader.vertexShader}}function modifyGeometry(dir){let count=_geom.attributes.offset.count+dir;_offset=new Float32Array(3*count),_scale=new Float32Array(3*count),_quaternion=new Float32Array(4*count),_geom.attributes.offset.setArray(new Float32Array(3*count)),_geom.attributes.scale.setArray(new Float32Array(3*count)),_geom.attributes.orientation.setArray(new Float32Array(4*count));for(let key in _attributes){let components=_geom.attributes[key].itemSize;_attributes[key]=new Float32Array(count*components),_geom.attributes[key].setArray(new Float32Array(count*components))}_geom.maxInstancedCount=_objects.length,loop()}function dirty(a,b){for(let i=a.length-1;i>-1;i--)if(a[i]!=b[i])return!0;return!1}function prepareMesh(mesh,i){let pos=_v1,scale=_v2,quaternion=_q;if(_config.worldCoords)try{if(_config.parent>0)switch(_config.parent){case 1:pos.copy(mesh._parent.position),scale.copy(mesh._parent.scale),quaternion.copy(mesh._parent.quaternion);break;case 2:pos.copy(mesh._parent._parent.position),scale.copy(mesh._parent._parent.scale),quaternion.copy(mesh._parent._parent.quaternion)}else _config.addParentPosition?(pos.copy(mesh.position).add(mesh._parent.position),2==_config.addParentPosition&&pos.add(mesh._parent._parent.position),scale.copy(mesh.scale),quaternion.copy(mesh.quaternion)):(pos.copy(mesh.getWorldPosition()),scale.copy(mesh.getWorldScale()),quaternion.copy(mesh.getWorldQuaternion()));mesh.determineVisible()||(scale.x=scale.y=scale.z=0)}catch(e){pos.copy(mesh.position),scale.copy(mesh.scale),quaternion.copy(mesh.quaternion)}else pos.copy(mesh.position),scale.copy(mesh.scale),quaternion.copy(mesh.quaternion);let i3=3*i,i4=4*i;if(_offset[i3+0]=pos.x,_offset[i3+1]=pos.y,_offset[i3+2]=pos.z,_scale[i3+0]=scale.x,_scale[i3+1]=scale.y,_scale[i3+2]=scale.z,_quaternion[i4+0]=quaternion.x,_quaternion[i4+1]=quaternion.y,_quaternion[i4+2]=quaternion.z,_quaternion[i4+3]=quaternion.w,mesh.attributes)for(let key in mesh.attributes){let attr=mesh.attributes[key],value=attr.value||attr;value instanceof Color?(_attributes[key][3*i+0]=value.r,_attributes[key][3*i+1]=value.g,_attributes[key][3*i+2]=value.b):value instanceof Vector3?(_attributes[key][3*i+0]=value.x,_attributes[key][3*i+1]=value.y,_attributes[key][3*i+2]=value.z):value instanceof Vector4||value instanceof Quaternion?(_attributes[key][4*i+0]=value.x,_attributes[key][4*i+1]=value.y,_attributes[key][4*i+2]=value.z,_attributes[key][4*i+3]=value.w):value instanceof Vector2?(_attributes[key][2*i+0]=value.x,_attributes[key][2*i+1]=value.y):_attributes[key][i]=value}}function updateBuffers(){if(_mesh){dirty(_quaternion,_geom.attributes.orientation.array)&&(_geom.attributes.orientation.array.set(_quaternion),_geom.attributes.orientation.needsUpdate=!0),dirty(_offset,_geom.attributes.offset.array)&&(_geom.attributes.offset.array.set(_offset),_geom.attributes.offset.needsUpdate=!0),dirty(_scale,_geom.attributes.scale.array)&&(_geom.attributes.scale.array.set(_scale),_geom.attributes.scale.needsUpdate=!0);for(let key in _attributes)dirty(_attributes[key],_geom.attributes[key].array)&&(_geom.attributes[key].array.set(_attributes[key]),_geom.attributes[key].needsUpdate=!0)}else!function initMesh(){if(_geom.addAttribute("offset",new GeometryAttribute(new Float32Array(_offset),3,1)),_geom.addAttribute("scale",new GeometryAttribute(new Float32Array(_scale),3,1)),_geom.addAttribute("orientation",new GeometryAttribute(new Float32Array(_quaternion),4,1)),_frustumCulled){let box=new Box3;_objects.forEach(mesh=>box.expandByObject(mesh,!0)),_geom.boundingBox=box,_geom.boundingSphere=box.getBoundingSphere()}(_mesh=new Mesh(_geom,_shader)).asyncPromise=Promise.resolve(),_this.mesh=_mesh,_this.mesh.isMeshBatch=!0,_this.group.add(_mesh),_mesh.frustumCulled=_frustumCulled,_renderOrder&&(_mesh.renderOrder=_renderOrder),_offset=new Float32Array(_offset),_quaternion=new Float32Array(_quaternion),_scale=new Float32Array(_scale);for(let key in _attributes){_attributes[key]=new Float32Array(_attributes[key]);let components=1,attr=_objects[0].attributes[key],value=attr.value||attr;value instanceof Vector3?components=3:value instanceof Vector4||value instanceof Quaternion?components=4:value instanceof Color?components=3:value instanceof Vector2&&(components=2),_geom.addAttribute(key,new GeometryAttribute(new Float32Array(_attributes[key]),components,1))}_this.onMeshCreated&&_this.onMeshCreated(_mesh)}()}async function initializeStatic(){await(_=>{let promise=Promise.create(),mesh=_list.start(),i=0,worker=new Render.Worker(_=>{mesh.updateMatrixWorld(!0),prepareMesh(mesh,i),i++,mesh=_list.next(),mesh||(worker.stop(),promise.resolve())},1);return promise})(),updateBuffers()}function loop(){_static&&_this.stopRender(loop);let first=!_firstRender;_firstRender=!0;let i=0,mesh=_list.start();for(;mesh;)(!1!==mesh.batchNeedsUpdate||first)&&(first&&mesh.updateMatrixWorld(!0),prepareMesh(mesh,i)),mesh=_list.next(),i++;updateBuffers()}_input instanceof InputUILConfig||(_config=_input,_input=null),_config=_config||{},_input&&_this.parent.ready(!0).then(initFromSceneLayout),Utils3D.getTestShader().visible=!1,this.add=function(mesh){_objects.push(mesh),_list.push(mesh),mesh.uploadIgnore=!0,mesh.batch=_this;let shader=mesh.shader;for(let key in shader.uniforms){let uniform=shader.uniforms[key];(uniform.value instanceof Color||uniform.value instanceof Vector2||uniform.value instanceof Vector3||uniform.value instanceof Vector4||uniform.value instanceof Quaternion||"number"==typeof uniform.value)&&(uniform.batchUnique||_config.batchUnique)&&(_uniformToAttrib.push(key),mesh.attributes||(mesh.attributes={}),mesh.attributes["a_"+key]=uniform)}_geom||function initGeometry(mesh){if(_geom=(new Geometry).instanceFrom(mesh.geometry),_this.geom=_geom,_shader||(_shader=mesh.shader.clone(),mesh.shader.copyUniformsTo(_shader,!0),updateShader(_shader)),mesh.attributes)for(let key in mesh.attributes)_attributes[key]=[];_static&&defer(initializeStatic)}(mesh),_mesh&&(modifyGeometry(1),_static&&console.error("Don't add more meshes to a static MeshBatch")),mesh.shader.neverRender=!0,_static||_this.startRender(loop,World.NUKE)},this.remove=function(mesh){_objects.remove(mesh),_list.remove(mesh),modifyGeometry(-1)},this.onDestroy=function(){_this.mesh&&_this.mesh.destroy&&_this.mesh.destroy(),delete MeshBatch.shaders[_shaderKey]},this.loadFromFile=async function(shader,geomFile,instanceFile){geomFile.includes("assets/geometry")||(geomFile="assets/geometry/"+geomFile),geomFile.includes(".json")||(geomFile+=".json"),instanceFile.includes("assets/geometry")||(instanceFile="assets/geometry/"+instanceFile),instanceFile.includes(".json")||(instanceFile+=".json");let[geom,data]=await Promise.all([GeomThread.loadGeometry(Assets.getPath(geomFile)),get(Assets.getPath(instanceFile))]),array=[],count=data.offset.buffer.length/3;for(let i=0;i<count;i++){let mesh=new Mesh(geom,shader);mesh.position.fromArray(data.offset.buffer,3*i),mesh.scale.fromArray(data.scale.buffer,3*i),mesh.quaternion.fromArray(data.orientation.buffer,4*i),array.push(mesh),_this.add(mesh)}return await _this.ready(),array},this.ready=function(){return _this.wait("mesh")},this.set("static",b=>{_objects.length?(console.warn("For better initialization performance, set meshBatch.static before adding any meshes"),loop(),_this.stopRender(loop,World.NUKE)):_static=!0}),this.set("renderOrder",v=>{_renderOrder=v,_mesh&&(_mesh.renderOrder=v)}),this.get("renderOrder",_=>_renderOrder),this.set("frustumCulled",b=>{_frustumCulled=b,_mesh&&(_mesh.frustumCulled=b)})}),_=>{MeshBatch.shaders={}}),Class((function MeshMerge(_input,_dynamic){Inherit(this,Object3D);const _this=this;var _mesh,_geom,_texture,_shaderKey,_meshes=[],_pending=[],_index=0;function initDynamic(){let array=new Float32Array(4096);(_texture=new DataTexture(array,32,32,Texture.RGBAFormat,Texture.FLOAT)).dynamic=!0,function updateShader(shader){shader.customCompile=`${shader.vsName}|${shader.fsName}|dynamicMerge`,shader.addUniforms({tDynamicMerge:{value:_texture}});let cached=MeshMerge.shaders[`${shader.vsName}|${shader.fsName}`];if(cached)return shader.fragmentShader=cached.fragment,shader.resetProgram();shader.resetProgram();let vsSplit=shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__");if(!vsSplit[1].includes("vec3 pos = position;"))throw`Shader ${shader.vsName} needs to have "vec3 pos = position;" in order for dynamic merging to work`;vsSplit[0]+="attribute float mIndex;\n",vsSplit[0]+="uniform sampler2D tDynamicMerge;\n",shader.vertexShader.includes("vec3 transformPosition")||(vsSplit[0]+=Shaders.getShader("instance.vs")+"\n");vsSplit[0]+="\n        vec2 getDMUV(float index, float offset) {\n            float pixel = (index*3.0) + offset;\n        \n            float size = 32.0;\n            float p0 = pixel / size;\n            float y = floor(p0);\n            float x = p0 - y;\n        \n            vec2 uv = vec2(0.0);\n            uv.x = x;\n            uv.y = y / size;\n            return uv;\n        }\n        \n",vsSplit[1]=vsSplit[1].replace(/vec3 pos = position;/g,"vec3 pos = transformPosition(position, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/vNormal = normalMatrix \* normal;/g,"vNormal = normalMatrix * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vec3 transformedNormal = normal;/g,"vec3 transformedNormal = transformNormal(normal, orientation);");let main=vsSplit[1].split("main() {");main[1]="\n\n        vec3 offset = texture2D(tDynamicMerge, getDMUV(mIndex, 0.0)).xyz;\n        vec3 scale = texture2D(tDynamicMerge, getDMUV(mIndex, 1.0)).xyz;\n        vec4 orientation = texture2D(tDynamicMerge, getDMUV(mIndex, 2.0));\n        "+main[1],vsSplit[1]=main.join("main() {"),vsSplit=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=vsSplit,_shaderKey=`${shader.vsName}|${shader.fsName}`,MeshMerge.shaders[_shaderKey]={vertex:shader.vertexShader}}(_mesh.shader);let loop=_=>{for(let i=_meshes.length-1;i>-1;i--){let mesh=_meshes[i],index=mesh.mergeIndex;array[12*index+0]=mesh.position.x,array[12*index+1]=mesh.position.y,array[12*index+2]=mesh.position.z,array[12*index+3]=1,array[12*index+4]=mesh.scale.x,array[12*index+5]=mesh.scale.y,array[12*index+6]=mesh.scale.z,array[12*index+7]=1,array[12*index+8]=mesh.quaternion.x,array[12*index+9]=mesh.quaternion.y,array[12*index+10]=mesh.quaternion.z,array[12*index+11]=mesh.quaternion.w}};loop(),_this.startRender(loop)}async function initFromSceneLayout(){let wildcard=_input.get("wildcard");if(!wildcard||!wildcard.length)return;let[groupName,dynamic]=wildcard.split("|");await _this.parent.loadedAllLayers();let group=await _this.parent.getLayer(groupName);_dynamic="dynamic"==dynamic;let children=[...group.children];children.sort((a,b)=>a.renderOrder-b.renderOrder),children.forEach(mesh=>_this.add(mesh)),group.add(_this.group)}"object"==typeof _input?_this.parent.ready().then(initFromSceneLayout):"boolean"==typeof _input&&(_dynamic=_input),this.onDestroy=function(){_mesh.destroy(),delete MeshBatch.shaders[_shaderKey]},this.ready=function(){return _this.wait("mesh")},this.add=function(mesh){if(mesh.uploadIgnore=!0,!mesh.visible)return;mesh.merge=_this,mesh.updateMatrixWorld(!0),_mesh||async function initMesh(mesh){(_mesh=new Mesh(World.QUAD,mesh.shader)).asyncPromise=Promise.create(),_this.group.add(_mesh),await defer();let data=await Promise.all(_pending),buffers=[];data.forEach(obj=>{for(let key in obj)obj[key].buffer&&buffers.push(obj[key].buffer)});let merged=await Thread.shared().meshMergeComplete({data:data},buffers);_geom=new Geometry;for(let key in merged)"components"!==key&&_geom.addAttribute(key,new GeometryAttribute(merged[key],merged.components[key]));_dynamic&&initDynamic(),_mesh.geometry=_geom,_mesh.asyncPromise.resolve(),_this.onMeshCreated&&_this.onMeshCreated(_mesh),_this.mesh=_mesh}(mesh);let geom=mesh.geometry;if(mesh.attributes)for(let key in mesh.attributes){let attr=mesh.attributes[key];attr instanceof Vector4&&(attr.isVector4=!0),attr instanceof Vector3&&(attr.isVector3=!0),attr instanceof Vector2&&(attr.isVector2=!0),attr instanceof Color&&(attr.isColor=!0)}let data={},components={},buffers=[];for(let key in geom.attributes)data[key]=new Float32Array(geom.attributes[key].array),buffers.push(data[key].buffer),components[key]=geom.attributes[key].itemSize;data.attributes=mesh.attributes,data.components=components,data.matrix="world"==_input?mesh.matrixWorld.elements:mesh.matrix.elements,_dynamic&&(data.matrix=null),data.dynamic=_dynamic,data.index=mesh.mergeIndex=_index++,mesh.visible=!1,_meshes.push(mesh),_pending.push(Thread.shared().meshMergeTransform(data,buffers))}}),_=>{Thread.upload((function meshMergeTransform(e,id){let geom=new Geometry;for(let key in e)!key.includes(["components","matrix"])&&e[key]instanceof Float32Array&&geom.addAttribute(key,new GeometryAttribute(e[key],e.components[key]));if(e.attributes)for(let key in e.attributes){let components=1,attr=e.attributes[key];attr.isVector4?components=4:attr.isVector3||attr.isColor?components=3:attr.isVector2&&(components=2);let buffer=new Float32Array(geom.attributes.position.count*components),step=buffer.length/components;for(let i=0;i<step;i++)4==components?(buffer[3*i+0]=attr.x,buffer[3*i+1]=attr.y,buffer[3*i+2]=attr.z,buffer[3*i+3]=attr.w):3==components?(buffer[3*i+0]=attr.x||attr.r||0,buffer[3*i+1]=attr.y||attr.g||0,buffer[3*i+2]=attr.z||attr.b||0):2==components?(buffer[2*i+0]=attr.x,buffer[2*i+1]=attr.y):buffer[i]=attr;geom.addAttribute(key,new GeometryAttribute(buffer,components))}e.matrix&&geom.applyMatrix((new Matrix4).fromArray(e.matrix));let indexBuffer=new Float32Array(geom.attributes.position.count);for(let i=0;i<indexBuffer.length;i++)indexBuffer[i]=e.index;geom.addAttribute("mIndex",new GeometryAttribute(indexBuffer,1));let data={},buffers=[],components={};for(let key in geom.attributes)data[key]=geom.attributes[key].array,components[key]=geom.attributes[key].itemSize,buffers.push(data[key].buffer);data.components=components,resolve(data,id,buffers)})),Thread.upload((function meshMergeComplete({data:data},id){let _geom;data.forEach(data=>{let geom=new Geometry;for(let key in data)"components"!=key&&geom.addAttribute(key,new GeometryAttribute(data[key],data.components[key]));_geom?_geom.merge(geom):_geom=geom});let result={},components={},buffers=[];for(let key in _geom.attributes)result[key]=_geom.attributes[key].array,components[key]=_geom.attributes[key].itemSize,buffers.push(result[key].buffer);result.components=components,resolve(result,id,buffers)})),MeshMerge.shaders={}}),Class((function RTPool(_type,_size=3,_format){Inherit(this,Component);const _this=this;var _pool;this.nullRT=Utils3D.createRT(2,2);var _array=[];function createRT(){let rt=Utils3D.createRT(Stage.width*World.DPR,Stage.height*World.DPR,_type,_format);return rt.index=_pool.length(),rt}function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}function resizeHandler(){_array.forEach(rt=>{rt.setSize(Stage.width*World.DPR,Stage.height*World.DPR)})}!function initPool(){_pool=new ObjectPool;for(let i=0;i<_size;i++){let rt=createRT();_pool.put(rt),_array.push(rt)}}(),defer(addListeners),this.get("array",_=>_array),this.getRT=function(){return _pool.get()||createRT()},this.putRT=function(rt){rt.scissor&&delete rt.scissor,_pool.put(rt)},this.setSize=function(width,height){_this.events.unsub(Events.RESIZE,resizeHandler),_array.forEach(rt=>{rt.setSize(width,height)})},this.onDestroy=function(){let p=_pool.get();for(;p;)p.dispose(),p=_pool.get()},this.clone=function(type=_type,size=_size,format=_format){return new RTPool(type,size,format)},this.disableResize=function(){_this.events.unsub(Events.RESIZE,resizeHandler)}}),"singleton"),Class((function RenderCount(){const _this=this;var $container,LOG,_map={},_display={};!async function(){await Hydra.ready(),_this.active=Utils.query("renderCount"),LOG=_this.active&&Utils.query("log"),_this.active&&async function initUIL(){await Hydra.ready(),($container=Stage.create("RenderCount")).css({width:150,height:"auto",paddingBottom:5,bottom:0}).bg("#111").setZ(9999999)}()}(),this.add=function(name,detail,amt=1){if(_this.active){if(void 0===_map[name]&&(_map[name]=0,$container)){let $wrapper=$container.create("wrapper");$wrapper.css({position:"relative",width:"100%",height:20}),$wrapper.label=$wrapper.create("label"),$wrapper.label.fontStyle("Arial",12,"#fff").text(name).css({left:10}),$wrapper.value=$wrapper.create("value"),$wrapper.value.fontStyle("Arial",12,"#fff").text(0).css({right:10}),_display[name]=$wrapper}LOG&&(console.groupCollapsed(name),detail&&console.log(detail),console.trace(),console.groupEnd()),_map[name]+=amt,_display[name].value.text(_map[name]||"0")}},this.remove=function(name,amt=1){_this.active&&_map[name]&&(_map[name]-=amt,_display[name].value.text(_map[name]||"0"))}}),"static"),Class((function RenderStats(){const _this=this;var _trace,_filter,$container,_map={},_stats={},_display={};function flush(){for(let key in _map)_stats[key]=_map[key],_display[key]&&_display[key].value.text(_map[key]||"0"),_map[key]=0;_trace=null}!async function(){await Hydra.ready(),_this.active=Utils.query("renderStats"),Utils.query("renderStats")&&async function initUIL(){await Hydra.ready(),($container=Stage.create("RenderStats")).css({position:"fixed",width:150,height:"auto",paddingTop:5}).bg("#111").setZ(99999)}(),Render.drawFrame=flush}(),this.update=function(name,amt=1,detail,detail2){if(_trace==name){if(_filter&&detail){if(!("string"==typeof detail?detail:Utils.getConstructorName(detail)).toLowerCase().includes(_filter.toLowerCase()))return}console.groupCollapsed(name),detail&&console.log("string"==typeof detail?detail:Utils.getConstructorName(detail)),detail2&&console.log(detail2),console.trace(),console.groupEnd()}if(void 0===_map[name]&&(_map[name]=0,$container)){let $wrapper=$container.create("wrapper");$wrapper.css({position:"relative",width:"100%",height:20}),$wrapper.label=$wrapper.create("label"),$wrapper.label.fontStyle("Arial",12,"#fff").text(name).css({left:10}),$wrapper.value=$wrapper.create("value"),$wrapper.value.fontStyle("Arial",12,"#fff").text(0).css({right:10}),_display[name]=$wrapper}_map[name]+=amt},this.trace=function(name,filter=null){_trace=name,_filter=filter},this.log=function(){for(let key in _stats)console.log(key,_stats[key]);console.log("----")}}),"static"),Class((function Fluid(_simSize=128,_dyeSize=512,_rect=Stage){Inherit(this,Component);const _this=this;var _fbos={},_scenes={},_tmpVec=new Vector2,_lastSplat=Render.TIME;const DYE_WIDTH=_dyeSize,DYE_HEIGHT=_dyeSize,SIM_WIDTH=_simSize,SIM_HEIGHT=_simSize,config={DENSITY_DISSIPATION:.97,VELOCITY_DISSIPATION:.98,PRESSURE_DISSIPATION:.8,PRESSURE_ITERATIONS:20,CURL:30,DEBUG_MOUSE:!0,SPLAT_RADIUS:.25};function loop(){config.DEBUG_MOUSE&&function drawMouse(){_this.drawInput(Mouse.x,Mouse.y,10*Mouse.delta.x,10*Mouse.delta.y,new Color("#777777"))}(),_scenes.curl.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.curl.render(_fbos.curl.fbo),_scenes.vorticity.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.vorticity.uniforms.uCurl.value=_fbos.curl.fbo,_scenes.vorticity.uniforms.curl.value=config.CURL,_scenes.vorticity.render(_fbos.velocity.write),_fbos.velocity.swap(),_scenes.divergence.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.divergence.render(_fbos.divergence.fbo),_scenes.clear.uniforms.uTexture.value=_fbos.pressure.read,_scenes.clear.uniforms.value.value=config.PRESSURE_DISSIPATION,_scenes.clear.render(_fbos.pressure.write),_fbos.pressure.swap(),_scenes.pressure.uniforms.uDivergence.value=_fbos.divergence.fbo;for(let i=0;i<config.PRESSURE_ITERATIONS;i++)_scenes.pressure.uniforms.uPressure.value=_fbos.pressure.read,_scenes.pressure.render(_fbos.pressure.write),_fbos.pressure.swap();_scenes.gradientSubtract.uniforms.uPressure.value=_fbos.pressure.read,_scenes.gradientSubtract.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.gradientSubtract.render(_fbos.velocity.write),_fbos.velocity.swap(),_scenes.advection.uniforms.texelSize.value.set(1/SIM_WIDTH,1/SIM_HEIGHT),_scenes.advection.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.advection.uniforms.uSource.value=_fbos.velocity.read,_scenes.advection.uniforms.dissipation.value=config.VELOCITY_DISSIPATION,_scenes.advection.render(_fbos.velocity.write),_fbos.velocity.swap(),_scenes.advection.uniforms.texelSize.value.set(1/DYE_WIDTH,1/DYE_HEIGHT),_scenes.advection.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.advection.uniforms.uSource.value=_fbos.density.read,_scenes.advection.uniforms.dissipation.value=config.DENSITY_DISSIPATION,_scenes.advection.render(_fbos.density.write),_fbos.density.swap(),_scenes.display.uniforms.uTexture.value=_fbos.density.read,_scenes.display.uniforms.texelSize.value.set(1/_rect.width,1/_rect.height),_scenes.display.render(_this.rt)}this.rt=Utils3D.createRT(_rect.width,_rect.height),this.fbos=_fbos,this.additiveBlending=!0,_this.rt.disableDepth=!0,function initFBOs(){_fbos.density=_this.initClass(FluidFBO,DYE_WIDTH,DYE_HEIGHT,Texture.LINEAR),_fbos.velocity=_this.initClass(FluidFBO,SIM_WIDTH,SIM_HEIGHT,Texture.LINEAR),_fbos.divergence=_this.initClass(FluidFBO,SIM_WIDTH,SIM_HEIGHT,Texture.NEAREST),_fbos.curl=_this.initClass(FluidFBO,SIM_WIDTH,SIM_HEIGHT,Texture.NEAREST),_fbos.pressure=_this.initClass(FluidFBO,SIM_WIDTH,SIM_HEIGHT,Texture.NEAREST)}(),function initScenes(){_scenes.curl=_this.initClass(FluidScene,"fluidBase","curlShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uVelocity:{value:null},depthWrite:!1}),_scenes.vorticity=_this.initClass(FluidScene,"fluidBase","vorticityShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uVelocity:{value:null},uCurl:{value:null},curl:{value:config.CURL},dt:{value:.016}}),_scenes.divergence=_this.initClass(FluidScene,"fluidBase","divergenceShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uVelocity:{value:null}}),_scenes.clear=_this.initClass(FluidScene,"fluidBase","clearShader",{uTexture:{value:null},value:{value:config.PRESSURE_DISSIPATION}}),_scenes.pressure=_this.initClass(FluidScene,"fluidBase","pressureShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uPressure:{value:null},uDivergence:{value:null}}),_scenes.gradientSubtract=_this.initClass(FluidScene,"fluidBase","gradientSubtractShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uPressure:{value:null},uVelocity:{value:null}}),_scenes.advection=_this.initClass(FluidScene,"fluidBase","advectionShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uVelocity:{value:null},uSource:{value:null},dt:{value:.016},dissipation:{value:config.VELOCITY_DISSIPATION}}),_scenes.display=_this.initClass(FluidScene,"fluidBase","displayShader",{texelSize:{value:new Vector2(1/_rect.width,1/_rect.height)},uTexture:{value:null}}),_scenes.splat=_this.initClass(FluidScene,"fluidBase","splatShader",{uTarget:{value:null},aspectRatio:{value:_rect.width/_rect.height},point:{value:new Vector2},prevPoint:{value:new Vector2},color:{value:new Vector3},bgColor:{value:new Color("#000000")},radius:{value:config.SPLAT_RADIUS/100},canRender:{value:0},uAdd:{value:1}})}(),_this.startRender(loop),this.updateConfig=function(key,value){config[key]=value},this.drawInput=function(x,y,dx,dy,color,radius=config.SPLAT_RADIUS){_scenes.splat.uniforms.uTarget.value=_fbos.velocity.read,_scenes.splat.uniforms.radius.value=radius/200,_scenes.splat.uniforms.aspectRatio.value=_rect.width/_rect.height,_tmpVec.set(x/_rect.width,1-y/_rect.height);let now=Render.TIME,delta=now-_lastSplat;_lastSplat=now,delta>50?_scenes.splat.uniforms.prevPoint.value.copy(_tmpVec):_scenes.splat.uniforms.prevPoint.value.copy(_scenes.splat.uniforms.point.value),_scenes.splat.uniforms.point.value.copy(_tmpVec),_scenes.splat.uniforms.color.value.set(dx,-dy,1),_scenes.splat.uniforms.uAdd.value=1,_scenes.splat.render(_fbos.velocity.write),_fbos.velocity.swap(),_scenes.splat.uniforms.uTarget.value=_fbos.density.read,_scenes.splat.uniforms.color.value.set(color.r,color.g,color.b),_scenes.splat.uniforms.uAdd.value=_this.additiveBlending?1:0,_scenes.splat.render(_fbos.density.write,!0),_fbos.density.swap(),_scenes.splat.uniforms.canRender.value=1}})),Class((function FluidFBO(_width,_height,_filter){Inherit(this,Component);const _this=this,type=Device.mobile||Renderer.type!=Renderer.WEBGL1?Texture.HALF_FLOAT:Texture.FLOAT;var _fbo1=new RenderTarget(_width,_height,{minFilter:_filter,magFilter:_filter,format:Texture.RGBAFormat,type:type}),_fbo2=new RenderTarget(_width,_height,{minFilter:_filter,magFilter:_filter,format:Texture.RGBAFormat,type:type});this.fbo=_fbo1,this.uniform={value:_fbo1},_fbo1.disableDepth=!0,_fbo2.disableDepth=!0,_fbo1.generateMipmaps=!1,_fbo2.generateMipmaps=!1,this.swap=function(){let temp=_fbo1;_fbo1=_fbo2,_fbo2=temp,_this.uniform.value=_fbo1},this.get("read",_=>_fbo1),this.get("write",_=>_fbo2)})),Class((function FluidLayer(_input,_group){Inherit(this,Object3D);var _fluid,_config,_this=this;!function initConfig(){(_config=InputUIL.create(_input.prefix+"fluid",_group)).setLabel("Fluid Config"),_config.add("dyeSize",512),_config.add("simSize",128),_config.add("velocity",.98),_config.add("density",.97),_config.add("pressure",.8),_config.add("iterations",20),_config.add("curl",30),_config.add("defaultRadius",25),_config.addToggle("debugMouse",!1)}(),function initFluid(){let rect=Stage,wildcard=_input.get("wildcard");if(wildcard&&wildcard.includes("x")){let split=wildcard.split("x");rect={width:Number(split[0]),height:Number(split[1])}}_fluid=_this.initClass(Fluid,_config.getNumber("simSize"),_config.getNumber("dyeSize"),rect),_this.rt=_fluid.rt,_this.fbos=_fluid.fbos,_config.onUpdate=key=>{switch(key){case"velocity":_fluid.updateConfig("VELOCITY_DISSIPATION",_config.getNumber(key));break;case"density":_fluid.updateConfig("DENSITY_DISSIPATION",_config.getNumber(key));break;case"pressure":_fluid.updateConfig("PRESSURE_DISSIPATION",_config.getNumber(key));break;case"iterations":_fluid.updateConfig("PRESSURE_ITERATIONS",_config.getNumber(key));break;case"curl":_fluid.updateConfig("CURL",_config.getNumber(key));break;case"defaultRadius":_fluid.updateConfig("SPLAT_RADIUS",_config.getNumber(key));break;case"debugMouse":_fluid.updateConfig("DEBUG_MOUSE",_config.get(key))}},["velocity","density","pressure","iterations","curl","defaultRadius","debugMouse"].forEach(_config.onUpdate)}(),function initMesh(){let shader=_this.initClass(Shader,"ScreenQuad",{tMap:{value:_fluid.rt}}),mesh=new Mesh(World.QUAD,shader);_this.add(mesh),_this.mesh=mesh}(),this.drawInput=_fluid.drawInput,this.set("additiveBlending",v=>_fluid.additiveBlending=v)})),Class((function FluidScene(_vs,_fs,_uniforms){Inherit(this,Component);const _this=this;var _scene=new Scene;!function(){_uniforms.depthWrite=!1;let shader=_this.initClass(Shader,_vs,_fs,_uniforms),mesh=new Mesh(World.QUAD,shader);shader.depthWrite=!1,mesh.noMatrices=!0,_scene.add(mesh),_this.uniforms=shader.uniforms}(),this.render=function(rt){World.RENDERER.autoClear=!1,World.RENDERER.renderSingle(_scene.children[0],World.CAMERA,rt),World.RENDERER.autoClear=!0}})),Class((function Fullscreen(){Inherit(this,Events);const _this=this;function update(){const isOpen=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);isOpen!==_this.isOpen&&(_this.isOpen=isOpen,_this.events.fire(Events.FULLSCREEN,{fullscreen:_this.isOpen}))}this.isOpen=!1,function addHandlers(){["onfullscreenchange","onwebkitfullscreenchange","onmozfullscreenchange","onmsfullscreenchange","onfullscreenerror","onwebkitfullscreenerror","onmozfullscreenerror","onmsfullscreenerror"].forEach(evt=>{void 0!==document[evt]&&(document[evt]=update)})}(),this.open=function(element){element=element||document.body,["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"].every(method=>{if(void 0===element[method])return!0;element[method]()})},this.close=function(){["exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen"].every(method=>{if(void 0===document[method])return!0;document[method]()})}}),"static"),Class((function FXAA(){Inherit(this,NukePass);this.uniforms={},this.init("FXAA","FXAA")})),Interaction.Class((function Renderer(_object){var _hydraObject=_object instanceof HydraObject;this.needsUpdate=!!_hydraObject,_hydraObject&&(_object.x=_object.x||0,_object.y=_object.y||0,_object.z=_object.z||0,_object.pos={x:0,y:0,z:0}),this.update=function(){_object.transform()}})),Interaction.Class((function Slider(_object,_direction,_config){Inherit(this,Component);var _input,_values,_renderer,_side,_delta,_addInput,_axis,_views,_dragging,_lockMove,_cacheStart,_this=this,_holdOffset=0;function getFullElapsed(){if(!_this.preventVisible&&(_this.elapsed=Math.abs(_object.x)/Math.abs(-_this[_side]*(_this.maxSlides-1)),_views))for(var i=0;i<_views.length;i++){var view=_views[i],pos=_this[_side]*i,offset=(_object[_axis]+pos)/_this[_side];view.sliderOffset=offset,view.updatePosition&&view.updatePosition(offset,_dragging)}}function copyFromTo(o1,o2){void 0!==o1.x&&(o2.x=o1.x),void 0!==o1.y&&(o2.y=o1.y),void 0!==o1.z&&(o2.z=o1.z)}function tweenObj(_to){var css=_this.cssTransitions;if(_this.needsRender=!0,copyFromTo(_object,_values),tween(_values,_to,_this.easeTime,_this.ease).onUpdate(()=>{copyFromTo(_values,css?_object.pos:_object),!css&&_this.autoRender&&_renderer.needsUpdate&&_renderer.update(),getFullElapsed(),_this.onUpdate&&_this.onUpdate(_this.elapsed)}).onComplete(_=>_this.needsRender=!1),css){var cssTo={};cssTo[_axis]=_to[_axis],_object.tween(cssTo,_this.easeTime,_this.ease)}}function incSlide(){_this.currentSlide++,_this.repeatable&&_this.currentSlide>_this.maxSlides-1&&(_this.currentSlide=0),!_this.infinite&&_this.currentSlide>_this.maxSlides-1&&(_this.currentSlide=_this.maxSlides-1),onUpdateSlide(_this.currentSlide)}function decSlide(){_this.currentSlide--,_this.repeatable&&_this.currentSlide<0&&(_this.currentSlide=_this.maxSlides-1),!_this.infinite&&_this.currentSlide<0&&(_this.currentSlide=0),onUpdateSlide(_this.currentSlide)}function onUpdateSlide(slide){_this.events.fire(Interaction.Slider.UPDATE,{slide:slide})}function inputUpdate(e,delta=_input.move,override){!Device.mobile&&!_this.desktopDrag||!_dragging&&!override||_this.preventMovement||_this.preventVisible||(_object[_axis]=-_this[_side]*_this.currentSlide+delta[_axis]*_this.multiplier+_holdOffset,!_this.infinite&&function outOfBounds(){return _object[_axis]>0||_this.currentSlide==_this.maxSlides-1&&_object[_axis]<-_this[_side]*_this.currentSlide}()&&function clampWithFriction(){var val=_object[_axis],max=-_this[_side]*_this.currentSlide;val>0?_object[_axis]=val*_this.friction:val<max&&(_object[_axis]=max+(val-max)*_this.friction)}(),getFullElapsed(),_this.cssTransitions&&_object.stopTween(),e.elapsed=_this.elapsed,_this.events.fire(Interaction.MOVE,e,!0),_this.autoRender&&_renderer.needsUpdate&&(_object.pos[_axis]=_object[_axis],_renderer.update()),_delta=delta)}function lockStart(e){_cacheStart=e}function lockMove(e){Math.abs(_input.move[_axis])>_lockMove&&!_this.flag("overrideLock")&&!_this.flag("preventMove")&&(inputStart(_cacheStart),_this.flag("overrideLock",!0),_this.events.fire(Interaction.Slider.OVERRIDE_LOCK,{action:"start"})),Math.abs(_input.move["x"==_axis?"y":"x"])>_lockMove&&_this.flag("preventMove",!0)}function lockEnd(e){_cacheStart=null,_this.flag("overrideLock")&&_this.events.fire(Interaction.Slider.OVERRIDE_LOCK,{action:"end"}),_this.flag("overrideLock",!1),_this.flag("preventMove",!1)}function inputStart(e){!Device.mobile&&!_this.desktopDrag||"hit"==e.target.className&&1!=_config.allowHit||_this.preventMovement||_this.preventVisible||(_dragging=!0,clearTween(_values),_holdOffset=_values[_axis]+_this[_side]*_this.currentSlide||0,Date.now(),_delta=0,_this.needsRender=!0,_this.events.fire(Interaction.Slider.START_INTERACTION,null,!0))}function inputEnd(e,override){if((Device.mobile||_this.desktopDrag)&&(_dragging||override)&&!_this.preventMovement&&!_this.preventVisible){var target={},elapsed=function getElapsed(){if(_delta)return-_delta[_axis]/_this[_side]}(),velocity=_input.velocity[_axis]*Math.sign(_input.delta[_axis]);Date.now();if(Math.abs(velocity)>.1||override){(override||velocity)>0?decSlide():incSlide()}else velocity<0?elapsed>_this.snapPoint&&incSlide():velocity>0&&Math.abs(elapsed)>_this.snapPoint&&decSlide();target[_axis]=-_this[_side]*_this.currentSlide,_dragging=!1,tweenObj(target),_this.events.fire(Interaction.Slider.END_INTERACTION,null,!0)}}this.autoRender=!0,this.currentSlide=0,this.maxSlides=_config.slides,this.width=_config.width,this.height=_config.height,this.snapPoint=.3,this.ease="easeOutCubic",this.easeTime=500,this.friction=.3,this.infinite=!1,this.desktopDrag="boolean"!=typeof _config.desktopDrag||_config.desktopDrag,this.preventMovement=!1,this.cssTransitions=!1,this.multiplier=1,this.elapsed=0,function initHelpers(){_input=_this.initClass(Interaction,_config.hit||_object),_this.events.sub(_input,Interaction.MOVE,inputUpdate),_this.events.sub(_input,Interaction.START,inputStart),_this.events.sub(_input,Interaction.END,inputEnd),_this.input=_input,_values={},_renderer=_this.initClass(Interaction.Renderer,_object)}(),function initDirection(){_side=_direction.x?"width":"height",_axis=_direction.x?"x":"y"}(),_this.startRender(_=>{}),this.set("views",(function(v){_views=v,_this.delayedCall(getFullElapsed,50)})),this.set("lockMove",(function(v){_lockMove=v})),this.lockDirection=function(move=50){_lockMove=move,_this.events.unsub(_input,Interaction.START,inputStart),_this.events.sub(_input,Interaction.START,lockStart),_this.events.sub(_input,Interaction.MOVE,lockMove),_this.events.sub(_input,Interaction.END,lockEnd)},this.moveTo=function(slide){_this.infinite||(slide<0&&(slide=0),slide>=_this.maxSlides&&(slide=_this.maxSlides-1)),_this.currentSlide=slide;var target={};target[_axis]=-_this[_side]*_this.currentSlide,tweenObj(target),onUpdateSlide(_this.currentSlide)},this.jumpTo=function(slide){_this.infinite||(slide<0&&(slide=0),slide>=_this.maxSlides&&(slide=_this.maxSlides-1)),_this.currentSlide=slide,_values[_axis]=-_this[_side]*_this.currentSlide,copyFromTo(_values,_object),_this.autoRender&&_renderer.needsUpdate&&(_object.pos[_axis]=_object[_axis],_renderer.update()),getFullElapsed(),onUpdateSlide(_this.currentSlide)},this.next=function(){incSlide();var target={};target[_axis]=-_this[_side]*_this.currentSlide,tweenObj(target)},this.prev=function(){decSlide();var target={};target[_axis]=-_this[_side]*_this.currentSlide,tweenObj(target)},this.clearTween=function(){clearTween(_values)},this.onInvisible=function(){_this.preventVisible=!0},this.onVisible=function(){_this.preventVisible=!1},this.addInput=function(x=0,y=0){if(!_this.flag("preventInput")&&(_addInput||((_addInput={}).delta={}),_addInput.delta.x=x,_addInput.delta.y=y,_addInput.total||(_addInput.total=0),inputUpdate(_addInput,_addInput.delta,!0),Math.abs(_object[_axis])>.2*Math.abs(_this[_side]))){let val=Math.abs(y)>Math.abs(x)?y:x;_this.moveTo(_this.currentSlide+Math.sign(val)),_this.flag("preventInput",!0,_this.easeTime)}}}),_=>{Interaction.Slider.OVERRIDE_LOCK="slider_override_lock",Interaction.Slider.UPDATE="slider_update",Interaction.Slider.START_INTERACTION="slider_start_interaction",Interaction.Slider.END_INTERACTION="slider_end_interaction"}),Class((function GLScreenProjection(_camera=World.CAMERA,_target=new Vector2){Inherit(this,Object3D);var _this=this,_projection=new ScreenProjection(_camera),_m0=new Matrix4,_m1=new Matrix4;function loop(){_this.pos.set(_target.x,_target.y),_this.pos3D.copy(_projection.unproject(_this.pos)),_this.group.updateMatrixWorld(),_m0.copy(_camera.projectionMatrix),_m1.getInverse(_camera.matrixWorld),_this.matrix.multiplyMatrices(_m0,_m1),_this.uniforms.normalMatrix.value.copy(_camera.matrixWorld),_this.uniforms.modelMatrix.value.copy(_this.group.matrixWorld)}this.resolution=new Vector2,this.pos=new Vector2,this.pos3D=new Vector3,this.matrix=new Matrix4,this.uniforms={projMatrix:{type:"m4",value:this.matrix},pos:{type:"v2",value:this.pos},pos3D:{type:"v3",value:this.pos3D},normalMatrix:{type:"m4",value:new Matrix4},modelMatrix:{type:"m4",value:new Matrix4}},this.set("camera",v=>{_camera=v,_projection.camera=_camera}),this.set("target",v=>{_target=v}),this.update=loop,this.start=function(){_this.startRender(loop)},this.stop=function(){_this.stopRender(loop)}})),Class((function GLSEO(){Inherit(this,Element);const _this=this;var $this,_groups=[],_links=[];function loop(){for(let i=_groups.length-1;i>-1;i--){let group=_groups[i];if(group.deleted)return $this.removeChild(group.seo),_groups.splice(i,1);group.seo.enabled&&group.determineVisible()?group.seo&&group.seo.hidden&&(group.seo.hidden=!1,$this.add(group.seo)):group.seo&&!group.seo.hidden&&(group.seo.hidden=!0,$this.removeChild(group.seo,!0))}for(let i=_links.length-1;i>-1;i--){let group=_links[i];if(group.deleted)return $this.removeChild(group.seo),_groups.splice(i,1);group.seo.enabled&&group.determineVisible()?group.seoHidden&&(group.seoHidden=!1,group.seoDOM.forEach(obj=>obj.show())):group.seoHidden||(group.seoHidden=!0,group.seoDOM.forEach(obj=>obj.hide()))}}!async function(){await Hydra.ready(),function initHTML(){($this=_this.element).size(1,1).css({overflow:"hidden",left:-1}).setZ(-1),Stage.add($this)}(),CSS.style(".GLSEO *",{position:"relative"})}(),this.registerPage=function(group,name){let topLevel=group;!(group=group instanceof GLUIObject?group:group.group||group.scene||group).determineVisible&&group.group&&(group.determineVisible=group.group.determineVisible.bind(group.group)),World.ELEMENT.mouseEnabled(!1),topLevel.seo=group.seo=$(name),group.seo.hidden=!0,group.seo.enabled=!0;let remove=group.seo.remove.bind(group.seo);group.seo.remove=_=>{_groups.remove(group),remove()},_groups.push(group),_this.startRender(loop,10)},this.registerPersist=function(group,name){let topLevel=group;group=group instanceof GLUIObject?group:group.group||group.scene||group,World.ELEMENT.mouseEnabled(!1),topLevel.seo=group.seo=$this.create(name)},this.link=function($dom,group){$dom instanceof HydraObject&&((group=group.group||group.scene||group).seoDOM||(group.seoDOM=[]),group.seoDOM.push($dom),_links.push(group)),$dom instanceof GLUIObject&&($dom.seo=group.seo)},this.textNode=function($text,text){let parent=($text._3d?$text.anchor||$text.group:$text)._parent;if($text.parentSeo){let parentSeo=$text.parentSeo;parent=parentSeo.group&&parentSeo.group.seo?parentSeo.group:parentSeo}else if(parent)for(;parent&&!parent.seo;)parent=parent._parent;parent&&parent.seo&&!$text.excludeSEO&&($text.seo?($text.seo.text(text),$text.seo.accessible()):($text.seo=$("text"),$text.seo.text(text),$text.seo.accessible(),parent.seo.add($text.seo),$text.seo.aLink=function(url){let index=Array.prototype.slice.call(parent.seo.div.children).indexOf($text.seo.div);$text.seo.remove(),$text.seo=$("link","a"),$text.seo.attr("href",Hydra.absolutePath(url)),$text.seo.text(text),$text.seo.accessible(),$text.seo.div.onfocus=_=>$text._divFocus(),$text.seo.div.onblur=_=>$text._divBlur(),$text.seo.div.onclick=e=>{e.preventDefault(),$text._divSelect()},parent.seo.div.insertBefore($text.seo.div,parent.seo.div.children[index])},$text.seo.unlink=function(){parent.seo.div.removeChild($text.seo.div),$text.seo=null}))},this.objectNode=function($object,$parent){let parent=$parent||($object._3d?$object.group:$object)._parent;if($object.parentSeo)parent=$object.parentSeo.group||$object.parentSeo;else{if(!parent)return;for(;parent&&!parent.seo;)parent=parent._parent}parent&&parent.seo&&($object.seo||$object.excludeSEO||($object.seo={},$object.seo.aLink=function(url,label){let index=Array.prototype.slice.call(parent.seo.div.children).indexOf($object.seo.div);$object.seo=$("link","a"),$object.seo.attr("href",Hydra.absolutePath(url)),$object.seo.text(label),$object.seo.accessible(),$object.seo.div.onfocus=_=>$object._divFocus(),$object.seo.div.onblur=_=>$object._divBlur(),$object.seo.div.onclick=e=>{e.preventDefault(),$object._divSelect()},parent.seo.div.insertBefore($object.seo.div,parent.seo.div.children[index]),$object.seo.unlink=function(){parent.seo.div.removeChild($object.seo.div),$object.seo=null}}))}}),"static"),Class((function GLText({font:font,italic:italic=!1,bold:bold=!1,text:text,width:width=1/0,align:align="left",size:size=1,direction:direction="ltr",letterSpacing:letterSpacing=0,lineHeight:lineHeight=1.4,wordSpacing:wordSpacing=0,wordBreak:wordBreak=!1,langBreak:langBreak=!1,paragraphSpacing:paragraphSpacing=1,color:color=new Color("#000000"),alpha:alpha=1,shader:shader="DefaultText"}){const _this=this;var _override,_promise=Promise.create();const config=GLText.FONT_CONFIG[font];function overrideParams(){if(GLText.overrideParams){_override={letterSpacing:letterSpacing,size:size,wordSpacing:wordSpacing,lineHeight:lineHeight};let obj=GLText.overrideParams({letterSpacing:letterSpacing,size:size,wordSpacing:wordSpacing,lineHeight:lineHeight});letterSpacing=obj.letterSpacing,size=obj.size,wordSpacing=obj.wordSpacing,lineHeight=obj.lineHeight}}function resetOverride(){_override&&(letterSpacing=_override.letterSpacing,size=_override.size,wordSpacing=_override.wordSpacing,lineHeight=_override.lineHeight)}!function init(){overrideParams(),_this.charLength=text.length,_this.text=new GLTextGeometry({font:font,italic:italic,bold:bold,text:text,width:width,align:align,direction:direction,wordSpacing:wordSpacing,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,size:size,lineHeight:lineHeight,wordBreak:wordBreak,langBreak:langBreak,config:config}),_this.string=text,resetOverride(),_this.text.loaded.then(({buffers:buffers,image:image,imageBold:imageBold,imageItalic:imageItalic,height:height,numLines:numLines})=>{_this.texture=GLText.getTexture(image),bold&&(_this.textureBold=GLText.getTexture(imageBold)),italic&&(_this.textureItalic=GLText.getTexture(imageItalic)),_this.shader=new Shader(shader,{tMap:{value:_this.texture,ignoreUIL:!0},tMapBold:{value:_this.textureBold||Utils3D.getEmptyTexture(),ignoreUIL:!0},tMapItalic:{value:_this.textureItalic||Utils3D.getEmptyTexture(),ignoreUIL:!0},uColor:{value:color,ignoreUIL:!0},uAlpha:{value:alpha,ignoreUIL:!0},transparent:!0}),_this.onCreateShader&&_this.onCreateShader(_this.shader),function createGeometry(buffers){_this.geometry=new Geometry,_this.geometry.addAttribute("position",new GeometryAttribute(buffers.position,3)),_this.geometry.addAttribute("uv",new GeometryAttribute(buffers.uv,2)),_this.geometry.addAttribute("animation",new GeometryAttribute(buffers.animation,3)),_this.geometry.addAttribute("weight",new GeometryAttribute(buffers.weight,1)),_this.geometry.setIndex(new GeometryAttribute(buffers.index,1)),_this.geometry.boundingBox=buffers.boundingBox,_this.geometry.letterCount=buffers.letterCount+1,_this.geometry.wordCount=buffers.wordCount+1,_this.geometry.lineCount=buffers.lineCount+1}(buffers),_this.mesh=new Mesh(_this.geometry,_this.shader),_this.height=height,_promise.resolve()})}(),void 0===font&&console.log(font,text),this.destroy=function(){_this.mesh&&_this.mesh.destroy&&_this.mesh.destroy()},this.ready=this.loaded=function(){return _promise},this.centerY=function(){_this.mesh.position.y=.5*_this.height,_this.needsCenterY=!0},this.resize=function(options){return this.setText(text,options)},this.tweenColor=function(c,time=300,ease="easeOutCubic"){c&&color.tween(c,time,ease)},this.setColor=function(c){c&&color.set(c)},this.setText=function(txt,options){if((text!=txt||!function match(options){return!options||options.font==font&&(options.italic==italic&&(options.bold==bold&&(options.width==width&&(options.align==align&&(options.direction==direction&&(!(options.wordSpacing>0&&options.wordSpacing!=wordSpacing)&&(options.letterSpacing==letterSpacing&&(options.paragraphSpacing==paragraphSpacing&&(options.size==size&&(options.lineHeight==lineHeight&&!(!0===options.wordBreak&&!options.wordBreak||0==options.wordBreak&&options.wordBreak)))))))))))}(options))&&(text=txt))return function setVars(options){font=options.font||font,bold=options.bold||bold,italic=options.italic||italic,width=options.width||width,align=options.align||align,wordSpacing=options.wordSpacing||wordSpacing,letterSpacing=options.letterSpacing||letterSpacing,paragraphSpacing=options.paragraphSpacing||paragraphSpacing,size=options.size||size,lineHeight=options.lineHeight||lineHeight,wordBreak=options.wordBreak||wordBreak,langBreak=options.langBreak||langBreak,direction=options.direction||direction}(options||{}),overrideParams(),_this.string=text,_this.charLength=text.length,_this.text=new GLTextGeometry({font:font,italic:italic,bold:bold,text:text,width:width,align:align,direction:direction,wordSpacing:wordSpacing,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,size:size,lineHeight:lineHeight,wordBreak:wordBreak,langBreak:langBreak,config:config}),resetOverride(),_promise=Promise.create(),_this.text.loaded.then(({buffers:buffers,image:image,imageBold:imageBold,imageItalic:imageItalic,height:height,numLines:numLines})=>{!function updateGeometry(buffers){_this.geometry.attributes.position.setArray(buffers.position),_this.geometry.attributes.uv.setArray(buffers.uv),_this.geometry.attributes.animation.setArray(buffers.animation),_this.geometry.attributes.weight.setArray(buffers.weight),_this.geometry.index=buffers.index,_this.geometry.indexNeedsUpdate=!0,_this.geometry.boundingBox=buffers.boundingBox,_this.geometry.letterCount=buffers.letterCount+1,_this.geometry.wordCount=buffers.wordCount+1,_this.geometry.lineCount=buffers.lineCount+1}(buffers),_this.height=height,_this.needsCenterY&&_this.centerY(),_promise.resolve()}),_promise},this.getData=function(){return{font:font,italic:italic,bold:bold,text:text,width:width,align:align,direction:direction,wordSpacing:wordSpacing,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,size:size,lineHeight:lineHeight,wordBreak:wordBreak,langBreak:langBreak,color:color}}}),_=>{GLText.FONT_CONFIG={};var _map=new Map;GLText.getTexture=function(image){if(!_map.get(image)){let texture=new Texture(image);texture.generateMipmaps=!1,texture.minFilter=Texture.LINEAR,_map.set(image,texture)}return _map.get(image)}}),Class((function GLTextGeometry({font:font,italic:italic,bold:bold,text:text,width:width=1/0,align:align="left",size:size=1,direction:direction="ltr",letterSpacing:letterSpacing=0,paragraphSpacing:paragraphSpacing=1,lineHeight:lineHeight=1.4,wordSpacing:wordSpacing=0,wordBreak:wordBreak=!1,langBreak:langBreak=!1,config:config={}}){let json,image,glyphs,bJson,bImage,bGlyphs,iJson,iImage,iGlyphs,_this=this;_this.loaded=Promise.create(),async function init(){await async function loadFont(){[json,image,glyphs]=await GLTextGeometry.loadFont(font),bold&&([bJson,bImage,bGlyphs]=await GLTextGeometry.loadFont(bold));italic&&([iJson,iImage,iGlyphs]=await GLTextGeometry.loadFont(italic))}(),async function createGeometry(){let buffers=await GLTextThread.generate({font:font,bold:bold,italic:italic,text:text,width:width,align:align,size:size,direction:direction,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,lineHeight:lineHeight,wordSpacing:wordSpacing,wordBreak:wordBreak,langBreak:langBreak,json:json,glyphs:glyphs,bJson:bJson,bGlyphs:bGlyphs,iJson:iJson,iGlyphs:iGlyphs,config:config});_this.buffers=buffers,_this.image=image,_this.imageBold=bImage,_this.imageItalic=iImage,_this.numLines=buffers.lineLength,_this.height=_this.numLines*size*lineHeight,_this.onLayout&&_this.onLayout(buffers,image,_this.height,_this.numLines),_this.loaded.resolve({buffers:buffers,image:image,imageBold:bImage,imageItalic:iImage,height:_this.height,numLines:_this.numLines})}()}()}),_=>{async function loadJSON(font){return await get(getPathTo(font,"json"))}async function loadImage(font){return await new Promise(resolve=>{let img=new Image;img.onload=()=>resolve(img),img.crossOrigin="anonymous",img.src=getPathTo(font,"png")})}function getPathTo(font,ext){let mapped=!1,fontName=function(){for(let key in GLTextGeometry.fontMapping){let mapping=GLTextGeometry.fontMapping[key];if(key==font)return mapped=!0,mapping}return font}(),path=mapped&&GLTextGeometry.fontPath?GLTextGeometry.fontPath:"assets/fonts/";return Assets.getPath(path+fontName+"."+ext+"?"+(window._CACHE_||Date.now()))}let _promises={};GLTextGeometry.fontMapping={},GLTextGeometry.chars={},GLTextGeometry.loadFont=function(font){if(!_promises[font]){let promise=Promise.create();_promises[font]=promise,async function(){let[json,image]=await Promise.all([loadJSON(font),loadImage(font)]);glyphs={},json.chars.forEach(d=>glyphs[d.char]=d),promise.resolve([json,image,glyphs]),GLTextGeometry.chars[font]=json.chars}()}return _promises[font]}}),Class((function GLTextThread(){function loadTextGeometry({font:font,bold:bold,italic:italic,text:text,width:width,align:align,size:size,direction:direction,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,lineHeight:lineHeight,wordSpacing:wordSpacing,wordBreak:wordBreak,langBreak:langBreak,json:json,glyphs:glyphs,bJson:bJson,bGlyphs:bGlyphs,iJson:iJson,iGlyphs:iGlyphs,config:config},pid){const newline=/\n/,whitespace=/\s/,langbreak=!!langBreak&&new RegExp(langBreak),dir="rtl"===direction?-1:1;config||(config={}),config.boldBaseOffset=config.boldBaseOffset?config.boldBaseOffset:0,config.italicBaseOffset=config.italicBaseOffset?config.italicBaseOffset:0;let weights=[],weight={0:glyphs,1:bGlyphs,2:iGlyphs};var buffers;function getKernPairOffset(id1,id2){for(let i=0;i<json.kernings.length;i++){let k=json.kernings[i];if(!(k.first<id1)&&!(k.second<id2))return k.first>id1||k.first===id1&&k.second>id2?0:k.amount}return 0}!function setWeights(){let i=0,w=0;for(;i<text.length;){let code=text.substring(i,i+3),endcode=text.substring(i,i+4);"<b>"!==code&&"<i>"!==code||(w="<b>"===code?1:2,text=text.substr(0,i)+text.substr(i+3)),"</b>"!==endcode&&"</i>"!==endcode||(w=0,text=text.substr(0,i)+text.substr(i+4)),weights.push(w),i++}}(),function createGeometry(){fontHeight=json.common.lineHeight,baseline=json.common.base,scale=size/baseline;let numChars=text.replace(/[ \n]/g,"").length;buffers={position:new Float32Array(4*numChars*3),uv:new Float32Array(4*numChars*2),animation:new Float32Array(3*numChars*4),index:new Uint16Array(6*numChars),weight:new Float32Array(4*numChars)};for(let i=0;i<numChars;i++)buffers.index.set([4*i,4*i+2,4*i+1,4*i+1,4*i+2,4*i+3],6*i);!function layout(){const lines=[];let cursor=0,wordCursor=0,wordWidth=0,line=newLine();function newLine(br=!1){const line={width:0,glyphs:[]};return lines.last()&&(lines.last().br=br),lines.push(line),wordCursor=cursor,wordWidth=0,line}for(;cursor<text.length;){let prev=text[cursor-1],char=text[cursor];text[cursor+1];if(!line.width&&whitespace.test(char)&&!(prev&&newline.test(char)&&newline.test(prev))){cursor++,wordCursor=cursor,wordWidth=0;continue}if(newline.test(char)){cursor++,line=newLine(!0);continue}let style=weight[weights[cursor]]||weight[0],glyph=style[char];if(glyph||(glyph=style.a),glyph.weight=weights[cursor],line.glyphs.length){const prevGlyph=line.glyphs[line.glyphs.length-1][0];let kern=getKernPairOffset(glyph.id,prevGlyph.id)*scale;line.width+=kern,wordWidth+=kern*dir}let gl=Object.assign({},glyph);gl.weight=weights[cursor],line.glyphs.push([gl,line.width]);let advance=0;if(whitespace.test(char)?(gl.whitespace=!0,wordCursor=cursor,wordWidth=0,advance+=wordSpacing*size):advance+=letterSpacing*size,advance+=glyph.xadvance*scale,line.width+=advance,wordWidth+=advance,line.width>width){if((wordBreak||char&&langBreak&&!langbreak.test(char))&&line.glyphs.length>1){line.width-=advance,line.glyphs.pop(),line=newLine();continue}if(!wordBreak&&wordWidth!==line.width){let numGlyphs=cursor-wordCursor+1;line.glyphs.splice(-numGlyphs,numGlyphs),cursor=wordCursor,line.width-=wordWidth,line=newLine();continue}}cursor++}line.width||lines.pop();if("justify"===align){let max=-1/0;lines.forEach(l=>{l.whitespaces=0,max<l.width&&(max=l.width),l.glyphs.forEach(g=>{g[0].whitespace&&l.whitespaces++})}),lines.forEach(l=>{let totalToAdd=max-l.width,addToWhitespace=0===l.whitespaces?0:totalToAdd/l.whitespaces;l.width=max;let additionalOffset=0;l.glyphs.forEach(g=>{g[1]+=additionalOffset,g[0].whitespace&&(additionalOffset+=addToWhitespace)})})}!function populateBuffers(lines){const texW=json.common.scaleW,texH=json.common.scaleH;let geom,y=(config.baseOffset?config.baseOffset:.07)*size,j=0,glyphIndex=0,wordIndex=-1,lineId=-1;for(let lineIndex=0;lineIndex<lines.length;lineIndex++){let line=lines[lineIndex];wordIndex++,lineId++;for(let i=0;i<line.glyphs.length;i++){const glyph=line.glyphs[i][0];let x=line.glyphs[i][1];if(-1===dir&&(x=line.width-x),"center"===align||"justify"===align?x-=.5*line.width:"right"===align&&(x-=line.width*dir),whitespace.test(glyph.char)){wordIndex++;continue}1===glyph.weight&&(y+=config.boldBaseOffset*scale),2===glyph.weight&&(y+=config.italicBaseOffset*scale),x+=glyph.xoffset*scale*dir,y-=glyph.yoffset*scale,buffers.weight.set([glyph.weight,glyph.weight,glyph.weight,glyph.weight],4*glyphIndex);let w=glyph.width*scale,h=glyph.height*scale;-1===dir?buffers.position.set([x-w,y-h,0,x-w,y,0,x,y-h,0,x,y,0],4*j*3):buffers.position.set([x,y-h,0,x,y,0,x+w,y-h,0,x+w,y,0],4*j*3),buffers.animation.set([glyphIndex,wordIndex,lineId,glyphIndex,wordIndex,lineId,glyphIndex,wordIndex,lineId,glyphIndex,wordIndex,lineId],3*glyphIndex*4),glyphIndex++;let u=glyph.x/texW,uw=glyph.width/texW,v=1-glyph.y/texH,vh=glyph.height/texH;buffers.uv.set([u,v-vh,u,v,u+uw,v-vh,u+uw,v],4*j*2),1===glyph.weight&&(y-=config.boldBaseOffset*scale),2===glyph.weight&&(y-=config.italicBaseOffset*scale),y+=glyph.yoffset*scale,j++}y-=size*lineHeight*(line.br?paragraphSpacing:1)}window.zUtils3D&&(geom=new Geometry,geom.addAttribute("position",new GeometryAttribute(buffers.position,3)),geom.computeBoundingBox());let backing=[];for(let key in buffers)backing.push(buffers[key].buffer);buffers.lineLength=lines.length,geom&&(buffers.boundingBox=geom.boundingBox);buffers.letterCount=glyphIndex,buffers.lineCount=lineId,buffers.wordCount=wordIndex,resolve(buffers,pid,backing)}(lines)}()}()}Thread.upload(loadTextGeometry),this.generate=async function(obj){return Thread.shared().loadTextGeometry(obj)}}),"static"),Class((function GLUI(){Inherit(this,Component);const _this=this;function loop(){window.Metal||(window.AURA_AR&&AURA_AR.active&&(World.NUKE.postRender=null,AURA_AR.postRender=loop),_this.Scene&&_this.Scene.render(),_this.Stage&&_this.Stage.render())}window.$gl=function(width,height,map,blending="additive"){return new GLUIObject(width,height,map,blending)},window.$glText=function(text,fontName,fontSize,options){return new GLUIText(text,fontName,fontSize,options)},this.init=async function(is2D,is3D){_this.initialized||(void 0===is2D&&(is2D=!0,is3D=!0),await AssetLoader.waitForLib("zUtils3D"),is2D&&(_this.Stage=new GLUIStage),is3D&&(_this.Scene=new GLUIStage3D,_this.Scene.interaction.input=Mouse),_this.wait(World,"NUKE",_=>{_this.initialized=!0,_this.Scene&&(World.NUKE.onBeforeRender=_this.Scene.mark),World.NUKE.postRender=loop}))},this.clear=function(){_this.Stage.clear(),_this.Scene.clear()},this.ready=function(){return _this.wait(_this,"initialized")},this.renderDirect=function(render){_this.Scene&&_this.Scene.renderDirect(render),_this.Stage&&_this.Stage.renderDirect(render)}}),"static"),Class((function GLUIElement(){Inherit(this,Component);this.element=$gl(),this.create=function(w,h,t){return this.element.create(w,h,t)}})),Class((function GLUIBatch(globalUniforms={}){Inherit(this,Component);const _this=this;var _timer,_geometry,_shader,_objects=[];function loop(){if(_geometry)for(let i=0;i<_objects.length;i++){let obj=_objects[i];obj.mesh.onBeforeRender(),obj._buffers.forEach(buffer=>{let dirty=!1;if(dirty=!buffer.value.equals(buffer.lookup),buffer.value.copy(buffer.lookup),dirty){let attribute=_geometry.attributes[buffer.key],array=attribute.array;switch(buffer.key){case"scale":array[2*i+0]=obj.group.scale.x*obj.mesh.scale.x,array[2*i+1]=obj.group.scale.y*obj.mesh.scale.y;break;case"rotation":array[i]=buffer.lookup.z;break;default:array[3*i+0]=obj.group.position.x,array[3*i+1]=obj.group.position.y,array[3*i+2]=obj.mesh.renderOrder}attribute.needsUpdate=!0}}),obj._uniforms.forEach(uniform=>{let dirty=!1;if("f"==uniform.type?(dirty=obj.mesh.shader.uniforms[uniform.key].value!=uniform.value,uniform.value=obj.mesh.shader.uniforms[uniform.key].value):(dirty=!obj.mesh.shader.uniforms[uniform.key].value.equals(uniform.value),uniform.value.copy(obj.mesh.shader.uniforms[uniform.key].value)),dirty){let attribute=_geometry.attributes["a_"+uniform.key],array=attribute.array;"f"==uniform.type?array[i]=uniform.value:uniform.value.toArray(array,i*uniform.components),attribute.needsUpdate=!0}})}}function getTypeFromSize(size){switch(size){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4"}}function createMesh(){let shader=_objects[0].mesh.shader;_geometry=(new Geometry).instanceFrom(_objects[0].mesh.geometry.clone());let map={},arrays={};_objects.forEach((obj,i)=>{obj.mesh.onBeforeRender();let buffers=[],uniforms=[];for(let key in shader.uniforms){let uniform=shader.uniforms[key];uniform.value instanceof Color&&uniforms.push({key:key,type:"c",components:3}),uniform.value instanceof Vector3&&uniforms.push({key:key,type:"v3",components:3}),uniform.value instanceof Vector2&&uniforms.push({key:key,type:"v",components:2}),"number"==typeof uniform.value&&uniforms.push({key:key,type:"f",components:1})}buffers.push({key:"scale",lookup:obj.group.scale,components:2}),buffers.push({key:"rotation",lookup:obj.group.rotation,components:1}),buffers.push({key:"offset",lookup:obj.group.position,components:3}),uniforms.forEach(uniform=>{arrays["a_"+uniform.key]||(arrays["a_"+uniform.key]=[]),map["a_"+uniform.key]||(map["a_"+uniform.key]=uniform);let value=shader.uniforms[uniform.key].value;"object"==typeof value?(uniform.value=value.clone(),uniform.value.toArray(arrays["a_"+uniform.key],i*uniform.components)):(uniform.value=shader.uniforms[uniform.key].value,arrays["a_"+uniform.key].push(uniform.value))}),buffers.forEach(buffer=>{switch(arrays[buffer.key]||(arrays[buffer.key]=[]),map[buffer.key]||(map[buffer.key]=buffer),buffer.value=buffer.lookup.clone(),buffer.key){case"scale":arrays[buffer.key].push(obj.group.scale.x*obj.mesh.scale.x,obj.group.scale.y*obj.mesh.scale.y);break;case"rotation":arrays[buffer.key].push(buffer.lookup.z);break;default:arrays[buffer.key].push(buffer.lookup.x,buffer.lookup.y,obj.mesh.renderOrder)}}),obj._buffers=buffers,obj._uniforms=uniforms,obj.shader.neverRender=!0});let attributes=[],defines=[];for(let key in map)key.includes("a_")&&(attributes.push(`% ${getTypeFromSize(map[key].components)} ${key};`),defines.push(`${key.replace("a_","v_")} = ${key};`));attributes=attributes.join("\n"),defines=defines.join("\n");for(let key in arrays)_geometry.addAttribute(key,new GeometryAttribute(new Float32Array(arrays[key]),map[key].components,1));if(GLUIBatch.cache[shader.fsName])_shader=GLUIBatch.cache[shader.fsName];else{let vsSplit=(_shader=_this.initClass(Shader,"GLUIBatch",shader.fsName,Object.assign({},{transparent:!0},globalUniforms))).vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=_shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__"),definitions=[];fsSplit[1].split("\n").forEach(line=>{if(line.includes("uniform")){if(line.includes("sampler2D"))return;let data=line.split(" ");definitions.push(`${data[2].replace(";","")} = a_${data[2]}`),vsSplit[1]=`\nattribute ${data[1]} a_${data[2]}\nvarying ${data[1]} ${data[2]}`+vsSplit[1],vsSplit[1]=vsSplit[1].replace(line,""),fsSplit[1]=fsSplit[1].replace(line,`varying ${data[1]} ${data[2]}`)}}),vsSplit[1]=vsSplit[1].replace("//vdefines","\n"+definitions.join("\n")),_shader.vertexShader=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),_shader.fragmentShader=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),GLUIBatch.cache[shader.fsName]=_shader}shader.copyUniformsTo(_shader),_this.mesh=new Mesh(_geometry,_shader),_this.mesh.frustumCulled=!1,_this.group.add(_this.mesh)}this.group=new Group,GLUIBatch.cache||(GLUIBatch.cache={}),_this.startRender(loop),this.add=function(obj){clearTimeout(_timer),_timer=_this.delayedCall(createMesh,50),_this.parent.add(obj),_objects.push(obj)},this.onDestroy=function(){_this.mesh.destroy()}})),Class((function GLUIBatchText(globalUniforms={}){Inherit(this,Component);const _this=this;var _geometry,_shader,_timer,_forceUpdate,_promises=[],_toSplice=[],_objects=[],_offset=0;function loop(){if(!_geometry)return;let updated=!1;for(let key in _geometry.attributes){let attrib=_geometry.attributes[key];attrib.updateRange.length&&(attrib.updateRange.length=0)}let len=_objects.length;for(let i=0;i<len;i++){let obj=_objects[i];obj.mesh.onBeforeRender();let offset=obj._offset,count=obj._count,end=offset+count;obj._buffers.forEach(buffer=>{let dirty=!1;if(dirty=!buffer.value.equals(buffer.lookup),buffer.value.copy(buffer.lookup),dirty){let array=_geometry.attributes[buffer.key].array;for(let j=offset;j<end;j++)switch(buffer.components){case 2:array[2*j+0]=buffer.lookup.x,array[2*j+1]=buffer.lookup.y;break;case 1:array[j]=buffer.lookup.z}updated=!0,buffer.updateRange.offset=offset*buffer.components,buffer.updateRange.count=count*buffer.components,_geometry.attributes[buffer.key].updateRange.push(buffer.updateRange),_geometry.attributes[buffer.key].needsUpdate=!0}}),obj._uniforms.forEach(uniform=>{let dirty=!1;if("f"==uniform.type?(dirty=obj.mesh.shader.uniforms[uniform.key].value!=uniform.value,uniform.value=obj.mesh.shader.uniforms[uniform.key].value):(dirty=!obj.mesh.shader.uniforms[uniform.key].value.equals(uniform.value),uniform.value.copy(obj.mesh.shader.uniforms[uniform.key].value)),dirty||_forceUpdate){let array=_geometry.attributes["a_"+uniform.key].array;for(let j=offset;j<end;j++)"f"==uniform.type?array[j]=obj.mesh.shader.uniforms[uniform.key].value:obj.mesh.shader.uniforms[uniform.key].value.toArray(array,j*uniform.components);updated=!0,uniform.updateRange.offset=offset*uniform.components,uniform.updateRange.count=count*uniform.components,_geometry.attributes["a_"+uniform.key].updateRange.push(uniform.updateRange),_geometry.attributes["a_"+uniform.key].needsUpdate=!0}})}if(updated)for(let key in _geometry.attributes){let bottom,attrib=_geometry.attributes[key];if(!attrib.updateRange.length)continue;let toSplice=_toSplice;toSplice.length=0;for(let i=0;i<attrib.updateRange.length;i++){let current=attrib.updateRange[i],prev=attrib.updateRange[i-1];prev?prev.offset+prev.count==current.offset?(bottom.count+=current.count,toSplice.push(i)):bottom=current:bottom=current}for(let i=toSplice.length-1;i>-1;i--)attrib.updateRange.splice(toSplice[i],1)}_forceUpdate=!1}async function createMesh(){if(_this.flag("mesh"))return;_this.flag("mesh",!0),await Promise.all(_promises),await _this.wait(100);let mesh=new Mesh(_geometry,_shader);_this.mesh=mesh,mesh.frustumCulled=!1,_this.group.add(mesh)}this.group=new Group,_this.flag("canLoad",!0),_this.startRender(loop),_this.add=async function(obj){await _this.flag("canLoad"),_this.flag("canLoad",!1),await obj.loaded(),obj.mesh.shader.neverRender=!0,_promises.push(obj.loaded()),function addAttributes(obj,mesh){let{geometry:geometry,shader:shader}=mesh,count=geometry.attributes.uv.count;mesh.onBeforeRender();let buffers=[],uniforms=[];for(let key in shader.uniforms){let uniform=shader.uniforms[key];uniform.value instanceof Color&&uniforms.push({key:key,type:"c",components:3}),uniform.value instanceof Vector3&&uniforms.push({key:key,type:"v3",components:3}),uniform.value instanceof Vector2&&uniforms.push({key:key,type:"v",components:2}),"number"==typeof uniform.value&&uniforms.push({key:key,type:"f",components:1})}buffers.push({key:"offset",lookup:obj.group.position,components:2}),buffers.push({key:"scale",lookup:obj.group.scale,components:2}),buffers.push({key:"rotation",lookup:obj.group.rotation,components:1}),uniforms.forEach(uniform=>{uniform.updateRange={},uniform.value=shader.uniforms[uniform.key].value,"object"==typeof uniform.value&&(uniform.value=uniform.value.clone()),uniform.buffer=new Float32Array(count*uniform.components)}),buffers.forEach(buffer=>{buffer.updateRange={},buffer.value=buffer.lookup.clone(),buffer.buffer=new Float32Array(count*buffer.components)});for(let i=0;i<count;i++)buffers.forEach(buffer=>{switch(buffer.components){case 2:buffer.buffer[2*i+0]=buffer.lookup.x,buffer.buffer[2*i+1]=buffer.lookup.y;break;case 1:buffer.buffer[i]=buffer.lookup.z}}),uniforms.forEach(uniform=>{"f"==uniform.type?uniform.buffer[i]=shader.uniforms[uniform.key].value:shader.uniforms[uniform.key].value.toArray(uniform.buffer,i*uniform.components)});buffers.forEach(buffer=>{geometry.addAttribute(buffer.key,new GeometryAttribute(buffer.buffer,buffer.components))}),uniforms.forEach(uniform=>{geometry.addAttribute("a_"+uniform.key,new GeometryAttribute(uniform.buffer,uniform.components))}),obj._offset=_offset,obj._count=count,obj._uniforms=uniforms,obj._buffers=buffers,_objects.push(obj),_offset+=count}(obj,obj.mesh),_this.parent.add(obj),_geometry?_geometry.merge(obj.mesh.geometry):function initGeometry(mesh){if((_shader=_this.initClass(Shader,"GLUIBatchText",mesh.shader.fsName,Object.assign({},{transparent:!0},globalUniforms))).vertexShader&&_shader.fragmentShader){let vsSplit=_shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=_shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__"),definitions=[];fsSplit[1].split("\n").forEach(line=>{if(line.includes("uniform")){if(line.includes("sampler2D"))return;let data=line.split(" ");definitions.push(`${data[2].replace(";","")} = a_${data[2]}`),vsSplit[1]=`\nattribute ${data[1]} a_${data[2]}\nvarying ${data[1]} ${data[2]}`+vsSplit[1],vsSplit[1]=vsSplit[1].replace(line,""),fsSplit[1]=fsSplit[1].replace(line,`varying ${data[1]} ${data[2]}`)}}),vsSplit[1]=vsSplit[1].replace("//vdefines","\n"+definitions.join("\n")),_shader.vertexShader=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),_shader.fragmentShader=fsSplit.join("__ACTIVE_THEORY_LIGHTS__")}mesh.shader.copyUniformsTo(_shader),_geometry=mesh.geometry.clone();for(let key in _geometry.attributes)_geometry.attributes[key].updateRange=[]}(obj.mesh),_this.flag("canLoad",!0),clearTimeout(_timer),_timer=_this.delayedCall(createMesh,50),obj.isDirty=!0},_this.remove=function(){_this.destroy()},_this.forceUpdate=function(){_forceUpdate=!0},_this.onDestroy=function(){_this.mesh&&_this.mesh.destroy()}})),Class((function GLUIStageInteraction2D(_camera,_scene,_stage,_custom){Inherit(this,Component);const _this=this;var _ray,_over,_click,_customTest,_disabled,_blocked,_test=[],_objects=this.objects=[],_hold=new Vector2,_lastTestedPoint=(new Vector2,new Vector2);function externalStart(){_this._invisible||start(_lastTestedPoint)}function externalRelease(){_this._invisible||end(_lastTestedPoint)}function move(e){if(GLUI.PREVENT_INTERACTION||_this._invisible||_disabled||_blocked)return;_ray||((_ray=new Raycaster(_camera)).testVisibility=!1);let objects=function testObjects(){let objects=GLUI.Stage.interaction.objects;_test.length=0;for(let i=objects.length-1;i>-1;i--){let obj=objects[i];obj.determineVisible()&&_test.push(obj)}return _test}();if(!objects.length)return;let hit=_ray.checkHit(objects,e,_stage);try{if(hit[0]){GLUI.HIT=!0;let obj=hit[0].object.glui;_over||((_over=obj)._onOver({action:"over",object:obj}),Stage.cursor("pointer")),_over!=obj&&(_over._onOver({action:"out",object:_over}),(_over=obj)._onOver({action:"over",object:obj}),Stage.cursor("pointer"))}else GLUI.HIT=!1,_over&&(_over._onOver({action:"out",object:_over}),_over=null,Stage.cursor("auto"))}catch(e){console.warn(e)}}function start(e){let checkDefault=GLUI.PREVENT_DEFAULT_INTERACTION&&!(e instanceof Vector2),checkPrevention=GLUI.PREVENT_INTERACTION||_this._invisible||_disabled||_blocked;checkDefault||checkPrevention||((Device.mobile||RenderManager.type==RenderManager.WEBVR)&&move(e),_over&&!_click&&(_click=_over,_hold.copy(e),_hold.time=Date.now()))}function end(e){if(!(GLUI.PREVENT_INTERACTION||_this._invisible||_disabled||_blocked)){if(_customTest&&Device.mobile&&_click&&null==_over&&(_over=_click),GLUI.HIT=!1,_click){if(Date.now()-_hold.time>750)return _click=null;if(_click==_over)try{_blocked=!0,_this.delayedCall(_=>{_blocked=!1},_this.preventDoubleClickTime),_click._onClick({action:"click",object:_click}),Device.mobile&&_over&&(_over._onOver({action:"out",object:_over}),_over=null,Stage.cursor("auto"))}catch(e){console.warn(e)}}_click=null}}this.preventDoubleClickTime=100,function addListeners(){_custom||_this.events.sub(Mouse.input,Interaction.MOVE,move),_this.events.sub(Mouse.input,Interaction.START,start),_this.events.sub(Mouse.input,Interaction.END,end),_this.events.sub(Interaction3D.EXTERNAL_PRESS,externalStart),_this.events.sub(Interaction3D.EXTERNAL_RELEASE,externalRelease)}(),_this.startRender(_=>{}),this.add=function(obj){obj&&_objects.push(obj.mesh||obj)},this.remove=function(obj){obj&&_objects.remove(obj.mesh||obj)},this.testWith=function(point,id){point.customTest=!0,_lastTestedPoint.copy(point),_lastTestedPoint.customTest=!0,move(point),Device.mobile&&RenderManager.type!=RenderManager.WEBVR&&_over&&start(point),_customTest||(_customTest=!0)},this.set("_disabled",v=>{(_disabled=v)&&(_click=null,_over=null)})})),Class((function GLUIStageInteraction3D(){Inherit(this,Component);function onHover(e){e.mesh.glui._onOver({action:e.action,object:e.mesh.glui})}function onClick(e){e.mesh.glui._onClick({action:e.action,object:e.mesh.glui})}this.add=function(obj,camera=World.CAMERA){Interaction3D.find(camera).add(obj.mesh||obj,onHover,onClick)},this.remove=function(obj,camera=World.CAMERA){Interaction3D.find(camera).remove(obj.mesh||obj)}})),Class((function GLUICornerPin($obj){Inherit(this,Component);const _this=this;var _geom,_vertices,_last;function loop(){_vertices[0]=_this.tl.x,_vertices[1]=-_this.tl.y,_vertices[3]=_vertices[9]=_this.bl.x,_vertices[4]=_vertices[10]=-_this.bl.y,_vertices[6]=_vertices[15]=_this.tr.x,_vertices[7]=_vertices[16]=-_this.tr.y,_vertices[12]=_this.br.x,_vertices[13]=-_this.br.y,function dirty(){let a=_vertices,b=_last;for(let i=a.length-1;i>-1;i--)if(a[i]!=b[i])return!0;return!1}()&&(_geom.attributes.position.needsUpdate=!0),_last.set(_vertices)}this.tl=new Vector2(0,0),this.tr=new Vector2($obj.width,0),this.bl=new Vector2(0,$obj.height),this.br=new Vector2($obj.width,$obj.height),function initGeometry(){_geom=$obj.mesh.geometry.toNonIndexed(),$obj.useGeometry(_geom),$obj.mesh.scale.set(1,1,1),_vertices=_geom.attributes.position.array,_last=new Float32Array(_vertices)}(),_this.startRender(loop),this.update=function(){this.tl.set(0,0),this.tr.set($obj.width,0),this.bl.set(0,$obj.height),this.br.set($obj.width,$obj.height)},this.tween=function(type,val,time,ease,delay){return val=val instanceof Vector2?val:new Vector2(val.x,val.y),tween(_this[type],val,time,ease,delay)}}));class GLUIObject{constructor(width,height,map,blending="additive"){let shader=this.textureShader=new Shader("GLUIObject",{tMap:{value:null},uAlpha:{type:"f",value:1},transparent:!0,depthTest:!1,blending:"additive"==blending?Shader.ADDITIVE_BLENDING:Shader.NORMAL_BLENDING});shader.persists=!0,map||(shader.visible=!1),this.usingMap=null!=map&&"empty"!=map&&""!=map,this.tMap=shader.uniforms.tMap,this.group=new Group,this.alpha=1,this._x=0,this._y=0,this._z=0,this._scaleX=1,this._scaleY=1,this._scale=1,this._rotation=0,this.multiTween=!0,this.children=[],this.dimensions=new Vector3(width,height,1),this._shader=shader,this._blending=blending,this.mesh=new Mesh(GLUIObject.getGeometry("2d"),shader),this.mesh.glui=this,this.group.add(this.mesh),window.GLSEO&&GLSEO.objectNode(this),this.bg("string"==typeof map?map.includes(["#","0x"])?map:"empty"===map||""===map?null:Utils3D.getTexture(map,{premultiplyAlpha:!1}):map);const _this=this;this.mesh.onBeforeRender=_=>{if(!_this.mesh.determineVisible()&&!_this.firstRender)return;let alpha=_this.getAlpha();if(_this.mesh.shader.uniforms.uAlpha&&(_this.mesh.shader.uniforms.uAlpha.value=alpha),_this.usingMap){if(0==alpha)return void(_this.mesh.shader.visible=!1);_this.mesh.shader.visible=!0}if(!_this.isDirty&&_this.firstRender)return;RenderStats.active&&RenderStats.update("GLUIObject",1,_this.mesh.shader.vsName+"|"+_this.mesh.shader.fsName,_this.mesh),_this.group.position.x=_this._x,_this.group.position.y=_this._3d?_this._y:-_this._y,_this.group.position.z=_this._z,1!=_this.scale&&(_this.group.position.x+=(_this.dimensions.x-_this.dimensions.x*_this.scale)/2,_this.group.position.y-=(_this.dimensions.y-_this.dimensions.y*_this.scale)/2);_this.mesh.shader;if(_this.calcMask){let v=_this.isMasked;v.copy(v.origin),_this.group.localToWorld(v),v.z=v.width,v.w=v.height}map?_this.corners||(_this.mesh.scale.set(1,1,1).multiply(_this.dimensions),_this.group.scale.x=_this._scaleX*_this._scale,_this.group.scale.y=_this._scaleY*_this._scale):_this.group.scale.set(_this._scaleX*_this._scale,_this._scaleY*_this._scale,1),_this._3d||(_this.group.rotation.z=Math.radians(_this._rotation)),_this.anchor&&_this.anchor._parent?(_this.anchor.position.copy(_this.group.position),_this.anchor.scale.copy(_this.group.scale),_this.anchor.quaternion.setFromEuler(_this._rotation),_this.anchor.isDirty=!0):(_this.group.quaternion.setFromEuler(_this._rotation),_this.group.matrixDirty=!0),_this.firstRender||(_this.group.updateMatrixWorld(!0),_this.firstRender=!0),_this.isDirty=!1},_this.isDirty=!0}get width(){return this.dimensions.x}set width(w){this.dimensions.x=w,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get height(){return this.dimensions.y}set height(h){this.dimensions.y=h,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get x(){return this._x}set x(v){this._x=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get y(){return this._y}set y(v){this._y=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get z(){return this._z}set z(v){this._z=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get scale(){return this._scale}set scale(v){this._scale=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get scaleX(){return this._scaleX}set scaleX(v){this._scaleX=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get scaleY(){return this._scaleY}set scaleY(v){this._scaleY=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get rotation(){return this._rotation}set rotation(v){this._rotation=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}style(props){for(let prop in props)void 0!==this[prop]&&(this[prop]=props[prop]);return this}size(w,h){return this.width=w,this.height=h,this.corners&&this.corners.update(),this}add($obj){return $obj.parent=this,this.group.add($obj.group),this.children.push($obj),this.isMasked&&$obj.mask(this.isMasked,this.maskShader),this._3d&&!$obj._3d&&$obj.enable3D(),this.deferred&&($obj.deferRender(!0),$obj.anchor&&this.anchor&&this.anchor.add($obj.anchor)),this}interact(over,click,camera=World.CAMERA,url,label){if(this._interactCamera)return;"string"==typeof camera&&(label=url,url=camera,camera=World.CAMERA),this._onOver=over,this._onClick=click,this._interactCamera=camera;let stage=this._3d?GLUI.Scene:GLUI.Stage;if(over?stage.interaction.add(this,camera):stage.interaction.remove(this,camera),"string"==typeof url&&"string"==typeof label){const _this=this;defer(_=>{!_this.seo&&window.GLSEO&&GLSEO.objectNode(_this),_this.seo&&_this.seo.aLink&&_this.seo.aLink(url,label)})}return this}clearInteract(){if(this._onOver){(this._3d?GLUI.Scene:GLUI.Stage).interaction.remove(this,this._interactCamera),this._onClick=GLUIObject.noop,this._onOver=GLUIObject.noop,this._interactCamera=null}return this}remove(){this.children.forEach(child=>{child.remove?child.remove():child.destroy&&child.destroy()}),this.clearInteract(),this.parent&&(this.parent.children?this.parent.children.remove(this):GLUI.Stage.remove(this)),this.mesh.parent?this.group.parent.remove(this.group):this._3d?GLUI.Scene.remove(this):GLUI.Stage.remove(this);let textureShader=this.textureShader;for(let key in textureShader.uniforms){let uniform=textureShader.uniforms[key];uniform&&uniform.value&&uniform.value.destroy&&uniform.value.destroy()}}create(width,height,map){let $obj=$gl(width,height,map);return this.add($obj),this._3d&&$obj.enable3D(),$obj}removeChild(obj){return this.group.remove(obj.group),this}tween(obj,time,ease,delay){return tween(this,obj,time,ease,delay)}enable3D(style2d){this._3d=!0,this.mesh.geometry=GLUIObject.getGeometry(style2d?"2d":"3d"),this.mesh.shader.depthTest=!0,this._rotation=new Euler;const _this=this;return _this._rotation.onChange(_=>{_this.isDirty=!0}),this}loaded(){return!0}setZ(z){return this.mesh.renderOrder=z,this}bg(path){if(void 0!==path)return"string"==typeof path?path.includes(["#","0x"])?(this.colorShader||(this.colorShader=new Shader("GLUIColor",{transparent:!0,uAlpha:{type:"f",value:1},uColor:{value:new Color(path)}})),this.colorShader.set("uColor",new Color(path)),this._shader!=this.colorShader&&this.useShader(this.colorShader)):(this.textureShader.uniforms.tMap.value=Utils3D.getTexture(path,{premultiplyAlpha:!1}),this._shader!=this.textureShader&&this.useShader(this.textureShader)):this._shader.uniforms.tMap.value=path,this}show(){return this.group.matrixDirty=!0,this.mesh.matrixDirty=!0,this.group.visible=!0,this}hide(){return this.group.visible=!1,this}useShader(shader){return shader&&(shader!=this.textureShader&&shader!=this.colorShader&&(shader.uniforms.tMap=this.mesh.shader.uniforms.tMap,shader.uniforms.uAlpha=this.mesh.shader.uniforms.uAlpha),shader.depthTest=!1,shader.transparent=!0,"additive"==this._blending&&(shader.blending=Shader.ADDITIVE_BLENDING)),this._shader=shader,this.mesh.shader=shader||this._shader,this}depthTest(bool){this.mesh.shader.depthTest=bool}useGeometry(geom){return this.mesh.geometry=geom,this}updateMap(src){this._shader.uniforms.tMap.value="string"==typeof src?Utils3D.getTexture(src):src}mask(d,shaderName){var v;if(d instanceof Vector4?(this.isMasked=!0,v=d):((v=new Vector4(d.x,d.y,0,1)).origin=(new Vector4).copy(v),v.width=d.width,v.height=d.height,this.calcMask=!0,this.isMasked=v),this.maskShader=shaderName,this.usingMap){let shader=new Shader(shaderName||"GLUIObjectMask",{tMap:this.tMap,uAlpha:{value:1},mask:{type:"v4",value:v},transparent:!0,depthWrite:!1,depthTest:!1});this.useShader(shader)}return this.group.traverse(obj=>{obj.glui&&obj.glui!=this&&obj.glui.mask(v,shaderName)}),v}deferRender(parent){this.deferred=!0,parent||(this.anchor=new Group,GLUI.Scene.addDeferred(this))}clearTween(){return this._mathTweens&&this._mathTweens.forEach(t=>{t.tween.stop()}),this}createCorners(){this.corners=new GLUICornerPin(this)}getAlpha(){if(this._gluiParent){let alpha=this._gluiParent.getAlpha();return this.alpha=alpha,alpha}let alpha=this.alpha,$parent=this.parent;for(;$parent;)alpha*=$parent.alpha,$parent=$parent.parent;return alpha}get shader(){return this._shader}_divFocus(){this._onOver&&this._onOver({action:"over",object:this}),this.onDivFocus&&this.onDivFocus()}_divBlur(){this._onOver&&this._onOver({action:"out",object:this}),this.onDivBlur&&this.onDivBlur()}_divSelect(){this._onClick&&this._onClick({action:"click",object:this}),this.onDivBlurSelect&&this.onDivSelect()}get _parent(){return this.parent}}!function(){var _geom2d,_geom3d;GLUIObject.getGeometry=function(type){return"2d"==type?(_geom2d||(_geom2d=new PlaneGeometry(1,1)).applyMatrix((new Matrix4).makeTranslation(.5,-.5,0)),_geom2d):(_geom3d||(_geom3d=World.PLANE),_geom3d)},GLUIObject.clear=function(){_geom2d=_geom3d=null},GLUIObject.noop=_=>{}}();class GLUIText{constructor(text,fontName,fontSize,options={}){options.font=fontName||options.font,options.text=text,options.width=options.width,options.align=options.align||"left",options.size=fontSize||options.size,options.lineHeight=options.lineHeight,options.letterSpacing=options.letterSpacing,options.wordSpacing=options.wordSpacing,options.wordBreak=options.wordBreak,options.langBreak=options.langBreak,options.color=new Color(options.color),this.text=new GLText(options),this.group=new Group,this.alpha=1,this._x=0,this._y=0,this._z=0,this._scaleX=1,this._scaleY=1,this._scale=1,this._rotation=0,this.multiTween=!0;const _this=this;defer(_=>text&&_this.seoText(text)),this.text.ready().then(_=>{let mesh=_this.text.mesh;mesh.glui=_this,mesh.shader.visible=!1,mesh.shader.blending=Shader.ADDITIVE_BLENDING,_this.mesh=mesh,_this.group.add(mesh),_this._3d&&!_this._style2d&&_this.text.centerY(),_this._3d||(_this.text.mesh.shader.depthTest=!1),mesh.onBeforeRender=_=>{if(!mesh.determineVisible()&&!_this.firstRender)return;let alpha=_this.getAlpha();mesh.shader.uniforms.uAlpha&&(mesh.shader.uniforms.uAlpha.value=alpha),0!=alpha?(mesh.shader.visible=!0,!_this.isDirty&&_this.firstRender||(RenderStats.active&&RenderStats.update("GLUIText",1,mesh.shader.vsName+"|"+mesh.shader.fsName,mesh),_this.group.position.x=_this._x,_this.group.position.y=_this._3d?_this._y:-_this._y,_this.group.position.z=_this._z,_this.group.scale.set(_this._scaleX*_this._scale,_this._scaleY*_this._scale,1),_this._3d?_this.anchor&&_this.anchor._parent?(_this.anchor.position.copy(_this.group.position),_this.anchor.scale.copy(_this.group.scale),_this.anchor.quaternion.setFromEuler(_this._rotation)):_this.group.quaternion.setFromEuler(_this._rotation):_this.group.rotation.z=Math.radians(_this._rotation),_this.firstRender||(_this.group.updateMatrixWorld(!0),_this.firstRender=!0,mesh.shader.visible=!0),_this.onInternalUpdate&&_this.onInternalUpdate(),_this.isDirty=!1)):mesh.shader.visible=!1}})}get x(){return this._x}set x(v){this._x=v,this.isDirty=!0}get y(){return this._y}set y(v){this._y=v,this.isDirty=!0}get z(){return this._z}set z(v){this._z=v,this.isDirty=!0}get scale(){return this._scale}set scale(v){this._scale=v,this.isDirty=!0}get scaleX(){return this._scaleX}set scaleX(v){this._scaleX=v,this.isDirty=!0}get scaleY(){return this._scaleY}set scaleY(v){this._scaleY=v,this.isDirty=!0}get rotation(){return this._rotation}set rotation(v){this._rotation=v,this.isDirty=!0}get dimensions(){return this._dimensions||(this._dimensions={}),this.text&&this.text.geometry&&!this._dimensions.max&&(this._dimensions=this.text.geometry.boundingBox,this._dimensions.width=Math.abs(this._dimensions.min.x-this._dimensions.max.x),this._dimensions.height=Math.abs(this._dimensions.min.y-this._dimensions.max.y)),this._dimensions}interact(over,click,camera=World.CAMERA,seoLink){"string"==typeof camera&&(seoLink=camera,camera=World.CAMERA),this._onOver=over,this._onClick=click,this._interactCamera=camera;let stage=this._3d?GLUI.Scene:GLUI.Stage;const _this=this;return _this.text.ready().then(_=>{if(over){if(_this.text.geometry.boundingBox||_this.text.geometry.computeBoundingBox(),!_this.hitArea){let bb=_this.text.geometry.boundingBox,shader=Utils3D.getTestShader();if(shader.visible=!1,_this.hitArea=new Mesh(World.PLANE,shader),_this.hitArea.glui=_this,_this.hitArea.scale.set(Math.abs(bb.min.x)+Math.abs(bb.max.x),Math.abs(bb.min.y)+Math.abs(bb.max.y),1),_this._3d&&!_this._style2d||(_this.hitArea.position.x=(bb.max.x-bb.min.x)/2),_this.hitArea.position.y=(bb.min.y-bb.max.y)/2,_this._3d)switch(_this.text.getData().align){case"center":_this.hitArea.position.x=0;break;case"right":_this.hitArea.position.x=(bb.min.x-bb.max.x)/2}else switch(_this.text.getData().align){case"center":_this.hitArea.position.x=0;break;case"right":_this.hitArea.position.x=-(bb.max.x-bb.min.x)/2}_this.text.mesh.add(_this.hitArea)}stage.interaction.add(_this.hitArea,camera)}else stage.interaction.remove(_this.hitArea,camera)}),defer(_=>{seoLink&&_this.seo&&_this.seo.aLink&&_this.seo.aLink(seoLink)}),this}clearInteract(){if(this._onOver){(this._3d?GLUI.Scene:GLUI.Stage).interaction.remove(this.hitArea,this._interactCamera),this._onClick=GLUIObject.noop,this._onOver=GLUIObject.noop}return this}remove(){let stage=this._3d?GLUI.Scene:GLUI.Stage;this.mesh&&this.mesh.parent?this.group.parent.remove(this.group):stage.remove(this),this.hitArea&&stage.interaction.remove(this.hitArea,this._interactCamera),this.text&&this.text.destroy&&this.text.destroy(),Utils.nullObject(this.mesh),Utils.nullObject(this)}tween(obj,time,ease,delay){return tween(this,obj,time,ease,delay)}enable3D(style2d){this._3d=!0,this._style2d=style2d,this._rotation=new Euler;const _this=this;return _this._rotation.onChange(_=>{_this.isDirty=!0}),_this.text.ready().then(_=>{_this.text.mesh.shader.depthTest=!0}),_this.isDirty=!0,this}depthTest(bool){const _this=this;return _this.text.ready().then(_=>{_this.text.mesh.shader.depthTest=bool}),this}setZ(z){const _this=this;return _this.text.ready().then(_=>{_this.text.mesh.renderOrder=z}),this}height(){return this.mesh?this.text.height:0}setText(text,options){text&&(text=text.toString(),this.seoText(text));const _this=this;return this._dimensions=null,_this.text.ready().then(_=>_this.text.setText(text,options)),this}seoText(text){window.GLSEO&&GLSEO.textNode(this,text)}getTextString(){return this.text.string}setColor(color){const _this=this;return _this.text.ready().then(_=>_this.text.setColor(color)),this}tweenColor(color,time,ease,delay){const _this=this;return _this.text.ready().then(_=>_this.text.tweenColor(color,time,ease,delay)),this}resize(options){const _this=this;_this.text.ready().then(_=>_this.text.resize(options))}show(){return this.text.ready().then(_=>{this.text.mesh.visible=!0,this.text.mesh.updateMatrixWorld(!0)}),this}hide(){const _this=this;return _this.text.ready().then(_=>_this.text.mesh.visible=!1),this}loaded(){return this.text.ready()}length(){return this.text.charLength}deferRender(parent){this.deferred=!0,parent||(this.anchor||(this.anchor=new Group),GLUI.Scene.addDeferred(this))}getAlpha(){if(this._gluiParent){let alpha=this._gluiParent.getAlpha();return this.alpha=alpha,alpha}let alpha=this.alpha,$parent=this.parent;for(;$parent;)alpha*=$parent.alpha,$parent=$parent.parent;return alpha}size(){}upload(){const _this=this;return _this.text.ready().then(_=>_this.text.mesh.upload()),this}_divFocus(){this._onOver&&this._onOver({action:"over",object:this}),this.onDivFocus&&this.onDivFocus()}_divBlur(){this._onOver&&this._onOver({action:"out",object:this}),this.onDivBlur&&this.onDivBlur()}_divSelect(){this._onClick&&this._onClick({action:"click",object:this}),this.onDivBlurSelect&&this.onDivSelect()}get _parent(){return this.parent}async useShader(shader){await this.text.ready(),shader.uniforms.tMap=this.text.shader.uniforms.tMap,shader.uniforms.uAlpha=this.text.shader.uniforms.uAlpha,shader.uniforms.uColor=this.text.shader.uniforms.uColor,shader.blending=Shader.ADDITIVE_BLENDING,shader.transparent=!0,(!this._3d||this._3d||this.parent)&&(shader.depthTest=!1),this.text.mesh.shader=shader||text.shader}}var spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine,spine;Class((function GLUIStage(){Inherit(this,Component);const _this=this;var _scene=new Scene,_camera=new OrthographicCamera(1,1,1,1,.1,1);function resizeHandler(){_camera.left=Stage.width/-2,_camera.right=Stage.width/2,_camera.top=Stage.height/2,_camera.bottom=Stage.height/-2,_camera.near=.01,_camera.far=1e3,_camera.updateProjectionMatrix(),_camera.position.x=Stage.width/2,_camera.position.y=-Stage.height/2}this.interaction=new GLUIStageInteraction2D(_camera,_scene,Stage),this.alpha=1,this.scene=_scene,this.camera=_camera,_scene.disableAutoSort=!0,_camera.position.z=1,function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),resizeHandler(),this.add=function($obj){$obj.parent=_this,_scene.add($obj.group||$obj.mesh)},this.remove=function($obj){$obj.parent=null,_scene.remove($obj.group)},this.clear=function(){_scene.traverse(obj=>{obj.geometry&&obj.shader&&obj.destroy()}),_scene.children.length=_scene.childrenLength=0},this.renderToRT=function(scene,rt){let clearAlpha;rt.fxscene&&rt.fxscene.clearAlpha>-1&&(clearAlpha=World.RENDERER.getClearAlpha(),World.RENDERER.setClearAlpha(0));let autoClear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.render(scene,_camera,rt),World.RENDERER.autoClear=autoClear,clearAlpha&&World.RENDERER.setClearAlpha(clearAlpha)},this.render=function loop(){if(!_scene.children.length)return;let clear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.render(_scene,_camera,null,!0),World.RENDERER.autoClear=clear},this.renderDirect=callback=>{_scene.children.length&&(_scene.traverse(obj=>{obj.shader&&(obj.shader.depthTest=!1)}),callback(_scene,_camera))}})),Class((function GLUIStage3D(){Inherit(this,Object3D);const _this=this;var _camera,_externalRenders=[],_scene=new Scene,_list=new LinkedList;this.alpha=1,this.interaction=new GLUIStageInteraction3D,this.add=function(obj,parent){obj.parent=_this,obj._gluiParent=parent,obj._3d||obj.enable3D(),obj.deferRender()},this.clear=function(){_scene.traverse(obj=>{obj.geometry&&obj.shader&&obj.destroy()}),_scene.children.length=_scene.childrenLength=0},this.addDeferred=function(obj){_list.push(obj),_scene.add(obj.group||obj.mesh)},this.remove=function(obj){_scene.remove(obj.group||obj.mesh),_list.remove(obj)},this.disableAutoSort=function(){_scene.disableAutoSort=!0},this.renderToRT=function(scene,camera){camera=camera.camera||camera,scene.traverse(mesh=>{let obj=mesh.glui;obj&&obj.anchor.determineVisible()&&Utils3D.decompose(obj.anchor,obj.group)}),scene._textRenderCamera=camera,_externalRenders.push(scene)},this.renderToRT2=function(scene,rt,camera){let clearAlpha;rt.fxscene&&rt.fxscene.clearAlpha>-1&&(clearAlpha=World.RENDERER.getClearAlpha(),World.RENDERER.setClearAlpha(0));let autoClear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.render(scene,camera,rt),World.RENDERER.autoClear=autoClear,clearAlpha&&World.RENDERER.setClearAlpha(clearAlpha)},this.render=function loop(){if(!window.Metal){if(_list.length){let obj=_list.start();for(;obj;)obj._marked&&(obj._marked=!1,Utils3D.decompose(obj.anchor,obj.group)),obj=_list.next();let clear=World.RENDERER.autoClear;Renderer.context.clear(Renderer.context.DEPTH_BUFFER_BIT),World.RENDERER.autoClear=!1,World.RENDERER.render(_scene,_camera||World.CAMERA),World.RENDERER.autoClear=clear}if(_externalRenders.length)for(;_externalRenders.length;){let scene=_externalRenders.shift(),camera=scene._textRenderCamera,clear=World.RENDERER.autoClear;Renderer.context.clear(Renderer.context.DEPTH_BUFFER_BIT),World.RENDERER.autoClear=!1,World.RENDERER.render(scene,camera),World.RENDERER.autoClear=clear}}},this.mark=function mark(){let obj=_list.start();for(;obj;)obj.anchor._parent&&(obj.group.visible=obj.anchor.determineVisible()),obj.mesh&&obj.mesh.determineVisible()&&obj.anchor._parent&&(obj._marked=!0),obj=_list.next()},this.renderDirect=function(callback){if(_list.length){let obj=_list.start();for(;obj;)obj._marked&&(obj._marked=!1,Utils3D.decompose(obj.anchor,obj.group)),obj=_list.next();_scene.traverse(obj=>{obj.shader&&(obj.shader.depthTest=!1)}),callback(_scene,_camera||World.CAMERA)}},this.set("camera",c=>{_camera=c.camera||c})})),Class((function GLUIToRT(){const _this=this;if(!_this.addObject)throw"GLUIToRT must decorate inheritance on an FXScene";var _gluiScene=new Scene,_glui3DScene=new Scene;this.glui=$gl(),this.glScene=$gl(),GLUI.Stage.add(_this.glui),_this.startRender(_=>{_this.flag("gluiActive")&&(GLUI.Stage.renderToRT(_gluiScene,_this.rt),_this.glSceneEnabled&&GLUI.Scene.renderToRT2(_glui3DScene,_this.rt,_this.camera.camera)),_this.glSceneEnabled&&(GLUI.Scene.camera=_this.camera.camera)}),this.gluiToRT=function(){_this.flag("gluiActive")||(_this.flag("gluiActive",!0),GLUI.Stage.remove(_this.glui),_gluiScene.add(_this.glui.group),_this.glSceneEnabled&&(GLUI.Scene.remove(_this.glScene),_glui3DScene.add(_this.glScene.group)))},this.gluiToScreen=function(){_this.flag("gluiActive")&&(GLUI.Stage.add(_this.glui),_gluiScene.remove(_this.glui.group),_this.flag("gluiActive",!1),_this.glSceneEnabled&&(GLUI.Scene.add(_this.glScene),_glui3DScene.remove(_this.glScene.group)))}})),Class((function GPU(){Inherit(this,Component);var _this=this,_split={};Hydra.ready(async()=>{for(var key in _this.detect=function(match){if(Device.graphics.gpu)return Device.graphics.gpu.detect(match)},_this.detectAll=function(){if(Device.graphics.gpu){for(var match=!0,i=0;i<arguments.length;i++)Device.graphics.gpu.detect(arguments[i])||(match=!1);return match}},_this.matchGPU=function(str,min,max=99999){let num=function splitGPU(string){if(_split[string])return _split[string];if(!_this.detect(string))return-1;try{var num=Number(_this.gpu.split(string)[1].split(" ")[0]);return _split[string]=num,num}catch(e){return-1}}(str);return num>=min&&num<max},_this.gpu=Device.graphics.gpu?Device.graphics.gpu.identifier:"","ios"==Device.system.os&&"apple gpu"==_this.gpu&&require("iOSGPUTest")(),_this.BLACKLIST=require("GPUBlacklist").match(),_this.T0=!(Device.mobile||!_this.BLACKLIST&&!_this.detect("radeon(tm) r5")&&!_this.detect("hd graphics family")&&!_this.matchGPU("hd graphics ",1e3,5001)&&!(_this.matchGPU("hd graphics ",0,618)&&Device.pixelRatio>1)&&!(_this.detect(["hd graphics","iris"])&&Math.max(Stage.width,Stage.height)>1800)&&"intel iris opengl engine"!==_this.gpu.toLowerCase()&&!_this.matchGPU("iris(tm) graphics ",1e3)),_this.T1=!(_this.BLACKLIST||Device.mobile||_this.T0||!_this.matchGPU("iris(tm) graphics ",540,1e3)&&!_this.matchGPU("hd graphics ",514,1e3)&&_this.detect(["nvidia","amd","radeon","geforce"])),_this.T2=!_this.BLACKLIST&&!Device.mobile&&!(!_this.detect(["nvidia","amd","radeon","geforce"])||_this.T1||_this.T0),_this.T3=!(_this.BLACKLIST||Device.mobile||!_this.detect(["titan","amd radeon pro","quadro"])&&!_this.matchGPU("gtx ",940)&&!_this.matchGPU("radeon (tm) rx ",400)&&!_this.matchGPU("radeon rx ",400)&&!_this.matchGPU("radeon pro ",420)),_this.T4=!(_this.BLACKLIST||Device.mobile||!_this.detect(["titan","quadro","radeon vii"])&&!_this.matchGPU("gtx ",1040)&&!_this.matchGPU("rtx")&&!_this.matchGPU("radeon rx ",500)&&!_this.matchGPU("vega ",50)),_this.T5=!(_this.BLACKLIST||Device.mobile||!_this.detect(["titan","radeon vii"])&&!_this.matchGPU("gtx ",1080)&&!_this.matchGPU("rtx ",2060)),_this.MT0=!!Device.mobile&&(!!_this.BLACKLIST||!("ios"!=Device.system.os||!_this.detect("a7"))||!("android"!=Device.system.os||!_this.detect("sgx"))||(_this.detect("adreno")?_this.matchGPU("adreno (tm) ",0,415):!!_this.detect("mali")&&_this.matchGPU("mali-t",0,628))),_this.MT1=!(!Device.mobile||_this.BLACKLIST||("ios"!=Device.system.os||!_this.detect(["a8","a9"]))&&("android"!=Device.system.os||_this.MT0)),_this.MT2=function(){if(!Device.mobile)return!1;if(_this.BLACKLIST)return!1;if("ios"==Device.system.os&&_this.detect("a10"))return!0;if(_this.detect("nvidia tegra")&&Device.detect("pixel c"))return!0;if(_this.detect("mali-g"))return _this.matchGPU("mali-g",73);if(_this.detect("adreno")){if(_this.matchGPU("adreno (tm) ",600,616))return!0;if(_this.matchGPU("adreno (tm) ",420))return!0}return!!_this.detect("mali-g")}(),_this.MT3=!!Device.mobile&&!_this.BLACKLIST&&(!("ios"!=Device.system.os||!_this.detect(["a11","a12"]))||!!_this.matchGPU("adreno (tm) ",530,600)||(_this.detect("mali-g")?_this.matchGPU("mali-g",71):!(!navigator.platform.toLowerCase().includes(["mac","windows"])||"chrome"!=Device.system.browser))),_this.MT4=!!Device.mobile&&!_this.BLACKLIST&&(!("ios"!=Device.system.os||!_this.detect(["a13","a14","a15","a16","a17","a18"]))||(_this.detect("adreno")?_this.matchGPU("adreno (tm) ",630):!(!navigator.platform.toLowerCase().includes(["mac","windows"])||"chrome"!=Device.system.browser))),_this.lt=function(num){return _this.TIER>-1&&_this.TIER<=num},_this.gt=function(num){return _this.TIER>-1&&_this.TIER>=num},_this.eq=function(num){return _this.TIER>-1&&_this.TIER==num},_this.mobileEq=function(num){return _this.M_TIER>-1&&_this.M_TIER==num},_this.mobileLT=function(num){return _this.M_TIER>-1&&_this.M_TIER<=num},_this.mobileGT=function(num){return _this.M_TIER>-1&&_this.M_TIER>=num},_this)"T"==key.charAt(0)&&!0===_this[key]&&(_this.TIER=Number(key.charAt(1))),"MT"==key.slice(0,2)&&!0===_this[key]&&(_this.M_TIER=Number(key.charAt(2)));!1!==Utils.query("gpu")&&(Device.mobile||Utils.query("gpu").toString().includes("m")?(_this.TIER=-1,_this.M_TIER=Number(Utils.query("gpu").slice(1))):_this.TIER=Number(Utils.query("gpu"))),_this.OVERSIZED=!Device.mobile&&_this.TIER<2&&Math.max(window.innerWidth,window.innerHeight)>1500,"ie"==Device.system.browser&&(_this.OVERSIZED=!0),_this.initialized=!0}),this.ready=function(){return this.wait("initialized")}}),"static"),Module((function iOSGPUTest(){function test(){let results=[];function getPrime(){return function largest_prime_factor(n){return factors(n).filter(primep).pop()}(1e11)}function factors(n){var i,out=[],sqrt_n=Math.sqrt(n);for(i=2;i<=sqrt_n;i++)n%i==0&&out.push(i);return out}function primep(n){return 0===factors(n).length}for(let i=0;i<3;i++){let time=performance.now();getPrime(),results.push(10*(performance.now()-time))}return results.sort((a,b)=>a-b),results[0]}this.exports=function(){let res=Math.min(screen.width,screen.height)+"x"+Math.max(screen.width,screen.height),time=test();switch(res){case"320x480":Device.graphics.webgl.gpu="legacy";break;case"320x568":Device.graphics.webgl.gpu=time<=400?"apple a8":time<=500?"apple a7":"legacy";break;case"375x812":case"414x896":Device.graphics.webgl.gpu=time<=160?"apple a13":time<=180?"apple a12":"apple a11";break;default:case"414x736":case"375x667":case"768x1024":Device.graphics.webgl.gpu=time<=160?"apple a13":time<=180?"apple a12":time<=220?"apple a11":time<=250?"apple a10":time<=360?"apple a9":time<=400?"apple a8":time<=600?"apple a7":"legacy";break;case"834x1112":Device.graphics.webgl.gpu=time<=160?"apple a13":time<=180?"apple a12":time<=220?"apple a11":"apple a10";break;case"834x1194":Device.graphics.webgl.gpu="apple a12";break;case"1024x1366":Device.graphics.webgl.gpu=time<=160?"apple a13":time<=180?"apple a12":time<=220?"apple a11":time<=250?"apple a10":"apple a9"}}})),Module((function GPUBlacklist(){this.exports={match:function(){return!Device.graphics.gpu||Device.graphics.gpu.detect(["radeon hd 6970m","radeon hd 6770m","radeon hd 6490m","radeon hd 6630m","radeon hd 6750m","radeon hd 5750","radeon hd 5670","radeon hd 4850","radeon hd 4870","radeon hd 4670","geforce 9400m","geforce 320m","geforce 330m","geforce gt 130","geforce gt 120","geforce gtx 285","geforce 8600","geforce 9600m","geforce 9400m","geforce 8800 gs","geforce 8800 gt","quadro fx 5","quadro fx 4","radeon hd 2600","radeon hd 2400","radeon hd 2600","radeon r9 200","mali-4","mali-3","mali-2","google swiftshader","sgx543","legacy","sgx 543"])}}})),Class((function Initializer3D(){Inherit(this,Component);const _this=this;let _loader,_working,_promises=[],_queue=[];async function resolve(){await Promise.all(_promises),clearTimeout(_this.fire),_this.fire=_this.delayedCall(_=>{_this.events.fire(_this.READY),_this.resolved=!0,Utils3D.onTextureCreated=null,_loader&&_loader.trigger(50)},100)}async function workQueue(){clearTimeout(_this.warningTimer),_working=!0;let promise=_queue.shift();if(!promise)return _working=!1;promise.resolve(workQueue),Hydra.LOCAL&&(_this.warningTimer=_this.delayedCall(_=>{console.warn("Long running queue has taken more than 5 seconds.")},5e3))}function incCompleted(){_loader&&_loader.trigger(1)}this.READY="initializer_ready",this.bundle=function(){return new function PromiseBundler(){const promises=[],ready=Promise.create();let timer;function run(){clearTimeout(timer),timer=_this.delayedCall(_=>{Promise.all(promises).then(_=>ready.resolve())},100)}this.capture=function(promise){promises.push(promise),run()},this.ready=function(){return run(),ready}}},this.promise=this.capture=function(promise){return _loader&&_loader.add(1),promise.then(incCompleted),_promises.push(promise),clearTimeout(_this.timer),_this.timer=_this.delayedCall(resolve,100),promise},this.ready=this.loaded=function(){return _this.wait(_this,"resolved")},this.createWorld=async function(){await Promise.all([AssetLoader.waitForLib("zUtils3D"),Shaders.ready(),UILStorage.ready()]),World.instance()},this.linkSceneLayout=function(loader){_this.captureTextures(),SceneLayout.initializer=_this.capture,_loader=loader},this.queue=function(immediate){if(immediate)return Promise.resolve(_=>{});let promise=Promise.create();return _queue.push(promise),_working||workQueue(),promise},this.captureTextures=function(){Utils3D.onTextureCreated=texture=>{_this.promise(texture.promise)}},this.uploadAll=async function(group){if(!group)throw"Undefined passed to uploadAll";let sceneLayout;if(group instanceof SceneLayout||window.StageLayout&&group instanceof StageLayout){if(sceneLayout=group,sceneLayout.uploaded)return;sceneLayout.uploaded=!0,await sceneLayout.loadedAllLayers(),group=group.group}let promises=[],layouts=[],textures=[];sceneLayout&&(sceneLayout.textures=textures),group.traverse(obj=>{if(obj.sceneLayout&&obj!=group&&layouts.push(obj.sceneLayout),obj.stageLayout&&obj!=group&&layouts.push(obj.stageLayout),!obj.uploadIgnore&&0!=obj.visible){if(obj.shader)for(let key in obj.shader.uniforms){let uniform=obj.shader.uniforms[key];uniform&&uniform.value&&uniform.value.promise&&(textures.push(uniform.value),promises.push(uniform.value.promise.then(_=>uniform.value.upload.bind(uniform.value)).catch(e=>{})))}obj.asyncPromise?promises.push(obj.asyncPromise.then(_=>obj.upload.bind(obj))):obj.upload&&obj.upload()}}),await Promise.catchAll(promises),textures.forEach(t=>t.upload());for(let i=0;i<layouts.length;i++)await _this.uploadAll(layouts[i]);sceneLayout&&sceneLayout._completeInitialization&&sceneLayout._completeInitialization(!0)},this.uploadAllDistributed=this.uploadAllAsync=async function(group){if(!group)throw"Undefined passed to uploadAllDistributed";let sceneLayout;if(group instanceof SceneLayout||window.StageLayout&&group instanceof StageLayout){if(sceneLayout=group,sceneLayout.uploaded)return;sceneLayout.uploaded=!0,await sceneLayout.loadedAllLayers(),group=group.group}let uploads=[],_async=[],promises=[],layouts=[],textures=[];sceneLayout&&(sceneLayout.textures=textures),group.traverse(obj=>{if(obj.sceneLayout&&obj!=group&&layouts.push(obj.sceneLayout),obj.stageLayout&&obj!=group&&layouts.push(obj.stageLayout),!obj.uploadIgnore&&0!=obj.visible){if(obj.shader)for(let key in obj.shader.uniforms){let uniform=obj.shader.uniforms[key];uniform&&uniform.value&&uniform.value.promise&&(textures.push(uniform.value),promises.push(uniform.value.promise.then(_=>uploads.push(uniform.value.upload.bind(uniform.value))).catch(e=>{})))}if(obj.asyncPromise)promises.push(obj.asyncPromise.then(_=>{obj.geometry&&(obj.geometry.distributeBufferData=!0),uploads.push(obj.upload.bind(obj)),obj.geometry&&_async.push(obj.geometry.uploadBuffersAsync.bind(obj.geometry))}));else if(obj.upload){if(obj.geometry){if(obj.geometry.uploaded)return;obj.geometry.distributeBufferData=!0}uploads.push(obj.upload.bind(obj)),obj.geometry&&_async.push(obj.geometry.uploadBuffersAsync.bind(obj.geometry))}}});let canFinish=!1,promise=Promise.create(),worker=new Render.Worker(_=>{let upload=uploads.shift();upload?upload():canFinish?((async _=>{for(let i=0;i<_async.length;i++)await _async[i]();for(let i=0;i<layouts.length;i++)await _this.uploadAllAsync(layouts[i]);promise.resolve()})(),worker.stop()):worker.pause()},1);return Promise.catchAll(promises).then(_=>{worker.resume(),canFinish=!0}),sceneLayout&&sceneLayout._completeInitialization&&sceneLayout._completeInitialization(!1),promise},this.detectUploadAll=function(group,sync){return sync?_this.uploadAll(group):_this.uploadAllDistributed(group)},this.detectUploadNuke=function(nuke,sync){return sync?_this.uploadNukeAsync(nuke):_this.uploadNuke(nuke)},this.uploadNuke=async function(nuke){for(let i=0;i<nuke.passes.length;i++){let pass=nuke.passes[i],uniforms=pass.uniforms;for(let key in uniforms)uniforms[key].promise&&await uniforms[key].promise,uniforms[key].upload&&uniforms[key].upload();pass.upload()}},this.uploadNukeAsync=function(nuke){return this.uploadNuke(nuke)},this.set("loader",loader=>{_loader=loader})}),"static"),Class((function Webcam(_width,_height,_audio){Inherit(this,Component);var _this=this;let _stream,_cameras={},_config={},_back=!1,_attempts=0;function establishWebcam(){if(_attempts>=2||!navigator.mediaDevices)return error();(function lookupDevices(){let promise=Promise.create();return Device.mobile?(navigator.mediaDevices.enumerateDevices().then(devices=>{devices.forEach(device=>{device.label.includes("front")&&(_cameras.front={deviceId:{exact:device.deviceId}}),device.label.includes("back")&&(_cameras.back={deviceId:{exact:device.deviceId}},_back=!0)}),_cameras.front||(_cameras.front={facingMode:"user"}),_cameras.back||(_cameras.back={facingMode:"environment"},_back=!1),promise.resolve()}),promise):Promise.resolve()})().then(()=>{_stream&&_config.back&&_stream.getTracks()[0].stop(),Device.mobile.phone&&(_cameras&&_cameras.back&&(_cameras.back.frameRate={ideal:60}),_cameras&&_cameras.front&&(_cameras.front.frameRate={ideal:60})),navigator.mediaDevices.getUserMedia({video:_config.back?_cameras.back:_cameras.front||!0,audio:_audio}).then(success).catch(error)}),_attempts+=1}function success(stream){_this.denied=!1,_stream=stream,_config.back&&!_back?establishWebcam():(_this.div.srcObject=stream,_this.events.fire(Events.READY,null,!0))}function error(){_this.denied=!0,_this.events.fire(Events.ERROR,null,!0)}_this.facing="back",function createVideo(){_this.div=window.AURA?document.createElement():document.createElement("video"),_this.div.width=_width,_this.div.height=_height,_this.div.autoplay=!0,_this.div.controls=!0,_this.div.playsinline=!0,_this.div.setAttribute("playsinline",!0),_this.div.setAttribute("controls",!0),Stage.add(_this.div),_this.element=$(_this.div),_this.element.transformPoint(0,0).transform({scaleX:Device.mobile?1:-1,scale:.25}).setZ(-1)}(),function initNavigator(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia}(),this.createStream=function(config={}){_attempts=0,_config=config,establishWebcam()},this.flip=function(){if(!_back)return;let direction;"front"===_this.facing?(_this.facing="back",direction=_cameras.back):(_this.facing="front",direction=_cameras.front),_stream.getTracks()[0].stop(),navigator.getUserMedia({video:direction||!0,audio:_audio},success,error)},this.get("width",(function(){return _width})),this.get("height",(function(){return _height})),this.size=function(w,h){_this.div.width=_width=w,_this.div.height=_height=h,_this.element.size(w,h)},this.getPixels=function(width=_width,height=_height){return _this.canvas||(_this.canvas=document.createElement("canvas"),_this.canvas.width=width,_this.canvas.height=height,_this.canvas.context=_this.canvas.getContext("2d")),_this.canvas.context.drawImage(_this.div,0,0,width,height),_this.canvas.context.getImageData(0,0,width,height)},this.getCanvas=function(){return _this.canvas||(_this.canvas=document.createElement("canvas"),_this.canvas.width=_width,_this.canvas.height=_height,_this.canvas.context=_this.canvas.getContext("2d")),_this.canvas.context.drawImage(_this.div,0,0,_width,_height),_this.canvas},this.ready=function(){return _this.div.readyState>0},this.end=function(){_this.active=!1,_this.div.pause(),_stream&&(_stream.getTracks()[0].enabled=!1)},this.restart=function(){_this.div.play(),_stream&&(_stream.getTracks()[0].enabled=!0),_this.active=!0},this.deviceCount=async function(kind){if(!navigator.mediaDevices)return 0;let devices=await navigator.mediaDevices.enumerateDevices(),count=0;return devices.forEach(d=>{d.kind.includes(kind)&&count++}),count}})),Class((function MouseFlowMap({size:size=512,radius:radius=.15,falloff:falloff=1,speed:speed=0,velocity:velocity=!0,autoStart:autoStart=!0,hitMesh:hitMesh,numStamps:numStamps=4,stampAlpha:stampAlpha=1,decay:decay=.93,fps:fps=60,multitouch:multitouch=!1,hideMouse:hideMouse=!1,autoFade:autoFade=!1,interaction:interaction=null,stage:stage=Stage}={}){Inherit(this,MouseFlowMapRenderer,size);const _this=this;let _stampShader;const _stamps=[],_stampPos=new Vector2;var _interaction=interaction,_touches=[],_touchMap={},_mouse=Device.mobile&&multitouch||hideMouse?null:new MouseFlowMapTouch;function draw(touch){touch.render(decay,numStamps),velocity&&_stampShader.uniforms.uVelocity.value.copy(touch.velocity),(touch!=_mouse||Mouse.velocity.length()>.05)&&!_this.disabled?(_stampPos.copy(touch.pos),_stamps.forEach(stamp=>{_stampPos.add(touch.step),stamp.position.x=_stampPos.x,stamp.position.y=_stampPos.y})):_stamps.forEach(stamp=>stamp.position.x=9999999),touch.ticks<5?touch.ticks++:_this.draw()}function loop(){_stampShader.set("uAspect",stage.width/stage.height),_mouse&&(mouseMove(Mouse),draw(_mouse));for(let i=0;i<_touches.length;i++){let touch=_touches[i];touch.disabled||draw(touch)}_this.clear()}function addHandlers(){multitouch&&(window.addEventListener("touchstart",touchStart,{passive:!1}),window.addEventListener("touchmove",touchMove,{passive:!1}),window.addEventListener("touchend",touchEnd,{passive:!1})),hideMouse||hitMesh||(window.addEventListener("mousedown",mouseStart),window.addEventListener("touchmove",mouseMove),window.addEventListener("mouseup",mouseEnd)),document.body.addEventListener("mouseleave",out,!1),_interaction&&_interaction.add([hitMesh],null,null,hitMeshMove)}function mouseStart(e){_this.isDragging=!0}function touchStart(e){e.preventDefault&&e.preventDefault();for(let i=0;i<e.changedTouches.length;i++){let touch=e.changedTouches[i];_touchMap[touch.identifier]=new MouseFlowMapTouch,_touches.push(_touchMap[touch.identifier])}}function mouseEnd(e){defer(()=>{_this.isDragging=!1,(e.x<0||e.y<0||e.x>Stage.width||e.y>Stage.width)&&(_mouse.isMouseLeft=!0)})}function touchEnd(e){for(let i=0;i<e.changedTouches.length;i++){let touch=e.changedTouches[i];_touches.remove(_touchMap[touch.identifier]),delete _touchMap[touch.identifier]}}function out(e){e.toElement||_this.isDragging||(_this.isMouseLeft=!0)}function mouseMove(e){_mouse&&_mouse.move(Mouse)}function touchMove(e){e.preventDefault&&e.preventDefault();for(let i=0;i<e.touches.length;i++){let touch=e.touches[i];touch.x=touch.pageX,touch.y=touch.pageY,_touchMap[touch.identifier]&&_touchMap[touch.identifier].move(touch)}}function hitMeshMove(e){_mouse&&_mouse.move(e.hit.uv,!0)}this.disabled=!1,this.touches=_touches,function initPass(){_this.setShader(_this.initClass(Shader,"MouseFlowMapBlend",{uStamp:{value:_this.rt.texture},uSpeed:{value:Math.pow(Math.clamp(speed,0,1),3)},uTexture:{value:null},uFirstDraw:{value:1}}))}(),function initStamps(){let geometry=new PlaneGeometry(1,1);_stampShader=_this.initClass(Shader,"MouseFlowMapStamp",{uVelocity:{value:new Vector2(1,1)},uFalloff:{value:Math.clamp(falloff,0,1)},uAlpha:{value:Math.clamp(stampAlpha,0,1)},uAspect:{value:stage.width/stage.height},transparent:!0,depthWrite:!1,depthTest:!1});for(let i=0;i<numStamps;i++){let stamp=new Mesh(geometry,_stampShader);stamp.frustumCulled=!1,stamp.scale.setScalar(radius),_this.add(stamp),_stamps.push(stamp)}}(),addHandlers(),autoStart&&defer(()=>_this.start()),this.start=function(){_this.isStarted||(_this.isStarted=!0,addHandlers(),_this.startRender(loop,fps))},this.stop=function(){_this.isStarted&&(_this.isStarted=!1,function removeHandlers(){window.removeEventListener("touchstart",touchStart),window.removeEventListener("mousedown",mouseStart),window.removeEventListener("touchmove",touchMove),window.removeEventListener("mouseup",mouseEnd),window.removeEventListener("touchend",touchEnd),document.body.removeEventListener("mouseleave",out,!1),_interaction&&_interaction.remove([hitMesh])}(),_this.stopRender(loop))},this.render=function(){loop()}})),Class((function MouseFlowMapRenderer(_size){Inherit(this,Component);const _this=this;let _shader;const _scene1=new Scene,_scene2=new Scene,_camera=new OrthographicCamera(0,1,1,0,.1,2);let _count=0;const _rtPing=Utils3D.createRT(_size,_size),_rtPong=Utils3D.createRT(_size,_size);this.rt=Utils3D.createRT(_size,_size,null,Texture.RGBAFormat),this.textureUniform={type:"t",value:null,ignoreUIL:!0},function init(){_camera.position.z=1}(),_scene1.disableAutoSort=!0,_scene2.disableAutoSort=!0,this.add=function(mesh){_scene1.add(mesh)},this.setShader=function(shader){_shader=shader;let mesh=new Mesh(World.QUAD,shader);_scene2.add(mesh)},this.draw=function(){if(!_shader)return;let autoClear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.renderSingle(_scene1.children[0],_camera,_this.rt),World.RENDERER.autoClear=autoClear,_this.textureUniform.value=_this.rt.texture},this.clear=function(){if(!_shader)return;_count++;const clearAlphaCache=Renderer.CLEAR[3];Renderer.CLEAR[3]=0,_count%2==0?(_shader.uniforms.uTexture.value=_rtPing.texture,World.RENDERER.renderSingle(_scene2.children[0],_camera,_rtPong),_this.textureUniform.value=_rtPong.texture):(_shader.uniforms.uTexture.value=_rtPong.texture,World.RENDERER.renderSingle(_scene2.children[0],_camera,_rtPing),_this.textureUniform.value=_rtPing.texture),_shader.uniforms.uFirstDraw.value=0,Renderer.CLEAR[3]=clearAlphaCache,Renderer.context.bindFramebuffer(Renderer.context.FRAMEBUFFER,_this.rt._gl),Renderer.context.clear(Renderer.context.COLOR_BUFFER_BIT),Renderer.context.bindFramebuffer(Renderer.context.FRAMEBUFFER,null)},this.upload=async function(){let uploads=[_rtPing,_rtPong,_this.rt];_shader&&uploads.push(_shader);for(let i=0;i<uploads.length;i++)uploads[i].upload(),await defer()}})),Class((function MouseFlowMapTouch(){Inherit(this,Component);const _this=this;new Vector2;var _touch=new Vector2,_touchLast=new Vector2,_touchStep=new Vector2,_velocity=new Vector2,_current=new Vector2,_delta={x:0,y:0},_last=new Vector2;this.velocity=new Vector2,this.ticks=0,this.render=function(decay,numStamps){_velocity.multiplyScalar(decay),_this.velocity.lerp(_velocity,.5),_touch.lerp(_current,.4),_touchStep.copy(_touch).sub(_touchLast).multiplyScalar(1/numStamps),_touchLast.copy(_touch)},this.move=function(e,hitMesh){_this.isMouseLeft&&(_this.isMouseLeft=!1,_touch.copy(Mouse.inverseNormal),_touchLast.copy(_touch)),e.x!=_last.x&&(hitMesh?(_current.x=e.x,_current.y=e.y):(_current.x=e.x/Stage.width,_current.y=1-e.y/Stage.height),_delta.x=e.x-_last.x,_delta.y=e.y-_last.y,_last.x=e.x,_last.y=e.y,_velocity.copy(_delta).multiplyScalar(.03/16))},this.get("step",_=>_touchStep),this.get("pos",_=>_touch)})),Class((function MouseFluid(_params={active:!0}){Inherit(this,Object3D);const _this=this;var _fluid;this.scale=1;var _scale=1,_last=new Vector2,_mouse=new Vector2,_white=new Color("#ffffff");function loop(){_scale+=.05*(_this.scale-_scale),_mouse.copy(Mouse);let len=_mouse.distanceTo(_last),size=_this.scaleBasedOnVelocity?.6*Math.range(len,0,5,5,60,!0):25,delta=Math.range(len,0,15,0,5,!0);len>.01&&_fluid.drawInput(Mouse.x,Mouse.y,(_mouse.x-_last.x)*delta,(_mouse.y-_last.y)*delta,_white,size*_scale),_last.copy(_mouse)}this.scaleBasedOnVelocity=!0,async function(){let layout=_this.initClass(SceneLayout,"mousefluid");_fluid=await layout.getLayer("fluid"),_this.flag("fluid",!0),_params.active?_this.startRender(loop):_fluid.visible=!1}(),this.applyTo=async function(shader){await _this.wait("fluid"),shader.uniforms.tFluid=_fluid.fbos.velocity.uniform,shader.uniforms.tFluidMask={value:_fluid}}}),"singleton"),Class((function ParticleDistributor(){Inherit(this,Component);const _this=this;function init(){_this.flag("initGenerate")||(_this.flag("initGenerate",!0),Thread.upload(distributeParticles))}function distributeParticles(e,id){let{position:position,count:count,normal:normal,uv:uv,skinIndex:skinIndex,skinWeight:skinWeight}=e,vertices=position.length/3,v3=new Vector3,outputPosition=new Float32Array(3*count),outputNormal=normal?new Float32Array(3*count):null,outputUV=uv?new Float32Array(2*count):null,outputSkinIndex=skinIndex?new Float32Array(4*count):null,outputSkinWeight=skinWeight?new Float32Array(4*count):null;for(let i=0;i<count;i++){let j=3*Math.random(0,vertices/3);v3.set(Math.random(0,100),Math.random(0,100),Math.random(0,100));let m=1/(v3.x+v3.y+v3.z);if(v3.set(v3.x*m,v3.y*m,v3.z*m),outputPosition[3*i+0]=position[3*j+0]*v3.x+position[3*j+3]*v3.y+position[3*j+6]*v3.z,outputPosition[3*i+1]=position[3*j+1]*v3.x+position[3*j+4]*v3.y+position[3*j+7]*v3.z,outputPosition[3*i+2]=position[3*j+2]*v3.x+position[3*j+5]*v3.y+position[3*j+8]*v3.z,outputNormal&&(outputNormal[3*i+0]=normal[3*j+0]*v3.x+normal[3*j+3]*v3.y+normal[3*j+6]*v3.z,outputNormal[3*i+1]=normal[3*j+1]*v3.x+normal[3*j+4]*v3.y+normal[3*j+7]*v3.z,outputNormal[3*i+2]=normal[3*j+2]*v3.x+normal[3*j+5]*v3.y+normal[3*j+8]*v3.z),outputUV&&(outputUV[2*i+0]=normal[2*j+0]*v3.x+normal[2*j+2]*v3.y+normal[2*j+4]*v3.z,outputUV[2*i+1]=normal[2*j+1]*v3.x+normal[2*j+3]*v3.y+normal[2*j+5]*v3.z),outputSkinIndex){let skinCluster1={};skinCluster1[skinIndex[4*j+0]]=skinWeight[4*j+0],skinCluster1[skinIndex[4*j+1]]=skinWeight[4*j+1],skinCluster1[skinIndex[4*j+2]]=skinWeight[4*j+2],skinCluster1[skinIndex[4*j+3]]=skinWeight[4*j+3];let skinCluster2={};skinCluster2[skinIndex[4*j+4]]=skinWeight[4*j+4],skinCluster2[skinIndex[4*j+5]]=skinWeight[4*j+5],skinCluster2[skinIndex[4*j+6]]=skinWeight[4*j+6],skinCluster2[skinIndex[4*j+7]]=skinWeight[4*j+7];let skinCluster3={};skinCluster3[skinIndex[4*j+8]]=skinWeight[4*j+8],skinCluster3[skinIndex[4*j+9]]=skinWeight[4*j+9],skinCluster3[skinIndex[4*j+10]]=skinWeight[4*j+10],skinCluster3[skinIndex[4*j+11]]=skinWeight[4*j+11];let indices=[];for(let k=0;k<12;k++){let index=skinIndex[4*j+k];-1===indices.indexOf(index)&&indices.push(index)}let clusters=[];for(let k=0;k<indices.length;k++){let index=indices[k];clusters.push([index,(skinCluster1[index]||0)*v3.x+(skinCluster2[index]||0)*v3.y+(skinCluster3[index]||0)*v3.z])}clusters.sort((function(a,b){return b[1]-a[1]}));for(let l=clusters.length-1;l<4;l++)clusters.push([0,0]);let sum=clusters[0][1]+clusters[1][1]+clusters[2][1]+clusters[3][1];outputSkinIndex[4*i+0]=clusters[0][0],outputSkinIndex[4*i+1]=clusters[1][0],outputSkinIndex[4*i+2]=clusters[2][0],outputSkinIndex[4*i+3]=clusters[3][0],outputSkinWeight[4*i+0]=clusters[0][1]*(1/sum),outputSkinWeight[4*i+1]=clusters[1][1]*(1/sum),outputSkinWeight[4*i+2]=clusters[2][1]*(1/sum),outputSkinWeight[4*i+3]=clusters[3][1]*(1/sum)}}let output={},buffer=[];output.position=outputPosition,buffer.push(outputPosition.buffer),outputNormal&&(output.normal=outputNormal,buffer.push(outputNormal.buffer)),outputUV&&(output.uv=outputUV,buffer.push(outputUV.buffer)),outputSkinIndex&&(output.skinIndex=outputSkinIndex,output.skinWeight=outputSkinWeight,buffer.push(outputSkinIndex.buffer),buffer.push(outputSkinWeight.buffer)),resolve(output,id,buffer)}this.generate=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array);return(await Thread.shared().distributeParticles({position:position,count:count},[position.buffer])).output},this.generateWithAll=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array),normal=new Float32Array(geom.attributes.normal.array),uv=new Float32Array(geom.attributes.uv.array);return await Thread.shared().distributeParticles({position:position,normal:normal,uv:uv,count:count},[position.buffer,normal.buffer,uv.buffer])},this.generateSkinned=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array),normal=new Float32Array(geom.attributes.normal.array),uv=new Float32Array(geom.attributes.uv.array),skinIndex=new Float32Array(geom.attributes.skinIndex.array),skinWeight=new Float32Array(geom.attributes.skinWeight.array);return await Thread.shared().distributeParticles({position:position,normal:normal,uv:uv,skinIndex:skinIndex,skinWeight:skinWeight,count:count},[position.buffer,normal.buffer,uv.buffer,skinIndex.buffer,skinWeight.buffer])}}),"static"),Class((function Performance(){Inherit(this,Component);var _overrides=Storage.get("performance_override")||{};function save(key,value){_overrides[key]=value,Storage.set("performance_override",_overrides)}function convert(tier){if(GPU.BLACKLIST)return"F";switch(tier){case 5:return"A++";case 4:return"A+";case 3:return"A";case 2:return"B";case 1:return"C";case 0:return"D"}}!async function(){if(Utils.query("performance")&&Utils.query("edit")||Utils.query("custom")){await Hydra.ready();for(let key in _overrides)Tests[key]=_=>_overrides[key]}}(),this.displayResults=async function(){let editing=Utils.query("edit");await GPU.ready(),__body.bg("#000");let $results=__body.create("PerformanceResults");__body.css({overflowY:"scroll"}),$results.fontStyle("Arial",18,"#fff").css({marginLeft:50,marginRight:50,"user-select":"auto"}),Mobile.allowNativeScroll(),CSS.style(".PerformanceResults *",{position:"relative","user-select":"auto"});Tests.constructor.toString();let tests="";for(let key in Tests){let result=Tests[key]();tests+=`<p><b>${key}:</b> `,editing?("number"==typeof result&&(tests+=`<input class="${key}" value="${result.toString()}" /></p>`),"boolean"==typeof result&&(tests+=`<input class="${key}" type="checkbox" ${result?"checked":""}/></p>`)):tests+=result+"</p>"}let html=`<h1>Performance Results</h1>\n                    <p><b>GPU:</b> ${Device.graphics.webgl?Device.graphics.webgl.gpu:"WEBGL UNAVAILABLE"}</p>\n                    <p><b>WebGL Version:</b> ${Device.graphics.webgl?Device.graphics.webgl.version:"WEBGL UNAVAILABLE"}</p>\n                    <p><b>GPU Tier:</b> ${Device.mobile?convert(GPU.M_TIER):convert(GPU.TIER)} [${Device.mobile?GPU.M_TIER:GPU.TIER}]</p>\n                    <p><b>Mobile:</b> ${Device.mobile}</p>\n                    <p><b>User Agent:</b> ${Device.agent}</p>\n                    <p><b>DPR:</b> ${Device.pixelRatio}</p>\n                    <p><b>Screen Size:</b> ${screen.width} x ${screen.height}</p>\n                    <p><b>Stage Size:</b> ${Stage.width} x ${Stage.height}</p>\n                    \n                    <h2>Project-Specific Tests</h2>\n                    ${editing?'<button class="resetBtn">Reset All</button>':""}\n                    ${tests}\n        `;if($results.html(html),editing){await defer(),document.querySelector(".resetBtn").onclick=_=>{Storage.set("performance_override",null),location.reload()};for(let key in Tests){!function(div,key){div.onchange=_=>{let value=div.value;value=isNaN(value)?div.checked:Number(value),save(key,value)}}(document.querySelector("."+key),key)}}}}),"static"),Class((function Proton(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_size,_antimatter;const prefix=this.prefix="P_"+_input.prefix;async function initConfig(){(_config=_this.uilConfig=InputUIL.create(prefix+"_config",_group)).setLabel("Config"),_config.addButton("load-values",{actions:[{title:"Save Values",callback:saveValues}],hideLabel:!0}),_config.addButton("save-values",{actions:[{title:"Load Values",callback:loadValues}],hideLabel:!0}),_config.addButton("save",{actions:[{title:"Save Configuration",callback:saveConfig}],hideLabel:!0}),_config.addButton("load",{actions:[{title:"Load Configuration",callback:loadConfig}],hideLabel:!0}),_config.addButton("load-shader",{actions:[{title:"Load Shader",callback:_=>loadShader()}],hideLabel:!0}),_config.addButton("load-behavior",{actions:[{title:"Load Behavior",callback:_=>loadBehavior()}],hideLabel:!0});_config.addSelect("type",[{label:"Permanent",value:"permanent"},{label:"Lifecycle",value:"lifecycle"}]),_config.add("particleCount",1e3);let output=[{label:"Particles",value:"particles"},{label:"Custom",value:"custom"}];window.ProtonTubes&&output.push({label:"Tubes",value:"tubes"}),_config.addSelect("output",output),_config.add("shader"),_config.get("shader")&&_config.addTextarea("uniforms"),_config.add("class");_config.get("type");try{if(!1===_input.get("visible"))throw"Layer set to invisible";_this.particleCount=_size=getSize(),initAntimatter()}catch(e){console.warn("Proton skipped",e),_this.disabled=!0}}function saveConfig(){let name=prompt("Name of configuration to be saved");UILStorage.setWrite("proton_config_"+name,prefix)}function saveValues(){let name=prompt("Name of values to be saved"),store=(shader,to)=>{for(let key in shader.uniforms){if(shader.uniforms[key].ignoreUIL)continue;let uilValue=UILStorage.get(shader.UILPrefix+key);void 0!==uilValue&&(to[key]=uilValue)}},output={behavior:{},shader:{}};store(_this.behavior,output.behavior),store(_this.shader,output.shader),_this.customClass&&_this.customClass.saveValues&&(output.custom={},store(_this.customClass.saveValues(),output.custom)),UILStorage.setWrite("proton_values_"+name,JSON.stringify(output))}function loadValues(){let name=prompt("Name of values to be loaded"),data=UILStorage.get("proton_values_"+name);data||alert(`No values ${name} found`),data=JSON.parse(data);let apply=(shader,obj)=>{for(let key in obj)UILStorage.set(shader.UILPrefix+key,obj[key])};apply(_this.behavior,data.behavior),apply(_this.shader,data.shader),_this.customClass&&_this.customClass.saveValues&&apply(_this.customClass.saveValues(),data.custom),alert("Values imported. Save and refresh.")}function loadShader(toLoad){let shouldNotify=!toLoad;if(!toLoad){let name=prompt("Name of shader to be loaded");toLoad=UILStorage.get("proton_config_"+name)}let copyConfig=InputUIL.create(toLoad+"_config",null);_config.copyFrom(copyConfig,["shader","uniforms"]),(_config.get("uniforms")||"").split("\n").forEach(line=>{if(!line.includes(":"))return;let name=(line=line.replace(/ /g,"")).split(":")[0],shaderName=copyConfig.get("shader"),store=`${shaderName}/${shaderName}/${prefix}/`,lookup=`${shaderName}/${shaderName}/${toLoad}/`,val=UILStorage.get(lookup+name);val?UILStorage.set(store+name,val):(val=UILStorage.get(lookup+"_tx_"+name),val&&UILStorage.set(store+"_tx_"+name,val))}),shouldNotify&&alert("Loaded. Save and refresh")}function loadBehavior(toLoad){let shouldNotify=!toLoad;if(!toLoad){let name=prompt("Name of behavior to be loaded");toLoad=UILStorage.get("proton_config_"+name)}let copyConfig=InputUIL.create(toLoad+"_config",null);_config.copyFrom(copyConfig,["type","particleCount","output","class"]);let copyBehavior=InputUIL.create(toLoad+"_behavior",null);InputUIL.create(prefix+"_behavior",null).copyFrom(copyBehavior,["uniforms","data","codeCount"]);let data=copyBehavior.get("data")||[],buniformString=copyBehavior.get("uniforms")+"\n";ListUIL.create(prefix+"_code",null).internalAddItems(data.length),data.forEach(postfix=>{let toCode=InputUIL.create(prefix+postfix,null),fromCode=InputUIL.create(toLoad+postfix,null);toCode.copyFrom(fromCode,["name","code","uniforms","preset"]),buniformString+=fromCode.get("uniforms")+"\n"}),buniformString.split("\n").forEach(line=>{if(!line.includes(":"))return;let name=(line=line.replace(/ /g,"")).split(":")[0],lookup="am_ProtonAntimatter_"+toLoad,store="am_ProtonAntimatter_"+prefix,val=UILStorage.get(lookup+name);val&&UILStorage.set(store+name,val)});let className=copyConfig.get("class");className&&(_this.customClass=_this.parent.initClass(window[className],_this,_group,_input),_this.customClass.loadConfig&&_this.customClass.loadConfig(toLoad,prefix)),shouldNotify&&alert("Loaded. Save and refresh")}function loadConfig(){let name=prompt("Name of configuration to be loaded"),toLoad=UILStorage.get("proton_config_"+name);loadBehavior(toLoad),loadShader(toLoad),alert("Loaded. Save and refresh")}function getSize(){if(_this.parent.data&&_this.parent.data.particleCount)return _this.parent.data.particleCount;let size=_config.getNumber("particleCount");if(isNaN(size))try{size=eval(_config.get("particleCount"))}catch(e){throw"Proton particleCount is not a number or valid test function"}if(isNaN(size))throw"Proton particleCount is falsy!";return _this.particleCount=size,size}async function initCustomClass(){_this.shader.addUniforms({DPR:{value:World.DPR,ignoreUIL:!0}});let className=_config.get("class");className&&(_this.customClass=_this.parent.initClass(window[className],_this,_group,_input))}function parseUniforms(text,predefined){if(!text)return{};let split=text.split("\n"),output={};return split.forEach(line=>{if(!(line=line.replace(/ /g,"")).length||!line.includes(":"))return;let split=line.split(":"),name=split[0],val=split[1];if(val.includes("[")){let array=JSON.parse(val);switch(array.length){case 2:output[name]={value:(new Vector2).fromArray(array)};break;case 3:output[name]={value:(new Vector3).fromArray(array)};break;case 4:output[name]={value:(new Vector4).fromArray(array)};break;default:throw"Unknown uniform type "+line}}else"C"==val.charAt(0)?predefined[name]=val.slice(1):"T"===val?output[name]={value:null}:"OEST"===val?output[name]={value:null,oes:!0}:val.includes(["0x","#"])?output[name]={value:new Color(val)}:output[name]={value:Number(val)}}),output}function getUniformGLSLType(obj){return"number"==typeof obj.value?"float":obj.oes?"samplerExternalOES":null===obj.value||obj.value instanceof Texture?"sampler2D":obj.value instanceof Vector2?"vec2":obj.value instanceof Vector3?"vec3":obj.value instanceof Vector4?"vec4":void 0}async function initBehavior(behavior){let glsl=[],predefinedUniforms={HZ:"float"},input=InputUIL.create(prefix+"_behavior",_group);input.setLabel("Behavior Uniforms"),input.addTextarea("uniforms"),input.add("data","hidden"),input.add("codeCount","hidden");let map={},list=[],count=input.getNumber("codeCount")||0,data=input.get("data")||[],panel=ListUIL.create(prefix+"_code",_group);panel.setLabel("Behavior Code"),panel.onAdd((name,input,index)=>{list[index]||addCode(),input.group.add(list[index].group),list[index].mapId=name,map[name]=list[index],input.setLabel(map[name].get("name")||"Code")}),panel.onRemove(name=>{let postfix=map[name].postfix;list.remove(map[name]),data.remove(postfix),input.setValue("data",JSON.stringify(data))}),panel.onSort(array=>{let arr=[];array.forEach(name=>{arr.push(map[name].postfix)}),data=arr,input.setValue("data",JSON.stringify(data))});let uniforms=parseUniforms(input.get("uniforms")),createCode=postfix=>{let input=InputUIL.create(prefix+postfix,_group,!0);if(input.prefix=prefix+postfix,input.postfix=postfix,input.setLabel("Editor"),input.add("name","hidden"),Proton.ignorePresets&&Proton.ignorePresets.includes(input.get("name")))return;ProtonPresets.bind(input),input.customPresetCallback&&input.customPresetCallback(_this);let code=input.get("code")||"";if(!input.disabled&&code.length){for(uniforms=Utils.mergeObject(uniforms,parseUniforms(input.get("uniforms"),predefinedUniforms));code.includes("#test ");)try{let test=code.split("#test ")[1],name=test.split("\n")[0],glsl=code.split("#test "+name+"\n")[1].split("#endtest")[0];eval(name)||(code=code.replace(glsl,"")),code=code.replace("#test "+name+"\n",""),code=code.replace("#endtest","")}catch(e){throw"Error parsing test :: "+e}glsl.push(code)}list.push(input)};data.forEach(createCode);let addCode=_=>{count++,data.push("code_"+count),input.setValue("data",JSON.stringify(data)),input.setValue("codeCount",count),createCode("code_"+count)};behavior instanceof AntimatterPass&&(behavior.addInput("tOrigin",_antimatter.vertices),behavior.addInput("tAttribs",_antimatter.attribs),behavior.addUniforms(uniforms));let filledRequire=[],insertUniform=(code,line)=>code.split("//uniforms").join(line+"\n//uniforms"),insertCode=(code,line)=>code.split("//code").join(line+"\n//code"),insertRequire=(code,line)=>{let name=line.split("require(")[1].split(")")[0];return filledRequire.includes(name)?code:(filledRequire.push(name),code.split("//require").join(Shaders.getShader(name)+"\n//require"))},insertGLSL=(code,line)=>{if(line.includes("#require")){let split=line.split("\n");for(let l of split)code=l.includes("#require")?insertRequire(code,l):insertCode(code,l);return code}return insertCode(code,line)};behavior.onCreateShader=code=>{for(let name in uniforms)code=insertUniform(code,`uniform ${getUniformGLSLType(uniforms[name])} ${name};`);for(let name in predefinedUniforms)code=insertUniform(code,`uniform ${predefinedUniforms[name]} ${name};`);for(let str of glsl)code=insertGLSL(code,str);return _this.tubes&&(code=_this.tubes.overrideShader(code)),Renderer.type==Renderer.WEBGL2&&(code=code.replace(/gl_FragColor/g,"FragColor")),code.includes("samplerExternalOES")&&window.AURA&&"android"==Device.system.os&&(code="#version 300 es\n#extension GL_OES_EGL_image_external_essl3 : require\n"+code.replace("#version 300 es","")),code},behavior.uniforms.uMaxCount={value:_this.particleCount,ignoreUIL:!0},ShaderUIL.add(behavior,_group).setLabel("Behavior Shader"),behavior.uniforms.HZ={value:1},_this.startRender(_=>{behavior.uniforms.HZ.value=Render.HZ_MULTIPLIER},10)}function completeShader(shader){let transparent=_input.get("transparent"),depthWrite=_input.get("depthWrite"),depthTest=_input.get("depthTest"),blending=_input.get("blending"),castShadow=_input.get("castShadow"),receiveShadow=_input.get("receiveShadow");"boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&(shader.depthTest=depthTest),"boolean"==typeof transparent&&(shader.transparent=transparent),"boolean"==typeof castShadow&&(_this.mesh.castShadow=castShadow),"boolean"==typeof receiveShadow&&(shader.receiveShadow=receiveShadow),blending&&(shader.blending=blending),shader.uniforms.tRandom={value:_antimatter.attribs}}function update(){_this.preventUpdate||_antimatter.update()}async function initAntimatter(){let lifecycle="lifecycle"==_config.get("type");_config.addVector("width",[-1,1]),_config.addVector("height",[-1,1]),_config.addVector("depth",[-1,1]);let dimensions={w:_config.get("width")||[-1,1],h:_config.get("height")||[-1,1],d:_config.get("depth")||[-1,1]};_antimatter=_this.initClass(Antimatter,_size,dimensions),Proton.forceCloneVertices.includes(_config.get("class"))&&(_antimatter.cloneVertices=!0),_this.antimatter=_antimatter,await _antimatter.ready();let output=_config.get("output");"tubes"==output&&(_this.tubes=_this.initClass(ProtonTubes,_this));let overrideShader,wildcard=_input.get("wildcard");if(wildcard&&wildcard.includes(".behavior")){let layer=await _this.parent.getLayer(wildcard.split(".")[0]);await _this.wait(layer,"behavior"),_this.behavior=layer.behavior}else{let behavior=_this.initClass(AntimatterPass,"ProtonAntimatter"+(lifecycle?"Lifecycle":""),{unique:prefix,customCompile:prefix});_this.behavior=behavior,initBehavior(behavior)}let shaderName=_config.get("shader");if(shaderName)if(shaderName.includes(".shader")){let layer=await _this.parent.getLayer(shaderName.split(".")[0]);await _this.wait(layer,"shader"),overrideShader=layer.shader}else{let uniforms=parseUniforms(_config.get("uniforms"));uniforms.unique=prefix+(_this.onGenerateUniqueShader?_this.onGenerateUniqueShader():""),_antimatter.useShader(shaderName,uniforms)}_antimatter.addPass(_this.behavior),_this.mesh=_antimatter.getMesh(),_this.onCreateMesh&&_this.onCreateMesh(_this.mesh),output&&"particles"!=output||_this.delayedCall(_=>{_this.add(_antimatter.mesh)},480),Utils.query("uilOnly")||_this.startRender(update),shaderName&&!shaderName.includes(".shader")&&(ShaderUIL.add(_antimatter.shader,_group).setLabel("Shader"),completeShader(_antimatter.shader)),overrideShader&&_antimatter.overrideShader(overrideShader),_this.shader=_antimatter.shader,_this.initialized=!0,lifecycle&&(_this.spawn=_this.initClass(AntimatterSpawn,_this,_group,_input)),initCustomClass()}this.uilInput=_input,this.uilGroup=_group,this.prefix=prefix,initConfig(),this.parseUniforms=parseUniforms,this.ready=function(){return this.wait(this,"initialized")},this.applyToInstancedGeometry=function(geometry){geometry.addAttribute("lookup",new GeometryAttribute(_antimatter.getLookupArray(),3,1)),geometry.addAttribute("random",new GeometryAttribute(_antimatter.getRandomArray(),4,1))},this.applyToShader=function(shader){shader.addUniforms({tPos:_antimatter.getOutput(),tPrevPos:_antimatter.getPrevOutput()})},this.upload=async function(){if(!_this.disabled){_this.group.visible=!1,await this.ready(),await _antimatter.upload(),_this.spawn&&await _this.spawn.upload();for(let key in _this.classes)_this.classes[key]instanceof MouseFlowMap&&await _this.classes[key].upload();_this.group.visible=!0}},this.uploadSync=async function(){_this.disabled||(await this.ready(),await _antimatter.uploadSync())},this.stopUpdating=function(){_this.stopRender(update)},this.set("renderOrder",async v=>{await _this.ready(),await _antimatter.ready(),_antimatter.mesh.renderOrder=v}),this.get("renderOrder",v=>_antimatter.mesh.renderOrder)}),_=>{Proton.forceCloneVertices=[],Proton.ignore=function(name){Proton.ignorePresets||(Proton.ignorePresets=[]),Proton.ignorePresets.push(name)}}),Class((function ProtonPresets(){const _this=this,LIST=[{label:"Custom Code",value:"custom"},{label:"Curl Noise",value:"curl"},{label:"Mouse Flowmap",value:"flowmap"},{label:"Plane Shape",value:"planeshape"},{label:"3D Shape",value:"3dshape"},{label:"Force",value:"force"},{label:"Follow",value:"follow"}],CALLBACKS={custom:customCode,curl:curlNoise,flowmap:flowmap,planeshape:planeShape,"3dshape":shape3D,force:force,follow:follow};function customCode(input){input.setValue("name","Custom Code"),input.setLabel("Custom Code")}function curlNoise(input){input.setValue("name","Curl Noise"),input.setLabel("Curl Noise");input.setValue("uniforms","\n        uCurlNoiseScale: 1\n        uCurlTimeScale: 0\n        uCurlNoiseSpeed: 0\n        "),input.get("code")&&input.get("code").includes("uCurlNoise")||input.setValue("code","#require(curl.glsl)\n        \nvec3 curl = curlNoise(pos * uCurlNoiseScale*0.1 + (time * uCurlTimeScale * 0.1));\npos += curl * uCurlNoiseSpeed * 0.01;")}function flowmap(input){input.setValue("name","Mouse Flowmap"),input.setLabel("Mouse Flowmap");let code="#require(glscreenprojection.glsl)\n#require(flowmap.fs)\n\nvec3 mpos = vec3(uModelMatrix * vec4(pos, 1.0));\nvec2 screenUV = getProjection(mpos, uProjMatrix);\nvec3 flow = vec3(getFlow(tFlowmap, screenUV), 0.0);\napplyNormal(flow, uProjNormalMatrix);\nfloat hit = 0.0;\nfloat fvelX = crange(flow.x, -1.0, 1.0, 0.0, 1.0);\nfloat fvelY = crange(flow.y, -1.0, 1.0, 0.0, 1.0);\nif (fvelX > 0.505 || fvelX < 0.495) hit = 1.0;\nif (fvelY > 0.505 || fvelY < 0.495) hit = 1.0;\npos += flow * uMouseStrength * hit;",uniforms="\n        uProjMatrix: Cmat4\n        uProjNormalMatrix: Cmat4\n        uModelMatrix: Cmat4\n        tFlowmap: Csampler2D\n        uMouseStrength: 1\n        ";input.setValue("uniforms",uniforms),input.get("code")&&input.get("code").includes("getFlow")||input.setValue("code",code),input.add("useExisting"),input.add("size",512),input.add("radius",.15),input.add("falloff",1),input.add("speed",0),input.add("decay",.93),input.addToggle("multitouch"),input.addToggle("hideMouse");let findCamera=proton=>{let camera=World.CAMERA,p=proton.group._parent;for(;p;)p instanceof Scene&&p.nuke&&(camera=p.nuke.camera),p=p._parent;return camera};input.customPresetCallback=async proton=>{let useExistingFlowmap=input.get("useExisting"),flowmap,projection;if(useExistingFlowmap)if(useExistingFlowmap.includes("."))flowmap=eval(useExistingFlowmap),projection=flowmap.projection;else{let layer=await proton.parent.getLayer(useExistingFlowmap);await proton.wait(layer,"flowmap"),flowmap=proton.flowmap=layer.flowmap,projection=flowmap.projection}else{flowmap=proton.initClass(MouseFlowMap,{size:input.getNumber("size"),radius:input.getNumber("radius"),falloff:input.getNumber("falloff"),speed:input.getNumber("speed"),decay:input.getNumber("decay"),multitouch:input.get("multitouch")||!1,hideMouse:input.get("hideMouse")||!1}),proton.flowmap=flowmap;let camera=findCamera(proton);projection=proton.initClass(GLScreenProjection,camera),projection.start(),flowmap.projection=projection}proton.behavior?proton.behavior.addUniforms({uProjMatrix:projection.uniforms.projMatrix,uModelMatrix:projection.uniforms.modelMatrix,uProjNormalMatrix:projection.uniforms.normalMatrix,tFlowmap:flowmap.textureUniform}):proton.wait("behavior").then(_=>{proton.behavior.addUniforms({uProjMatrix:projection.uniforms.projMatrix,uModelMatrix:projection.uniforms.modelMatrix,uProjNormalMatrix:projection.uniforms.normalMatrix,tFlowmap:flowmap.textureUniform})})}}function planeShape(input){input.setValue("name","Plane Shape"),input.setLabel("Plane Shape");input.setValue("uniforms","\n        uTakePlaneShape: 1\n        uPlaneScale: 1\n        tPlaneTexture: Csampler2D\n        "),input.get("code")&&input.get("code").includes("uPlaneScale")||input.setValue("code","vec2 planeLookup = texture2D(tPlaneTexture, uv).xy;\nvec3 plane;\nplane.x = uPlaneScale * 0.5 * range(planeLookup.x, 0.0, 1.0, -1.0, 1.0);\nplane.y = uPlaneScale * 0.5 * -range(planeLookup.y, 0.0, 1.0, -1.0, 1.0);\nif (uTakePlaneShape > 0.5) pos = plane;"),input.customPresetCallback=proton=>{proton.behavior.addUniforms({tPlaneTexture:{value:null}})}}function shape3D(input){input.setValue("name","3D Shape"),input.setLabel("3D Shape"),input.add("geometry");let geometry=input.get("geometry");input.setValue("uniforms","\n        tShape3D: Csampler2D\n        uTake3DShape: 1\n        u3DShapeScale: 1\n        "),input.get("code")&&input.get("code").includes("shape3d")||input.setValue("code","vec3 shape3d = texture2D(tShape3D, uv).xyz * u3DShapeScale;\nif (uTake3DShape > 0.5) pos = shape3d;"),input.customPresetCallback=proton=>{let create=async g=>{let geom=await GeomThread.loadGeometry(g),distribution=await ParticleDistributor.generate(geom,proton.antimatter.particleCount),attribute=new AntimatterAttribute(distribution,3);proton.behavior.addInput("tShape3D",attribute)};geometry&&create(geometry),proton.set3DShape=create}}function force(input){input.setValue("name","Force"),input.setLabel("Force");input.setValue("uniforms","\n        uForceDir: [0, 1, 0]\n        uForceScale: 1\n        "),input.setValue("code","vec3 force = normalize(uForceDir) * uForceScale * 0.1;\npos += force;")}function follow(input){input.setValue("name","Follow"),input.setLabel("Follow");input.setValue("uniforms","\n        uFollowPos: [0, 0, 0]\n        uFollowRadius: 2\n        uFollowLerp: 0.7\n        "),input.get("code")&&input.get("code").includes("followPos")||input.setValue("code","float speed = range(random.x, 0.0, 1.0, 0.5, 1.5);\nvec3 followPos = uFollowPos;\nfollowPos.x += range(random.y, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\nfollowPos.y += range(random.z, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\nfollowPos.z += range(random.w, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\npos += (followPos - pos) * (uFollowLerp*0.1*speed);")}this.register=function(name,callback){let key=name.replace(/ /g,"").toLowerCase();LIST.push({label:name,value:key}),CALLBACKS[key]=callback},this.bind=function(input){input.add("code","hidden");input.add("uniforms","hidden"),input.addSelect("preset",LIST);let callback=CALLBACKS[input.get("preset")];callback&&callback(input),input.addButton("btn",{actions:[{title:"Edit Code",callback:_=>{let editor=new UILExternalEditor(input.get("name")||"Code",300);editor.setCode(input.get("code"),"c"),editor.onSave=value=>input.setValue("code",value),UIL.add(editor)}}],hideLabel:!0})}}),"static"),Class((function RenderManager(){Inherit(this,Component);const _this=this;var _dpr=null;function resizeHandler(){_this.renderer&&_this.renderer.setSize(Stage.width,Stage.height)}function getDPR(){return window.AURA?Device.pixelRatio:GPU.OVERSIZED?1:GPU.lt(0)?Math.min(1.3,Device.pixelRatio):GPU.lt(1)?Math.min(1.8,Device.pixelRatio):GPU.mobileLT(2)?Math.min(2,Device.pixelRatio):GPU.gt(4)?Math.min(1.5,Device.pixelRatio):Math.max(1.25,Device.pixelRatio)}function directRenderCallback(render){window.GLUI&&window.Metal&&GLUI.renderDirect(render)}this.NORMAL="normal",this.MAGIC_WINDOW="magic_window",this.VR=this.WEBVR="webvr",this.AR=this.WEBAR="webar",this.RENDER="RenderManager_render",this.POST_RENDER="RenderManager_post_render",this.EYE_RENDER="RenderManager_eye_render",this.READY="render_gl_ready",_this.events.sub(Events.RESIZE,resizeHandler),this.get("DPR",v=>getDPR()),this.initialize=function(type,params={}){if(_this.camera&&_this.camera.destroy(),_this.renderer&&_this.renderer.destroy(),type!=_this.WEBVR&&type!=_this.WEBAR||(params.xrCompatible=!0,params.alpha=!1),!_this.gl){let camera=new PerspectiveCamera(45,Stage.width/Stage.height,.01,200);_this.gl=function(){"safari"==Device.system.browser&&Device.system.browserVersion<13&&delete params.powerPreference,Utils.query("compat")&&(params.forceWebGL1=!0);let renderer=new(window.Metal?MetalRenderer:Renderer)(params);return renderer.setSize(Stage.width,Stage.height),renderer.setPixelRatio(getDPR()),renderer}(),_this.scene=new Scene,_this.nuke=_this.initClass(Nuke,Stage,Object.assign({renderer:_this.gl,scene:_this.scene,camera:camera,dpr:World.DPR},params))}switch(_dpr=_dpr||World.DPR||1,type){case _this.WEBVR:_this.renderer=_this.initClass(VRRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(VRCamera);break;case _this.WEBAR:_this.renderer=_this.initClass(window.Metal?MetalARRenderer:ARRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(ARCamera);break;case _this.MAGIC_WINDOW:_this.renderer=_this.initClass(MagicWindowRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(VRCamera);break;case _this.NORMAL:_this.renderer=_this.initClass(RenderManagerRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(RenderManagerCamera)}_this.type=type,_this.nuke.camera=_this.camera.worldCamera},this.render=function(scene,camera,renderTarget,forceClear){_this.renderer.render(scene||_this.scene,camera||_this.camera.worldCamera,renderTarget,forceClear,directRenderCallback),_this.events.fire(_this.POST_RENDER)},this.startRender=function(){Render.start(_this.render)},this.stopRender=function(){Render.stop(_this.render)},this.requestPresent=function(bool){_this.renderer.requestPresent&&_this.renderer.requestPresent(bool)},this.setSize=function(width,height){_this.events.unsub(Events.RESIZE,resizeHandler),_this.renderer.setSize(width,height)},this.set("onRenderEye",callback=>{_this.renderer.onRenderEye=callback})}),"static"),Class((function RenderManagerCamera(){Inherit(this,Component);const _this=this;this.worldCamera=window.THREE?new THREE.PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3):new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),_this.events.sub(Events.RESIZE,()=>{_this.worldCamera.aspect=Stage.width/Stage.height,_this.worldCamera.updateProjectionMatrix()})})),Class((function RenderManagerRenderer(_renderer,_nuke){Inherit(this,Component);const _this=this;var _evt={};_nuke.onBeforeProcess=_=>{_evt.stage=Stage,_evt.camera=_nuke.camera,_this.events.fire(RenderManager.RENDER,_evt)},this.render=function(scene,camera,_1,_2,directRender){_nuke.camera=camera,_nuke?_nuke.render(directRender):_renderer.render(scene,camera,null,null,directRender)},this.setSize=function(width,height){_renderer.setSize(width,height)}})),Class((function RTPool(_type,_size=3,_format){Inherit(this,Component);const _this=this;var _pool;this.nullRT=Utils3D.createRT(2,2);var _array=[];function createRT(){let rt=Utils3D.createRT(Stage.width*World.DPR,Stage.height*World.DPR,_type,_format);return rt.index=_pool.length(),rt}function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}function resizeHandler(){_array.forEach(rt=>{rt.setSize(Stage.width*World.DPR,Stage.height*World.DPR)})}!function initPool(){_pool=new ObjectPool;for(let i=0;i<_size;i++){let rt=createRT();_pool.put(rt),_array.push(rt)}}(),defer(addListeners),this.get("array",_=>_array),this.getRT=function(){return _pool.get()||createRT()},this.putRT=function(rt){rt.scissor&&delete rt.scissor,_pool.put(rt)},this.setSize=function(width,height){_this.events.unsub(Events.RESIZE,resizeHandler),_array.forEach(rt=>{rt.setSize(width,height)})},this.onDestroy=function(){let p=_pool.get();for(;p;)p.dispose(),p=_pool.get()},this.clone=function(type=_type,size=_size,format=_format){return new RTPool(type,size,format)},this.disableResize=function(){_this.events.unsub(Events.RESIZE,resizeHandler)}}),"singleton"),Class((function SceneLayout(_name,_options={}){Inherit(this,Object3D);const _this=this;var _dataStore,_data,_timeline,_breakpoint;const ZERO=new Vector3;var _initializers=[],_promises=[],_breakpoints=[],_folders={},_groups={},_custom={},_meshes={},_exists={},_layers={},_uil=UIL.sidebar,_graph,_config,_groupIndex=0,_groupsSynced=Promise.create();function initialize(promise){_promises.push(promise)}function createFolder(name){let folder=new UILFolder(`sl_${_name}_${name}`,{label:name,closed:!0});return folder.hide(),_folders[`sl_${_name}_${name}`]=folder,folder}async function initConfig(){let input=InputUIL.create("CONFIG_sl_"+_name,_uil);input.add("Animation"),input.add("Layout"),input.add("Cinema Config"),_graph&&_graph.addSpecial("Config",`Config (${_name})`,"Config"),input.setLabel("Config");let animation=input.get("Animation"),layout=input.get("Layout");animation&&(await ready(),_groupsSynced.then(async()=>{if(animation=animation.replace(/^\//g,""),_this.animation=_this.initClass(HierarchyAnimation,animation,linkObjects),_timeline)_this.startRender(_=>{_this.animation.elapsed=_timeline.elapsed,_this.animation.update()});else if(_uil){let range=new UILControlRange("Animation",{min:0,max:1,step:.001});range.onChange(val=>{_this.animation.elapsed=val,_this.animation.update()}),_uil.add(range)}await _this.animation.ready(),_this.animation.update()})),layout&&(await ready(),_this.layout=_this.initClass(HierarchyLayout,layout,linkObjects),await _this.layout.ready()),_config=input,await defer(),_this.configured=!0}async function linkObjects(data){let array=[];for(let i=0;i<data.length;i++){let name=data[i].name,exists=_this.exists(name);exists||"null"==name.toLowerCase()||console.warn(`linkAnimation :: ${name} does not exist`);let group=new Group,mesh=exists?await _this.getLayer(name):null;mesh&&(_this.layout&&mesh instanceof Mesh?(mesh._parent.add(group),group.add(mesh)):group=mesh.group||mesh),group.name=name,array.push(group)}return array}async function initGraph(){if(_options.noGraph||!window.UILGraph||SceneLayout.noGraph)return _uil=null;(_graph=UILGraph.instance().getGraph(_name,_this))&&(UIL.sidebar.element.show(),await _this.ready(),_graph.syncVisibility(_layers),_graph.syncGroupNames(_groups,_folders),_groupsSynced.resolve(),Global.PLAYGROUND&&Utils.getConstructorName(_this.parent)==Global.PLAYGROUND&&_graph.open())}function initParams(){if(_options.rootPath?"/"!=_options.rootPath.charAt(_options.rootPath.length-1)&&(_options.rootPath+="/"):_options.rootPath="",_this.timeline=_timeline=_options.timeline,_timeline&&(_timeline.add({v:0},{v:1},100,"linear"),_uil)){let range=new UILControlRange("Timeline",{min:0,max:1,step:.001});range.onChange(val=>{_timeline.elapsed=val,_timeline.update()}),_uil.add(range),range.hide(),_graph&&_graph.addSpecial("Timeline","Timeline")}_this.baseRenderOrder=_options.baseRenderOrder||0,_this.data=_options.data,_breakpoint=_options.breakpoint||SceneLayout.breakpoint,_options.breakpoint&&(_this.localBreakpoint=!0),_options.uil&&(_uil=_options.uil)}async function initData(){if(await UILStorage.ready(),_dataStore=InputUIL.create("scenelayout_"+_name,null),void 0===(_data=JSON.parse(_dataStore.get("data")||"{}")).layers&&(_data.layers=-1),_options.perFrame)_data.layers>0&&createLayers();else{for(let i=0,c=_data.layers+1;i<c;i++)initialize(createLayer(i));_this.loaded=!0}}function createLayers(){let index=0,renderWorker=new Render.Worker((function(){initialize(createLayer(index)),index++==_data.layers&&(renderWorker.stop(),_this.loaded=!0)}),_options.perFrame)}function getGroup(name){if(!name)return _this.group;if(name==_name)return _this.group;if(!_groups[name]){let uilGroup=_uil?createFolder(name):null;uilGroup&&(uilGroup.setLabel(name+" (Group)"),_uil.add(uilGroup),_graph&&_graph.addGroup(uilGroup.id,name));let config=InputUIL.create(`GROUP_${_name}_${name}`,uilGroup);config.setLabel("Parameters"),_timeline&&config.add("tween"),config.addToggle("billboard"),config.add("breakpoints"),config.add("name","hidden");let breakpoints=config.get("breakpoints");breakpoints&&(breakpoints=breakpoints.replace(/ /g,"").split(","));let breakpoint=breakpoints&&_breakpoint?"-"+_breakpoint:"";"-"==breakpoint.charAt(breakpoint.length-1)&&(breakpoint="");let group=new Group;_groups[name]=group,_layers[name]=group,_exists[name]="group",group.prefix=`${name}_${_name}${breakpoint}`,MeshUIL.add(group,uilGroup).setLabel("Mesh"),_this.add(group),uilGroup&&(uilGroup.params=config),breakpoints&&_breakpoints.push(group),config.get("billboard")&&_this.startRender(_=>Utils3D.billboard(group)),config.get("tween")&&applyTween(group,name,uilGroup)}return _groupIndex++,_groups[name]}async function applyTween(mesh,id,group,shader){let config=TweenUIL.create(`Element_${id}_${_name}`,group),a=config.add(tween(mesh.position,mesh.position.clone(),100,"linear",0,null,!0),"position"),b=config.add(tween(mesh.rotation,mesh.rotation.clone(),100,"linear",0,null,!0),"rotation"),c=config.add(tween(mesh.scale,mesh.scale.clone(),100,"linear",0,null,!0),"scale"),d=shader&&shader.uniforms.uAlpha?config.add(tween(shader.uniforms.uAlpha,{value:1},100,"linear",0,null,!0),"alpha"):null;await defer(),await defer(),config.setLabel("Tween"),mesh.position.equals(a.props)||0==a.props.x&&0==a.props.y&&0==a.props.z||_timeline.add(a),mesh.rotation.equals(b.props)||0==b.props.x&&0==b.props.y&&0==b.props.z||_timeline.add(b),mesh.scale.equals(c.props)||1==c.props.x&&1==c.props.y&&1==c.props.z||_timeline.add(c),d&&shader.uniforms.uAlpha.value!=d.props.uAlpha&&_timeline.add(d),mesh.tweens={position:a,rotation:b,scale:c,alpha:d}}async function createLayer(index,groupName){let id="number"==typeof index?index:++_data.layers,graphGroupName=groupName;if(graphGroupName){let nameLabel=UILStorage.get(`INPUT_GROUP_${_name}_${groupName}_name`);nameLabel&&(groupName=nameLabel)}if(UILStorage.get(`sl_${_name}_${id}_deleted`))return;if(_this.preventLayerCreation&&_this.preventLayerCreation(UILStorage.get(`INPUT_Config_${id}_${_name}_name`)))return;let group=_uil?createFolder(id):null,shader,mesh,input=InputUIL.create(`Config_${id}_${_name}`,group);input.setLabel("Parameters"),input.add("name","hidden").add("geometry").addToggle("visible",!0).addToggle("transparent").addToggle("depthWrite",!0).addToggle("depthTest",!0).addToggle("castShadow").addToggle("receiveShadow").addToggle("receiveLight").addToggle("billboard").add("shader").add("customClass").add("scriptClass").add("wildcard").add("renderOrder","hidden").add("group","hidden").add("breakpoints").addSelect("side",[{label:"Front Side",value:"shader_front_side"},{label:"Back Side",value:"shader_back_side"},{label:"Double Side",value:"shader_double_side"}]).addSelect("blending",[{label:"Normal",value:"shader_normal_blending"},{label:"Additive",value:"shader_additive_blending"}]),input.name=_name,input.prefix=`Element_${id}_${_name}`,input.id=id,group&&(group.params=input),_timeline&&input.addToggle("tween"),_options.physics&&(input.addToggle("physics"),input.add("physicsCode"));let name=input.get("name")||id,shaderName=input.get("shader")||"SceneLayout",geomPath=input.get("geometry"),visible=input.get("visible"),transparent=input.get("transparent"),depthWrite=input.get("depthWrite"),depthTest=input.get("depthTest"),billboard=input.get("billboard"),doTween=input.get("tween"),renderOrder=input.getNumber("renderOrder"),blending=input.get("blending"),side=input.get("side"),physics=input.get("physics"),castShadow=input.get("castShadow"),receiveShadow=input.get("receiveShadow"),receiveLight=input.get("receiveLight"),breakpoints=input.get("breakpoints");breakpoints&&(breakpoints=breakpoints.replace(/ /g,"").split(","));let breakpoint=breakpoints&&_breakpoint?"-"+_breakpoint:"";"-"==breakpoint.charAt(breakpoint.length-1)&&(breakpoint=""),name&&group&&group.setLabel(name),groupName&&input.setValue("group",groupName);let groupParent=getGroup(input.get("group"));if(group){let groupName=input.get("group"),groupId=groupName?`sl_${_name}_${graphGroupName||groupName}`:void 0;_graph&&_graph.addLayer(group.id,name||id+"",groupId)}if(_uil&&_uil.add(group),"ignore"==name)return;let customClass=input.get("customClass"),scriptClass=input.get("scriptClass");if(_exists[name]=customClass?"custom":"mesh",customClass){if(!window[customClass])return console.warn(`Tried to initialize ${customClass} but it doesn't  exist!`);let obj=_this.initClass(window[customClass],input,group,id,null);if(mesh=obj.group,"boolean"==typeof visible&&mesh&&(mesh.visible=visible),doTween&&obj.group&&applyTween(obj.group,id,group),_custom[name]=obj,_layers[name]=obj,_this.onCreateLayer){let capture=cb=>(_this.delayedCall(_=>cb(obj,name),32),!0);if(!0===_this.onCreateLayer(name,group,capture))return}return obj.group&&groupParent.add(obj.group),obj.renderOrder=_this.baseRenderOrder+renderOrder,void(mesh&&(mesh.prefix=`Element_${id}_${_name}${breakpoint}`,MeshUIL.add(mesh,group).setLabel("Mesh"),_breakpoints.push(mesh),scriptClass&&(scriptClass.includes(",")?(scriptClass=scriptClass.replace(/ /g,"").split(","),scriptClass.forEach(script=>{window[script]?(mesh.scriptClass=mesh.scriptClass||[],mesh.scriptClass.push(_this.initClass(window[script],mesh,shader,group,input))):console.warn(`scriptClass ${script} not found`)})):window[scriptClass]?mesh.scriptClass=_this.initClass(window[scriptClass],mesh,shader,group,input):console.warn(`scriptClass ${scriptClass} not found`))))}if(_this.onCreateLayer){let capture=cb=>{let mesh=new Group;return mesh.prefix=`Element_${id}_${_name}${breakpoint}`,MeshUIL.add(mesh,group),doTween&&applyTween(mesh,id,group,{uniforms:{uAlpha:{value:1}}}),_meshes[name]=mesh,_layers[name]=mesh,_this.delayedCall(_=>cb(mesh,name),32),!0};if(!0===_this.onCreateLayer(name,group,capture))return}let geom=World.PLANE;if(geomPath&&geomPath.includes(["World","SceneLayout"])&&(geom=eval(geomPath),geomPath=null),shaderName.includes(".shader")){let shaderLayer=shaderName.split(".shader")[0],layer=await _this.getLayer(shaderLayer);shader=layer.shader,shader._copied=layer}else if(shaderName.includes("PBR"))shader=_this.initClass(PBRShader,shaderName,{unique:`Element_${id}_${_name}`});else{let texturePath=input.getImage("texture");texturePath?texturePath.includes("assets/images")||(texturePath=_options.rootPath+texturePath):texturePath="assets/images/_scenelayout/uv.jpg",shader=_this.initClass(Shader,shaderName,{unique:`Element_${id}_${_name}`}),"SceneLayout"!=shaderName&&window[shaderName]||shader.addUniforms({tMap:{value:Utils3D.getTexture(texturePath)},uAlpha:{value:1}}),defer(_=>{for(let key in shader.uniforms){let uniform=shader.uniforms[key];uniform.value instanceof Texture&&initialize(uniform.value.promise)}})}if("boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&(shader.depthTest=depthTest),"boolean"==typeof transparent&&(shader.transparent=transparent),_this.onCreateGeometry&&(geomPath=_this.onCreateGeometry(geomPath,input.get("wildcard"))),geomPath&&(geom=await GeomThread.loadGeometry(geomPath)),mesh=new Mesh(geom,shader),"boolean"==typeof _options.frustumCulled&&(mesh.frustumCulled=_options.frustumCulled),"boolean"==typeof visible&&(mesh.visible=visible),groupParent.add(mesh),mesh.prefix=`Element_${id}_${_name}${breakpoint}`,MeshUIL.add(mesh,group).setLabel("Mesh"),physics){let obj=Physics.instance().create(mesh);obj.prefix=`Physics_${id}_${_name}`,PhysicsUIL.add(obj,group).setLabel("Physics");let code=input.get("physicsCode");code&&_this.initClass(window[code],obj,mesh,group,input)}_meshes[name]=mesh,_layers[name]=mesh,breakpoints&&_breakpoints.push(mesh),mesh.renderOrder=_this.baseRenderOrder+(renderOrder||0),billboard&&_this.startRender(_=>Utils3D.billboard(mesh)),doTween&&applyTween(mesh,id,group,shader),"SceneLayout"!=shaderName&&window[shaderName]&&(mesh.shaderClass=_this.initClass(window[shaderName],mesh,shader,group,input)),shader._copied||shader!==mesh.shader&&!shaderName.includes("PBR")||ShaderUIL.add(shader,group).setLabel("Shader"),shader._copied&&shader._copied.shaderClass&&shader._copied.shaderClass.applyClone&&shader._copied.shaderClass.applyClone(mesh),"number"!=typeof index&&_dataStore.setValue("data",JSON.stringify(_data)),blending&&(shader.blending=blending),side&&(shader.side=side),castShadow&&(mesh.castShadow=castShadow),receiveShadow&&(shader.receiveShadow=receiveShadow),receiveLight&&(shader.receiveLight=receiveLight),scriptClass&&(scriptClass.includes(",")?(scriptClass=scriptClass.replace(/ /g,"").split(","),scriptClass.forEach(script=>{window[script]?(mesh.scriptClass=mesh.scriptClass||[],mesh.scriptClass.push(_this.initClass(window[script],mesh,shader,group,input))):console.warn(`scriptClass ${script} not found`)})):window[scriptClass]?mesh.scriptClass=_this.initClass(window[scriptClass],mesh,shader,group,input):console.warn(`scriptClass ${scriptClass} not found`)),input.onUpdate=key=>{switch(key){case"name":group.setLabel(input.get(key));break;case"visible":mesh.visible=input.get(key);break;case"renderOrder":mesh.renderOrder=_this.baseRenderOrder+input.getNumber(key);break;case"transparent":shader.transparent=input.get(key);break;case"depthWrite":shader.depthWrite=input.get(key);break;case"depthTest":shader.depthTest=input.get(key);break;case"side":shader.side=input.get(key);break;case"blending":shader.blending=input.get(key)}}}function addListeners(){_this.events.sub(SceneLayout.BREAKPOINT,e=>_this.localBreakpoint?null:setBreakpoint(e))}function setBreakpoint({value:value}){value!=_breakpoint&&(_breakpoint=value,_breakpoints.forEach(mesh=>{mesh.prefix=mesh.prefix.split("-")[0]+"-"+_breakpoint,"-"==mesh.prefix.charAt(mesh.prefix.length-1)&&(mesh.prefix=mesh.prefix.slice(0,-1)),new MeshUILConfig(mesh)}))}async function ready(){await _this.wait(_this,"loaded"),UIL.sidebar&&UIL.sidebar.toolbar.hideAll()}function copyFolderProps(from,to){let mesh,params,shader;to.forEachFolder(child=>{switch(child.label){case"Parameters":params=child;break;case"Mesh":mesh=child;break;case"Shader":shader=child}});let allowed=["Parameters","Mesh","Shader"];from.forEachFolder(child=>{if(!(allowed.indexOf(child.label)<0))switch(child.toClipboard(),child.label){case"Parameters":params.fromClipboard();break;case"Mesh":mesh.fromClipboard();break;case"Shader":shader.fromClipboard()}})}this.isSceneLayout=!0,this.name=_name,async function(){_this.group.sceneLayout=_this,await initialize(defer()),SceneLayout.getTexture||(SceneLayout.getTexture=Utils3D.getTexture),initGraph(),initParams(),initialize(initConfig()),initData(),addListeners(),ready()}(),this.ready=async function(early){if(await _this.wait(_this,"loaded"),await _this.wait(_this,"configured"),early)return!0;await defer(),await defer()},this.getLayer=async function(name){let timer;return Hydra.LOCAL&&(timer=_this.delayedCall(_=>{_exists[name]||console.warn(`${name} doesn't exist in SceneLayout ${_name}`)},1e3)),await _this.wait(_layers,name),timer&&clearTimeout(timer),_layers[name]},this.getLayers=async function(){let array=[];for(let i=0;i<arguments.length;i++)array.push(_this.getLayer(arguments[i]));return Promise.all(array)},this.getAllLayers=async function(){return await this.ready(),await this.loadedAllLayers(),_layers},this.getAllMatching=async function(label){let layers=await _this.getAllLayers(),array=[];for(let key in layers)key.includes(label)&&array.push(layers[key]);return array},this.exists=function(name){return _exists[name]},this._createLayer=function(parentId){createLayer(null,parentId)},this._createGroup=function(parentId){getGroup("group_"+_groupIndex,parentId)},this._rename=function(id,name,value){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];folder&&(folder.setLabel(value),folder.params&&folder.params.setValue("name",value),[_groups,_custom,_meshes,_exists,_layers].forEach((function(store){store[name]&&(store[value]=store[name],store[name]=null,delete store[name])})))},this._deleteLayer=function(id,name){id.includes("_")&&(id=(id=id.split("_"))[id.length-1]);let folder=_folders[id]||_folders[`sl_${_name}_${id}`],layer=_layers[id]||_layers[name];return layer&&layer.isGroup&&layer.length>1?(alert("Can't delete a group that has nested layers."),!1):!!confirm("Are you sure you want to delete this layer?")&&(layer&&layer._parent&&(layer._parent.remove(layer),layer._parent=null),folder&&folder.parent&&folder.parent.remove(folder),UILStorage.set(`sl_${_name}_${id}_deleted`,!0),!0)},this._changeParent=function(childId,childName,parentId,parentName){let child=_layers[childId]||_layers[childName],parent=_layers[parentId]||_layers[parentName]||_this;if(!child)return;let folder=_folders[childId]||_folders[`sl_${_name}_${childName}`];folder&&folder.params&&folder.params.setValue("group",parentName||null);let parentObject=parent.group||parent,childObject=child.group||child;parentObject.isObject3D&&childObject.isObject3D&&parentObject.add(childObject),child.updateMatrix&&child.updateMatrix()},this._visible=function(name,visible){let mesh=_layers[name];mesh&&(mesh.group&&(mesh=mesh.group),mesh.visible=visible)},this._focus=function(name){UIL.sidebar.toolbar.filterSingle(name)},this._blur=function(name){let folder=_folders[name]||_folders[`sl_${_name}_${name}`];folder&&folder.forEachFolder&&(folder.forEachFolder(f=>f.close()),folder.close())},this._sort=function(order){order.forEach((label,index)=>{label.children&&label.children.forEach((function(child,j,all){let folder=_folders[child];if(!folder||!folder.params)return;let renderOrder=_this.baseRenderOrder+index+(j+1)/(all.length+1);folder.params.setValue("renderOrder",renderOrder-_this.baseRenderOrder);let mesh=_layers[child]||_layers[folder.label];mesh&&(mesh.renderOrder=renderOrder)}));let folder=_folders[label];if(!folder||!folder.params)return;let renderOrder=_this.baseRenderOrder+index;folder.params.setValue("renderOrder",renderOrder-_this.baseRenderOrder);let mesh=_layers[label]||_layers[folder.label];mesh&&(mesh.renderOrder=renderOrder)})},this._duplicateLayer=function(id,parentId){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];folder&&(createLayer(null,parentId),copyFolderProps(folder,Object.values(_folders).last()))},this._duplicateGroup=function(id,children){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];if(!folder)return;let copyId="group_"+(_groupIndex+1);getGroup(copyId),copyFolderProps(folder,Object.values(_folders).last()),children.forEach(childId=>{_this._duplicateLayer(childId,copyId)})},this._getCinemaConfig=async function(){let _cinemaConfig=_config.get("Cinema Config").replace(".json","");return await get(Assets.getPath(`assets/geometry/${_cinemaConfig}.json`))},this._applyCinemaConfig=function(id,params){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];if(!folder)return;let mesh=folder.getAll().filter(sub=>"Mesh"==sub.label)[0];if(params.geometry&&folder.params.setValue("geometry",params.geometry.replace("assets/geometry/","")),["position","quaternion","scale"].forEach(transform=>{if(params[transform]){let value=JSON.parse(params[transform]);if("quaternion"==transform){let quat=(new Quaternion).fromArray(value);value=(new Euler).setFromQuaternion(quat).toArray().slice(0,3).map(angle=>180*angle/Math.PI),transform="rotation"}mesh.getAll().filter(control=>control.label==transform)[0].force(value)}}),params.visible&&"false"===params.visible&&!params.geometry&&(folder.params.setValue("geometry","World.PLANE"),folder.params.setValue("side","shader_double_side"),!Global.PLAYGROUND)){_meshes[folder.params.get("name")].shader.neverRender=!0}params.shader&&folder.params.setValue("shader",params.shader)},this.loadedAllLayers=async function(){return await _this.ready(),Promise.all(_promises)},this.set("breakpoint",value=>{_this.localBreakpoint=!0,setBreakpoint({value:value})}),this.get("breakpoint",_=>_breakpoint),this.get("layers",_=>_layers),this.get("layerCount",_=>_data.layers),this.onDestroy=function(){_this.textures&&!_options.persistTextures&&_this.textures.forEach(t=>{t.destroy&&t.destroy()})},this.addInitializer=function(callback){_initializers.push(callback)},this._completeInitialization=async function(sync){if(!_initializers.length)return!0;for(let i=0;i<_initializers.length;i++)await _initializers[i](sync);_initializers.length=0}}),_=>{SceneLayout.BREAKPOINT="sl_breakpoint",SceneLayout.setBreakpoint=function(value){SceneLayout.breakpoint!==value&&(SceneLayout.breakpoint=value,Events.emitter._fireEvent(SceneLayout.BREAKPOINT,{value:value}))}}),Class((function SceneLayoutPreloader(_name){Inherit(this,Component);function findMatch(src){for(let i=ASSETS.length-1;i>-1;i--)if(ASSETS[i].includes(src))return!0;return!1}this.load=function(name){let ext,promise=Promise.create(),array=[],settings_dxt=!!Renderer.extensions.s3tc,settings_etc=!!Renderer.extensions.etc1,settings_pvrtc=!!Renderer.extensions.pvrtc,settings_astc=!!Renderer.extensions.astc;settings_dxt?ext="dxt":settings_etc?ext="astc":settings_pvrtc?ext="pvrtc":settings_astc&&(ext="astc");let keys=UILStorage.getKeys(),i=0,worker=new Render.Worker(_=>{let key=keys[i];if(!key)return worker.stop(),void Promise.all(array).then(promise.resolve);if(key.includes(name)){let val=UILStorage.get(key);if(!val.includes)return i++;if(val.includes(".json"))key.includes("geometry")?findMatch(val.split("assets/")[1])&&array.push(GeomThread.loadGeometry(val,null,!0)):(val.includes("assets/")||(val="assets/geometry/"+val),findMatch(val.split("assets/")[1])&&array.push(fetch(Assets.getPath(val)).catch(e=>{})));else if(val.includes("src")){let obj=JSON.parse(val),src=obj.src;obj.compressed&&(src=src.split(".")[0]+"-"+ext+".kxt"),findMatch(src.split("assets/")[1])&&array.push(fetch(Assets.getPath(src)).catch(e=>{}))}}i++},1);return promise}}),"static"),Mobile.Class((function ScreenLock(){Inherit(this,Component);const _this=this;function update(){if(window.Fullscreen&&window.Fullscreen.isOpen)return;const width=Stage.width,height=Stage.height;if(width<height)Stage.div.style.transformOrigin="",Stage.div.style.transform="",Stage.size(width,height);else{const w=Math.max(width,height),h=Math.min(width,height);Stage.size(h,w),Stage.div.style.transformOrigin="0% 0%",-90==window.orientation||180==window.orientation?Stage.div.style.transform=`translateX(${w}px) rotate(90deg)`:Stage.div.style.transform=`translateY(${h}px) rotate(-90deg)`}}this.lock=function(){_this.isActive=!0,update(),Device.mobile&&function addHandlers(){_this.events.sub(Events.RESIZE,update)}()},this.unlock=function(){_this.isActive&&(_this.isActive=!1,_this.events.unsub(Events.RESIZE,update),Stage.div.style.transform="",Stage.div.style.transformOrigin="",Stage.size("100%"),window.innerWidth>window.innerHeight&&defer(window.onresize))}}),"static"),Class((function Scroll(_object,_params){Inherit(this,Component);const _this=this;this.x=0,this.y=0,this.max={x:0,y:0},this.delta={x:0,y:0},this.enabled=!0;const _scrollTarget={x:0,y:0},_scrollInertia={x:0,y:0};let _axes=["x","y"];var _lastDelta,_deltaChange=0;function loop(){_this.object&&(Math.round(_this.object.div.scrollLeft)===Math.round(_this.x)&&Math.round(_this.object.div.scrollTop)===Math.round(_this.y)||(_this.x=_scrollTarget.x=_this.object.div.scrollLeft,_this.y=_scrollTarget.y=_this.object.div.scrollTop,stopInertia())),_axes.forEach(axis=>{_this.isInertia&&(_scrollInertia[axis]*=.9,_scrollTarget[axis]+=_scrollInertia[axis]),_this.limit&&(_scrollTarget[axis]=Math.max(_scrollTarget[axis],0)),_this.limit&&(_scrollTarget[axis]=Math.min(_scrollTarget[axis],_this.max[axis]/_this.scale)),_this.delta[axis]=_this.flag("block")?0:.5*(_scrollTarget[axis]*_this.scale-_this[axis]),_this[axis]+=_this.delta[axis],Math.abs(_this.delta[axis])<.01&&(_this.delta[axis]=0),Math.abs(_this[axis])<.001&&(_this[axis]=0),_this.flag("block")&&(_scrollTarget[axis]=0,_this.delta[axis]=0,_this[axis]=0),_this.object&&("x"==axis&&(_this.object.div.scrollLeft=Math.round(_this.x)),"y"==axis&&(_this.object.div.scrollTop=Math.round(_this.y)))})}function stopInertia(){_this.isInertia=!1,clearTween(_scrollTarget)}function edgeScroll(e){_params.lockMouseX&&Mouse.x>Stage.width||"touch"===e.pointerType&&_this.enabled&&(e.preventDefault&&e.preventDefault(),_axes.forEach(axis=>{let dir=axis.toUpperCase(),delta="offset"+dir,diff=(_this["ieDelta"+dir]||e[delta])-e[delta];_scrollTarget[axis]+=diff,_scrollInertia[axis]=diff,_this.isInertia=!0,_this["ieDelta"+dir]=e[delta]}),_this.onUpdate&&_this.onUpdate(),_this.events.fire(Events.UPDATE,_scrollInertia))}function edgeScrollEnd(){_this.ieDeltaX=!1,_this.ieDeltaY=!1}function scroll(e){if(_params.lockMouseX&&Mouse.x>Stage.width)return;if(!_this.enabled)return;if(_this.object&&_this.limit&&e.preventDefault&&e.preventDefault(),!_this.mouseWheel)return;stopInertia();let newDelta=0;_axes.forEach(axis=>{let delta="delta"+axis.toUpperCase();if("mac"==Device.system.os){if("firefox"==Device.system.browser)return 1===e.deltaMode?(_scrollTarget[axis]+=4*e[delta],_scrollInertia[axis]=4*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])):void(_scrollTarget[axis]+=e[delta]);if(Device.system.browser.includes(["chrome","safari"]))return _scrollTarget[axis]+=.33*e[delta],_scrollInertia[axis]=.33*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}if("windows"==Device.system.os){if("firefox"==Device.system.browser&&1===e.deltaMode)return _scrollTarget[axis]+=10*e[delta],_scrollInertia[axis]=10*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis]);if(Device.system.browser.includes(["chrome"])){let s=.025;return _scrollTarget[axis]+=e[delta]*s,_scrollInertia[axis]=e[delta]*s,_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}if("ie"==Device.system.browser)return _scrollTarget[axis]+=e[delta],_scrollInertia[axis]=e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}_scrollTarget[axis]+=e[delta],newDelta=_scrollInertia[axis]}),newDelta=Math.abs(newDelta),newDelta!=_lastDelta&&_deltaChange++,_this.flag("hardBlock")||(_deltaChange>3?newDelta>_lastDelta&&_this.flag("block",!1):newDelta>=_lastDelta&&_this.flag("block",!1)),_lastDelta=newDelta,_this.onUpdate&&_this.onUpdate(),_this.events.fire(Events.UPDATE,_scrollInertia)}function down(){_this.enabled&&stopInertia()}function drag(){_this.enabled&&(_axes.forEach(axis=>{let newDelta=Math.abs(Mouse.delta[axis]);_this.flag("hardBlock")||newDelta>_lastDelta&&_this.flag("block",!1),_lastDelta=newDelta,_scrollTarget[axis]-=Mouse.delta[axis]}),_this.events.fire(Events.UPDATE))}function up(){if(!_this.enabled||_this.preventInertia)return;const m="android"==Device.system.os?35:25,obj={};_axes.forEach(axis=>{obj[axis]=_scrollTarget[axis]-Mouse.delta[axis]*m}),tween(_scrollTarget,obj,2500,"easeOutQuint")}function resize(){if(!_this.enabled)return;if(stopInertia(),!_this.object)return;const p={};Device.mobile&&_axes.forEach(axis=>p[axis]=_this.max[axis]?_scrollTarget[axis]/_this.max[axis]:0),void 0===_params.height&&(_this.max.y=_this.object.div.scrollHeight-_this.object.div.clientHeight),void 0===_params.width&&(_this.max.x=_this.object.div.scrollWidth-_this.object.div.clientWidth),Device.mobile&&_axes.forEach(axis=>_this[axis]=_scrollTarget[axis]=p[axis]*_this.max[axis])}!function initParams(){_object&&_object.div||(_params=_object,_object=null),_params||(_params={}),_this.object=_object,_this.hitObject=_params.hitObject||_this.object,_this.max.y=_params.height||0,_this.max.x=_params.width||0,_this.scale=_params.scale||1,_this.drag=void 0!==_params.drag?_params.drag:!!Device.mobile,_this.mouseWheel=!1!==_params.mouseWheel,_this.limit="boolean"==typeof _params.limit&&_params.limit,Array.isArray(_params.axes)&&(_axes=_params.axes)}(),_this.object&&function style(){_this.object.css({overflow:"auto"})}(),function addHandlers(){if(Device.mobile||("ie"===Device.system.browser&&Device.system.browserVersion>=17&&(document.body.addEventListener("pointermove",edgeScroll,!0),document.body.addEventListener("pointerup",edgeScrollEnd,!0)),"ie"==Device.system.browser?document.body.addEventListener("wheel",scroll,!0):__window.bind("wheel",scroll)),_this.drag){_this.hitObject&&_this.hitObject.bind("touchstart",e=>e.preventDefault());let input=_this.hitObject?_this.initClass(Interaction,_this.hitObject):Mouse.input;_this.events.sub(input,Interaction.START,down),_this.events.sub(input,Interaction.DRAG,drag),_this.events.sub(input,Interaction.END,up)}_this.events.sub(Events.RESIZE,resize)}(),resize(),_this.startRender(loop),this.reset=function(){return _this.object&&_this.object.div&&(_this.object.div.scrollLeft=_this.x=0,_this.object.div.scrollTop=_this.y=0),_scrollTarget.x=_scrollTarget.y=0,_scrollInertia.x=_scrollInertia.y=0,stopInertia(),this},this.onDestroy=function(){__window.unbind("wheel",scroll)},this.resize=resize,this.scrollTo=function(value,axis="y"){let values={};values[axis]=value,tween(_scrollTarget,values,800,"easeInOutCubic")},this.blockUntilNewScroll=function(){return _this.reset(),_this.flag("block",!0),_this.flag("hardBlock",!0,200),this},this.stopInertia=stopInertia}),_=>{var _scroll;Scroll.createUnlimited=Scroll.getUnlimited=function(options){return _scroll||(_scroll=new Scroll({limit:!1,drag:Device.mobile})),_scroll}}),Class((function SentryDebug(){!async function(){window.Sentry&&(await Hydra.ready(),await GPU.ready(),Sentry.configureScope((function(scope){if(scope.setExtra("gpu",""+(Device.graphics.webgl?Device.graphics.webgl.gpu:"WEBGL UNAVAILABLE")),scope.setExtra("gpu_tier",""+(Device.mobile?GPU.M_TIER:GPU.TIER)),scope.setExtra("webgl_version",""+(Device.graphics.webgl?Device.graphics.webgl.version:"WEBGL UNAVAILABLE")),scope.setExtra("mobile",""+JSON.stringify(Device.mobile).split(":").join(": ")),scope.setExtra("system",""+JSON.stringify(Device.system).split(":").join(": ")),scope.setExtra("user_agent",Device.agent),scope.setExtra("dpr",Device.pixelRatio),scope.setExtra("refresh_rate",Render.REFRESH_RATE),scope.setExtra("user_agent",Device.agent),scope.setExtra("screen_size",`${screen.width} x ${screen.height}`),scope.setExtra("stage_size",`${Stage.width} x ${Stage.height}`),Tests)for(let key in Tests)scope.setExtra("test_"+key,Tests[key]())})))}()}),"static"),Class((function Shaders(){Inherit(this,Component);var _this=this;function parseSingleShader(code,fileName){let uniforms=code.split("#!UNIFORMS")[1].split("#!")[0],varyings=code.split("#!VARYINGS")[1].split("#!")[0],attributes=code.split("#!ATTRIBUTES")[1].split("#!")[0];for(;code.includes("#!SHADER");){let split=(code=code.slice(code.indexOf("#!SHADER"))).split("#!SHADER")[1],br=split.indexOf("\n"),name=split.slice(0,br).split(": ")[1];name.slice(0,6).includes("Vertex")&&(name=fileName.split(".")[0]+".vs"),name.slice(0,8).includes("Fragment")&&(name=fileName.split(".")[0]+".fs");let glsl=split.slice(br);glsl=name.includes(".vs")?attributes+uniforms+varyings+glsl:uniforms+varyings+glsl;let splitName=name.split(".");_this[splitName[0]+(splitName[1].includes("vs")?".vs":".fs")]=glsl,code=code.replace("#!SHADER","$")}}function parseCompiled(shaders){var split=shaders.split("{@}");split.shift();for(var i=0;i<split.length;i+=2){var name=split[i],text=split[i+1];text.includes("#!UNIFORMS")?parseSingleShader(text,name):_this[name]=text}}function parseRequirements(){for(var key in _this){var obj=_this[key];"string"==typeof obj&&(_this[key]=require(obj))}}function require(shader){if(!shader.includes("require"))return shader;for(shader=shader.replace(/# require/g,"#require");shader.includes("#require");){var name=shader.split("#require(")[1].split(")")[0];if(name=name.replace(/ /g,""),!_this[name])throw"Shader required "+name+", but not found in compiled shaders.\n"+shader;shader=shader.replace("#require("+name+")",_this[name])}return shader}this.parse=function(code,file){code.includes("{@}")?(parseCompiled(code),parseRequirements()):(file=(file=file.split("/"))[file.length-1],_this[file]=code),_this.shadersParsed=!0},this.onReady=this.ready=function(callback){let promise=Promise.create();return callback&&promise.then(callback),_this.wait(()=>promise.resolve(),_this,"shadersParsed"),promise},this.getShader=function(string){_this.FALLBACKS&&_this.FALLBACKS[string]&&(string=_this.FALLBACKS[string]);var code=_this[string];if(!code)throw`No shader ${string} found`;for(;code.includes("#test ");)try{var test=code.split("#test ")[1],name=test.split("\n")[0],glsl=code.split("#test "+name+"\n")[1].split("#endtest")[0];eval(name)||(code=code.replace(glsl,"")),code=code.replace("#test "+name+"\n",""),code=code.replace("#endtest","")}catch(e){throw"Error parsing test :: "+string}return code}}),"static"),Class((function Share(){function url(u){return u||`${location.protocol}//${location.host}${location.pathname}`}this.native=function(text,u,title){if(window.navigator.share)return window.navigator.share({url:url(u),text:text,title:title||document.title})},this.facebook=function(u){open(`https://www.facebook.com/sharer?u=${url(u)}/share`,"_blank","height=555,width=577,scrollbars=yes")},this.twitter=function(text,u){open(`https://twitter.com/share?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url(u)+"/share")}`,"_blank","height=555,width=577,scrollbars=yes")},this.email=function(subject,body,u){window.location.href=`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body+url(u)+"/share")}`},this.download=function(image){return Device.mobile||"ie"===Device.system.browser?open(image):function download(image){var link=document.createElement("a");link.setAttribute("href",image),link.setAttribute("target","_blank"),link.setAttribute("download","download.png"),link.style.display="none","firefox"===Device.system.browser?(document.body.appendChild(link),link.click(),document.body.removeChild(link)):link.click()}(image)}}),"static"),Class((function Spine(_input,_group){Inherit(this,Object3D);const _this=this;var _mesh,_shader,_data,_animation;async function initMesh(){(_mesh=new spine.hydra.SkeletonMesh(_data,_shader)).update(0),_this.group.add(_mesh),_this.flag("isReady",!0),_this.animate(_animation),_this.startRender(loop)}function loop(time,delta){let rate=_this.flag("playbackRate")*_this.flag("speedMult")*Render.HZ_MULTIPLIER;_mesh.update(.001*delta*rate)}!async function(){!function initShader(){_shader=_this.initClass(Shader,"Spine",{map:{value:Utils3D.getTexture("assets/images/_scenelayout/uv.jpg")}})}(),await async function initLib(){await AssetLoader.waitForLib("spine")}(),function initAnimation(){_input.add("animation"),_this.flag("speedMult",1),_this.flag("playbackRate",1);let animation=_input.get("animation");animation&&async function loadAssets(animation,shader){let name=animation.split("/").last(),assetManager=new spine.hydra.AssetManager(Assets.getPath("assets/animations/")),dataFile=`${animation}/${name}.json`,atlasFile=`${animation}/${name}.atlas`;assetManager.loadText(dataFile),assetManager.loadTextureAtlas(atlasFile),await async function load(assetManager){let loaded=Promise.create(),loading=_=>{assetManager.isLoadingComplete()&&loaded.resolve()};_this.startRender(loading),await loaded,_this.stopRender(loading)}(assetManager);let atlas=assetManager.get(atlasFile),atlasLoader=new spine.AtlasAttachmentLoader(atlas),skeletonData=new spine.SkeletonJson(atlasLoader).readSkeletonData(assetManager.get(dataFile));_data=skeletonData,function initSelectAnimation(data){let options=[];for(let item of data)options.push({value:item.name});_input.addSelect("currentAnimation",options);_animation=_input.get("currentAnimation")}(skeletonData.animations),initMesh()}(animation)}()}(),this.ready=_=>_this.wait("isReady"),this.get("mesh",_=>_mesh),this.get("shader",_=>_mesh.shaderObj),this.get("playbackRate",_=>_this.flag("playbackRate")),this.set("playbackRate",v=>_this.flag("playbackRate",v)),this.uil={input:_input,group:_group},this.animate=async function(name,mix=.25,loop=!0,time=0){await _this.ready(),_mesh.state.data.defaultMix=mix,_mesh.state.setAnimation(time,name,loop),_animation=name},this.useShader=async function(shader){await _this.ready(),_this.stopRender(loop),_mesh.remove(),_mesh.dispose(),_mesh=_mesh.destroy(),shader.uniforms.map||shader.addUniforms({map:{value:Utils3D.getTexture("assets/images/_scenelayout/uv.jpg"),flipY:!1}}),_shader=shader,initMesh()}})),function(spine){class Animation{constructor(name,timelines,duration){if(null==name)throw new Error("name cannot be null.");if(null==timelines)throw new Error("timelines cannot be null.");this.name=name,this.timelines=timelines,this.timelineIds=[];for(var i=0;i<timelines.length;i++)this.timelineIds[timelines[i].getPropertyId()]=!0;this.duration=duration}hasTimeline(id){return 1==this.timelineIds[id]}apply(skeleton,lastTime,time,loop,events,alpha,blend,direction){if(null==skeleton)throw new Error("skeleton cannot be null.");loop&&0!=this.duration&&(time%=this.duration,lastTime>0&&(lastTime%=this.duration));let timelines=this.timelines;for(let i=0,n=timelines.length;i<n;i++)timelines[i].apply(skeleton,lastTime,time,events,alpha,blend,direction)}static binarySearch(values,target,step=1){let low=0,high=values.length/step-2;if(0==high)return step;let current=high>>>1;for(;;){if(values[(current+1)*step]<=target?low=current+1:high=current,low==high)return(low+1)*step;current=low+high>>>1}}static linearSearch(values,target,step){for(let i=0,last=values.length-step;i<=last;i+=step)if(values[i]>target)return i;return-1}}let MixBlend,MixDirection,TimelineType;spine.Animation=Animation,function(MixBlend){MixBlend[MixBlend.setup=0]="setup",MixBlend[MixBlend.first=1]="first",MixBlend[MixBlend.replace=2]="replace",MixBlend[MixBlend.add=3]="add"}(MixBlend=spine.MixBlend||(spine.MixBlend={})),function(MixDirection){MixDirection[MixDirection.mixIn=0]="mixIn",MixDirection[MixDirection.mixOut=1]="mixOut"}(MixDirection=spine.MixDirection||(spine.MixDirection={})),function(TimelineType){TimelineType[TimelineType.rotate=0]="rotate",TimelineType[TimelineType.translate=1]="translate",TimelineType[TimelineType.scale=2]="scale",TimelineType[TimelineType.shear=3]="shear",TimelineType[TimelineType.attachment=4]="attachment",TimelineType[TimelineType.color=5]="color",TimelineType[TimelineType.deform=6]="deform",TimelineType[TimelineType.event=7]="event",TimelineType[TimelineType.drawOrder=8]="drawOrder",TimelineType[TimelineType.ikConstraint=9]="ikConstraint",TimelineType[TimelineType.transformConstraint=10]="transformConstraint",TimelineType[TimelineType.pathConstraintPosition=11]="pathConstraintPosition",TimelineType[TimelineType.pathConstraintSpacing=12]="pathConstraintSpacing",TimelineType[TimelineType.pathConstraintMix=13]="pathConstraintMix",TimelineType[TimelineType.twoColor=14]="twoColor"}(TimelineType=spine.TimelineType||(spine.TimelineType={}));let CurveTimeline=(()=>{class CurveTimeline{constructor(frameCount){if(frameCount<=0)throw new Error("frameCount must be > 0: "+frameCount);this.curves=spine.Utils.newFloatArray((frameCount-1)*CurveTimeline.BEZIER_SIZE)}getFrameCount(){return this.curves.length/CurveTimeline.BEZIER_SIZE+1}setLinear(frameIndex){this.curves[frameIndex*CurveTimeline.BEZIER_SIZE]=CurveTimeline.LINEAR}setStepped(frameIndex){this.curves[frameIndex*CurveTimeline.BEZIER_SIZE]=CurveTimeline.STEPPED}getCurveType(frameIndex){let index=frameIndex*CurveTimeline.BEZIER_SIZE;if(index==this.curves.length)return CurveTimeline.LINEAR;let type=this.curves[index];return type==CurveTimeline.LINEAR?CurveTimeline.LINEAR:type==CurveTimeline.STEPPED?CurveTimeline.STEPPED:CurveTimeline.BEZIER}setCurve(frameIndex,cx1,cy1,cx2,cy2){let tmpx=.03*(2*-cx1+cx2),tmpy=.03*(2*-cy1+cy2),dddfx=.006*(3*(cx1-cx2)+1),dddfy=.006*(3*(cy1-cy2)+1),ddfx=2*tmpx+dddfx,ddfy=2*tmpy+dddfy,dfx=.3*cx1+tmpx+.16666667*dddfx,dfy=.3*cy1+tmpy+.16666667*dddfy,i=frameIndex*CurveTimeline.BEZIER_SIZE,curves=this.curves;curves[i++]=CurveTimeline.BEZIER;let x=dfx,y=dfy;for(let n=i+CurveTimeline.BEZIER_SIZE-1;i<n;i+=2)curves[i]=x,curves[i+1]=y,dfx+=ddfx,dfy+=ddfy,ddfx+=dddfx,ddfy+=dddfy,x+=dfx,y+=dfy}getCurvePercent(frameIndex,percent){percent=spine.MathUtils.clamp(percent,0,1);let curves=this.curves,i=frameIndex*CurveTimeline.BEZIER_SIZE,type=curves[i];if(type==CurveTimeline.LINEAR)return percent;if(type==CurveTimeline.STEPPED)return 0;i++;let x=0;for(let start=i,n=i+CurveTimeline.BEZIER_SIZE-1;i<n;i+=2)if(x=curves[i],x>=percent){let prevX,prevY;return i==start?(prevX=0,prevY=0):(prevX=curves[i-2],prevY=curves[i-1]),prevY+(curves[i+1]-prevY)*(percent-prevX)/(x-prevX)}let y=curves[i-1];return y+(1-y)*(percent-x)/(1-x)}}return CurveTimeline.LINEAR=0,CurveTimeline.STEPPED=1,CurveTimeline.BEZIER=2,CurveTimeline.BEZIER_SIZE=19,CurveTimeline})();spine.CurveTimeline=CurveTimeline;let RotateTimeline=(()=>{class RotateTimeline extends CurveTimeline{constructor(frameCount){super(frameCount),this.frames=spine.Utils.newFloatArray(frameCount<<1)}getPropertyId(){return(TimelineType.rotate<<24)+this.boneIndex}setFrame(frameIndex,time,degrees){frameIndex<<=1,this.frames[frameIndex]=time,this.frames[frameIndex+RotateTimeline.ROTATION]=degrees}apply(skeleton,lastTime,time,events,alpha,blend,direction){let frames=this.frames,bone=skeleton.bones[this.boneIndex];if(!bone.active)return;if(time<frames[0]){switch(blend){case MixBlend.setup:return void(bone.rotation=bone.data.rotation);case MixBlend.first:let r=bone.data.rotation-bone.rotation;bone.rotation+=(r-360*(16384-(16384.499999999996-r/360|0)))*alpha}return}if(time>=frames[frames.length-RotateTimeline.ENTRIES]){let r=frames[frames.length+RotateTimeline.PREV_ROTATION];switch(blend){case MixBlend.setup:bone.rotation=bone.data.rotation+r*alpha;break;case MixBlend.first:case MixBlend.replace:r+=bone.data.rotation-bone.rotation,r-=360*(16384-(16384.499999999996-r/360|0));case MixBlend.add:bone.rotation+=r*alpha}return}let frame=Animation.binarySearch(frames,time,RotateTimeline.ENTRIES),prevRotation=frames[frame+RotateTimeline.PREV_ROTATION],frameTime=frames[frame],percent=this.getCurvePercent((frame>>1)-1,1-(time-frameTime)/(frames[frame+RotateTimeline.PREV_TIME]-frameTime)),r=frames[frame+RotateTimeline.ROTATION]-prevRotation;switch(r=prevRotation+(r-360*(16384-(16384.499999999996-r/360|0)))*percent,blend){case MixBlend.setup:bone.rotation=bone.data.rotation+(r-360*(16384-(16384.499999999996-r/360|0)))*alpha;break;case MixBlend.first:case MixBlend.replace:r+=bone.data.rotation-bone.rotation;case MixBlend.add:bone.rotation+=(r-360*(16384-(16384.499999999996-r/360|0)))*alpha}}}return RotateTimeline.ENTRIES=2,RotateTimeline.PREV_TIME=-2,RotateTimeline.PREV_ROTATION=-1,RotateTimeline.ROTATION=1,RotateTimeline})();spine.RotateTimeline=RotateTimeline;let TranslateTimeline=(()=>{class TranslateTimeline extends CurveTimeline{constructor(frameCount){super(frameCount),this.frames=spine.Utils.newFloatArray(frameCount*TranslateTimeline.ENTRIES)}getPropertyId(){return(TimelineType.translate<<24)+this.boneIndex}setFrame(frameIndex,time,x,y){frameIndex*=TranslateTimeline.ENTRIES,this.frames[frameIndex]=time,this.frames[frameIndex+TranslateTimeline.X]=x,this.frames[frameIndex+TranslateTimeline.Y]=y}apply(skeleton,lastTime,time,events,alpha,blend,direction){let frames=this.frames,bone=skeleton.bones[this.boneIndex];if(!bone.active)return;if(time<frames[0]){switch(blend){case MixBlend.setup:return bone.x=bone.data.x,void(bone.y=bone.data.y);case MixBlend.first:bone.x+=(bone.data.x-bone.x)*alpha,bone.y+=(bone.data.y-bone.y)*alpha}return}let x=0,y=0;if(time>=frames[frames.length-TranslateTimeline.ENTRIES])x=frames[frames.length+TranslateTimeline.PREV_X],y=frames[frames.length+TranslateTimeline.PREV_Y];else{let frame=Animation.binarySearch(frames,time,TranslateTimeline.ENTRIES);x=frames[frame+TranslateTimeline.PREV_X],y=frames[frame+TranslateTimeline.PREV_Y];let frameTime=frames[frame],percent=this.getCurvePercent(frame/TranslateTimeline.ENTRIES-1,1-(time-frameTime)/(frames[frame+TranslateTimeline.PREV_TIME]-frameTime));x+=(frames[frame+TranslateTimeline.X]-x)*percent,y+=(frames[frame+TranslateTimeline.Y]-y)*percent}switch(blend){case MixBlend.setup:bone.x=bone.data.x+x*alpha,bone.y=bone.data.y+y*alpha;break;case MixBlend.first:case MixBlend.replace:bone.x+=(bone.data.x+x-bone.x)*alpha,bone.y+=(bone.data.y+y-bone.y)*alpha;break;case MixBlend.add:bone.x+=x*alpha,bone.y+=y*alpha}}}return TranslateTimeline.ENTRIES=3,TranslateTimeline.PREV_TIME=-3,TranslateTimeline.PREV_X=-2,TranslateTimeline.PREV_Y=-1,TranslateTimeline.X=1,TranslateTimeline.Y=2,TranslateTimeline})();spine.TranslateTimeline=TranslateTimeline;class ScaleTimeline extends TranslateTimeline{constructor(frameCount){super(frameCount)}getPropertyId(){return(TimelineType.scale<<24)+this.boneIndex}apply(skeleton,lastTime,time,events,alpha,blend,direction){let frames=this.frames,bone=skeleton.bones[this.boneIndex];if(!bone.active)return;if(time<frames[0]){switch(blend){case MixBlend.setup:return bone.scaleX=bone.data.scaleX,void(bone.scaleY=bone.data.scaleY);case MixBlend.first:bone.scaleX+=(bone.data.scaleX-bone.scaleX)*alpha,bone.scaleY+=(bone.data.scaleY-bone.scaleY)*alpha}return}let x=0,y=0;if(time>=frames[frames.length-ScaleTimeline.ENTRIES])x=frames[frames.length+ScaleTimeline.PREV_X]*bone.data.scaleX,y=frames[frames.length+ScaleTimeline.PREV_Y]*bone.data.scaleY;else{let frame=Animation.binarySearch(frames,time,ScaleTimeline.ENTRIES);x=frames[frame+ScaleTimeline.PREV_X],y=frames[frame+ScaleTimeline.PREV_Y];let frameTime=frames[frame],percent=this.getCurvePercent(frame/ScaleTimeline.ENTRIES-1,1-(time-frameTime)/(frames[frame+ScaleTimeline.PREV_TIME]-frameTime));x=(x+(frames[frame+ScaleTimeline.X]-x)*percent)*bone.data.scaleX,y=(y+(frames[frame+ScaleTimeline.Y]-y)*percent)*bone.data.scaleY}if(1==alpha)blend==MixBlend.add?(bone.scaleX+=x-bone.data.scaleX,bone.scaleY+=y-bone.data.scaleY):(bone.scaleX=x,bone.scaleY=y);else{let bx=0,by=0;if(direction==MixDirection.mixOut)switch(blend){case MixBlend.setup:bx=bone.data.scaleX,by=bone.data.scaleY,bone.scaleX=bx+(Math.abs(x)*spine.MathUtils.signum(bx)-bx)*alpha,bone.scaleY=by+(Math.abs(y)*spine.MathUtils.signum(by)-by)*alpha;break;case MixBlend.first:case MixBlend.replace:bx=bone.scaleX,by=bone.scaleY,bone.scaleX=bx+(Math.abs(x)*spine.MathUtils.signum(bx)-bx)*alpha,bone.scaleY=by+(Math.abs(y)*spine.MathUtils.signum(by)-by)*alpha;break;case MixBlend.add:bx=bone.scaleX,by=bone.scaleY,bone.scaleX=bx+(Math.abs(x)*spine.MathUtils.signum(bx)-bone.data.scaleX)*alpha,bone.scaleY=by+(Math.abs(y)*spine.MathUtils.signum(by)-bone.data.scaleY)*alpha}else switch(blend){case MixBlend.setup:bx=Math.abs(bone.data.scaleX)*spine.MathUtils.signum(x),by=Math.abs(bone.data.scaleY)*spine.MathUtils.signum(y),bone.scaleX=bx+(x-bx)*alpha,bone.scaleY=by+(y-by)*alpha;break;case MixBlend.first:case MixBlend.replace:bx=Math.abs(bone.scaleX)*spine.MathUtils.signum(x),by=Math.abs(bone.scaleY)*spine.MathUtils.signum(y),bone.scaleX=bx+(x-bx)*alpha,bone.scaleY=by+(y-by)*alpha;break;case MixBlend.add:bx=spine.MathUtils.signum(x),by=spine.MathUtils.signum(y),bone.scaleX=Math.abs(bone.scaleX)*bx+(x-Math.abs(bone.data.scaleX)*bx)*alpha,bone.scaleY=Math.abs(bone.scaleY)*by+(y-Math.abs(bone.data.scaleY)*by)*alpha}}}}spine.ScaleTimeline=ScaleTimeline;class ShearTimeline extends TranslateTimeline{constructor(frameCount){super(frameCount)}getPropertyId(){return(TimelineType.shear<<24)+this.boneIndex}apply(skeleton,lastTime,time,events,alpha,blend,direction){let frames=this.frames,bone=skeleton.bones[this.boneIndex];if(!bone.active)return;if(time<frames[0]){switch(blend){case MixBlend.setup:return bone.shearX=bone.data.shearX,void(bone.shearY=bone.data.shearY);case MixBlend.first:bone.shearX+=(bone.data.shearX-bone.shearX)*alpha,bone.shearY+=(bone.data.shearY-bone.shearY)*alpha}return}let x=0,y=0;if(time>=frames[frames.length-ShearTimeline.ENTRIES])x=frames[frames.length+ShearTimeline.PREV_X],y=frames[frames.length+ShearTimeline.PREV_Y];else{let frame=Animation.binarySearch(frames,time,ShearTimeline.ENTRIES);x=frames[frame+ShearTimeline.PREV_X],y=frames[frame+ShearTimeline.PREV_Y];let frameTime=frames[frame],percent=this.getCurvePercent(frame/ShearTimeline.ENTRIES-1,1-(time-frameTime)/(frames[frame+ShearTimeline.PREV_TIME]-frameTime));x+=(frames[frame+ShearTimeline.X]-x)*percent,y+=(frames[frame+ShearTimeline.Y]-y)*percent}switch(blend){case MixBlend.setup:bone.shearX=bone.data.shearX+x*alpha,bone.shearY=bone.data.shearY+y*alpha;break;case MixBlend.first:case MixBlend.replace:bone.shearX+=(bone.data.shearX+x-bone.shearX)*alpha,bone.shearY+=(bone.data.shearY+y-bone.shearY)*alpha;break;case MixBlend.add:bone.shearX+=x*alpha,bone.shearY+=y*alpha}}}spine.ShearTimeline=ShearTimeline;let ColorTimeline=(()=>{class ColorTimeline extends CurveTimeline{constructor(frameCount){super(frameCount),this.frames=spine.Utils.newFloatArray(frameCount*ColorTimeline.ENTRIES)}getPropertyId(){return(TimelineType.color<<24)+this.slotIndex}setFrame(frameIndex,time,r,g,b,a){frameIndex*=ColorTimeline.ENTRIES,this.frames[frameIndex]=time,this.frames[frameIndex+ColorTimeline.R]=r,this.frames[frameIndex+ColorTimeline.G]=g,this.frames[frameIndex+ColorTimeline.B]=b,this.frames[frameIndex+ColorTimeline.A]=a}apply(skeleton,lastTime,time,events,alpha,blend,direction){let slot=skeleton.slots[this.slotIndex];if(!slot.bone.active)return;let frames=this.frames;if(time<frames[0]){switch(blend){case MixBlend.setup:return void slot.color.setFromColor(slot.data.color);case MixBlend.first:let color=slot.color,setup=slot.data.color;color.add((setup.r-color.r)*alpha,(setup.g-color.g)*alpha,(setup.b-color.b)*alpha,(setup.a-color.a)*alpha)}return}let r=0,g=0,b=0,a=0;if(time>=frames[frames.length-ColorTimeline.ENTRIES]){let i=frames.length;r=frames[i+ColorTimeline.PREV_R],g=frames[i+ColorTimeline.PREV_G],b=frames[i+ColorTimeline.PREV_B],a=frames[i+ColorTimeline.PREV_A]}else{let frame=Animation.binarySearch(frames,time,ColorTimeline.ENTRIES);r=frames[frame+ColorTimeline.PREV_R],g=frames[frame+ColorTimeline.PREV_G],b=frames[frame+ColorTimeline.PREV_B],a=frames[frame+ColorTimeline.PREV_A];let frameTime=frames[frame],percent=this.getCurvePercent(frame/ColorTimeline.ENTRIES-1,1-(time-frameTime)/(frames[frame+ColorTimeline.PREV_TIME]-frameTime));r+=(frames[frame+ColorTimeline.R]-r)*percent,g+=(frames[frame+ColorTimeline.G]-g)*percent,b+=(frames[frame+ColorTimeline.B]-b)*percent,a+=(frames[frame+ColorTimeline.A]-a)*percent}if(1==alpha)slot.color.set(r,g,b,a);else{let color=slot.color;blend==MixBlend.setup&&color.setFromColor(slot.data.color),color.add((r-color.r)*alpha,(g-color.g)*alpha,(b-color.b)*alpha,(a-color.a)*alpha)}}}return ColorTimeline.ENTRIES=5,ColorTimeline.PREV_TIME=-5,ColorTimeline.PREV_R=-4,ColorTimeline.PREV_G=-3,ColorTimeline.PREV_B=-2,ColorTimeline.PREV_A=-1,ColorTimeline.R=1,ColorTimeline.G=2,ColorTimeline.B=3,ColorTimeline.A=4,ColorTimeline})();spine.ColorTimeline=ColorTimeline;let TwoColorTimeline=(()=>{class TwoColorTimeline extends CurveTimeline{constructor(frameCount){super(frameCount),this.frames=spine.Utils.newFloatArray(frameCount*TwoColorTimeline.ENTRIES)}getPropertyId(){return(TimelineType.twoColor<<24)+this.slotIndex}setFrame(frameIndex,time,r,g,b,a,r2,g2,b2){frameIndex*=TwoColorTimeline.ENTRIES,this.frames[frameIndex]=time,this.frames[frameIndex+TwoColorTimeline.R]=r,this.frames[frameIndex+TwoColorTimeline.G]=g,this.frames[frameIndex+TwoColorTimeline.B]=b,this.frames[frameIndex+TwoColorTimeline.A]=a,this.frames[frameIndex+TwoColorTimeline.R2]=r2,this.frames[frameIndex+TwoColorTimeline.G2]=g2,this.frames[frameIndex+TwoColorTimeline.B2]=b2}apply(skeleton,lastTime,time,events,alpha,blend,direction){let slot=skeleton.slots[this.slotIndex];if(!slot.bone.active)return;let frames=this.frames;if(time<frames[0]){switch(blend){case MixBlend.setup:return slot.color.setFromColor(slot.data.color),void slot.darkColor.setFromColor(slot.data.darkColor);case MixBlend.first:let light=slot.color,dark=slot.darkColor,setupLight=slot.data.color,setupDark=slot.data.darkColor;light.add((setupLight.r-light.r)*alpha,(setupLight.g-light.g)*alpha,(setupLight.b-light.b)*alpha,(setupLight.a-light.a)*alpha),dark.add((setupDark.r-dark.r)*alpha,(setupDark.g-dark.g)*alpha,(setupDark.b-dark.b)*alpha,0)}return}let r=0,g=0,b=0,a=0,r2=0,g2=0,b2=0;if(time>=frames[frames.length-TwoColorTimeline.ENTRIES]){let i=frames.length;r=frames[i+TwoColorTimeline.PREV_R],g=frames[i+TwoColorTimeline.PREV_G],b=frames[i+TwoColorTimeline.PREV_B],a=frames[i+TwoColorTimeline.PREV_A],r2=frames[i+TwoColorTimeline.PREV_R2],g2=frames[i+TwoColorTimeline.PREV_G2],b2=frames[i+TwoColorTimeline.PREV_B2]}else{let frame=Animation.binarySearch(frames,time,TwoColorTimeline.ENTRIES);r=frames[frame+TwoColorTimeline.PREV_R],g=frames[frame+TwoColorTimeline.PREV_G],b=frames[frame+TwoColorTimeline.PREV_B],a=frames[frame+TwoColorTimeline.PREV_A],r2=frames[frame+TwoColorTimeline.PREV_R2],g2=frames[frame+TwoColorTimeline.PREV_G2],b2=frames[frame+TwoColorTimeline.PREV_B2];let frameTime=frames[frame],percent=this.getCurvePercent(frame/TwoColorTimeline.ENTRIES-1,1-(time-frameTime)/(frames[frame+TwoColorTimeline.PREV_TIME]-frameTime));r+=(frames[frame+TwoColorTimeline.R]-r)*percent,g+=(frames[frame+TwoColorTimeline.G]-g)*percent,b+=(frames[frame+TwoColorTimeline.B]-b)*percent,a+=(frames[frame+TwoColorTimeline.A]-a)*percent,r2+=(frames[frame+TwoColorTimeline.R2]-r2)*percent,g2+=(frames[frame+TwoColorTimeline.G2]-g2)*percent,b2+=(frames[frame+TwoColorTimeline.B2]-b2)*percent}if(1==alpha)slot.color.set(r,g,b,a),slot.darkColor.set(r2,g2,b2,1);else{let light=slot.color,dark=slot.darkColor;blend==MixBlend.setup&&(light.setFromColor(slot.data.color),dark.setFromColor(slot.data.darkColor)),light.add((r-light.r)*alpha,(g-light.g)*alpha,(b-light.b)*alpha,(a-light.a)*alpha),dark.add((r2-dark.r)*alpha,(g2-dark.g)*alpha,(b2-dark.b)*alpha,0)}}}return TwoColorTimeline.ENTRIES=8,TwoColorTimeline.PREV_TIME=-8,TwoColorTimeline.PREV_R=-7,TwoColorTimeline.PREV_G=-6,TwoColorTimeline.PREV_B=-5,TwoColorTimeline.PREV_A=-4,TwoColorTimeline.PREV_R2=-3,TwoColorTimeline.PREV_G2=-2,TwoColorTimeline.PREV_B2=-1,TwoColorTimeline.R=1,TwoColorTimeline.G=2,TwoColorTimeline.B=3,TwoColorTimeline.A=4,TwoColorTimeline.R2=5,TwoColorTimeline.G2=6,TwoColorTimeline.B2=7,TwoColorTimeline})();spine.TwoColorTimeline=TwoColorTimeline;spine.AttachmentTimeline=class AttachmentTimeline{constructor(frameCount){this.frames=spine.Utils.newFloatArray(frameCount),this.attachmentNames=new Array(frameCount)}getPropertyId(){return(TimelineType.attachment<<24)+this.slotIndex}getFrameCount(){return this.frames.length}setFrame(frameIndex,time,attachmentName){this.frames[frameIndex]=time,this.attachmentNames[frameIndex]=attachmentName}apply(skeleton,lastTime,time,events,alpha,blend,direction){let slot=skeleton.slots[this.slotIndex];if(!slot.bone.active)return;if(direction==MixDirection.mixOut)return void(blend==MixBlend.setup&&this.setAttachment(skeleton,slot,slot.data.attachmentName));let frames=this.frames;if(time<frames[0])return void(blend!=MixBlend.setup&&blend!=MixBlend.first||this.setAttachment(skeleton,slot,slot.data.attachmentName));let frameIndex=0;frameIndex=time>=frames[frames.length-1]?frames.length-1:Animation.binarySearch(frames,time,1)-1;let attachmentName=this.attachmentNames[frameIndex];skeleton.slots[this.slotIndex].setAttachment(null==attachmentName?null:skeleton.getAttachment(this.slotIndex,attachmentName))}setAttachment(skeleton,slot,attachmentName){slot.attachment=null==attachmentName?null:skeleton.getAttachment(this.slotIndex,attachmentName)}};let zeros=null;spine.DeformTimeline=class DeformTimeline extends CurveTimeline{constructor(frameCount){super(frameCount),this.frames=spine.Utils.newFloatArray(frameCount),this.frameVertices=new Array(frameCount),null==zeros&&(zeros=spine.Utils.newFloatArray(64))}getPropertyId(){return(TimelineType.deform<<27)+ +this.attachment.id+this.slotIndex}setFrame(frameIndex,time,vertices){this.frames[frameIndex]=time,this.frameVertices[frameIndex]=vertices}apply(skeleton,lastTime,time,firedEvents,alpha,blend,direction){let slot=skeleton.slots[this.slotIndex];if(!slot.bone.active)return;let slotAttachment=slot.getAttachment();if(!(slotAttachment instanceof spine.VertexAttachment)||slotAttachment.deformAttachment!=this.attachment)return;let deformArray=slot.deform;0==deformArray.length&&(blend=MixBlend.setup);let frameVertices=this.frameVertices,vertexCount=frameVertices[0].length,frames=this.frames;if(time<frames[0]){let vertexAttachment=slotAttachment;switch(blend){case MixBlend.setup:return void(deformArray.length=0);case MixBlend.first:if(1==alpha){deformArray.length=0;break}let deform=spine.Utils.setArraySize(deformArray,vertexCount);if(null==vertexAttachment.bones){let setupVertices=vertexAttachment.vertices;for(var i=0;i<vertexCount;i++)deform[i]+=(setupVertices[i]-deform[i])*alpha}else{alpha=1-alpha;for(i=0;i<vertexCount;i++)deform[i]*=alpha}}return}let deform=spine.Utils.setArraySize(deformArray,vertexCount);if(time>=frames[frames.length-1]){let lastVertices=frameVertices[frames.length-1];if(1==alpha)if(blend==MixBlend.add){let vertexAttachment=slotAttachment;if(null==vertexAttachment.bones){let setupVertices=vertexAttachment.vertices;for(let i=0;i<vertexCount;i++)deform[i]+=lastVertices[i]-setupVertices[i]}else for(let i=0;i<vertexCount;i++)deform[i]+=lastVertices[i]}else spine.Utils.arrayCopy(lastVertices,0,deform,0,vertexCount);else switch(blend){case MixBlend.setup:{let vertexAttachment=slotAttachment;if(null==vertexAttachment.bones){let setupVertices=vertexAttachment.vertices;for(let i=0;i<vertexCount;i++){let setup=setupVertices[i];deform[i]=setup+(lastVertices[i]-setup)*alpha}}else for(let i=0;i<vertexCount;i++)deform[i]=lastVertices[i]*alpha;break}case MixBlend.first:case MixBlend.replace:for(let i=0;i<vertexCount;i++)deform[i]+=(lastVertices[i]-deform[i])*alpha;break;case MixBlend.add:let vertexAttachment=slotAttachment;if(null==vertexAttachment.bones){let setupVertices=vertexAttachment.vertices;for(let i=0;i<vertexCount;i++)deform[i]+=(lastVertices[i]-setupVertices[i])*alpha}else for(let i=0;i<vertexCount;i++)deform[i]+=lastVertices[i]*alpha}return}let frame=Animation.binarySearch(frames,time),prevVertices=frameVertices[frame-1],nextVertices=frameVertices[frame],frameTime=frames[frame],percent=this.getCurvePercent(frame-1,1-(time-frameTime)/(frames[frame-1]-frameTime));if(1==alpha)if(blend==MixBlend.add){let vertexAttachment=slotAttachment;if(null==vertexAttachment.bones){let setupVertices=vertexAttachment.vertices;for(let i=0;i<vertexCount;i++){let prev=prevVertices[i];deform[i]+=prev+(nextVertices[i]-prev)*percent-setupVertices[i]}}else for(let i=0;i<vertexCount;i++){let prev=prevVertices[i];deform[i]+=prev+(nextVertices[i]-prev)*percent}}else for(let i=0;i<vertexCount;i++){let prev=prevVertices[i];deform[i]=prev+(nextVertices[i]-prev)*percent}else switch(blend){case MixBlend.setup:{let vertexAttachment=slotAttachment;if(null==vertexAttachment.bones){let setupVertices=vertexAttachment.vertices;for(let i=0;i<vertexCount;i++){let prev=prevVertices[i],setup=setupVertices[i];deform[i]=setup+(prev+(nextVertices[i]-prev)*percent-setup)*alpha}}else for(let i=0;i<vertexCount;i++){let prev=prevVertices[i];deform[i]=(prev+(nextVertices[i]-prev)*percent)*alpha}break}case MixBlend.first:case MixBlend.replace:for(let i=0;i<vertexCount;i++){let prev=prevVertices[i];deform[i]+=(prev+(nextVertices[i]-prev)*percent-deform[i])*alpha}break;case MixBlend.add:let vertexAttachment=slotAttachment;if(null==vertexAttachment.bones){let setupVertices=vertexAttachment.vertices;for(let i=0;i<vertexCount;i++){let prev=prevVertices[i];deform[i]+=(prev+(nextVertices[i]-prev)*percent-setupVertices[i])*alpha}}else for(let i=0;i<vertexCount;i++){let prev=prevVertices[i];deform[i]+=(prev+(nextVertices[i]-prev)*percent)*alpha}}}};spine.EventTimeline=class EventTimeline{constructor(frameCount){this.frames=spine.Utils.newFloatArray(frameCount),this.events=new Array(frameCount)}getPropertyId(){return TimelineType.event<<24}getFrameCount(){return this.frames.length}setFrame(frameIndex,event){this.frames[frameIndex]=event.time,this.events[frameIndex]=event}apply(skeleton,lastTime,time,firedEvents,alpha,blend,direction){if(null==firedEvents)return;let frames=this.frames,frameCount=this.frames.length;if(lastTime>time)this.apply(skeleton,lastTime,Number.MAX_VALUE,firedEvents,alpha,blend,direction),lastTime=-1;else if(lastTime>=frames[frameCount-1])return;if(time<frames[0])return;let frame=0;if(lastTime<frames[0])frame=0;else{frame=Animation.binarySearch(frames,lastTime);let frameTime=frames[frame];for(;frame>0&&frames[frame-1]==frameTime;)frame--}for(;frame<frameCount&&time>=frames[frame];frame++)firedEvents.push(this.events[frame])}};spine.DrawOrderTimeline=class DrawOrderTimeline{constructor(frameCount){this.frames=spine.Utils.newFloatArray(frameCount),this.drawOrders=new Array(frameCount)}getPropertyId(){return TimelineType.drawOrder<<24}getFrameCount(){return this.frames.length}setFrame(frameIndex,time,drawOrder){this.frames[frameIndex]=time,this.drawOrders[frameIndex]=drawOrder}apply(skeleton,lastTime,time,firedEvents,alpha,blend,direction){let drawOrder=skeleton.drawOrder,slots=skeleton.slots;if(direction==MixDirection.mixOut)return void(blend==MixBlend.setup&&spine.Utils.arrayCopy(skeleton.slots,0,skeleton.drawOrder,0,skeleton.slots.length));let frames=this.frames;if(time<frames[0])return void(blend!=MixBlend.setup&&blend!=MixBlend.first||spine.Utils.arrayCopy(skeleton.slots,0,skeleton.drawOrder,0,skeleton.slots.length));let frame=0;frame=time>=frames[frames.length-1]?frames.length-1:Animation.binarySearch(frames,time)-1;let drawOrderToSetupIndex=this.drawOrders[frame];if(null==drawOrderToSetupIndex)spine.Utils.arrayCopy(slots,0,drawOrder,0,slots.length);else for(let i=0,n=drawOrderToSetupIndex.length;i<n;i++)drawOrder[i]=slots[drawOrderToSetupIndex[i]]}};let IkConstraintTimeline=(()=>{class IkConstraintTimeline extends CurveTimeline{constructor(frameCount){super(frameCount),this.frames=spine.Utils.newFloatArray(frameCount*IkConstraintTimeline.ENTRIES)}getPropertyId(){return(TimelineType.ikConstraint<<24)+this.ikConstraintIndex}setFrame(frameIndex,time,mix,softness,bendDirection,compress,stretch){frameIndex*=IkConstraintTimeline.ENTRIES,this.frames[frameIndex]=time,this.frames[frameIndex+IkConstraintTimeline.MIX]=mix,this.frames[frameIndex+IkConstraintTimeline.SOFTNESS]=softness,this.frames[frameIndex+IkConstraintTimeline.BEND_DIRECTION]=bendDirection,this.frames[frameIndex+IkConstraintTimeline.COMPRESS]=compress?1:0,this.frames[frameIndex+IkConstraintTimeline.STRETCH]=stretch?1:0}apply(skeleton,lastTime,time,firedEvents,alpha,blend,direction){let frames=this.frames,constraint=skeleton.ikConstraints[this.ikConstraintIndex];if(!constraint.active)return;if(time<frames[0]){switch(blend){case MixBlend.setup:return constraint.mix=constraint.data.mix,constraint.softness=constraint.data.softness,constraint.bendDirection=constraint.data.bendDirection,constraint.compress=constraint.data.compress,void(constraint.stretch=constraint.data.stretch);case MixBlend.first:constraint.mix+=(constraint.data.mix-constraint.mix)*alpha,constraint.softness+=(constraint.data.softness-constraint.softness)*alpha,constraint.bendDirection=constraint.data.bendDirection,constraint.compress=constraint.data.compress,constraint.stretch=constraint.data.stretch}return}if(time>=frames[frames.length-IkConstraintTimeline.ENTRIES])return void(blend==MixBlend.setup?(constraint.mix=constraint.data.mix+(frames[frames.length+IkConstraintTimeline.PREV_MIX]-constraint.data.mix)*alpha,constraint.softness=constraint.data.softness+(frames[frames.length+IkConstraintTimeline.PREV_SOFTNESS]-constraint.data.softness)*alpha,direction==MixDirection.mixOut?(constraint.bendDirection=constraint.data.bendDirection,constraint.compress=constraint.data.compress,constraint.stretch=constraint.data.stretch):(constraint.bendDirection=frames[frames.length+IkConstraintTimeline.PREV_BEND_DIRECTION],constraint.compress=0!=frames[frames.length+IkConstraintTimeline.PREV_COMPRESS],constraint.stretch=0!=frames[frames.length+IkConstraintTimeline.PREV_STRETCH])):(constraint.mix+=(frames[frames.length+IkConstraintTimeline.PREV_MIX]-constraint.mix)*alpha,constraint.softness+=(frames[frames.length+IkConstraintTimeline.PREV_SOFTNESS]-constraint.softness)*alpha,direction==MixDirection.mixIn&&(constraint.bendDirection=frames[frames.length+IkConstraintTimeline.PREV_BEND_DIRECTION],constraint.compress=0!=frames[frames.length+IkConstraintTimeline.PREV_COMPRESS],constraint.stretch=0!=frames[frames.length+IkConstraintTimeline.PREV_STRETCH])));let frame=Animation.binarySearch(frames,time,IkConstraintTimeline.ENTRIES),mix=frames[frame+IkConstraintTimeline.PREV_MIX],softness=frames[frame+IkConstraintTimeline.PREV_SOFTNESS],frameTime=frames[frame],percent=this.getCurvePercent(frame/IkConstraintTimeline.ENTRIES-1,1-(time-frameTime)/(frames[frame+IkConstraintTimeline.PREV_TIME]-frameTime));blend==MixBlend.setup?(constraint.mix=constraint.data.mix+(mix+(frames[frame+IkConstraintTimeline.MIX]-mix)*percent-constraint.data.mix)*alpha,constraint.softness=constraint.data.softness+(softness+(frames[frame+IkConstraintTimeline.SOFTNESS]-softness)*percent-constraint.data.softness)*alpha,direction==MixDirection.mixOut?(constraint.bendDirection=constraint.data.bendDirection,constraint.compress=constraint.data.compress,constraint.stretch=constraint.data.stretch):(constraint.bendDirection=frames[frame+IkConstraintTimeline.PREV_BEND_DIRECTION],constraint.compress=0!=frames[frame+IkConstraintTimeline.PREV_COMPRESS],constraint.stretch=0!=frames[frame+IkConstraintTimeline.PREV_STRETCH])):(constraint.mix+=(mix+(frames[frame+IkConstraintTimeline.MIX]-mix)*percent-constraint.mix)*alpha,constraint.softness+=(softness+(frames[frame+IkConstraintTimeline.SOFTNESS]-softness)*percent-constraint.softness)*alpha,direction==MixDirection.mixIn&&(constraint.bendDirection=frames[frame+IkConstraintTimeline.PREV_BEND_DIRECTION],constraint.compress=0!=frames[frame+IkConstraintTimeline.PREV_COMPRESS],constraint.stretch=0!=frames[frame+IkConstraintTimeline.PREV_STRETCH]))}}return IkConstraintTimeline.ENTRIES=6,IkConstraintTimeline.PREV_TIME=-6,IkConstraintTimeline.PREV_MIX=-5,IkConstraintTimeline.PREV_SOFTNESS=-4,IkConstraintTimeline.PREV_BEND_DIRECTION=-3,IkConstraintTimeline.PREV_COMPRESS=-2,IkConstraintTimeline.PREV_STRETCH=-1,IkConstraintTimeline.MIX=1,IkConstraintTimeline.SOFTNESS=2,IkConstraintTimeline.BEND_DIRECTION=3,IkConstraintTimeline.COMPRESS=4,IkConstraintTimeline.STRETCH=5,IkConstraintTimeline})();spine.IkConstraintTimeline=IkConstraintTimeline;let TransformConstraintTimeline=(()=>{class TransformConstraintTimeline extends CurveTimeline{constructor(frameCount){super(frameCount),this.frames=spine.Utils.newFloatArray(frameCount*TransformConstraintTimeline.ENTRIES)}getPropertyId(){return(TimelineType.transformConstraint<<24)+this.transformConstraintIndex}setFrame(frameIndex,time,rotateMix,translateMix,scaleMix,shearMix){frameIndex*=TransformConstraintTimeline.ENTRIES,this.frames[frameIndex]=time,this.frames[frameIndex+TransformConstraintTimeline.ROTATE]=rotateMix,this.frames[frameIndex+TransformConstraintTimeline.TRANSLATE]=translateMix,this.frames[frameIndex+TransformConstraintTimeline.SCALE]=scaleMix,this.frames[frameIndex+TransformConstraintTimeline.SHEAR]=shearMix}apply(skeleton,lastTime,time,firedEvents,alpha,blend,direction){let frames=this.frames,constraint=skeleton.transformConstraints[this.transformConstraintIndex];if(!constraint.active)return;if(time<frames[0]){let data=constraint.data;switch(blend){case MixBlend.setup:return constraint.rotateMix=data.rotateMix,constraint.translateMix=data.translateMix,constraint.scaleMix=data.scaleMix,void(constraint.shearMix=data.shearMix);case MixBlend.first:constraint.rotateMix+=(data.rotateMix-constraint.rotateMix)*alpha,constraint.translateMix+=(data.translateMix-constraint.translateMix)*alpha,constraint.scaleMix+=(data.scaleMix-constraint.scaleMix)*alpha,constraint.shearMix+=(data.shearMix-constraint.shearMix)*alpha}return}let rotate=0,translate=0,scale=0,shear=0;if(time>=frames[frames.length-TransformConstraintTimeline.ENTRIES]){let i=frames.length;rotate=frames[i+TransformConstraintTimeline.PREV_ROTATE],translate=frames[i+TransformConstraintTimeline.PREV_TRANSLATE],scale=frames[i+TransformConstraintTimeline.PREV_SCALE],shear=frames[i+TransformConstraintTimeline.PREV_SHEAR]}else{let frame=Animation.binarySearch(frames,time,TransformConstraintTimeline.ENTRIES);rotate=frames[frame+TransformConstraintTimeline.PREV_ROTATE],translate=frames[frame+TransformConstraintTimeline.PREV_TRANSLATE],scale=frames[frame+TransformConstraintTimeline.PREV_SCALE],shear=frames[frame+TransformConstraintTimeline.PREV_SHEAR];let frameTime=frames[frame],percent=this.getCurvePercent(frame/TransformConstraintTimeline.ENTRIES-1,1-(time-frameTime)/(frames[frame+TransformConstraintTimeline.PREV_TIME]-frameTime));rotate+=(frames[frame+TransformConstraintTimeline.ROTATE]-rotate)*percent,translate+=(frames[frame+TransformConstraintTimeline.TRANSLATE]-translate)*percent,scale+=(frames[frame+TransformConstraintTimeline.SCALE]-scale)*percent,shear+=(frames[frame+TransformConstraintTimeline.SHEAR]-shear)*percent}if(blend==MixBlend.setup){let data=constraint.data;constraint.rotateMix=data.rotateMix+(rotate-data.rotateMix)*alpha,constraint.translateMix=data.translateMix+(translate-data.translateMix)*alpha,constraint.scaleMix=data.scaleMix+(scale-data.scaleMix)*alpha,constraint.shearMix=data.shearMix+(shear-data.shearMix)*alpha}else constraint.rotateMix+=(rotate-constraint.rotateMix)*alpha,constraint.translateMix+=(translate-constraint.translateMix)*alpha,constraint.scaleMix+=(scale-constraint.scaleMix)*alpha,constraint.shearMix+=(shear-constraint.shearMix)*alpha}}return TransformConstraintTimeline.ENTRIES=5,TransformConstraintTimeline.PREV_TIME=-5,TransformConstraintTimeline.PREV_ROTATE=-4,TransformConstraintTimeline.PREV_TRANSLATE=-3,TransformConstraintTimeline.PREV_SCALE=-2,TransformConstraintTimeline.PREV_SHEAR=-1,TransformConstraintTimeline.ROTATE=1,TransformConstraintTimeline.TRANSLATE=2,TransformConstraintTimeline.SCALE=3,TransformConstraintTimeline.SHEAR=4,TransformConstraintTimeline})();spine.TransformConstraintTimeline=TransformConstraintTimeline;let PathConstraintPositionTimeline=(()=>{class PathConstraintPositionTimeline extends CurveTimeline{constructor(frameCount){super(frameCount),this.frames=spine.Utils.newFloatArray(frameCount*PathConstraintPositionTimeline.ENTRIES)}getPropertyId(){return(TimelineType.pathConstraintPosition<<24)+this.pathConstraintIndex}setFrame(frameIndex,time,value){frameIndex*=PathConstraintPositionTimeline.ENTRIES,this.frames[frameIndex]=time,this.frames[frameIndex+PathConstraintPositionTimeline.VALUE]=value}apply(skeleton,lastTime,time,firedEvents,alpha,blend,direction){let frames=this.frames,constraint=skeleton.pathConstraints[this.pathConstraintIndex];if(!constraint.active)return;if(time<frames[0]){switch(blend){case MixBlend.setup:return void(constraint.position=constraint.data.position);case MixBlend.first:constraint.position+=(constraint.data.position-constraint.position)*alpha}return}let position=0;if(time>=frames[frames.length-PathConstraintPositionTimeline.ENTRIES])position=frames[frames.length+PathConstraintPositionTimeline.PREV_VALUE];else{let frame=Animation.binarySearch(frames,time,PathConstraintPositionTimeline.ENTRIES);position=frames[frame+PathConstraintPositionTimeline.PREV_VALUE];let frameTime=frames[frame],percent=this.getCurvePercent(frame/PathConstraintPositionTimeline.ENTRIES-1,1-(time-frameTime)/(frames[frame+PathConstraintPositionTimeline.PREV_TIME]-frameTime));position+=(frames[frame+PathConstraintPositionTimeline.VALUE]-position)*percent}blend==MixBlend.setup?constraint.position=constraint.data.position+(position-constraint.data.position)*alpha:constraint.position+=(position-constraint.position)*alpha}}return PathConstraintPositionTimeline.ENTRIES=2,PathConstraintPositionTimeline.PREV_TIME=-2,PathConstraintPositionTimeline.PREV_VALUE=-1,PathConstraintPositionTimeline.VALUE=1,PathConstraintPositionTimeline})();spine.PathConstraintPositionTimeline=PathConstraintPositionTimeline;class PathConstraintSpacingTimeline extends PathConstraintPositionTimeline{constructor(frameCount){super(frameCount)}getPropertyId(){return(TimelineType.pathConstraintSpacing<<24)+this.pathConstraintIndex}apply(skeleton,lastTime,time,firedEvents,alpha,blend,direction){let frames=this.frames,constraint=skeleton.pathConstraints[this.pathConstraintIndex];if(!constraint.active)return;if(time<frames[0]){switch(blend){case MixBlend.setup:return void(constraint.spacing=constraint.data.spacing);case MixBlend.first:constraint.spacing+=(constraint.data.spacing-constraint.spacing)*alpha}return}let spacing=0;if(time>=frames[frames.length-PathConstraintSpacingTimeline.ENTRIES])spacing=frames[frames.length+PathConstraintSpacingTimeline.PREV_VALUE];else{let frame=Animation.binarySearch(frames,time,PathConstraintSpacingTimeline.ENTRIES);spacing=frames[frame+PathConstraintSpacingTimeline.PREV_VALUE];let frameTime=frames[frame],percent=this.getCurvePercent(frame/PathConstraintSpacingTimeline.ENTRIES-1,1-(time-frameTime)/(frames[frame+PathConstraintSpacingTimeline.PREV_TIME]-frameTime));spacing+=(frames[frame+PathConstraintSpacingTimeline.VALUE]-spacing)*percent}blend==MixBlend.setup?constraint.spacing=constraint.data.spacing+(spacing-constraint.data.spacing)*alpha:constraint.spacing+=(spacing-constraint.spacing)*alpha}}spine.PathConstraintSpacingTimeline=PathConstraintSpacingTimeline;let PathConstraintMixTimeline=(()=>{class PathConstraintMixTimeline extends CurveTimeline{constructor(frameCount){super(frameCount),this.frames=spine.Utils.newFloatArray(frameCount*PathConstraintMixTimeline.ENTRIES)}getPropertyId(){return(TimelineType.pathConstraintMix<<24)+this.pathConstraintIndex}setFrame(frameIndex,time,rotateMix,translateMix){frameIndex*=PathConstraintMixTimeline.ENTRIES,this.frames[frameIndex]=time,this.frames[frameIndex+PathConstraintMixTimeline.ROTATE]=rotateMix,this.frames[frameIndex+PathConstraintMixTimeline.TRANSLATE]=translateMix}apply(skeleton,lastTime,time,firedEvents,alpha,blend,direction){let frames=this.frames,constraint=skeleton.pathConstraints[this.pathConstraintIndex];if(!constraint.active)return;if(time<frames[0]){switch(blend){case MixBlend.setup:return constraint.rotateMix=constraint.data.rotateMix,void(constraint.translateMix=constraint.data.translateMix);case MixBlend.first:constraint.rotateMix+=(constraint.data.rotateMix-constraint.rotateMix)*alpha,constraint.translateMix+=(constraint.data.translateMix-constraint.translateMix)*alpha}return}let rotate=0,translate=0;if(time>=frames[frames.length-PathConstraintMixTimeline.ENTRIES])rotate=frames[frames.length+PathConstraintMixTimeline.PREV_ROTATE],translate=frames[frames.length+PathConstraintMixTimeline.PREV_TRANSLATE];else{let frame=Animation.binarySearch(frames,time,PathConstraintMixTimeline.ENTRIES);rotate=frames[frame+PathConstraintMixTimeline.PREV_ROTATE],translate=frames[frame+PathConstraintMixTimeline.PREV_TRANSLATE];let frameTime=frames[frame],percent=this.getCurvePercent(frame/PathConstraintMixTimeline.ENTRIES-1,1-(time-frameTime)/(frames[frame+PathConstraintMixTimeline.PREV_TIME]-frameTime));rotate+=(frames[frame+PathConstraintMixTimeline.ROTATE]-rotate)*percent,translate+=(frames[frame+PathConstraintMixTimeline.TRANSLATE]-translate)*percent}blend==MixBlend.setup?(constraint.rotateMix=constraint.data.rotateMix+(rotate-constraint.data.rotateMix)*alpha,constraint.translateMix=constraint.data.translateMix+(translate-constraint.data.translateMix)*alpha):(constraint.rotateMix+=(rotate-constraint.rotateMix)*alpha,constraint.translateMix+=(translate-constraint.translateMix)*alpha)}}return PathConstraintMixTimeline.ENTRIES=3,PathConstraintMixTimeline.PREV_TIME=-3,PathConstraintMixTimeline.PREV_ROTATE=-2,PathConstraintMixTimeline.PREV_TRANSLATE=-1,PathConstraintMixTimeline.ROTATE=1,PathConstraintMixTimeline.TRANSLATE=2,PathConstraintMixTimeline})();spine.PathConstraintMixTimeline=PathConstraintMixTimeline}(spine||(spine={})),function(spine){let EventType,AnimationState=(()=>{class AnimationState{constructor(data){this.tracks=new Array,this.timeScale=1,this.unkeyedState=0,this.events=new Array,this.listeners=new Array,this.queue=new EventQueue(this),this.propertyIDs=new spine.IntSet,this.animationsChanged=!1,this.trackEntryPool=new spine.Pool(()=>new TrackEntry),this.data=data}update(delta){delta*=this.timeScale;let tracks=this.tracks;for(let i=0,n=tracks.length;i<n;i++){let current=tracks[i];if(null==current)continue;current.animationLast=current.nextAnimationLast,current.trackLast=current.nextTrackLast;let currentDelta=delta*current.timeScale;if(current.delay>0){if(current.delay-=currentDelta,current.delay>0)continue;currentDelta=-current.delay,current.delay=0}let next=current.next;if(null!=next){let nextTime=current.trackLast-next.delay;if(nextTime>=0){for(next.delay=0,next.trackTime+=0==current.timeScale?0:(nextTime/current.timeScale+delta)*next.timeScale,current.trackTime+=currentDelta,this.setCurrent(i,next,!0);null!=next.mixingFrom;)next.mixTime+=delta,next=next.mixingFrom;continue}}else if(current.trackLast>=current.trackEnd&&null==current.mixingFrom){tracks[i]=null,this.queue.end(current),this.disposeNext(current);continue}if(null!=current.mixingFrom&&this.updateMixingFrom(current,delta)){let from=current.mixingFrom;for(current.mixingFrom=null,null!=from&&(from.mixingTo=null);null!=from;)this.queue.end(from),from=from.mixingFrom}current.trackTime+=currentDelta}this.queue.drain()}updateMixingFrom(to,delta){let from=to.mixingFrom;if(null==from)return!0;let finished=this.updateMixingFrom(from,delta);return from.animationLast=from.nextAnimationLast,from.trackLast=from.nextTrackLast,to.mixTime>0&&to.mixTime>=to.mixDuration?(0!=from.totalAlpha&&0!=to.mixDuration||(to.mixingFrom=from.mixingFrom,null!=from.mixingFrom&&(from.mixingFrom.mixingTo=to),to.interruptAlpha=from.interruptAlpha,this.queue.end(from)),finished):(from.trackTime+=delta*from.timeScale,to.mixTime+=delta,!1)}apply(skeleton){if(null==skeleton)throw new Error("skeleton cannot be null.");this.animationsChanged&&this._animationsChanged();let events=this.events,tracks=this.tracks,applied=!1;for(let i=0,n=tracks.length;i<n;i++){let current=tracks[i];if(null==current||current.delay>0)continue;applied=!0;let blend=0==i?spine.MixBlend.first:current.mixBlend,mix=current.alpha;null!=current.mixingFrom?mix*=this.applyMixingFrom(current,skeleton,blend):current.trackTime>=current.trackEnd&&null==current.next&&(mix=0);let animationLast=current.animationLast,animationTime=current.getAnimationTime(),timelineCount=current.animation.timelines.length,timelines=current.animation.timelines;if(0==i&&1==mix||blend==spine.MixBlend.add)for(let ii=0;ii<timelineCount;ii++){spine.Utils.webkit602BugfixHelper(mix,blend);var timeline=timelines[ii];timeline instanceof spine.AttachmentTimeline?this.applyAttachmentTimeline(timeline,skeleton,animationTime,blend,!0):timeline.apply(skeleton,animationLast,animationTime,events,mix,blend,spine.MixDirection.mixIn)}else{let timelineMode=current.timelineMode,firstFrame=0==current.timelinesRotation.length;firstFrame&&spine.Utils.setArraySize(current.timelinesRotation,timelineCount<<1,null);let timelinesRotation=current.timelinesRotation;for(let ii=0;ii<timelineCount;ii++){let timeline=timelines[ii],timelineBlend=timelineMode[ii]==AnimationState.SUBSEQUENT?blend:spine.MixBlend.setup;timeline instanceof spine.RotateTimeline?this.applyRotateTimeline(timeline,skeleton,animationTime,mix,timelineBlend,timelinesRotation,ii<<1,firstFrame):timeline instanceof spine.AttachmentTimeline?this.applyAttachmentTimeline(timeline,skeleton,animationTime,blend,!0):(spine.Utils.webkit602BugfixHelper(mix,blend),timeline.apply(skeleton,animationLast,animationTime,events,mix,timelineBlend,spine.MixDirection.mixIn))}}this.queueEvents(current,animationTime),events.length=0,current.nextAnimationLast=animationTime,current.nextTrackLast=current.trackTime}for(var setupState=this.unkeyedState+AnimationState.SETUP,slots=skeleton.slots,i=0,n=skeleton.slots.length;i<n;i++){var slot=slots[i];if(slot.attachmentState==setupState){var attachmentName=slot.data.attachmentName;slot.attachment=null==attachmentName?null:skeleton.getAttachment(slot.data.index,attachmentName)}}return this.unkeyedState+=2,this.queue.drain(),applied}applyMixingFrom(to,skeleton,blend){let from=to.mixingFrom;null!=from.mixingFrom&&this.applyMixingFrom(from,skeleton,blend);let mix=0;0==to.mixDuration?(mix=1,blend==spine.MixBlend.first&&(blend=spine.MixBlend.setup)):(mix=to.mixTime/to.mixDuration,mix>1&&(mix=1),blend!=spine.MixBlend.first&&(blend=from.mixBlend));let events=mix<from.eventThreshold?this.events:null,attachments=mix<from.attachmentThreshold,drawOrder=mix<from.drawOrderThreshold,animationLast=from.animationLast,animationTime=from.getAnimationTime(),timelineCount=from.animation.timelines.length,timelines=from.animation.timelines,alphaHold=from.alpha*to.interruptAlpha,alphaMix=alphaHold*(1-mix);if(blend==spine.MixBlend.add)for(let i=0;i<timelineCount;i++)timelines[i].apply(skeleton,animationLast,animationTime,events,alphaMix,blend,spine.MixDirection.mixOut);else{let timelineMode=from.timelineMode,timelineHoldMix=from.timelineHoldMix,firstFrame=0==from.timelinesRotation.length;firstFrame&&spine.Utils.setArraySize(from.timelinesRotation,timelineCount<<1,null);let timelinesRotation=from.timelinesRotation;from.totalAlpha=0;for(let i=0;i<timelineCount;i++){let timelineBlend,timeline=timelines[i],direction=spine.MixDirection.mixOut,alpha=0;switch(timelineMode[i]){case AnimationState.SUBSEQUENT:if(!drawOrder&&timeline instanceof spine.DrawOrderTimeline)continue;timelineBlend=blend,alpha=alphaMix;break;case AnimationState.FIRST:timelineBlend=spine.MixBlend.setup,alpha=alphaMix;break;case AnimationState.HOLD:timelineBlend=spine.MixBlend.setup,alpha=alphaHold;break;default:timelineBlend=spine.MixBlend.setup;let holdMix=timelineHoldMix[i];alpha=alphaHold*Math.max(0,1-holdMix.mixTime/holdMix.mixDuration)}from.totalAlpha+=alpha,timeline instanceof spine.RotateTimeline?this.applyRotateTimeline(timeline,skeleton,animationTime,alpha,timelineBlend,timelinesRotation,i<<1,firstFrame):timeline instanceof spine.AttachmentTimeline?this.applyAttachmentTimeline(timeline,skeleton,animationTime,timelineBlend,attachments):(spine.Utils.webkit602BugfixHelper(alpha,blend),drawOrder&&timeline instanceof spine.DrawOrderTimeline&&timelineBlend==spine.MixBlend.setup&&(direction=spine.MixDirection.mixIn),timeline.apply(skeleton,animationLast,animationTime,events,alpha,timelineBlend,direction))}}return to.mixDuration>0&&this.queueEvents(from,animationTime),this.events.length=0,from.nextAnimationLast=animationTime,from.nextTrackLast=from.trackTime,mix}applyAttachmentTimeline(timeline,skeleton,time,blend,attachments){var slot=skeleton.slots[timeline.slotIndex];if(slot.bone.active){var frameIndex,frames=timeline.frames;if(time<frames[0])blend!=spine.MixBlend.setup&&blend!=spine.MixBlend.first||this.setAttachment(skeleton,slot,slot.data.attachmentName,attachments);else frameIndex=time>=frames[frames.length-1]?frames.length-1:spine.Animation.binarySearch(frames,time)-1,this.setAttachment(skeleton,slot,timeline.attachmentNames[frameIndex],attachments);slot.attachmentState<=this.unkeyedState&&(slot.attachmentState=this.unkeyedState+AnimationState.SETUP)}}setAttachment(skeleton,slot,attachmentName,attachments){slot.attachment=null==attachmentName?null:skeleton.getAttachment(slot.data.index,attachmentName),attachments&&(slot.attachmentState=this.unkeyedState+AnimationState.CURRENT)}applyRotateTimeline(timeline,skeleton,time,alpha,blend,timelinesRotation,i,firstFrame){if(firstFrame&&(timelinesRotation[i]=0),1==alpha)return void timeline.apply(skeleton,0,time,null,1,blend,spine.MixDirection.mixIn);let rotateTimeline=timeline,frames=rotateTimeline.frames,bone=skeleton.bones[rotateTimeline.boneIndex];if(!bone.active)return;let r1=0,r2=0;if(time<frames[0])switch(blend){case spine.MixBlend.setup:bone.rotation=bone.data.rotation;default:return;case spine.MixBlend.first:r1=bone.rotation,r2=bone.data.rotation}else if(r1=blend==spine.MixBlend.setup?bone.data.rotation:bone.rotation,time>=frames[frames.length-spine.RotateTimeline.ENTRIES])r2=bone.data.rotation+frames[frames.length+spine.RotateTimeline.PREV_ROTATION];else{let frame=spine.Animation.binarySearch(frames,time,spine.RotateTimeline.ENTRIES),prevRotation=frames[frame+spine.RotateTimeline.PREV_ROTATION],frameTime=frames[frame],percent=rotateTimeline.getCurvePercent((frame>>1)-1,1-(time-frameTime)/(frames[frame+spine.RotateTimeline.PREV_TIME]-frameTime));r2=frames[frame+spine.RotateTimeline.ROTATION]-prevRotation,r2-=360*(16384-(16384.499999999996-r2/360|0)),r2=prevRotation+r2*percent+bone.data.rotation,r2-=360*(16384-(16384.499999999996-r2/360|0))}let total=0,diff=r2-r1;if(diff-=360*(16384-(16384.499999999996-diff/360|0)),0==diff)total=timelinesRotation[i];else{let lastTotal=0,lastDiff=0;firstFrame?(lastTotal=0,lastDiff=diff):(lastTotal=timelinesRotation[i],lastDiff=timelinesRotation[i+1]);let current=diff>0,dir=lastTotal>=0;spine.MathUtils.signum(lastDiff)!=spine.MathUtils.signum(diff)&&Math.abs(lastDiff)<=90&&(Math.abs(lastTotal)>180&&(lastTotal+=360*spine.MathUtils.signum(lastTotal)),dir=current),total=diff+lastTotal-lastTotal%360,dir!=current&&(total+=360*spine.MathUtils.signum(lastTotal)),timelinesRotation[i]=total}timelinesRotation[i+1]=diff,r1+=total*alpha,bone.rotation=r1-360*(16384-(16384.499999999996-r1/360|0))}queueEvents(entry,animationTime){let animationStart=entry.animationStart,animationEnd=entry.animationEnd,duration=animationEnd-animationStart,trackLastWrapped=entry.trackLast%duration,events=this.events,i=0,n=events.length;for(;i<n;i++){let event=events[i];if(event.time<trackLastWrapped)break;event.time>animationEnd||this.queue.event(entry,event)}let complete=!1;for(complete=entry.loop?0==duration||trackLastWrapped>entry.trackTime%duration:animationTime>=animationEnd&&entry.animationLast<animationEnd,complete&&this.queue.complete(entry);i<n;i++){events[i].time<animationStart||this.queue.event(entry,events[i])}}clearTracks(){let oldDrainDisabled=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(let i=0,n=this.tracks.length;i<n;i++)this.clearTrack(i);this.tracks.length=0,this.queue.drainDisabled=oldDrainDisabled,this.queue.drain()}clearTrack(trackIndex){if(trackIndex>=this.tracks.length)return;let current=this.tracks[trackIndex];if(null==current)return;this.queue.end(current),this.disposeNext(current);let entry=current;for(;;){let from=entry.mixingFrom;if(null==from)break;this.queue.end(from),entry.mixingFrom=null,entry.mixingTo=null,entry=from}this.tracks[current.trackIndex]=null,this.queue.drain()}setCurrent(index,current,interrupt){let from=this.expandToIndex(index);this.tracks[index]=current,null!=from&&(interrupt&&this.queue.interrupt(from),current.mixingFrom=from,from.mixingTo=current,current.mixTime=0,null!=from.mixingFrom&&from.mixDuration>0&&(current.interruptAlpha*=Math.min(1,from.mixTime/from.mixDuration)),from.timelinesRotation.length=0),this.queue.start(current)}setAnimation(trackIndex,animationName,loop){let animation=this.data.skeletonData.findAnimation(animationName);if(null==animation)throw new Error("Animation not found: "+animationName);return this.setAnimationWith(trackIndex,animation,loop)}setAnimationWith(trackIndex,animation,loop){if(null==animation)throw new Error("animation cannot be null.");let interrupt=!0,current=this.expandToIndex(trackIndex);null!=current&&(-1==current.nextTrackLast?(this.tracks[trackIndex]=current.mixingFrom,this.queue.interrupt(current),this.queue.end(current),this.disposeNext(current),current=current.mixingFrom,interrupt=!1):this.disposeNext(current));let entry=this.trackEntry(trackIndex,animation,loop,current);return this.setCurrent(trackIndex,entry,interrupt),this.queue.drain(),entry}addAnimation(trackIndex,animationName,loop,delay){let animation=this.data.skeletonData.findAnimation(animationName);if(null==animation)throw new Error("Animation not found: "+animationName);return this.addAnimationWith(trackIndex,animation,loop,delay)}addAnimationWith(trackIndex,animation,loop,delay){if(null==animation)throw new Error("animation cannot be null.");let last=this.expandToIndex(trackIndex);if(null!=last)for(;null!=last.next;)last=last.next;let entry=this.trackEntry(trackIndex,animation,loop,last);if(null==last)this.setCurrent(trackIndex,entry,!0),this.queue.drain();else if(last.next=entry,delay<=0){let duration=last.animationEnd-last.animationStart;0!=duration?(last.loop?delay+=duration*(1+(last.trackTime/duration|0)):delay+=Math.max(duration,last.trackTime),delay-=this.data.getMix(last.animation,animation)):delay=last.trackTime}return entry.delay=delay,entry}setEmptyAnimation(trackIndex,mixDuration){let entry=this.setAnimationWith(trackIndex,AnimationState.emptyAnimation,!1);return entry.mixDuration=mixDuration,entry.trackEnd=mixDuration,entry}addEmptyAnimation(trackIndex,mixDuration,delay){delay<=0&&(delay-=mixDuration);let entry=this.addAnimationWith(trackIndex,AnimationState.emptyAnimation,!1,delay);return entry.mixDuration=mixDuration,entry.trackEnd=mixDuration,entry}setEmptyAnimations(mixDuration){let oldDrainDisabled=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(let i=0,n=this.tracks.length;i<n;i++){let current=this.tracks[i];null!=current&&this.setEmptyAnimation(current.trackIndex,mixDuration)}this.queue.drainDisabled=oldDrainDisabled,this.queue.drain()}expandToIndex(index){return index<this.tracks.length?this.tracks[index]:(spine.Utils.ensureArrayCapacity(this.tracks,index+1,null),this.tracks.length=index+1,null)}trackEntry(trackIndex,animation,loop,last){let entry=this.trackEntryPool.obtain();return entry.trackIndex=trackIndex,entry.animation=animation,entry.loop=loop,entry.holdPrevious=!1,entry.eventThreshold=0,entry.attachmentThreshold=0,entry.drawOrderThreshold=0,entry.animationStart=0,entry.animationEnd=animation.duration,entry.animationLast=-1,entry.nextAnimationLast=-1,entry.delay=0,entry.trackTime=0,entry.trackLast=-1,entry.nextTrackLast=-1,entry.trackEnd=Number.MAX_VALUE,entry.timeScale=1,entry.alpha=1,entry.interruptAlpha=1,entry.mixTime=0,entry.mixDuration=null==last?0:this.data.getMix(last.animation,animation),entry.mixBlend=spine.MixBlend.replace,entry}disposeNext(entry){let next=entry.next;for(;null!=next;)this.queue.dispose(next),next=next.next;entry.next=null}_animationsChanged(){this.animationsChanged=!1,this.propertyIDs.clear();for(let i=0,n=this.tracks.length;i<n;i++){let entry=this.tracks[i];if(null!=entry){for(;null!=entry.mixingFrom;)entry=entry.mixingFrom;do{null!=entry.mixingFrom&&entry.mixBlend==spine.MixBlend.add||this.computeHold(entry),entry=entry.mixingTo}while(null!=entry)}}}computeHold(entry){let to=entry.mixingTo,timelines=entry.animation.timelines,timelinesCount=entry.animation.timelines.length,timelineMode=spine.Utils.setArraySize(entry.timelineMode,timelinesCount);entry.timelineHoldMix.length=0;let timelineDipMix=spine.Utils.setArraySize(entry.timelineHoldMix,timelinesCount),propertyIDs=this.propertyIDs;if(null!=to&&to.holdPrevious)for(let i=0;i<timelinesCount;i++)propertyIDs.add(timelines[i].getPropertyId()),timelineMode[i]=AnimationState.HOLD;else outer:for(let i=0;i<timelinesCount;i++){let timeline=timelines[i],id=timeline.getPropertyId();if(propertyIDs.add(id))if(null==to||timeline instanceof spine.AttachmentTimeline||timeline instanceof spine.DrawOrderTimeline||timeline instanceof spine.EventTimeline||!to.animation.hasTimeline(id))timelineMode[i]=AnimationState.FIRST;else{for(let next=to.mixingTo;null!=next;next=next.mixingTo)if(!next.animation.hasTimeline(id)){if(entry.mixDuration>0){timelineMode[i]=AnimationState.HOLD_MIX,timelineDipMix[i]=next;continue outer}break}timelineMode[i]=AnimationState.HOLD}else timelineMode[i]=AnimationState.SUBSEQUENT}}getCurrent(trackIndex){return trackIndex>=this.tracks.length?null:this.tracks[trackIndex]}addListener(listener){if(null==listener)throw new Error("listener cannot be null.");this.listeners.push(listener)}removeListener(listener){let index=this.listeners.indexOf(listener);index>=0&&this.listeners.splice(index,1)}clearListeners(){this.listeners.length=0}clearListenerNotifications(){this.queue.clear()}}return AnimationState.emptyAnimation=new spine.Animation("<empty>",[],0),AnimationState.SUBSEQUENT=0,AnimationState.FIRST=1,AnimationState.HOLD=2,AnimationState.HOLD_MIX=3,AnimationState.SETUP=1,AnimationState.CURRENT=2,AnimationState})();spine.AnimationState=AnimationState;class TrackEntry{constructor(){this.mixBlend=spine.MixBlend.replace,this.timelineMode=new Array,this.timelineHoldMix=new Array,this.timelinesRotation=new Array}reset(){this.next=null,this.mixingFrom=null,this.mixingTo=null,this.animation=null,this.listener=null,this.timelineMode.length=0,this.timelineHoldMix.length=0,this.timelinesRotation.length=0}getAnimationTime(){if(this.loop){let duration=this.animationEnd-this.animationStart;return 0==duration?this.animationStart:this.trackTime%duration+this.animationStart}return Math.min(this.trackTime+this.animationStart,this.animationEnd)}setAnimationLast(animationLast){this.animationLast=animationLast,this.nextAnimationLast=animationLast}isComplete(){return this.trackTime>=this.animationEnd-this.animationStart}resetRotationDirections(){this.timelinesRotation.length=0}}spine.TrackEntry=TrackEntry;class EventQueue{constructor(animState){this.objects=[],this.drainDisabled=!1,this.animState=animState}start(entry){this.objects.push(EventType.start),this.objects.push(entry),this.animState.animationsChanged=!0}interrupt(entry){this.objects.push(EventType.interrupt),this.objects.push(entry)}end(entry){this.objects.push(EventType.end),this.objects.push(entry),this.animState.animationsChanged=!0}dispose(entry){this.objects.push(EventType.dispose),this.objects.push(entry)}complete(entry){this.objects.push(EventType.complete),this.objects.push(entry)}event(entry,event){this.objects.push(EventType.event),this.objects.push(entry),this.objects.push(event)}drain(){if(this.drainDisabled)return;this.drainDisabled=!0;let objects=this.objects,listeners=this.animState.listeners;for(let i=0;i<objects.length;i+=2){let type=objects[i],entry=objects[i+1];switch(type){case EventType.start:null!=entry.listener&&entry.listener.start&&entry.listener.start(entry);for(let ii=0;ii<listeners.length;ii++)listeners[ii].start&&listeners[ii].start(entry);break;case EventType.interrupt:null!=entry.listener&&entry.listener.interrupt&&entry.listener.interrupt(entry);for(let ii=0;ii<listeners.length;ii++)listeners[ii].interrupt&&listeners[ii].interrupt(entry);break;case EventType.end:null!=entry.listener&&entry.listener.end&&entry.listener.end(entry);for(let ii=0;ii<listeners.length;ii++)listeners[ii].end&&listeners[ii].end(entry);case EventType.dispose:null!=entry.listener&&entry.listener.dispose&&entry.listener.dispose(entry);for(let ii=0;ii<listeners.length;ii++)listeners[ii].dispose&&listeners[ii].dispose(entry);this.animState.trackEntryPool.free(entry);break;case EventType.complete:null!=entry.listener&&entry.listener.complete&&entry.listener.complete(entry);for(let ii=0;ii<listeners.length;ii++)listeners[ii].complete&&listeners[ii].complete(entry);break;case EventType.event:let event=objects[2+i++];null!=entry.listener&&entry.listener.event&&entry.listener.event(entry,event);for(let ii=0;ii<listeners.length;ii++)listeners[ii].event&&listeners[ii].event(entry,event)}}this.clear(),this.drainDisabled=!1}clear(){this.objects.length=0}}spine.EventQueue=EventQueue,function(EventType){EventType[EventType.start=0]="start",EventType[EventType.interrupt=1]="interrupt",EventType[EventType.end=2]="end",EventType[EventType.dispose=3]="dispose",EventType[EventType.complete=4]="complete",EventType[EventType.event=5]="event"}(EventType=spine.EventType||(spine.EventType={}));spine.AnimationStateAdapter=class AnimationStateAdapter{start(entry){}interrupt(entry){}end(entry){}dispose(entry){}complete(entry){}event(entry,event){}}}(spine||(spine={})),function(spine){spine.AnimationStateData=class AnimationStateData{constructor(skeletonData){if(this.animationToMixTime={},this.defaultMix=0,null==skeletonData)throw new Error("skeletonData cannot be null.");this.skeletonData=skeletonData}setMix(fromName,toName,duration){let from=this.skeletonData.findAnimation(fromName);if(null==from)throw new Error("Animation not found: "+fromName);let to=this.skeletonData.findAnimation(toName);if(null==to)throw new Error("Animation not found: "+toName);this.setMixWith(from,to,duration)}setMixWith(from,to,duration){if(null==from)throw new Error("from cannot be null.");if(null==to)throw new Error("to cannot be null.");let key=from.name+"."+to.name;this.animationToMixTime[key]=duration}getMix(from,to){let key=from.name+"."+to.name,value=this.animationToMixTime[key];return void 0===value?this.defaultMix:value}}}(spine||(spine={})),function(spine){spine.AssetManager=class AssetManager{constructor(textureLoader,pathPrefix=""){this.assets={},this.errors={},this.toLoad=0,this.loaded=0,this.rawDataUris={},this.textureLoader=textureLoader,this.pathPrefix=pathPrefix}downloadText(url,success,error){let request=new XMLHttpRequest;request.overrideMimeType("text/html"),this.rawDataUris[url]&&(url=this.rawDataUris[url]),request.open("GET",url,!0),request.onload=()=>{200==request.status?success(request.responseText):error(request.status,request.responseText)},request.onerror=()=>{error(request.status,request.responseText)},request.send()}downloadBinary(url,success,error){let request=new XMLHttpRequest;this.rawDataUris[url]&&(url=this.rawDataUris[url]),request.open("GET",url,!0),request.responseType="arraybuffer",request.onload=()=>{200==request.status?success(new Uint8Array(request.response)):error(request.status,request.responseText)},request.onerror=()=>{error(request.status,request.responseText)},request.send()}setRawDataURI(path,data){this.rawDataUris[this.pathPrefix+path]=data}loadBinary(path,success=null,error=null){path=this.pathPrefix+path,this.toLoad++,this.downloadBinary(path,data=>{this.assets[path]=data,success&&success(path,data),this.toLoad--,this.loaded++},(state,responseText)=>{this.errors[path]=`Couldn't load binary ${path}: status ${status}, ${responseText}`,error&&error(path,`Couldn't load binary ${path}: status ${status}, ${responseText}`),this.toLoad--,this.loaded++})}loadText(path,success=null,error=null){path=this.pathPrefix+path,this.toLoad++,this.downloadText(path,data=>{this.assets[path]=data,success&&success(path,data),this.toLoad--,this.loaded++},(state,responseText)=>{this.errors[path]=`Couldn't load text ${path}: status ${status}, ${responseText}`,error&&error(path,`Couldn't load text ${path}: status ${status}, ${responseText}`),this.toLoad--,this.loaded++})}loadTexture(path,success=null,error=null){let storagePath=path=this.pathPrefix+path;this.toLoad++;let img=new Image;img.crossOrigin="anonymous",img.onload=ev=>{let texture=this.textureLoader(img);this.assets[storagePath]=texture,this.toLoad--,this.loaded++,success&&success(path,img)},img.onerror=ev=>{this.errors[path]="Couldn't load image "+path,this.toLoad--,this.loaded++,error&&error(path,"Couldn't load image "+path)},this.rawDataUris[path]&&(path=this.rawDataUris[path]),img.src=path}loadTextureAtlas(path,success=null,error=null){let parent=path.lastIndexOf("/")>=0?path.substring(0,path.lastIndexOf("/")):"";path=this.pathPrefix+path,this.toLoad++,this.downloadText(path,atlasData=>{let pagesLoaded={count:0},atlasPages=new Array;try{new spine.TextureAtlas(atlasData,path=>{atlasPages.push(""==parent?path:parent+"/"+path);let image=document.createElement("img");return image.width=16,image.height=16,new spine.FakeTexture(image)})}catch(e){let ex=e;return this.errors[path]=`Couldn't load texture atlas ${path}: ${ex.message}`,error&&error(path,`Couldn't load texture atlas ${path}: ${ex.message}`),this.toLoad--,void this.loaded++}for(let atlasPage of atlasPages){let pageLoadError=!1;this.loadTexture(atlasPage,(imagePath,image)=>{if(pagesLoaded.count++,pagesLoaded.count==atlasPages.length)if(pageLoadError)this.errors[path]=`Couldn't load texture atlas page ${imagePath}} of atlas ${path}`,error&&error(path,`Couldn't load texture atlas page ${imagePath} of atlas ${path}`),this.toLoad--,this.loaded++;else try{let atlas=new spine.TextureAtlas(atlasData,path=>this.get(""==parent?path:parent+"/"+path));this.assets[path]=atlas,success&&success(path,atlas),this.toLoad--,this.loaded++}catch(e){let ex=e;this.errors[path]=`Couldn't load texture atlas ${path}: ${ex.message}`,error&&error(path,`Couldn't load texture atlas ${path}: ${ex.message}`),this.toLoad--,this.loaded++}},(imagePath,errorMessage)=>{pageLoadError=!0,pagesLoaded.count++,pagesLoaded.count==atlasPages.length&&(this.errors[path]=`Couldn't load texture atlas page ${imagePath}} of atlas ${path}`,error&&error(path,`Couldn't load texture atlas page ${imagePath} of atlas ${path}`),this.toLoad--,this.loaded++)})}},(state,responseText)=>{this.errors[path]=`Couldn't load texture atlas ${path}: status ${status}, ${responseText}`,error&&error(path,`Couldn't load texture atlas ${path}: status ${status}, ${responseText}`),this.toLoad--,this.loaded++})}get(path){return path=this.pathPrefix+path,this.assets[path]}remove(path){path=this.pathPrefix+path;let asset=this.assets[path];asset.dispose&&asset.dispose(),this.assets[path]=null}removeAll(){for(let key in this.assets){let asset=this.assets[key];asset.dispose&&asset.dispose()}this.assets={}}isLoadingComplete(){return 0==this.toLoad}getToLoad(){return this.toLoad}getLoaded(){return this.loaded}dispose(){this.removeAll()}hasErrors(){return Object.keys(this.errors).length>0}getErrors(){return this.errors}}}(spine||(spine={})),function(spine){spine.AtlasAttachmentLoader=class AtlasAttachmentLoader{constructor(atlas){this.atlas=atlas}newRegionAttachment(skin,name,path){let region=this.atlas.findRegion(path);if(null==region)throw new Error("Region not found in atlas: "+path+" (region attachment: "+name+")");region.renderObject=region;let attachment=new spine.RegionAttachment(name);return attachment.setRegion(region),attachment}newMeshAttachment(skin,name,path){let region=this.atlas.findRegion(path);if(null==region)throw new Error("Region not found in atlas: "+path+" (mesh attachment: "+name+")");region.renderObject=region;let attachment=new spine.MeshAttachment(name);return attachment.region=region,attachment}newBoundingBoxAttachment(skin,name){return new spine.BoundingBoxAttachment(name)}newPathAttachment(skin,name){return new spine.PathAttachment(name)}newPointAttachment(skin,name){return new spine.PointAttachment(name)}newClippingAttachment(skin,name){return new spine.ClippingAttachment(name)}}}(spine||(spine={})),function(spine){let BlendMode;!function(BlendMode){BlendMode[BlendMode.Normal=0]="Normal",BlendMode[BlendMode.Additive=1]="Additive",BlendMode[BlendMode.Multiply=2]="Multiply",BlendMode[BlendMode.Screen=3]="Screen"}(BlendMode=spine.BlendMode||(spine.BlendMode={}))}(spine||(spine={})),function(spine){spine.Bone=class Bone{constructor(data,skeleton,parent){if(this.children=new Array,this.x=0,this.y=0,this.rotation=0,this.scaleX=0,this.scaleY=0,this.shearX=0,this.shearY=0,this.ax=0,this.ay=0,this.arotation=0,this.ascaleX=0,this.ascaleY=0,this.ashearX=0,this.ashearY=0,this.appliedValid=!1,this.a=0,this.b=0,this.c=0,this.d=0,this.worldY=0,this.worldX=0,this.sorted=!1,this.active=!1,null==data)throw new Error("data cannot be null.");if(null==skeleton)throw new Error("skeleton cannot be null.");this.data=data,this.skeleton=skeleton,this.parent=parent,this.setToSetupPose()}isActive(){return this.active}update(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)}updateWorldTransform(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)}updateWorldTransformWith(x,y,rotation,scaleX,scaleY,shearX,shearY){this.ax=x,this.ay=y,this.arotation=rotation,this.ascaleX=scaleX,this.ascaleY=scaleY,this.ashearX=shearX,this.ashearY=shearY,this.appliedValid=!0;let parent=this.parent;if(null==parent){let skeleton=this.skeleton,rotationY=rotation+90+shearY,sx=skeleton.scaleX,sy=skeleton.scaleY;return this.a=spine.MathUtils.cosDeg(rotation+shearX)*scaleX*sx,this.b=spine.MathUtils.cosDeg(rotationY)*scaleY*sx,this.c=spine.MathUtils.sinDeg(rotation+shearX)*scaleX*sy,this.d=spine.MathUtils.sinDeg(rotationY)*scaleY*sy,this.worldX=x*sx+skeleton.x,void(this.worldY=y*sy+skeleton.y)}let pa=parent.a,pb=parent.b,pc=parent.c,pd=parent.d;switch(this.worldX=pa*x+pb*y+parent.worldX,this.worldY=pc*x+pd*y+parent.worldY,this.data.transformMode){case spine.TransformMode.Normal:{let rotationY=rotation+90+shearY,la=spine.MathUtils.cosDeg(rotation+shearX)*scaleX,lb=spine.MathUtils.cosDeg(rotationY)*scaleY,lc=spine.MathUtils.sinDeg(rotation+shearX)*scaleX,ld=spine.MathUtils.sinDeg(rotationY)*scaleY;return this.a=pa*la+pb*lc,this.b=pa*lb+pb*ld,this.c=pc*la+pd*lc,void(this.d=pc*lb+pd*ld)}case spine.TransformMode.OnlyTranslation:{let rotationY=rotation+90+shearY;this.a=spine.MathUtils.cosDeg(rotation+shearX)*scaleX,this.b=spine.MathUtils.cosDeg(rotationY)*scaleY,this.c=spine.MathUtils.sinDeg(rotation+shearX)*scaleX,this.d=spine.MathUtils.sinDeg(rotationY)*scaleY;break}case spine.TransformMode.NoRotationOrReflection:{let s=pa*pa+pc*pc,prx=0;s>1e-4?(s=Math.abs(pa*pd-pb*pc)/s,pa/=this.skeleton.scaleX,pc/=this.skeleton.scaleY,pb=pc*s,pd=pa*s,prx=Math.atan2(pc,pa)*spine.MathUtils.radDeg):(pa=0,pc=0,prx=90-Math.atan2(pd,pb)*spine.MathUtils.radDeg);let rx=rotation+shearX-prx,ry=rotation+shearY-prx+90,la=spine.MathUtils.cosDeg(rx)*scaleX,lb=spine.MathUtils.cosDeg(ry)*scaleY,lc=spine.MathUtils.sinDeg(rx)*scaleX,ld=spine.MathUtils.sinDeg(ry)*scaleY;this.a=pa*la-pb*lc,this.b=pa*lb-pb*ld,this.c=pc*la+pd*lc,this.d=pc*lb+pd*ld;break}case spine.TransformMode.NoScale:case spine.TransformMode.NoScaleOrReflection:{let cos=spine.MathUtils.cosDeg(rotation),sin=spine.MathUtils.sinDeg(rotation),za=(pa*cos+pb*sin)/this.skeleton.scaleX,zc=(pc*cos+pd*sin)/this.skeleton.scaleY,s=Math.sqrt(za*za+zc*zc);s>1e-5&&(s=1/s),za*=s,zc*=s,s=Math.sqrt(za*za+zc*zc),this.data.transformMode==spine.TransformMode.NoScale&&pa*pd-pb*pc<0!=(this.skeleton.scaleX<0!=this.skeleton.scaleY<0)&&(s=-s);let r=Math.PI/2+Math.atan2(zc,za),zb=Math.cos(r)*s,zd=Math.sin(r)*s,la=spine.MathUtils.cosDeg(shearX)*scaleX,lb=spine.MathUtils.cosDeg(90+shearY)*scaleY,lc=spine.MathUtils.sinDeg(shearX)*scaleX,ld=spine.MathUtils.sinDeg(90+shearY)*scaleY;this.a=za*la+zb*lc,this.b=za*lb+zb*ld,this.c=zc*la+zd*lc,this.d=zc*lb+zd*ld;break}}this.a*=this.skeleton.scaleX,this.b*=this.skeleton.scaleX,this.c*=this.skeleton.scaleY,this.d*=this.skeleton.scaleY}setToSetupPose(){let data=this.data;this.x=data.x,this.y=data.y,this.rotation=data.rotation,this.scaleX=data.scaleX,this.scaleY=data.scaleY,this.shearX=data.shearX,this.shearY=data.shearY}getWorldRotationX(){return Math.atan2(this.c,this.a)*spine.MathUtils.radDeg}getWorldRotationY(){return Math.atan2(this.d,this.b)*spine.MathUtils.radDeg}getWorldScaleX(){return Math.sqrt(this.a*this.a+this.c*this.c)}getWorldScaleY(){return Math.sqrt(this.b*this.b+this.d*this.d)}updateAppliedTransform(){this.appliedValid=!0;let parent=this.parent;if(null==parent)return this.ax=this.worldX,this.ay=this.worldY,this.arotation=Math.atan2(this.c,this.a)*spine.MathUtils.radDeg,this.ascaleX=Math.sqrt(this.a*this.a+this.c*this.c),this.ascaleY=Math.sqrt(this.b*this.b+this.d*this.d),this.ashearX=0,void(this.ashearY=Math.atan2(this.a*this.b+this.c*this.d,this.a*this.d-this.b*this.c)*spine.MathUtils.radDeg);let pa=parent.a,pb=parent.b,pc=parent.c,pd=parent.d,pid=1/(pa*pd-pb*pc),dx=this.worldX-parent.worldX,dy=this.worldY-parent.worldY;this.ax=dx*pd*pid-dy*pb*pid,this.ay=dy*pa*pid-dx*pc*pid;let ia=pid*pd,id=pid*pa,ib=pid*pb,ic=pid*pc,ra=ia*this.a-ib*this.c,rb=ia*this.b-ib*this.d,rc=id*this.c-ic*this.a,rd=id*this.d-ic*this.b;if(this.ashearX=0,this.ascaleX=Math.sqrt(ra*ra+rc*rc),this.ascaleX>1e-4){let det=ra*rd-rb*rc;this.ascaleY=det/this.ascaleX,this.ashearY=Math.atan2(ra*rb+rc*rd,det)*spine.MathUtils.radDeg,this.arotation=Math.atan2(rc,ra)*spine.MathUtils.radDeg}else this.ascaleX=0,this.ascaleY=Math.sqrt(rb*rb+rd*rd),this.ashearY=0,this.arotation=90-Math.atan2(rd,rb)*spine.MathUtils.radDeg}worldToLocal(world){let a=this.a,b=this.b,c=this.c,d=this.d,invDet=1/(a*d-b*c),x=world.x-this.worldX,y=world.y-this.worldY;return world.x=x*d*invDet-y*b*invDet,world.y=y*a*invDet-x*c*invDet,world}localToWorld(local){let x=local.x,y=local.y;return local.x=x*this.a+y*this.b+this.worldX,local.y=x*this.c+y*this.d+this.worldY,local}worldToLocalRotation(worldRotation){let sin=spine.MathUtils.sinDeg(worldRotation),cos=spine.MathUtils.cosDeg(worldRotation);return Math.atan2(this.a*sin-this.c*cos,this.d*cos-this.b*sin)*spine.MathUtils.radDeg+this.rotation-this.shearX}localToWorldRotation(localRotation){localRotation-=this.rotation-this.shearX;let sin=spine.MathUtils.sinDeg(localRotation),cos=spine.MathUtils.cosDeg(localRotation);return Math.atan2(cos*this.c+sin*this.d,cos*this.a+sin*this.b)*spine.MathUtils.radDeg}rotateWorld(degrees){let a=this.a,b=this.b,c=this.c,d=this.d,cos=spine.MathUtils.cosDeg(degrees),sin=spine.MathUtils.sinDeg(degrees);this.a=cos*a-sin*c,this.b=cos*b-sin*d,this.c=sin*a+cos*c,this.d=sin*b+cos*d,this.appliedValid=!1}}}(spine||(spine={})),function(spine){let TransformMode;spine.BoneData=class BoneData{constructor(index,name,parent){if(this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.shearX=0,this.shearY=0,this.transformMode=TransformMode.Normal,this.skinRequired=!1,this.color=new spine.Color,index<0)throw new Error("index must be >= 0.");if(null==name)throw new Error("name cannot be null.");this.index=index,this.name=name,this.parent=parent}},function(TransformMode){TransformMode[TransformMode.Normal=0]="Normal",TransformMode[TransformMode.OnlyTranslation=1]="OnlyTranslation",TransformMode[TransformMode.NoRotationOrReflection=2]="NoRotationOrReflection",TransformMode[TransformMode.NoScale=3]="NoScale",TransformMode[TransformMode.NoScaleOrReflection=4]="NoScaleOrReflection"}(TransformMode=spine.TransformMode||(spine.TransformMode={}))}(spine||(spine={})),function(spine){spine.ConstraintData=class ConstraintData{constructor(name,order,skinRequired){this.name=name,this.order=order,this.skinRequired=skinRequired}}}(spine||(spine={})),function(spine){spine.Event=class Event{constructor(time,data){if(null==data)throw new Error("data cannot be null.");this.time=time,this.data=data}}}(spine||(spine={})),function(spine){spine.EventData=class EventData{constructor(name){this.name=name}}}(spine||(spine={})),function(spine){spine.IkConstraint=class IkConstraint{constructor(data,skeleton){if(this.bendDirection=0,this.compress=!1,this.stretch=!1,this.mix=1,this.softness=0,this.active=!1,null==data)throw new Error("data cannot be null.");if(null==skeleton)throw new Error("skeleton cannot be null.");this.data=data,this.mix=data.mix,this.softness=data.softness,this.bendDirection=data.bendDirection,this.compress=data.compress,this.stretch=data.stretch,this.bones=new Array;for(let i=0;i<data.bones.length;i++)this.bones.push(skeleton.findBone(data.bones[i].name));this.target=skeleton.findBone(data.target.name)}isActive(){return this.active}apply(){this.update()}update(){let target=this.target,bones=this.bones;switch(bones.length){case 1:this.apply1(bones[0],target.worldX,target.worldY,this.compress,this.stretch,this.data.uniform,this.mix);break;case 2:this.apply2(bones[0],bones[1],target.worldX,target.worldY,this.bendDirection,this.stretch,this.softness,this.mix)}}apply1(bone,targetX,targetY,compress,stretch,uniform,alpha){bone.appliedValid||bone.updateAppliedTransform();let p=bone.parent,pa=p.a,pb=p.b,pc=p.c,pd=p.d,rotationIK=-bone.ashearX-bone.arotation,tx=0,ty=0;switch(bone.data.transformMode){case spine.TransformMode.OnlyTranslation:tx=targetX-bone.worldX,ty=targetY-bone.worldY;break;case spine.TransformMode.NoRotationOrReflection:rotationIK+=Math.atan2(pc,pa)*spine.MathUtils.radDeg;let ps=Math.abs(pa*pd-pb*pc)/(pa*pa+pc*pc);pb=-pc*ps,pd=pa*ps;default:let x=targetX-p.worldX,y=targetY-p.worldY,d=pa*pd-pb*pc;tx=(x*pd-y*pb)/d-bone.ax,ty=(y*pa-x*pc)/d-bone.ay}rotationIK+=Math.atan2(ty,tx)*spine.MathUtils.radDeg,bone.ascaleX<0&&(rotationIK+=180),rotationIK>180?rotationIK-=360:rotationIK<-180&&(rotationIK+=360);let sx=bone.ascaleX,sy=bone.ascaleY;if(compress||stretch){switch(bone.data.transformMode){case spine.TransformMode.NoScale:case spine.TransformMode.NoScaleOrReflection:tx=targetX-bone.worldX,ty=targetY-bone.worldY}let b=bone.data.length*sx,dd=Math.sqrt(tx*tx+ty*ty);if(compress&&dd<b||stretch&&dd>b&&b>1e-4){let s=(dd/b-1)*alpha+1;sx*=s,uniform&&(sy*=s)}}bone.updateWorldTransformWith(bone.ax,bone.ay,bone.arotation+rotationIK*alpha,sx,sy,bone.ashearX,bone.ashearY)}apply2(parent,child,targetX,targetY,bendDir,stretch,softness,alpha){if(0==alpha)return void child.updateWorldTransform();parent.appliedValid||parent.updateAppliedTransform(),child.appliedValid||child.updateAppliedTransform();let px=parent.ax,py=parent.ay,psx=parent.ascaleX,sx=psx,psy=parent.ascaleY,csx=child.ascaleX,os1=0,os2=0,s2=0;psx<0?(psx=-psx,os1=180,s2=-1):(os1=0,s2=1),psy<0&&(psy=-psy,s2=-s2),csx<0?(csx=-csx,os2=180):os2=0;let cx=child.ax,cy=0,cwx=0,cwy=0,a=parent.a,b=parent.b,c=parent.c,d=parent.d,u=Math.abs(psx-psy)<=1e-4;u?(cy=child.ay,cwx=a*cx+b*cy+parent.worldX,cwy=c*cx+d*cy+parent.worldY):(cy=0,cwx=a*cx+parent.worldX,cwy=c*cx+parent.worldY);let pp=parent.parent;a=pp.a,b=pp.b,c=pp.c,d=pp.d;let a1,a2,id=1/(a*d-b*c),x=cwx-pp.worldX,y=cwy-pp.worldY,dx=(x*d-y*b)*id-px,dy=(y*a-x*c)*id-py,l1=Math.sqrt(dx*dx+dy*dy),l2=child.data.length*csx;if(l1<1e-4)return this.apply1(parent,targetX,targetY,!1,stretch,!1,alpha),void child.updateWorldTransformWith(cx,cy,0,child.ascaleX,child.ascaleY,child.ashearX,child.ashearY);x=targetX-pp.worldX,y=targetY-pp.worldY;let tx=(x*d-y*b)*id-px,ty=(y*a-x*c)*id-py,dd=tx*tx+ty*ty;if(0!=softness){softness*=psx*(csx+1)/2;let td=Math.sqrt(dd),sd=td-l1-l2*psx+softness;if(sd>0){let p=Math.min(1,sd/(2*softness))-1;p=(sd-softness*(1-p*p))/td,tx-=p*tx,ty-=p*ty,dd=tx*tx+ty*ty}}outer:if(u){l2*=psx;let cos=(dd-l1*l1-l2*l2)/(2*l1*l2);cos<-1?cos=-1:cos>1&&(cos=1,stretch&&(sx*=(Math.sqrt(dd)/(l1+l2)-1)*alpha+1)),a2=Math.acos(cos)*bendDir,a=l1+l2*cos,b=l2*Math.sin(a2),a1=Math.atan2(ty*a-tx*b,tx*a+ty*b)}else{a=psx*l2,b=psy*l2;let aa=a*a,bb=b*b,ta=Math.atan2(ty,tx);c=bb*l1*l1+aa*dd-aa*bb;let c1=-2*bb*l1,c2=bb-aa;if(d=c1*c1-4*c2*c,d>=0){let q=Math.sqrt(d);c1<0&&(q=-q),q=-(c1+q)/2;let r0=q/c2,r1=c/q,r=Math.abs(r0)<Math.abs(r1)?r0:r1;if(r*r<=dd){y=Math.sqrt(dd-r*r)*bendDir,a1=ta-Math.atan2(y,r),a2=Math.atan2(y/psy,(r-l1)/psx);break outer}}let minAngle=spine.MathUtils.PI,minX=l1-a,minDist=minX*minX,minY=0,maxAngle=0,maxX=l1+a,maxDist=maxX*maxX,maxY=0;c=-a*l1/(aa-bb),c>=-1&&c<=1&&(c=Math.acos(c),x=a*Math.cos(c)+l1,y=b*Math.sin(c),d=x*x+y*y,d<minDist&&(minAngle=c,minDist=d,minX=x,minY=y),d>maxDist&&(maxAngle=c,maxDist=d,maxX=x,maxY=y)),dd<=(minDist+maxDist)/2?(a1=ta-Math.atan2(minY*bendDir,minX),a2=minAngle*bendDir):(a1=ta-Math.atan2(maxY*bendDir,maxX),a2=maxAngle*bendDir)}let os=Math.atan2(cy,cx)*s2,rotation=parent.arotation;a1=(a1-os)*spine.MathUtils.radDeg+os1-rotation,a1>180?a1-=360:a1<-180&&(a1+=360),parent.updateWorldTransformWith(px,py,rotation+a1*alpha,sx,parent.ascaleY,0,0),rotation=child.arotation,a2=((a2+os)*spine.MathUtils.radDeg-child.ashearX)*s2+os2-rotation,a2>180?a2-=360:a2<-180&&(a2+=360),child.updateWorldTransformWith(cx,cy,rotation+a2*alpha,child.ascaleX,child.ascaleY,child.ashearX,child.ashearY)}}}(spine||(spine={})),function(spine){class IkConstraintData extends spine.ConstraintData{constructor(name){super(name,0,!1),this.bones=new Array,this.bendDirection=1,this.compress=!1,this.stretch=!1,this.uniform=!1,this.mix=1,this.softness=0}}spine.IkConstraintData=IkConstraintData}(spine||(spine={})),function(spine){let PathConstraint=(()=>{class PathConstraint{constructor(data,skeleton){if(this.position=0,this.spacing=0,this.rotateMix=0,this.translateMix=0,this.spaces=new Array,this.positions=new Array,this.world=new Array,this.curves=new Array,this.lengths=new Array,this.segments=new Array,this.active=!1,null==data)throw new Error("data cannot be null.");if(null==skeleton)throw new Error("skeleton cannot be null.");this.data=data,this.bones=new Array;for(let i=0,n=data.bones.length;i<n;i++)this.bones.push(skeleton.findBone(data.bones[i].name));this.target=skeleton.findSlot(data.target.name),this.position=data.position,this.spacing=data.spacing,this.rotateMix=data.rotateMix,this.translateMix=data.translateMix}isActive(){return this.active}apply(){this.update()}update(){let attachment=this.target.getAttachment();if(!(attachment instanceof spine.PathAttachment))return;let rotateMix=this.rotateMix,translateMix=this.translateMix,rotate=rotateMix>0;if(!(translateMix>0)&&!rotate)return;let data=this.data,percentSpacing=data.spacingMode==spine.SpacingMode.Percent,rotateMode=data.rotateMode,tangents=rotateMode==spine.RotateMode.Tangent,scale=rotateMode==spine.RotateMode.ChainScale,boneCount=this.bones.length,spacesCount=tangents?boneCount:boneCount+1,bones=this.bones,spaces=spine.Utils.setArraySize(this.spaces,spacesCount),lengths=null,spacing=this.spacing;if(scale||!percentSpacing){scale&&(lengths=spine.Utils.setArraySize(this.lengths,boneCount));let lengthSpacing=data.spacingMode==spine.SpacingMode.Length;for(let i=0,n=spacesCount-1;i<n;){let bone=bones[i],setupLength=bone.data.length;if(setupLength<PathConstraint.epsilon)scale&&(lengths[i]=0),spaces[++i]=0;else if(percentSpacing){if(scale){let x=setupLength*bone.a,y=setupLength*bone.c,length=Math.sqrt(x*x+y*y);lengths[i]=length}spaces[++i]=spacing}else{let x=setupLength*bone.a,y=setupLength*bone.c,length=Math.sqrt(x*x+y*y);scale&&(lengths[i]=length),spaces[++i]=(lengthSpacing?setupLength+spacing:spacing)*length/setupLength}}}else for(let i=1;i<spacesCount;i++)spaces[i]=spacing;let positions=this.computeWorldPositions(attachment,spacesCount,tangents,data.positionMode==spine.PositionMode.Percent,percentSpacing),boneX=positions[0],boneY=positions[1],offsetRotation=data.offsetRotation,tip=!1;if(0==offsetRotation)tip=rotateMode==spine.RotateMode.Chain;else{tip=!1;let p=this.target.bone;offsetRotation*=p.a*p.d-p.b*p.c>0?spine.MathUtils.degRad:-spine.MathUtils.degRad}for(let i=0,p=3;i<boneCount;i++,p+=3){let bone=bones[i];bone.worldX+=(boneX-bone.worldX)*translateMix,bone.worldY+=(boneY-bone.worldY)*translateMix;let x=positions[p],y=positions[p+1],dx=x-boneX,dy=y-boneY;if(scale){let length=lengths[i];if(0!=length){let s=(Math.sqrt(dx*dx+dy*dy)/length-1)*rotateMix+1;bone.a*=s,bone.c*=s}}if(boneX=x,boneY=y,rotate){let a=bone.a,b=bone.b,c=bone.c,d=bone.d,r=0,cos=0,sin=0;if(r=tangents?positions[p-1]:0==spaces[i+1]?positions[p+2]:Math.atan2(dy,dx),r-=Math.atan2(c,a),tip){cos=Math.cos(r),sin=Math.sin(r);let length=bone.data.length;boneX+=(length*(cos*a-sin*c)-dx)*rotateMix,boneY+=(length*(sin*a+cos*c)-dy)*rotateMix}else r+=offsetRotation;r>spine.MathUtils.PI?r-=spine.MathUtils.PI2:r<-spine.MathUtils.PI&&(r+=spine.MathUtils.PI2),r*=rotateMix,cos=Math.cos(r),sin=Math.sin(r),bone.a=cos*a-sin*c,bone.b=cos*b-sin*d,bone.c=sin*a+cos*c,bone.d=sin*b+cos*d}bone.appliedValid=!1}}computeWorldPositions(path,spacesCount,tangents,percentPosition,percentSpacing){let target=this.target,position=this.position,spaces=this.spaces,out=spine.Utils.setArraySize(this.positions,3*spacesCount+2),world=null,closed=path.closed,verticesLength=path.worldVerticesLength,curveCount=verticesLength/6,prevCurve=PathConstraint.NONE;if(!path.constantSpeed){let lengths=path.lengths;curveCount-=closed?1:2;let pathLength=lengths[curveCount];if(percentPosition&&(position*=pathLength),percentSpacing)for(let i=1;i<spacesCount;i++)spaces[i]*=pathLength;world=spine.Utils.setArraySize(this.world,8);for(let i=0,o=0,curve=0;i<spacesCount;i++,o+=3){let space=spaces[i];position+=space;let p=position;if(closed)p%=pathLength,p<0&&(p+=pathLength),curve=0;else{if(p<0){prevCurve!=PathConstraint.BEFORE&&(prevCurve=PathConstraint.BEFORE,path.computeWorldVertices(target,2,4,world,0,2)),this.addBeforePosition(p,world,0,out,o);continue}if(p>pathLength){prevCurve!=PathConstraint.AFTER&&(prevCurve=PathConstraint.AFTER,path.computeWorldVertices(target,verticesLength-6,4,world,0,2)),this.addAfterPosition(p-pathLength,world,0,out,o);continue}}for(;;curve++){let length=lengths[curve];if(!(p>length)){if(0==curve)p/=length;else{let prev=lengths[curve-1];p=(p-prev)/(length-prev)}break}}curve!=prevCurve&&(prevCurve=curve,closed&&curve==curveCount?(path.computeWorldVertices(target,verticesLength-4,4,world,0,2),path.computeWorldVertices(target,0,4,world,4,2)):path.computeWorldVertices(target,6*curve+2,8,world,0,2)),this.addCurvePosition(p,world[0],world[1],world[2],world[3],world[4],world[5],world[6],world[7],out,o,tangents||i>0&&0==space)}return out}closed?(verticesLength+=2,world=spine.Utils.setArraySize(this.world,verticesLength),path.computeWorldVertices(target,2,verticesLength-4,world,0,2),path.computeWorldVertices(target,0,2,world,verticesLength-4,2),world[verticesLength-2]=world[0],world[verticesLength-1]=world[1]):(curveCount--,verticesLength-=4,world=spine.Utils.setArraySize(this.world,verticesLength),path.computeWorldVertices(target,2,verticesLength,world,0,2));let curves=spine.Utils.setArraySize(this.curves,curveCount),pathLength=0,x1=world[0],y1=world[1],cx1=0,cy1=0,cx2=0,cy2=0,x2=0,y2=0,tmpx=0,tmpy=0,dddfx=0,dddfy=0,ddfx=0,ddfy=0,dfx=0,dfy=0;for(let i=0,w=2;i<curveCount;i++,w+=6)cx1=world[w],cy1=world[w+1],cx2=world[w+2],cy2=world[w+3],x2=world[w+4],y2=world[w+5],tmpx=.1875*(x1-2*cx1+cx2),tmpy=.1875*(y1-2*cy1+cy2),dddfx=.09375*(3*(cx1-cx2)-x1+x2),dddfy=.09375*(3*(cy1-cy2)-y1+y2),ddfx=2*tmpx+dddfx,ddfy=2*tmpy+dddfy,dfx=.75*(cx1-x1)+tmpx+.16666667*dddfx,dfy=.75*(cy1-y1)+tmpy+.16666667*dddfy,pathLength+=Math.sqrt(dfx*dfx+dfy*dfy),dfx+=ddfx,dfy+=ddfy,ddfx+=dddfx,ddfy+=dddfy,pathLength+=Math.sqrt(dfx*dfx+dfy*dfy),dfx+=ddfx,dfy+=ddfy,pathLength+=Math.sqrt(dfx*dfx+dfy*dfy),dfx+=ddfx+dddfx,dfy+=ddfy+dddfy,pathLength+=Math.sqrt(dfx*dfx+dfy*dfy),curves[i]=pathLength,x1=x2,y1=y2;if(position*=percentPosition?pathLength:pathLength/path.lengths[curveCount-1],percentSpacing)for(let i=1;i<spacesCount;i++)spaces[i]*=pathLength;let segments=this.segments,curveLength=0;for(let i=0,o=0,curve=0,segment=0;i<spacesCount;i++,o+=3){let space=spaces[i];position+=space;let p=position;if(closed)p%=pathLength,p<0&&(p+=pathLength),curve=0;else{if(p<0){this.addBeforePosition(p,world,0,out,o);continue}if(p>pathLength){this.addAfterPosition(p-pathLength,world,verticesLength-4,out,o);continue}}for(;;curve++){let length=curves[curve];if(!(p>length)){if(0==curve)p/=length;else{let prev=curves[curve-1];p=(p-prev)/(length-prev)}break}}if(curve!=prevCurve){prevCurve=curve;let ii=6*curve;for(x1=world[ii],y1=world[ii+1],cx1=world[ii+2],cy1=world[ii+3],cx2=world[ii+4],cy2=world[ii+5],x2=world[ii+6],y2=world[ii+7],tmpx=.03*(x1-2*cx1+cx2),tmpy=.03*(y1-2*cy1+cy2),dddfx=.006*(3*(cx1-cx2)-x1+x2),dddfy=.006*(3*(cy1-cy2)-y1+y2),ddfx=2*tmpx+dddfx,ddfy=2*tmpy+dddfy,dfx=.3*(cx1-x1)+tmpx+.16666667*dddfx,dfy=.3*(cy1-y1)+tmpy+.16666667*dddfy,curveLength=Math.sqrt(dfx*dfx+dfy*dfy),segments[0]=curveLength,ii=1;ii<8;ii++)dfx+=ddfx,dfy+=ddfy,ddfx+=dddfx,ddfy+=dddfy,curveLength+=Math.sqrt(dfx*dfx+dfy*dfy),segments[ii]=curveLength;dfx+=ddfx,dfy+=ddfy,curveLength+=Math.sqrt(dfx*dfx+dfy*dfy),segments[8]=curveLength,dfx+=ddfx+dddfx,dfy+=ddfy+dddfy,curveLength+=Math.sqrt(dfx*dfx+dfy*dfy),segments[9]=curveLength,segment=0}for(p*=curveLength;;segment++){let length=segments[segment];if(!(p>length)){if(0==segment)p/=length;else{let prev=segments[segment-1];p=segment+(p-prev)/(length-prev)}break}}this.addCurvePosition(.1*p,x1,y1,cx1,cy1,cx2,cy2,x2,y2,out,o,tangents||i>0&&0==space)}return out}addBeforePosition(p,temp,i,out,o){let x1=temp[i],y1=temp[i+1],dx=temp[i+2]-x1,dy=temp[i+3]-y1,r=Math.atan2(dy,dx);out[o]=x1+p*Math.cos(r),out[o+1]=y1+p*Math.sin(r),out[o+2]=r}addAfterPosition(p,temp,i,out,o){let x1=temp[i+2],y1=temp[i+3],dx=x1-temp[i],dy=y1-temp[i+1],r=Math.atan2(dy,dx);out[o]=x1+p*Math.cos(r),out[o+1]=y1+p*Math.sin(r),out[o+2]=r}addCurvePosition(p,x1,y1,cx1,cy1,cx2,cy2,x2,y2,out,o,tangents){if(0==p||isNaN(p))return out[o]=x1,out[o+1]=y1,void(out[o+2]=Math.atan2(cy1-y1,cx1-x1));let tt=p*p,ttt=tt*p,u=1-p,uu=u*u,uuu=uu*u,ut=u*p,ut3=3*ut,uut3=u*ut3,utt3=ut3*p,x=x1*uuu+cx1*uut3+cx2*utt3+x2*ttt,y=y1*uuu+cy1*uut3+cy2*utt3+y2*ttt;out[o]=x,out[o+1]=y,tangents&&(out[o+2]=p<.001?Math.atan2(cy1-y1,cx1-x1):Math.atan2(y-(y1*uu+cy1*ut*2+cy2*tt),x-(x1*uu+cx1*ut*2+cx2*tt)))}}return PathConstraint.NONE=-1,PathConstraint.BEFORE=-2,PathConstraint.AFTER=-3,PathConstraint.epsilon=1e-5,PathConstraint})();spine.PathConstraint=PathConstraint}(spine||(spine={})),function(spine){class PathConstraintData extends spine.ConstraintData{constructor(name){super(name,0,!1),this.bones=new Array}}let PositionMode,SpacingMode,RotateMode;spine.PathConstraintData=PathConstraintData,function(PositionMode){PositionMode[PositionMode.Fixed=0]="Fixed",PositionMode[PositionMode.Percent=1]="Percent"}(PositionMode=spine.PositionMode||(spine.PositionMode={})),function(SpacingMode){SpacingMode[SpacingMode.Length=0]="Length",SpacingMode[SpacingMode.Fixed=1]="Fixed",SpacingMode[SpacingMode.Percent=2]="Percent"}(SpacingMode=spine.SpacingMode||(spine.SpacingMode={})),function(RotateMode){RotateMode[RotateMode.Tangent=0]="Tangent",RotateMode[RotateMode.Chain=1]="Chain",RotateMode[RotateMode.ChainScale=2]="ChainScale"}(RotateMode=spine.RotateMode||(spine.RotateMode={}))}(spine||(spine={})),function(spine){class Assets{constructor(clientId){this.toLoad=new Array,this.assets={},this.clientId=clientId}loaded(){let i=0;for(let v in this.assets)i++;return i}}spine.SharedAssetManager=class SharedAssetManager{constructor(pathPrefix=""){this.clientAssets={},this.queuedAssets={},this.rawAssets={},this.errors={},this.pathPrefix=pathPrefix}queueAsset(clientId,textureLoader,path){let clientAssets=this.clientAssets[clientId];return null==clientAssets&&(clientAssets=new Assets(clientId),this.clientAssets[clientId]=clientAssets),null!==textureLoader&&(clientAssets.textureLoader=textureLoader),clientAssets.toLoad.push(path),this.queuedAssets[path]!==path&&(this.queuedAssets[path]=path,!0)}loadText(clientId,path){if(path=this.pathPrefix+path,!this.queueAsset(clientId,null,path))return;let request=new XMLHttpRequest;request.overrideMimeType("text/html"),request.onreadystatechange=()=>{request.readyState==XMLHttpRequest.DONE&&(request.status>=200&&request.status<300?this.rawAssets[path]=request.responseText:this.errors[path]=`Couldn't load text ${path}: status ${request.status}, ${request.responseText}`)},request.open("GET",path,!0),request.send()}loadJson(clientId,path){if(path=this.pathPrefix+path,!this.queueAsset(clientId,null,path))return;let request=new XMLHttpRequest;request.overrideMimeType("text/html"),request.onreadystatechange=()=>{request.readyState==XMLHttpRequest.DONE&&(request.status>=200&&request.status<300?this.rawAssets[path]=JSON.parse(request.responseText):this.errors[path]=`Couldn't load text ${path}: status ${request.status}, ${request.responseText}`)},request.open("GET",path,!0),request.send()}loadTexture(clientId,textureLoader,path){if(path=this.pathPrefix+path,!this.queueAsset(clientId,textureLoader,path))return;let img=new Image;img.crossOrigin="anonymous",img.onload=ev=>{this.rawAssets[path]=img},img.onerror=ev=>{this.errors[path]="Couldn't load image "+path},img.src=path}get(clientId,path){path=this.pathPrefix+path;let clientAssets=this.clientAssets[clientId];return null==clientAssets||clientAssets.assets[path]}updateClientAssets(clientAssets){for(let i=0;i<clientAssets.toLoad.length;i++){let path=clientAssets.toLoad[i],asset=clientAssets.assets[path];if(null==asset){let rawAsset=this.rawAssets[path];if(null==rawAsset)continue;rawAsset instanceof HTMLImageElement?clientAssets.assets[path]=clientAssets.textureLoader(rawAsset):clientAssets.assets[path]=rawAsset}}}isLoadingComplete(clientId){let clientAssets=this.clientAssets[clientId];return null==clientAssets||(this.updateClientAssets(clientAssets),clientAssets.toLoad.length==clientAssets.loaded())}dispose(){}hasErrors(){return Object.keys(this.errors).length>0}getErrors(){return this.errors}}}(spine||(spine={})),function(spine){spine.Skeleton=class Skeleton{constructor(data){if(this._updateCache=new Array,this.updateCacheReset=new Array,this.time=0,this.scaleX=1,this.scaleY=1,this.x=0,this.y=0,null==data)throw new Error("data cannot be null.");this.data=data,this.bones=new Array;for(let i=0;i<data.bones.length;i++){let bone,boneData=data.bones[i];if(null==boneData.parent)bone=new spine.Bone(boneData,this,null);else{let parent=this.bones[boneData.parent.index];bone=new spine.Bone(boneData,this,parent),parent.children.push(bone)}this.bones.push(bone)}this.slots=new Array,this.drawOrder=new Array;for(let i=0;i<data.slots.length;i++){let slotData=data.slots[i],bone=this.bones[slotData.boneData.index],slot=new spine.Slot(slotData,bone);this.slots.push(slot),this.drawOrder.push(slot)}this.ikConstraints=new Array;for(let i=0;i<data.ikConstraints.length;i++){let ikConstraintData=data.ikConstraints[i];this.ikConstraints.push(new spine.IkConstraint(ikConstraintData,this))}this.transformConstraints=new Array;for(let i=0;i<data.transformConstraints.length;i++){let transformConstraintData=data.transformConstraints[i];this.transformConstraints.push(new spine.TransformConstraint(transformConstraintData,this))}this.pathConstraints=new Array;for(let i=0;i<data.pathConstraints.length;i++){let pathConstraintData=data.pathConstraints[i];this.pathConstraints.push(new spine.PathConstraint(pathConstraintData,this))}this.color=new spine.Color(1,1,1,1),this.updateCache()}updateCache(){this._updateCache.length=0,this.updateCacheReset.length=0;let bones=this.bones;for(let i=0,n=bones.length;i<n;i++){let bone=bones[i];bone.sorted=bone.data.skinRequired,bone.active=!bone.sorted}if(null!=this.skin){let skinBones=this.skin.bones;for(let i=0,n=this.skin.bones.length;i<n;i++){let bone=this.bones[skinBones[i].index];do{bone.sorted=!1,bone.active=!0,bone=bone.parent}while(null!=bone)}}let ikConstraints=this.ikConstraints,transformConstraints=this.transformConstraints,pathConstraints=this.pathConstraints,ikCount=ikConstraints.length,transformCount=transformConstraints.length,pathCount=pathConstraints.length,constraintCount=ikCount+transformCount+pathCount;outer:for(let i=0;i<constraintCount;i++){for(let ii=0;ii<ikCount;ii++){let constraint=ikConstraints[ii];if(constraint.data.order==i){this.sortIkConstraint(constraint);continue outer}}for(let ii=0;ii<transformCount;ii++){let constraint=transformConstraints[ii];if(constraint.data.order==i){this.sortTransformConstraint(constraint);continue outer}}for(let ii=0;ii<pathCount;ii++){let constraint=pathConstraints[ii];if(constraint.data.order==i){this.sortPathConstraint(constraint);continue outer}}}for(let i=0,n=bones.length;i<n;i++)this.sortBone(bones[i])}sortIkConstraint(constraint){if(constraint.active=constraint.target.isActive()&&(!constraint.data.skinRequired||null!=this.skin&&spine.Utils.contains(this.skin.constraints,constraint.data,!0)),!constraint.active)return;let target=constraint.target;this.sortBone(target);let constrained=constraint.bones,parent=constrained[0];if(this.sortBone(parent),constrained.length>1){let child=constrained[constrained.length-1];this._updateCache.indexOf(child)>-1||this.updateCacheReset.push(child)}this._updateCache.push(constraint),this.sortReset(parent.children),constrained[constrained.length-1].sorted=!0}sortPathConstraint(constraint){if(constraint.active=constraint.target.bone.isActive()&&(!constraint.data.skinRequired||null!=this.skin&&spine.Utils.contains(this.skin.constraints,constraint.data,!0)),!constraint.active)return;let slot=constraint.target,slotIndex=slot.data.index,slotBone=slot.bone;null!=this.skin&&this.sortPathConstraintAttachment(this.skin,slotIndex,slotBone),null!=this.data.defaultSkin&&this.data.defaultSkin!=this.skin&&this.sortPathConstraintAttachment(this.data.defaultSkin,slotIndex,slotBone);for(let i=0,n=this.data.skins.length;i<n;i++)this.sortPathConstraintAttachment(this.data.skins[i],slotIndex,slotBone);let attachment=slot.getAttachment();attachment instanceof spine.PathAttachment&&this.sortPathConstraintAttachmentWith(attachment,slotBone);let constrained=constraint.bones,boneCount=constrained.length;for(let i=0;i<boneCount;i++)this.sortBone(constrained[i]);this._updateCache.push(constraint);for(let i=0;i<boneCount;i++)this.sortReset(constrained[i].children);for(let i=0;i<boneCount;i++)constrained[i].sorted=!0}sortTransformConstraint(constraint){if(constraint.active=constraint.target.isActive()&&(!constraint.data.skinRequired||null!=this.skin&&spine.Utils.contains(this.skin.constraints,constraint.data,!0)),!constraint.active)return;this.sortBone(constraint.target);let constrained=constraint.bones,boneCount=constrained.length;if(constraint.data.local)for(let i=0;i<boneCount;i++){let child=constrained[i];this.sortBone(child.parent),this._updateCache.indexOf(child)>-1||this.updateCacheReset.push(child)}else for(let i=0;i<boneCount;i++)this.sortBone(constrained[i]);this._updateCache.push(constraint);for(let ii=0;ii<boneCount;ii++)this.sortReset(constrained[ii].children);for(let ii=0;ii<boneCount;ii++)constrained[ii].sorted=!0}sortPathConstraintAttachment(skin,slotIndex,slotBone){let attachments=skin.attachments[slotIndex];if(attachments)for(let key in attachments)this.sortPathConstraintAttachmentWith(attachments[key],slotBone)}sortPathConstraintAttachmentWith(attachment,slotBone){if(!(attachment instanceof spine.PathAttachment))return;let pathBones=attachment.bones;if(null==pathBones)this.sortBone(slotBone);else{let bones=this.bones,i=0;for(;i<pathBones.length;){let boneCount=pathBones[i++];for(let n=i+boneCount;i<n;i++){let boneIndex=pathBones[i];this.sortBone(bones[boneIndex])}}}}sortBone(bone){if(bone.sorted)return;let parent=bone.parent;null!=parent&&this.sortBone(parent),bone.sorted=!0,this._updateCache.push(bone)}sortReset(bones){for(let i=0,n=bones.length;i<n;i++){let bone=bones[i];bone.active&&(bone.sorted&&this.sortReset(bone.children),bone.sorted=!1)}}updateWorldTransform(){let updateCacheReset=this.updateCacheReset;for(let i=0,n=updateCacheReset.length;i<n;i++){let bone=updateCacheReset[i];bone.ax=bone.x,bone.ay=bone.y,bone.arotation=bone.rotation,bone.ascaleX=bone.scaleX,bone.ascaleY=bone.scaleY,bone.ashearX=bone.shearX,bone.ashearY=bone.shearY,bone.appliedValid=!0}let updateCache=this._updateCache;for(let i=0,n=updateCache.length;i<n;i++)updateCache[i].update()}setToSetupPose(){this.setBonesToSetupPose(),this.setSlotsToSetupPose()}setBonesToSetupPose(){let bones=this.bones;for(let i=0,n=bones.length;i<n;i++)bones[i].setToSetupPose();let ikConstraints=this.ikConstraints;for(let i=0,n=ikConstraints.length;i<n;i++){let constraint=ikConstraints[i];constraint.mix=constraint.data.mix,constraint.softness=constraint.data.softness,constraint.bendDirection=constraint.data.bendDirection,constraint.compress=constraint.data.compress,constraint.stretch=constraint.data.stretch}let transformConstraints=this.transformConstraints;for(let i=0,n=transformConstraints.length;i<n;i++){let constraint=transformConstraints[i],data=constraint.data;constraint.rotateMix=data.rotateMix,constraint.translateMix=data.translateMix,constraint.scaleMix=data.scaleMix,constraint.shearMix=data.shearMix}let pathConstraints=this.pathConstraints;for(let i=0,n=pathConstraints.length;i<n;i++){let constraint=pathConstraints[i],data=constraint.data;constraint.position=data.position,constraint.spacing=data.spacing,constraint.rotateMix=data.rotateMix,constraint.translateMix=data.translateMix}}setSlotsToSetupPose(){let slots=this.slots;spine.Utils.arrayCopy(slots,0,this.drawOrder,0,slots.length);for(let i=0,n=slots.length;i<n;i++)slots[i].setToSetupPose()}getRootBone(){return 0==this.bones.length?null:this.bones[0]}findBone(boneName){if(null==boneName)throw new Error("boneName cannot be null.");let bones=this.bones;for(let i=0,n=bones.length;i<n;i++){let bone=bones[i];if(bone.data.name==boneName)return bone}return null}findBoneIndex(boneName){if(null==boneName)throw new Error("boneName cannot be null.");let bones=this.bones;for(let i=0,n=bones.length;i<n;i++)if(bones[i].data.name==boneName)return i;return-1}findSlot(slotName){if(null==slotName)throw new Error("slotName cannot be null.");let slots=this.slots;for(let i=0,n=slots.length;i<n;i++){let slot=slots[i];if(slot.data.name==slotName)return slot}return null}findSlotIndex(slotName){if(null==slotName)throw new Error("slotName cannot be null.");let slots=this.slots;for(let i=0,n=slots.length;i<n;i++)if(slots[i].data.name==slotName)return i;return-1}setSkinByName(skinName){let skin=this.data.findSkin(skinName);if(null==skin)throw new Error("Skin not found: "+skinName);this.setSkin(skin)}setSkin(newSkin){if(newSkin!=this.skin){if(null!=newSkin)if(null!=this.skin)newSkin.attachAll(this,this.skin);else{let slots=this.slots;for(let i=0,n=slots.length;i<n;i++){let slot=slots[i],name=slot.data.attachmentName;if(null!=name){let attachment=newSkin.getAttachment(i,name);null!=attachment&&slot.setAttachment(attachment)}}}this.skin=newSkin,this.updateCache()}}getAttachmentByName(slotName,attachmentName){return this.getAttachment(this.data.findSlotIndex(slotName),attachmentName)}getAttachment(slotIndex,attachmentName){if(null==attachmentName)throw new Error("attachmentName cannot be null.");if(null!=this.skin){let attachment=this.skin.getAttachment(slotIndex,attachmentName);if(null!=attachment)return attachment}return null!=this.data.defaultSkin?this.data.defaultSkin.getAttachment(slotIndex,attachmentName):null}setAttachment(slotName,attachmentName){if(null==slotName)throw new Error("slotName cannot be null.");let slots=this.slots;for(let i=0,n=slots.length;i<n;i++){let slot=slots[i];if(slot.data.name==slotName){let attachment=null;if(null!=attachmentName&&(attachment=this.getAttachment(i,attachmentName),null==attachment))throw new Error("Attachment not found: "+attachmentName+", for slot: "+slotName);return void slot.setAttachment(attachment)}}throw new Error("Slot not found: "+slotName)}findIkConstraint(constraintName){if(null==constraintName)throw new Error("constraintName cannot be null.");let ikConstraints=this.ikConstraints;for(let i=0,n=ikConstraints.length;i<n;i++){let ikConstraint=ikConstraints[i];if(ikConstraint.data.name==constraintName)return ikConstraint}return null}findTransformConstraint(constraintName){if(null==constraintName)throw new Error("constraintName cannot be null.");let transformConstraints=this.transformConstraints;for(let i=0,n=transformConstraints.length;i<n;i++){let constraint=transformConstraints[i];if(constraint.data.name==constraintName)return constraint}return null}findPathConstraint(constraintName){if(null==constraintName)throw new Error("constraintName cannot be null.");let pathConstraints=this.pathConstraints;for(let i=0,n=pathConstraints.length;i<n;i++){let constraint=pathConstraints[i];if(constraint.data.name==constraintName)return constraint}return null}getBounds(offset,size,temp=new Array(2)){if(null==offset)throw new Error("offset cannot be null.");if(null==size)throw new Error("size cannot be null.");let drawOrder=this.drawOrder,minX=Number.POSITIVE_INFINITY,minY=Number.POSITIVE_INFINITY,maxX=Number.NEGATIVE_INFINITY,maxY=Number.NEGATIVE_INFINITY;for(let i=0,n=drawOrder.length;i<n;i++){let slot=drawOrder[i];if(!slot.bone.active)continue;let verticesLength=0,vertices=null,attachment=slot.getAttachment();if(attachment instanceof spine.RegionAttachment)verticesLength=8,vertices=spine.Utils.setArraySize(temp,verticesLength,0),attachment.computeWorldVertices(slot.bone,vertices,0,2);else if(attachment instanceof spine.MeshAttachment){let mesh=attachment;verticesLength=mesh.worldVerticesLength,vertices=spine.Utils.setArraySize(temp,verticesLength,0),mesh.computeWorldVertices(slot,0,verticesLength,vertices,0,2)}if(null!=vertices)for(let ii=0,nn=vertices.length;ii<nn;ii+=2){let x=vertices[ii],y=vertices[ii+1];minX=Math.min(minX,x),minY=Math.min(minY,y),maxX=Math.max(maxX,x),maxY=Math.max(maxY,y)}}offset.set(minX,minY),size.set(maxX-minX,maxY-minY)}update(delta){this.time+=delta}}}(spine||(spine={})),function(spine){let SkeletonBinary=(()=>{class SkeletonBinary{constructor(attachmentLoader){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=attachmentLoader}readSkeletonData(binary){let scale=this.scale,skeletonData=new spine.SkeletonData;skeletonData.name="";let input=new BinaryInput(binary);if(skeletonData.hash=input.readString(),skeletonData.version=input.readString(),"3.8.75"==skeletonData.version)throw new Error("Unsupported skeleton data, please export with a newer version of Spine.");skeletonData.x=input.readFloat(),skeletonData.y=input.readFloat(),skeletonData.width=input.readFloat(),skeletonData.height=input.readFloat();let nonessential=input.readBoolean();nonessential&&(skeletonData.fps=input.readFloat(),skeletonData.imagesPath=input.readString(),skeletonData.audioPath=input.readString());let n=0;n=input.readInt(!0);for(let i=0;i<n;i++)input.strings.push(input.readString());n=input.readInt(!0);for(let i=0;i<n;i++){let name=input.readString(),parent=0==i?null:skeletonData.bones[input.readInt(!0)],data=new spine.BoneData(i,name,parent);data.rotation=input.readFloat(),data.x=input.readFloat()*scale,data.y=input.readFloat()*scale,data.scaleX=input.readFloat(),data.scaleY=input.readFloat(),data.shearX=input.readFloat(),data.shearY=input.readFloat(),data.length=input.readFloat()*scale,data.transformMode=SkeletonBinary.TransformModeValues[input.readInt(!0)],data.skinRequired=input.readBoolean(),nonessential&&spine.Color.rgba8888ToColor(data.color,input.readInt32()),skeletonData.bones.push(data)}n=input.readInt(!0);for(let i=0;i<n;i++){let slotName=input.readString(),boneData=skeletonData.bones[input.readInt(!0)],data=new spine.SlotData(i,slotName,boneData);spine.Color.rgba8888ToColor(data.color,input.readInt32());let darkColor=input.readInt32();-1!=darkColor&&spine.Color.rgb888ToColor(data.darkColor=new spine.Color,darkColor),data.attachmentName=input.readStringRef(),data.blendMode=SkeletonBinary.BlendModeValues[input.readInt(!0)],skeletonData.slots.push(data)}n=input.readInt(!0);for(let nn,i=0;i<n;i++){let data=new spine.IkConstraintData(input.readString());data.order=input.readInt(!0),data.skinRequired=input.readBoolean(),nn=input.readInt(!0);for(let ii=0;ii<nn;ii++)data.bones.push(skeletonData.bones[input.readInt(!0)]);data.target=skeletonData.bones[input.readInt(!0)],data.mix=input.readFloat(),data.softness=input.readFloat()*scale,data.bendDirection=input.readByte(),data.compress=input.readBoolean(),data.stretch=input.readBoolean(),data.uniform=input.readBoolean(),skeletonData.ikConstraints.push(data)}n=input.readInt(!0);for(let nn,i=0;i<n;i++){let data=new spine.TransformConstraintData(input.readString());data.order=input.readInt(!0),data.skinRequired=input.readBoolean(),nn=input.readInt(!0);for(let ii=0;ii<nn;ii++)data.bones.push(skeletonData.bones[input.readInt(!0)]);data.target=skeletonData.bones[input.readInt(!0)],data.local=input.readBoolean(),data.relative=input.readBoolean(),data.offsetRotation=input.readFloat(),data.offsetX=input.readFloat()*scale,data.offsetY=input.readFloat()*scale,data.offsetScaleX=input.readFloat(),data.offsetScaleY=input.readFloat(),data.offsetShearY=input.readFloat(),data.rotateMix=input.readFloat(),data.translateMix=input.readFloat(),data.scaleMix=input.readFloat(),data.shearMix=input.readFloat(),skeletonData.transformConstraints.push(data)}n=input.readInt(!0);for(let nn,i=0;i<n;i++){let data=new spine.PathConstraintData(input.readString());data.order=input.readInt(!0),data.skinRequired=input.readBoolean(),nn=input.readInt(!0);for(let ii=0;ii<nn;ii++)data.bones.push(skeletonData.bones[input.readInt(!0)]);data.target=skeletonData.slots[input.readInt(!0)],data.positionMode=SkeletonBinary.PositionModeValues[input.readInt(!0)],data.spacingMode=SkeletonBinary.SpacingModeValues[input.readInt(!0)],data.rotateMode=SkeletonBinary.RotateModeValues[input.readInt(!0)],data.offsetRotation=input.readFloat(),data.position=input.readFloat(),data.positionMode==spine.PositionMode.Fixed&&(data.position*=scale),data.spacing=input.readFloat(),data.spacingMode!=spine.SpacingMode.Length&&data.spacingMode!=spine.SpacingMode.Fixed||(data.spacing*=scale),data.rotateMix=input.readFloat(),data.translateMix=input.readFloat(),skeletonData.pathConstraints.push(data)}let defaultSkin=this.readSkin(input,skeletonData,!0,nonessential);null!=defaultSkin&&(skeletonData.defaultSkin=defaultSkin,skeletonData.skins.push(defaultSkin));{let i=skeletonData.skins.length;for(spine.Utils.setArraySize(skeletonData.skins,n=i+input.readInt(!0));i<n;i++)skeletonData.skins[i]=this.readSkin(input,skeletonData,!1,nonessential)}n=this.linkedMeshes.length;for(let i=0;i<n;i++){let linkedMesh=this.linkedMeshes[i],skin=null==linkedMesh.skin?skeletonData.defaultSkin:skeletonData.findSkin(linkedMesh.skin);if(null==skin)throw new Error("Skin not found: "+linkedMesh.skin);let parent=skin.getAttachment(linkedMesh.slotIndex,linkedMesh.parent);if(null==parent)throw new Error("Parent mesh not found: "+linkedMesh.parent);linkedMesh.mesh.deformAttachment=linkedMesh.inheritDeform?parent:linkedMesh.mesh,linkedMesh.mesh.setParentMesh(parent),linkedMesh.mesh.updateUVs()}this.linkedMeshes.length=0,n=input.readInt(!0);for(let i=0;i<n;i++){let data=new spine.EventData(input.readStringRef());data.intValue=input.readInt(!1),data.floatValue=input.readFloat(),data.stringValue=input.readString(),data.audioPath=input.readString(),null!=data.audioPath&&(data.volume=input.readFloat(),data.balance=input.readFloat()),skeletonData.events.push(data)}n=input.readInt(!0);for(let i=0;i<n;i++)skeletonData.animations.push(this.readAnimation(input,input.readString(),skeletonData));return skeletonData}readSkin(input,skeletonData,defaultSkin,nonessential){let skin=null,slotCount=0;if(defaultSkin){if(slotCount=input.readInt(!0),0==slotCount)return null;skin=new spine.Skin("default")}else{skin=new spine.Skin(input.readStringRef()),skin.bones.length=input.readInt(!0);for(let i=0,n=skin.bones.length;i<n;i++)skin.bones[i]=skeletonData.bones[input.readInt(!0)];for(let i=0,n=input.readInt(!0);i<n;i++)skin.constraints.push(skeletonData.ikConstraints[input.readInt(!0)]);for(let i=0,n=input.readInt(!0);i<n;i++)skin.constraints.push(skeletonData.transformConstraints[input.readInt(!0)]);for(let i=0,n=input.readInt(!0);i<n;i++)skin.constraints.push(skeletonData.pathConstraints[input.readInt(!0)]);slotCount=input.readInt(!0)}for(let i=0;i<slotCount;i++){let slotIndex=input.readInt(!0);for(let ii=0,nn=input.readInt(!0);ii<nn;ii++){let name=input.readStringRef(),attachment=this.readAttachment(input,skeletonData,skin,slotIndex,name,nonessential);null!=attachment&&skin.setAttachment(slotIndex,name,attachment)}}return skin}readAttachment(input,skeletonData,skin,slotIndex,attachmentName,nonessential){let scale=this.scale,name=input.readStringRef();null==name&&(name=attachmentName);let typeIndex=input.readByte();switch(SkeletonBinary.AttachmentTypeValues[typeIndex]){case spine.AttachmentType.Region:{let path=input.readStringRef(),rotation=input.readFloat(),x=input.readFloat(),y=input.readFloat(),scaleX=input.readFloat(),scaleY=input.readFloat(),width=input.readFloat(),height=input.readFloat(),color=input.readInt32();null==path&&(path=name);let region=this.attachmentLoader.newRegionAttachment(skin,name,path);return null==region?null:(region.path=path,region.x=x*scale,region.y=y*scale,region.scaleX=scaleX,region.scaleY=scaleY,region.rotation=rotation,region.width=width*scale,region.height=height*scale,spine.Color.rgba8888ToColor(region.color,color),region.updateOffset(),region)}case spine.AttachmentType.BoundingBox:{let vertexCount=input.readInt(!0),vertices=this.readVertices(input,vertexCount),color=nonessential?input.readInt32():0,box=this.attachmentLoader.newBoundingBoxAttachment(skin,name);return null==box?null:(box.worldVerticesLength=vertexCount<<1,box.vertices=vertices.vertices,box.bones=vertices.bones,nonessential&&spine.Color.rgba8888ToColor(box.color,color),box)}case spine.AttachmentType.Mesh:{let path=input.readStringRef(),color=input.readInt32(),vertexCount=input.readInt(!0),uvs=this.readFloatArray(input,vertexCount<<1,1),triangles=this.readShortArray(input),vertices=this.readVertices(input,vertexCount),hullLength=input.readInt(!0),edges=null,width=0,height=0;nonessential&&(edges=this.readShortArray(input),width=input.readFloat(),height=input.readFloat()),null==path&&(path=name);let mesh=this.attachmentLoader.newMeshAttachment(skin,name,path);return null==mesh?null:(mesh.path=path,spine.Color.rgba8888ToColor(mesh.color,color),mesh.bones=vertices.bones,mesh.vertices=vertices.vertices,mesh.worldVerticesLength=vertexCount<<1,mesh.triangles=triangles,mesh.regionUVs=uvs,mesh.updateUVs(),mesh.hullLength=hullLength<<1,nonessential&&(mesh.edges=edges,mesh.width=width*scale,mesh.height=height*scale),mesh)}case spine.AttachmentType.LinkedMesh:{let path=input.readStringRef(),color=input.readInt32(),skinName=input.readStringRef(),parent=input.readStringRef(),inheritDeform=input.readBoolean(),width=0,height=0;nonessential&&(width=input.readFloat(),height=input.readFloat()),null==path&&(path=name);let mesh=this.attachmentLoader.newMeshAttachment(skin,name,path);return null==mesh?null:(mesh.path=path,spine.Color.rgba8888ToColor(mesh.color,color),nonessential&&(mesh.width=width*scale,mesh.height=height*scale),this.linkedMeshes.push(new LinkedMesh(mesh,skinName,slotIndex,parent,inheritDeform)),mesh)}case spine.AttachmentType.Path:{let closed=input.readBoolean(),constantSpeed=input.readBoolean(),vertexCount=input.readInt(!0),vertices=this.readVertices(input,vertexCount),lengths=spine.Utils.newArray(vertexCount/3,0);for(let i=0,n=lengths.length;i<n;i++)lengths[i]=input.readFloat()*scale;let color=nonessential?input.readInt32():0,path=this.attachmentLoader.newPathAttachment(skin,name);return null==path?null:(path.closed=closed,path.constantSpeed=constantSpeed,path.worldVerticesLength=vertexCount<<1,path.vertices=vertices.vertices,path.bones=vertices.bones,path.lengths=lengths,nonessential&&spine.Color.rgba8888ToColor(path.color,color),path)}case spine.AttachmentType.Point:{let rotation=input.readFloat(),x=input.readFloat(),y=input.readFloat(),color=nonessential?input.readInt32():0,point=this.attachmentLoader.newPointAttachment(skin,name);return null==point?null:(point.x=x*scale,point.y=y*scale,point.rotation=rotation,nonessential&&spine.Color.rgba8888ToColor(point.color,color),point)}case spine.AttachmentType.Clipping:{let endSlotIndex=input.readInt(!0),vertexCount=input.readInt(!0),vertices=this.readVertices(input,vertexCount),color=nonessential?input.readInt32():0,clip=this.attachmentLoader.newClippingAttachment(skin,name);return null==clip?null:(clip.endSlot=skeletonData.slots[endSlotIndex],clip.worldVerticesLength=vertexCount<<1,clip.vertices=vertices.vertices,clip.bones=vertices.bones,nonessential&&spine.Color.rgba8888ToColor(clip.color,color),clip)}}return null}readVertices(input,vertexCount){let verticesLength=vertexCount<<1,vertices=new Vertices,scale=this.scale;if(!input.readBoolean())return vertices.vertices=this.readFloatArray(input,verticesLength,scale),vertices;let weights=new Array,bonesArray=new Array;for(let i=0;i<vertexCount;i++){let boneCount=input.readInt(!0);bonesArray.push(boneCount);for(let ii=0;ii<boneCount;ii++)bonesArray.push(input.readInt(!0)),weights.push(input.readFloat()*scale),weights.push(input.readFloat()*scale),weights.push(input.readFloat())}return vertices.vertices=spine.Utils.toFloatArray(weights),vertices.bones=bonesArray,vertices}readFloatArray(input,n,scale){let array=new Array(n);if(1==scale)for(let i=0;i<n;i++)array[i]=input.readFloat();else for(let i=0;i<n;i++)array[i]=input.readFloat()*scale;return array}readShortArray(input){let n=input.readInt(!0),array=new Array(n);for(let i=0;i<n;i++)array[i]=input.readShort();return array}readAnimation(input,name,skeletonData){let timelines=new Array,scale=this.scale,duration=0,tempColor1=new spine.Color,tempColor2=new spine.Color;for(let i=0,n=input.readInt(!0);i<n;i++){let slotIndex=input.readInt(!0);for(let ii=0,nn=input.readInt(!0);ii<nn;ii++){let timelineType=input.readByte(),frameCount=input.readInt(!0);switch(timelineType){case SkeletonBinary.SLOT_ATTACHMENT:{let timeline=new spine.AttachmentTimeline(frameCount);timeline.slotIndex=slotIndex;for(let frameIndex=0;frameIndex<frameCount;frameIndex++)timeline.setFrame(frameIndex,input.readFloat(),input.readStringRef());timelines.push(timeline),duration=Math.max(duration,timeline.frames[frameCount-1]);break}case SkeletonBinary.SLOT_COLOR:{let timeline=new spine.ColorTimeline(frameCount);timeline.slotIndex=slotIndex;for(let frameIndex=0;frameIndex<frameCount;frameIndex++){let time=input.readFloat();spine.Color.rgba8888ToColor(tempColor1,input.readInt32()),timeline.setFrame(frameIndex,time,tempColor1.r,tempColor1.g,tempColor1.b,tempColor1.a),frameIndex<frameCount-1&&this.readCurve(input,frameIndex,timeline)}timelines.push(timeline),duration=Math.max(duration,timeline.frames[(frameCount-1)*spine.ColorTimeline.ENTRIES]);break}case SkeletonBinary.SLOT_TWO_COLOR:{let timeline=new spine.TwoColorTimeline(frameCount);timeline.slotIndex=slotIndex;for(let frameIndex=0;frameIndex<frameCount;frameIndex++){let time=input.readFloat();spine.Color.rgba8888ToColor(tempColor1,input.readInt32()),spine.Color.rgb888ToColor(tempColor2,input.readInt32()),timeline.setFrame(frameIndex,time,tempColor1.r,tempColor1.g,tempColor1.b,tempColor1.a,tempColor2.r,tempColor2.g,tempColor2.b),frameIndex<frameCount-1&&this.readCurve(input,frameIndex,timeline)}timelines.push(timeline),duration=Math.max(duration,timeline.frames[(frameCount-1)*spine.TwoColorTimeline.ENTRIES]);break}}}}for(let i=0,n=input.readInt(!0);i<n;i++){let boneIndex=input.readInt(!0);for(let ii=0,nn=input.readInt(!0);ii<nn;ii++){let timelineType=input.readByte(),frameCount=input.readInt(!0);switch(timelineType){case SkeletonBinary.BONE_ROTATE:{let timeline=new spine.RotateTimeline(frameCount);timeline.boneIndex=boneIndex;for(let frameIndex=0;frameIndex<frameCount;frameIndex++)timeline.setFrame(frameIndex,input.readFloat(),input.readFloat()),frameIndex<frameCount-1&&this.readCurve(input,frameIndex,timeline);timelines.push(timeline),duration=Math.max(duration,timeline.frames[(frameCount-1)*spine.RotateTimeline.ENTRIES]);break}case SkeletonBinary.BONE_TRANSLATE:case SkeletonBinary.BONE_SCALE:case SkeletonBinary.BONE_SHEAR:{let timeline,timelineScale=1;timelineType==SkeletonBinary.BONE_SCALE?timeline=new spine.ScaleTimeline(frameCount):timelineType==SkeletonBinary.BONE_SHEAR?timeline=new spine.ShearTimeline(frameCount):(timeline=new spine.TranslateTimeline(frameCount),timelineScale=scale),timeline.boneIndex=boneIndex;for(let frameIndex=0;frameIndex<frameCount;frameIndex++)timeline.setFrame(frameIndex,input.readFloat(),input.readFloat()*timelineScale,input.readFloat()*timelineScale),frameIndex<frameCount-1&&this.readCurve(input,frameIndex,timeline);timelines.push(timeline),duration=Math.max(duration,timeline.frames[(frameCount-1)*spine.TranslateTimeline.ENTRIES]);break}}}}for(let i=0,n=input.readInt(!0);i<n;i++){let index=input.readInt(!0),frameCount=input.readInt(!0),timeline=new spine.IkConstraintTimeline(frameCount);timeline.ikConstraintIndex=index;for(let frameIndex=0;frameIndex<frameCount;frameIndex++)timeline.setFrame(frameIndex,input.readFloat(),input.readFloat(),input.readFloat()*scale,input.readByte(),input.readBoolean(),input.readBoolean()),frameIndex<frameCount-1&&this.readCurve(input,frameIndex,timeline);timelines.push(timeline),duration=Math.max(duration,timeline.frames[(frameCount-1)*spine.IkConstraintTimeline.ENTRIES])}for(let i=0,n=input.readInt(!0);i<n;i++){let index=input.readInt(!0),frameCount=input.readInt(!0),timeline=new spine.TransformConstraintTimeline(frameCount);timeline.transformConstraintIndex=index;for(let frameIndex=0;frameIndex<frameCount;frameIndex++)timeline.setFrame(frameIndex,input.readFloat(),input.readFloat(),input.readFloat(),input.readFloat(),input.readFloat()),frameIndex<frameCount-1&&this.readCurve(input,frameIndex,timeline);timelines.push(timeline),duration=Math.max(duration,timeline.frames[(frameCount-1)*spine.TransformConstraintTimeline.ENTRIES])}for(let i=0,n=input.readInt(!0);i<n;i++){let index=input.readInt(!0),data=skeletonData.pathConstraints[index];for(let ii=0,nn=input.readInt(!0);ii<nn;ii++){let timelineType=input.readByte(),frameCount=input.readInt(!0);switch(timelineType){case SkeletonBinary.PATH_POSITION:case SkeletonBinary.PATH_SPACING:{let timeline,timelineScale=1;timelineType==SkeletonBinary.PATH_SPACING?(timeline=new spine.PathConstraintSpacingTimeline(frameCount),data.spacingMode!=spine.SpacingMode.Length&&data.spacingMode!=spine.SpacingMode.Fixed||(timelineScale=scale)):(timeline=new spine.PathConstraintPositionTimeline(frameCount),data.positionMode==spine.PositionMode.Fixed&&(timelineScale=scale)),timeline.pathConstraintIndex=index;for(let frameIndex=0;frameIndex<frameCount;frameIndex++)timeline.setFrame(frameIndex,input.readFloat(),input.readFloat()*timelineScale),frameIndex<frameCount-1&&this.readCurve(input,frameIndex,timeline);timelines.push(timeline),duration=Math.max(duration,timeline.frames[(frameCount-1)*spine.PathConstraintPositionTimeline.ENTRIES]);break}case SkeletonBinary.PATH_MIX:{let timeline=new spine.PathConstraintMixTimeline(frameCount);timeline.pathConstraintIndex=index;for(let frameIndex=0;frameIndex<frameCount;frameIndex++)timeline.setFrame(frameIndex,input.readFloat(),input.readFloat(),input.readFloat()),frameIndex<frameCount-1&&this.readCurve(input,frameIndex,timeline);timelines.push(timeline),duration=Math.max(duration,timeline.frames[(frameCount-1)*spine.PathConstraintMixTimeline.ENTRIES]);break}}}}for(let i=0,n=input.readInt(!0);i<n;i++){let skin=skeletonData.skins[input.readInt(!0)];for(let ii=0,nn=input.readInt(!0);ii<nn;ii++){let slotIndex=input.readInt(!0);for(let iii=0,nnn=input.readInt(!0);iii<nnn;iii++){let attachment=skin.getAttachment(slotIndex,input.readStringRef()),weighted=null!=attachment.bones,vertices=attachment.vertices,deformLength=weighted?vertices.length/3*2:vertices.length,frameCount=input.readInt(!0),timeline=new spine.DeformTimeline(frameCount);timeline.slotIndex=slotIndex,timeline.attachment=attachment;for(let frameIndex=0;frameIndex<frameCount;frameIndex++){let deform,time=input.readFloat(),end=input.readInt(!0);if(0==end)deform=weighted?spine.Utils.newFloatArray(deformLength):vertices;else{deform=spine.Utils.newFloatArray(deformLength);let start=input.readInt(!0);if(end+=start,1==scale)for(let v=start;v<end;v++)deform[v]=input.readFloat();else for(let v=start;v<end;v++)deform[v]=input.readFloat()*scale;if(!weighted)for(let v=0,vn=deform.length;v<vn;v++)deform[v]+=vertices[v]}timeline.setFrame(frameIndex,time,deform),frameIndex<frameCount-1&&this.readCurve(input,frameIndex,timeline)}timelines.push(timeline),duration=Math.max(duration,timeline.frames[frameCount-1])}}}let drawOrderCount=input.readInt(!0);if(drawOrderCount>0){let timeline=new spine.DrawOrderTimeline(drawOrderCount),slotCount=skeletonData.slots.length;for(let i=0;i<drawOrderCount;i++){let time=input.readFloat(),offsetCount=input.readInt(!0),drawOrder=spine.Utils.newArray(slotCount,0);for(let ii=slotCount-1;ii>=0;ii--)drawOrder[ii]=-1;let unchanged=spine.Utils.newArray(slotCount-offsetCount,0),originalIndex=0,unchangedIndex=0;for(let ii=0;ii<offsetCount;ii++){let slotIndex=input.readInt(!0);for(;originalIndex!=slotIndex;)unchanged[unchangedIndex++]=originalIndex++;drawOrder[originalIndex+input.readInt(!0)]=originalIndex++}for(;originalIndex<slotCount;)unchanged[unchangedIndex++]=originalIndex++;for(let ii=slotCount-1;ii>=0;ii--)-1==drawOrder[ii]&&(drawOrder[ii]=unchanged[--unchangedIndex]);timeline.setFrame(i,time,drawOrder)}timelines.push(timeline),duration=Math.max(duration,timeline.frames[drawOrderCount-1])}let eventCount=input.readInt(!0);if(eventCount>0){let timeline=new spine.EventTimeline(eventCount);for(let i=0;i<eventCount;i++){let time=input.readFloat(),eventData=skeletonData.events[input.readInt(!0)],event=new spine.Event(time,eventData);event.intValue=input.readInt(!1),event.floatValue=input.readFloat(),event.stringValue=input.readBoolean()?input.readString():eventData.stringValue,null!=event.data.audioPath&&(event.volume=input.readFloat(),event.balance=input.readFloat()),timeline.setFrame(i,event)}timelines.push(timeline),duration=Math.max(duration,timeline.frames[eventCount-1])}return new spine.Animation(name,timelines,duration)}readCurve(input,frameIndex,timeline){switch(input.readByte()){case SkeletonBinary.CURVE_STEPPED:timeline.setStepped(frameIndex);break;case SkeletonBinary.CURVE_BEZIER:this.setCurve(timeline,frameIndex,input.readFloat(),input.readFloat(),input.readFloat(),input.readFloat())}}setCurve(timeline,frameIndex,cx1,cy1,cx2,cy2){timeline.setCurve(frameIndex,cx1,cy1,cx2,cy2)}}return SkeletonBinary.AttachmentTypeValues=[0,1,2,3,4,5,6],SkeletonBinary.TransformModeValues=[spine.TransformMode.Normal,spine.TransformMode.OnlyTranslation,spine.TransformMode.NoRotationOrReflection,spine.TransformMode.NoScale,spine.TransformMode.NoScaleOrReflection],SkeletonBinary.PositionModeValues=[spine.PositionMode.Fixed,spine.PositionMode.Percent],SkeletonBinary.SpacingModeValues=[spine.SpacingMode.Length,spine.SpacingMode.Fixed,spine.SpacingMode.Percent],SkeletonBinary.RotateModeValues=[spine.RotateMode.Tangent,spine.RotateMode.Chain,spine.RotateMode.ChainScale],SkeletonBinary.BlendModeValues=[spine.BlendMode.Normal,spine.BlendMode.Additive,spine.BlendMode.Multiply,spine.BlendMode.Screen],SkeletonBinary.BONE_ROTATE=0,SkeletonBinary.BONE_TRANSLATE=1,SkeletonBinary.BONE_SCALE=2,SkeletonBinary.BONE_SHEAR=3,SkeletonBinary.SLOT_ATTACHMENT=0,SkeletonBinary.SLOT_COLOR=1,SkeletonBinary.SLOT_TWO_COLOR=2,SkeletonBinary.PATH_POSITION=0,SkeletonBinary.PATH_SPACING=1,SkeletonBinary.PATH_MIX=2,SkeletonBinary.CURVE_LINEAR=0,SkeletonBinary.CURVE_STEPPED=1,SkeletonBinary.CURVE_BEZIER=2,SkeletonBinary})();spine.SkeletonBinary=SkeletonBinary;class BinaryInput{constructor(data,strings=new Array,index=0,buffer=new DataView(data.buffer)){this.strings=strings,this.index=index,this.buffer=buffer}readByte(){return this.buffer.getInt8(this.index++)}readShort(){let value=this.buffer.getInt16(this.index);return this.index+=2,value}readInt32(){let value=this.buffer.getInt32(this.index);return this.index+=4,value}readInt(optimizePositive){let b=this.readByte(),result=127&b;return 0!=(128&b)&&(b=this.readByte(),result|=(127&b)<<7,0!=(128&b)&&(b=this.readByte(),result|=(127&b)<<14,0!=(128&b)&&(b=this.readByte(),result|=(127&b)<<21,0!=(128&b)&&(b=this.readByte(),result|=(127&b)<<28)))),optimizePositive?result:result>>>1^-(1&result)}readStringRef(){let index=this.readInt(!0);return 0==index?null:this.strings[index-1]}readString(){let byteCount=this.readInt(!0);switch(byteCount){case 0:return null;case 1:return""}byteCount--;let chars="";for(let i=0;i<byteCount;){let b=this.readByte();switch(b>>4){case 12:case 13:chars+=String.fromCharCode((31&b)<<6|63&this.readByte()),i+=2;break;case 14:chars+=String.fromCharCode((15&b)<<12|(63&this.readByte())<<6|63&this.readByte()),i+=3;break;default:chars+=String.fromCharCode(b),i++}}return chars}readFloat(){let value=this.buffer.getFloat32(this.index);return this.index+=4,value}readBoolean(){return 0!=this.readByte()}}class LinkedMesh{constructor(mesh,skin,slotIndex,parent,inheritDeform){this.mesh=mesh,this.skin=skin,this.slotIndex=slotIndex,this.parent=parent,this.inheritDeform=inheritDeform}}class Vertices{constructor(bones=null,vertices=null){this.bones=bones,this.vertices=vertices}}}(spine||(spine={})),function(spine){spine.SkeletonBounds=class SkeletonBounds{constructor(){this.minX=0,this.minY=0,this.maxX=0,this.maxY=0,this.boundingBoxes=new Array,this.polygons=new Array,this.polygonPool=new spine.Pool(()=>spine.Utils.newFloatArray(16))}update(skeleton,updateAabb){if(null==skeleton)throw new Error("skeleton cannot be null.");let boundingBoxes=this.boundingBoxes,polygons=this.polygons,polygonPool=this.polygonPool,slots=skeleton.slots,slotCount=slots.length;boundingBoxes.length=0,polygonPool.freeAll(polygons),polygons.length=0;for(let i=0;i<slotCount;i++){let slot=slots[i];if(!slot.bone.active)continue;let attachment=slot.getAttachment();if(attachment instanceof spine.BoundingBoxAttachment){let boundingBox=attachment;boundingBoxes.push(boundingBox);let polygon=polygonPool.obtain();polygon.length!=boundingBox.worldVerticesLength&&(polygon=spine.Utils.newFloatArray(boundingBox.worldVerticesLength)),polygons.push(polygon),boundingBox.computeWorldVertices(slot,0,boundingBox.worldVerticesLength,polygon,0,2)}}updateAabb?this.aabbCompute():(this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY)}aabbCompute(){let minX=Number.POSITIVE_INFINITY,minY=Number.POSITIVE_INFINITY,maxX=Number.NEGATIVE_INFINITY,maxY=Number.NEGATIVE_INFINITY,polygons=this.polygons;for(let i=0,n=polygons.length;i<n;i++){let polygon=polygons[i],vertices=polygon;for(let ii=0,nn=polygon.length;ii<nn;ii+=2){let x=vertices[ii],y=vertices[ii+1];minX=Math.min(minX,x),minY=Math.min(minY,y),maxX=Math.max(maxX,x),maxY=Math.max(maxY,y)}}this.minX=minX,this.minY=minY,this.maxX=maxX,this.maxY=maxY}aabbContainsPoint(x,y){return x>=this.minX&&x<=this.maxX&&y>=this.minY&&y<=this.maxY}aabbIntersectsSegment(x1,y1,x2,y2){let minX=this.minX,minY=this.minY,maxX=this.maxX,maxY=this.maxY;if(x1<=minX&&x2<=minX||y1<=minY&&y2<=minY||x1>=maxX&&x2>=maxX||y1>=maxY&&y2>=maxY)return!1;let m=(y2-y1)/(x2-x1),y=m*(minX-x1)+y1;if(y>minY&&y<maxY)return!0;if(y=m*(maxX-x1)+y1,y>minY&&y<maxY)return!0;let x=(minY-y1)/m+x1;return x>minX&&x<maxX||(x=(maxY-y1)/m+x1,x>minX&&x<maxX)}aabbIntersectsSkeleton(bounds){return this.minX<bounds.maxX&&this.maxX>bounds.minX&&this.minY<bounds.maxY&&this.maxY>bounds.minY}containsPoint(x,y){let polygons=this.polygons;for(let i=0,n=polygons.length;i<n;i++)if(this.containsPointPolygon(polygons[i],x,y))return this.boundingBoxes[i];return null}containsPointPolygon(polygon,x,y){let vertices=polygon,nn=polygon.length,prevIndex=nn-2,inside=!1;for(let ii=0;ii<nn;ii+=2){let vertexY=vertices[ii+1],prevY=vertices[prevIndex+1];if(vertexY<y&&prevY>=y||prevY<y&&vertexY>=y){let vertexX=vertices[ii];vertexX+(y-vertexY)/(prevY-vertexY)*(vertices[prevIndex]-vertexX)<x&&(inside=!inside)}prevIndex=ii}return inside}intersectsSegment(x1,y1,x2,y2){let polygons=this.polygons;for(let i=0,n=polygons.length;i<n;i++)if(this.intersectsSegmentPolygon(polygons[i],x1,y1,x2,y2))return this.boundingBoxes[i];return null}intersectsSegmentPolygon(polygon,x1,y1,x2,y2){let vertices=polygon,nn=polygon.length,width12=x1-x2,height12=y1-y2,det1=x1*y2-y1*x2,x3=vertices[nn-2],y3=vertices[nn-1];for(let ii=0;ii<nn;ii+=2){let x4=vertices[ii],y4=vertices[ii+1],det2=x3*y4-y3*x4,width34=x3-x4,height34=y3-y4,det3=width12*height34-height12*width34,x=(det1*width34-width12*det2)/det3;if((x>=x3&&x<=x4||x>=x4&&x<=x3)&&(x>=x1&&x<=x2||x>=x2&&x<=x1)){let y=(det1*height34-height12*det2)/det3;if((y>=y3&&y<=y4||y>=y4&&y<=y3)&&(y>=y1&&y<=y2||y>=y2&&y<=y1))return!0}x3=x4,y3=y4}return!1}getPolygon(boundingBox){if(null==boundingBox)throw new Error("boundingBox cannot be null.");let index=this.boundingBoxes.indexOf(boundingBox);return-1==index?null:this.polygons[index]}getWidth(){return this.maxX-this.minX}getHeight(){return this.maxY-this.minY}}}(spine||(spine={})),function(spine){class SkeletonClipping{constructor(){this.triangulator=new spine.Triangulator,this.clippingPolygon=new Array,this.clipOutput=new Array,this.clippedVertices=new Array,this.clippedTriangles=new Array,this.scratch=new Array}clipStart(slot,clip){if(null!=this.clipAttachment)return 0;this.clipAttachment=clip;let n=clip.worldVerticesLength,vertices=spine.Utils.setArraySize(this.clippingPolygon,n);clip.computeWorldVertices(slot,0,n,vertices,0,2);let clippingPolygon=this.clippingPolygon;SkeletonClipping.makeClockwise(clippingPolygon);let clippingPolygons=this.clippingPolygons=this.triangulator.decompose(clippingPolygon,this.triangulator.triangulate(clippingPolygon));for(let i=0,n=clippingPolygons.length;i<n;i++){let polygon=clippingPolygons[i];SkeletonClipping.makeClockwise(polygon),polygon.push(polygon[0]),polygon.push(polygon[1])}return clippingPolygons.length}clipEndWithSlot(slot){null!=this.clipAttachment&&this.clipAttachment.endSlot==slot.data&&this.clipEnd()}clipEnd(){null!=this.clipAttachment&&(this.clipAttachment=null,this.clippingPolygons=null,this.clippedVertices.length=0,this.clippedTriangles.length=0,this.clippingPolygon.length=0)}isClipping(){return null!=this.clipAttachment}clipTriangles(vertices,verticesLength,triangles,trianglesLength,uvs,light,dark,twoColor){let clipOutput=this.clipOutput,clippedVertices=this.clippedVertices,clippedTriangles=this.clippedTriangles,polygons=this.clippingPolygons,polygonsCount=this.clippingPolygons.length,vertexSize=twoColor?12:8,index=0;clippedVertices.length=0,clippedTriangles.length=0;outer:for(let i=0;i<trianglesLength;i+=3){let vertexOffset=triangles[i]<<1,x1=vertices[vertexOffset],y1=vertices[vertexOffset+1],u1=uvs[vertexOffset],v1=uvs[vertexOffset+1];vertexOffset=triangles[i+1]<<1;let x2=vertices[vertexOffset],y2=vertices[vertexOffset+1],u2=uvs[vertexOffset],v2=uvs[vertexOffset+1];vertexOffset=triangles[i+2]<<1;let x3=vertices[vertexOffset],y3=vertices[vertexOffset+1],u3=uvs[vertexOffset],v3=uvs[vertexOffset+1];for(let p=0;p<polygonsCount;p++){let s=clippedVertices.length;if(!this.clip(x1,y1,x2,y2,x3,y3,polygons[p],clipOutput)){let clippedVerticesItems=spine.Utils.setArraySize(clippedVertices,s+3*vertexSize);clippedVerticesItems[s]=x1,clippedVerticesItems[s+1]=y1,clippedVerticesItems[s+2]=light.r,clippedVerticesItems[s+3]=light.g,clippedVerticesItems[s+4]=light.b,clippedVerticesItems[s+5]=light.a,twoColor?(clippedVerticesItems[s+6]=u1,clippedVerticesItems[s+7]=v1,clippedVerticesItems[s+8]=dark.r,clippedVerticesItems[s+9]=dark.g,clippedVerticesItems[s+10]=dark.b,clippedVerticesItems[s+11]=dark.a,clippedVerticesItems[s+12]=x2,clippedVerticesItems[s+13]=y2,clippedVerticesItems[s+14]=light.r,clippedVerticesItems[s+15]=light.g,clippedVerticesItems[s+16]=light.b,clippedVerticesItems[s+17]=light.a,clippedVerticesItems[s+18]=u2,clippedVerticesItems[s+19]=v2,clippedVerticesItems[s+20]=dark.r,clippedVerticesItems[s+21]=dark.g,clippedVerticesItems[s+22]=dark.b,clippedVerticesItems[s+23]=dark.a,clippedVerticesItems[s+24]=x3,clippedVerticesItems[s+25]=y3,clippedVerticesItems[s+26]=light.r,clippedVerticesItems[s+27]=light.g,clippedVerticesItems[s+28]=light.b,clippedVerticesItems[s+29]=light.a,clippedVerticesItems[s+30]=u3,clippedVerticesItems[s+31]=v3,clippedVerticesItems[s+32]=dark.r,clippedVerticesItems[s+33]=dark.g,clippedVerticesItems[s+34]=dark.b,clippedVerticesItems[s+35]=dark.a):(clippedVerticesItems[s+6]=u1,clippedVerticesItems[s+7]=v1,clippedVerticesItems[s+8]=x2,clippedVerticesItems[s+9]=y2,clippedVerticesItems[s+10]=light.r,clippedVerticesItems[s+11]=light.g,clippedVerticesItems[s+12]=light.b,clippedVerticesItems[s+13]=light.a,clippedVerticesItems[s+14]=u2,clippedVerticesItems[s+15]=v2,clippedVerticesItems[s+16]=x3,clippedVerticesItems[s+17]=y3,clippedVerticesItems[s+18]=light.r,clippedVerticesItems[s+19]=light.g,clippedVerticesItems[s+20]=light.b,clippedVerticesItems[s+21]=light.a,clippedVerticesItems[s+22]=u3,clippedVerticesItems[s+23]=v3),s=clippedTriangles.length;let clippedTrianglesItems=spine.Utils.setArraySize(clippedTriangles,s+3);clippedTrianglesItems[s]=index,clippedTrianglesItems[s+1]=index+1,clippedTrianglesItems[s+2]=index+2,index+=3;continue outer}{let clipOutputLength=clipOutput.length;if(0==clipOutputLength)continue;let d0=y2-y3,d1=x3-x2,d2=x1-x3,d4=y3-y1,d=1/(d0*d2+d1*(y1-y3)),clipOutputCount=clipOutputLength>>1,clipOutputItems=this.clipOutput,clippedVerticesItems=spine.Utils.setArraySize(clippedVertices,s+clipOutputCount*vertexSize);for(let ii=0;ii<clipOutputLength;ii+=2){let x=clipOutputItems[ii],y=clipOutputItems[ii+1];clippedVerticesItems[s]=x,clippedVerticesItems[s+1]=y,clippedVerticesItems[s+2]=light.r,clippedVerticesItems[s+3]=light.g,clippedVerticesItems[s+4]=light.b,clippedVerticesItems[s+5]=light.a;let c0=x-x3,c1=y-y3,a=(d0*c0+d1*c1)*d,b=(d4*c0+d2*c1)*d,c=1-a-b;clippedVerticesItems[s+6]=u1*a+u2*b+u3*c,clippedVerticesItems[s+7]=v1*a+v2*b+v3*c,twoColor&&(clippedVerticesItems[s+8]=dark.r,clippedVerticesItems[s+9]=dark.g,clippedVerticesItems[s+10]=dark.b,clippedVerticesItems[s+11]=dark.a),s+=vertexSize}s=clippedTriangles.length;let clippedTrianglesItems=spine.Utils.setArraySize(clippedTriangles,s+3*(clipOutputCount-2));clipOutputCount--;for(let ii=1;ii<clipOutputCount;ii++)clippedTrianglesItems[s]=index,clippedTrianglesItems[s+1]=index+ii,clippedTrianglesItems[s+2]=index+ii+1,s+=3;index+=clipOutputCount+1}}}}clip(x1,y1,x2,y2,x3,y3,clippingArea,output){let originalOutput=output,clipped=!1,input=null;clippingArea.length%4>=2?(input=output,output=this.scratch):input=this.scratch,input.length=0,input.push(x1),input.push(y1),input.push(x2),input.push(y2),input.push(x3),input.push(y3),input.push(x1),input.push(y1),output.length=0;let clippingVertices=clippingArea,clippingVerticesLast=clippingArea.length-4;for(let i=0;;i+=2){let edgeX=clippingVertices[i],edgeY=clippingVertices[i+1],edgeX2=clippingVertices[i+2],edgeY2=clippingVertices[i+3],deltaX=edgeX-edgeX2,deltaY=edgeY-edgeY2,inputVertices=input,inputVerticesLength=input.length-2,outputStart=output.length;for(let ii=0;ii<inputVerticesLength;ii+=2){let inputX=inputVertices[ii],inputY=inputVertices[ii+1],inputX2=inputVertices[ii+2],inputY2=inputVertices[ii+3],side2=deltaX*(inputY2-edgeY2)-deltaY*(inputX2-edgeX2)>0;if(deltaX*(inputY-edgeY2)-deltaY*(inputX-edgeX2)>0){if(side2){output.push(inputX2),output.push(inputY2);continue}let c0=inputY2-inputY,c2=inputX2-inputX,s=c0*(edgeX2-edgeX)-c2*(edgeY2-edgeY);if(Math.abs(s)>1e-6){let ua=(c2*(edgeY-inputY)-c0*(edgeX-inputX))/s;output.push(edgeX+(edgeX2-edgeX)*ua),output.push(edgeY+(edgeY2-edgeY)*ua)}else output.push(edgeX),output.push(edgeY)}else if(side2){let c0=inputY2-inputY,c2=inputX2-inputX,s=c0*(edgeX2-edgeX)-c2*(edgeY2-edgeY);if(Math.abs(s)>1e-6){let ua=(c2*(edgeY-inputY)-c0*(edgeX-inputX))/s;output.push(edgeX+(edgeX2-edgeX)*ua),output.push(edgeY+(edgeY2-edgeY)*ua)}else output.push(edgeX),output.push(edgeY);output.push(inputX2),output.push(inputY2)}clipped=!0}if(outputStart==output.length)return originalOutput.length=0,!0;if(output.push(output[0]),output.push(output[1]),i==clippingVerticesLast)break;let temp=output;(output=input).length=0,input=temp}if(originalOutput!=output){originalOutput.length=0;for(let i=0,n=output.length-2;i<n;i++)originalOutput[i]=output[i]}else originalOutput.length=originalOutput.length-2;return clipped}static makeClockwise(polygon){let vertices=polygon,verticeslength=polygon.length,area=vertices[verticeslength-2]*vertices[1]-vertices[0]*vertices[verticeslength-1],p1x=0,p1y=0,p2x=0,p2y=0;for(let i=0,n=verticeslength-3;i<n;i+=2)p1x=vertices[i],p1y=vertices[i+1],p2x=vertices[i+2],p2y=vertices[i+3],area+=p1x*p2y-p2x*p1y;if(!(area<0))for(let i=0,lastX=verticeslength-2,n=verticeslength>>1;i<n;i+=2){let x=vertices[i],y=vertices[i+1],other=lastX-i;vertices[i]=vertices[other],vertices[i+1]=vertices[other+1],vertices[other]=x,vertices[other+1]=y}}}spine.SkeletonClipping=SkeletonClipping}(spine||(spine={})),function(spine){spine.SkeletonData=class SkeletonData{constructor(){this.bones=new Array,this.slots=new Array,this.skins=new Array,this.events=new Array,this.animations=new Array,this.ikConstraints=new Array,this.transformConstraints=new Array,this.pathConstraints=new Array,this.fps=0}findBone(boneName){if(null==boneName)throw new Error("boneName cannot be null.");let bones=this.bones;for(let i=0,n=bones.length;i<n;i++){let bone=bones[i];if(bone.name==boneName)return bone}return null}findBoneIndex(boneName){if(null==boneName)throw new Error("boneName cannot be null.");let bones=this.bones;for(let i=0,n=bones.length;i<n;i++)if(bones[i].name==boneName)return i;return-1}findSlot(slotName){if(null==slotName)throw new Error("slotName cannot be null.");let slots=this.slots;for(let i=0,n=slots.length;i<n;i++){let slot=slots[i];if(slot.name==slotName)return slot}return null}findSlotIndex(slotName){if(null==slotName)throw new Error("slotName cannot be null.");let slots=this.slots;for(let i=0,n=slots.length;i<n;i++)if(slots[i].name==slotName)return i;return-1}findSkin(skinName){if(null==skinName)throw new Error("skinName cannot be null.");let skins=this.skins;for(let i=0,n=skins.length;i<n;i++){let skin=skins[i];if(skin.name==skinName)return skin}return null}findEvent(eventDataName){if(null==eventDataName)throw new Error("eventDataName cannot be null.");let events=this.events;for(let i=0,n=events.length;i<n;i++){let event=events[i];if(event.name==eventDataName)return event}return null}findAnimation(animationName){if(null==animationName)throw new Error("animationName cannot be null.");let animations=this.animations;for(let i=0,n=animations.length;i<n;i++){let animation=animations[i];if(animation.name==animationName)return animation}return null}findIkConstraint(constraintName){if(null==constraintName)throw new Error("constraintName cannot be null.");let ikConstraints=this.ikConstraints;for(let i=0,n=ikConstraints.length;i<n;i++){let constraint=ikConstraints[i];if(constraint.name==constraintName)return constraint}return null}findTransformConstraint(constraintName){if(null==constraintName)throw new Error("constraintName cannot be null.");let transformConstraints=this.transformConstraints;for(let i=0,n=transformConstraints.length;i<n;i++){let constraint=transformConstraints[i];if(constraint.name==constraintName)return constraint}return null}findPathConstraint(constraintName){if(null==constraintName)throw new Error("constraintName cannot be null.");let pathConstraints=this.pathConstraints;for(let i=0,n=pathConstraints.length;i<n;i++){let constraint=pathConstraints[i];if(constraint.name==constraintName)return constraint}return null}findPathConstraintIndex(pathConstraintName){if(null==pathConstraintName)throw new Error("pathConstraintName cannot be null.");let pathConstraints=this.pathConstraints;for(let i=0,n=pathConstraints.length;i<n;i++)if(pathConstraints[i].name==pathConstraintName)return i;return-1}}}(spine||(spine={})),function(spine){class SkeletonJson{constructor(attachmentLoader){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=attachmentLoader}readSkeletonData(json){let scale=this.scale,skeletonData=new spine.SkeletonData,root="string"==typeof json?JSON.parse(json):json,skeletonMap=root.skeleton;if(null!=skeletonMap){if(skeletonData.hash=skeletonMap.hash,skeletonData.version=skeletonMap.spine,"3.8.75"==skeletonData.version)throw new Error("Unsupported skeleton data, please export with a newer version of Spine.");skeletonData.x=skeletonMap.x,skeletonData.y=skeletonMap.y,skeletonData.width=skeletonMap.width,skeletonData.height=skeletonMap.height,skeletonData.fps=skeletonMap.fps,skeletonData.imagesPath=skeletonMap.images}if(root.bones)for(let i=0;i<root.bones.length;i++){let boneMap=root.bones[i],parent=null,parentName=this.getValue(boneMap,"parent",null);if(null!=parentName&&(parent=skeletonData.findBone(parentName),null==parent))throw new Error("Parent bone not found: "+parentName);let data=new spine.BoneData(skeletonData.bones.length,boneMap.name,parent);data.length=this.getValue(boneMap,"length",0)*scale,data.x=this.getValue(boneMap,"x",0)*scale,data.y=this.getValue(boneMap,"y",0)*scale,data.rotation=this.getValue(boneMap,"rotation",0),data.scaleX=this.getValue(boneMap,"scaleX",1),data.scaleY=this.getValue(boneMap,"scaleY",1),data.shearX=this.getValue(boneMap,"shearX",0),data.shearY=this.getValue(boneMap,"shearY",0),data.transformMode=SkeletonJson.transformModeFromString(this.getValue(boneMap,"transform","normal")),data.skinRequired=this.getValue(boneMap,"skin",!1),skeletonData.bones.push(data)}if(root.slots)for(let i=0;i<root.slots.length;i++){let slotMap=root.slots[i],slotName=slotMap.name,boneName=slotMap.bone,boneData=skeletonData.findBone(boneName);if(null==boneData)throw new Error("Slot bone not found: "+boneName);let data=new spine.SlotData(skeletonData.slots.length,slotName,boneData),color=this.getValue(slotMap,"color",null);null!=color&&data.color.setFromString(color);let dark=this.getValue(slotMap,"dark",null);null!=dark&&(data.darkColor=new spine.Color(1,1,1,1),data.darkColor.setFromString(dark)),data.attachmentName=this.getValue(slotMap,"attachment",null),data.blendMode=SkeletonJson.blendModeFromString(this.getValue(slotMap,"blend","normal")),skeletonData.slots.push(data)}if(root.ik)for(let i=0;i<root.ik.length;i++){let constraintMap=root.ik[i],data=new spine.IkConstraintData(constraintMap.name);data.order=this.getValue(constraintMap,"order",0),data.skinRequired=this.getValue(constraintMap,"skin",!1);for(let j=0;j<constraintMap.bones.length;j++){let boneName=constraintMap.bones[j],bone=skeletonData.findBone(boneName);if(null==bone)throw new Error("IK bone not found: "+boneName);data.bones.push(bone)}let targetName=constraintMap.target;if(data.target=skeletonData.findBone(targetName),null==data.target)throw new Error("IK target bone not found: "+targetName);data.mix=this.getValue(constraintMap,"mix",1),data.softness=this.getValue(constraintMap,"softness",0)*scale,data.bendDirection=this.getValue(constraintMap,"bendPositive",!0)?1:-1,data.compress=this.getValue(constraintMap,"compress",!1),data.stretch=this.getValue(constraintMap,"stretch",!1),data.uniform=this.getValue(constraintMap,"uniform",!1),skeletonData.ikConstraints.push(data)}if(root.transform)for(let i=0;i<root.transform.length;i++){let constraintMap=root.transform[i],data=new spine.TransformConstraintData(constraintMap.name);data.order=this.getValue(constraintMap,"order",0),data.skinRequired=this.getValue(constraintMap,"skin",!1);for(let j=0;j<constraintMap.bones.length;j++){let boneName=constraintMap.bones[j],bone=skeletonData.findBone(boneName);if(null==bone)throw new Error("Transform constraint bone not found: "+boneName);data.bones.push(bone)}let targetName=constraintMap.target;if(data.target=skeletonData.findBone(targetName),null==data.target)throw new Error("Transform constraint target bone not found: "+targetName);data.local=this.getValue(constraintMap,"local",!1),data.relative=this.getValue(constraintMap,"relative",!1),data.offsetRotation=this.getValue(constraintMap,"rotation",0),data.offsetX=this.getValue(constraintMap,"x",0)*scale,data.offsetY=this.getValue(constraintMap,"y",0)*scale,data.offsetScaleX=this.getValue(constraintMap,"scaleX",0),data.offsetScaleY=this.getValue(constraintMap,"scaleY",0),data.offsetShearY=this.getValue(constraintMap,"shearY",0),data.rotateMix=this.getValue(constraintMap,"rotateMix",1),data.translateMix=this.getValue(constraintMap,"translateMix",1),data.scaleMix=this.getValue(constraintMap,"scaleMix",1),data.shearMix=this.getValue(constraintMap,"shearMix",1),skeletonData.transformConstraints.push(data)}if(root.path)for(let i=0;i<root.path.length;i++){let constraintMap=root.path[i],data=new spine.PathConstraintData(constraintMap.name);data.order=this.getValue(constraintMap,"order",0),data.skinRequired=this.getValue(constraintMap,"skin",!1);for(let j=0;j<constraintMap.bones.length;j++){let boneName=constraintMap.bones[j],bone=skeletonData.findBone(boneName);if(null==bone)throw new Error("Transform constraint bone not found: "+boneName);data.bones.push(bone)}let targetName=constraintMap.target;if(data.target=skeletonData.findSlot(targetName),null==data.target)throw new Error("Path target slot not found: "+targetName);data.positionMode=SkeletonJson.positionModeFromString(this.getValue(constraintMap,"positionMode","percent")),data.spacingMode=SkeletonJson.spacingModeFromString(this.getValue(constraintMap,"spacingMode","length")),data.rotateMode=SkeletonJson.rotateModeFromString(this.getValue(constraintMap,"rotateMode","tangent")),data.offsetRotation=this.getValue(constraintMap,"rotation",0),data.position=this.getValue(constraintMap,"position",0),data.positionMode==spine.PositionMode.Fixed&&(data.position*=scale),data.spacing=this.getValue(constraintMap,"spacing",0),data.spacingMode!=spine.SpacingMode.Length&&data.spacingMode!=spine.SpacingMode.Fixed||(data.spacing*=scale),data.rotateMix=this.getValue(constraintMap,"rotateMix",1),data.translateMix=this.getValue(constraintMap,"translateMix",1),skeletonData.pathConstraints.push(data)}if(root.skins)for(let i=0;i<root.skins.length;i++){let skinMap=root.skins[i],skin=new spine.Skin(skinMap.name);if(skinMap.bones)for(let ii=0;ii<skinMap.bones.length;ii++){let bone=skeletonData.findBone(skinMap.bones[ii]);if(null==bone)throw new Error("Skin bone not found: "+skinMap.bones[i]);skin.bones.push(bone)}if(skinMap.ik)for(let ii=0;ii<skinMap.ik.length;ii++){let constraint=skeletonData.findIkConstraint(skinMap.ik[ii]);if(null==constraint)throw new Error("Skin IK constraint not found: "+skinMap.ik[i]);skin.constraints.push(constraint)}if(skinMap.transform)for(let ii=0;ii<skinMap.transform.length;ii++){let constraint=skeletonData.findTransformConstraint(skinMap.transform[ii]);if(null==constraint)throw new Error("Skin transform constraint not found: "+skinMap.transform[i]);skin.constraints.push(constraint)}if(skinMap.path)for(let ii=0;ii<skinMap.path.length;ii++){let constraint=skeletonData.findPathConstraint(skinMap.path[ii]);if(null==constraint)throw new Error("Skin path constraint not found: "+skinMap.path[i]);skin.constraints.push(constraint)}for(let slotName in skinMap.attachments){let slot=skeletonData.findSlot(slotName);if(null==slot)throw new Error("Slot not found: "+slotName);let slotMap=skinMap.attachments[slotName];for(let entryName in slotMap){let attachment=this.readAttachment(slotMap[entryName],skin,slot.index,entryName,skeletonData);null!=attachment&&skin.setAttachment(slot.index,entryName,attachment)}}skeletonData.skins.push(skin),"default"==skin.name&&(skeletonData.defaultSkin=skin)}for(let i=0,n=this.linkedMeshes.length;i<n;i++){let linkedMesh=this.linkedMeshes[i],skin=null==linkedMesh.skin?skeletonData.defaultSkin:skeletonData.findSkin(linkedMesh.skin);if(null==skin)throw new Error("Skin not found: "+linkedMesh.skin);let parent=skin.getAttachment(linkedMesh.slotIndex,linkedMesh.parent);if(null==parent)throw new Error("Parent mesh not found: "+linkedMesh.parent);linkedMesh.mesh.deformAttachment=linkedMesh.inheritDeform?parent:linkedMesh.mesh,linkedMesh.mesh.setParentMesh(parent),linkedMesh.mesh.updateUVs()}if(this.linkedMeshes.length=0,root.events)for(let eventName in root.events){let eventMap=root.events[eventName],data=new spine.EventData(eventName);data.intValue=this.getValue(eventMap,"int",0),data.floatValue=this.getValue(eventMap,"float",0),data.stringValue=this.getValue(eventMap,"string",""),data.audioPath=this.getValue(eventMap,"audio",null),null!=data.audioPath&&(data.volume=this.getValue(eventMap,"volume",1),data.balance=this.getValue(eventMap,"balance",0)),skeletonData.events.push(data)}if(root.animations)for(let animationName in root.animations){let animationMap=root.animations[animationName];this.readAnimation(animationMap,animationName,skeletonData)}return skeletonData}readAttachment(map,skin,slotIndex,name,skeletonData){let scale=this.scale;switch(name=this.getValue(map,"name",name),this.getValue(map,"type","region")){case"region":{let path=this.getValue(map,"path",name),region=this.attachmentLoader.newRegionAttachment(skin,name,path);if(null==region)return null;region.path=path,region.x=this.getValue(map,"x",0)*scale,region.y=this.getValue(map,"y",0)*scale,region.scaleX=this.getValue(map,"scaleX",1),region.scaleY=this.getValue(map,"scaleY",1),region.rotation=this.getValue(map,"rotation",0),region.width=map.width*scale,region.height=map.height*scale;let color=this.getValue(map,"color",null);return null!=color&&region.color.setFromString(color),region.updateOffset(),region}case"boundingbox":{let box=this.attachmentLoader.newBoundingBoxAttachment(skin,name);if(null==box)return null;this.readVertices(map,box,map.vertexCount<<1);let color=this.getValue(map,"color",null);return null!=color&&box.color.setFromString(color),box}case"mesh":case"linkedmesh":{let path=this.getValue(map,"path",name),mesh=this.attachmentLoader.newMeshAttachment(skin,name,path);if(null==mesh)return null;mesh.path=path;let color=this.getValue(map,"color",null);null!=color&&mesh.color.setFromString(color),mesh.width=this.getValue(map,"width",0)*scale,mesh.height=this.getValue(map,"height",0)*scale;let parent=this.getValue(map,"parent",null);if(null!=parent)return this.linkedMeshes.push(new LinkedMesh(mesh,this.getValue(map,"skin",null),slotIndex,parent,this.getValue(map,"deform",!0))),mesh;let uvs=map.uvs;return this.readVertices(map,mesh,uvs.length),mesh.triangles=map.triangles,mesh.regionUVs=uvs,mesh.updateUVs(),mesh.edges=this.getValue(map,"edges",null),mesh.hullLength=2*this.getValue(map,"hull",0),mesh}case"path":{let path=this.attachmentLoader.newPathAttachment(skin,name);if(null==path)return null;path.closed=this.getValue(map,"closed",!1),path.constantSpeed=this.getValue(map,"constantSpeed",!0);let vertexCount=map.vertexCount;this.readVertices(map,path,vertexCount<<1);let lengths=spine.Utils.newArray(vertexCount/3,0);for(let i=0;i<map.lengths.length;i++)lengths[i]=map.lengths[i]*scale;path.lengths=lengths;let color=this.getValue(map,"color",null);return null!=color&&path.color.setFromString(color),path}case"point":{let point=this.attachmentLoader.newPointAttachment(skin,name);if(null==point)return null;point.x=this.getValue(map,"x",0)*scale,point.y=this.getValue(map,"y",0)*scale,point.rotation=this.getValue(map,"rotation",0);let color=this.getValue(map,"color",null);return null!=color&&point.color.setFromString(color),point}case"clipping":{let clip=this.attachmentLoader.newClippingAttachment(skin,name);if(null==clip)return null;let end=this.getValue(map,"end",null);if(null!=end){let slot=skeletonData.findSlot(end);if(null==slot)throw new Error("Clipping end slot not found: "+end);clip.endSlot=slot}let vertexCount=map.vertexCount;this.readVertices(map,clip,vertexCount<<1);let color=this.getValue(map,"color",null);return null!=color&&clip.color.setFromString(color),clip}}return null}readVertices(map,attachment,verticesLength){let scale=this.scale;attachment.worldVerticesLength=verticesLength;let vertices=map.vertices;if(verticesLength==vertices.length){let scaledVertices=spine.Utils.toFloatArray(vertices);if(1!=scale)for(let i=0,n=vertices.length;i<n;i++)scaledVertices[i]*=scale;return void(attachment.vertices=scaledVertices)}let weights=new Array,bones=new Array;for(let i=0,n=vertices.length;i<n;){let boneCount=vertices[i++];bones.push(boneCount);for(let nn=i+4*boneCount;i<nn;i+=4)bones.push(vertices[i]),weights.push(vertices[i+1]*scale),weights.push(vertices[i+2]*scale),weights.push(vertices[i+3])}attachment.bones=bones,attachment.vertices=spine.Utils.toFloatArray(weights)}readAnimation(map,name,skeletonData){let scale=this.scale,timelines=new Array,duration=0;if(map.slots)for(let slotName in map.slots){let slotMap=map.slots[slotName],slotIndex=skeletonData.findSlotIndex(slotName);if(-1==slotIndex)throw new Error("Slot not found: "+slotName);for(let timelineName in slotMap){let timelineMap=slotMap[timelineName];if("attachment"==timelineName){let timeline=new spine.AttachmentTimeline(timelineMap.length);timeline.slotIndex=slotIndex;let frameIndex=0;for(let i=0;i<timelineMap.length;i++){let valueMap=timelineMap[i];timeline.setFrame(frameIndex++,this.getValue(valueMap,"time",0),valueMap.name)}timelines.push(timeline),duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1])}else if("color"==timelineName){let timeline=new spine.ColorTimeline(timelineMap.length);timeline.slotIndex=slotIndex;let frameIndex=0;for(let i=0;i<timelineMap.length;i++){let valueMap=timelineMap[i],color=new spine.Color;color.setFromString(valueMap.color),timeline.setFrame(frameIndex,this.getValue(valueMap,"time",0),color.r,color.g,color.b,color.a),this.readCurve(valueMap,timeline,frameIndex),frameIndex++}timelines.push(timeline),duration=Math.max(duration,timeline.frames[(timeline.getFrameCount()-1)*spine.ColorTimeline.ENTRIES])}else{if("twoColor"!=timelineName)throw new Error("Invalid timeline type for a slot: "+timelineName+" ("+slotName+")");{let timeline=new spine.TwoColorTimeline(timelineMap.length);timeline.slotIndex=slotIndex;let frameIndex=0;for(let i=0;i<timelineMap.length;i++){let valueMap=timelineMap[i],light=new spine.Color,dark=new spine.Color;light.setFromString(valueMap.light),dark.setFromString(valueMap.dark),timeline.setFrame(frameIndex,this.getValue(valueMap,"time",0),light.r,light.g,light.b,light.a,dark.r,dark.g,dark.b),this.readCurve(valueMap,timeline,frameIndex),frameIndex++}timelines.push(timeline),duration=Math.max(duration,timeline.frames[(timeline.getFrameCount()-1)*spine.TwoColorTimeline.ENTRIES])}}}}if(map.bones)for(let boneName in map.bones){let boneMap=map.bones[boneName],boneIndex=skeletonData.findBoneIndex(boneName);if(-1==boneIndex)throw new Error("Bone not found: "+boneName);for(let timelineName in boneMap){let timelineMap=boneMap[timelineName];if("rotate"===timelineName){let timeline=new spine.RotateTimeline(timelineMap.length);timeline.boneIndex=boneIndex;let frameIndex=0;for(let i=0;i<timelineMap.length;i++){let valueMap=timelineMap[i];timeline.setFrame(frameIndex,this.getValue(valueMap,"time",0),this.getValue(valueMap,"angle",0)),this.readCurve(valueMap,timeline,frameIndex),frameIndex++}timelines.push(timeline),duration=Math.max(duration,timeline.frames[(timeline.getFrameCount()-1)*spine.RotateTimeline.ENTRIES])}else{if("translate"!==timelineName&&"scale"!==timelineName&&"shear"!==timelineName)throw new Error("Invalid timeline type for a bone: "+timelineName+" ("+boneName+")");{let timeline=null,timelineScale=1,defaultValue=0;"scale"===timelineName?(timeline=new spine.ScaleTimeline(timelineMap.length),defaultValue=1):"shear"===timelineName?timeline=new spine.ShearTimeline(timelineMap.length):(timeline=new spine.TranslateTimeline(timelineMap.length),timelineScale=scale),timeline.boneIndex=boneIndex;let frameIndex=0;for(let i=0;i<timelineMap.length;i++){let valueMap=timelineMap[i],x=this.getValue(valueMap,"x",defaultValue),y=this.getValue(valueMap,"y",defaultValue);timeline.setFrame(frameIndex,this.getValue(valueMap,"time",0),x*timelineScale,y*timelineScale),this.readCurve(valueMap,timeline,frameIndex),frameIndex++}timelines.push(timeline),duration=Math.max(duration,timeline.frames[(timeline.getFrameCount()-1)*spine.TranslateTimeline.ENTRIES])}}}}if(map.ik)for(let constraintName in map.ik){let constraintMap=map.ik[constraintName],constraint=skeletonData.findIkConstraint(constraintName),timeline=new spine.IkConstraintTimeline(constraintMap.length);timeline.ikConstraintIndex=skeletonData.ikConstraints.indexOf(constraint);let frameIndex=0;for(let i=0;i<constraintMap.length;i++){let valueMap=constraintMap[i];timeline.setFrame(frameIndex,this.getValue(valueMap,"time",0),this.getValue(valueMap,"mix",1),this.getValue(valueMap,"softness",0)*scale,this.getValue(valueMap,"bendPositive",!0)?1:-1,this.getValue(valueMap,"compress",!1),this.getValue(valueMap,"stretch",!1)),this.readCurve(valueMap,timeline,frameIndex),frameIndex++}timelines.push(timeline),duration=Math.max(duration,timeline.frames[(timeline.getFrameCount()-1)*spine.IkConstraintTimeline.ENTRIES])}if(map.transform)for(let constraintName in map.transform){let constraintMap=map.transform[constraintName],constraint=skeletonData.findTransformConstraint(constraintName),timeline=new spine.TransformConstraintTimeline(constraintMap.length);timeline.transformConstraintIndex=skeletonData.transformConstraints.indexOf(constraint);let frameIndex=0;for(let i=0;i<constraintMap.length;i++){let valueMap=constraintMap[i];timeline.setFrame(frameIndex,this.getValue(valueMap,"time",0),this.getValue(valueMap,"rotateMix",1),this.getValue(valueMap,"translateMix",1),this.getValue(valueMap,"scaleMix",1),this.getValue(valueMap,"shearMix",1)),this.readCurve(valueMap,timeline,frameIndex),frameIndex++}timelines.push(timeline),duration=Math.max(duration,timeline.frames[(timeline.getFrameCount()-1)*spine.TransformConstraintTimeline.ENTRIES])}if(map.path)for(let constraintName in map.path){let constraintMap=map.path[constraintName],index=skeletonData.findPathConstraintIndex(constraintName);if(-1==index)throw new Error("Path constraint not found: "+constraintName);let data=skeletonData.pathConstraints[index];for(let timelineName in constraintMap){let timelineMap=constraintMap[timelineName];if("position"===timelineName||"spacing"===timelineName){let timeline=null,timelineScale=1;"spacing"===timelineName?(timeline=new spine.PathConstraintSpacingTimeline(timelineMap.length),data.spacingMode!=spine.SpacingMode.Length&&data.spacingMode!=spine.SpacingMode.Fixed||(timelineScale=scale)):(timeline=new spine.PathConstraintPositionTimeline(timelineMap.length),data.positionMode==spine.PositionMode.Fixed&&(timelineScale=scale)),timeline.pathConstraintIndex=index;let frameIndex=0;for(let i=0;i<timelineMap.length;i++){let valueMap=timelineMap[i];timeline.setFrame(frameIndex,this.getValue(valueMap,"time",0),this.getValue(valueMap,timelineName,0)*timelineScale),this.readCurve(valueMap,timeline,frameIndex),frameIndex++}timelines.push(timeline),duration=Math.max(duration,timeline.frames[(timeline.getFrameCount()-1)*spine.PathConstraintPositionTimeline.ENTRIES])}else if("mix"===timelineName){let timeline=new spine.PathConstraintMixTimeline(timelineMap.length);timeline.pathConstraintIndex=index;let frameIndex=0;for(let i=0;i<timelineMap.length;i++){let valueMap=timelineMap[i];timeline.setFrame(frameIndex,this.getValue(valueMap,"time",0),this.getValue(valueMap,"rotateMix",1),this.getValue(valueMap,"translateMix",1)),this.readCurve(valueMap,timeline,frameIndex),frameIndex++}timelines.push(timeline),duration=Math.max(duration,timeline.frames[(timeline.getFrameCount()-1)*spine.PathConstraintMixTimeline.ENTRIES])}}}if(map.deform)for(let deformName in map.deform){let deformMap=map.deform[deformName],skin=skeletonData.findSkin(deformName);if(null==skin)throw new Error("Skin not found: "+deformName);for(let slotName in deformMap){let slotMap=deformMap[slotName],slotIndex=skeletonData.findSlotIndex(slotName);if(-1==slotIndex)throw new Error("Slot not found: "+slotMap.name);for(let timelineName in slotMap){let timelineMap=slotMap[timelineName],attachment=skin.getAttachment(slotIndex,timelineName);if(null==attachment)throw new Error("Deform attachment not found: "+timelineMap.name);let weighted=null!=attachment.bones,vertices=attachment.vertices,deformLength=weighted?vertices.length/3*2:vertices.length,timeline=new spine.DeformTimeline(timelineMap.length);timeline.slotIndex=slotIndex,timeline.attachment=attachment;let frameIndex=0;for(let j=0;j<timelineMap.length;j++){let deform,valueMap=timelineMap[j],verticesValue=this.getValue(valueMap,"vertices",null);if(null==verticesValue)deform=weighted?spine.Utils.newFloatArray(deformLength):vertices;else{deform=spine.Utils.newFloatArray(deformLength);let start=this.getValue(valueMap,"offset",0);if(spine.Utils.arrayCopy(verticesValue,0,deform,start,verticesValue.length),1!=scale)for(let i=start,n=i+verticesValue.length;i<n;i++)deform[i]*=scale;if(!weighted)for(let i=0;i<deformLength;i++)deform[i]+=vertices[i]}timeline.setFrame(frameIndex,this.getValue(valueMap,"time",0),deform),this.readCurve(valueMap,timeline,frameIndex),frameIndex++}timelines.push(timeline),duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1])}}}let drawOrderNode=map.drawOrder;if(null==drawOrderNode&&(drawOrderNode=map.draworder),null!=drawOrderNode){let timeline=new spine.DrawOrderTimeline(drawOrderNode.length),slotCount=skeletonData.slots.length,frameIndex=0;for(let j=0;j<drawOrderNode.length;j++){let drawOrderMap=drawOrderNode[j],drawOrder=null,offsets=this.getValue(drawOrderMap,"offsets",null);if(null!=offsets){drawOrder=spine.Utils.newArray(slotCount,-1);let unchanged=spine.Utils.newArray(slotCount-offsets.length,0),originalIndex=0,unchangedIndex=0;for(let i=0;i<offsets.length;i++){let offsetMap=offsets[i],slotIndex=skeletonData.findSlotIndex(offsetMap.slot);if(-1==slotIndex)throw new Error("Slot not found: "+offsetMap.slot);for(;originalIndex!=slotIndex;)unchanged[unchangedIndex++]=originalIndex++;drawOrder[originalIndex+offsetMap.offset]=originalIndex++}for(;originalIndex<slotCount;)unchanged[unchangedIndex++]=originalIndex++;for(let i=slotCount-1;i>=0;i--)-1==drawOrder[i]&&(drawOrder[i]=unchanged[--unchangedIndex])}timeline.setFrame(frameIndex++,this.getValue(drawOrderMap,"time",0),drawOrder)}timelines.push(timeline),duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1])}if(map.events){let timeline=new spine.EventTimeline(map.events.length),frameIndex=0;for(let i=0;i<map.events.length;i++){let eventMap=map.events[i],eventData=skeletonData.findEvent(eventMap.name);if(null==eventData)throw new Error("Event not found: "+eventMap.name);let event=new spine.Event(spine.Utils.toSinglePrecision(this.getValue(eventMap,"time",0)),eventData);event.intValue=this.getValue(eventMap,"int",eventData.intValue),event.floatValue=this.getValue(eventMap,"float",eventData.floatValue),event.stringValue=this.getValue(eventMap,"string",eventData.stringValue),null!=event.data.audioPath&&(event.volume=this.getValue(eventMap,"volume",1),event.balance=this.getValue(eventMap,"balance",0)),timeline.setFrame(frameIndex++,event)}timelines.push(timeline),duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1])}if(isNaN(duration))throw new Error("Error while parsing animation, duration is NaN");skeletonData.animations.push(new spine.Animation(name,timelines,duration))}readCurve(map,timeline,frameIndex){if(map.hasOwnProperty("curve"))if("stepped"==map.curve)timeline.setStepped(frameIndex);else{let curve=map.curve;timeline.setCurve(frameIndex,curve,this.getValue(map,"c2",0),this.getValue(map,"c3",1),this.getValue(map,"c4",1))}}getValue(map,prop,defaultValue){return void 0!==map[prop]?map[prop]:defaultValue}static blendModeFromString(str){if("normal"==(str=str.toLowerCase()))return spine.BlendMode.Normal;if("additive"==str)return spine.BlendMode.Additive;if("multiply"==str)return spine.BlendMode.Multiply;if("screen"==str)return spine.BlendMode.Screen;throw new Error("Unknown blend mode: "+str)}static positionModeFromString(str){if("fixed"==(str=str.toLowerCase()))return spine.PositionMode.Fixed;if("percent"==str)return spine.PositionMode.Percent;throw new Error("Unknown position mode: "+str)}static spacingModeFromString(str){if("length"==(str=str.toLowerCase()))return spine.SpacingMode.Length;if("fixed"==str)return spine.SpacingMode.Fixed;if("percent"==str)return spine.SpacingMode.Percent;throw new Error("Unknown position mode: "+str)}static rotateModeFromString(str){if("tangent"==(str=str.toLowerCase()))return spine.RotateMode.Tangent;if("chain"==str)return spine.RotateMode.Chain;if("chainscale"==str)return spine.RotateMode.ChainScale;throw new Error("Unknown rotate mode: "+str)}static transformModeFromString(str){if("normal"==(str=str.toLowerCase()))return spine.TransformMode.Normal;if("onlytranslation"==str)return spine.TransformMode.OnlyTranslation;if("norotationorreflection"==str)return spine.TransformMode.NoRotationOrReflection;if("noscale"==str)return spine.TransformMode.NoScale;if("noscaleorreflection"==str)return spine.TransformMode.NoScaleOrReflection;throw new Error("Unknown transform mode: "+str)}}spine.SkeletonJson=SkeletonJson;class LinkedMesh{constructor(mesh,skin,slotIndex,parent,inheritDeform){this.mesh=mesh,this.skin=skin,this.slotIndex=slotIndex,this.parent=parent,this.inheritDeform=inheritDeform}}}(spine||(spine={})),function(spine){class SkinEntry{constructor(slotIndex,name,attachment){this.slotIndex=slotIndex,this.name=name,this.attachment=attachment}}spine.SkinEntry=SkinEntry;spine.Skin=class Skin{constructor(name){if(this.attachments=new Array,this.bones=Array(),this.constraints=new Array,null==name)throw new Error("name cannot be null.");this.name=name}setAttachment(slotIndex,name,attachment){if(null==attachment)throw new Error("attachment cannot be null.");let attachments=this.attachments;slotIndex>=attachments.length&&(attachments.length=slotIndex+1),attachments[slotIndex]||(attachments[slotIndex]={}),attachments[slotIndex][name]=attachment}addSkin(skin){for(let i=0;i<skin.bones.length;i++){let bone=skin.bones[i],contained=!1;for(let j=0;j<this.bones.length;j++)if(this.bones[j]==bone){contained=!0;break}contained||this.bones.push(bone)}for(let i=0;i<skin.constraints.length;i++){let constraint=skin.constraints[i],contained=!1;for(let j=0;j<this.constraints.length;j++)if(this.constraints[j]==constraint){contained=!0;break}contained||this.constraints.push(constraint)}let attachments=skin.getAttachments();for(let i=0;i<attachments.length;i++){var attachment=attachments[i];this.setAttachment(attachment.slotIndex,attachment.name,attachment.attachment)}}copySkin(skin){for(let i=0;i<skin.bones.length;i++){let bone=skin.bones[i],contained=!1;for(let j=0;j<this.bones.length;j++)if(this.bones[j]==bone){contained=!0;break}contained||this.bones.push(bone)}for(let i=0;i<skin.constraints.length;i++){let constraint=skin.constraints[i],contained=!1;for(let j=0;j<this.constraints.length;j++)if(this.constraints[j]==constraint){contained=!0;break}contained||this.constraints.push(constraint)}let attachments=skin.getAttachments();for(let i=0;i<attachments.length;i++){var attachment=attachments[i];null!=attachment.attachment&&(attachment.attachment instanceof spine.MeshAttachment?(attachment.attachment=attachment.attachment.newLinkedMesh(),this.setAttachment(attachment.slotIndex,attachment.name,attachment.attachment)):(attachment.attachment=attachment.attachment.copy(),this.setAttachment(attachment.slotIndex,attachment.name,attachment.attachment)))}}getAttachment(slotIndex,name){let dictionary=this.attachments[slotIndex];return dictionary?dictionary[name]:null}removeAttachment(slotIndex,name){let dictionary=this.attachments[slotIndex];dictionary&&(dictionary[name]=null)}getAttachments(){let entries=new Array;for(var i=0;i<this.attachments.length;i++){let slotAttachments=this.attachments[i];if(slotAttachments)for(let name in slotAttachments){let attachment=slotAttachments[name];attachment&&entries.push(new SkinEntry(i,name,attachment))}}return entries}getAttachmentsForSlot(slotIndex,attachments){let slotAttachments=this.attachments[slotIndex];if(slotAttachments)for(let name in slotAttachments){let attachment=slotAttachments[name];attachment&&attachments.push(new SkinEntry(slotIndex,name,attachment))}}clear(){this.attachments.length=0,this.bones.length=0,this.constraints.length=0}attachAll(skeleton,oldSkin){let slotIndex=0;for(let i=0;i<skeleton.slots.length;i++){let slot=skeleton.slots[i],slotAttachment=slot.getAttachment();if(slotAttachment&&slotIndex<oldSkin.attachments.length){let dictionary=oldSkin.attachments[slotIndex];for(let key in dictionary){if(slotAttachment==dictionary[key]){let attachment=this.getAttachment(slotIndex,key);null!=attachment&&slot.setAttachment(attachment);break}}}slotIndex++}}}}(spine||(spine={})),function(spine){spine.Slot=class Slot{constructor(data,bone){if(this.deform=new Array,null==data)throw new Error("data cannot be null.");if(null==bone)throw new Error("bone cannot be null.");this.data=data,this.bone=bone,this.color=new spine.Color,this.darkColor=null==data.darkColor?null:new spine.Color,this.setToSetupPose()}getSkeleton(){return this.bone.skeleton}getAttachment(){return this.attachment}setAttachment(attachment){this.attachment!=attachment&&(this.attachment=attachment,this.attachmentTime=this.bone.skeleton.time,this.deform.length=0)}setAttachmentTime(time){this.attachmentTime=this.bone.skeleton.time-time}getAttachmentTime(){return this.bone.skeleton.time-this.attachmentTime}setToSetupPose(){this.color.setFromColor(this.data.color),null!=this.darkColor&&this.darkColor.setFromColor(this.data.darkColor),null==this.data.attachmentName?this.attachment=null:(this.attachment=null,this.setAttachment(this.bone.skeleton.getAttachment(this.data.index,this.data.attachmentName)))}}}(spine||(spine={})),function(spine){spine.SlotData=class SlotData{constructor(index,name,boneData){if(this.color=new spine.Color(1,1,1,1),index<0)throw new Error("index must be >= 0.");if(null==name)throw new Error("name cannot be null.");if(null==boneData)throw new Error("boneData cannot be null.");this.index=index,this.name=name,this.boneData=boneData}}}(spine||(spine={})),function(spine){class Texture{constructor(image){this._image=image}getImage(){return this._image}static filterFromString(text){switch(text.toLowerCase()){case"nearest":return TextureFilter.Nearest;case"linear":return TextureFilter.Linear;case"mipmap":return TextureFilter.MipMap;case"mipmapnearestnearest":return TextureFilter.MipMapNearestNearest;case"mipmaplinearnearest":return TextureFilter.MipMapLinearNearest;case"mipmapnearestlinear":return TextureFilter.MipMapNearestLinear;case"mipmaplinearlinear":return TextureFilter.MipMapLinearLinear;default:throw new Error("Unknown texture filter "+text)}}static wrapFromString(text){switch(text.toLowerCase()){case"mirroredtepeat":return TextureWrap.MirroredRepeat;case"clamptoedge":return TextureWrap.ClampToEdge;case"repeat":return TextureWrap.Repeat;default:throw new Error("Unknown texture wrap "+text)}}}let TextureFilter,TextureWrap;spine.Texture=Texture,function(TextureFilter){TextureFilter[TextureFilter.Nearest=9728]="Nearest",TextureFilter[TextureFilter.Linear=9729]="Linear",TextureFilter[TextureFilter.MipMap=9987]="MipMap",TextureFilter[TextureFilter.MipMapNearestNearest=9984]="MipMapNearestNearest",TextureFilter[TextureFilter.MipMapLinearNearest=9985]="MipMapLinearNearest",TextureFilter[TextureFilter.MipMapNearestLinear=9986]="MipMapNearestLinear",TextureFilter[TextureFilter.MipMapLinearLinear=9987]="MipMapLinearLinear"}(TextureFilter=spine.TextureFilter||(spine.TextureFilter={})),function(TextureWrap){TextureWrap[TextureWrap.MirroredRepeat=33648]="MirroredRepeat",TextureWrap[TextureWrap.ClampToEdge=33071]="ClampToEdge",TextureWrap[TextureWrap.Repeat=10497]="Repeat"}(TextureWrap=spine.TextureWrap||(spine.TextureWrap={}));spine.TextureRegion=class TextureRegion{constructor(){this.u=0,this.v=0,this.u2=0,this.v2=0,this.width=0,this.height=0,this.rotate=!1,this.offsetX=0,this.offsetY=0,this.originalWidth=0,this.originalHeight=0}};spine.FakeTexture=class FakeTexture extends Texture{setFilters(minFilter,magFilter){}setWraps(uWrap,vWrap){}dispose(){}}}(spine||(spine={})),function(spine){spine.TextureAtlas=class TextureAtlas{constructor(atlasText,textureLoader){this.pages=new Array,this.regions=new Array,this.load(atlasText,textureLoader)}load(atlasText,textureLoader){if(null==textureLoader)throw new Error("textureLoader cannot be null.");let reader=new TextureAtlasReader(atlasText),tuple=new Array(4),page=null;for(;;){let line=reader.readLine();if(null==line)break;if(line=line.trim(),0==line.length)page=null;else if(page){let region=new TextureAtlasRegion;region.name=line,region.page=page;let rotateValue=reader.readValue();"true"==rotateValue.toLocaleLowerCase()?region.degrees=90:"false"==rotateValue.toLocaleLowerCase()?region.degrees=0:region.degrees=parseFloat(rotateValue),region.rotate=90==region.degrees,reader.readTuple(tuple);let x=parseInt(tuple[0]),y=parseInt(tuple[1]);reader.readTuple(tuple);let width=parseInt(tuple[0]),height=parseInt(tuple[1]);region.u=x/page.width,region.v=y/page.height,region.rotate?(region.u2=(x+height)/page.width,region.v2=(y+width)/page.height):(region.u2=(x+width)/page.width,region.v2=(y+height)/page.height),region.x=x,region.y=y,region.width=Math.abs(width),region.height=Math.abs(height),4==reader.readTuple(tuple)&&4==reader.readTuple(tuple)&&reader.readTuple(tuple),region.originalWidth=parseInt(tuple[0]),region.originalHeight=parseInt(tuple[1]),reader.readTuple(tuple),region.offsetX=parseInt(tuple[0]),region.offsetY=parseInt(tuple[1]),region.index=parseInt(reader.readValue()),region.texture=page.texture,this.regions.push(region)}else{page=new TextureAtlasPage,page.name=line,2==reader.readTuple(tuple)&&(page.width=parseInt(tuple[0]),page.height=parseInt(tuple[1]),reader.readTuple(tuple)),reader.readTuple(tuple),page.minFilter=spine.Texture.filterFromString(tuple[0]),page.magFilter=spine.Texture.filterFromString(tuple[1]);let direction=reader.readValue();page.uWrap=spine.TextureWrap.ClampToEdge,page.vWrap=spine.TextureWrap.ClampToEdge,"x"==direction?page.uWrap=spine.TextureWrap.Repeat:"y"==direction?page.vWrap=spine.TextureWrap.Repeat:"xy"==direction&&(page.uWrap=page.vWrap=spine.TextureWrap.Repeat),page.texture=textureLoader(line),page.texture.setFilters(page.minFilter,page.magFilter),page.texture.setWraps(page.uWrap,page.vWrap),page.width=page.texture.getImage().width,page.height=page.texture.getImage().height,this.pages.push(page)}}}findRegion(name){for(let i=0;i<this.regions.length;i++)if(this.regions[i].name==name)return this.regions[i];return null}dispose(){for(let i=0;i<this.pages.length;i++)this.pages[i].texture.dispose()}};class TextureAtlasReader{constructor(text){this.index=0,this.lines=text.split(/\r\n|\r|\n/)}readLine(){return this.index>=this.lines.length?null:this.lines[this.index++]}readValue(){let line=this.readLine(),colon=line.indexOf(":");if(-1==colon)throw new Error("Invalid line: "+line);return line.substring(colon+1).trim()}readTuple(tuple){let line=this.readLine(),colon=line.indexOf(":");if(-1==colon)throw new Error("Invalid line: "+line);let i=0,lastMatch=colon+1;for(;i<3;i++){let comma=line.indexOf(",",lastMatch);if(-1==comma)break;tuple[i]=line.substr(lastMatch,comma-lastMatch).trim(),lastMatch=comma+1}return tuple[i]=line.substring(lastMatch).trim(),i+1}}class TextureAtlasPage{}spine.TextureAtlasPage=TextureAtlasPage;class TextureAtlasRegion extends spine.TextureRegion{}spine.TextureAtlasRegion=TextureAtlasRegion}(spine||(spine={})),function(spine){spine.TransformConstraint=class TransformConstraint{constructor(data,skeleton){if(this.rotateMix=0,this.translateMix=0,this.scaleMix=0,this.shearMix=0,this.temp=new spine.Vector2,this.active=!1,null==data)throw new Error("data cannot be null.");if(null==skeleton)throw new Error("skeleton cannot be null.");this.data=data,this.rotateMix=data.rotateMix,this.translateMix=data.translateMix,this.scaleMix=data.scaleMix,this.shearMix=data.shearMix,this.bones=new Array;for(let i=0;i<data.bones.length;i++)this.bones.push(skeleton.findBone(data.bones[i].name));this.target=skeleton.findBone(data.target.name)}isActive(){return this.active}apply(){this.update()}update(){this.data.local?this.data.relative?this.applyRelativeLocal():this.applyAbsoluteLocal():this.data.relative?this.applyRelativeWorld():this.applyAbsoluteWorld()}applyAbsoluteWorld(){let rotateMix=this.rotateMix,translateMix=this.translateMix,scaleMix=this.scaleMix,shearMix=this.shearMix,target=this.target,ta=target.a,tb=target.b,tc=target.c,td=target.d,degRadReflect=ta*td-tb*tc>0?spine.MathUtils.degRad:-spine.MathUtils.degRad,offsetRotation=this.data.offsetRotation*degRadReflect,offsetShearY=this.data.offsetShearY*degRadReflect,bones=this.bones;for(let i=0,n=bones.length;i<n;i++){let bone=bones[i],modified=!1;if(0!=rotateMix){let a=bone.a,b=bone.b,c=bone.c,d=bone.d,r=Math.atan2(tc,ta)-Math.atan2(c,a)+offsetRotation;r>spine.MathUtils.PI?r-=spine.MathUtils.PI2:r<-spine.MathUtils.PI&&(r+=spine.MathUtils.PI2),r*=rotateMix;let cos=Math.cos(r),sin=Math.sin(r);bone.a=cos*a-sin*c,bone.b=cos*b-sin*d,bone.c=sin*a+cos*c,bone.d=sin*b+cos*d,modified=!0}if(0!=translateMix){let temp=this.temp;target.localToWorld(temp.set(this.data.offsetX,this.data.offsetY)),bone.worldX+=(temp.x-bone.worldX)*translateMix,bone.worldY+=(temp.y-bone.worldY)*translateMix,modified=!0}if(scaleMix>0){let s=Math.sqrt(bone.a*bone.a+bone.c*bone.c),ts=Math.sqrt(ta*ta+tc*tc);s>1e-5&&(s=(s+(ts-s+this.data.offsetScaleX)*scaleMix)/s),bone.a*=s,bone.c*=s,s=Math.sqrt(bone.b*bone.b+bone.d*bone.d),ts=Math.sqrt(tb*tb+td*td),s>1e-5&&(s=(s+(ts-s+this.data.offsetScaleY)*scaleMix)/s),bone.b*=s,bone.d*=s,modified=!0}if(shearMix>0){let b=bone.b,d=bone.d,by=Math.atan2(d,b),r=Math.atan2(td,tb)-Math.atan2(tc,ta)-(by-Math.atan2(bone.c,bone.a));r>spine.MathUtils.PI?r-=spine.MathUtils.PI2:r<-spine.MathUtils.PI&&(r+=spine.MathUtils.PI2),r=by+(r+offsetShearY)*shearMix;let s=Math.sqrt(b*b+d*d);bone.b=Math.cos(r)*s,bone.d=Math.sin(r)*s,modified=!0}modified&&(bone.appliedValid=!1)}}applyRelativeWorld(){let rotateMix=this.rotateMix,translateMix=this.translateMix,scaleMix=this.scaleMix,shearMix=this.shearMix,target=this.target,ta=target.a,tb=target.b,tc=target.c,td=target.d,degRadReflect=ta*td-tb*tc>0?spine.MathUtils.degRad:-spine.MathUtils.degRad,offsetRotation=this.data.offsetRotation*degRadReflect,offsetShearY=this.data.offsetShearY*degRadReflect,bones=this.bones;for(let i=0,n=bones.length;i<n;i++){let bone=bones[i],modified=!1;if(0!=rotateMix){let a=bone.a,b=bone.b,c=bone.c,d=bone.d,r=Math.atan2(tc,ta)+offsetRotation;r>spine.MathUtils.PI?r-=spine.MathUtils.PI2:r<-spine.MathUtils.PI&&(r+=spine.MathUtils.PI2),r*=rotateMix;let cos=Math.cos(r),sin=Math.sin(r);bone.a=cos*a-sin*c,bone.b=cos*b-sin*d,bone.c=sin*a+cos*c,bone.d=sin*b+cos*d,modified=!0}if(0!=translateMix){let temp=this.temp;target.localToWorld(temp.set(this.data.offsetX,this.data.offsetY)),bone.worldX+=temp.x*translateMix,bone.worldY+=temp.y*translateMix,modified=!0}if(scaleMix>0){let s=(Math.sqrt(ta*ta+tc*tc)-1+this.data.offsetScaleX)*scaleMix+1;bone.a*=s,bone.c*=s,s=(Math.sqrt(tb*tb+td*td)-1+this.data.offsetScaleY)*scaleMix+1,bone.b*=s,bone.d*=s,modified=!0}if(shearMix>0){let r=Math.atan2(td,tb)-Math.atan2(tc,ta);r>spine.MathUtils.PI?r-=spine.MathUtils.PI2:r<-spine.MathUtils.PI&&(r+=spine.MathUtils.PI2);let b=bone.b,d=bone.d;r=Math.atan2(d,b)+(r-spine.MathUtils.PI/2+offsetShearY)*shearMix;let s=Math.sqrt(b*b+d*d);bone.b=Math.cos(r)*s,bone.d=Math.sin(r)*s,modified=!0}modified&&(bone.appliedValid=!1)}}applyAbsoluteLocal(){let rotateMix=this.rotateMix,translateMix=this.translateMix,scaleMix=this.scaleMix,shearMix=this.shearMix,target=this.target;target.appliedValid||target.updateAppliedTransform();let bones=this.bones;for(let i=0,n=bones.length;i<n;i++){let bone=bones[i];bone.appliedValid||bone.updateAppliedTransform();let rotation=bone.arotation;if(0!=rotateMix){let r=target.arotation-rotation+this.data.offsetRotation;r-=360*(16384-(16384.499999999996-r/360|0)),rotation+=r*rotateMix}let x=bone.ax,y=bone.ay;0!=translateMix&&(x+=(target.ax-x+this.data.offsetX)*translateMix,y+=(target.ay-y+this.data.offsetY)*translateMix);let scaleX=bone.ascaleX,scaleY=bone.ascaleY;0!=scaleMix&&(scaleX>1e-5&&(scaleX=(scaleX+(target.ascaleX-scaleX+this.data.offsetScaleX)*scaleMix)/scaleX),scaleY>1e-5&&(scaleY=(scaleY+(target.ascaleY-scaleY+this.data.offsetScaleY)*scaleMix)/scaleY));let shearY=bone.ashearY;if(0!=shearMix){let r=target.ashearY-shearY+this.data.offsetShearY;r-=360*(16384-(16384.499999999996-r/360|0)),bone.shearY+=r*shearMix}bone.updateWorldTransformWith(x,y,rotation,scaleX,scaleY,bone.ashearX,shearY)}}applyRelativeLocal(){let rotateMix=this.rotateMix,translateMix=this.translateMix,scaleMix=this.scaleMix,shearMix=this.shearMix,target=this.target;target.appliedValid||target.updateAppliedTransform();let bones=this.bones;for(let i=0,n=bones.length;i<n;i++){let bone=bones[i];bone.appliedValid||bone.updateAppliedTransform();let rotation=bone.arotation;0!=rotateMix&&(rotation+=(target.arotation+this.data.offsetRotation)*rotateMix);let x=bone.ax,y=bone.ay;0!=translateMix&&(x+=(target.ax+this.data.offsetX)*translateMix,y+=(target.ay+this.data.offsetY)*translateMix);let scaleX=bone.ascaleX,scaleY=bone.ascaleY;0!=scaleMix&&(scaleX>1e-5&&(scaleX*=(target.ascaleX-1+this.data.offsetScaleX)*scaleMix+1),scaleY>1e-5&&(scaleY*=(target.ascaleY-1+this.data.offsetScaleY)*scaleMix+1));let shearY=bone.ashearY;0!=shearMix&&(shearY+=(target.ashearY+this.data.offsetShearY)*shearMix),bone.updateWorldTransformWith(x,y,rotation,scaleX,scaleY,bone.ashearX,shearY)}}}}(spine||(spine={})),function(spine){class TransformConstraintData extends spine.ConstraintData{constructor(name){super(name,0,!1),this.bones=new Array,this.rotateMix=0,this.translateMix=0,this.scaleMix=0,this.shearMix=0,this.offsetRotation=0,this.offsetX=0,this.offsetY=0,this.offsetScaleX=0,this.offsetScaleY=0,this.offsetShearY=0,this.relative=!1,this.local=!1}}spine.TransformConstraintData=TransformConstraintData}(spine||(spine={})),function(spine){class Triangulator{constructor(){this.convexPolygons=new Array,this.convexPolygonsIndices=new Array,this.indicesArray=new Array,this.isConcaveArray=new Array,this.triangles=new Array,this.polygonPool=new spine.Pool(()=>new Array),this.polygonIndicesPool=new spine.Pool(()=>new Array)}triangulate(verticesArray){let vertices=verticesArray,vertexCount=verticesArray.length>>1,indices=this.indicesArray;indices.length=0;for(let i=0;i<vertexCount;i++)indices[i]=i;let isConcave=this.isConcaveArray;isConcave.length=0;for(let i=0,n=vertexCount;i<n;++i)isConcave[i]=Triangulator.isConcave(i,vertexCount,vertices,indices);let triangles=this.triangles;for(triangles.length=0;vertexCount>3;){let previous=vertexCount-1,i=0,next=1;for(;;){outer:if(!isConcave[i]){let p1=indices[previous]<<1,p2=indices[i]<<1,p3=indices[next]<<1,p1x=vertices[p1],p1y=vertices[p1+1],p2x=vertices[p2],p2y=vertices[p2+1],p3x=vertices[p3],p3y=vertices[p3+1];for(let ii=(next+1)%vertexCount;ii!=previous;ii=(ii+1)%vertexCount){if(!isConcave[ii])continue;let v=indices[ii]<<1,vx=vertices[v],vy=vertices[v+1];if(Triangulator.positiveArea(p3x,p3y,p1x,p1y,vx,vy)&&Triangulator.positiveArea(p1x,p1y,p2x,p2y,vx,vy)&&Triangulator.positiveArea(p2x,p2y,p3x,p3y,vx,vy))break outer}break}if(0==next){do{if(!isConcave[i])break;i--}while(i>0);break}previous=i,i=next,next=(next+1)%vertexCount}triangles.push(indices[(vertexCount+i-1)%vertexCount]),triangles.push(indices[i]),triangles.push(indices[(i+1)%vertexCount]),indices.splice(i,1),isConcave.splice(i,1),vertexCount--;let previousIndex=(vertexCount+i-1)%vertexCount,nextIndex=i==vertexCount?0:i;isConcave[previousIndex]=Triangulator.isConcave(previousIndex,vertexCount,vertices,indices),isConcave[nextIndex]=Triangulator.isConcave(nextIndex,vertexCount,vertices,indices)}return 3==vertexCount&&(triangles.push(indices[2]),triangles.push(indices[0]),triangles.push(indices[1])),triangles}decompose(verticesArray,triangles){let vertices=verticesArray,convexPolygons=this.convexPolygons;this.polygonPool.freeAll(convexPolygons),convexPolygons.length=0;let convexPolygonsIndices=this.convexPolygonsIndices;this.polygonIndicesPool.freeAll(convexPolygonsIndices),convexPolygonsIndices.length=0;let polygonIndices=this.polygonIndicesPool.obtain();polygonIndices.length=0;let polygon=this.polygonPool.obtain();polygon.length=0;let fanBaseIndex=-1,lastWinding=0;for(let i=0,n=triangles.length;i<n;i+=3){let t1=triangles[i]<<1,t2=triangles[i+1]<<1,t3=triangles[i+2]<<1,x1=vertices[t1],y1=vertices[t1+1],x2=vertices[t2],y2=vertices[t2+1],x3=vertices[t3],y3=vertices[t3+1],merged=!1;if(fanBaseIndex==t1){let o=polygon.length-4,winding1=Triangulator.winding(polygon[o],polygon[o+1],polygon[o+2],polygon[o+3],x3,y3),winding2=Triangulator.winding(x3,y3,polygon[0],polygon[1],polygon[2],polygon[3]);winding1==lastWinding&&winding2==lastWinding&&(polygon.push(x3),polygon.push(y3),polygonIndices.push(t3),merged=!0)}merged||(polygon.length>0?(convexPolygons.push(polygon),convexPolygonsIndices.push(polygonIndices)):(this.polygonPool.free(polygon),this.polygonIndicesPool.free(polygonIndices)),polygon=this.polygonPool.obtain(),polygon.length=0,polygon.push(x1),polygon.push(y1),polygon.push(x2),polygon.push(y2),polygon.push(x3),polygon.push(y3),polygonIndices=this.polygonIndicesPool.obtain(),polygonIndices.length=0,polygonIndices.push(t1),polygonIndices.push(t2),polygonIndices.push(t3),lastWinding=Triangulator.winding(x1,y1,x2,y2,x3,y3),fanBaseIndex=t1)}polygon.length>0&&(convexPolygons.push(polygon),convexPolygonsIndices.push(polygonIndices));for(let i=0,n=convexPolygons.length;i<n;i++){if(polygonIndices=convexPolygonsIndices[i],0==polygonIndices.length)continue;let firstIndex=polygonIndices[0],lastIndex=polygonIndices[polygonIndices.length-1];polygon=convexPolygons[i];let o=polygon.length-4,prevPrevX=polygon[o],prevPrevY=polygon[o+1],prevX=polygon[o+2],prevY=polygon[o+3],firstX=polygon[0],firstY=polygon[1],secondX=polygon[2],secondY=polygon[3],winding=Triangulator.winding(prevPrevX,prevPrevY,prevX,prevY,firstX,firstY);for(let ii=0;ii<n;ii++){if(ii==i)continue;let otherIndices=convexPolygonsIndices[ii];if(3!=otherIndices.length)continue;let otherFirstIndex=otherIndices[0],otherSecondIndex=otherIndices[1],otherLastIndex=otherIndices[2],otherPoly=convexPolygons[ii],x3=otherPoly[otherPoly.length-2],y3=otherPoly[otherPoly.length-1];if(otherFirstIndex!=firstIndex||otherSecondIndex!=lastIndex)continue;let winding1=Triangulator.winding(prevPrevX,prevPrevY,prevX,prevY,x3,y3),winding2=Triangulator.winding(x3,y3,firstX,firstY,secondX,secondY);winding1==winding&&winding2==winding&&(otherPoly.length=0,otherIndices.length=0,polygon.push(x3),polygon.push(y3),polygonIndices.push(otherLastIndex),prevPrevX=prevX,prevPrevY=prevY,prevX=x3,prevY=y3,ii=0)}}for(let i=convexPolygons.length-1;i>=0;i--)polygon=convexPolygons[i],0==polygon.length&&(convexPolygons.splice(i,1),this.polygonPool.free(polygon),polygonIndices=convexPolygonsIndices[i],convexPolygonsIndices.splice(i,1),this.polygonIndicesPool.free(polygonIndices));return convexPolygons}static isConcave(index,vertexCount,vertices,indices){let previous=indices[(vertexCount+index-1)%vertexCount]<<1,current=indices[index]<<1,next=indices[(index+1)%vertexCount]<<1;return!this.positiveArea(vertices[previous],vertices[previous+1],vertices[current],vertices[current+1],vertices[next],vertices[next+1])}static positiveArea(p1x,p1y,p2x,p2y,p3x,p3y){return p1x*(p3y-p2y)+p2x*(p1y-p3y)+p3x*(p2y-p1y)>=0}static winding(p1x,p1y,p2x,p2y,p3x,p3y){let px=p2x-p1x,py=p2y-p1y;return p3x*py-p3y*px+px*p1y-p1x*py>=0?1:-1}}spine.Triangulator=Triangulator}(spine||(spine={})),function(spine){spine.IntSet=class IntSet{constructor(){this.array=new Array}add(value){let contains=this.contains(value);return this.array[0|value]=0|value,!contains}contains(value){return null!=this.array[0|value]}remove(value){this.array[0|value]=void 0}clear(){this.array.length=0}};let Color=(()=>{class Color{constructor(r=0,g=0,b=0,a=0){this.r=r,this.g=g,this.b=b,this.a=a}set(r,g,b,a){return this.r=r,this.g=g,this.b=b,this.a=a,this.clamp(),this}setFromColor(c){return this.r=c.r,this.g=c.g,this.b=c.b,this.a=c.a,this}setFromString(hex){return hex="#"==hex.charAt(0)?hex.substr(1):hex,this.r=parseInt(hex.substr(0,2),16)/255,this.g=parseInt(hex.substr(2,2),16)/255,this.b=parseInt(hex.substr(4,2),16)/255,this.a=(8!=hex.length?255:parseInt(hex.substr(6,2),16))/255,this}add(r,g,b,a){return this.r+=r,this.g+=g,this.b+=b,this.a+=a,this.clamp(),this}clamp(){return this.r<0?this.r=0:this.r>1&&(this.r=1),this.g<0?this.g=0:this.g>1&&(this.g=1),this.b<0?this.b=0:this.b>1&&(this.b=1),this.a<0?this.a=0:this.a>1&&(this.a=1),this}static rgba8888ToColor(color,value){color.r=((4278190080&value)>>>24)/255,color.g=((16711680&value)>>>16)/255,color.b=((65280&value)>>>8)/255,color.a=(255&value)/255}static rgb888ToColor(color,value){color.r=((16711680&value)>>>16)/255,color.g=((65280&value)>>>8)/255,color.b=(255&value)/255}}return Color.WHITE=new Color(1,1,1,1),Color.RED=new Color(1,0,0,1),Color.GREEN=new Color(0,1,0,1),Color.BLUE=new Color(0,0,1,1),Color.MAGENTA=new Color(1,0,1,1),Color})();spine.Color=Color;let MathUtils=(()=>{class MathUtils{static clamp(value,min,max){return value<min?min:value>max?max:value}static cosDeg(degrees){return Math.cos(degrees*MathUtils.degRad)}static sinDeg(degrees){return Math.sin(degrees*MathUtils.degRad)}static signum(value){return value>0?1:value<0?-1:0}static toInt(x){return x>0?Math.floor(x):Math.ceil(x)}static cbrt(x){let y=Math.pow(Math.abs(x),1/3);return x<0?-y:y}static randomTriangular(min,max){return MathUtils.randomTriangularWith(min,max,.5*(min+max))}static randomTriangularWith(min,max,mode){let u=Math.random(),d=max-min;return u<=(mode-min)/d?min+Math.sqrt(u*d*(mode-min)):max-Math.sqrt((1-u)*d*(max-mode))}}return MathUtils.PI=3.1415927,MathUtils.PI2=2*MathUtils.PI,MathUtils.radiansToDegrees=180/MathUtils.PI,MathUtils.radDeg=MathUtils.radiansToDegrees,MathUtils.degreesToRadians=MathUtils.PI/180,MathUtils.degRad=MathUtils.degreesToRadians,MathUtils})();spine.MathUtils=MathUtils;class Interpolation{apply(start,end,a){return start+(end-start)*this.applyInternal(a)}}spine.Interpolation=Interpolation;class Pow extends Interpolation{constructor(power){super(),this.power=2,this.power=power}applyInternal(a){return a<=.5?Math.pow(2*a,this.power)/2:Math.pow(2*(a-1),this.power)/(this.power%2==0?-2:2)+1}}spine.Pow=Pow;spine.PowOut=class PowOut extends Pow{constructor(power){super(power)}applyInternal(a){return Math.pow(a-1,this.power)*(this.power%2==0?-1:1)+1}};let Utils=(()=>{class Utils{static arrayCopy(source,sourceStart,dest,destStart,numElements){for(let i=sourceStart,j=destStart;i<sourceStart+numElements;i++,j++)dest[j]=source[i]}static setArraySize(array,size,value=0){let oldSize=array.length;if(oldSize==size)return array;if(array.length=size,oldSize<size)for(let i=oldSize;i<size;i++)array[i]=value;return array}static ensureArrayCapacity(array,size,value=0){return array.length>=size?array:Utils.setArraySize(array,size,value)}static newArray(size,defaultValue){let array=new Array(size);for(let i=0;i<size;i++)array[i]=defaultValue;return array}static newFloatArray(size){if(Utils.SUPPORTS_TYPED_ARRAYS)return new Float32Array(size);{let array=new Array(size);for(let i=0;i<array.length;i++)array[i]=0;return array}}static newShortArray(size){if(Utils.SUPPORTS_TYPED_ARRAYS)return new Int16Array(size);{let array=new Array(size);for(let i=0;i<array.length;i++)array[i]=0;return array}}static toFloatArray(array){return Utils.SUPPORTS_TYPED_ARRAYS?new Float32Array(array):array}static toSinglePrecision(value){return Utils.SUPPORTS_TYPED_ARRAYS?Math.fround(value):value}static webkit602BugfixHelper(alpha,blend){}static contains(array,element,identity=!0){for(var i=0;i<array.length;i++)if(array[i]==element)return!0;return!1}}return Utils.SUPPORTS_TYPED_ARRAYS="undefined"!=typeof Float32Array,Utils})();spine.Utils=Utils;spine.DebugUtils=class DebugUtils{static logBones(skeleton){for(let i=0;i<skeleton.bones.length;i++){let bone=skeleton.bones[i];console.log(bone.data.name+", "+bone.a+", "+bone.b+", "+bone.c+", "+bone.d+", "+bone.worldX+", "+bone.worldY)}}};spine.Pool=class Pool{constructor(instantiator){this.items=new Array,this.instantiator=instantiator}obtain(){return this.items.length>0?this.items.pop():this.instantiator()}free(item){item.reset&&item.reset(),this.items.push(item)}freeAll(items){for(let i=0;i<items.length;i++)items[i].reset&&items[i].reset(),this.items[i]=items[i]}clear(){this.items.length=0}};spine.Vector2=class Vector2{constructor(x=0,y=0){this.x=x,this.y=y}set(x,y){return this.x=x,this.y=y,this}length(){let x=this.x,y=this.y;return Math.sqrt(x*x+y*y)}normalize(){let len=this.length();return 0!=len&&(this.x/=len,this.y/=len),this}};spine.TimeKeeper=class TimeKeeper{constructor(){this.maxDelta=.064,this.framesPerSecond=0,this.delta=0,this.totalTime=0,this.lastTime=Date.now()/1e3,this.frameCount=0,this.frameTime=0}update(){let now=Date.now()/1e3;this.delta=now-this.lastTime,this.frameTime+=this.delta,this.totalTime+=this.delta,this.delta>this.maxDelta&&(this.delta=this.maxDelta),this.lastTime=now,this.frameCount++,this.frameTime>1&&(this.framesPerSecond=this.frameCount/this.frameTime,this.frameTime=0,this.frameCount=0)}};spine.WindowedMean=class WindowedMean{constructor(windowSize=32){this.addedValues=0,this.lastValue=0,this.mean=0,this.dirty=!0,this.values=new Array(windowSize)}hasEnoughData(){return this.addedValues>=this.values.length}addValue(value){this.addedValues<this.values.length&&this.addedValues++,this.values[this.lastValue++]=value,this.lastValue>this.values.length-1&&(this.lastValue=0),this.dirty=!0}getMean(){if(this.hasEnoughData()){if(this.dirty){let mean=0;for(let i=0;i<this.values.length;i++)mean+=this.values[i];this.mean=mean/this.values.length,this.dirty=!1}return this.mean}return 0}}}(spine||(spine={})),(()=>{var array;Math.fround||(Math.fround=(array=new Float32Array(1),function(x){return array[0]=x,array[0]}))})(),function(spine){class Attachment{constructor(name){if(null==name)throw new Error("name cannot be null.");this.name=name}}spine.Attachment=Attachment;let VertexAttachment=(()=>{class VertexAttachment extends Attachment{constructor(name){super(name),this.id=(65535&VertexAttachment.nextID++)<<11,this.worldVerticesLength=0,this.deformAttachment=this}computeWorldVertices(slot,start,count,worldVertices,offset,stride){count=offset+(count>>1)*stride;let skeleton=slot.bone.skeleton,deformArray=slot.deform,vertices=this.vertices,bones=this.bones;if(null==bones){deformArray.length>0&&(vertices=deformArray);let bone=slot.bone,x=bone.worldX,y=bone.worldY,a=bone.a,b=bone.b,c=bone.c,d=bone.d;for(let v=start,w=offset;w<count;v+=2,w+=stride){let vx=vertices[v],vy=vertices[v+1];worldVertices[w]=vx*a+vy*b+x,worldVertices[w+1]=vx*c+vy*d+y}return}let v=0,skip=0;for(let i=0;i<start;i+=2){let n=bones[v];v+=n+1,skip+=n}let skeletonBones=skeleton.bones;if(0==deformArray.length)for(let w=offset,b=3*skip;w<count;w+=stride){let wx=0,wy=0,n=bones[v++];for(n+=v;v<n;v++,b+=3){let bone=skeletonBones[bones[v]],vx=vertices[b],vy=vertices[b+1],weight=vertices[b+2];wx+=(vx*bone.a+vy*bone.b+bone.worldX)*weight,wy+=(vx*bone.c+vy*bone.d+bone.worldY)*weight}worldVertices[w]=wx,worldVertices[w+1]=wy}else{let deform=deformArray;for(let w=offset,b=3*skip,f=skip<<1;w<count;w+=stride){let wx=0,wy=0,n=bones[v++];for(n+=v;v<n;v++,b+=3,f+=2){let bone=skeletonBones[bones[v]],vx=vertices[b]+deform[f],vy=vertices[b+1]+deform[f+1],weight=vertices[b+2];wx+=(vx*bone.a+vy*bone.b+bone.worldX)*weight,wy+=(vx*bone.c+vy*bone.d+bone.worldY)*weight}worldVertices[w]=wx,worldVertices[w+1]=wy}}}copyTo(attachment){null!=this.bones?(attachment.bones=new Array(this.bones.length),spine.Utils.arrayCopy(this.bones,0,attachment.bones,0,this.bones.length)):attachment.bones=null,null!=this.vertices?(attachment.vertices=spine.Utils.newFloatArray(this.vertices.length),spine.Utils.arrayCopy(this.vertices,0,attachment.vertices,0,this.vertices.length)):attachment.vertices=null,attachment.worldVerticesLength=this.worldVerticesLength,attachment.deformAttachment=this.deformAttachment}}return VertexAttachment.nextID=0,VertexAttachment})();spine.VertexAttachment=VertexAttachment}(spine||(spine={})),function(spine){let AttachmentType;!function(AttachmentType){AttachmentType[AttachmentType.Region=0]="Region",AttachmentType[AttachmentType.BoundingBox=1]="BoundingBox",AttachmentType[AttachmentType.Mesh=2]="Mesh",AttachmentType[AttachmentType.LinkedMesh=3]="LinkedMesh",AttachmentType[AttachmentType.Path=4]="Path",AttachmentType[AttachmentType.Point=5]="Point",AttachmentType[AttachmentType.Clipping=6]="Clipping"}(AttachmentType=spine.AttachmentType||(spine.AttachmentType={}))}(spine||(spine={})),function(spine){class BoundingBoxAttachment extends spine.VertexAttachment{constructor(name){super(name),this.color=new spine.Color(1,1,1,1)}copy(){let copy=new BoundingBoxAttachment(name);return this.copyTo(copy),copy.color.setFromColor(this.color),copy}}spine.BoundingBoxAttachment=BoundingBoxAttachment}(spine||(spine={})),function(spine){class ClippingAttachment extends spine.VertexAttachment{constructor(name){super(name),this.color=new spine.Color(.2275,.2275,.8078,1)}copy(){let copy=new ClippingAttachment(name);return this.copyTo(copy),copy.endSlot=this.endSlot,copy.color.setFromColor(this.color),copy}}spine.ClippingAttachment=ClippingAttachment}(spine||(spine={})),function(spine){class MeshAttachment extends spine.VertexAttachment{constructor(name){super(name),this.color=new spine.Color(1,1,1,1),this.tempColor=new spine.Color(0,0,0,0)}updateUVs(){let regionUVs=this.regionUVs;null!=this.uvs&&this.uvs.length==regionUVs.length||(this.uvs=spine.Utils.newFloatArray(regionUVs.length));let uvs=this.uvs,n=this.uvs.length,u=this.region.u,v=this.region.v,width=0,height=0;if(this.region instanceof spine.TextureAtlasRegion){let region=this.region,textureWidth=region.texture.getImage().width,textureHeight=region.texture.getImage().height;switch(region.degrees){case 90:u-=(region.originalHeight-region.offsetY-region.height)/textureWidth,v-=(region.originalWidth-region.offsetX-region.width)/textureHeight,width=region.originalHeight/textureWidth,height=region.originalWidth/textureHeight;for(let i=0;i<n;i+=2)uvs[i]=u+regionUVs[i+1]*width,uvs[i+1]=v+(1-regionUVs[i])*height;return;case 180:u-=(region.originalWidth-region.offsetX-region.width)/textureWidth,v-=region.offsetY/textureHeight,width=region.originalWidth/textureWidth,height=region.originalHeight/textureHeight;for(let i=0;i<n;i+=2)uvs[i]=u+(1-regionUVs[i])*width,uvs[i+1]=v+(1-regionUVs[i+1])*height;return;case 270:u-=region.offsetY/textureWidth,v-=region.offsetX/textureHeight,width=region.originalHeight/textureWidth,height=region.originalWidth/textureHeight;for(let i=0;i<n;i+=2)uvs[i]=u+(1-regionUVs[i+1])*width,uvs[i+1]=v+regionUVs[i]*height;return}u-=region.offsetX/textureWidth,v-=(region.originalHeight-region.offsetY-region.height)/textureHeight,width=region.originalWidth/textureWidth,height=region.originalHeight/textureHeight}else null==this.region?(u=v=0,width=height=1):(width=this.region.u2-u,height=this.region.v2-v);for(let i=0;i<n;i+=2)uvs[i]=u+regionUVs[i]*width,uvs[i+1]=v+regionUVs[i+1]*height}getParentMesh(){return this.parentMesh}setParentMesh(parentMesh){this.parentMesh=parentMesh,null!=parentMesh&&(this.bones=parentMesh.bones,this.vertices=parentMesh.vertices,this.worldVerticesLength=parentMesh.worldVerticesLength,this.regionUVs=parentMesh.regionUVs,this.triangles=parentMesh.triangles,this.hullLength=parentMesh.hullLength,this.worldVerticesLength=parentMesh.worldVerticesLength)}copy(){if(null!=this.parentMesh)return this.newLinkedMesh();let copy=new MeshAttachment(this.name);return copy.region=this.region,copy.path=this.path,copy.color.setFromColor(this.color),this.copyTo(copy),copy.regionUVs=new Array(this.regionUVs.length),spine.Utils.arrayCopy(this.regionUVs,0,copy.regionUVs,0,this.regionUVs.length),copy.uvs=new Array(this.uvs.length),spine.Utils.arrayCopy(this.uvs,0,copy.uvs,0,this.uvs.length),copy.triangles=new Array(this.triangles.length),spine.Utils.arrayCopy(this.triangles,0,copy.triangles,0,this.triangles.length),copy.hullLength=this.hullLength,null!=this.edges&&(copy.edges=new Array(this.edges.length),spine.Utils.arrayCopy(this.edges,0,copy.edges,0,this.edges.length)),copy.width=this.width,copy.height=this.height,copy}newLinkedMesh(){let copy=new MeshAttachment(this.name);return copy.region=this.region,copy.path=this.path,copy.color.setFromColor(this.color),copy.deformAttachment=this.deformAttachment,copy.setParentMesh(null!=this.parentMesh?this.parentMesh:this),copy.updateUVs(),copy}}spine.MeshAttachment=MeshAttachment}(spine||(spine={})),function(spine){class PathAttachment extends spine.VertexAttachment{constructor(name){super(name),this.closed=!1,this.constantSpeed=!1,this.color=new spine.Color(1,1,1,1)}copy(){let copy=new PathAttachment(name);return this.copyTo(copy),copy.lengths=new Array(this.lengths.length),spine.Utils.arrayCopy(this.lengths,0,copy.lengths,0,this.lengths.length),copy.closed=closed,copy.constantSpeed=this.constantSpeed,copy.color.setFromColor(this.color),copy}}spine.PathAttachment=PathAttachment}(spine||(spine={})),function(spine){class PointAttachment extends spine.VertexAttachment{constructor(name){super(name),this.color=new spine.Color(.38,.94,0,1)}computeWorldPosition(bone,point){return point.x=this.x*bone.a+this.y*bone.b+bone.worldX,point.y=this.x*bone.c+this.y*bone.d+bone.worldY,point}computeWorldRotation(bone){let cos=spine.MathUtils.cosDeg(this.rotation),sin=spine.MathUtils.sinDeg(this.rotation),x=cos*bone.a+sin*bone.b,y=cos*bone.c+sin*bone.d;return Math.atan2(y,x)*spine.MathUtils.radDeg}copy(){let copy=new PointAttachment(name);return copy.x=this.x,copy.y=this.y,copy.rotation=this.rotation,copy.color.setFromColor(this.color),copy}}spine.PointAttachment=PointAttachment}(spine||(spine={})),function(spine){let RegionAttachment=(()=>{class RegionAttachment extends spine.Attachment{constructor(name){super(name),this.x=0,this.y=0,this.scaleX=1,this.scaleY=1,this.rotation=0,this.width=0,this.height=0,this.color=new spine.Color(1,1,1,1),this.offset=spine.Utils.newFloatArray(8),this.uvs=spine.Utils.newFloatArray(8),this.tempColor=new spine.Color(1,1,1,1)}updateOffset(){let regionScaleX=this.width/this.region.originalWidth*this.scaleX,regionScaleY=this.height/this.region.originalHeight*this.scaleY,localX=-this.width/2*this.scaleX+this.region.offsetX*regionScaleX,localY=-this.height/2*this.scaleY+this.region.offsetY*regionScaleY,localX2=localX+this.region.width*regionScaleX,localY2=localY+this.region.height*regionScaleY,radians=this.rotation*Math.PI/180,cos=Math.cos(radians),sin=Math.sin(radians),localXCos=localX*cos+this.x,localXSin=localX*sin,localYCos=localY*cos+this.y,localYSin=localY*sin,localX2Cos=localX2*cos+this.x,localX2Sin=localX2*sin,localY2Cos=localY2*cos+this.y,localY2Sin=localY2*sin,offset=this.offset;offset[RegionAttachment.OX1]=localXCos-localYSin,offset[RegionAttachment.OY1]=localYCos+localXSin,offset[RegionAttachment.OX2]=localXCos-localY2Sin,offset[RegionAttachment.OY2]=localY2Cos+localXSin,offset[RegionAttachment.OX3]=localX2Cos-localY2Sin,offset[RegionAttachment.OY3]=localY2Cos+localX2Sin,offset[RegionAttachment.OX4]=localX2Cos-localYSin,offset[RegionAttachment.OY4]=localYCos+localX2Sin}setRegion(region){this.region=region;let uvs=this.uvs;region.rotate?(uvs[2]=region.u,uvs[3]=region.v2,uvs[4]=region.u,uvs[5]=region.v,uvs[6]=region.u2,uvs[7]=region.v,uvs[0]=region.u2,uvs[1]=region.v2):(uvs[0]=region.u,uvs[1]=region.v2,uvs[2]=region.u,uvs[3]=region.v,uvs[4]=region.u2,uvs[5]=region.v,uvs[6]=region.u2,uvs[7]=region.v2)}computeWorldVertices(bone,worldVertices,offset,stride){let vertexOffset=this.offset,x=bone.worldX,y=bone.worldY,a=bone.a,b=bone.b,c=bone.c,d=bone.d,offsetX=0,offsetY=0;offsetX=vertexOffset[RegionAttachment.OX1],offsetY=vertexOffset[RegionAttachment.OY1],worldVertices[offset]=offsetX*a+offsetY*b+x,worldVertices[offset+1]=offsetX*c+offsetY*d+y,offset+=stride,offsetX=vertexOffset[RegionAttachment.OX2],offsetY=vertexOffset[RegionAttachment.OY2],worldVertices[offset]=offsetX*a+offsetY*b+x,worldVertices[offset+1]=offsetX*c+offsetY*d+y,offset+=stride,offsetX=vertexOffset[RegionAttachment.OX3],offsetY=vertexOffset[RegionAttachment.OY3],worldVertices[offset]=offsetX*a+offsetY*b+x,worldVertices[offset+1]=offsetX*c+offsetY*d+y,offset+=stride,offsetX=vertexOffset[RegionAttachment.OX4],offsetY=vertexOffset[RegionAttachment.OY4],worldVertices[offset]=offsetX*a+offsetY*b+x,worldVertices[offset+1]=offsetX*c+offsetY*d+y}copy(){let copy=new RegionAttachment(name);return copy.region=this.region,copy.rendererObject=this.rendererObject,copy.path=this.path,copy.x=this.x,copy.y=this.y,copy.scaleX=this.scaleX,copy.scaleY=this.scaleY,copy.rotation=this.rotation,copy.width=this.width,copy.height=this.height,spine.Utils.arrayCopy(this.uvs,0,copy.uvs,0,8),spine.Utils.arrayCopy(this.offset,0,copy.offset,0,8),copy.color.setFromColor(this.color),copy}}return RegionAttachment.OX1=0,RegionAttachment.OY1=1,RegionAttachment.OX2=2,RegionAttachment.OY2=3,RegionAttachment.OX3=4,RegionAttachment.OY3=5,RegionAttachment.OX4=6,RegionAttachment.OY4=7,RegionAttachment.X1=0,RegionAttachment.Y1=1,RegionAttachment.C1R=2,RegionAttachment.C1G=3,RegionAttachment.C1B=4,RegionAttachment.C1A=5,RegionAttachment.U1=6,RegionAttachment.V1=7,RegionAttachment.X2=8,RegionAttachment.Y2=9,RegionAttachment.C2R=10,RegionAttachment.C2G=11,RegionAttachment.C2B=12,RegionAttachment.C2A=13,RegionAttachment.U2=14,RegionAttachment.V2=15,RegionAttachment.X3=16,RegionAttachment.Y3=17,RegionAttachment.C3R=18,RegionAttachment.C3G=19,RegionAttachment.C3B=20,RegionAttachment.C3A=21,RegionAttachment.U3=22,RegionAttachment.V3=23,RegionAttachment.X4=24,RegionAttachment.Y4=25,RegionAttachment.C4R=26,RegionAttachment.C4G=27,RegionAttachment.C4B=28,RegionAttachment.C4A=29,RegionAttachment.U4=30,RegionAttachment.V4=31,RegionAttachment})();spine.RegionAttachment=RegionAttachment}(spine||(spine={})),function(spine){spine.JitterEffect=class JitterEffect{constructor(jitterX,jitterY){this.jitterX=0,this.jitterY=0,this.jitterX=jitterX,this.jitterY=jitterY}begin(skeleton){}transform(position,uv,light,dark){position.x+=spine.MathUtils.randomTriangular(-this.jitterX,this.jitterY),position.y+=spine.MathUtils.randomTriangular(-this.jitterX,this.jitterY)}end(){}}}(spine||(spine={})),function(spine){let SwirlEffect=(()=>{class SwirlEffect{constructor(radius){this.centerX=0,this.centerY=0,this.radius=0,this.angle=0,this.worldX=0,this.worldY=0,this.radius=radius}begin(skeleton){this.worldX=skeleton.x+this.centerX,this.worldY=skeleton.y+this.centerY}transform(position,uv,light,dark){let radAngle=this.angle*spine.MathUtils.degreesToRadians,x=position.x-this.worldX,y=position.y-this.worldY,dist=Math.sqrt(x*x+y*y);if(dist<this.radius){let theta=SwirlEffect.interpolation.apply(0,radAngle,(this.radius-dist)/this.radius),cos=Math.cos(theta),sin=Math.sin(theta);position.x=cos*x-sin*y+this.worldX,position.y=sin*x+cos*y+this.worldY}}end(){}}return SwirlEffect.interpolation=new spine.PowOut(2),SwirlEffect})();spine.SwirlEffect=SwirlEffect}(spine||(spine={})),function(spine){!function(hydra){class AssetManager extends spine.AssetManager{constructor(pathPrefix=""){super(image=>new hydra.HydraTexture(image),pathPrefix)}}hydra.AssetManager=AssetManager}(spine.hydra||(spine.hydra={}))}(spine||(spine={})),function(spine){!function(hydra){let MeshBatcher=(()=>{class MeshBatcher extends Mesh{constructor(maxVertices=10920,shader){if(super(),this.verticesLength=0,this.indicesLength=0,maxVertices>10920)throw new Error("Can't have more than 10920 triangles per batch: "+maxVertices);let vertices=this.vertices=new Float32Array(maxVertices*MeshBatcher.VERTEX_SIZE),indices=this.indices=new Uint16Array(3*maxVertices),geo=new Geometry,vertexBuffer=this.vertexBuffer=new InterleavedBuffer(vertices,MeshBatcher.VERTEX_SIZE);vertexBuffer.dynamic=!0,geo.addAttribute("position",new InterleavedGeometryAttribute(vertexBuffer,3,0,!1)),geo.addAttribute("color",new InterleavedGeometryAttribute(vertexBuffer,4,3,!1)),geo.addAttribute("uv",new InterleavedGeometryAttribute(vertexBuffer,2,7,!1)),geo.setIndex(indices),geo.index.dynamic=!0,geo.drawRange.start=0,geo.drawRange.count=0,this.geometry=geo,this.shader=shader,this.frustumCulled=!1,this.shader.side=Shader.BACK_SIDE,this.shader.transparent=!0,this.shader.depthWrite=!1}dispose(){this.destroy()}clear(){let geo=this.geometry;geo.drawRange.start=0,geo.drawRange.count=0,this.shader.uniforms.map.value=null}begin(){this.verticesLength=0,this.indicesLength=0}canBatch(verticesLength,indicesLength){return!(this.indicesLength+indicesLength>=this.indices.byteLength/2)&&!(this.verticesLength+verticesLength>=this.vertices.byteLength/2)}batch(vertices,verticesLength,indices,indicesLength,z=0){let indexStart=this.verticesLength/MeshBatcher.VERTEX_SIZE,vertexBuffer=this.vertices,i=this.verticesLength,j=0;for(;j<verticesLength;)vertexBuffer[i++]=vertices[j++],vertexBuffer[i++]=vertices[j++],vertexBuffer[i++]=z,vertexBuffer[i++]=vertices[j++],vertexBuffer[i++]=vertices[j++],vertexBuffer[i++]=vertices[j++],vertexBuffer[i++]=vertices[j++],vertexBuffer[i++]=vertices[j++],vertexBuffer[i++]=vertices[j++];this.verticesLength=i;let indicesArray=this.indices;for(i=this.indicesLength,j=0;j<indicesLength;i++,j++)indicesArray[i]=indices[j]+indexStart;this.indicesLength+=indicesLength}end(){this.vertexBuffer.needsUpdate=this.verticesLength>0,this.vertexBuffer.updateRange.offset=0,this.vertexBuffer.updateRange.count=this.verticesLength;let geo=this.geometry;geo.drawRange.start=0,geo.drawRange.count=this.indicesLength,geo.indexNeedsUpdate=this.indicesLength>0,geo.indexUpdateRange={offset:0,count:this.indicesLength}}}return MeshBatcher.VERTEX_SIZE=9,MeshBatcher})();hydra.MeshBatcher=MeshBatcher}(spine.hydra||(spine.hydra={}))}(spine||(spine={})),function(spine){!function(hydra){let SkeletonMesh=(()=>{class SkeletonMesh extends Group{constructor(skeletonData,shader){super(),this.tempPos=new spine.Vector2,this.tempUv=new spine.Vector2,this.tempLight=new spine.Color,this.tempDark=new spine.Color,this.zOffset=.1,this.batches=new Array,this.nextBatchIndex=0,this.clipper=new spine.SkeletonClipping,this.vertices=spine.Utils.newFloatArray(1024),this.tempColor=new spine.Color,this.shaderObj=shader,this.skeleton=new spine.Skeleton(skeletonData);let animData=new spine.AnimationStateData(skeletonData);this.state=new spine.AnimationState(animData)}update(deltaTime){let state=this.state,skeleton=this.skeleton;state.update(deltaTime),state.apply(skeleton),skeleton.updateWorldTransform(),this.updateGeometry()}dispose(){for(var i=0;i<this.batches.length;i++)this.batches[i].dispose()}clearBatches(){for(var i=0;i<this.batches.length;i++)this.batches[i].clear(),this.batches[i].visible=!1;this.nextBatchIndex=0}nextBatch(){if(this.batches.length==this.nextBatchIndex){let batch=new hydra.MeshBatcher(10920,this.shaderObj);this.add(batch),this.batches.push(batch)}let batch=this.batches[this.nextBatchIndex++];return batch.visible=!0,batch}updateGeometry(){this.clearBatches();let tempPos=this.tempPos,tempUv=this.tempUv,tempLight=this.tempLight,tempDark=this.tempDark;let clipper=this.clipper,vertices=this.vertices,triangles=null,uvs=null,drawOrder=this.skeleton.drawOrder,batch=this.nextBatch();batch.begin();let z=0,zOffset=this.zOffset;for(let i=0,n=drawOrder.length;i<n;i++){let vertexSize=clipper.isClipping()?2:SkeletonMesh.VERTEX_SIZE,slot=drawOrder[i];if(!slot.bone.active)continue;let attachment=slot.getAttachment(),attachmentColor=null,texture=null,numFloats=0;if(attachment instanceof spine.RegionAttachment){let region=attachment;attachmentColor=region.color,vertices=this.vertices,numFloats=4*vertexSize,region.computeWorldVertices(slot.bone,vertices,0,vertexSize),triangles=SkeletonMesh.QUAD_TRIANGLES,uvs=region.uvs,texture=region.region.renderObject.texture}else{if(!(attachment instanceof spine.MeshAttachment)){if(attachment instanceof spine.ClippingAttachment){let clip=attachment;clipper.clipStart(slot,clip);continue}continue}{let mesh=attachment;attachmentColor=mesh.color,vertices=this.vertices,numFloats=(mesh.worldVerticesLength>>1)*vertexSize,numFloats>vertices.length&&(vertices=this.vertices=spine.Utils.newFloatArray(numFloats)),mesh.computeWorldVertices(slot,0,mesh.worldVerticesLength,vertices,0,vertexSize),triangles=mesh.triangles,uvs=mesh.uvs,texture=mesh.region.renderObject.texture}}if(null!=texture){let finalVertices,finalVerticesLength,finalIndices,finalIndicesLength,skeletonColor=slot.bone.skeleton.color,slotColor=slot.color,alpha=skeletonColor.a*slotColor.a*attachmentColor.a,color=this.tempColor;if(color.set(skeletonColor.r*slotColor.r*attachmentColor.r,skeletonColor.g*slotColor.g*attachmentColor.g,skeletonColor.b*slotColor.b*attachmentColor.b,alpha),clipper.isClipping()){clipper.clipTriangles(vertices,numFloats,triangles,triangles.length,uvs,color,null,!1);let clippedVertices=clipper.clippedVertices,clippedTriangles=clipper.clippedTriangles;if(null!=this.vertexEffect){let vertexEffect=this.vertexEffect,verts=clippedVertices;for(let v=0,n=clippedVertices.length;v<n;v+=vertexSize)tempPos.x=verts[v],tempPos.y=verts[v+1],tempLight.setFromColor(color),tempDark.set(0,0,0,0),tempUv.x=verts[v+6],tempUv.y=verts[v+7],vertexEffect.transform(tempPos,tempUv,tempLight,tempDark),verts[v]=tempPos.x,verts[v+1]=tempPos.y,verts[v+2]=tempLight.r,verts[v+3]=tempLight.g,verts[v+4]=tempLight.b,verts[v+5]=tempLight.a,verts[v+6]=tempUv.x,verts[v+7]=tempUv.y}finalVertices=clippedVertices,finalVerticesLength=clippedVertices.length,finalIndices=clippedTriangles,finalIndicesLength=clippedTriangles.length}else{let verts=vertices;if(null!=this.vertexEffect){let vertexEffect=this.vertexEffect;for(let v=0,u=0,n=numFloats;v<n;v+=vertexSize,u+=2)tempPos.x=verts[v],tempPos.y=verts[v+1],tempLight.setFromColor(color),tempDark.set(0,0,0,0),tempUv.x=uvs[u],tempUv.y=uvs[u+1],vertexEffect.transform(tempPos,tempUv,tempLight,tempDark),verts[v]=tempPos.x,verts[v+1]=tempPos.y,verts[v+2]=tempLight.r,verts[v+3]=tempLight.g,verts[v+4]=tempLight.b,verts[v+5]=tempLight.a,verts[v+6]=tempUv.x,verts[v+7]=tempUv.y}else for(let v=2,u=0,n=numFloats;v<n;v+=vertexSize,u+=2)verts[v]=color.r,verts[v+1]=color.g,verts[v+2]=color.b,verts[v+3]=color.a,verts[v+4]=uvs[u],verts[v+5]=uvs[u+1];finalVertices=vertices,finalVerticesLength=numFloats,finalIndices=triangles,finalIndicesLength=triangles.length}if(0==finalVerticesLength||0==finalIndicesLength)continue;batch.canBatch(finalVerticesLength,finalIndicesLength)||(batch.end(),batch=this.nextBatch(),batch.begin());let batchMaterial=batch.shader;null==batchMaterial.uniforms.map.value&&(batchMaterial.uniforms.map.value=texture.texture),batchMaterial.uniforms.map.value!=texture.texture&&(batch.end(),batch=this.nextBatch(),batch.begin(),batchMaterial=batch.shader,batchMaterial.uniforms.map.value=texture.texture),batchMaterial.needsUpdate=!0,batch.batch(finalVertices,finalVerticesLength,finalIndices,finalIndicesLength,z),z+=zOffset}clipper.clipEndWithSlot(slot)}clipper.clipEnd(),batch.end()}}return SkeletonMesh.QUAD_TRIANGLES=[0,1,2,2,3,0],SkeletonMesh.VERTEX_SIZE=8,SkeletonMesh})();hydra.SkeletonMesh=SkeletonMesh}(spine.hydra||(spine.hydra={}))}(spine||(spine={})),function(spine){!function(hydra){class HydraTexture extends spine.Texture{constructor(image){super(image),this.texture=new Texture(image),this.texture.flipY=!1,this.texture.needsUpdate=!0}setFilters(minFilter,magFilter){this.texture.minFilter=HydraTexture.toHydraTextureFilter(minFilter),this.texture.magFilter=HydraTexture.toHydraTextureFilter(magFilter)}setWraps(uWrap,vWrap){this.texture.wrapS=HydraTexture.toHydraTextureWrap(uWrap),this.texture.wrapT=HydraTexture.toHydraTextureWrap(vWrap)}dispose(){this.texture.dispose()}static toHydraTextureFilter(filter){if(filter===spine.TextureFilter.Linear)return Texture.LINEAR;if(filter===spine.TextureFilter.MipMap)return Texture.LINEAR_MIPMAP_NEAREST;if(filter===spine.TextureFilter.MipMapLinearNearest)return Texture.LINEAR_MIPMAP_NEAREST;if(filter===spine.TextureFilter.MipMapNearestLinear)return Texture.LINEAR_MIPMAP_NEAREST;if(filter===spine.TextureFilter.MipMapNearestNearest)return Texture.LINEAR_MIPMAP_NEAREST;if(filter===spine.TextureFilter.Nearest)return Texture.NEAREST;throw new Error("Unknown texture filter: "+filter)}static toHydraTextureWrap(wrap){if(wrap===spine.TextureWrap.ClampToEdge)return Texture.CLAMP_TO_EDGE;if(wrap===spine.TextureWrap.MirroredRepeat)return Texture.MIRROR_REPEAT;if(wrap===spine.TextureWrap.Repeat)return Texture.REPEAT;throw new Error("Unknown texture wrap: "+wrap)}}hydra.HydraTexture=HydraTexture}(spine.hydra||(spine.hydra={}))}(spine||(spine={})),Class((function StageLayout(_name,_options={}){Inherit(this,Component);const _this=this;var _dataStore,_data,$create;const GLUI=_options.glui;var _uil=getTopLevelUIL(),_folders={},_layers={},_exists={},_resize=[],_graph,_config;function getTopLevelUIL(){let uil=UIL.sidebar;return!_options.uil&&_this.parent&&uil&&Utils.getConstructorName(_this.parent)!=Global.PLAYGROUND&&(uil=new UILFolder(`stl_${_name}_nested`,{label:_name.capitalize()+" (Nested)",closed:!0}),UIL.sidebar&&UIL.sidebar.add(uil)),uil}function createFolder(name){let folder=new UILFolder(`stl_${_name}_${name}`,{label:name,closed:!0});return _folders[`stl_${_name}_${name}`]=folder,folder}async function initGraph(){_options.noGraph||!window.UILGraph||StageLayout.noGraph||(_graph=UILGraph.instance().getGraph(_name,_this,!!GLUI))&&(UIL.sidebar.element.show(),Global.PLAYGROUND&&(Utils.getConstructorName(_this.parent),Global.PLAYGROUND),_graph.open())}function initParams(){_options.rootPath?"/"!=_options.rootPath.charAt(_options.rootPath.length-1)&&(_options.rootPath+="/"):_options.rootPath="",_this.baseZ=_options.baseZ||0,_this.data=_options.data,_options.uil&&(_uil=_options.uil),GLUI?(_this.element=$gl(1,1),_this.element.stageLayout=_this):(_this.element=$("StageLayout_"+_name),_this.element.size("100%"))}async function initData(){if(await UILStorage.ready(),_dataStore=InputUIL.create("stagelayout_"+_name,null),void 0===(_data=JSON.parse(_dataStore.get("data")||"{}")).layers&&(_data.layers=-1),_options.perFrame)_data.layers>0&&createLayers();else{for(let i=0,c=_data.layers+1;i<c;i++)createLayer(i);_this.loaded=!0}}function initRoot(){let name=_name+"Root",group=_uil?createFolder(name):null,$obj=_this.element,input=InputUIL.create(`Config_${name}_${_name}`,group);if(input.setLabel("Parameters"),input.add("size").addTextarea("fontStyle").addTextarea("css",GLUI?"hidden":void 0).add("onResize","hidden"),input.add("compiled","hidden"),input.add("Figma Config"),_config=input,!group)return createCompiledLayer(`${name}_${_name}`,input);StageLayoutUtil.create(`${name}_${_name}`),group.hide(),group.setLabel(name);let size=input.get("size"),css=input.get("css"),resizeCode=(input.get("fontStyle"),input.get("onResize")),doCSS=change=>{if(GLUI)return;css=css||"";let obj={},objSave={};css=css.split("\n"),css.forEach(line=>{let key=(line=line.split(":"))[0],val=line[1],valSave=val;val&&(val=parseData(val.replace(/ /g,""))),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val),valSave&&(valSave=valSave.replace(/ /g,"")),objSave[key]=isNaN(Number(valSave))?valSave:Number(valSave))}),change&&StageLayoutUtil.save("css",objSave,input),$obj.css(obj)},doSize=change=>{if(size){let s=parseData(size).replace(/ /g,"").split(","),s0=s[0].includes("%")?s[0]:Number(s[0])||s[0],s1=s[1].includes("%")?s[1]:Number(s[1])||s[1];$obj.size(s0,s1),change&&StageLayoutUtil.save("size",[s0,s1],input)}else $obj.size(100,100)},doResize=change=>{if(resizeCode){let fn=new Function("$this",resizeCode);_resize.push({fn:fn,$obj:$obj}),fn($obj)}},doFont=change=>{let fontStyle=parseData(input.get("fontStyle"));fontStyle&&(fontStyle=fontStyle.split("\n"),$obj.fontStyle(fontStyle[0],Number(fontStyle[1]),fontStyle[2],fontStyle[3]),change&&StageLayoutUtil.save("fontStyle",fontStyle,input))};doCSS(),doSize(),doFont(),doResize(),input.onUpdate=key=>{switch(key){case"css":css=input.get("css"),doCSS(!0);break;case"size":size=input.get("size"),doSize(!0);break;case"onResize":resizeCode=input.get("onResize"),doResize();break;case"fontStyle":doFont(!0)}},group.params=input,_graph&&_graph.addSpecial(group.id,name,"Root"),_uil.add(group),(_=>{let folder=new UILFolder(`stl_${_name}_${name}_resize`,{label:"Resize Logic",closed:!0}),button=new UILControlButton("button",{actions:[{title:"Open Editor",callback:_=>{let editor=new UILWindow(_name,{label:"Resize Logic",height:"auto",drag:!0}),text=new UILControlTextarea(`stl_${_name}_${name}_resize`,{label:"Resize",value:input.get("onResize"),monospace:!0,rows:10,resize:"both",minWidth:400,hideLabel:!0,tab:!0});editor.add(text),text.onFinishChange(value=>input.setValue("onResize",value)),UIL.add(editor)}}],hideLabel:!0});folder.add(button),group.add(folder)})()}function createLayers(){let index=0,renderWorker=new Render.Worker((function(){createLayer(index),index++==_data.layers&&(renderWorker.stop(),_this.loaded=!0)}),_options.perFrame)}function parseData(text){if(!text||"string"!=typeof text||!text.includes("$DATA"))return text;for(;text.includes("$DATA");){let code=text.split("$DATA")[1].split(" ")[0].split("\n")[0],line="$DATA"+code;text=text.replace(line,eval(line.replace("$DATA","_options.data")))}return text}async function createCompiledLayer(key,input){let compiled=StageLayoutUtil.getCompiled(key);if(!compiled)return;let $obj,name=input.get("name"),text=input.get("text");$obj=GLUI?text?$glText(parseData(text),null,null,compiled.fontStyle):$gl(1,1,parseData(input.get("bg"))):key==`${_name}Root_${_name}`?_this.element:$(name||"Layer",parseData(input.get("type")||"div"));let nestedGroup=input.get("group");if(nestedGroup){let layer;layer=nestedGroup===_name?_this.element:await _this.getLayer(nestedGroup),layer.add($obj)}else _this.element!=$obj&&_this.element.add($obj);if(Global.PLAYGROUND&&($obj._input=input),_layers[name]=$obj,_exists[name]=!0,checkNameHook($obj,name),compiled.css&&$obj.css){for(let key in compiled.css)compiled.css[key]=parseData(compiled.css[key]);$obj.css(compiled.css)}if(compiled.transform){for(let key in compiled.transform)$obj[key]=compiled.transform[key];$obj.transform&&$obj.transform()}if(compiled.size&&$obj.size(compiled.size[0],compiled.size[1]),compiled.attributes&&$obj.attr)for(let key in compiled.attributes)$obj.attr(key,parseData(compiled.attributes[key]));if(!GLUI){let bg=input.get("bg");bg&&$obj.bg(parseData(bg)||"#ff0000")}if(!GLUI){if(text){text=parseData(text);let helper=compiled.helper;if(helper){let helperName=helper.split("(")[0],args=helper.split("(")[1];args?(args=args.replace(")","").replace(/,\ /g,",").split(","),args.forEach((function(arg,i){"$text"==arg&&(args[i]=text)})),args.indexOf(text)<0&&args.unshift(text)):args=[text];let helperFn=_options[helperName]||StageLayout.helpers[helperName];return helperFn?void $obj.html(helperFn.apply(null,args)):console.warn(`No helper function ${helperName} found.`)}text.includes(["</","/>"])?$obj.html(text):$obj.text(text)}let fs=compiled.fontStyle;fs&&$obj.fontStyle(fs[0],Number(fs[1]),fs[2],fs[3])}let zIndex=input.getNumber("zIndex");"number"==typeof zIndex&&$obj&&$obj.setZ&&!isNaN(zIndex)&&$obj.setZ(zIndex),compiled.resize&&(_resize.push({$obj:$obj,fn:compiled.resize}),compiled.resize($obj));let customClass=input.get("customClass");if(customClass){let Class=window[customClass];if(customClass.includes(".")){let split=customClass.split(".");Class=window[split[0]]&&window[split[0]][split[1]]}if(!Class)return console.warn(`No custom class ${customClass} found.`);_layers[name]=_this.initClass(Class,$obj,_options.data,input)}}function checkNameHook($obj,name){if(_this.layerHooks)for(let i=0,l=_this.layerHooks.length;i<l;i++){console.log(i);let{test:test,callback:callback,classConstructor:classConstructor}=_this.layerHooks[i];test&&test(name)&&(classConstructor&&_this.initClass(classConstructor,$obj,name),callback&&callback($obj,name))}for(let i=0,l=StageLayout.LAYER_HOOKS.length;i<l;i++){let{test:test,callback:callback,classConstructor:classConstructor}=StageLayout.LAYER_HOOKS[i];test&&test(name)&&(classConstructor&&_this.initClass(classConstructor,$obj,name),callback&&callback($obj,name))}}async function createLayer(index,groupName){let id="number"==typeof index?index:++_data.layers;if(UILStorage.get(`stl_${_name}_${id}_deleted`))return;let $obj,group=_uil?createFolder(id):null,input=InputUIL.create(`Config_${id}_${_name}`,group);if(input.setLabel("Parameters"),input.add("name").add("type",GLUI?"hidden":void 0).add("bg").add("size").add("group").add("customClass").add("wildcard").add("helper",GLUI?"hidden":void 0).add("zIndex","hidden").addTextarea("attributes",GLUI?"hidden":void 0).addTextarea("text").addTextarea("fontStyle").addTextarea("css",GLUI?"hidden":void 0).addTextarea("transform").add("onResize","hidden"),input.add("compiled","hidden"),!group)return createCompiledLayer(`${id}_${_name}`,input);StageLayoutUtil.create(`${id}_${_name}`),groupName&&input.setValue("group",groupName);let name=input.get("name")||id+"",size=input.get("size"),bg=input.get("bg"),css=input.get("css"),transform=input.get("transform"),type=input.get("type"),attributes=input.get("attributes"),text=input.get("text"),nestedGroup=(input.get("fontStyle"),input.get("group")),resizeCode=input.get("onResize"),zIndex=input.getNumber("zIndex"),customClass=input.get("customClass"),helper=input.get("helper");input.get("wildcard");group.setLabel(name),group.params=input;let getGLUIFontObject=_=>{let font=input.get("fontStyle")||"",obj={};return font=font.split("\n"),font.forEach(line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val),"false"===val&&(obj[key]=!1),"true"===val&&(obj[key]=!0))}),obj};if($obj=GLUI?text?$glText(parseData(text),null,null,getGLUIFontObject()):$gl(1,1,bg?parseData(bg):bg||name?void 0:"assets/images/_scenelayout/uv.jpg"):$(name||"Layer",parseData(type)),$obj._uil=group,nestedGroup){let layer;layer=nestedGroup===_name?_this.element:await _this.getLayer(nestedGroup),layer.add&&layer.add($obj),group&&_uil.add(group)}else _this.element.add($obj),group&&_uil.add(group);_graph&&_graph.addGroup(group.id,name||id+"",nestedGroup),(_=>{let folder=new UILFolder(`stl_${_name}_${name}_resize`,{label:"Resize Logic",closed:!0}),button=new UILControlButton("button",{actions:[{title:"Open Editor",callback:_=>{let editor=new UILWindow(_name,{label:"Resize Logic",height:"auto",drag:!0}),text=new UILControlTextarea(`stl_${_name}_${name}_resize`,{label:"Resize",value:input.get("onResize"),monospace:!0,rows:10,resize:"both",minWidth:400,hideLabel:!0,tab:!0});editor.add(text),text.onFinishChange(value=>input.setValue("onResize",value)),UIL.add(editor)}}],hideLabel:!0});folder.add(button),group.add(folder)})(),Global.PLAYGROUND&&($obj._input=input),_layers[name]=$obj,_exists[name]=!0,checkNameHook($obj,name);let doBG=change=>{GLUI?change&&$obj.bg(parseData(bg)):(bg||!bg&&!name)&&$obj.bg(parseData(bg)||"#ff0000")},doType=change=>{GLUI||change&&StageLayoutUtil.save("type",{type:type},input)},doCSS=change=>{if(GLUI)return;css=css||"";let obj={};css=css.split("\n"),css.forEach(line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=parseData(val.replace(/ /g,""))),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val))}),change&&StageLayoutUtil.save("css",obj,input),$obj.css(obj)},doTransform=change=>{transform=transform||"";let obj={};transform=transform.split("\n"),transform.forEach(line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),key.length&&(obj[key]=$obj[key]=isNaN(Number(val))?val:Number(val))}),change&&StageLayoutUtil.save("transform",obj,input),GLUI||$obj.transform()},doResize=change=>{if(resizeCode){let fn=new Function("$this",resizeCode);_resize.push({fn:fn,$obj:$obj}),fn($obj)}},doSize=change=>{if(size){let s=parseData(size).replace(/ /g,"").split(","),s0=Number(s[0])||s[0],s1=Number(s[1])||s[1];$obj.size(s0,s1),change&&StageLayoutUtil.save("size",[s0,s1],input)}else $obj.size(100,100)},doAttributes=change=>{if(GLUI)return;attributes=attributes||"";let obj={};attributes.split("\n").forEach((function(line,i){let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),obj[key]=val,val=parseData(val),$obj.attr(key,val)})),change&&StageLayoutUtil.save("attributes",obj,input)},doText=change=>{if(text=parseData(text),GLUI){if(!text)return $obj;if($obj instanceof GLUIObject)return $obj;let fontStyle=getGLUIFontObject();change&&StageLayoutUtil.save("fontStyle",fontStyle,input),$obj.setText(text,fontStyle),fontStyle.color&&$obj.setColor(fontStyle.color)}else{let fontStyle=parseData(input.get("fontStyle"));if(fontStyle?(fontStyle=fontStyle.split("\n"),$obj.fontStyle(fontStyle[0]||"",Number(fontStyle[1]),fontStyle[2],fontStyle[3]),change&&StageLayoutUtil.save("fontStyle",fontStyle,input)):change&&StageLayoutUtil.save("fontStyle","",input),!text)return;if(helper){let helperName=helper.split("(")[0],args=helper.split("(")[1];args?(args=args.replace(")","").replace(/,\ /g,",").split(","),args.forEach((function(arg,i){"$text"==arg&&(args[i]=text)})),args.indexOf(text)<0&&args.unshift(text)):args=[text];let helperFn=_options[helperName]||StageLayout.helpers[helperName];return helperFn?($obj.html(helperFn.apply(null,args)),void StageLayoutUtil.save("helper",helper,input)):console.warn(`No helper function ${helperName} found.`)}text.includes(["</","/>"])?$obj.html(text):$obj.text(text)}},doZ=_=>{"number"==typeof zIndex&&$obj.setZ(zIndex)};if(doType(),doCSS(),doBG(),doSize(),doAttributes(),doTransform(),doText(),doResize(),doZ(),input.onUpdate=key=>{switch(key){case"name":group.setLabel(input.get("name"));break;case"type":type=input.get("type"),doType(!0);break;case"css":css=input.get("css"),doCSS(!0);break;case"size":size=input.get("size"),doSize(!0);break;case"attributes":attributes=input.get("attributes"),doAttributes(!0);break;case"transform":transform=input.get("transform"),doTransform(!0);break;case"onResize":resizeCode=input.get("onResize"),doResize();break;case"text":case"fontStyle":text=input.get("text"),doText(!0);break;case"bg":bg=input.get("bg"),doBG(!0);break;case"zIndex":zIndex=input.getNumber("zIndex")||0,doZ()}},customClass){let Class=window[customClass];if(customClass.includes(".")){let split=customClass.split(".");Class=window[split[0]]&&window[split[0]][split[1]]}if(!Class)return console.warn(`No custom class ${customClass} found.`);_layers[name]=_this.initClass(Class,$obj,_options.data,input,group)}return"number"!=typeof index&&_dataStore.setValue("data",JSON.stringify(_data)),$obj}function resizeHandler(){_resize.forEach(({$obj:$obj,fn:fn})=>fn($obj))}function sortChild(label,index=0,parent,baseZ,step){let folder=_folders[label.id||label];if(!folder||!folder.params)return;let zIndex=0;zIndex=GLUI&&baseZ!=_this.baseZ?baseZ+(index+1)*step:baseZ+index,folder.params.setValue("zIndex",zIndex),label.children&&label.children.forEach((function(child,j,all){sortChild(child,j,all,zIndex,step/(parent.length+1))}))}function copyFolderProps(from,to){let params;to.forEachFolder(child=>{switch(child.label){case"Parameters":params=child}});let allowed=["Parameters"];from.forEachFolder(child=>{if(!(allowed.indexOf(child.label)<0))switch(child.toClipboard(),child.label){case"Parameters":params.fromClipboard()}})}this.isStageLayout=!0,_options.layerHooks&&(_this.layerHooks=_options.layerHooks),_this.onResize(resizeHandler),initParams(),initGraph(),initData(),defer(()=>{initRoot()}),this._createLayer=function(parentId){return createLayer(null,parentId)},this._createGroup=function(parentId){return createLayer(null,parentId)},this._rename=function(id,name,value){if(name==value)return;let folder=_folders[id]||_folders[`stl_${_name}_${name}`];folder&&(folder.setLabel(value),folder.params&&folder.params.setValue("name",value),Object.values(_layers).filter(layer=>layer._uil.params.get("group")==name).forEach(layer=>layer._uil.params.setValue("group",value)),[_exists,_layers].forEach((function(store){store[name]&&(store[value]=store[name],store[name]=null,delete store[name])})))},this._deleteLayer=function(id,name){let $obj=_layers[name];if(!$obj)return!1;if($obj.div&&$obj.div.children.length)return alert("Can't delete a group that has nested layers."),!1;if(!confirm("Are you sure you want to delete this layer?"))return;let folder=_folders[id];return _uil.remove(folder),($obj.element||$obj).remove(),UILStorage.set(id+"_deleted",!0),!0},this._changeParent=function(childId,childName,parentId,parentName){let child=_layers[childId]||_layers[childName],parent=_layers[parentId]||_layers[parentName]||_this;if(!child)return;child=child.element||child,parent==_this&&(parent=_this.element);let folder=_folders[childId]||_folders[`sl_${_name}_${childName}`];folder&&folder.params&&folder.params.setValue("group",parentName||null),("function"==typeof child.parent?child.parent():child.parent).removeChild(child,!0),parent.add(child)},this._visible=function(name,visible){let $obj=_layers[name];$obj&&$obj.css&&(visible?$obj.css({opacity:1}):$obj.css({opacity:0}))},this._focus=function(name){UIL.sidebar.toolbar.filterSingle(name)},this._blur=function(name){let folder=_folders[name];folder&&folder.forEachFolder&&(folder.forEachFolder(f=>f.close()),folder.close())},this._sort=function(order){order.forEach((function(item,i,all){sortChild(item,i,all,_this.baseZ,1)}))},this._duplicateLayer=function(id,parentId){let folder=_folders[id];if(!folder)return;createLayer(null,parentId);let copy=Object.values(_folders).last();copyFolderProps(folder,copy),parentId&&copy.params.setValue("group",parentId)},this._duplicateGroup=function(id,children,parentId){_this._duplicateLayer(id,parentId);let pid=_data.layers;children.forEach(childId=>{_this._duplicateGroup(childId,_graph.listChildren(childId),pid)})},this._getFigmaConfig=async function(){let _figmaConfig=_config.get("Figma Config").replace(".json","");return await get(Assets.getPath(`assets/data/${_figmaConfig}.json`))},this._applyFigmaConfig=function(id,params,$obj){if("TEXT"===params.type){$obj._input.setValue("text",params.characters);let figmaConfig,lineHeight,fontStyle="",align=params.textAlignHorizontal.toLowerCase(),fontName=StageLayout.FIGMA_FONT.DEFAULT,fontScale=1,ptToPixel=.75,family=StageLayout.FIGMA_FONT[params.fontName.family];if(family){let font=family[params.fontName.style.toLowerCase()];font&&(fontName=font.name,Stage.FIGMA_FONT_CONFIG&&Stage.FIGMA_FONT_CONFIG[fontName]&&(figmaConfig=Stage.FIGMA_FONT_CONFIG[fontName]),font.scale&&(fontScale=font.scale),console.log("figmaconf",figmaConfig,figmaConfig.fontScale),figmaConfig&&figmaConfig.fontScale&&figmaConfig.fontScale>.1&&(fontScale=figmaConfig.fontScale))}fontName&&(fontStyle+=`font: ${fontName}\n`),fontStyle+=`size: ${params.fontSize*ptToPixel*fontScale}\n`,fontStyle+=`align: ${align}\n`,"PERCENT"===params.letterSpacing.unit&&params.letterSpacing.value&&(fontStyle+=`letterSpacing: ${params.letterSpacing.value/100*fontScale}\n`),figmaConfig&&figmaConfig.lineHeight&&(lineHeight=figmaConfig.lineHeight),"PERCENT"===params.lineHeight.unit&&params.lineHeight.value&&(lineHeight*=params.lineHeight.value/100),lineHeight&&(fontStyle+=`lineHeight: ${lineHeight}\n`),fontStyle+=`width: ${params.width}\n`,fontStyle+=`height: ${params.height}\n`;let fill=params.fills[0];if(fill&&fill.color){let c=fill.color;fontStyle+=`color: ${new Color(c.r,c.g,c.b).getHexString()}\n`}$obj._input.setValue("fontStyle",fontStyle);let x=params.x;"center"===align?x+=params.width/2:"right"===align&&(x+=params.width);let transform=`x: ${x}\ny: ${params.y}`;params.rotation&&(transform+="\nrotation: "+params.rotation),$obj._input.setValue("transform",transform)}else if("RECTANGLE"===params.type){$obj._input.setValue("size",`${params.width}, ${params.height}`);let fill=params.fills[0];if(!fill)return;if("IMAGE"===fill.type)$obj._input.setValue("bg","assets/images/_scenelayout/uv.jpg");else if("SOLID"===fill.type){let c=fill.color,color=new Color(c.r,c.g,c.b);$obj._input.setValue("bg",color.getHexString())}let transform=`x: ${params.x}\ny: ${params.y}`;params.rotation&&(transform+="\nrotation: "+params.rotation),$obj._input.setValue("transform",transform)}},this.getLayer=async function(name){let timer;Hydra.LOCAL&&(timer=_this.delayedCall(_=>{_exists[name]||"mockup"===name||console.warn(`${name} doesn't exist in StageLayout ${_name}`)},1e3));for(let key in _layers){let layer=_layers[key];if(layer._uil){let uil=layer._uil;if(uil.id===name||uil.label===name)return timer&&clearTimeout(timer),layer}}return await _this.wait(_layers,name),timer&&clearTimeout(timer),_layers[name]},this.getLayers=async function(){let array=[];for(let i=0;i<arguments.length;i++)array.push(_this.getLayer(arguments[i]));return Promise.all(array)},this.getAllLayers=async function(){return await this.ready(),_layers},this.ready=async function(){await _this.wait(_this,"loaded"),await defer()},this.get("graph",_=>_graph),this.get("config",_=>_config),this.get("layerCount",_=>_data.layers)}),()=>{StageLayout.FIGMA_FONT={},StageLayout.LAYER_HOOKS=[],StageLayout.helpers={},StageLayout.loadFontConfig=async(path,json)=>{if(!json){path=path||"assets/data/figma-font.json";try{json=await get("assets/data/figma-font.json")}catch(e){return}}Stage.FIGMA_FONT_CONFIG=json.config}}),Class((function StageLayoutUtil(){Inherit(this,Component);var _data;const KEY="stagelayoututil_keys";var _compiled={};async function init(){await UILStorage.ready(),_data=JSON.parse(UILStorage.get(KEY)||"[]"),function compile(){_data.forEach(key=>{_compiled[key]=JSON.parse(UILStorage.get(`INPUT_Config_${key}_compiled`)||"{}");let resizeCode=UILStorage.get(`INPUT_Config_${key}_onResize`);resizeCode&&(_compiled[key].resize=new Function("$this",resizeCode))})}()}!async function(){await Hydra.ready(),window.Platform&&Platform.isPlatform||init()}(),this.save=function(key,data,input){let compiled=JSON.parse(input.get("compiled")||"{}");compiled[key]=data,input.setValue("compiled",JSON.stringify(compiled))},this.create=function(key){_data.includes(key)||(_data.push(key),UILStorage.set(KEY,JSON.stringify(_data)))},this.getCompiled=function(key){return _compiled[key]},this.reload=function(){return init()}}),"static"),Class((function Text3D(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_fontObject,$text;function initUIL(){(_config=InputUIL.create(_input.prefix+"_text3d",_group)).setLabel("Text3D"),_config.addTextarea("text").addTextarea("fontStyle"),_config.addToggle("anchor2D",!1),_config.addToggle("renderRetina",!1),_config.add("data","hidden"),UIL.sidebar&&(_config.onUpdate=key=>{if("data"!=key){let text=parseData(_config.get("text")),obj=getFontObject();_config.setValue("data",JSON.stringify(obj)),$text&&($text.setText(text,obj),obj.color&&$text.setColor(obj.color)),_this.onUpdate&&_this.onUpdate()}})}function parseData(text){if(!text||!text.includes("$DATA"))return text;for(;text.includes("$DATA");){let code=text.split("$DATA")[1].split(" ")[0].split("\n")[0],line="$DATA"+code;text=text.replace(line,eval(line.replace("$DATA","_this.parent.data")))}return text}function getFontObject(){let font=_config.get("fontStyle")||"",obj={};return font=font.split("\n"),font.forEach(line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val),"false"===val&&(obj[key]=!1),"true"===val&&(obj[key]=!0))}),obj}function initText(){if(!(_fontObject=JSON.parse(_config.get("data")||"{}")).size)return;Text3D.FONT_CONFIG&&(_fontObject.config=Text3D.FONT_CONFIG),Text3D.LANG_BREAK&&(_fontObject.langBreak=Text3D.LANG_BREAK),_fontObject.shader||(_fontObject.shader="Text3D");let text=parseData(_config.get("text"));text&&createText(text,_fontObject)}async function overrideLocalize(text,fontObject,cb){if(!text)return;_this.localized=!0,fontObject.text=text,_this.text&&_this.text.destroy&&_this.text.destroy(),_this.text=new Text3D.FallbackText,_this.text.setColor(_fontObject.color),_this.text.onSetText=text=>_this.setText(text);Text3D.createFallbackTexture(text,fontObject).then(texture=>{_this.text.setColor(fontObject.color);let geom=new PlaneGeometry(texture.width,texture.height);for(geom.computeBoundingBox(),"center"!=fontObject.align&&geom.applyMatrix((new Matrix4).makeTranslation(texture.width/2,0,0));_this.group.children.length;)_this.group.remove(_this.group.children[0]);return _this.text.createMesh(geom,texture),_this.add(_this.text.group),_this.text})}function createText(text,fontObject){if((fontObject.localize||_input.forceLocalize)&&Text3D.missingChars(text,fontObject))return overrideLocalize(text,fontObject);($text=$glText(text,null,null,fontObject)).enable3D(_config.get("anchor2D")),_config.get("renderRetina")?($text.anchor||($text.anchor=new Group),_this.add($text.anchor),GLUI.Scene.add($text)):_this.add($text.group),$text.text.onCreateShader=shader=>{let shaderName=_input.get("shader");shaderName&&(shader.fragmentShader=shader.fragmentShader.split("void main")[0]+"\n"+Shaders.getShader(shaderName+".fs"),shader.customCompile=shaderName),$text.text3d=_this,window[shaderName]&&(_this.shaderClass=_this.parent.initClass(window[shaderName],$text,shader,_group,_input),ShaderUIL.add(shader,_group).setLabel("Shader"))},_this.text=$text;let setText=$text.setText.bind($text);$text.setText=function(text,obj){if(obj)for(let key in obj)_fontObject[key]=obj[key];_fontObject.text=text,setText(text,_fontObject),_this.events.fire(Events.UPDATE),defer(setUniforms)},$text.loaded().then(_=>{$text&&(_this.shader=$text.mesh.shader,_this.shader.addUniforms({uTransition:{value:5,ignoreUIL:!0},uTranslate:{value:_this.translate,ignoreUIL:!0},uRotate:{value:_this.rotate,ignoreUIL:!0},uWordCount:{value:0,ignoreUIL:!0},uLetterCount:{value:0,ignoreUIL:!0},uLineCount:{value:0,ignoreUIL:!0},uByWord:{value:0,ignoreUIL:!0},uByLine:{value:0,ignoreUIL:!0},uPadding:{value:.3,ignoreUIL:!0},uBoundingMin:{value:(new Vector3).copy($text.dimensions.min)},uBoundingMax:{value:(new Vector3).copy($text.dimensions.max)}}),Text3D.onCreateShader&&Text3D.onCreateShader(_this.shader))}),setUniforms()}async function setUniforms(){if(await _this.wait(_this,"shader"),await $text.loaded(),_input&&_input.get){let depthWrite=_input.get("depthWrite"),depthTest=_input.get("depthTest");"boolean"==typeof depthWrite&&($text.mesh.shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&($text.mesh.shader.depthTest=depthTest);let blending=_input.get("blending");blending&&($text.mesh.shader.blending=blending)}_this.shader.set("uWordCount",$text.mesh.geometry.wordCount),_this.shader.set("uLetterCount",$text.mesh.geometry.letterCount),_this.shader.set("uLineCount",$text.mesh.geometry.lineCount),_this.shader.set("uBoundingMin",(new Vector3).copy($text.dimensions.min)),_this.shader.set("uBoundingMax",(new Vector3).copy($text.dimensions.max))}this.translate=new Vector3,this.rotate=new Vector3,_this.wildcard=_input.get("wildcard"),async function(){_this.group.text=_this,initUIL(),initText(),Text3D.onCreate&&Text3D.onCreate(_this)}(),this.get("fontObject",_=>_fontObject),this.setProperties=function(obj=_fontObject){return $text?($text.setText(obj.text,obj),setUniforms()):createText(obj.text,obj),_this.text.loaded()},this.setPropertiesCheck=function(obj,force){let applyProperties=!1;for(const key in obj)_fontObject[key]!==obj[key]&&(applyProperties=!0,_fontObject[key]=obj[key]);return applyProperties||force?_this.setProperties():Promise.resolve()},this.setText=function(text){if(_fontObject.text=text,$text){if(_fontObject.localize&&Text3D.missingChars(text,_fontObject))return _this.group.remove($text.group),_this.shader=void 0,$text=null,void createText(text,_fontObject);$text.setText(text),setUniforms(),$text.mesh&&($text.mesh.onBeforeRender(),$text.mesh.updateMatrixWorld(!0))}else createText(text,_fontObject)},this.setColor=function(color){_fontObject.color=color,_this.text&&_this.text.setColor(color)},this.set("animateByWord",async bool=>{_this.localized||(await _this.wait(_this,"shader"),_this.shader.set("uByWord",bool?1:0))}),this.set("animateByLine",async bool=>{_this.localized||(await _this.wait(_this,"shader"),_this.shader.set("uByLine",bool?1:0))}),this.set("animationPadding",async p=>{_this.localized||(await _this.wait(_this,"shader"),_this.shader.set("uPadding",p))}),this.set("transition",async v=>{if(_this.localized)return _this.text.alpha=v;await _this.wait(_this,"shader"),_this.shader.set("uTransition",v>0?1.5:-.5)}),this.tween=async function(val,time,ease,delay){return _this.localized?_this.text.tween(val,time,ease,delay):(await _this.wait(_this,"shader"),_this.shader.tween("uTransition",val>0?1.5:-.5,time,ease,delay))},this.upload=function(){$text&&$text.upload()},this.ready=function(){return _this.wait(_this,"shader")},this.set("renderOrder",v=>{$text&&$text.setZ(v)}),this.getDimensions=async _=>(await $text.loaded(),await $text.text.ready(),$text.dimensions)}),_=>{var _projection;Text3D.missingChars=function(){return!1},Text3D.measureScreen=async function($text,camera=World.CAMERA,z=0){_projection||(_projection=new ScreenProjection(World.CAMERA)),$text instanceof Text3D&&($text=$text.text),await $text.loaded(),$text.mesh.onBeforeRender(),$text.mesh.updateMatrixWorld(!0),await defer(),_projection.camera=camera;let bb=new Box3;bb.setFromObject($text.mesh),bb.min.z=bb.max.z=z;let min=_projection.project(bb.min).clone(),max=_projection.project(bb.max).clone();return{width:Math.abs(min.x-max.x),height:Math.abs(min.y-max.y)}}}),Class((function Track(){Inherit(this,Model);const _this=this,DEBUG=Utils.query("debug");this.page=function(path,title){let data={};title&&(data.page_title=title),path&&(data.page_path=path),window.gtag&&gtag("config",Config.ANALYTICS_ID,data),DEBUG&&(window.gtag||_this.flag("warnedPage")||console.warn("no gtag"),Config.ANALYTICS_ID||_this.flag("warnedPage")||console.warn("Config.ANALYTICS_ID required"),console.log(`>>> track page: '${JSON.stringify(data)}'`),_this.flag("warnedPage",!0))},this.event=function(category,action,label,value,params){let data={event:"event",event_category:null,event_action:null,event_label:null,value:null};category&&(data.event_category=category),action&&(data.event_action=action),label&&(data.event_label=label),value&&(data.value=value),params&&(data=Object.assign(params,data)),window.gtag&&gtag("event",action,data),DEBUG&&(window.gtag||_this.flag("warnedEvent")||console.log("no gtag"),console.log(`>>> track event: '${action}', '${JSON.stringify(data)}'`),_this.flag("warnedEvent",!0))}}),"Static"),Class((function UIL(){Inherit(this,Component);const _this=this;let _style,$el,_ui={};Hydra.ready(async _=>{if(!Utils.query("editMode")&&!(window.Platform&&window.Platform.isDreamPlatform&&Utils.query("uil"))&&(!Hydra.LOCAL||Device.mobile||window._BUILT_||!Utils.query("uil")&&!Device.detect("hydra")))return function doNotLoad(){Hydra.LOCAL&&Utils.query("remoteUIL")&&(_this.sidebar=_this.global=new UILPanel("null"))}();!function init(){(function initContainer(){$el=$("UIL"),$el.css({position:"fixed",contain:"strict"}).size("100%","100%").mouseEnabled(!1),document.body.insertAdjacentElement("beforeend",$el.div),$el.setZ(9999)})(),function initStyle(){let style=document.head.appendChild(document.createElement("style"));style.type="text/css",style.id="uil-style",style.appendChild(document.createTextNode("\n            .UIL ::-webkit-scrollbar { width:2px; }\n            .UIL ::-webkit-scrollbar-track { background:#161616; }\n            .UIL ::-webkit-scrollbar-thumb { background:#37A1EF; }\n        ")),_style=style}(),function initSidebar(){_this.add(new UILPanel("sidebar")),_this.add(new UILPanel("global",{side:"left"}))}(),function initGraph(){if(!_this.sidebar)return;let parent=_ui.sidebar.element.div;parent.insertBefore(UILGraph.instance().element.div,parent.firstChild)}()}(),_this.loaded=!0}),this.ready=function(){return _this.wait(_this,"loaded")},this.add=function(panel){return _ui[panel.id]=panel,_this[panel.id]=panel,$el.add(panel),_this},this.remove=function(id){let $panel=_ui[id];return $panel.eliminate&&$panel.eliminate(),$panel.destroy(),delete _ui[id],delete _this[id],_this},this.find=function(id){return Object.values(_ui).reduce((acc,el)=>acc.concat(el.find(id)),[])},this.enableSorting=function(id,enable){let el=_this.find(id)[0];return el&&el.enableSorting&&el.enableSorting(enable),_this},this.addCSS=function(control,style){if(control.styled)return;let node=document.createTextNode(style);return _style&&_style.appendChild(node),control.styled=!0,_this},this.REORDER="uil_reorder"}),"static"),Class((function CameraUIL(){this.UPDATE="camera_uil_update",this.add=function(light,group){return new CameraUILConfig(light,null===group?null:group||UIL.global)}}),"static"),Class((function CameraUILConfig(_camera,_uil){const _this=this;if(!_camera.prefix)throw"camera.prefix required when using MeshUIL";var prefix="CAMERA_"+_camera.prefix,_group=_uil?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:_camera.prefix,closed:!0});return _uil.add(folder),folder}():null;function initVec(key){let initValue=UILStorage.get(`${prefix}${key}`)||_camera[key].toArray();if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange(e=>{_group&&Events.emitter._fireEvent(CameraUIL.UPDATE,{prefix:prefix,key:key,val:e,vec:!0,group:_this}),_camera[key].fromArray(e)}),vector.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(vector)}_camera[key].fromArray(initValue)}function initNumber(key){let initValue=UILStorage.get(`${prefix}${key}`)||(void 0===_camera[key]?9999:_camera[key]);if(_group){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onChange(e=>{_camera[key]=e,_group&&Events.emitter._fireEvent(CameraUIL.UPDATE,{prefix:prefix,key:key,val:e,number:!0,group:_this})}),number.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(number)}_camera[key]=initValue}function update(e){e.prefix==prefix&&e.group!=_this&&(e.fov&&_camera.setFOV(e.val),e.number&&(_camera[e.key]=e.val),e.rotation&&_camera.group[e.key].fromArray(e.val),e.vec&&_camera[e.key].fromArray(e.val))}_camera.position&&initVec("position"),_camera.group&&(_camera.groupPos=_camera.group.position,initVec("groupPos"),function initRotation(){let key="rotation",toRadians=array=>array?(array.length=3,array.map(x=>Math.radians(x))):[0,0,0],initValue=toRadians(UILStorage.get(`${prefix}${key}`));if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:(array=initValue,array?(array.length=3,array.map(x=>Math.degrees(x))):[0,0,0])});vector.onChange(e=>{_group&&Events.emitter._fireEvent(CameraUIL.UPDATE,{prefix:prefix,key:key,val:toRadians(e),rotation:!0,group:_this}),_camera.group[key].fromArray(toRadians(e))}),vector.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(vector)}var array;_camera.group[key].fromArray(initValue)}()),function initFOV(key){let initValue=UILStorage.get(`${prefix}${key}`)||_camera.camera.fov||9999;if(_group){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onFinishChange(e=>{_group&&Events.emitter._fireEvent(CameraUIL.UPDATE,{prefix:prefix,key:key,val:e,fov:!0,group:_this}),_camera.setFOV(e),UILStorage.set(`${prefix}${key}`,e)}),_group.add(number)}defer(_=>{_camera.setFOV(initValue)})}("fov"),_camera.moveXY&&(initVec("moveXY"),initVec("lookAt"),initNumber("lerpSpeed"),initNumber("lerpSpeed2"),initNumber("deltaRotate"),initNumber("deltaLerp"),initNumber("wobbleSpeed"),initNumber("wobbleStrength"),initNumber("wobbleZ")),_group&&function addListeners(){Events.emitter._addEvent(CameraUIL.UPDATE,update,_this)}(),this.setLabel=function(name){_group&&_group.setLabel(name)}})),Class((function InputUIL(){this.UPDATE="inputUil_Update",this.create=function(name,group,decoupled){return new InputUILConfig(name,null===group?null:group||UIL.global,decoupled)}}),"static"),Class((function InputUILConfig(_name,_uil,_decoupled,_slim){var _this=this;const prefix="INPUT_"+_name;var _group=_uil?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(_name,{closed:!0});_decoupled||(_uil.add(folder),_uil==UIL.sidebar&&folder.hide());return folder}():null,_fields=_uil?{}:null;function externalUpdate(e){e.prefix==prefix&&e.group!=_this&&(UILStorage.set(`${prefix}_${e.key}`,e.value),_this.onUpdate&&_this.onUpdate(e.key))}_this.group=_group,_uil&&function addListeners(){Events.emitter._addEvent(InputUIL.UPDATE,externalUpdate,_this)}(),this.get=function(key){let val=UILStorage.get(`${prefix}_${key}`);return"boolean"==typeof val?val:val&&""!=val?"true"===val||"false"!==val&&(val.charAt&&"["==val.charAt(0)?JSON.parse(val):val):void 0},this.getNumber=function(key){return Number(this.get(key))},_slim||(this.add=function(key,initValue,uil=window.UILControlText,options,params={}){if(!_group||"hidden"==initValue||!UIL.sidebar)return this;let value=UILStorage.get(`${prefix}_${key}`);"true"===value&&(value=!0),"false"===value&&(value=!1),uil==UILControlVector&&"string"==typeof value&&(value=JSON.parse(value)),void 0===value&&(value=initValue),"string"==typeof value&&uil==UILControlImage&&(value=JSON.parse(value));let change=(val,fromInit)=>{val="string"==typeof val?val:JSON.stringify(val),UILStorage.set(`${prefix}_${key}`,val),_this.onUpdate&&_this.onUpdate(key,val),fromInit||Events.emitter._fireEvent(InputUIL.UPDATE,{prefix:prefix,key:key,value:val,group:_this})};"string"!=typeof initValue&&"number"!=typeof initValue&&uil!=UILControlVector||UILStorage.get(`${prefix}_${key}`)||change(initValue,!0);let opts=Utils.mergeObject(params,{label:key,value:value,options:options});uil==window.UILControlButton&&(opts=options);let config=new uil(`${prefix}_${key}`,opts);return config.onFinishChange(change),uil!=UILControlVector&&uil!=UILControlRange||config.onChange(change),_group.add(config),_fields[key]=config,this},this.addToggle=function(key,initValue){return UIL.sidebar?this.add(key,initValue,UILControlCheckbox):this},this.addSelect=function(key,options){return UIL.sidebar?this.add(key,null,UILControlSelect,options):this},this.addImage=function(key,options){return UIL.sidebar?this.add(key,null,UILControlImage,null,options):this},this.addRange=function(key,initValue,options){return UIL.sidebar?this.add(key,initValue,UILControlRange,null,options):this},this.addNumber=function(key,initValue,step){return UIL.sidebar?this.add(key,initValue,UILControlNumber,null,{step:step}):this},this.addColor=function(key,initValue=new Color){return UIL.sidebar?this.add(key,initValue.getHexString(),UILControlColor):this},this.addTextarea=function(key,initValue){return UIL.sidebar?this.add(key,initValue,UILControlTextarea,null,{monospace:!0,rows:4}):this},this.addButton=function(key,options){return UIL.sidebar?this.add(key,null,UILControlButton,options):this},this.addVector=function(key,initValue,options){return UIL.sidebar?(options||(options={step:.05}),this.add(key,initValue,UILControlVector,null,options)):this},this.getImage=function(key){let data=this.get(key);if(data)return JSON.parse(data).src},this.setValue=function(key,value){if(UILStorage.set(`${prefix}_${key}`,value),_this.onUpdate&&_this.onUpdate(key),_fields){let field=_fields[key];field&&(field.value=value,field.update&&field.update())}return this},this.copyFrom=function(input,fields){fields.forEach(key=>{let val=input.get(key);void 0!==val&&("string"!=typeof val&&(val=JSON.stringify(val)),_this.setValue(key,val))})},this.setLabel=function(name){_group&&_group.setLabel(name)},this.getField=function(key){if(_fields)return _fields[key]})})),Class((function ListUIL(){Inherit(this,Component);const _this=this;var _panel,_created={};function removePanel(){_panel&&_panel.destroy&&(_this.events.unsub(_panel,Events.COMPLETE,removePanel),_panel=_panel.destroy())}this.create=function(id,version=1,group){"number"!=typeof version&&(group=version,version=1),group=null===group?null:group||UIL.global;let config=new ListUILConfig(id,version,UIL.global&&!_created[id]);return UIL.global&&(_created[id]||(_created[id]=config,null!=group&&config.appendUILGroup(group||UIL.global))),config},this.openPanel=function(id,name,template){return removePanel(),_panel=new ListUILEditor(id,name,template),_this.events.sub(_panel,Events.COMPLETE,removePanel),_panel},this.set=function(){},this.get=function(){},this.getPanel=function(){return _panel}}),"static"),Class((function ListUILConfig(_id,_version=1,_store){Inherit(this,Component);const _this=this;var _items,_folder,_config,_template={onSort:_=>{},onAdd:_=>{},onRemove:_=>{}},_name="";function name(){return`LIST_${_id}_config`}function updateConfig(){_config.version=_version,UILStorage.setWrite(name(),_config)}function edit(){let panel=ListUIL.openPanel(_id,_name,_this.template);_this.events.bubble(panel,Events.UPDATE),_this.events.fire(ListUIL.OPEN)}_store&&(_items=[]),function initConfig(){(_config=UILStorage.get(name()))?_config.version!=_version&&(updateConfig(),UILStorage.clearMatch(name().split("_config")[0])):(_config={},updateConfig())}(),this.add=function(item){return _items&&_items.push(item),item},this.template=function(config){return"function"==typeof config&&(_template=config),_template},this.appendUILGroup=function(uil){let folder=new UILFolder("LIST_"+_id,{closed:!0}),button=new UILControlButton("button",{actions:[{title:"Edit List",callback:edit}],hideLabel:!0});folder.add(button),uil.add(folder),_folder=folder},this.setLabel=function(name){_folder&&_folder.setLabel(name),_name=name},this.onAdd=function(cb){_template.onAdd=cb},this.onRemove=function(cb){_template.onRemove=cb},this.onSort=function(cb){_template.onSort=cb},this.internalAddItems=function(count){if(!count)return;let array=[];for(let i=0;i<count;i++){let id=`${_id}_${Utils.timestamp()}`;array.push(id)}UILStorage.set(_id+"_list_items",JSON.stringify(array))}}),_=>{ListUIL.OPEN="list_uil_open"}),Class((function ListUILEditor(_id,_name,_template){Inherit(this,Component);const _this=this,PANEL_CONFIG={label:_name||"List",width:"400px",height:"auto",drag:!0};var _gui,_list,_add,_items,_tabs=[],_index=0;function initList(){!function read(){let data=UILStorage.get(_id+"_list_items");void 0===data&&(data="[]");_items=JSON.parse(data)}(),(_list=new UILFolder(_id+"_list",{hideTitle:!0})).enableSorting(_id),_gui.add(_list);for(let id of _items){let view=new ListUILItem(id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view)}}function initAdd(){!function initButton(title,callback){_add=new UILControlButton("button",{actions:[{title:title,callback:callback}],hideLabel:!0}),_gui.add(_add)}("Add Item",add)}function add(){let id=`${_id}_${Utils.timestamp()}`,view=new ListUILItem(id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view),_items.push(id),write()}function reorder(e){let order=[];for(let item of e.order)order.push(item.split("_folder")[0]);_items=order,_template().onSort(_items),write(),_this.events.fire(Events.UPDATE,{order:order})}function close(){_this.events.fire(Events.COMPLETE)}function remove(e){_items.remove(e.id),write(),refresh()}function write(){let data=JSON.stringify(_items);UILStorage.set(_id+"_list_items",data)}function refresh(){_index=0,_list&&_list.destroy&&(_list=_list.destroy()),_add&&_add.destroy&&(_add=_add.destroy()),initList(),initAdd()}!function initPanel(){_this.gui=_gui=new UILWindow(_id,PANEL_CONFIG),_this.gui.onClose=close,UIL.add(_gui)}(),refresh(),this.onDestroy=function(){_gui.destroy()},this.add=function(){add()}})),Class((function ListUILItem(_id,_parent,_template,_index){Inherit(this,Component);const _this=this;var _folder;function onDelete(){if(!confirm("You sure you want to delete this?"))return;let id=_id;_template().onRemove(id),_this.events.fire(Events.END,{id:id})}function onReorder(e){_this.events.fire(Events.UPDATE,e)}!async function initFolder(){(_folder=InputUIL.create(_id+"_folder",_parent)).setLabel("Item"),_folder.group.draggable(!0),_this.events.sub(_folder.group,UIL.REORDER,onReorder),_folder.listUILItem=_this}(),function initTemplate(){let id=_id;(0,_template().onAdd)(id,_folder,_index)}(),function initUI(){let actions=[{title:"Delete",callback:onDelete}];_folder.addButton("delete",{actions:actions,hideLabel:!0})}(),this.setLabel=function(label){_folder.setLabel(label)},this.forceSort=function(index){_folder.group.forceSort(index)},this.open=function(){_folder.group.open(),_folder.group.openChildren()},this.close=function(){_folder.group.close()}})),Class((function MeshUIL(){Inherit(this,Component);this.exists={},this.UPDATE="mesh_uil_update",this.add=function(mesh,group){return new MeshUILConfig(mesh,null===group?null:group||UIL.global)}}),"static"),Class((function MeshUILConfig(_mesh,_uil){const _this=this;if(!_mesh.prefix)throw"mesh.prefix required when using MeshUIL";var prefix="MESH_"+_mesh.prefix,_group=_uil&&!MeshUIL.exists[prefix]?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:_mesh.prefix,closed:!0});return _uil.add(folder),folder}():null,_controls=_group?{}:null;function initVec(key){let initValue=UILStorage.get(`${prefix}${key}`)||_mesh[key].toArray();if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange(e=>{_mesh[key].fromArray(e),_group&&Events.emitter._fireEvent(MeshUIL.UPDATE,{prefix:prefix,key:key,val:e,group:_this})}),vector.onFinishChange(save),_group.add(vector),_controls[key]=vector}_mesh[key].fromArray(initValue)}function save(){for(let key in _controls){let value=_controls[key].value;UILStorage.set(`${prefix}${key}`,value)}}function update(e){e.prefix==prefix&&e.group!=_this&&_mesh[e.key].fromArray(e.val)}this.group=_group,MeshUIL.exists[prefix]=!0,initVec("position"),initVec("scale"),function initRotation(){let key="rotation",toRadians=array=>array?(array.length=3,array.map(x=>Math.radians(x))):[0,0,0],initValue=toRadians(UILStorage.get(`${prefix}${key}`));if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:(array=initValue,array?(array.length=3,array.map(x=>Math.degrees(x))):[0,0,0])});vector.onChange(e=>{_mesh[key].fromArray(toRadians(e)),_group&&Events.emitter._fireEvent(MeshUIL.UPDATE,{prefix:prefix,key:key,val:toRadians(e),group:_this})}),vector.onFinishChange(save),_group.add(vector),_controls[key]=vector}var array;_mesh[key].fromArray(initValue)}(),_group&&function addListeners(){Events.emitter._addEvent(MeshUIL.UPDATE,update,_this)}(),this.setLabel=function(name){_group&&_group.setLabel(name)}})),Class((function ShaderUIL(){this.exists={},this.UPDATE="shader_update",this.TEXTURE_UPDATE="shader_texture_update",this.add=function(shader,group){return new ShaderUILConfig(shader.shader||shader,null===group?null:group||UIL.global)}}),"static"),Class((function ShaderUILConfig(_shader,_uil){var _textures,_this=this;const prefix=_shader.UILPrefix;var _group=_uil&&!ShaderUIL.exists[prefix]?function createFolder(){if(!UIL.sidebar)return null;let label=function getName(){let split=_shader.UILPrefix.split("/");return split.length>2?split[0]+"_"+split[2]:split[0]}();"_"==label.charAt(label.length-1)&&(label=label.slice(0,-1));let folder=new UILFolder(prefix+label,{label:label,closed:!0});return _uil.add(folder),folder}():null;function createVector(obj,key){let initValue=UILStorage.get(`${prefix}${key}`)||obj.value.toArray();if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange(val=>{obj.value.fromArray(val),_shader.ubo&&(_shader.ubo.needsUpdate=!0),Events.emitter._fireEvent(ShaderUIL.UPDATE,{prefix:prefix,key:key,val:val,group:_this,vector:!0})}),vector.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(vector)}obj.value.fromArray(initValue)}function createTexture(obj,key){_group&&!_textures&&(_textures={});const getTexture=obj.getTexture||ShaderUIL.getTexture||Utils3D.getTexture,set=_shader.parent&&_shader.parent.setOverride?_shader.parent.setOverride:_shader.set||_shader.setUniform,get=_shader.get||_shader.getUniform;let prefix=_shader.UILPrefix+"_tx",data=UILStorage.get(`${prefix}_${key}`);data&&(data=JSON.parse(data));let value=data?data.src:null,change=data=>{let val=data.src,cleanPath=val.includes("?")?val.split("?")[0]:val;data.compressed&&(val+="-compressedKtx"),_textures&&(_textures[cleanPath]=change),data.src=cleanPath,UILStorage.set(`${prefix}_${key}`,JSON.stringify(data)),set(key,getTexture(val,{premultiplyAlpha:obj.premultiplyAlpha,scale:obj.scale}),_shader),_group&&Events.emitter._fireEvent(ShaderUIL.UPDATE,{prefix:_shader.UILPrefix,key:key,val:val,texture:get(key,_shader),group:_this})};if(value&&value.length&&change(data),_group){let img=new UILControlImage(prefix+key,{label:key,value:data});img.onFinishChange(change),_group.add(img)}}function createNumber(obj,key){let initValue=UILStorage.get(`${prefix}${key}`);if(void 0===initValue&&(initValue=obj.value),_group){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onChange(val=>{_shader.ubo&&(_shader.ubo.needsUpdate=!0),Events.emitter._fireEvent(ShaderUIL.UPDATE,{prefix:prefix,key:key,val:val,group:_this}),obj.value=val}),number.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(number)}obj.value=initValue}function createColor(obj,key){let initValue=UILStorage.get(`${prefix}${key}`);if(_group){let color=new UILControlColor(`${prefix}${key}`,{label:key,value:initValue});color.onChange(val=>{obj.value.set(val),_shader.ubo&&(_shader.ubo.needsUpdate=!0),_group&&Events.emitter._fireEvent(ShaderUIL.UPDATE,{prefix:prefix,key:key,val:val,color:!0,group:_this})}),color.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(color)}initValue&&obj.value.set(initValue)}function textureUpdate(e){if(!_textures)return;let cleanPath=e.file.split("?")[0];for(let key in _textures)cleanPath==key&&_textures[key]({src:e.file})}function update(e){if(e.prefix==_shader.UILPrefix&&e.group!=_this)if(e.color){let val=e.val,obj=_shader.uniforms[e.key];Array.isArray(val)?obj.value.setRGB(val[0],val[1],val[2]):obj.value.set(val)}else e.texture?"remote"!=e.texture&&_shader.set(e.key,e.texture):e.vector?_shader.uniforms[e.key].value.fromArray(e.val):_shader.uniforms[e.key].value=e.val}this.group=_group,ShaderUIL.exists[_shader.UILPrefix]=!0,function initItems(){for(var key in _shader.uniforms){let obj=_shader.uniforms[key];obj&&!obj.ignoreUIL&&(obj.value instanceof Color&&createColor(obj,key),"number"==typeof obj.value&&createNumber(obj,key),(null===obj.value||obj.value instanceof Texture)&&createTexture(obj,key),obj.value instanceof Vector2&&createVector(obj,key),obj.value instanceof Vector3&&createVector(obj,key),obj.value instanceof Vector4&&createVector(obj,key))}}(),_group&&function addListeners(){Events.emitter._addEvent(ShaderUIL.UPDATE,update,_this),Events.emitter._addEvent(ShaderUIL.TEXTURE_UPDATE,textureUpdate,_this)}(),this.setLabel=function(name){_group&&_group.setLabel(name)}})),Class((function ShadowUIL(){this.add=function(light,group){return new ShadowUILConfig(light,null===group?null:group||UIL.global)}}),"static"),Class((function ShadowUILConfig(_light,_uil){if(!_light.prefix)throw"light.prefix required when using MeshUIL";var prefix="SHADOW_"+_light.prefix,_group=_uil?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:_light.prefix,closed:!0});return _uil.add(folder),folder}():null;function initNumber(key){let initValue=UILStorage.get(`${prefix}${key}`)||_light.shadow[key];if(_group){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onFinishChange(e=>{_light.shadow[key]=e,UILStorage.set(`${prefix}${key}`,e)}),_group.add(number)}_light.shadow[key]=initValue}function initVec(key){let initValue=UILStorage.get(`${prefix}${key}`)||_light[key].toArray();if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange(e=>{_light[key].fromArray(e),"target"==key&&_light.shadow.camera.lookAt(_light.target)}),vector.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(vector)}_light[key].fromArray(initValue)}_light.target=_light.shadow.target,initVec("position"),initVec("target"),initNumber("fov"),initNumber("size"),initNumber("area"),initNumber("near"),initNumber("far"),function initTick(key){let initValue=UILStorage.get(`${prefix}${key}`);if(_group){let tick=new UILControlCheckbox(`${prefix}${key}`,{label:key,value:initValue});tick.onFinishChange(e=>{_light[key]=e,UILStorage.set(`${prefix}${key}`,e)}),_group.add(tick)}_light[key]=initValue}("static"),this.setLabel=function(name){_group&&_group.setLabel(name)}})),Class((function TimelineUIL(){Inherit(this,Component);const _this=this;var _panel,_created={};function removePanel(){_panel&&_panel.destroy&&(_this.events.unsub(_panel,Events.COMPLETE,removePanel),_panel=_panel.destroy())}this.create=function(id,version=1,group){"number"!=typeof version&&(group=version,version=1),group=null===group?null:group||UIL.global;let config=new TimelineUILConfig(id,version,UIL.global&&!_created[id]);return UIL.global&&(_created[id]||(_created[id]=config,null!=group&&config.appendUILGroup(group||UIL.global))),config},this.openPanel=function(id,name,template){return removePanel(),_panel=new TimelineUILEditor(id,name,template),_this.events.sub(_panel,Events.COMPLETE,removePanel),_panel},this.set=function(){},this.get=function(){}}),"static"),Class((function TimelineUILConfig(_id,_version=1,_store){Inherit(this,Component);const _this=this;var _items,_folder,_config,_template={onSort:_=>{},onAdd:_=>{},onRemove:_=>{}},_name="";function name(){return`TL_${_id}_config`}function updateConfig(){_config.version=_version,UILStorage.setWrite(name(),_config)}function edit(){let panel=TimelineUIL.openPanel(name(),_name,_this.template);_this.events.bubble(panel,Events.UPDATE),_this.events.fire(TimelineUIL.OPEN)}this.model=new TimelineUILModel(name()),_store&&(_items=[]),function initConfig(){(_config=UILStorage.get(name()))?_config.version!=_version&&(updateConfig(),UILStorage.clearMatch(name().split("_config")[0])):(_config={},updateConfig())}(),this.add=function(item){return _items&&_items.push(item),item},this.template=function(config){return"function"==typeof config&&(_template=config),_template},this.appendUILGroup=function(uil){let folder=new UILFolder("TL_"+_id,{closed:!0}),button=new UILControlButton("button",{actions:[{title:"Edit Timeline",callback:edit}],hideLabel:!0});folder.add(button),uil.add(folder),_folder=folder},this.setLabel=function(name){_folder&&_folder.setLabel(name),_name=name},this.onAdd=function(cb){_template.onAdd=cb},this.onRemove=function(cb){_template.onRemove=cb},this.onSort=function(cb){_template.onSort=cb},this.internalAddItems=function(count){if(!count)return;let array=[];for(let i=0;i<count;i++){let id=`${_id}_${Utils.timestamp()}`;array.push(id)}UILStorage.set(_id+"_list_items",JSON.stringify(array))}}),_=>{TimelineUIL.OPEN="list_uil_open"}),Class((function TimelineUILEditor(_id,_name,_template){Inherit(this,Component);const _this=this,PANEL_CONFIG={label:"Timeline Editor",width:"800px",height:"auto",drag:!0};var _gui,_list,_add,_config,_items,_tabs=[],_index=0;function initList(){!function read(){let data=UILStorage.get(_id+"_list_items");void 0===data&&(data="[]");_items=JSON.parse(data)}(),_list=new UILFolder(_id+"_list",{hideTitle:!0}),_gui.add(_list);for(let id of _items){let view=_this.initClass(TimelineUILItem,id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view)}_config.rails&&function attachRails(){_tabs.forEach((t,i)=>{t.onUpdate=v=>{_tabs.forEach((t2,j)=>{t2!=t&&(j<i&&t.getValue()<t2.getValue()&&t2.setValue(t.getValue()),j>i&&t.getValue()>t2.getValue()&&t2.setValue(t.getValue()))})}})}()}function initButton(title,callback){let btn=new UILControlButton("button",{actions:[{title:title,callback:callback}],hideLabel:!0});return _gui.add(btn),btn}function spaceEvenly(){_tabs.forEach((t,i)=>{let perc=Math.range(i,0,_tabs.length-1,0,1);t.setValue(perc)})}function add(){let id=`${_id}_${Utils.timestamp()}`,view=new TimelineUILItem(id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view),_items.push(id),write()}function reorder(e){let order=[];for(let item of e.order)order.push(item.split("_folder")[0]);_items=order,_template().onSort(_items),write(),_this.events.fire(Events.UPDATE,{order:order})}function remove(e){_items.remove(e.id),write(),refresh()}function write(){let data=JSON.stringify(_items);UILStorage.set(_id+"_list_items",data)}function refresh(){_index=0,_list&&_list.destroy&&(_list=_list.destroy()),_add&&_add.destroy&&(_add=_add.destroy()),initList(),function initAdd(){_config.lock||(_add=initButton("Add Item",add)).element.css({width:"20%"}),initButton("Space Evenly",spaceEvenly).element.css({width:"20%"})}()}_this.config=_config=JSON.parse(UILStorage.get(_id+"_config")||"{}"),function initPanel(){_this.gui=_gui=new UILWindow(_id,PANEL_CONFIG),UIL.add(_gui)}(),refresh(),this.onDestroy=function(){_gui.destroy()}})),Class((function TimelineUILItem(_id,_parent,_template,_index){Inherit(this,Component);const _this=this;var _folder;function onDelete(){if(!confirm("You sure you want to delete this?"))return;let id=_id;_template().onRemove(id),_this.events.fire(Events.END,{id:id})}function onReorder(e){_this.events.fire(Events.UPDATE,e)}!async function initFolder(){(_folder=InputUIL.create(_id+"_folder",_parent)).setLabel("Item"),_this.parent&&_this.parent.config.lock||_folder.group.draggable(!0),_this.events.sub(_folder.group,UIL.REORDER,onReorder),_folder.group.open()}(),function initTemplate(){let id=_id;(0,_template().onAdd)(id,_folder,_index)}(),function initUI(){_folder.add("label",_this.parent&&_this.parent.config.lock?"hidden":void 0),_folder.addRange("keyframe"),_folder.add("percent","hidden"),_folder.getField("keyframe").force(Math.round(100*_folder.getNumber("percent"))||0),_folder.onUpdate=key=>{if("keyframe"==key){let val=_folder.getNumber(key)/100;_folder.setValue("percent",val),_this.onUpdate&&_this.onUpdate(val)}};let label=_folder.get("label");if(label&&_folder.setLabel(label),!_this.parent||!_this.parent.config.lock){let actions=[{title:"Delete",callback:onDelete}],hideLabel=!0,btn=(_folder.addButton("delete",{actions:actions,hideLabel:hideLabel}),_folder.getField("delete"));btn&&btn.$content.css({width:"20%"})}}(),this.setLabel=function(label){_folder.setLabel(label)},this.getValue=function(value){return _folder.getNumber("percent")},this.setValue=function(value){_folder.setValue("percent",value),_folder.getField("keyframe").force(Math.round(100*value)||0)}})),Class((function TimelineUILModel(_id){var _items,_config,_data=[],_map={};!function initItems(){_config=JSON.parse(UILStorage.get(_id+"_config")||"{}"),_items=JSON.parse(UILStorage.get(_id+"_list_items")||"[]")}(),function initData(){_items.forEach((item,i)=>{let input=InputUIL.create(item+"_folder",null,null,!!UIL.global),data={};data.label=input.get("label")||"Item",data.value=input.getNumber("percent")||0,data.arbitrary=input.get("arbitrary"),_data.push(data),_map[data.label]=data,UIL.global&&Render.start(_=>{data.label=input.get("label")||"Item",data.value=input.getNumber("percent")||0},10)})}(),this.setState=function(array){for(let i=0;i<array.length;i++)_items[i]||_items.push(`${_id}_${Utils.timestamp()}`);_items.length>array.length&&(_items=_items.slice(0,array.length)),_items.forEach((item,i)=>{let data=array[i],input=InputUIL.create(item+"_folder",null);input.setValue("label",data.label),data.percent&&input.setValue("percent",data.percent),data.arbitrary&&input.setValue("percent",data.arbitrary)}),UILStorage.set(_id+"_list_items",JSON.stringify(_items))},this.lock=function(){return _config.lock||(_config.lock=!0,UIL.global&&UILStorage.set(_id+"_config",JSON.stringify(_config))),this},this.rails=function(){return _config.rails||(_config.rails=!0,UIL.global&&UILStorage.set(_id+"_config",JSON.stringify(_config))),this},this.getData=function(){return _data},this.get=function(key){return _map[key]}})),Class((function TweenUIL(){var _folder,_cache={};this.create=function(name,config,group,repeatable,autoplay=!0){if(_folder||function initFolder(){UIL.global&&(_folder=new UILFolder("tweenUIL",{label:"Tweens",closed:!0}),UIL.global.add(_folder))}(),repeatable){let tween=new TweenUILConfig(name,config,group||_folder);return autoplay&&tween.play(),tween}return _cache[name]||(_cache[name]=new TweenUILConfig(name,config,group||_folder)),autoplay&&_cache[name].play(),_cache[name]}}),"static"),Class((function TweenUILConfig(_name,_config,_group){Inherit(this,Component);const _this=this;var _input,_layers,_promise,_exec,resolve,_cache={};function editCode(){let editor=new UILExternalEditor(_name,400,900);editor.setCode(_input.get("code")||"//Keys: "+Object.keys(_config).join(", "),"c"),editor.onSave=value=>{_input.setValue("code",value),evaluate(_input.get("code"))},UIL.add(editor)}function replay(){for(let key in _cache){let el=_cache[key];switch(el.type){case"hydra":TweenManager._clearCSSTween(el.obj),el.obj.css(el.css).transform(el.transform);break;case"mesh":el.obj.position.copy(el.position),el.obj.scale.copy(el.scale),el.obj.quaternion.copy(el.quaternion),TweenManager.clearTween(el.obj.position),TweenManager.clearTween(el.obj.scale),TweenManager.clearTween(el.obj.quaternion);break;case"shader":for(let key in el.uniforms)TweenManager.clearTween(el.obj.uniforms[key]),"number"==typeof el.uniforms[key]?el.obj.set(key,el.uniforms[key]):(TweenManager.clearTween(el.obj.uniforms[key].value),el.obj.get(key).copy(el.uniforms[key]));break;case"glui":TweenManager.clearTween(el.obj);for(let key in el.values)el.obj[key]=el.values[key]}}_this.play()}function cacheHydraObject(obj){let transform={},css={};return transform.x=obj.x||0,transform.y=obj.y||0,transform.z=obj.z||0,transform.scale=obj.scale||1,void 0!==obj.scaleX&&(transform.scaleX=obj.scaleX),void 0!==obj.scaleY&&(transform.scaleY=obj.scaleY),transform.rotation=obj.rotation||0,transform.rotationX=obj.rotationX||0,transform.rotationY=obj.rotationY||0,transform.rotationZ=obj.rotationZ||0,css.opacity=obj.css("opacity")||1,{obj:obj,transform:transform,css:css,type:"hydra"}}function cacheGLUI(obj){let values={};return values.x=obj.x||0,values.y=obj.y||0,values.z=obj.z||0,values.scale=obj.scale||1,values.scaleX=obj.scaleX,values.scaleY=obj.scaleY,values.rotation=obj.rotation||0,values.rotationX=obj.rotationX||0,values.rotationY=obj.rotationY||0,values.rotationZ=obj.rotationZ||0,{obj:obj,values:values,type:"glui"}}function cacheMesh(obj){return{obj:obj,position:obj.position.clone(),scale:obj.scale.clone(),quaternion:obj.quaternion.clone(),type:"mesh"}}function cacheShader(obj){let uniforms={};for(let key in obj.uniforms){let uniform=obj.uniforms[key];uniform.value instanceof Vector2||uniform.value instanceof Vector3||uniform.value instanceof Vector4||uniform.value instanceof Quaternion||uniform.value instanceof Color?uniforms[key]=uniform.value.clone():"number"==typeof uniform.value&&(uniforms[key]=uniform.value)}return{obj:obj,uniforms:uniforms,type:"shader"}}function cache(obj,key){UIL.global&&!_cache[key]&&(obj instanceof HydraObject?_cache[key]=cacheHydraObject(obj):obj.position?_cache[key]=cacheMesh(obj):obj instanceof Shader?_cache[key]=cacheShader(obj):(obj instanceof GLUIObject||obj instanceof GLUIText)&&(_cache[key]=cacheGLUI(obj)))}async function evaluate(code){let single;if(_layers={},_config.loadedAllLayers&&(await _config.loadedAllLayers(),_layers[_config.name]=_config,single=_config),Array.isArray(_config))_config.forEach(layout=>{_layers[layer.name]=layout}),await Promise.all(_config.map(layout=>layout.loadedAllLayers()));else{let promises=[];for(let key in _config)_config[key].loadedAllLayers&&promises.push(_config[key].loadedAllLayers()),_layers[key]=_config[key];await Promise.all(promises)}let keys=Object.keys(_layers);for(;code.includes("${");){let matched=!1,match=code.match(/\${([^\}]*)}/);if(match[1].includes(".")){if(!match[1].includes(keys))throw`TweenUIL::${_name} has no top level parent ${match[1]}\n${code}`;{let[key,name]=match[1].split(".");if(_layers[key].loadedAllLayers&&!_layers[key].exists(name))throw`TweenUIL::${_name} has no layer ${match[1]}\n${code}`;let split=match[1].split("."),lookupString=`_layers.${split[0]}.layers.${split[1]}`,lookupObj=_layers[split[0]].layers[split[1]];!_exec&&lookupObj.ready&&await lookupObj.ready();for(let i=2;i<split.length;i++)split[i]&&(lookupString+="."+split[i],lookupObj=lookupObj[split[i]],!_exec&&lookupObj.ready&&await lookupObj.ready());code=code.replace(match[0],lookupString),_exec||cache(lookupObj,match[1]),matched=!0}}else if(single){let split=match[1].split(".");if(!single.exists(match[1]))throw`TweenUIL::${_name} has no layer ${match[1]}\n${code}`;let lookupString=`_layers.${single.name}.layers.${split[0]}`,lookupObj=_layers[single.name].layers[split[0]];!_exec&&lookupObj.ready&&await lookupObj.ready();for(let i=1;i<split.length;i++)split[i]&&(lookupString+="."+split[i],lookObj=lookupObj[split[i]],!_exec&&lookupObj.ready&&await lookupObj.ready());code=code.replace(match[0],lookupString),_exec||cache(lookupObj,match[1]),matched=!0}else null==_layers[match[1]]&&null==_layers[match[1]]||(code=code.replace(match[0],"_layers."+match[1]),_exec||cache(_layers[match[1]],match[1]),matched=!0);if(!matched)throw`TweenUIL::${_name} couldn't find object!\n${code}`}_exec=eval(`(function() { return function exec(e) { \n ${code} \n } })();`)}!async function(){(_input=InputUIL.create(_name+"_tween",_group)).setLabel(_name),_input.addButton("edit",{label:"Edit",actions:[{title:"Edit Code",callback:editCode}]}),_input.addButton("replay",{label:"Replay",actions:[{title:"Replay",callback:replay}]}),_input.add("code","hidden"),await evaluate(_input.get("code")||""),_this.flag("ready",!0)}(),this.play=async function(){await _this.wait("ready"),_promise=Promise.create(),resolve=_promise.resolve,_exec(_config.e)},this.promise=async function(){return await _this.wait("ready"),_promise}})),Class((function UILFile(_offline,_path){Inherit(this,Component);this.load=async function(){let path=window.UIL_STATIC_PATH||"assets/data/uil.json";try{return await get(path)}catch(e){return{}}},this.save=async function(sessionData,data){if(Dev.writeFile(window.UIL_STATIC_PATH||"assets/data/uil.json",data),_offline){let partial={};try{partial=await get("assets/data/uil-partial.json",data);for(let key in sessionData)partial[key]=sessionData[key]}catch(e){partial=sessionData}Dev.writeFile("assets/data/uil-partial.json",partial),Storage.set("uil_update_partial",!0)}}})),Class((function UILStorage(){Inherit(this,Component);const _this=this;var _platform,_fs,_keys,_storeIds=[],_data={},_dataSession={},_id=window.UIL_ID||"default";this.SAVE="uil_save";const OFFLINE_FIREBASE=Utils.query("offlineFB");function clearOfflineData(){Storage.set("uil_update_partial",!1),Dev.writeFile("assets/data/uil-partial.json",{})}async function init(){if(_fs&&_fs.destroy(),_fs=_this.initClass(uilFile()?UILFile:UILRemote,OFFLINE_FIREBASE),_data[_id]=await _fs.load(),_this.loaded=!0,!OFFLINE_FIREBASE&&Storage.get("uil_update_partial")&&!uilFile()){if(!confirm("Looks like you have UIL data captured offline, do you want to sync it to Firebase?"))return clearOfflineData();let data=await get("assets/data/uil-partial.json");for(let key in data)_this.set(key,data[key]);write(!0,!0),clearOfflineData()}}async function write(direct,silent){let prevent=!1,e={prevent:_=>prevent=!0};_this.events.fire(_this.SAVE,e),!direct&&(e.wait&&await e.wait(),prevent)||(_fs.save(_dataSession,_data[_id]),_dataSession={},silent||(__body.css({display:"none"}),_this.delayedCall(()=>{__body.css({display:"block"})},100)))}function uilFile(){return!Utils.query("editMode")&&((!window.DREAM_CONFIG||!Utils.query("uil"))&&(!Hydra.LOCAL||(!!Device.mobile||(!!OFFLINE_FIREBASE||(!!window._BUILT_||(!!window.AURA||(!!window._UIL_FILE_||(!window._FIREBASE_UIL_&&!window.UIL_ID||!Device.detect("hydra")&&!Utils.query("uil")))))))))}Hydra.ready(async _=>{window.Platform&&Platform.isDreamPlatform&&window.DREAM_CONFIG?async function initLocalCached(){_fs=_this.initClass(UILFile),_data[_id]=await _fs.load(),_this.loaded=!0}():window.Platform&&window.Platform.isPlatform||init(),(Utils.query("editMode")||window.Platform&&window.Platform.isDreamPlatform&&Utils.query("uil")||Hydra.LOCAL&&!Device.mobile&&!window._BUILT_&&(Utils.query("uil")||Device.detect("hydra")))&&__window.bind("keydown",e=>{(e.ctrlKey||e.metaKey)&&83==e.keyCode&&(e.preventDefault(),write())})}),this.reload=function(id,path,persist){_this.loaded=!1,_platform||(_platform=_id),persist&&_storeIds.push(id),_id=id,window.UIL_ID=id,window.UIL_STATIC_PATH=path,init()},this.set=function(key,value){null===value?(delete _data[_id][key],delete _dataSession[key]):(_data[_id][key]=value,_dataSession[key]=value)},this.setWrite=function(key,value){this.set(key,value),write(!0)},this.clearMatch=function(string){for(let key in _data[_id])key.includes(string)&&delete _data[_id][key];write(!0)},this.write=function(silent){write(!0,silent)},this.get=function(key){let val=_data[_id]&&_data[_id][key];if(void 0===val&&_platform&&(val=_data[_platform][key]),void 0===val&&_storeIds)for(let i=0;i<_storeIds.length;i++)val=_data[_storeIds[i]][key];return val},this.ready=function(){return _this.wait(_this,"loaded")},this.getKeys=function(){return _keys||(_keys=Object.keys(_data[_id])),_keys},this.parse=function(key,hint){let data=_data[_id][key];if(void 0===data)return null;if(Array.isArray(data)){if(hint instanceof Vector2)return{value:(new Vector2).fromArray(data)};if(hint instanceof Vector3)return{value:(new Vector3).fromArray(data)};if(hint instanceof Vector4)return{value:(new Vector4).fromArray(data)}}else if("string"==typeof data&&"#"===data.charAt(0))return{value:new Color(data)};return{value:data}}}),"static"),Class((function UILControl(){Inherit(this,Element);const _this=this;let $this,$label,$content,$view,_value,_previous,_label,_opts,_visible=!0,_onChange=()=>{},_onFinishChange=()=>{};function isEqual(a,b){return Array.isArray(a)||Array.isArray(b)?a+""==b+"":"object"==typeof a||"object"==typeof b?JSON.stringify(a)===JSON.stringify(b):a===b}function clone(value){return Array.isArray(value)?[...value]:"object"==typeof value?Object.assign({},value):value}!function initHTML(){$this=_this.element,$this.size("100%","auto"),$this.css({position:"relative",display:"inline-block",borderBottom:"1px solid #161616",padding:"2px 0",boxSizing:"border-box"}),$this.attr("data-type","UILControl"),$this.div._this=_this}(),function initLabel(){$label=$this.create("label"),$label.size("100px","auto").fontStyle("sans-serif",12,"#9B9C9B"),$label.css({paddingLeft:4,paddingTop:2,boxSizing:"border-box",verticalAlign:"top",float:"left"}),_this.$label=$label}(),function initContent(){$content=$this.create("content"),$content.size("calc(100% - 100px)","auto").css({float:"left"}),_this.$content=$content}(),this.init=function(id,opts={}){_this.id=id,_opts=opts,_this.setLabel(opts.label||id),_value=clone(opts.value),_previous=clone(_value),$this.attr("data-id",id)},this.finish=function(history=!0){_onFinishChange(_value),isEqual(_value,_previous)||(history&&UILHistory.set(_this,_previous),UILLocalStorage.set(_this.id,_value),_previous=clone(_value))},this.force=function(value){_this.value=clone(value),_this.finish(!1)},this.debounce=function(callback,time=250){let interval;return(...args)=>{clearTimeout(interval),interval=setTimeout(()=>{interval=null,callback(...args)},time)}},this.onChange=function(cb){return _onChange=cb,_this},this.onFinishChange=function(cb){return _onFinishChange=cb,_this},this.get("value",()=>_value),this.set("value",value=>{isEqual(value,_value)||(_value=clone(value),_this.update&&_this.update(_value),_onChange(_value))}),this.get("view",()=>$view),this.set("view",view=>{$view&&$view.destroy(),$view=view,$content.add($view)}),this.hide=function(){return _visible=!1,$this.css({display:"none"}),_this},this.show=function(){return _visible=!0,$this.css({display:"inline-block"}),_this},this.isVisible=function(){return _visible},this.setLabel=function(label){_label=label,_this.label=label,$label.text(label),$label.attr("title",label)}})),Class((function UILFolder(_id,_opts={drag:!0}){Inherit(this,Element);const _this=this;let $this,$header,$container,$toggle,$drag,$title,_children={},_open=!_opts.closed,_visible=!0,_order=[],_draggable=!1,_sortableChildren=!1,_headerDrag=!1;var _hasClipboard=!1;_this.id=_id,_this.label=""+(_opts.label||_id),_this.level=-1;function removeDragHandlers(){$this.div.removeEventListener("dragstart",dragStart,!1),$this.div.removeEventListener("dragover",dragOver,!1),$this.div.removeEventListener("drop",drop,!1)}function matchItem(str,item){return UILFuzzySearch.search(str,item.id.toLowerCase())||UILFuzzySearch.search(str,item.label.toLowerCase())}function dragStart(e){if(!UILFolder.DragLock){if(!_headerDrag)return e.preventDefault(),void e.stopPropagation();UILFolder.DragLock=_this.id,e.dataTransfer.setData("text/plain",_this.id),e.dataTransfer.effectAllowed="move",$this.css({opacity:.5})}}function dragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function drop(e){if(!UILFolder.DragLock)return;if(e.dataTransfer.items)for(var i=0;i<e.dataTransfer.items.length;i++)if("file"===e.dataTransfer.items[i].kind)return;e.preventDefault(),_headerDrag=!1;let target=e.currentTarget._this,dragging=_this.parent.get(UILFolder.DragLock);UILFolder.DragLock=null,target&&target.parent&&dragging&&(dragging.element.css({opacity:1}),dragging.parent.get(target.id)&&(e.stopPropagation(),target.parent.container.insertBefore(dragging.element.div,target.element.div),_order=[...target.parent.container.childNodes].map(el=>el._this.id),_this.events.fire(UIL.REORDER,{order:[..._order]}),function saveSort(){UILStorage.set(`UIL_${UIL.sortKey}_${_this.parent.id}_order`,JSON.stringify(_order))}()))}function getUrlID(){return`${Global.PLAYGROUND||"Global"}_folder_${_id}`}function saveFolderState(){sessionStorage.setItem(getUrlID(),JSON.stringify({open:_open}))}function open(keepClosed=!1){_open=!0,$container.css({display:"flex"}),$toggle&&$toggle.text(""),1!=keepClosed&&forEachFolder(f=>f.close()),saveFolderState(),_this.onOpen&&_this.onOpen()}function close(){_open=!1,$container.css({display:"none"}),$toggle&&$toggle.text(""),saveFolderState()}function onToggle(e){_open?close():open()}function onMouseDown(e){_headerDrag=!0,$header.div.addEventListener("mouseup",onMouseUp)}function onMouseUp(e){_headerDrag=!1,$header.div.removeEventListener("mouseup",onMouseUp)}function onKeydown(e){13===e.which&&(_open?close():open())}function onKeyup(e){_hasClipboard&&("c"==e.key&&e.metaKey?function onCopy(){UILClipboard.copy(_children)}():"v"==e.key&&e.metaKey&&function onPaste(){UILClipboard.paste(_children)}())}function onFocus(){$this.css({border:"1px solid #37a1ef"}),$this.div.classList.add("active"),_hasClipboard=!0}function onBlur(){$this.css({border:"none",border:"1px solid #161616"}),$this.div.classList.remove("active"),_hasClipboard=!1}function forEachFolder(cb){return Object.values(_children).forEach(el=>{el instanceof UILFolder&&(cb(el),el.forEachFolder(cb))}),_this}!function init(){$this=_this.element,$this.size("100%","auto").bg(_opts.background||"#272727"),$this.css({position:"relative",border:"1px solid #161616",boxSizing:"border-box",maxHeight:_opts.maxHeight||"none"}),$this.attr("data-id",_id),$this.attr("data-type","UILFolder"),$this.div._this=_this}(),function style(){UIL.addCSS(UILFolder,"\n            .UILFolder *:focus { outline: none; }\n            .UILFolder input:focus { border-color:#37a1ef!important; }\n            .UILFolder button:focus { border-color:#37a1ef!important; }\n            .UILFolder .UILFolder .UILFolder .toggle {margin-left:8px; }\n            .UILFolder .UILFolder .UILFolder .UILFolder .toggle {margin-left:16px; }\n            .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .toggle {margin-left:24px; }\n            .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .toggle {margin-left:32px; }\n            .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .toggle {margin-left:40px; }\n        ")}(),function initHeader(){_opts.hideTitle||($header=$this.create("title","a"),$header.attr("tabindex","0"),$header.size("100%","auto").bg("#272727"),$header.css({display:"block",padding:"4px 4px",boxSizing:"border-box",fontWeight:"bold",userSelect:"none",borderBottom:"1px solid #161616"}),$header.fontStyle("sans-serif",11,"#B1B1B1"),$header.div.addEventListener("keydown",onKeydown,!1),$header.div.addEventListener("click",onToggle,!1),$header.div.addEventListener("mousedown",onMouseDown),$header.div.addEventListener("focus",onFocus,!1),$header.div.addEventListener("blur",onBlur,!1),$header.div.addEventListener("keydown",onKeyup,!1),$toggle=$header.create("toggle"),$toggle.text(_open?"":"").css({fontSize:8,display:"inline-block",verticalAlign:"middle"}),$drag=$header.create("drag"),$drag.text("").css({position:"absolute",right:7,top:3,display:"inline-block",pointerEvents:"none"}),$drag.hide(),$title=$header.create("title"),$title.text(_this.label).css({display:"inline-block",marginLeft:4}))}(),function initContainer(){$container=$this.create("container"),$container.size("100%","100%").css({display:"flex",flexDirection:"column",position:"relative",overflowY:"auto"}),_open||$container.css({display:"none"}),_this.container=$container.div}(),function restoreFolderState(){let json=JSON.parse(sessionStorage.getItem(getUrlID()));json&&(json.open?open():close())}(),this.add=function(child){return child.draggable&&child.draggable(_sortableChildren),child.parent=_this,_children[child.id]=child,$container.add(child),_this},this.remove=function(x){let id="string"==typeof x?x:x.id,child=_children[id];return child.eliminate&&child.eliminate(),child.destroy(),_order&&(_order=_order.filter(child=>child!==id)),delete _children[id],_this},this.get=function(id){return _children[id]},this.getAll=function(){return Object.values(_children)},this.getVisible=function(){return Object.values(_children).filter(x=>x.isVisible())},this.find=function(id){return id===_id?_this:Object.values(_children).reduce((acc,item)=>item.id===id?acc.concat(item):item instanceof UILFolder?acc.concat(item.find(id)):acc,[])},this.filter=function(str){return function filter(str,match=!1){str=str.toLowerCase();let result=[],haystack=Object.values(_children);for(let el of haystack)if(el instanceof UILFolder){let matches=el.filter(str,!0);matches.length?(result.concat(matches),el.show(),el.open()):matchItem(str,el)?(result.push(el),el.show(),el.showChildren(),el.close()):el.getVisible().length?el.show():el.hide()}else matchItem(str,el)?(result.push(el),el.show()):el.hide();return result}(str)},this.filterSingle=function filterSingle(str){str=str.toLowerCase();let haystack=Object.values(_children);for(let el of haystack)el instanceof UILFolder?(el.filterSingle(str),str==el.label.toLowerCase()||str==el.id.toLowerCase()?(el.show(),el.showChildren(),el.open(!0)):el.getVisible().length?el.show():el.hide()):matchItem(str,el)?(el.show(),el.open&&el.open(!0)):el.hide();return[]},this.open=function(keepClosed){return open(keepClosed),_this},this.close=function(){return close(),_this},this.setLabel=function(label){return _this.label=""+label,$title.text(label),_this},this.hide=function(){return _visible=!1,$this.css({display:"none"}),_this},this.show=function(){return _visible=!0,$this.css({display:"block"}),_this},this.showChildren=function(){return Object.values(_children).forEach(el=>el instanceof UILFolder?el.showChildren():el.show()),_this.show(),_this},this.isOpen=function(){return _open},this.isVisible=function(){return _visible},this.forEachFolder=function(cb){return forEachFolder(cb)},this.forEachControl=function(cb){return Object.values(_children).forEach(el=>{el instanceof UILFolder?el.forEachControl(cb):cb(el)}),_this},this.enableSorting=function(key){_sortableChildren=!0,UIL.sortKey=key,Object.values(_children).forEach(el=>{el instanceof UILFolder&&el.draggable(!0)});let order=function getSort(){let sort=UILStorage.get(`UIL_${UIL.sortKey}_${_id}_order`);if(sort)return JSON.parse(sort)}();return order&&(_order=order,function restoreSort(){_order.forEach(id=>{_children[id]&&$container.add(_children[id])})}()),_this},this.draggable=function(enable){_draggable=enable,$this.attr("draggable",enable),enable?(!function addDragHandlers(){$this.div.addEventListener("dragstart",dragStart,!1),$this.div.addEventListener("dragover",dragOver,!1),$this.div.addEventListener("drop",drop,!1)}(),$drag&&$drag.show()):(removeDragHandlers(),$drag&&$drag.hide())},this.toClipboard=function(){UILClipboard.copy(_children)},this.fromClipboard=function(){UILClipboard.paste(_children)},this.eliminate=function(){_opts.hideTitle||($header.div.removeEventListener("keydown",onToggle,!1),$header.div.removeEventListener("click",onToggle,!1),$header.div.removeEventListener("mousedown",onMouseDown),$header.div.removeEventListener("focus",onFocus,!1),$header.div.removeEventListener("blur",onBlur,!1)),_draggable&&removeDragHandlers()},this.forceSort=function(index){_this.parent.container.insertBefore(_this.element.div,_this.parent.container.children[index]),_order=[..._this.parent.container.childNodes].map(el=>el._this.id),_this.events.fire(UIL.REORDER,{order:[..._order]})},this.openChildren=function(){Object.values(_children).forEach(el=>el instanceof UILFolder?el.open():null)}})),Class((function UILPanel(_title,_opts={}){Inherit(this,Element);const _this=this;let $this,_folder,_toolbar,_hidden=!1;function onKeydown(e){if(e.ctrlKey||e.metaKey){if(72==e.keyCode&&e.shiftKey){if((""+document.activeElement.type).includes(["textarea","input","number"]))return;e.preventDefault(),_hidden?function show(){$this.visible(),_hidden=!1}():function hide(){$this.invisible(),_hidden=!0}()}37==e.keyCode&&e.shiftKey&&(e.preventDefault(),$this.css({left:0,right:"auto"})),39==e.keyCode&&e.shiftKey&&(e.preventDefault(),$this.css({left:"auto",right:0})),67==e.which&&e.shiftKey&&(e.preventDefault(),_folder.forEachFolder(f=>f.close())),79==e.which&&e.shiftKey&&(e.preventDefault(),_folder.forEachFolder(f=>f.open()))}}function undim(){$this.css({opacity:1})}function dim(){$this.css({opacity:.3})}_this.id=_title,function initHTML(){$this=_this.element,$this.size(_opts.width||"300px",_opts.height||"auto").bg("#161616").mouseEnabled(!0),"left"===_opts.side?$this.css({left:0}):$this.css({right:0}),$this.css({top:0,maxHeight:_opts.maxHeight||"100%",position:"absolute",userSelect:"none",padding:4,overflowY:"auto",borderRadius:4}),$this.hide()}(),function initToolbar(){_toolbar=_this.toolbar=_this.initClass(UILPanelToolbar)}(),function initGroup(){_folder=_this.initClass(UILFolder,_title,{hideTitle:!0,drag:!1,background:"#161616"}),_this.folder=_folder}(),function addHandlers(){document.addEventListener("keydown",onKeydown,!1),_opts.hide&&($this.div.addEventListener("mouseover",undim,!1),$this.div.addEventListener("mouseleave",dim,!1))}(),this.add=function(child){return $this.show(),_folder.add(child),_this},this.remove=function(x){return _folder.remove(x.id),_this},this.get=function(id){return _folder.get(id)},this.find=function(id){return _folder.find(id)},this.filter=function(str){return _folder.filter(str)},this.enableSorting=function(key){return _folder.enableSorting&&_folder.enableSorting(key),_this},this.eliminate=function(){_toolbar.eliminate(),$this.div.removeEventListener("mouseover",undim,!1),$this.div.removeEventListener("mouseleave",dim,!1),document.removeEventListener("keydown",onKeydown,!1)}})),Class((function UILControlButton(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $view,_buttons=[];!function init(){_this.init(_id,_opts),_opts.hideLabel&&(_this.$label.css({display:"none"}),_this.$content.css({width:"100%"}))}(),function initActions(){$view=$("inputs");let config=[].concat(_opts.actions);_buttons=[].concat(_opts.actions).map(({title:title,callback:callback})=>{let btn=$view.create("btn btn-"+title,"button");return btn.text(title).bg("#1d1d1d"),btn.css({width:"calc(100% / "+(config.length||1),border:"1px solid #2e2e2e",color:"#37a1ef",position:"relative"}),btn.interact(e=>function hover(btn,e){"over"===e.action?btn.css({border:"1px solid #9b9c9b"}):btn.css({border:"1px solid #2e2e2e"})}(btn,e)),btn.click(e=>function click(e,title,callback){_this.value=title,callback&&callback(title,e),_this.finish()}(e,title,callback)),btn}),_this.view=$view}(),this.setTitle=function(text){_buttons.forEach(btn=>{btn.text(text)})}})),Class((function UILControlCheckbox(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $view,$label,$checkbox,$slider;function toggle(){$checkbox.attr("checked",_this.value),$slider.css({right:_this.value?0:"auto"}),$label.bg(_this.value?"#37a1ef":"#1d1d1d")}function click(){_this.value=!_this.value,toggle(),_this.finish()}function focus(){$label.css({border:"1px solid #37a1ef"})}function blur(){$label.css({border:"1px solid #2e2e2e"})}!function init(){_opts.value=_opts.value||!1,_this.init(_id,_opts)}(),function initView(){$view=$("view"),$label=$view.create("label","label"),$label.size(30,15).css({position:"relative",display:"inline-block",borderRadius:15,border:"1px solid #2e2e2e"}).bg(_this.value?"#37a1ef":"#1d1d1d"),$checkbox=$label.create("checkbox","input"),$checkbox.attr("type","checkbox"),$checkbox.attr("checked",_this.value),$checkbox.css({opacity:0,width:"100%",position:"absolute"}),$slider=$label.create("slider"),$slider.size(15,15).css({borderRadius:15,position:"absolute",right:_this.value?0:"auto",boxSizing:"border-box"}).bg("#ffffff"),_this.view=$view}(),function addHandlers(){$checkbox.div.addEventListener("focus",focus,!1),$checkbox.div.addEventListener("blur",blur,!1),$checkbox.div.addEventListener("click",click,!1),$checkbox.div.addEventListener("keypress",click,!1)}(),this.update=function(){toggle()},this.onDestroy=function(){$checkbox.div.removeEventListener("focus",focus,!1),$checkbox.div.removeEventListener("blur",blur,!1),$checkbox.div.removeEventListener("click",click,!1),$checkbox.div.removeEventListener("keypress",click,!1)}})),Class((function UILControlColor(_id,_opts={}){Inherit(this,UILControl);const _this=this;var $display,_input;function onDisplayClick(){_input&&(_this.events.unsub(_input,Events.UPDATE,onChange),_input=_input.destroy()),_input=_this.initClass(UILExternalColor,_opts.label||_id,_this.value),_this.events.sub(_input,Events.UPDATE,onChange)}function onChange({value:value}){_this.value=value,$display.bg(_this.value),$display.hex.css({color:_this.value}).text(_this.value),finishChange()}function finishChange(){_this.finish()}!function init(){_opts.value=_opts.value||"#ffffff",_this.init(_id,_opts)}(),function initInput(){let $view=$("color");$view.css({position:"relative"}).css({padding:1}),($display=$view.create("color")).size("100%","100%").bg(_this.value),$display.css({border:"1px solid #2E2E2E",boxSizing:"border-box"}),$display.hex=$display.create("hex"),$display.hex.text(_this.value),$display.hex.css({color:_this.value,filter:"invert(100%)",fontSize:12,fontFamily:"sans-serif",padding:1}),_this.view=$view}(),function addHandlers(){$display.interact(null,onDisplayClick),finishChange=_this.debounce(finishChange,250)}(),this.update=function(){$display.bg(_this.value),$display.hex.css({color:_this.value}).text(_this.value)},this.onDestroy=function(){}})),Class((function UILControlFile(_id,_opts={value:{}}){Inherit(this,UILControl);const _this=this;let $view,$picker,$preview,$img,$input,$$copy,_value;async function change(e){let file=$picker.div.files[0];file&&(_value.filename=file.name,_value.relative=function getRelative(){return _value.relative.includes(_value.prefix)?_value.relative.replace(""+_value.prefix,""):_value.relative}(),_value.src=function getSrc(){return`${_value.prefix?_value.prefix+"/":""}${_value.relative?_value.relative+"/":""}${_value.filename}`}(),await function fileExists(url){return fetch(url).then(e=>404!=e.status).catch(e=>console.warn("UILControlImage image url validation failed",e))}(_value.src)?(_this.value=Object.assign({},_value),$img.attr("title",_value.src),$$copy.text(_value.filename),_this.finish()):($picker.div.value="",console.warn("UIL: Could not find file",_value),alert(`"${_value.src}" not found!\nMake sure "relative path" is correct.`)))}function focus(){$img.css({border:"1px solid #37a1ef"})}function blur(){$img.css({border:"1px dotted #2e2e2e"})}function inputChange(){_value.relative=$input.div.value}!function init(){_opts.value=Object.assign({src:"",relative:_opts.relative||"",prefix:_opts.prefix,filename:""},_opts.value),_value=Object.assign({},_opts.value),_this.init(_id,_opts)}(),function initView(){$view=$("view"),$view.css({position:"relative",padding:5}),$input=$view.create("path","input"),$input.size("100%").bg("#1D1D1D"),$input.css({boxSizing:"border-box",border:"1px solid #2E2E2E",color:"#37A1EF",marginBottom:5}),_this.value.relative?$input.div.value=_this.value.relative:$input.attr("placeholder","Relative Path"),$preview=$view.create("preview"),$preview.size("100%",60),$preview.css({boxSizing:"border-box",position:"relative",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}),$img=$preview.create("img"),$img.size("100%"),$img.css({position:"absolute",top:0,right:0,bottom:0,left:0,backgroundSize:"cover",backgroundRepeat:"no-repeat",backgroundPosition:"center",border:"1px dotted #2e2e2e",boxSizing:"border-box"}),$picker=$preview.create("picker","input"),$picker.attr("type","file"),$picker.css({opacity:0,position:"absolute",top:0,right:0,bottom:0,left:0}),$$copy=$preview.create("copy"),$$copy.html("Drag file here<br><small>or Click to Select</small>"),$$copy.fontStyle("sans-serif",11,"#9B9C9B").css({textAlign:"center"}),_this.view=$view}(),function addHandlers(){$picker.div.addEventListener("change",change,!1),$picker.div.addEventListener("focus",focus,!1),$picker.div.addEventListener("blur",blur,!1),$input.div.addEventListener("change",inputChange,!1)}(),this.force=function(value){_value=Object.assign({},value),$input.div.value=_value.relative,$img.attr("title",_value.src),$$copy.text(_value.filename)},this.onDestroy=function(){$picker.div.removeEventListener("change",change,!1),$picker.div.removeEventListener("focus",focus,!1),$picker.div.removeEventListener("blur",blur,!1),$input.div.removeEventListener("change",inputChange,!1)}})),Class((function UILControlImage(_id,_opts={value:{}}){Inherit(this,UILControl);const _this=this;let $view,$picker,$preview,$img,$input,$check,$compress,_value;async function compressClick(){if(_value.src&&!_this.flag("compressPending")){_this.flag("compressPending",!0),$compress.bg("#f4ee42").text("---");try{"Error"==await Dev.execUILScript("compressktx",{src:_value.src})?$compress.bg("#f44141").html("Failed"):$compress.bg("#46f441").html("Success")}catch(e){$compress.bg("#f44141").html("Failed"),console.error(e)}_this.flag("compressPending",!1)}}function checkChange(){_this.value.compressed=_value.compressed=!!$check.div.checked,_this.finish(!1)}async function change(e){let file=$picker.div.files[0];file&&(_value.filename=file.name,_value.relative=function getRelative(){return _value.relative.includes(_value.prefix)?_value.relative.replace(""+_value.prefix,""):_value.relative}(),_value.src=function getSrc(){return`${_value.prefix?_value.prefix+"/":""}${_value.relative?_value.relative+"/":""}${_value.filename}`}(),_value.compressed=!!$check.div.checked,await function imageExists(url){return url=Assets.getPath(url),fetch(url).then(e=>404!=e.status).catch(e=>console.warn("UILControlImage image url validation failed",e))}(_value.src)?(_this.value=Object.assign({},_value),$img.attr("title",_value.src),$img.css({backgroundImage:`url(${Assets.getPath(_value.src)})`}),_this.finish()):($picker.div.value="",console.warn("UIL: Could not find image",_value),alert(`"${_value.src}" not found!\nMake sure "relative path" is correct.`)))}function focus(){$img.css({border:"1px solid #37a1ef"})}function blur(){$img.css({border:"1px dotted #2e2e2e"})}function inputChange(){_value.relative=$input.div.value}!function init(){_opts.value=Object.assign({src:"",relative:_opts.relative||"",prefix:_opts.prefix||"assets/images",filename:""},_opts.value),_value=Object.assign({},_opts.value),_this.init(_id,_opts)}(),function initView(){$view=$("view"),$view.css({position:"relative",padding:5}),$input=$view.create("path","input"),$input.size("100%").bg("#1D1D1D"),$input.css({boxSizing:"border-box",border:"1px solid #2E2E2E",color:"#37A1EF",marginBottom:5}),_this.value.relative?$input.div.value=_this.value.relative:$input.attr("placeholder","Relative Path"),$compress=$view.create("compress"),$compress.text("Compress").bg("#fff").css({top:3,width:70,height:15,textAlign:"center",borderRadius:5,position:"relative",float:"left",paddingTop:2}).fontStyle("sans-serif",11,"#000"),$check=$view.create("#compressed","input"),$check.attr("type","checkbox"),$check.size(20,20),$check.css({boxSizing:"border-box",position:"relative"}),$check.div.checked=!!_this.value.compressed;let $label=$view.create("compressed-label","label");$label.attr("for","compressed"),$label.text("Use Compressed").fontStyle("sans-serif",9,"#9B9C9B").css({top:-6,position:"relative"}),$preview=$view.create("preview"),$preview.size("100%",60),$preview.css({boxSizing:"border-box",position:"relative",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}),$img=$preview.create("img"),$img.size("100%"),$img.css({position:"absolute",top:0,right:0,bottom:0,left:0,backgroundSize:"cover",backgroundRepeat:"no-repeat",backgroundPosition:"center",border:"1px dotted #2e2e2e",boxSizing:"border-box"}),_this.value.src&&$img.css({backgroundImage:`url('${Assets.getPath(_this.value.src)}')`}),$picker=$preview.create("picker","input"),$picker.attr("type","file"),$picker.attr("accept","image/*"),$picker.css({opacity:0,position:"absolute",top:0,right:0,bottom:0,left:0});let copy=$preview.create("copy");copy.html("Drag image here<br><small>or Click to Select</small>"),copy.fontStyle("sans-serif",11,"#9B9C9B").css({textAlign:"center"}),_this.view=$view}(),function addHandlers(){$picker.div.addEventListener("change",change,!1),$picker.div.addEventListener("focus",focus,!1),$picker.div.addEventListener("blur",blur,!1),$input.div.addEventListener("change",inputChange,!1),$compress.div.onclick=compressClick,$check.div.onchange=checkChange}(),this.force=function(value,isClipboard){_value=Object.assign({},value),!0===isClipboard&&(_this.value=_value),$input.div.value=_value.relative,$img.attr("title",_value.src),$img.css({backgroundImage:`url('${Assets.getPath(_value.src)}')`}),$check.div.checked=_value.compressed},this.onDestroy=function(){$picker.div.removeEventListener("change",change,!1),$picker.div.removeEventListener("focus",focus,!1),$picker.div.removeEventListener("blur",blur,!1),$input.div.removeEventListener("change",inputChange,!1)}})),Class((function UILControlNumber(_id,_opts={}){Inherit(this,UILControl);const _this=this;let _input;!function init(){_opts.value=_opts.value||0,_this.init(_id,_opts)}(),function initInput(){_input=_this.initClass(UILInputNumber,Object.assign(_opts,{value:_this.value})),_input.onInput(v=>_this.value=v),_input.onFinish(v=>_this.finish()),_this.view=_input.input}(),this.update=function(value){_input.value=_this.value||0}})),Class((function UILControlRange(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $view,$slider,_max=_opts.max||100,_min=_opts.min||0,_step=_opts.step||1;function change(){_this.finish()}function input(e){_this.value=Number($slider.div.value)}function focus(){$slider.css({border:"1px solid #37a1ef"})}function blur(){$slider.css({border:"1px solid #2e2e2e"})}!function init(){_opts.value=_opts.value||0,_this.init(_id,_opts)}(),function style(){UIL.addCSS(UILControlRange,"\n            .UILControlRange input { -webkit-appearance:none; appearance:none; }\n            .UILControlRange input::-webkit-slider-thumb { -webkit-appearance: none; }\n            .UILControlRange input::-webkit-slider-thumb { \n                -webkit-appearance:none; appearance:none;\n                width:15px; height:15px;\n                background:#FFF;\n                border-radius:15px;\n            }\n            .UILControlRange input::-moz-slider-thumb { \n                -webkit-appearance:none; appearance:none;\n                width:15px; height:15px;\n                background:#FFF;\n                border-radius:15px;\n            }\n        ")}(),function initView(){$view=$("view"),$slider=$view.create("range","input"),$slider.attr("type","range"),$slider.attr("max",_max),$slider.attr("min",_min),$slider.attr("step",_step),$slider.div.value=_this.value,$slider.css({width:"100%",margin:0,padding:0,background:"#1d1d1d",height:4,borderRadius:15,border:"1px solid #2e2e2e",boxSizing:"border-box"}),_this.view=$view}(),function addHandlers(){$slider.div.addEventListener("change",change,!1),$slider.div.addEventListener("input",input,!1),$slider.div.addEventListener("focus",focus,!1),$slider.div.addEventListener("blur",blur,!1)}(),this.force=function(value){_this.value=value,$slider.div.value=value,_this.finish(!1)},this.onDestroy=function(){$slider.div.removeEventListener("change",change,!1),$slider.div.removeEventListener("input",input,!1),$slider.div.removeEventListener("focus",focus,!1),$slider.div.removeEventListener("blur",blur,!1)}})),Class((function UILControlSelect(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $view,$select,_options;function change(){_this.finish()}function input(){let i=$select.div.selectedIndex;_this.value=_options[i].value}function focus(){$select.css({border:"1px solid #37a1ef"})}function blur(){$select.css({border:"1px solid #2e2e2e"})}!function init(){if(!_opts.options)throw"UILControlSelect is missing select options";_opts.value=_opts.value||_opts.options[0].value,_this.init(_id,_opts)}(),function style(){UIL.addCSS(UILControlSelect,"\n            .UILControlSelect select { -webkit-appearance:none; appearance:none; }\n        ")}(),function initView(){$view=$("view"),$view.css({position:"relative"}),$select=$view.create("dropdown","select"),$select.css({width:"100%",margin:0,padding:0,background:"#1d1d1d",height:15,border:"1px solid #2e2e2e",boxSizing:"border-box",color:"#37a1ef",borderRadius:0,height:17}),$select.div.value=_this.value,$view.create("arrow").text("").css({color:"#37a1ef",fontSize:6,position:"absolute",right:8,top:7,pointerEvents:"none"}),_this.view=$view}(),function initOptions(){_options=_opts.options.map(({value:value,label:label})=>{let el=document.createElement("option");return el.setAttribute("value",value),_this.value===value&&el.setAttribute("selected",!0),el.text=label||value,el.value=value,$select.add(el),el})}(),function addHandlers(){$select.div.addEventListener("change",change,!1),$select.div.addEventListener("input",input,!1),$select.div.addEventListener("focus",focus,!1),$select.div.addEventListener("blur",blur,!1)}(),this.force=function(value){$select.div.value=value,_this.value=value},this.onDestroy=function(){$select.div.removeEventListener("change",change,!1),$select.div.removeEventListener("input",input,!1),$select.div.removeEventListener("focus",focus,!1),$select.div.removeEventListener("blur",blur,!1)}})),Class((function UILControlText(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $input,_timeout;function onChange(v){clearTimeout(_timeout),_timeout=setTimeout(onFinishChange,400),_this.value=$input.div.value}function onFinishChange(){null!==_timeout&&(clearTimeout(_timeout),_timeout=null,_this.finish())}_this.init(_id,_opts),function initInput(){$input=$("input","input"),$input.size("100%").bg("#1D1D1D"),$input.css({boxSizing:"border-box",border:"1px solid #2E2E2E",color:"#37A1EF"}),_this.value&&($input.div.value=_this.value||""),_this.view=$input}(),function addHandlers(){$input.div.addEventListener("input",onChange,!1),$input.div.addEventListener("change",onFinishChange,!1)}(),this.update=function(){$input.div.value=_this.value||""},this.onDestroy=function(){$input.div.removeEventListener("input",onChange,!1),$input.div.removeEventListener("change",onBlur,!1)}})),Class((function UILControlTextarea(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $input,_timeout;function onChange(v){clearTimeout(_timeout),_timeout=setTimeout(onFinishChange,400),_this.value=$input.div.value}function onFinishChange(){null!==_timeout&&(clearTimeout(_timeout),_timeout=null,_this.finish())}_this.init(_id,_opts),function initInput(){$input=$("input","textarea"),$input.attr("maxlength",_opts.max||1/0),$input.attr("minlength",_opts.min||-1/0),$input.attr("rows",_opts.rows||2),$input.attr("readonly",_opts.readonly||!1),$input.size("100%").bg("#1D1D1D"),$input.css({boxSizing:"border-box",resize:_opts.resize||"vertical",minWidth:_opts.minWidth||0,border:"1px solid #2E2E2E",color:"#37A1EF"}),(_opts.monospace||_opts.editor)&&$input.css({fontFamily:"monospace"}),_this.value&&($input.div.value=_this.value||""),_this.view=$input}(),_opts.editor&&function enableTab(){$input.div.onkeydown=function(e){if(9===e.keyCode){let val=this.value,start=this.selectionStart,end=this.selectionEnd;this.value=val.substring(0,start)+"\t"+val.substring(end),this.selectionStart=this.selectionEnd=start+1,e.preventDefault()}}}(),function addHandlers(){$input.div.addEventListener("input",onChange,!1),$input.div.addEventListener("change",onFinishChange,!1)}(),this.update=function(){$input.div.value=_this.value||""},this.onDestroy=function(){$input.div.removeEventListener("input",onChange,!1),$input.div.removeEventListener("change",onBlur,!1)}})),Class((function UILControlVector(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $view,_length,_inputs=[],_vector=[];function onInput(value,index,master){master?_vector=_vector.map(v=>value):_vector[index]=value,_this.value=[..._vector]}!function init(){if(_opts.value)_length=_vector.length;else{if(!_opts.components)throw'UILControlVector: Cannot detect vector type. Define "options.components" count or init with a initial value';_opts.value=new Array(_opts.components).fill(0)}_length=_opts.value.length,_this.init(_id,_opts),_vector=[..._this.value]}(),function initInputs(){$view=$("inputs");for(let i=0;i<_length;i++){let input=_this.initClass(UILInputNumber,_opts);input.value=_this.value[i],input.onInput((v,m)=>onInput(v,i,m)),input.onFinish((v,m)=>{_this.finish()}),input.input.css({display:"inline-block",width:`calc(100% / ${_length})`}),_inputs.push(input),$view.add(input.input)}_this.view=$view}(),this.force=function(value){_vector=[...value],_this.value=[..._vector],_inputs.forEach((input,index)=>input.value=_this.value[index]),_this.finish(!1)},this.update=function(){_inputs.forEach((input,index)=>input.value=_this.value[index])}})),Class((function UILInputNumber(_opts={}){Inherit(this,Component);const _this=this;let $input,_timeout,_distance,_onMouseDownValue,_editing=!1,_precision=_opts.precision||3,_step=_opts.step||1,_min=_opts.min||-1/0,_max=_opts.max||1/0,_value=_opts.value||0,_pointer=[0,0],_prevPointer=[0,0],_onInputCB=()=>{},_onFinishCB=()=>{};function setValue(value){(value=parseFloat(value)||0)<_min&&(value=_min),value>_max&&(value=_max),_value=value,_onInputCB(value,_this.master)}function onBlur(){onFinishChange(),$input.div.value=parseFloat(_value).toFixed(_precision)}function onKeyUp(e){13===e.keyCode&&e.altKey&&(_this.master=!0,onInput())}function onInput(e){_timeout=setTimeout(onFinishChange,400),_editing=!0,setValue(parseFloat($input.div.value))}function onFinishChange(){_editing&&(_editing=!1,clearTimeout(_timeout),_onFinishCB(_value,_this.master),_this.master=!1)}function onMouseDown(e){(1===e.button||0===e.button&&e.metaKey||e.ctrlKey)&&(e.preventDefault(),$input.css({cursor:"col-resize"}),_distance=0,_onMouseDownValue=_value,_prevPointer=[e.screenX,e.screenY],document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("mouseup",onMouseUp,!1))}function onMouseMove(e){clearTimeout(_timeout),_editing=!0;let currentValue=_value;_pointer=[e.screenX,e.screenY],_distance+=_pointer[0]-_prevPointer[0]-(_pointer[1]-_prevPointer[1]);let value=_onMouseDownValue+_distance/(e.shiftKey?5:50)*_step;value=Math.min(_max,Math.max(_min,value)),_this.master=e.altKey,currentValue!==value&&function setValueDrag(value){void 0===value&&value===$input.div.value||(setValue(value),$input.div.value=_value.toFixed(_precision))}(value),_prevPointer=[e.screenX,e.screenY]}function onMouseUp(e){onFinishChange(),$input.css({cursor:""}),document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1)}!function initInput(){$input=$("input","input"),$input.attr("type","number"),$input.attr("step",_step),$input.size("100%").bg("#1D1D1D"),$input.css({boxSizing:"border-box",border:"1px solid #2E2E2E",color:"#37A1EF",boxShadow:"none"}),$input.div.value=parseFloat(_value).toFixed(_precision),_this.input=$input}(),function addHandlers(){$input.div.addEventListener("mousedown",onMouseDown,!1),$input.div.addEventListener("keyup",onKeyUp,!1),$input.div.addEventListener("change",onFinishChange,!1),$input.div.addEventListener("blur",onBlur,!1),$input.div.addEventListener("input",onInput,!1)}(),this.set("value",value=>{_value=value,_editing||($input.div.value=parseFloat(value).toFixed(_precision))}),this.get("value",()=>_value),this.onInput=cb=>_onInputCB=cb,this.onFinish=cb=>_onFinishCB=cb,this.onDestroy=function(){$input.div.removeEventListener("mousedown",onMouseDown,!1),$input.div.removeEventListener("change",onFinishChange,!1),$input.div.removeEventListener("blur",onBlur,!1),$input.div.removeEventListener("input",onInput,!1)}})),Class((function UILExternalColor(_title,_value){Inherit(this,Component);const _this=this;var _window;function onReload(){_this.onDestroy()}(_window=window.open(location.protocol+"//localhost/hydra/editor/color/index.html","hydra_color_"+_title,"width=480,height=220,left=200,top=100,location=no")).window.onload=_=>{_window.window.initPicker(_title,_value,_this)},window.addEventListener("beforeunload",onReload),this.update=function(value){_this.events.fire(Events.UPDATE,{value:value})},this.onDestroy=function(){window.removeEventListener("beforeunload",onReload),_window&&_window.window&&_window.window.close()}})),Class((function UILExternalEditor(_title,_height=500,_width=700){Inherit(this,Component);const _this=this;var _window,_code,_language;_window=window.open(location.protocol+"//localhost/hydra/editor/code/index.html","_blank",`width=${_width},height=${_height},left=200,top=100`),_this.events.sub(Events.UNLOAD,_=>_window.close()),_window.window.onload=_=>{_window.window.initEditor(_title,_code,_language,_this)},this.setCode=function(code,language){_code=code,_language=language},this.saved=async function(code){_this.onSave&&_this.onSave(code),await defer(),UILStorage.write()}})),Class((function UILPanelToolbar(){Inherit(this,Element);const _this=this;let $this,$filter,_state=new Map;function restoreFolderState(){_this.parent.folder.forEachFolder(folder=>{_state.get(folder)?folder.open():folder.close()}),_state.clear()}function onInput(e){if(!$filter.div.value.length)return restoreFolderState(),_this.parent.folder.showChildren();_this.parent.folder.filter($filter.div.value)}function onFocus(){!function saveFolderState(){_this.parent.folder.forEachFolder(folder=>{_state.set(folder,folder.isOpen())})}(),$filter.css({border:"1px solid #37a1ef"})}function onBlur(){$filter.css({border:"1px solid #2e2e2e"})}function onKeyPressed(e){if(27===e.keyCode)return $filter.div.value="",restoreFolderState(),_this.parent.folder.showChildren()}!function initHTML(){$this=_this.element,$this.size("100%","auto").bg("#272727"),$this.css({padding:4,boxSizing:"border-box",marginBottom:4})}(),function initFilter(){$filter=$this.create("filter","input"),$filter.div.addEventListener("input",onInput,!1),$filter.div.addEventListener("keydown",onKeyPressed,!1),$filter.div.addEventListener("focus",onFocus,!1),$filter.div.addEventListener("blur",onBlur,!1),$filter.size("100%","auto").bg("#161616"),$filter.css({color:"#B1B1B1",border:"1px solid #2e2e2e",outline:"none",padding:2,boxSizing:"border-box"})}(),this.eliminate=function(){$filter.div.removeEventListener("input",onInput,!1),$filter.div.removeEventListener("keydown",onKeyPressed,!1),$filter.div.removeEventListener("focus",onFocus,!1),$filter.div.removeEventListener("blur",onBlur,!1)},this.filter=function(text){$filter.div.value=text,onInput()},this.filterSingle=function(text){$filter.div.value=text,_this.parent.folder.filterSingle($filter.div.value)},this.hideAll=function(){_this.flag("init")||(_this.flag("init",!0),this.filterSingle("xxxxxx"))}})),Namespace("FX"),FX.Class((function UnrealBloom(_nuke,options,_unique){Inherit(this,Component);var _triangleGeometry,_luminosityShader,_compositeShader,_mesh,_inputTexture,_this=this;"string"==typeof options?(_unique=_params,options={},_nuke=World.NUKE):"string"==typeof _nuke?(_unique=_nuke,options={},_nuke=World.NUKE):!_nuke||_nuke instanceof Nuke?(_nuke=_nuke||World.NUKE,options=options||{},_unique=_unique||""):(options=_nuke,_nuke=World.NUKE);var _oldClearColor=new Color,_oldClearAlpha=1,_renderTargetsHorizontal=[],_renderTargetsVertical=[],_separableBlurShaders=[],_nMips=options.nMips||5,_DPR=_nuke.dpr,_blurDirectionX=new Vector2(_DPR,0),_blurDirectionY=new Vector2(0,_DPR),_kernelSizeArray=options.kernelSizeArray||[3,5,7,9,11],_bloomFactors=options.bloomFactors||[1,.8,.6,.4,.2],_useRTPool=options.useRTPool||!1;function render(){if(!_this.enabled||!1===_this.visible)return;let renderer=_nuke.renderer;_oldClearColor.copy(renderer.getClearColor()),_oldClearAlpha=renderer.getClearAlpha();let oldAutoClear=renderer.autoClear;renderer.autoClear=!0,renderer.setClearColor(_this.clearColor,0),_luminosityShader.uniforms.tDiffuse.value=_inputTexture||_nuke.rttBuffer.texture,_mesh.shader=_luminosityShader,renderer.renderSingle(_mesh,_nuke.camera,_this.renderTargetBright);let inputRenderTarget=_this.renderTargetBright;for(let i=0;i<_nMips;i++)_mesh.shader=_separableBlurShaders[i],_separableBlurShaders[i].uniforms.colorTexture.value=inputRenderTarget.texture,_separableBlurShaders[i].uniforms.direction.value=_blurDirectionX,renderer.renderSingle(_mesh,_nuke.camera,_renderTargetsHorizontal[i]),_separableBlurShaders[i].uniforms.colorTexture.value=_renderTargetsHorizontal[i].texture,_separableBlurShaders[i].uniforms.direction.value=_blurDirectionY,renderer.renderSingle(_mesh,_nuke.camera,_renderTargetsVertical[i]),inputRenderTarget=_renderTargetsVertical[i];_mesh.shader=_compositeShader,renderer.renderSingle(_mesh,_nuke.camera,_renderTargetsHorizontal[0]),renderer.setClearColor(_oldClearColor,_oldClearAlpha),renderer.autoClear=oldAutoClear}function resizeHandler(){_this.resolution.set(_nuke.stage.width,_nuke.stage.height).multiplyScalar(_DPR),_blurDirectionX.x=_DPR,_blurDirectionY.y=_DPR;let resx=Math.round(_this.resolution.x/2),resy=Math.round(_this.resolution.y/2);_this.renderTargetBright&&_this.renderTargetBright.setSize(resx,resy);for(var i=0;i<_renderTargetsHorizontal.length;i++)_renderTargetsHorizontal[i].setSize(resx,resy),_renderTargetsVertical[i].setSize(resx,resy),_separableBlurShaders[i].uniforms.texSize.value=new Vector2(resx,resy),resx=Math.round(resx/2),resy=Math.round(resy/2)}this.uniforms={tUnrealBloom:{value:null},unique:_unique},this.resolution=new Vector2(_nuke.stage.width*_DPR,_nuke.stage.height*_DPR),this.clearColor=new Color(0,0,0),this.enabled="boolean"!=typeof options.enabled||options.enabled,this.outputTexture=null,function initRTs(){if(_useRTPool)return void RTPool.instance(null,3,Texture.RGBAFormat).disableResize();let pars={minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:Texture.RGBAFormat},resx=Math.round(_this.resolution.x/2),resy=Math.round(_this.resolution.y/2);_this.renderTargetBright=new RenderTarget(resx,resy,pars),_this.renderTargetBright.texture.generateMipmaps=!1;for(let i=0;i<_nMips;i++){let renderTargetHorizonal=new RenderTarget(resx,resy,pars);renderTargetHorizonal.texture.generateMipmaps=!1,_renderTargetsHorizontal.push(renderTargetHorizonal);let renderTargetVertical=new RenderTarget(resx,resy,pars);renderTargetVertical.texture.generateMipmaps=!1,_renderTargetsVertical.push(renderTargetVertical),resx=Math.round(resx/2),resy=Math.round(resy/2)}_this.outputTexture=_renderTargetsHorizontal[0].texture,_this.uniforms.tUnrealBloom.value=_renderTargetsHorizontal[0].texture}(),function initScene(){_triangleGeometry=World.QUAD,_luminosityShader=_this.initClass(Shader,"UnrealBloomLuminosity",{tDiffuse:{value:null,ignoreUIL:!0},luminosityThreshold:{value:1},smoothWidth:{value:.01,ignoreUIL:!0},defaultColor:{value:new Color(0),ignoreUIL:!0},defaultOpacity:{value:0,ignoreUIL:!0},unique:_unique}),(_mesh=new Mesh(_triangleGeometry,_luminosityShader)).frustumCulled=!1}(),function initBlurShaders(){let resx=Math.round(_this.resolution.x/2),resy=Math.round(_this.resolution.y/2);for(let i=0;i<_nMips;i++){let shader=_this.initClass(Shader,"UnrealBloomGaussian",{unique:_unique,colorTexture:{value:null},texSize:{value:new Vector2(resx,resy)},direction:{value:new Vector2(.5,.5)}},null,glsl=>`\n#define KERNEL_RADIUS ${_kernelSizeArray[i]}\n#define SIGMA ${_kernelSizeArray[i]}\n${glsl}`,"gaussian"+i);_separableBlurShaders.push(shader),resx=Math.round(resx/2),resy=Math.round(resy/2)}}(),function initCompositeShader(){let uniforms={bloomStrength:{value:1},bloomTintColor:{value:new Color("#ffffff")},bloomRadius:{value:0},unique:_unique};for(let i=0;i<_nMips;i++)uniforms["blurTexture"+(i+1)]={value:_useRTPool?null:_renderTargetsVertical[i].texture,ignoreUIL:!0};(_compositeShader=_this.initClass(Shader,"UnrealBloomComposite",uniforms,null,(glsl,type)=>{if("vs"===type)return glsl;let compositeUniforms="",compositeMain="";for(let i=0;i<_nMips;i++)compositeUniforms+=`uniform sampler2D blurTexture${i+1};\n`,compositeMain+=`lerpBloomFactor(${_bloomFactors[i].toFixed(4)}) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture${i+1}, vUv) ${i<_nMips-1?"+ ":""}`;return(glsl=glsl.replace("uniform sampler2D blurTexture1;",compositeUniforms)).replace("lerpBloomFactor(1.0) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture1, vUv)",compositeMain)})).needsUpdate=!0}(),function initPass(){_this.pass=_this.initClass(NukePass,"UnrealBloomPass",_this.uniforms)}(),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler),_this.events.sub(RenderManager.POST_RENDER,render)}(),ShaderUIL.add(_luminosityShader).setLabel("UnrealBloom Luminosity"),ShaderUIL.add(_compositeShader).setLabel("UnrealBloom Composite"),this.set("texture",texture=>{_inputTexture=texture}),this.set("dpr",dpr=>{_DPR=dpr,resizeHandler()}),this.renderBloom=render,this.renderMesh=_mesh,this.onDestroy=function(){_renderTargetsHorizontal.forEach(r=>r.destroy()),_renderTargetsVertical.forEach(r=>r.destroy()),_this.renderTargetBright&&_this.renderTargetBright.destroy()},this.getRTs=function(){_this.renderTargetBright=RTPool.instance().getRT();for(let i=0;i<_nMips;i++)_renderTargetsHorizontal.push(RTPool.instance().getRT()),_renderTargetsVertical.push(RTPool.instance().getRT()),_compositeShader.uniforms["blurTexture"+(i+1)].value=_renderTargetsVertical[i].texture;_this.outputTexture=_renderTargetsHorizontal[0].texture,_this.uniforms.tUnrealBloom.value=_renderTargetsHorizontal[0].texture,resizeHandler()},this.putRTs=function(){_this.renderTargetBright&&RTPool.instance().putRT(_this.renderTargetBright),_this.renderTargetBright=null;for(let i=0;i<_renderTargetsHorizontal.length;i++)RTPool.instance().putRT(_renderTargetsHorizontal[i]),RTPool.instance().putRT(_renderTargetsVertical[i]);_renderTargetsHorizontal=[],_renderTargetsVertical=[]}})),Class((function Video(_params){Inherit(this,Component);const _this=this;let $video,_video,_loadingState,_handlers,_ready=Promise.create(),_loaded=Promise.create(),_initialPlay=!0;function startPreload(){return _loadingState=!0,_ready}async function startPlayback(){_this.playing||(_loadingState=!1,_video.load(),await _ready,_this.playing||(_initialPlay&&(_initialPlay=!1,_video.currentTime=_params.currentTime),_this.playing=!0,_video.play()))}function getSource(src=""){return src.includes(["webm","mp4","ogv","blob"])||(src+="."+Device.media.video),src}function progress(e){_this.events.fire(Video.PROGRESS,e)}function timeupdate(e){_this.events.fire(Video.UPDATE,e)}function play(e){if(_loadingState)return _loadingState=!1;_this.events.fire(Video.PLAY,e)}function pause(e){_this.events.fire(Video.PAUSE,e)}function playing(e){_this.events.fire(Video.PLAYING,e)}function ended(e){_this.events.fire(Video.ENDED,e)}function waiting(e){_this.events.fire(Video.WAITING,e)}function canplay(e){loadeddata(),_this.events.fire(Video.CANPLAY,e)}function loadeddata(e){_video.readyState>=2&&_ready.resolve(),_video.readyState>=4&&_loaded.resolve()}!function initParam(){_params=Object.assign({muted:!0,loop:!1,autoplay:!1,inline:!0,controls:!1,currentTime:0,playback:1,preload:!1,width:640,height:360,events:[]},_params)}(),function init(){return _video=document.createElement("video"),_video.src=getSource(_params.src),_video.setAttribute("crossorigin","anonymous"),_video.autoplay=_params.autoplay,_video.loop=_params.loop,_video.controls=_params.controls,_video.height=_params.height,_video.width=_params.width,_video.defaultMuted=_params.muted,_video.defaultPlaybackRate=_params.playback,_video.preload=_params.preload,_video.muted=_params.autoplay||_params.muted,_video.setAttribute("webkit-playsinline",_params.inline),_video.setAttribute("playsinline",_params.inline),_video.autoplay&&_video.setAttribute("autoplay",_params.autoplay),_video.setAttribute("muted",_params.muted),_params.loop&&_video.setAttribute("loop",_params.loop),_this.div=_video,$video=$(_video),_params.autoplay?startPlayback():_params.preload?startPreload():void 0}(),function addHandlers(){_params.events.push("loadeddata"),_handlers={play:play,pause:pause,ended:ended,playing:playing,progress:progress,waiting:waiting,timeupdate:timeupdate,loadeddata:loadeddata,canplay:canplay},_params.events.forEach(ev=>_video.addEventListener(ev,_handlers[ev],!0))}(),this.set("loop",bool=>_video.loop=bool),this.get("loop",()=>_video.loop),this.set("src",src=>{src!==_video.src&&(_video.src=getSource(src))}),this.get("src",()=>_video.currentSrc),this.set("volume",v=>{_video.muted=0===v,_video.volume=v}),this.get("volume",()=>_video.volume),this.set("muted",bool=>_video.muted=bool),this.get("muted",()=>_video.muted),this.set("controls",bool=>_video.controls=bool),this.get("controls",()=>_video.controls),this.get("duration",()=>_video.duration),this.get("ended",()=>_video.ended),this.get("playback",()=>_video.playbackRate),this.get("time",()=>_video.currentTime),this.get("canRender",()=>_video.readyState>=2),this.get("canPlayThrough",()=>_video.readyState>=4),this.get("paused",()=>_video.paused),this.get("element",()=>$video),this.get("object",()=>$video),this.get("video",()=>_video),this.get("bufferedSeconds",_=>_video.readyState<2?0:_video.buffered.end(0)-_video.buffered.start(0)),this.load=async function(){return startPreload()},this.play=async function(){return startPlayback()},this.pause=function(){_this.playing=!1,_video.pause()},this.stop=function(){_this.playing=!1,_video.pause(),_this.seek(0)},this.seek=function(t){if(_video.fastSeek)return _video.fastSeek(t);_video.currentTime=t},this.seekExact=function(t){_video.currentTime=t},this.ready=function(){return _ready},this.loaded=function(){return _loaded},this.onDestroy=function(){_this.stop(),_video.src="",function removeListeners(){_params.events.forEach(ev=>_video.removeEventListener(ev,_handlers[ev],!0))}(),_video=null}}),()=>{Video.PLAY="hydra_video_play",Video.CANPLAY="hydra_video_can_play",Video.PAUSE="hydra_video_pause",Video.PROGRESS="hydra_video_progress",Video.UPDATE="hydra_video_update",Video.PLAYING="hydra_video_playing",Video.ENDED="hydra_video_ended",Video.WAITING="hydra_video_waiting"}),Class((function VideoTexture(_path,{loop:loop=!0,preload:preload=!0,autoplay:autoplay=!0,muted:muted=!0,firstFrame:firstFrame=!1}={}){Inherit(this,Component);const _this=this;let _video;function update(){_video.canRender&&(_this.videoTexture&&(_this.texture.destroy(),_this.texture=_this.videoTexture,delete _this.videoTexture),_this.texture.image||(_this.texture.image=_video.video,_this.texture.upload()),_this.texture.loaded=_this.texture.needsUpdate=!0)}!function(){if(_path.includes(["jpg","png"])){let noop=_=>{};_this.texture=Utils3D.getTexture(_path),_this.video={play:noop,pause:noop}}else{let src=_path.includes("blob")?_path:Assets.getPath(_path);_video=_this.initClass(Video,{src:src,loop:loop,preload:preload,autoplay:autoplay,muted:muted,events:["timeupdate","playing","ended"]}),_this.texture=new Texture,_this.texture.format=Texture.RGBFormat,_this.texture.minFilter=_this.texture.magFilter=Texture.LINEAR,_this.texture.generateMipmaps=!1,_this.texture.loaded=!1,_this.video=_video,_this.events.bubble(_video,Video.PLAYING),firstFrame&&(_this.videoTexture=_this.texture,_this.texture=Utils3D.getTexture(firstFrame))}}(),this.set("loop",loop=>_video.loop=loop),this.set("muted",muted=>_video.muted=muted),this.set("src",src=>_video.src=Assets.getPath(src)),this.start=async function(){_video&&(_this.active=!0,await _video.play(),_this.startRender(update))},this.stop=function(){_video&&(_this.active=!1,_video.pause(),_this.stopRender(update))},this.seek=function(time){_video&&_video.seek(time)},this.onInvisible=function(){_this.active&&_video.pause(),VideoTexture.element().removeChild(_this.video.object,!0)},this.onVisible=function(){_this.active&&_video.play(),VideoTexture.element().add(_this.video.object)},this.onDestroy=function(){_this.texture.destroy(),VideoTexture.element().removeChild(_this.video.object,!0)}}),_=>{var $element;VideoTexture.element=function(){return $element||(($element=Stage.create("VideoTextures")).size(1,1).css({overflow:"hidden"}).setZ(-1),$element.mouseEnabled(!1),Stage.add($element)),$element}}),Class((function VideoTextureColorParser(_path,_static){Inherit(this,Component);const _this=this;var _colorData,_color=new Color;this.color=new Color,this.lerp=1,async function(){let path=_path.split(".")[0]+".json";_colorData=await get(path)}(),this.update=function(time){if(_colorData)for(let key in _colorData)if(time<=key){_color.set("#"+_colorData[key]),_this.color.lerp(_color,_this.lerp);break}}})),Namespace("FX"),FX.Class((function VolumetricLight(_nuke=World.NUKE,_unique,_options={}){Inherit(this,Component);const _this=this;var _scene,_layer,_volume,_light,_invisible,_obj={},_blurs=[],_projection=new ScreenProjection(_nuke.camera),_lightPos=new Vector3;function render({stage:stage,camera:camera}){if(!_light||!_this.enabled||_invisible)return;_scene.nuke.setSize(stage.width,stage.height),_scene.nuke.stage=stage,_scene.nuke.camera=camera,_projection.camera=camera,_lightPos.setFromMatrixPosition(_light.matrixWorld);let screen=_projection.project(_lightPos,stage);screen.x/=stage.width,screen.y/=stage.height,_volume.uniforms.lightPos.value.set(screen.x,1-screen.y),_scene.render()}!function polymorph(){"object"==typeof _unique&&(_options=_unique,_unique=void 0),_this.enabled="boolean"!=typeof _options.enabled||_options.enabled}(),function initLayer(){(_layer=_this.initClass(_options.useFXScene?FXScene:FXLayer,_nuke,_options)).name="VolumetricLight",_this.startRender(_=>_layer.render()),_layer.setDPR(1),_this.fxLayer=_layer}(),function initScene(){_scene=_this.initClass(FXScene,_nuke),_layer.setDPR(1),_this.rt=_scene.rt;let shader=_this.initClass(Shader,_options.screenQuadShader||"ScreenQuad",{tMap:{value:_layer},depthWrite:!1}),mesh=new Mesh(World.QUAD,shader);mesh.frustumCulled=!1,_scene.scene.add(mesh),_this.screenQuadMesh=mesh,_this.fxScene=_scene}(),function initPasses(){[new Vector2(1.5*_nuke.dpr,0),new Vector2(0,1.5*_nuke.dpr)].forEach(dir=>{let pass=new NukePass("LightBlur",{uDir:{value:dir}});_blurs.push(pass),_scene.nuke.add(pass)}),_volume=new NukePass("VolumetricLight",{unique:_unique,lightPos:{value:new Vector2},fExposure:{type:"f",value:.2},fDecay:{type:"f",value:.93},fDensity:{type:"f",value:.96},fWeight:{type:"f",value:.4},fClamp:{type:"f",value:1}}),_scene.nuke.add(_volume),ShaderUIL.add(_volume).setLabel("Volumetric Light"),_this.volumeShader=_volume}(),function addListeners(){_this.events.sub(_nuke,Nuke.RENDER,render)}(),this.add=function(mesh,light){_layer.add(mesh),light&&(_light=mesh)},this.set("resolution",v=>{_layer.setResolution(v),_scene.setResolution(v)}),this.set("dpr",v=>{_layer.setDPR(v),_scene.setDPR(v)}),this.onInvisible=function(){_invisible=!0},this.onVisible=function(){_invisible=!1},this.setComposite=function(texture){_this.screenQuadMesh.shader.set("tMap",texture)},this.render=function(stage,camera){_this.events.unsub(_nuke,Nuke.RENDER,render),_obj.stage=stage,_obj.camera=camera,render(_obj)}})),Class((function SocketConnection(_server,_channel){Inherit(this,Component);var _socket,_pingPong,_this=this,_fail=0,_binary={},_time=Render.TIME;function connect(){_this.pending=!1,(_socket=new WebSocket(_server,["permessage-deflate"])).binaryType="arraybuffer",_socket.onopen=open,_socket.onmessage=message,_socket.onclose=close,_socket.onerror=close}function sendPing(){_socket&&_socket.readyState==WebSocket.OPEN&&_socket.send("ping")}function open(e){_fail=0,_this.connected=!0,_this.events.fire(SocketConnection.OPEN,{socket:_this},!0),_channel&&_this.send("register",{channel:_channel}),_pingPong=setInterval(sendPing,5e3)}function message(e){if("pong"!=e.data&&"ping"!=e.data)if("string"==typeof e.data)try{let data=JSON.parse(e.data),evt=data._evt;evt?(delete data._evt,_this.events.fire(evt,data,!0)):(_binary.data=data,_this.events.fire(SocketConnection.BINARY,_binary))}catch(er){}else _binary.data=e.data,_this.events.fire(SocketConnection.BINARY,_binary)}function close(e){if(Render.TIME-_time<50&&!_this.blocked)return _this.blocked=!0,_this.events.fire(SocketConnection.BLOCKED);_this.pending||_fail++>250||(_this.connected=!1,_this.pending=!0,_this.events.fire(SocketConnection.CLOSE,{socket:_this},!0),_this.timer=_this.delayedCall(connect,250),clearTimeout(_pingPong))}this.connected=!1,async function(){try{connect()}catch(e){await defer(),_this.events.fire(SocketConnection.ERROR,{socket:_this}),_this.timer=_this.delayedCall(connect,250)}}(),this.send=function(evt,data={}){if(!_this.connected)return _this.delayedCall(_=>_this.send(evt,data),100);data._evt=evt,_socket&&_socket.readyState==WebSocket.OPEN&&_socket.send(null!=data.length?data:JSON.stringify(data))},this.sendBinary=function(data){_socket.send("binary:"+(null!=data.length?data:JSON.stringify(data)))},this.close=function(){_socket.onclose=null,_socket.onerror=null,clearTimeout(_this.timer),_socket.close()}}),_=>{SocketConnection.OPEN="socket_connection_open",SocketConnection.CLOSE="socket_connection_close",SocketConnection.ERROR="socket_connection_error",SocketConnection.BINARY="socket_connection_binary",SocketConnection.BLOCKED="socket_connection_blocked"}),Class((function CameraFollow(_mesh){Inherit(this,Component);const _this=this,BOSSES=require("Bosses");var _camera,_level,$coordinates,_storageId=Utils.query("p")+"DebugCamera",_target=(new Vector2,new Vector2),_noise=new Vector3,_shake=new Vector2,_delta=new Vector2,_debug=new Vector3(0,0,1),_offset=new Vector2;function loop(){_mesh.transform&&(!function offset(){if(!_mesh.input||!_mesh.input.input||!_mesh.input.input.gamepad)return;_offset.copy(_mesh.input.input.gamepad.offset).multiplyScalar(50)}(),function follow(){_this.flag("previewing")||_target.copy(Utils.query("debugCamera")?_debug:_mesh.position);let rate=Math.range(Math.abs(_shake.y),0,100,.1,.25);_camera.position.x=Math.lerp(_target.x-Stage.width/2,_camera.position.x+_shake.x+_noise.x+_offset.x,rate),_camera.position.y=Math.lerp(_target.y+Stage.height/2,_camera.position.y+_shake.y+_noise.y+_offset.y,rate)}(),function noise(){if(_this.flag("died"))return;if(!Tests.CameraWobble())return;let playerMovement=_delta.distanceTo(_target),power=.5*Math.range(playerMovement,0,30,1,5)*_noise.z,time=.001*Render.TIME,xDist=Math.range(Math.cos(3*time*.5),-1,1,2,6)*power,yDist=Math.range(Math.cos(2.9*time*.5+100),-1,1,2,4)*power;_noise.x=Math.sin(2.7*time*.5+100)*xDist,_noise.y=Math.cos(.5*time)*yDist}(),function delta(){if(_this.flag("previewing"))return;_delta.copy(_target)}())}function coordinateString(lineBreak=!0){return`x: ${Math.round(_debug.x)}${lineBreak?"\n":", "}y: ${Math.round(-_debug.y)}`}function printCoordinates(){$coordinates.text(coordinateString())}function onPress({keyCode:keyCode,shiftKey:shiftKey}){let step=shiftKey?1e3:100;switch(keyCode){case 39:_debug.x+=step;break;case 37:_debug.x-=step;break;case 38:_debug.y+=step;break;case 40:_debug.y-=step;break;case 187:_debug.z+=step/1e3;break;case 189:_debug.z-=step/1e3;break;case 48:_debug.z=1;break;case 67:shiftKey&&Utils.copyToClipboard(coordinateString(!1))}_debug.z=Math.max(_debug.z,.01),_level.debugZoom=_debug.z,printCoordinates();let state=JSON.stringify({x:_debug.x,y:_debug.y,z:_debug.z});localStorage.setItem(_storageId,state)}async function onPreview({level:level}){await level.ready(),await level.player.ready(),await level.boss.ready();let target=level.boss.layer,offset=BOSSES[Utils.getConstructorName(level)].offset;if(target&&(!Hydra.LOCAL||!Utils.query("skipPreview"))){_this.flag("previewing",!0),_target.copy(target.group.position).add(offset),level.previewZoom=.5,_noise.z=0,_camera.position.x=_target.x-Stage.width/2,_camera.position.y=_target.y+Stage.height/2,ViewController.instance().letterbox(!0,0),await _this.wait(500),_this.delayedCall(_=>{ViewController.instance().letterbox(!1,1e3),tween(_noise,{z:1},2e3,"easeInOutCubic")},8e3),tween({v:0},{v:1},6e3,"easeInOutQuad",2500).onUpdate(t=>{let sineOffset=1-.45*Math.sin(t*Math.PI),progressZoom=Math.range(t,0,1,.5,1);level.previewZoom=sineOffset*progressZoom}),_this.events.fire(AudioController.PLAY,{name:"levelStart"}),await tween(_target,{x:_mesh.position.x,y:_mesh.position.y},6e3,"easeInOutQuint",2500).promise(),_this.flag("previewing",!1)}level.player.movement.flag("locked",!1),_this.events.fire(Level.START,{level:level})}async function onReset({died:died}){await defer(),_this.flag("died",!0,1e3),_camera.position.x=_mesh.position.x-Stage.width/2,_camera.position.y=_mesh.position.y+Stage.height/2,_delta.copy(_mesh.position),_target.copy(_mesh.position),_noise.z=0,tween(_noise,{z:1},2e3,"easeInOutCubic",500)}function onShake({amount:amount=0,duration:duration=300,ease:ease="easeOutCubic",delay:delay=0}={}){if(!Tests.ScreenShake())return;let shake={amount:amount};_this.shaking&&clearTween(_this.shaking);let rumble=_=>{let angle=2*Math.random()*Math.PI;_shake.x=Math.cos(angle)*shake.amount*.75,_shake.y=Math.sin(angle)*shake.amount*.25},gamepad=!!(_mesh.input&&_mesh.input.input&&_mesh.input.input.gamepad)&&_mesh.input.input.gamepad;gamepad&&(gamepad.playEffect={duration:duration,strongMagnitude:Math.min(amount/120,1)}),_this.startRender(rumble),_this.shaking=tween(shake,{amount:0},duration,ease,delay).onComplete(_=>{_this.stopRender(rumble)})}!function initMotion(){_level=_this.parent.parent,_camera=_level.camera,_this.startRender(loop)}(),function addHandlers(){_this.events.sub(CameraFollow.SHAKE,onShake),_this.events.sub(Level.PREVIEW,onPreview),_this.events.sub(Level.RESET,onReset),Utils.query("debugCamera")&&function initDebugCamera(){let stored=localStorage.getItem(_storageId);stored&&(_debug.copy(JSON.parse(stored)),_camera.position.x=_debug.x-Stage.width/2,_camera.position.y=_debug.y+Stage.height/2,_level.debugZoom=_debug.z||1,_debug.z=_level.debugZoom),_this.events.sub(Keyboard.DOWN,onPress),($coordinates=$(document.createElement("div"))).css({padding:12,bottom:0,left:0,whiteSpace:"pre"}).bg("#000").fontStyle("monospace",12,"#fff"),Stage.add($coordinates),printCoordinates()}()}()}),_=>{CameraFollow.SHAKE="camera_follow_shake"}),Class((function CameraHelpers(){this.getDefaultCamera=function(){let camera=new GazeCamera;return camera.position.z=6,camera.moveXY.set(.8,.5),camera.lookAt.z=2,camera.deltaRotate=0,camera}}),"static"),Class((function StringUtils(){this.formatTime=function(ms=0){let seconds=Math.floor(ms/1e3),minutes=Math.floor(seconds/60);for(seconds-=60*minutes,seconds=seconds.toString();seconds.length<2;)seconds="0"+seconds;for(minutes=minutes.toString();minutes.length<2;)minutes="0"+minutes;return`${minutes}:${seconds}`},this.padInt=function(num="",digits=3,pad="0"){for(num=""+num;num.length<digits;)num=`${pad}${num}`;return num},this.shuffle=function(text,value){let length=text.length-value,result="",charactersLength="ABCDEFGHIJKLMNOPQRSTUVWXYZ".length;for(let i=0;i<length;i++)result+=" "===text[value+i]?" ":"ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random()*charactersLength));return text.substring(0,text.length-length)+result},this.formatUI=function(text){return text.toUpperCase().replace(/\n/g," ")}}),"static"),Class((function Tests(){const _this=this;this.getDPR=function(){return GPU.OVERSIZED||GPU.lt(0)?.8:GPU.lt(1)?Math.min(Device.pixelRatio,1):GPU.lt(3)&&Math.max(Stage.width,Stage.height)>1500?1:GPU.lt(2)?Math.min(Device.pixelRatio,1.1):GPU.lt(3)?Math.min(Device.pixelRatio,1.25):GPU.lt(4)?Math.min(Device.pixelRatio,2):GPU.mobileLT(0)?1:GPU.mobileLT(1)||GPU.mobileLT(2)?Math.min(Device.pixelRatio,1):GPU.mobileLT(3)?Math.min(Device.pixelRatio,1.25):GPU.mobileLT(4)?Math.min(Device.pixelRatio,1.5):1},this.fallback=function(){return!Device.detect(["bot","googlebot","crawl","spider"])&&(!(Config.PROD||!Utils.query("fallback"))||(!Device.graphics.webgl||("safari"===Device.system.browser&&Device.system.browserVersion<10||("ie"===Device.system.browser&&Device.system.browserVersion<=11||("ios"===Device.system.os&&Device.system.version<10||"android"===Device.system.os&&Device.system.version<5)))))},this.renderClouds=function(){return!0},this.renderCloudNoise=function(){return!GPU.lt(1)&&!GPU.mobileLT(2)},this.IntroGlitch=function(){return!GPU.lt(0)},this.getIntroResolution=function(){return GPU.lt(0)?.8:1},this.getIntroLevelResolution=function(){return GPU.lt(1)?.7:1},this.IntroGrain=function(){return!0},this.IntroScanlines=function(){return!0},this.ScreensBackgroundDPR=function(){return.25*_this.getDPR()},this.ScreensBackgroundBlur=function(){return!GPU.mobileLT(2)},this.vfxHueShift=function(){return!0},this.ScreensBackgroundGrain=function(){return!0},this.ScreensBackgroundVolumetricLight=function(){return!GPU.lt(0)},this.ScreensBackgroundScanlines=function(){return!0},this.LightingEnabled=function(){return!!GPU.lt(0)||!Utils.query("disableLighting")},this.lightingDPR=function(){return GPU.lt(1)?.05*_this.getDPR():.25*_this.getDPR()},this.renderBloom=function(){return GPU.lt(1)&&"mac"==Device.system.os&&GPU.lt(0)||GPU.mobileLT(2),!0},this.bloomDPR=function(){return this.lightingDPR()},this.mouseFluid=function(){return!GPU.lt(0)&&(!Device.mobile&&"safari"!==Device.system.browser)},this.fogAmount=function(){return 150},this.antialiasing=function(){return GPU.lt(0)||GPU.mobileLT(1),!1},this.videoTexture=function(){return!("safari"===Device.system.browser&&!Device.mobile)},this.textureGrad=function(){return"safari"!==Device.system.browser},this.renderRGBShift=function(){return GPU.lt(0)||GPU.mobileLT(2),!0},this.enableRain=function(){return!GPU.lt(1)&&!GPU.mobileLT(2)},this.enableLightingEffects=function(){return!GPU.lt(0)&&!GPU.mobileLT(2)},this.GlitchTransition=function(){return!_this.ReduceMotion()},this.ScreenEffects=function(){return!_this.ReduceMotion()},this.ScreenShake=function(){return!_this.ReduceMotion()},this.CameraWobble=function(){return!_this.ReduceMotion()},this.ReduceMotion=function(){return!!Utils.query("reduceMotion")||window.matchMedia("(prefers-reduced-motion: reduce)").matches}}),"static"),Class((function Api(){Inherit(this,Model);const _this=this,consoleSecurity=require("ConsoleSecurity"),API_URL=Config.API_TEST;let _ip,_postHeader;function valid(){return!(!Hydra.LOCAL&&consoleSecurity())}!async function(){await Hydra.ready();const{ip:ip}=await get(Config.API+"/ip");_ip=ip,_postHeader={headers:{"x-forwarded-for":ip,"content-type":"application/json"}},_this.dataReady=!0}(),_this.PROFILE={},_this.login=async function(email){if(!valid())return!1;const result=await get(`${API_URL}/${email}`,{headers:{"x-forwarded-for":_ip}});return _this.PROFILE.email=email,_this.PROFILE.webkey=result.userWebkey,_this.PROFILE.gameplays=result.gameplays,result},_this.createProfile=async function(formData){if(!valid())return!1;const{result:result,message:message}=await post(API_URL+"/profiles",formData,_postHeader);return result&&(_this.PROFILE.email=formData.email,_this.PROFILE.webkey=result.userWebkey,_this.PROFILE.gameplays=result.gameplays),{result:result,message:message}},_this.redeemUPC=async function(upcCode,test=!1){if(!valid())return!1;let query=test?"?test="+test:"";if(Utils.query("test")&&(query="?test="+Utils.query("test")),!_this.PROFILE.webkey)return{success:!1,result:"User must register or login."};const data={webkey:_this.PROFILE.webkey,code:upcCode},result=await post(API_URL+"/offer_code"+query,data,_postHeader);return!1===result.success?result:result.result},_this.playInstantWin=async function(test=!1){if(!valid())return!1;let query=test?"?test="+test:"";if(Utils.query("test")&&(query="?test="+Utils.query("test")),!_this.PROFILE.webkey)return{success:!1,result:"User must register or login."};const data={webkey:_this.PROFILE.webkey};let result;return _this.PROFILE.gameplays>0?(_this.PROFILE.gameplays--,result=await post(API_URL+"/play_game"+query,data,_postHeader),!1===result.success?result:result.result):{success:!0,winner:null,msg:"limited"}},_this.awardSweeps=async function(sweepsAmount,test=!1){if(!valid())return!1;let query=test?"?test="+sweepsAmount:"";if(!_this.PROFILE.webkey)return{success:!1,result:"User must register or login."};const data={webkey:_this.PROFILE.webkey,amount:sweepsAmount};Utils.query("test")&&"lose"===Utils.query("test")&&(data.amount=7);const result=await post(API_URL+"/award_sweeps"+query,data,_postHeader);return!1===result.success?result:result.result}}),"static"),Class((function AudioController(){Inherit(this,Component);const _this=this;var _pool,_tracks={},_queue=[];function generateSFX(){return _this.initClass(Audio3D,{simpleBuffer:!0})}function addHandlers(){_this.events.sub(AudioController.PLAY,onPlay),_this.events.sub(AudioController.PAUSE,onPause),_this.events.sub(GlobalAudio3D,Events.READY,onReady)}function onReady(){!function initPool(){_pool=_this.initClass(ObjectPool);let afx=[];for(;afx.length<16;)afx.push(generateSFX());_pool.insert(afx)}(),function handleQueue(){for(let name of _queue)onPlay({name:name,type:"track"})}()}function onPlay({name:name,type:type="effect"}){let config=AudioConfig["effect"===type?"EFFECTS":"TRACKS"][name];if(!config)return console.warn(`missing file for '${name}'`);!1!==config.src&&("effect"===type?function playEffect(name,audio){if(Utils.query("noSFX"))return;if(!GlobalAudio3D.initialized)return;let sound=_pool.get();null===sound&&(sound=generateSFX());_this.events.sub(sound,Events.END,(function onSoundEnd(){_this.events.fire(AudioController.ENDED,{name:name}),_this.events.unsub(sound,Events.END,onSoundEnd),_pool.put(sound)})),sound.src=audio.src,sound.volume=audio.volume,sound.play()}(name,config):function playTrack(name,audio){if(!GlobalAudio3D.initialized)return _queue.push(name);_tracks[name]||(_tracks[name]=function generateTrack(){return _this.initClass(Audio3D,{stream:!0})}());let sound=_tracks[name];if(sound.isPlaying)return;sound.isPlaying=!0,sound.loop=audio.loop,sound.src=audio.src,sound.volume=0,sound.play(),tween(sound,{volume:audio.volume},750,"linear")}(name,config))}function onPause({name:name}){if(!GlobalAudio3D.initialized)return _queue.remove(name);let sound=_tracks[name];sound&&sound.isPlaying&&(sound.isPlaying=!1,tween(sound,{volume:0},750,"linear"))}!async function(){Hydra.LOCAL&&UIL.global||(GlobalAudio3D.pool=16,GlobalAudio3D.setup(),defer(addHandlers))}(),this.PLAY=AudioController.PLAY="audio_play",this.PAUSE=AudioController.PAUSE="audio_pause",this.ENDED=AudioController.ENDED="audio_ended"}),"static"),Class((function Container(){Inherit(this,Element);const _this=this,$this=this.element;Mobile.allowNativeScroll(),function initHTML(){Stage.add($this),$this.css({position:"static"}),TweenManager.addCustomEase({name:"inOut",curve:"cubic-bezier(.67,.01,.17,.98)"})}(),async function loadView(){DOMResize.instance(),Utils.query("logout")&&Account.instance().logout();let loaderView=_this.initClass(LoaderView),loader=_this.initClass(AssetLoader,Assets.list().filter(["shaders","data"]));_this.events.sub(loader,Events.PROGRESS,loaderView.progress),_this.events.sub(loader,Events.COMPLETE,()=>{loaderView.animateOut(()=>{ViewController.instance().show(),_this.delayedCall(_=>{loaderView.element.tween({opacity:0},1e3,"easeInOutSine",200,_=>{loaderView=loaderView.destroy()})},100)})}),await Initializer3D.createWorld(),async function initView(){Colors.instance(),World.instance(),$this.add(World.ELEMENT),ScreensBackground.instance(),ViewController.instance(),VFXUI.instance()}()}(),function initLevelSettings(){if(Hydra.LOCAL&&Utils.query("unlockAll"))for(let level of["LevelGummiLeaks","LevelDataMine","LevelCitricAlley","LevelSugarRoad","LevelExoticPetShop"])Storage.set("level-"+level,3)}()}),"singleton"),Class((function DOMResize(){Inherit(this,Component);const _this=this;var _scale;function onResize(){let scaleWidth=Stage.width/667,scaleHeight=Stage.height/375;_scale=Math.max(1,Math.min(scaleWidth,scaleHeight)),document.documentElement.style.fontSize=10*_scale+"px"}_this.onResize(onResize),onResize(),_this.get("scale",_=>_scale)}),"singleton"),Class((function SpriteAnimation(_mesh,_s,_group,_input){Inherit(this,Object3D);const _this=this;var _id,_config,_animation,_shader;function loop(){let frame=_this.flag("frame");frame+=1,_shader.set("uFrame",frame),frame>=_config.animations[_animation].frames-1&&(_this.flag("loops")||pause(),_this.events.fire(Events.COMPLETE,{animation:_animation}),frame=0),_this.flag("frame",frame),clearTimeout(_this._frame),_this.flag("playing")&&(_this._frame=_this.delayedCall(loop,1e3/_this.flag("fps")*Render.HZ_MULTIPLIER))}function pause(){_this.flag("playing",!1),clearTimeout(_this._frame)}!function initConfig(){void 0!==(_id="string"==typeof _s?_s:_input.get("wildcard"))&&(_config=require(_id+"Animation"))}(),_config&&(function initSelector(){if(_input&&_input.addSelect){let options=[];for(let value in _config.animations)options.push({value:value});_input.addSelect("currentAnimation",options),_animation=_input.get("currentAnimation")||options[0].value}else _animation=Object.keys(_config.animations)[0]}(),function initShader(){let texture=Utils3D.getTexture(_config.src);texture.minFilter=texture.magFilter=Texture.NEAREST,_this.flag("frame",0),_this.flag("animation",_config.animations[_animation].index),_this.flag("direction",1),_this.flag("fps",15),_shader=_this.initClass(Shader,"SpriteAnimation",{tMap:{value:texture},uInvincible:{value:new Vector2},uJumping:{value:new Vector2},uColor1:{value:new Color("#60b7dd")},uColor2:{value:new Color("#aa3077")},uRealColor:{value:1},uDirection:{value:_this.flag("direction")},uTextureSize:{value:_config.textureSize},uFrameSize:{value:_config.frameSize},uAnimation:{value:_this.flag("animation")},uFrame:{value:_this.flag("frame")},uAlpha:{value:1},depthWrite:!1,transparent:!0}),_mesh.shader=_shader}()),_mesh.animation=_this,this.play=function(name,fps){!function play(name=_animation,fps){name!==_animation&&(_this.flag("frame",0),_this.flag("fps",fps||15)),fps&&_this.flag("fps",fps),name===_animation&&_this.flag("playing")||(_this.flag("animation",_config.animations[_animation].index),_this.flag("loops",_config.animations[_animation].loops),_shader.set("uFrame",_this.flag("frame")),_shader.set("uAnimation",_this.flag("animation")),_animation=name,_this.flag("playing",!0),loop())}(name,fps)},this.pause=function(){pause()},this.get("speed",_=>_this.flag("fps")),this.set("speed",fps=>{_this.flag("fps",fps)}),this.get("playing",_=>_this.flag("playing")),this.get("direction",_=>_this.flag("direction")),this.set("direction",direction=>{_this.flag("direction",direction),_shader.set("uDirection",_this.flag("direction"))})})),Class((function Billboard(_mesh,_shader,_input,_group){Inherit(this,Object3D);const _this=this,NAME=_this.parent.name,CURRENT={LevelGummiLeakslevel:"gummi-leaks",LevelCitricAlleylevel:"citric-alley",LevelDataMinelevel:"data-mine",LevelSugarRoadlevel:"sugar-road",LevelExoticPetShoplevel:"the-exotic-pet-shop"}[NAME];var _config;!function initConfig(){if(!Billboard.LEVELS[NAME]){let config=InputUIL.create(NAME+"_billboards");config.setLabel("Billboards"),config.add("video",""),config.addVector("cells",[3,3]),Billboard.LEVELS[NAME]=config}let input=Billboard.LEVELS[NAME],src=input.get("video");src=src.replace(".mp4",""),src=`assets/videos/${src}.mp4`;let cells=input.get("cells");_config={src:src,cells:cells}}(),function initVideo(){let fallback=!Tests.videoTexture(),src=fallback?"assets/images/fallback/screens.jpg":"assets/videos/screens.mp4";if(Billboard.VIDEO||(Billboard.VIDEO=new VideoTexture(src)),fallback)return;let video=Billboard.VIDEO;video.src=_config.src,video.start()}(),async function initShader(){let img1=Data.LEVELS[CURRENT].levelBillboardImage0,img2=Data.LEVELS[CURRENT].levelBillboardImage1,img3=Data.LEVELS[CURRENT].levelBillboardImage2;img1&&0!==img1.length||(img1="assets/images/fallback/billboard.jpg"),img2&&0!==img2.length||(img2=img1),img3&&0!==img3.length||(img3=img2),_shader.addUniforms({tVidMap:{value:Billboard.VIDEO,ignoreUIL:!0},tImg1:{value:Utils3D.getTexture(img1),ignoreUIL:!0},tImg2:{value:Utils3D.getTexture(img2),ignoreUIL:!0},tImg3:{value:Utils3D.getTexture(img3),ignoreUIL:!0},uCells:{value:(new Vector2).fromArray(_config.cells),ignoreUIL:!0},uCell:{value:new Vector2,batchUnique:!0},uImg:{value:0,batchUnique:!0},uType:{value:0,batchUnique:!0},uAspect:{value:1,batchUnique:!0},depthWrite:!1}),_mesh.renderOrder=-1,await _this.parent.ready(),await _this.wait(500);let aspect=_mesh.scale.x/_mesh.scale.y;_shader.set("uAspect",aspect)}(),this.onDestroy=_=>delete Billboard.LEVELS[NAME]}),_=>{Billboard.LEVELS={}}),Class((function Boss(_player,_layers,_level){Inherit(this,Component);const _this=this,CONFIGS=require("Bosses"),ID=Utils.getConstructorName(_level),Config=CONFIGS[ID]||{};var _boss,_position;function loop(){!function updatePosition(){if(!_layers)return;if(!_layers.boss)return;if(!Config||!Config.position)return;_position.copy(_layers.boss.transform),_position.y-=_layers.boss.transform.height*Config.position.y,_position.x-=_layers.boss.transform.width*Config.position.x}(),function applyVelocity(){if(!_player)return;let distance=_position.distanceTo(_player.transform),powDist=Math.pow(distance,2),power=Math.range(powDist,Math.pow(400,2),Math.pow(2e3,2),4.5,0,!0),zoom=Math.range(powDist,Math.pow(1650,2),Math.pow(3250,2),.575,1,!0);_level.bossZoom=Math.lerp(_level.bossZoom,zoom,.05),!_this.flag("needsReset")&&distance<=2700&&(_level.ui.glui.alpha=Math.range(distance,2150,1750,1,1e-6,!0),ViewController.instance().letterbox(Math.range(distance,2150,1500,0,1,!0),!0),_level.timeScale=Math.range(distance,2150,1250,1,.5,!0));if(0===power)return _player.transform.scale=1;let angle=Math.atan2(_position.y-_player.transform.y,_position.x-_player.transform.x),friction=Math.range(Math.pow(distance,2),Math.pow(350,2),Math.pow(500,2),1e-6,1,!0),scale=Math.range(Math.pow(distance,2),Math.pow(400,2),Math.pow(750,2),1e-6,1,!0);scale<.01?(_player.transform.x=_position.x,_player.transform.y=_position.y,friction=0):(_player.movement.velocity.x+=Math.cos(angle)*power*Render.HZ_MULTIPLIER,_player.movement.velocity.y+=Math.sin(angle)*power*Render.HZ_MULTIPLIER);_player.movement.velocity.x*=friction,_player.movement.velocity.y*=friction,_player.movement.movement.x*=friction,_player.movement.movement.y*=friction,_player.transform.scale=scale}(),function applyReset(){if(_this.flag("needsReset"))return;if(_player.transform.scale>.1)return;_this.flag("needsReset",!0),tween(_level,{timeScale:1.25},1e3,"easeInCubic"),sadToHappy(),clearTimeout(_this.delayReset),_this.events.fire(Level.END,{success:!0}),_this.events.fire(CameraFollow.SHAKE,{amount:180,delay:1e3,duration:4e3}),_this.delayReset=_this.delayedCall(_=>{tween(_level,{timeScale:1},250,"easeInCubic")},4e3)}(),function applyPlaybackRate(){if(!_boss)return}()}function sadToHappy(){tween(_boss,{playbackRate:1.75},1750,"easeOutQuad"),_boss.shader.tween("uProgress",1,1750,"easeOutQuad"),_boss.animate(Config.happy,.5)}function happyToSad(){tween(_boss,{playbackRate:1},500,"easeOutQuad"),_boss.shader.tween("uProgress",0,500,"easeOutQuad"),_boss.animate(Config.sad,1.5)}async function onReset(){await _this.wait(1e3),happyToSad(),_this.flag("needsReset",!1)}!async function(){await async function initBoss(){if(_boss=_layers.boss,_position=new Vector2,!_boss)return;(function initShader(){let shader=_this.initClass(Shader,"Boss",{map:{value:Utils3D.getTexture("assets/images/_scenelayout/uv.jpg"),ignoreUIL:!0},tMapFrom:{value:Utils3D.getTexture("assets/images/_scenelayout/uv.jpg")},tMapTo:{value:Utils3D.getTexture("assets/images/_scenelayout/uv.jpg")},tRainbow:{value:null,getTexture:Utils3D.getRepeatTexture},tExtraGlow:{value:null,getTexture:Utils3D.getRepeatTexture},uTransitionOrigin:{value:new Vector2},uTransitionNoise:{value:new Vector3},uNoiseRate:{value:1},uProgress:{value:0},uScale:{value:1},uSaturation:{value:1},uBrightness:{value:0},uHue:{value:0},uRainbowStrength:{value:.25},uRainbowSpeed:{value:1.45},uExtraGlowStrength:{value:5},uExtraGlowSpeed:{value:.3},uBlinkSpeed:{value:12}});Utils.getConstructorName(_level);shader.UILPrefix=`boss_${ID}_shader`,ShaderUIL.add(shader,_boss.uil.group).setLabel("Shader"),_boss.useShader(shader),_boss.flag("speedMult",.2)})(),await _boss.ready(),function addHandlers(){_this.events.sub(Level.RESET,onReset),Dev.expose("sadToHappy",sadToHappy),Dev.expose("happyToSad",happyToSad)}(),_this.startRender(loop),_this.flag("isReady",!0)}()}(),this.get("layer",_=>_boss),this.ready=_=>_this.wait("isReady")})),Class((function Breakable(_player,_layout){Inherit(this,Component);const _this=this;function onCollision({breakable:breakable}){if(breakable)for(let block of breakable)pop(block.mesh)}function pop(mesh){let x=mesh.position.x,y=mesh.position.y,end=y-50,velY=.2,velX=Math.random(-6,6,9)/100;mesh.batchNeedsUpdate=!0,Track.event(Level.CURRENT,"break-block"),_this.startRender((function arc(){let rate=_this.parent.timeScale;velY-=.015*rate,x+=velX*rate,y+=velY*rate,mesh.position.x=x,mesh.position.y=y,y<end&&(_this.stopRender(arc),mesh.visible=!1,mesh.scale.x=1e-6,mesh.scale.y=1e-6,_this.wait(100).then(_=>{mesh.batchNeedsUpdate=!1}))}))}!function initLayers(){_layout.breakable}(),function addHandlers(){_this.events.sub(Player.COLLISION,onCollision)}()})),Class((function Coins(_player,_layout,_camera){Inherit(this,Component);const _this=this,COLLECTIBLES=require("Collectibles")[_this.parent.name]||{};var _collected=[],_coins=[],_total=(new Vector2,0),_batch=[];function typeByCoordinate(pos){for(let key in COLLECTIBLES){let coords=COLLECTIBLES[key];Array.isArray(coords)||(coords=[coords]);for(let coord of coords)if(coord.x===pos.x&&coord.y===pos.y)return key}return"items"}function spriteByCoordinate(pos){for(let key in COLLECTIBLES){let coords=COLLECTIBLES[key];Array.isArray(coords)||(coords=[coords]);for(let coord of coords)if(coord.x===pos.x&&coord.y===pos.y)return coord.type}return 0}function getBatch(){let current=_this.flag("batchIndex"),next=current+1>=_batch.length-1?0:current+1;return _this.flag("batchIndex",next),_batch[current]}function onCollision({coins:coins}){if(!coins)return;let rate=_this.parent.timeScale;for(let coin of coins){if(_collected.includes(coin.index))continue;let index=coin.index,type=typeByCoordinate(coin.spritePos);_player.inventory.add(type,1),_this.events.fire(Coins.COLLECTED,{index:index,type:type}),Track.event(Level.CURRENT,"collect",type);let y=coin.mesh.position.y+30,x="coins"===type?-7.25:"keys"===type&&7.25,batch=getBatch();batch.attributes.sprite=spriteByCoordinate(coin.spritePos),batch.position.copy(coin.mesh.position),batch.scale.copy(coin.mesh.scale),batch.batchNeedsUpdate=!0,coin.mesh.batchNeedsUpdate=!0,coin.mesh.attributes.opacity=0,defer(_=>coin.mesh.batchNeedsUpdate=!1),!1===x?tween(batch.scale,{x:1e-5,y:1e-5},1/rate*125,"easeOutCubic").onUpdate(v=>{batch.attributes.opacity=Math.range(v,.5,1,1,0)}).onComplete(_=>{batch.attributes.opacity=0,defer(_=>batch.batchNeedsUpdate=!1)}):tween(batch.position,{y:y},1/rate*1e3,"easeInQuad").onUpdate(v=>{batch.attributes.opacity=Math.range(v,.5,1,1,0),batch.position.x=Math.lerp(_camera.position.x/100+x,batch.position.x,.05*rate)}).onComplete(_=>{batch.attributes.opacity=0,defer(_=>batch.batchNeedsUpdate=!1)}),_collected.push(index)}}!async function(){await _layout.ready(),function initBatch(){let batch=new MeshBatch,geom=World.PLANE,shader=_this.initClass(Shader,"CoinCollection",{uSprites:{value:7},tMap:{value:Utils3D.getTexture("assets/images/collectibles/pickups.png")},depthWrite:!1,depthTest:!1,transparent:!0});for(;_batch.length<64;){let mesh=new Mesh(geom,shader),sprite=0,opacity=0;mesh.attributes={sprite:sprite,opacity:opacity},mesh.renderOrder=999999999,mesh.batchNeedsUpdate=!1,_batch.push(mesh),batch.add(mesh)}batch.frustumCulled=!1,batch.renderOrder=999999999,_layout.add(batch.group),_this.flag("batchIndex",0)}(),function initCoins(){_coins=_layout.coins,_total=_coins.filter(coin=>"coins"===typeByCoordinate(coin.spritePos)).length,Dev.expose("totalCoins",_total)}(),function addHandlers(){_this.events.sub(Player.COLLISION,onCollision)}()}(),this.get("coins",_=>_coins),this.get("total",_=>_total)}),_=>{Coins.COLLECTED="coin_collected"}),Class((function Door(_player,_region){Inherit(this,Component);const _this=this;var _v2=new Vector2;function detect(){let distX=Math.abs(_v2.x-_player.transform.x);Math.abs(_v2.y-_player.transform.y)<=.5*_region.height+300&&distX<=.5*_region.width+300&&function open(){if(!_player.inventory.remove("keys",1))return;_this.flag("unlocked",!0),_this.stopRender(detect),_this.events.fire(Coins.COLLECTED,{type:"keys"}),_player.collision.openDoors(_region.meshes);let axis=_region.width>_region.height?"x":"y",cells=_region.meshes.sort((a,b)=>a.position[axis]-b.position[axis]);for(let[i,cell]of cells.entries()){cell.batchNeedsUpdate=!0;let xScale="x"===axis?0:cell.scale.x,yScale="y"===axis?0:cell.scale.y,xPos=cell.position.x+cell.scale.x*("x"===axis?1:0),yPos=cell.position.y+cell.scale.y*("y"===axis?1:0);tween(cell.scale,{x:xScale,y:yScale},100,"linear",100*i),tween(cell.position,{x:xPos,y:yPos},100,"linear",100*i).onComplete(_=>{cell.batchNeedsUpdate=!1})}_this.onUnlock&&_this.onUnlock()}()}_this.flag("unlocked",!1),_v2.set(_region.x+.5*_region.width,_region.y+.5*_region.height),_this.startRender(detect,10),this.get("unlocked",_=>_this.flag("unlocked")),this.get("region",_=>_region)})),Class((function Doors(_player,_layout){Inherit(this,Component);const _this=this;var _regions;function findByCoordinate(cells,x,y){return cells.find(c=>c.x===x&&c.y===y)}_this.list=[],async function(){await _layout.ready(),function initRegions(){let cells=_layout.doors;_regions=function joinNeighbors(cells){return function joinY(c){let yMin=null,yMax=null,xMin=null,xMax=null;c.map(cell=>{yMax=null===yMax?cell.y:Math.max(cell.y,yMax),yMin=null===yMin?cell.y:Math.min(cell.y,yMin),xMax=null===xMax?cell.x:Math.max(cell.x,xMax),xMin=null===xMin?cell.x:Math.min(cell.x,xMin)});let x=xMin;for(;x<=xMax;){let y=yMin;for(;y<=yMax;){let cell=findByCoordinate(c,x,y);if(cell){let neighbor;do{neighbor=findByCoordinate(c,x,y+cell.height),neighbor&&neighbor.width===cell.width?(cell.meshes.push(...neighbor.meshes),c.remove(neighbor),cell.height+=neighbor.height):neighbor=!1}while(neighbor)}y+=100}x+=100}return c}(function joinX(c){let yMin=null,yMax=null,xMin=null,xMax=null;c.map(cell=>{yMax=null===yMax?cell.y:Math.max(cell.y,yMax),yMin=null===yMin?cell.y:Math.min(cell.y,yMin),xMax=null===xMax?cell.x:Math.max(cell.x,xMax),xMin=null===xMin?cell.x:Math.min(cell.x,xMin)});let y=yMin;for(;y<=yMax;){let x=xMin;for(;x<=xMax;){let cell=findByCoordinate(c,x,y);if(cell){let neighbor;do{neighbor=findByCoordinate(c,x+cell.width,y),neighbor&&neighbor.height===cell.height?(cell.meshes.push(...neighbor.meshes),c.remove(neighbor),cell.width+=neighbor.width):neighbor=!1}while(neighbor)}x+=100}y+=100}return c}(cells=cells.slice().map(cell=>(cell.mesh.index=cell.index,cell.meshes=[cell.mesh],delete cell.mesh,cell))))}(cells)}(),function initDoors(){for(let region of _regions)_this.list.push(_this.initClass(Door,_player,region))}(),_this.flag("isReady",!0)}(),this.ready=_=>_this.wait("isReady"),this.get("unlocked",_=>{let sum=0;return _this.list.map(door=>!!door.flag("unlocked")&&sum++),sum})})),Class((function Enemies(_player,_layout,_proton){Inherit(this,Component);const _this=this,CONFIG=require("Enemies")[_this.parent.name];var _regions,_death,_mobs=[];function findByCoordinate(cells,x,y){return cells.find(c=>c.x===x&&c.y===y)}function typeByCoordinate(pos){for(let key in CONFIG){let coord=CONFIG[key];if(coord.x===pos.x&&coord.y===pos.y)return key}return"UnknownEnemy"}function onPlayerCollision({enemies:enemies,projectiles:projectiles,type:type}){if(!enemies&&!projectiles)return;let arr=enemies||projectiles;for(let enemy of arr)enemy.die&&_death.play(enemy,projectiles?"shot":"crushed");let delay=Math.range(Math.abs(_player.movement.velocity.y),0,30,125,0,!0);"playerHit"===type&&_this.delayedCall(_=>{let gamepad=!!(_player.input&&_player.input.input&&_player.input.input.gamepad)&&_player.input.input.gamepad;gamepad&&(gamepad.playEffect={duration:150,strongMagnitude:.5}),_player.movement.flag("hitEnemy",!0,100),_player.movement.velocity.y=-25},delay)}async function onLevelReset(){await defer();for(let enemy of _mobs)enemy.reset()}!async function(){await _layout.ready(),function initRegions(){let cells=_layout.enemies;_regions=function joinNeighbors(cells){return function joinY(c){let yMin=null,yMax=null,xMin=null,xMax=null;c.map(cell=>{yMax=null===yMax?cell.y:Math.max(cell.y,yMax),yMin=null===yMin?cell.y:Math.min(cell.y,yMin),xMax=null===xMax?cell.x:Math.max(cell.x,xMax),xMin=null===xMin?cell.x:Math.min(cell.x,xMin)});let x=xMin;for(;x<=xMax;){let y=yMin;for(;y<=yMax;){let cell=findByCoordinate(c,x,y);if(cell){let neighbor;do{neighbor=findByCoordinate(c,x,y+cell.height),neighbor&&neighbor.width===cell.width?(c.remove(neighbor),cell.height+=neighbor.height):neighbor=!1}while(neighbor)}y+=100}x+=100}return c}(function joinX(c){let yMin=null,yMax=null,xMin=null,xMax=null;c.map(cell=>{yMax=null===yMax?cell.y:Math.max(cell.y,yMax),yMin=null===yMin?cell.y:Math.min(cell.y,yMin),xMax=null===xMax?cell.x:Math.max(cell.x,xMax),xMin=null===xMin?cell.x:Math.min(cell.x,xMin)});let y=yMin;for(;y<=yMax;){let x=xMin;for(;x<=xMax;){let cell=findByCoordinate(c,x,y);if(cell){let neighbor;do{neighbor=findByCoordinate(c,x+cell.width,y),neighbor&&neighbor.height===cell.height?(c.remove(neighbor),cell.width+=neighbor.width):neighbor=!1}while(neighbor)}x+=100}y+=100}return c}(cells.slice()))}(cells)}(),function spawnEnemies(){let batch=new MeshBatch;_layout.parent.add(batch);let geom=World.PLANE,texture=Utils3D.getTexture("assets/images/enemies/enemies_sprites.png");texture.minFilter=texture.magFilter=Texture.NEAREST;let shader=_this.initClass(Shader,"BasicEnemy",{tMap:{value:texture},uDisabled:{value:0},uTextureSize:{value:512},uFrameSize:{value:64},uFrame:{value:0},transparent:!0,depthWrite:!1,depthTest:!1});for(let region of _regions){let type=typeByCoordinate(region.spritePos);if("UnknownEnemy"===type)continue;let mesh=new Mesh(geom,shader),animation=["BasicEnemy","ShootingEnemy","FlyingEnemy"].indexOf(type);mesh.attributes={direction:1,disabled:0,animation:animation},mesh.batchNeedsUpdate=!1,mesh.scale.setScalar(100),_mobs.push(_this.initClass(window[type],_player,mesh,region,_this.parent)),batch.add(mesh)}batch.renderOrder=99999;let frame=0;_this.startRender(_=>{frame>=5&&(frame=0),shader.set("uFrame",frame),frame++},4)}(),function initEffects(){_death=_this.initClass(EnemyDeath,_proton)}(),function addHandlers(){_this.events.sub(Player.COLLISION,onPlayerCollision),_this.events.sub(Level.RESET,onLevelReset)}()}(),this.get("mobs",_=>_mobs),this.get("projectiles",_=>{let shots=[];for(let mob of _mobs)mob.weapon&&shots.push(...mob.weapon.shot.slice());return shots})})),Class((function Enemy(_player,_mesh,_region){Inherit(this,Component);const HACKS=require("Hacks"),_this=this;function loop(){let offScreen=_mesh.position.distanceTo(_player.position)>3e3;offScreen&&offScreen===_this.flag("offScreen")||(_this.lastX=_mesh.position.x,_this.lastY=_mesh.position.y,_mesh.position.set(_this.x,-_this.y)),offScreen!==_this.flag("offScreen")&&(_this.flag("offScreen",offScreen),_mesh.batchNeedsUpdate=!_this.flag("offScreen"))}function onHack({type:type}){if("disableEnemies"!==type)return;let duration=HACKS.disableEnemies.duration,warning=duration-1500;_this.flag("disabled",!0,duration),clearTimeout(_this.warningTimer),_this.warningTimer=_this.delayedCall(_=>{_this.flag("warnEnable",!0,1500)},warning)}_this.width=200,_this.height=200,_this.mesh=_mesh,_this.x=_region.x,_this.y=_region.y-45,_this.lastX=_region.x,_this.lastY=_region.y-45,function addHandlers(){_this.events.sub(Hacks.EVENT,onHack)}(),_this.startRender(loop),this.get("name",_=>Utils.getConstructorName(_this)),this.reset=function(){_this.flag("dead",!1),_this.die=!1,_this.x=_region.x,_this.y=_region.y-45,_this.lastX=_region.x,_this.lastY=_region.y-45,_mesh.visible=!0,_mesh.scale.x=_this.height,_mesh.scale.y=_this.height},this.kill=function(){_this.flag("dead",!0);let start=_this.y,end=start+_this.height/2;tween(_mesh.scale,{y:1e-5},200,"easeOutCubic").onUpdate(t=>{_this.y=Math.lerp(start,end,1-t)}).onComplete(_=>{_mesh.visible=!1})}})),Class((function EnemyDeath(_proton){Inherit(this,Component);const _this=this;var _origin=new Vector3;function fire(){_proton&&_proton.spawn&&_proton.spawn.release(_origin,20,.1,25)}!async function(){Dev.expose("fire",_=>{_origin.copy(player.position).multiplyScalar(.01),fire()}),Dev.expose("proton",_proton)}(),this.play=function(enemy,src){_proton&&(_origin.copy(enemy.mesh.position).multiplyScalar(.01),fire()),Track.event(Level.CURRENT,"kill",src,enemy.name),_this.events.fire(AudioController.PLAY,{name:"enemyDeath"}),enemy.kill()}})),Class((function BasicEnemy(_player,_mesh,_region,_level){Inherit(this,Enemy,_player,_mesh,_region);const _this=this;var _direction=1;function loop(time){if(_this.flag("offScreen"))return;let disabled=_this.flag("disabled"),attr=disabled?1:0;if(_this.flag("warnEnable")&&(attr*=time/150%1>.5?0:1),_mesh.attributes.disabled=attr,disabled)return;if(_this.flag("dead"))return;let rate=_level.timeScale,position=_this.x+5*_direction;position-.5*_this.width<=_region.x&&(_direction=1),position>=_region.x+_region.width-_this.width&&(_direction=-1),_this.x+=5*_direction*rate*Render.HZ_MULTIPLIER,_mesh.attributes.direction=_direction}_this.startRender(loop),_this.reset()})),Class((function FlyingEnemy(_player,_mesh,_region,_level){Inherit(this,Enemy,_player,_mesh,_region);const _this=this;var _direction=new Vector2(1,1);function loop(time){if(_this.flag("offScreen"))return;let disabled=_this.flag("disabled"),attr=disabled?1:0;_this.flag("warnEnable")&&(attr*=time/150%1>.5?0:1),_mesh.attributes.disabled=attr,disabled||_this.flag("dead")||(!function horizontal(){if(_region.width<=200)return _direction.x=_player.position.x>_mesh.position.x?1:-1;let rate=_level.timeScale,position=_this.x+5*_direction.x*Render.HZ_MULTIPLIER;position-.5*_this.width<=_region.x&&(_direction.x=1);position>=_region.x+_region.width-_this.width&&(_direction.x=-1);_this.x+=5*_direction.x*rate*Render.HZ_MULTIPLIER}(),function vertical(){if(_region.height<=300)return;let rate=_level.timeScale,position=_this.y+5*_direction.y*Render.HZ_MULTIPLIER;position-.5*_this.height<=_region.y&&(_direction.y=1);position>=_region.y+_region.height-_this.height&&(_direction.y=-1);_this.y+=5*_direction.y*rate*Render.HZ_MULTIPLIER}(),_mesh.attributes.direction=_direction.x)}_this.startRender(loop),_this.reset()})),Class((function EnemyWeapon(_enemy,_player){Inherit(this,Component);const _this=this,WEAPONS=require("Weapons");function loop(time,delta){let i=_this.shot.length-1;for(;i>=0;){let projectile=_this.shot[i],scale=100;_this.update(projectile),projectile.x=projectile.mesh.position.x,projectile.y=-projectile.mesh.position.y,projectile.width=_this.size*scale,projectile.height=_this.size*scale,projectile.life-=delta,projectile.life<=0&&(_this.reset(projectile),_this.shot.splice(i,1)),i--}}function defaultMovement(projectile,position){position.x+=projectile.speed*projectile.direction}function onCollision({projectile:projectile}){projectile&&(projectile.life=0)}_this.style="#dddddd",_this.perShot=1,_this.rate=3,_this.speed=30,_this.size=.05,_this.direction=1,_this.life=2e3,_this.shake=15,_this.shot=[],function addHandlers(){_this.events.sub(Player.COLLISION,onCollision)}(),_this.startRender(loop),this.reset=function(projectile){projectile.mesh.position.set(0,1e3,0),projectile.mesh.attributes.enemyShot=0,defer(_=>projectile.mesh.batchNeedsUpdate=!1)},this.update=function(projectile){projectile.update(projectile,projectile.mesh.position)},this.fire=function(mesh){let position=_enemy.position;mesh.position.set(position.x+.5*_this.direction,position.y,0),mesh.scale.setScalar(.5*_this.size*1e3),mesh.attributes.enemyShot=1,mesh.batchNeedsUpdate=!0,_this.shot.push({mesh:mesh,life:_this.life,direction:_this.direction,speed:_this.speed,update:_this.flag("weapon").update||defaultMovement,random:Math.random(),src:"enemy"})},this.shoot=function(state){let meshes=_player.projectiles.getProjectiles(_this.perShot);for(let mesh of meshes)_this.fire(mesh)},this.select=function(index=0){let weapon=WEAPONS[index];for(let key in weapon)"update"!==key&&(_this[key]=weapon[key]);_this.flag("weapon",weapon)}})),Class((function ShootingEnemy(_player,_mesh,_region,_level){Inherit(this,Enemy,_player,_mesh,_region);const _this=this;var _direction=1;function loop(time){if(_this.flag("offScreen"))return;let disabled=_this.flag("disabled"),attr=disabled?1:0;if(_this.flag("warnEnable")&&(attr*=time/150%1>.5?0:1),_mesh.attributes.disabled=attr,disabled)return;if(_this.flag("dead"))return;let position=_this.x;position<=_level.player.transform.x&&(_direction=1),position>=_level.player.transform.x-_this.width&&(_direction=-1),_mesh.attributes.direction=_direction,function inRange(){let distance=_mesh.position.distanceTo(_level.player.position),yDist=Math.abs(_mesh.position.y-_level.player.position.y),canShoot=distance<1200&&yDist<600;canShoot&&!_this.onTimer&&(_this.onTimer=!0,_this.shootTimer=_this.delayedCall(_=>{_this.flag("canShoot",!0)},500));!canShoot&&_this.onTimer&&(_this.flag("canShoot",!1),clearTimeout(_this.shootTimer),_this.onTimer=!1)}(),_this.flag("fireDelay")||function shoot(){if(!_this.flag("canShoot"))return;_this.events.fire(AudioController.PLAY,{name:"enemyShoot"}),_this.flag("fireDelay",!0,3500),_this.weapon.direction=_direction,_this.weapon.shoot()}()}!async function(){await _level.ready(),await _level.player.ready(),function initWeapon(){_this.weapon=_this.initClass(EnemyWeapon,_mesh,_level.player),_this.weapon.select(1)}(),_this.startRender(loop),_this.reset()}()})),Class((function GameEnvironment(_mesh,_shader){Inherit(this,Component);_shader.addUniforms({tMap:{value:Utils3D.getTexture("assets/images/_scenelayout/uv.jpg")},uFogColor:{value:new Color},uFogDistance:{value:new Vector2(0,100)},uFogBrightness:{value:new Vector2(50,80)},uAlpha:{value:1}})})),Class((function SpaceShips(_mesh,_shader){Inherit(this,Component);const _this=this;function getTexture(src){let texture=Utils3D.getTexture(src);return texture.wrapS=texture.wrapT=Texture.REPEAT,texture.minFilter=texture.magFilter=Texture.NEAREST,texture.promise.then(_=>{let{width:width,height:height}=texture.dimensions,ratio=width/height;_shader.set("uTextureAspect",ratio)}),texture}_shader.addUniforms({tMap:{value:null,getTexture:getTexture},uMeshAspect:{value:1,batchUnique:!0,ignoreUIL:!0},uTextureAspect:{value:1,ignoreUIL:!0},uAlpha:{value:1,batchUnique:!0},uSpeed:{value:1,batchUnique:!0},uDirection:{value:1,batchUnique:!0},transparent:!0}),_this.startRender(_=>{_shader.set("uMeshAspect",_mesh.scale.x/_mesh.scale.y)})})),Class((function Fog({size:size}){Inherit(this,Object3D);const _this=this;var _batch,_meshes=[];!async function(){await function initBatch(){(_batch=new MeshBatch).static=!0,_this.add(_batch)}(),await function initMeshes(){for(let i=0;i<Tests.fogAmount();i++){let shader=_this.initClass(Shader,"Fog",{depthWrite:!1,uAlpha:{value:.05},uSeed:{value:Math.random(0,1e3),batchUnique:!0},tMap:{value:Utils3D.getTexture("assets/images/vfx/smoke.jpg")},transparent:!0}),mesh=new Mesh(World.TEST,shader),scale=Math.random(15,20,3);mesh.position.x=Math.random(0,size[0],3),mesh.position.y=Math.random(0,size[1],3),mesh.rotation.z=Math.random(0,Math.PI,3),mesh.scale.x=scale,mesh.scale.y=scale,_batch.add(mesh),_meshes.push(mesh)}_batch.renderOrder=9999}(),"Fog"===Global.PLAYGROUND&&World.SCENE.add(_this.group),_this.group.scale.setScalar(100)}()})),Class((function Gate(_player,_layers){Inherit(this,Component);const _this=this;var _gate,_doors;function loop(){_gate.position.distanceTo(_player.position)<=750&&function unlocked(){let doors=_doors.list;if(0===doors.length)return _player.inventory.items.keys>=5;let open=!0;for(let door of doors)door.unlocked||(open=!1);return open}()&&!_this.flag("open")&&_this.open()}!async function(){Dev.expose("gate",_this),_this.flag("open",!1),function initLayer(){_gate=_layers.gate,_doors=_this.parent.doors}(),await _doors.ready(),_gate&&_this.startRender(loop,10)}(),this.open=function(){_gate&&!_this.flag("open")&&(_player.collision.unlockGate(),_gate.shader.tween("uProgress",1,500,"easeOutCubic"),_this.flag("open",!0))},this.close=function(){_gate&&_this.flag("open")&&(_player.collision.lockGate(),_gate.shader.tween("uProgress",0,500,"easeOutCubic"),_this.flag("open",!1))}})),Class((function GateShader(_mesh,_shader){Inherit(this,Component);_shader.addUniforms({tGateOpen:{value:Utils3D.getTexture("assets/images/_scenelayout/uv.jpg")},tGateClosed:{value:Utils3D.getTexture("assets/images/_scenelayout/uv.jpg")},uProgress:{value:0},transparent:!0})})),Class((function Hacks(){Inherit(this,Component);const _this=this;function onKeyUp({keyCode:keyCode}){let type=!1;switch(keyCode){case 49:type="invincible";break;case 50:type="disableEnemies";break;case 51:type="speedBoost";break;case 52:type="jumping"}type&&_this.fire(type)}function onHack(){_this.events.fire(AudioController.PLAY,{name:"powerUp"})}Dev.expose("hacks",_this),function addHandlers(){Hydra.LOCAL&&_this.events.sub(Keyboard.UP,onKeyUp),_this.events.sub(Hacks.EVENT,onHack)}(),this.fire=type=>{_this.events.fire(Hacks.EVENT,{type:type})}}),_=>{Hacks.EVENT="hacks_event"}),Class((function Hazards(_player,_layout){Inherit(this,Component);const _this=this,CONFIG=require("Hazards"),HACKS=require("Hacks");function getHazardType(hazard){let type=getTypeFromCoordinates(hazard.spritePos);return CONFIG[type].type}function getTypeFromCoordinates(pos){for(let key in CONFIG){let coord=CONFIG[key].coordinates;if(coord.x===pos.x&&coord.y===pos.y)return key}return Hydra.LOCAL&&console.warn(`unknown hazard at coord x:${pos.x},y:${pos.y}`),"slowing"}function onPlayerCollision({hazards:hazards}){if(!hazards)return;let type=getTypeFromCoordinates(hazards[0].spritePos),hazard=CONFIG[type];_this.flag("invincible")&&hazard.harmful||(0,hazard.collision)(_player,_this)}function onHack({type:type}){switch(type){case"invincible":_this.flag("invincible",!0,HACKS.invincible.duration)}}!async function(){await _layout.ready(),function initHazards(){let batch=new MeshBatch;batch.static=!0;let geom=World.PLANE,shader=function initShader(){let texture=function getTexture(){let texture=Utils3D.getTexture("assets/images/hazards/hazards.png");return texture.minFilter=texture.magFilter=Texture.NEAREST,texture}();return _this.initClass(Shader,"HazardTile",{tMap:{value:texture},uFrameSize:{value:new Vector2(32,32)},uTextureSize:{value:new Vector2(1024,1024)},uAnimationSize:{value:20},uAnimationSpeed:{value:20},uAlpha:{value:1},depthWrite:!1,depthTest:!1,transparent:!0})}(),index=0;for(let hazard of _layout.hazards){let mesh=new Mesh(geom,shader),type=getHazardType(hazard);mesh.attributes={type:type,index:index},mesh.position.copy(hazard.mesh.position),mesh.scale.copy(hazard.mesh.scale),batch.add(mesh),index++}batch.frustumCulled=!1,batch.renderOrder=50,_layout.group.add(batch.group)}(),function addHandlers(){_this.events.sub(Player.COLLISION,onPlayerCollision),_this.events.sub(Hacks.EVENT,onHack)}()}()})),Class((function IntroLevel(level="LevelGummiLeaks"){Inherit(this,GameView,{audio:!0,background:!1,logo:"left"});const _this=this;var _wrapper,_layout,_cameras,_groups,_groupsElements,_texts,_next,_skip,_firstCamera,_bg,$line,_levelReady,_constructorName=Utils.getConstructorName(_this),_index=0,_color=new Color("#ffffff");function onResize(){_skip.x=30*_skip.scale,_skip.y=Stage.height-35*_skip.scale,_next.x=Stage.width-30*_next.scale,_next.y=Stage.height-35*_next.scale,$line.x=Stage.width-60-82*_next.scale,$line.y=Stage.height-35*_next.scale*.88}function handleChange(index){_this.flag("isAnimating")||(_this.flag("isAnimating",!0),_cameras[index]?(_cameras[_index].still(0),_cameras[index].transition(2e3,"inOut"),_groupsElements[_index].forEach(element=>element.animateOut()),_groupsElements[index].forEach(element=>element.animateIn()),_this.delayedCall(_=>{_cameras[index].orbit(),_index=index,_this.flag("isAnimating",!1),startAutoplay()},2e3)):index===_cameras.length?async function handleEnd(){if(_this.flag("transitioning"))return;if(_this.flag("transitioning",!0),await _levelReady,Global.PLAYGROUND)return;_texts.forEach(text=>text.animateOut()),_cameras.forEach(camera=>{camera.moveXY.setScalar(0),camera.deltaRotate=0}),_this.delayedCall(_=>{ViewController.instance().effect("GlitchEffect")},400),_this.delayedCall(_=>{ViewController.instance().transition(level,null,"IntroTransition")},1e3)}():_this.flag("isAnimating",!1))}function handleKeyDown({keyCode:keyCode}){40===keyCode?_this.previous():38===keyCode&&_this.next()}function handleWheel(e){let direction=e.deltaY>0?1:e.deltaY<0?-1:0;0!==direction&&(1===direction?_this.next():_this.previous())}function handleNext(){_this.next()}function loop(){_this.render()}function startAutoplay(){_this.timeout&&stopAutoplay(_this.timeout),$line.x=Stage.width-82*_next.scale,$line.scaleX=0,$line.tween({scaleX:1,x:Stage.width-60-82*_next.scale},1e3,"easeOutCubic",_=>{$line.tween({scaleX:0,x:Stage.width-82*_next.scale},8e3,"linear")}),_this.timeout=_this.delayedCall(_=>{_this.next(),clearInterval(_this.timerInterval)},9e3)}function stopAutoplay(){clearTimeout(_this.timeout)}_this.uiDelay=2e3,async function(){_this.visible=!1,_wrapper=new Group,_this.create(),_this.setDPR(1),_this.setResolution(Tests.getIntroLevelResolution()),await Data.ready();let levels=Levels.instance().getList(),check=_constructorName.replace("Intro","Level");levels.forEach(l=>{l.level==check&&(_color=new Color(l.color))}),function initBg(){let shader=_this.initClass(Shader,"IntroComicBG",{uBase:{value:new Color(Colors.instance().getColor("DARK_BLUE"))},uColor:{value:_color},uAlpha:{value:0},side:Shader.BACK_SIDE});(_bg=new Mesh(World.SPHERE,shader)).shader=shader,_bg.scale.setScalar(300),_this.scene.add(_bg)}(),await async function initLayout(){let load=await Initializer3D.queue();_layout=_this.initClass(SceneLayout,_constructorName),await Initializer3D.uploadAllDistributed(_layout),load()}(),await async function initCameras(){(_cameras=await _layout.getAllMatching("camera-")).forEach(camera=>camera.still()),(_firstCamera=new BaseCamera).group.position.z=5,_cameras.forEach(camera=>{camera.moveXY.set(Device.mobile?-1.5:-3.5,1),camera.deltaRotate=5})}(),await async function initGroups(){_groups=await _layout.getLayers("step-1","step-2","step-3"),_groupsElements=_groups.map(group=>group.children.map(child=>child.classRef)),_texts=await _layout.getAllMatching("text"),_groupsElements.forEach(group=>{group.forEach(element=>{if(element.shader&&element.shader.uniforms.uBgColor&&element.shader.set("uBgColor",_color),element.shader&&element.shader.uniforms.uBorderColor&&element.shader.set("uBorderColor",_color),element.text){let textColor=new Color("#ffffff");textColor.lerp(_color,.7),element.textColor=textColor.getHexString(),element.text.setColor(element.textColor)}})})}(),await function initNext(){_next=_this.initClass(UILabel,Data.COPY.next||"Next",{align:"right",fontSize:9,letterSpacing:-.05,onClick:handleNext}),_this.glui.add(_next.element),_this.elements.push(_next),$line=$gl(60,4,"assets/images/_scenelayout/mask.jpg"),_this.glui.add($line),$line.scaleX=0,$line.x=Stage.width-82*_next.scale,_next.animateOut()}(),await function initSkip(){_skip=_this.initClass(UILabel,Data.COPY.skip,{align:"left",fontSize:9,letterSpacing:-.05,onClick:_=>{let{name:name}=Config.TRACK_LEVEL[level],type=`Level${name.split(" ").join("")}Intro`;Track.event(type,"click","skip"),handleChange(_cameras.length)}}),_this.glui.add(_skip.element),_this.elements.push(_skip),_skip.animateOut()}(),Dev.expose("next",_=>_this.next()),_this.startRender(loop),Global.PLAYGROUND&&(_this.visible=!0,_this.animateIn()),_wrapper.add(_layout.group),_this.scene.add(_wrapper),function addHandlers(){_this.onResize(onResize)}(),_this.onResizeDelayed(onResize),await defer(),_this.flag("isReady",!0)}(),_this.next=function(){let{name:name}=Config.TRACK_LEVEL[level],type=`Level${name.split(" ").join("")}Intro`;Track.event(type,"click","next"),handleChange(_index+1),$line.tween({scaleX:0,x:Stage.width-82*_next.scale},1e3,"easeOutCubic"),clearInterval(_this.timerInterval)},_this.previous=function(){let{name:name}=Config.TRACK_LEVEL[level],type=`Level${name.split(" ").join("")}Intro`;Track.event(type,"click","previous"),handleChange(_index-1)},_this.animateIn=async function(){await _this.wait(_this,"isReady"),_this.flag("transitioning",!1);let{route:route,name:name}=Config.TRACK_LEVEL[level];Track.page(`/level/${route}/intro`,`Level ${name} Intro`),ScreensBackground.instance().disable(),_this.wait(100).then(async _=>{_this.flag("isAnimating",!0),_firstCamera&&_firstCamera.lock(),_cameras[0].transition(2e3,"inOut"),_groupsElements[0].forEach(element=>element.animateIn()),_this.delayedCall(_=>{_cameras[0].orbit(),_index=0,_this.flag("isAnimating",!1),function addEvents(){document.addEventListener("wheel",handleWheel),_this.events.sub(Keyboard.DOWN,handleKeyDown)}(),startAutoplay(),Global.PLAYGROUND||(_levelReady=ViewController.instance().initLevel(level))},2e3),_bg&&_bg.shader.tween("uAlpha",1,3e3,"easeInOutSine"),_texts.forEach(text=>text.show()),_skip.animateIn(),_next.animateIn()})},_this.animateOut=async function(){return _skip.animateOut(),function removeEvents(){document.removeEventListener("wheel",handleWheel),_this.events.unsub(Keyboard.DOWN,handleKeyDown)}(),stopAutoplay(),_groupsElements.forEach(group=>{group.forEach(element=>element.animateOut())}),_bg&&_bg.shader.tween("uAlpha",0,1e3,"easeOutCubic"),_this.flag("isAnimating",!1),_texts.forEach(text=>text.hide()),Promise.resolve()}})),Class((function IntroTextBox(_input,_group){Inherit(this,Object3D);const _this=this;var _shader,_shaderText,_data,_text="",_textColor="#ffffff",_textPadding=.15,_textSize=20,_textWidth=5,_firstResize=!0;async function onResize(){let size=.01*_textSize,width=.1*_textWidth;await _this.text.setText(_text,{size:size,width:width}),await _this.text.loaded(),_firstResize&&(_firstResize=!1,_this.text.text.mesh.frustumCulled=!1,_this.wrapper.mesh.frustumCulled=!1),_this.wrapper.width=_this.text.dimensions.width+2*_textPadding,_this.wrapper.height=_this.text.dimensions.height+2*_textPadding,_shader.set("uAspect",Math.round(_this.wrapper.width/_this.wrapper.height,5)),await _this.wrapper,_this.text.x=-_this.text.dimensions.width/2-_this.wrapper.width*_shader.uniforms.uShadowGap.value*.5/_shader.uniforms.uAspect.value,_this.text.y=-_this.text.dimensions.height/2-_this.wrapper.height*_shader.uniforms.uShadowGap.value*.5,_this.text.setColor(_this.textColor||_textColor)}!async function(){_this.constructorName=Utils.getConstructorName(_this),await async function initWrapper(){_this.wrapper=$gl(_textWidth,0,"empty"),_this.wrapper.setZ(-1)}(),await async function initText(){_this.text=$glText(_text,UI.FONT_PRIMARY,_textSize,{color:Colors.instance().getColor("WHITE"),align:"left",wordBreak:!1}),await _this.text.loaded(),_this.wrapper.add(_this.text),GLUI.Scene.add(_this.wrapper),_this.group.add(_this.wrapper.anchor)}(),await function initShader(){_shader=new Shader("IntroTextBox",{unique:_input.prefix,uBgColor:{value:new Color},uBorderColor:{value:new Color},uBorderWidth:{value:.05},uShadowGap:{value:.05},uDotSize:{value:10},uDotAmount:{value:.1},uDotRadius:{value:1},uAlpha:{value:1,ignoreUIL:!0},uAspect:{value:1,ignoreUIL:!0},uFogFar:{value:18,ignoreUIL:!0},uFogNear:{value:10,ignoreUIL:!0},tMap:{value:null,ignoreUIL:!0},uOpacity:{value:0,ignoreUIL:!0},transparent:!0}),_this.shader=_shader,_this.wrapper.useShader(_shader),ShaderUIL.add(_shader,_group).setLabel("Text Box Shader"),_shaderText=_this.initClass(Shader,"IntroTextText",{unique:_input.prefix,tMap:{value:null,ignoreUIL:!0},uFogFar:{value:18,ignoreUIL:!0},uFogNear:{value:10,ignoreUIL:!0},uOpacity:{value:0,ignoreUIL:!0},transparent:!0}),_this.text.useShader(_shaderText)}(),function initUIL(){(_data=InputUIL.create("IntroTextBox_"+_input.prefix,_group)).setLabel("Text Options"),_data.addTextarea("Text"),_data.addNumber("TextSize",_textSize),_data.addNumber("TextPadding",.15),_data.addColor("TextColor"),_data.addNumber("Width",_textWidth),_text=_data.get("Text")||"This is a placeholder text";let textField=_data.getField("Text");textField&&textField.onChange(val=>{_text=val,onResize()});_textSize=_data.getNumber("TextSize")||10;let textSizeField=_data.getField("TextSize");textSizeField&&textSizeField.onChange(val=>{_textSize=val,onResize()});_textPadding=_data.getNumber("TextPadding")||.15;let textPaddingField=_data.getField("TextPadding");textPaddingField&&textPaddingField.onChange(val=>{_textPadding=val,onResize()});_textColor=_data.get("TextColor")||"#ffffff";let tColField=_data.getField("TextColor");tColField&&tColField.onChange(t=>{_textColor=t,onResize()});_textWidth=_data.getNumber("Width")||50;let textWidthield=_data.getField("Width");textWidthield&&textWidthield.onChange(val=>{_textWidth=val,onResize()})}(),_this.delayedCall(_=>{onResize()},100),function addHandlers(){_this.onResize(onResize)}()}(),_this.animateIn=function(){_shader.tween("uOpacity",1,2e3,"inOut"),_shaderText.tween("uOpacity",1,2e3,"inOut")},_this.animateOut=function(){_shader.tween("uOpacity",0,2e3,"inOut"),_shaderText.tween("uOpacity",0,2e3,"inOut")},_this.show=function(){_shader.set("uOpacity",1),_shaderText.set("uOpacity",1),_this.group.visible=!0},_this.hide=function(){_this.group.visible=!1}})),Class((function IntroWindow(_input,_group){Inherit(this,Object3D);const _this=this;var _shader,_mesh,_layout,_layers,_camera,_scene,_wildcard=_input.get("wildcard"),_animation={value:0},_blank=(new Vector2,Utils3D.getTexture("assets/images/_scenelayout/mask.jpg"));function onResize(){if(_scene&&_this.flag("showing")){let baseSize=.33*Stage.height,width=Math._round(baseSize*_this.group.scale.x),height=Math._round(baseSize*_this.group.scale.y);_scene.setSize(width,height);const aspect=width/height;_camera.camera.aspect=aspect,_camera.camera.updateProjectionMatrix()}}function loop(){_mesh.rotation.y=.2*-_this.group.position.x,_shader.set("uAspect",Math.round(_this.group.scale.x/_this.group.scale.y,5)),_scene&&_this.flag("isVisible")&&_this.flag("showing")&&_scene.render()}!async function(){_this.constructorName=Utils.getConstructorName(_this),await function initShader(){_shader=_this.initClass(Shader,"IntroWindow",{unique:_input.prefix,uAlpha:{value:0,ignoreUIL:!0},uBorderColor:{value:new Color("#000000")},uBorderWidth:{value:.01},uAspect:{value:1,ignoreUIL:!0},uFogFar:{value:20,ignoreUIL:!0},uFogNear:{value:10,ignoreUIL:!0},tScene:{value:_blank,ignoreUIL:!0},transparent:!0}),ShaderUIL.add(_shader,_group).setLabel("Shader"),_this.shader=_shader}(),await function initMesh(){_mesh=new Mesh(World.PLANE,_shader),_this.add(_mesh)}(),_wildcard&&await async function createScene(){(_scene=new FXScene).create(World.NUKE,RTPool.instance(null,9).nullRT);let loaded=await Initializer3D.queue();_layout=_this.initClass(SceneLayout,"IntroWindowLayer_"+_wildcard),await Initializer3D.uploadAllDistributed(_layout),loaded(),_layers=await _layout.getAllLayers(),_scene.scene.add(_layout.group),_layers.camera?_camera=_layers.camera:(_camera=CameraHelpers.getDefaultCamera()).lookAt.z=3;_scene.useCamera(_camera)}(),function addHandlers(){_this.onResize(onResize)}(),_this.startRender(loop)}(),_this.onVisible=function(){_this.flag("isVisible",!0)},_this.onInvisible=function(){_this.flag("isVisible",!1)},_this.animateIn=async function(){_this.flag("showing",!0),_animation.value=1,_scene&&(_scene.useRT(RTPool.instance().getRT()),_shader.set("tScene",_scene),onResize()),await tween(_animation,{value:0},2e3,"inOut",0).onUpdate(_=>{let direction=_this.group.position.x>0?-1:1,value=_animation.value*direction;_shader.uniforms.uAlpha.value=1-_animation.value,_this.group.rotation.y=.3*Math.PI*value,_mesh.position.x=-.3*value})},_this.animateOut=async function(){await tween(_animation,{value:1},2e3,"inOut").onUpdate(_=>{let direction=_this.group.position.x>0?-1:1,value=_animation.value*direction;_this.flag("showing",!1),_shader.uniforms.uAlpha.value=1-_animation.value,_this.group.rotation.y=.3*Math.PI*value,_mesh.position.x=.5*-value}).onComplete(_=>{_scene&&(_scene.rt&&_scene.rt.dispose&&_scene.rt.dispose(),_scene.useRT(RTPool.instance().nullRT))})}})),Class((function IntroWindowLayer(_name=Utils.query("name")){Inherit(this,Object3D);const _this=this;var _layers;!async function(){_this.layout=_this.initClass(SceneLayout,"IntroWindowLayer_"+_name),_layers=await _this.layout.getAllLayers(),await _this.wait(500),(_layers.camera||CameraHelpers.getDefaultCamera()).lock()}()})),Class((function Level(){Inherit(this,FXScene);const _this=this;var _envCamera,_levelCamera,_levelScene,_success,_prize,_config,_bossZoom=1,_debugZoom=1,_movementZoom=1,_previewZoom=1,_timeScale=1,_renderMult=Render.createTimeMultiplier(),_constructorName=Utils.getConstructorName(_this),_transforms=[];function loop(){!function applyTransforms(){_transforms.forEach(t=>t.update())}(),function positionCamera(){_envCamera.group.position.copy(_this.camera.position).divideScalar(_this.config.getNumber("orthoToPerspective")),_levelCamera.group.position.copy(_this.camera.position),_levelCamera.group.position.z=_envCamera.group.position.z,_levelCamera.group.position.x+=Stage.width/2,_levelCamera.group.position.y-=Stage.height/2}(),function applyZoom(){let scale=1500/Stage.height*(1/_bossZoom)*(1/_movementZoom)*(1/_debugZoom)*(1/_previewZoom);Config.PROD||(Utils.query("realPixels")&&(scale=1),Utils.query("scale")&&(scale=Utils.query("scale")));_levelCamera.width=Stage.width*scale,_levelCamera.height=Stage.height*scale,_levelCamera.camera.setViewport(_levelCamera.width,_levelCamera.height)}(),function render(){_this.flag("preventRender")||_levelScene.render()}()}function onReset({died:died}){died&&!Global.PLAYGROUND&&ViewController.instance().effect("GlitchEffect")}async function onChange({view:view}){await _this.wait("player"),_this.player&&(await _this.player.ready(),_this.player.input.hide()),view===Utils.getConstructorName(_this)&&(_this.flag("preventRender",!1),_this.events.fire(Level.PREVIEW,{level:_this}),Utils.query("noSTrack")||_this.events.fire(AudioController.PLAY,{name:"track"+_constructorName,type:"track"}))}async function onStart(){await _this.ready(),await _this.player.ready(),_this.ui.animateIn(),_this.player.input.show();let{route:route,name:name}=Config.TRACK_LEVEL[_constructorName];Track.page(`/level/${route}/game`,`Level ${name} Game`),Track.event(Level.CURRENT,"start")}async function onEnd({success:success}){let zoom={value:1};tween(zoom,{value:.5},9e3,"linear").onUpdate(_=>_movementZoom=zoom.value).onComplete(_=>{_movementZoom=1}),await defer(),await _this.player.ready(),_this.player.input.hide(),_success=success;let data=await function getData(success){return{level:_constructorName.slice(),coins:_this.player.inventory.items.coins,time:_this.ui.time,success:success,prize:_prize}}(_success);_success&&ViewController.instance().letterbox(!1,1e3),_this.events.fire(Level.COMPLETE,data),_this.ui.animateOut(),_success?(_this.ending.animateIn(2500),_this.events.fire(AudioController.PLAY,{name:"levelSuccess"}),await _this.wait(3e3),ViewController.instance().effect("GlitchEffect",{level:10,ramp:200,duration:8e3}),await _this.wait(4e3)):(_this.events.fire(AudioController.PLAY,{name:"levelFail"}),_this.timeout.animateIn(),await _this.wait(3e3)),tween(zoom,{value:3},1500,"easeInOutQuad").onUpdate(_=>_movementZoom=zoom.value).onComplete(_=>{_movementZoom=1}),await _this.wait(200),await ViewController.instance().circle(!0),Global.PLAYGROUND?_this.events.fire(Level.RESET):ViewController.instance().transition("CompleteView",data),await _this.wait(500),ViewController.instance().circle(!1),_this.ending.animateOut(),_this.timeout.animateOut(),_this.events.fire(AudioController.PAUSE,{name:"track"+_constructorName,type:"track"})}async function createLayer(name,group){let mesh=await _this.layouts.level.getLayer(name);mesh.transform=new LevelTransform(mesh.group||mesh);let input=InputUIL.create(_constructorName+"l"+name+"_transform",group);input.setLabel("Transform"),input.addVector("position",[0,0]),input.addNumber("width",100),input.addNumber("height",100),input.addVector("scale",[1,1]),input.addNumber("rotation",0),input.addNumber("z",0),input.onUpdate=_=>{let position=input.get("position"),scale=input.get("scale");mesh.transform.x=position[0],mesh.transform.y=position[1],mesh.transform.z=input.getNumber("z"),mesh.transform.width=input.getNumber("width"),mesh.transform.height=input.getNumber("height"),mesh.transform.scale.x=scale[0],mesh.transform.scale.y=scale[1],mesh.transform.rotation=input.getNumber("rotation")},input.onUpdate(),_transforms.push(mesh.transform)}this.camera=new Group,async function(){Level.CURRENT=Config.TRACK_LEVEL[_constructorName].type,Level.PLAYING=_constructorName,_config=Levels.instance().getItemById(_constructorName),Dev.expose("level",_this),function addHandlers(){_this.events.sub(ViewController.CHANGE,onChange),_this.events.sub(Level.RESET,onReset),_this.events.sub(Level.END,onEnd),_this.events.sub(Level.START,onStart)}(),function initCamera(){_this.camera.position.z=6,_this.camera.prefix=_constructorName+"camera",MeshUIL.add(_this.camera).setLabel("Camera")}(),function initRender(){_this.create(),_this.startRender(_=>{_this.flag("preventRender")||_this.render()})}(),function initLevelCamera(){_envCamera=_this.initClass(BaseCamera),_this.config=InputUIL.create("levelconfig"),_this.config.setLabel("Config"),_this.config.add("orthoToPerspective",250),(_levelScene=_this.initClass(FXScene,World.NUKE,{format:Texture.RGBAFormat})).clearAlpha=0,(_levelCamera=_this.initClass(BaseCamera)).useOrthographic(Stage.width,Stage.height),_this.startRender(loop,_this.nuke),Utils.query("orbit")||(_this.useCamera(_envCamera),_levelScene.useCamera(_levelCamera))}(),await async function initLayouts(){_this.layouts={},await async function initLayoutEnvironment(){let loaded=await Initializer3D.queue();_this.layouts.environment=_this.initClass(SceneLayout,_constructorName+"environment"),await Initializer3D.uploadAllDistributed(_this.layouts.environment),loaded(),_this.layouts.environment.layers=await _this.layouts.environment.getAllLayers(),_this.scene.add(_this.layouts.environment.group)}(),await async function initLayoutLevel(){await LightGeometries.instance().ready();let loaded=await Initializer3D.queue();_this.layouts.level=_this.initClass(SceneLayout,_constructorName+"level"),_this.layouts.level.onCreateLayer=createLayer,_levelScene.scene.add(_this.layouts.level.group),_this.layouts.level.camera=_levelCamera,await Initializer3D.uploadAllDistributed(_this.layouts.level),loaded();let levelLayout=await _this.layouts.level.getLayer("layout");if(await levelLayout.ready(),Tests.enableLightingEffects()){_this.initClass(LevelLights,_constructorName,_levelScene,_levelCamera,levelLayout,_envCamera)}let levelLayer=(await _this.layouts.environment.getAllLayers()).level;levelLayer.shader.addUniforms({tMap:{value:_levelScene},depthWrite:!1,transparent:!0}),levelLayer.frustumCulled=!1}()}(),await async function initGameElements(){let layers=await _this.layouts.level.getAllLayers();_this.player=layers.player,_this.hazards=_this.initClass(Hazards,layers.player,layers.layout),_this.coins=_this.initClass(Coins,layers.player,layers.layout,_levelCamera.group),_this.enemies=_this.initClass(Enemies,layers.player,layers.layout,layers.explosion),_this.doors=_this.initClass(Doors,layers.player,layers.layout),_this.pets=_this.initClass(Pets,layers.player,_this.doors,layers,layers.layout),_this.breakable=_this.initClass(Breakable,layers.player,layers.layout),_this.boss=_this.initClass(Boss,layers.player,layers,_this),_this.gate=_this.initClass(Gate,layers.player,layers),_this.hacks=_this.initClass(Hacks),_this.ui=_this.initClass(LevelView,_this.player,!0,_config),_this.ending=_this.initClass(UIEnding,Data.COPY.eaten),_this.timeout=_this.initClass(UIBounceTitle,"TIME RAN OUT")}(),await async function fetchPrize(){_prize=await Api.playInstantWin()}(),function initVFX(){let bloom=_this.initClass(FX.UnrealBloom,_this.nuke,{enabled:Tests.renderBloom(),nMips:3},_constructorName),composite=_this.initClass(NukePass,"Composite",Utils.mergeObject({unique:_constructorName,tCloud:{value:Fog.instance(),ignoreUIL:!0},uCloudStrength:{value:1},uRGBStrength:{value:.1}},bloom.uniforms));_this.nuke.add(composite),ShaderUIL.add(composite),bloom.dpr=Tests.bloomDPR(),Tests.antialiasing()&&_this.nuke.add(new FXAA);let fogConfig=InputUIL.create(_constructorName+"_fog");fogConfig.setLabel("Fog"),fogConfig.addVector("size",[200,-50]);let fog=_this.initClass(Fog,{size:fogConfig.get("size")});_levelScene.scene.add(fog.group),_this.bloom=bloom}(),_this.flag("isReady",!0),_this.flag("preventRender",!0),_this.isPlayground()&&(_this.flag("preventRender",!1),_this.visible=!0,_this.events.fire(Level.PREVIEW,{level:_this}))}(),this.onDestroy=function(){_this.bloom.visible=!1},this.ready=_=>_this.wait("isReady"),this.get("name",_=>_constructorName),this.get("bossZoom",_=>_bossZoom),this.set("bossZoom",v=>_bossZoom=v),this.get("movementZoom",_=>_movementZoom),this.set("movementZoom",v=>_movementZoom=v),this.get("debugZoom",_=>_debugZoom),this.set("debugZoom",v=>_debugZoom=v),this.get("previewZoom",_=>_previewZoom),this.set("previewZoom",v=>_previewZoom=v),this.get("timeScale",_=>_timeScale),this.set("timeScale",v=>{_timeScale=v,_renderMult.value=v}),this.showDOM=function(){},this.hideDOM=function(){},this.showGLUI=function(){},this.hideGLUI=function(){_this.ui.animateOut()},this.enableRT=function(){},this.disableRT=function(){_this.ui.animateOut()},this.animateIn=function(){},this.animateOut=function(){}}),_=>{Level.PLAYING="",Level.CURRENT="",Level.COMPLETE="level_complete",Level.PREVIEW="level_preview",Level.START="level_start",Level.RESET="level_reset",Level.END="level_end"}),Class((function LevelLayout(_input,_group){Inherit(this,Object3D);const _this=this,BOUNDS=["hazards","platforms","barriers","coins","enemies","breakable","gate","doors"];require("LevelAnimations");var _mesh,TILE_SCALE=100,_playerPos=new Vector3,_v3=new Vector3,_shaders=[];function getXYFromIndex(index,width,height){let y=Math.floor(index/width);return{x:index-width*y,y:y}}function initShader(texture,normal,animation,playerLight){texture.minFilter=texture.magFilter=Texture.NEAREST,normal.minFilter=normal.magFilter=Texture.NEAREST,animation.minFitler=animation.magFilter=Texture.NEAREST;let shader=_this.initClass(Shader,"LevelLayout",{tMap:{value:texture,ignoreUIL:!0},tNormal:{value:normal,ignoreUIL:!0},tAnimation:{value:animation,ignoreUIL:!0},tLightsColor:{value:null,ignoreUIL:!0},tLightsPosition:{value:null,ignoreUIL:!0},uNoiseScale:{value:.1},uNoiseSpeed:{value:-.3},uPlayerPos:{value:new Vector3,ignoreUIL:!0},uUnderglowColor:{value:new Color("#ffffff")},uPlayerLightColor:{value:new Color("#ffffff"),ignoreUIL:!0},uPlayerLightRange:{value:2},uPlayerLightBrightness:{value:.333},depthWrite:!0,transparent:!0});return shader.UILPrefix=_input.name+"_levellayout_shader",ShaderUIL.add(shader,_group).setLabel("Shader"),_shaders.push(shader),shader}function loop(){_v3.copy(_this.parent.layers.player.position).multiplyScalar(.01),_playerPos.copy(_v3);for(let shader of _shaders)shader.set("uPlayerPos",_playerPos)}function onPlayerLight({color:color}){for(let shader of _shaders)shader.set("uPlayerLightColor",color)}!function initBounds(){for(let region of BOUNDS)_this[region]=[]}(),async function initData(){let input=InputUIL.create(_input.name+"_levellayout",_group);input.setLabel("Level Layout"),input.add("tileset_config"),input.add("level_config"),input.addImage("tileset_texture"),input.addImage("tileset_normal"),input.addImage("tileset_animation");let[tilesSrc,levelSrc,textureSrc,normalSrc,animationSrc]=[Assets.getPath(input.get("tileset_config")),Assets.getPath(input.get("level_config")),Assets.getPath(input.getImage("tileset_texture")),Assets.getPath(input.getImage("tileset_normal")),Assets.getPath(input.getImage("tileset_animation")||"assets/images/_scenelayout/uv.jpg")];if(!(tilesSrc&&levelSrc&&textureSrc&&normalSrc&&animationSrc))return;let[tiles,level,texture,normal,animation]=await Promise.all([get(tilesSrc),get(levelSrc),Utils3D.getTexture(textureSrc),Utils3D.getTexture(normalSrc),Utils3D.getTexture(animationSrc)]);await _this.wait("transform"),TILE_SCALE=_this.transform.width*_this.transform.scale,async function buildLevel(tiles,level,texture,normal,animation){await async function buildLevelGeom(tiles,level,texture,normal,animation){(new Date).getTime();let debug=Utils.query("layerDebug");Config.PROD&&(debug=!1);let batchVariable=_this.initClass(MeshBatch),batchStatic=_this.initClass(MeshBatch),batchForeground=_this.initClass(MeshBatch);batchStatic.static=!0,batchForeground.static=!0;let batchDebug=!!debug&&new MeshBatch;_this.add(batchVariable),_this.add(batchStatic),_this.add(batchForeground),batchDebug&&_this.add(batchDebug);let lowest,tileLayers,i=0,z=0,geom=World.PLANE,shaderVariable=initShader(texture,normal,animation,!0),shaderStatic=initShader(texture,normal,animation,!0),shaderForeground=initShader(texture,normal,animation,!1);[tiles,tileLayers]=function sortLayers(tiles,level){tiles.columns=tiles.imagewidth/tiles.tilewidth,tiles.rows=tiles.imageheight/tiles.tileheight;let tileLayers=level.layers.filter(l=>"tilelayer"===l.type);for(let layer of tileLayers){layer.tiles={};for(let[i,tile]of layer.data.entries())0!==tile&&(layer.tiles[i]=tile-1)}return[tiles,tileLayers]}(tiles,level);let spriteScale=new Vector2(tiles.tilewidth/tiles.imagewidth,tiles.tileheight/tiles.imageheight);for(let layer of tileLayers){let name=layer.name.includes(["collision","floor","wall","barrier"])?"barriers":layer.name,collides=name.includes(BOUNDS),visible=!name.includes(["barriers","platforms","enemies","gate","hazard"]),isStatic=!name.includes(["coin","breakable","gate","animate","door"]),bounces=(name.includes(["animate"]),name.includes(["coin"])),isDebug=!!debug&&name.includes([debug]),needsMesh=!!debug||!name.includes(["barriers","hazards","enemies","gate"]);debug&&"collision"===debug&&collides&&(isDebug=!0);for(let index in layer.tiles){let pos=getXYFromIndex(index,level.width,level.height),spritePos=getXYFromIndex(layer.tiles[index],tiles.columns,tiles.rows);spritePos.y+=1;let mesh,meshX=1*pos.x-_this.transform.x/TILE_SCALE,meshY=1*-pos.y+_this.transform.y/TILE_SCALE,meshZ=name.includes(["foreground","breakable"])?-1e-5:z-tileLayers.length-2;if(needsMesh){let spriteCoord=new Vector2(spritePos.x/tiles.columns,1-spritePos.y/tiles.rows),opacity=layer.opacity*(visible?1:0),excludeGradient=name.includes(["coin"])?0:1,shader=isDebug?Utils3D.getTestShader():"foreground"===name?shaderForeground:isStatic?shaderStatic:shaderVariable,random=new Vector4(4).fromArray(new Array(4).fill(Math.random()));mesh=new Mesh(geom,shader),mesh.batchNeedsUpdate=!1,mesh.attributes={index:index,spriteCoord:spriteCoord,spriteScale:spriteScale,opacity:opacity,excludeGradient:excludeGradient,bounces:bounces,random:random},mesh.position.x=meshX,mesh.position.y=meshY,mesh.position.z=meshZ,mesh.scale.setScalar(1.01),isDebug?batchDebug.add(mesh):"foreground"===name?batchForeground.add(mesh):isStatic?batchStatic.add(mesh):batchVariable.add(mesh)}else mesh={position:{x:meshX,y:meshY,z:meshZ},scale:{x:1.01,y:1.01,z:1.01}};collides&&_this[name].push({index:i,mesh:mesh,x:pos.x*TILE_SCALE,y:pos.y*TILE_SCALE,tiled:pos,width:TILE_SCALE,height:TILE_SCALE,spritePos:spritePos}),lowest=lowest?Math.max(lowest,pos.y*TILE_SCALE):pos.y*TILE_SCALE,i++}z++}batchStatic.frustumCulled=!1,batchVariable.frustumCulled=!1,batchForeground.frustumCulled=!1,batchForeground.renderOrder=9999,batchDebug&&(batchDebug.frustumCulled=!1),_this.parent.add(_this.group),_this.flag("lowest",lowest),await Promise.all([batchStatic.ready(),batchVariable.ready(),batchForeground.ready()]),batchDebug&&await batchDebug.ready(),(_mesh=batchStatic.mesh||batchVariable.mesh).level=level}(tiles,level,texture,normal,animation),_this.startRender(loop),function sortBounds(){for(let region of BOUNDS)_this[region]=_this[region].sort((a,b)=>a.x-b.x)}(),function addHandlers(){_this.events.sub(LevelLayout.PLAYER_LIGHT,onPlayerLight)}(),_this.flag("isReady",!0)}(tiles,level,texture,normal,animation)}(),Dev.expose("levelLayout",_this),_this.get("mesh",_=>_mesh),this.ready=_=>_this.wait("isReady"),this.lowestPoint=function(){return _this.flag("lowest")||0}}),_=>{LevelLayout.PLAYER_LIGHT="level_layout_player_light"});class LevelTransform{constructor(mesh){this.x=0,this.y=0,this.z=0,this.width=100,this.height=100,this.scaleX=1,this.scaleY=1,this.scale=1,this.rotation=0,this.mesh=mesh,this.mesh.onBeforeRender=this.update.bind(this)}update(){let mesh=this.mesh;mesh.position.x=this.x,mesh.position.y=-this.y,mesh.position.z=this.z/1e4||0,mesh.scale.x=this.width*this.scaleX*this.scale,mesh.scale.y=this.height*this.scaleY*this.scale,mesh.rotation.z=Math.radians(this.rotation)}intersects(transform){let aMinX=this.x-this.width/2,aMinY=this.y-this.height/2,aMaxX=this.x+this.width/2,aMaxY=this.y+this.height/2,bMinX=transform.x-transform.width/2,bMinY=transform.y-transform.height/2,bMaxX=transform.x+transform.width/2,bMaxY=transform.y+transform.height/2;return!(bMaxX<aMinX||bMinX>aMaxX||bMaxY<aMinY||bMinY>aMaxY)}linkOnBeforeRender(mesh){mesh.onBeforeRender=this.update.bind(this)}}Class((function LevelLight(_data){Inherit(this,Object3D);const _this=this;var _mesh,_shader,_geometry,_feedback,_overlay;!async function(){!function initGeometry(){_geometry=LightGeometries.instance().getGeometry(_data.shape)}(),function initShader(){_shader=_this.initClass(Shader,"LevelLightShader",{uColor:{value:new Color(_data.color)},uRadius:{value:_data.radius},uStrength:{value:_data.strength},depthTest:!1,depthWrite:!1,transparent:!0})}(),function initMesh(){let positionVector=(new Vector3).fromArray(_data.position),scaleVector=(new Vector3).fromArray(_data.scale);(_mesh=new Mesh(_geometry,_shader)).renderOrder=99999,_mesh.attributes={color:new Color(_data.color),pos:positionVector,radius:parseFloat(_data.radius),scale:scaleVector,strength:parseFloat(_data.strength)},_mesh.position.copy(positionVector),_mesh.position.y*=-1,_mesh.scale.copy(scaleVector),(_feedback=_mesh.clone()).position.z+=.01}(),function initOverlay(){_overlay=_this.initClass(LevelLightOverlay,_data)}(),_this.flag("isReady",!0)}(),_this.get("data",_=>_data),_this.get("feedback",_=>_feedback),_this.get("mesh",_=>_mesh),_this.get("overlay",_=>_overlay),_this.edit=function(data){_data=data;let{color:color,radius:radius,position:position,scale:scale,shape:shape,strength:strength}=data,positionVector=(new Vector3).fromArray(position),scaleVector=(new Vector3).fromArray(scale);_shader.set("uColor",new Color(color)),_shader.set("uRadius",radius),_shader.set("uStrength",strength),_mesh.attributes={color:new Color(color),pos:positionVector,radius:parseFloat(radius),scale:scaleVector,strength:parseFloat(strength)},_mesh.geometry=LightGeometries.instance().getGeometry(shape),_mesh.position.copy(positionVector),_mesh.position.y*=-1,_mesh.scale.copy(scaleVector),_feedback.geometry=LightGeometries.instance().getGeometry(shape),_feedback.position.copy(positionVector),_feedback.position.y*=-1,_feedback.scale.copy(scaleVector),_overlay.edit(data)},_this.ready=function(){return _this.wait("isReady")}})),Class((function LevelLightOverlay(_data){Inherit(this,Object3D);const _this=this;var _mesh,_shader,_feedback;!async function(){!function initShader(){(_shader=_this.initClass(Shader,"LevelLightOverlayShader",{uAlpha:{value:parseFloat(_data.overlayAlpha),batchUnique:!0},uColor:{value:new Color(_data.overlayColor),batchUnique:!0},uRadius:{value:parseFloat(_data.overlayRadius),batchUnique:!0},uEffectFlicker:{value:parseFloat(_data.effectFlicker),batchUnique:!0},uEffectRainbow:{value:parseFloat(_data.effectRainbow),batchUnique:!0},uDesktop:{value:Device.mobile?0:1},depthTest:!1,depthWrite:!1,transparent:!0})).blending=Shader.ADDITIVE_BLENDING}(),function initMesh(){if(!_data.overlayPosition)return;let positionVector=(new Vector3).fromArray(_data.position);positionVector.x+=_data.overlayPosition[0],positionVector.y+=_data.overlayPosition[1],positionVector.z+=_data.overlayPosition[2];let scaleVector=(new Vector3).fromArray(_data.overlayScale);(_mesh=new Mesh(World.PLANE_LIGHT,_shader)).renderOrder=99999,_mesh.position.copy(positionVector),_mesh.position.y*=-1,_mesh.scale.copy(scaleVector),(_feedback=_mesh.clone()).position.z+=.01}(),_this.flag("isReady",!0)}(),_this.get("data",_=>_data),_this.get("feedback",_=>_feedback),_this.get("mesh",_=>_mesh),_this.edit=function(data){_data=data;let{position:position,overlayAlpha:overlayAlpha,overlayColor:overlayColor,overlayPosition:overlayPosition,overlayRadius:overlayRadius,overlayScale:overlayScale,effectFlicker:effectFlicker,effectRainbow:effectRainbow}=data,positionVector=(new Vector3).fromArray(position);positionVector.x+=overlayPosition[0],positionVector.y+=overlayPosition[1],positionVector.z+=overlayPosition[2];let scaleVector=(new Vector3).fromArray(overlayScale);_shader.set("uAlpha",parseFloat(overlayAlpha)),_shader.set("uColor",new Color(overlayColor)),_shader.set("uRadius",parseFloat(overlayRadius)),_shader.set("uEffectFlicker",parseFloat(effectFlicker)),_shader.set("uEffectRainbow",parseFloat(effectRainbow)),_mesh.geometry=World.PLANE_LIGHT,_mesh.position.copy(positionVector),_mesh.position.y*=-1,_mesh.scale.copy(scaleVector),_feedback.geometry=World.PLANE_LIGHT,_feedback.position.copy(positionVector),_feedback.position.y*=-1,_feedback.scale.copy(scaleVector)},_this.ready=function(){return _this.wait("isReady")}})),Class((function LevelLights(_name,_scene,_camera,_layout,_envCamera){Inherit(this,Component);const _this=this;var _fx,_editor,_merge,_mergeShader,_overlay,_overlayMesh,_config=InputUIL.create("lights_"+_name,null),_data=_config.get("data")||[],_lights=[];function handleEditor({isVisible:isVisible}){}!async function(){!Config.PROD&&Utils.query("editLight")?(console.log("Lights Data",_data),await async function initEditor(){_editor=_this.initClass(LevelLightsEditor,_config,_name,_scene,_camera,_layout,_envCamera),_lights=_editor.lights}()):await function initLights(){_data.forEach(data=>{let light=_this.initClass(LevelLight,data);_lights.push(light)})}(),await function initFX(){_fx=_this.initClass(LevelLightsFX,_camera)}(),await function initMerge(){_merge=new MeshMerge(!1),_mergeShader=_this.initClass(Shader,"LevelLightsShader",{depthTest:!1,depthWrite:!1}),_lights.forEach(light=>{light.mesh.shader=_mergeShader,_merge.add(light.mesh)}),_merge.onMeshCreated=mesh=>{mesh.frustumCulled=!1,_fx.addMesh(mesh),_layout.mesh.shader.uniforms.tLightsColor.value=_fx,_layout.mesh.shader.uniforms.tLightsPosition.value=FX.Position.instance()}}(),await function initOverlay(){_overlay=new MeshBatch,_lights.forEach(async light=>{await light.overlay.ready(),light.overlay.mesh&&_overlay.add(light.overlay.mesh)}),_overlay.onMeshCreated=mesh=>{(_overlayMesh=mesh).frustumCulled=!1,_overlayMesh.renderOrder=99999,_layout.add(_overlayMesh)}}(),function addHandlers(){_this.events.sub(LevelLightsEditor.TOGGLE,handleEditor)}()}()})),Class((function LevelLightsEditor(_config,_name,_scene,_camera,_layout,_envCamera){Inherit(this,Component);const _this=this;var _uil,_uilHover,_lightSelected,_lightHovered,_plane,_feedback,_data=_config.get("data")||[],_elementsVisible=!0,_lights=[],_lightsMeshes=[];function handleUILHover(e){switch(e.action){case"over":_this.flag("isUIL",!0);break;case"out":_this.flag("isUIL",!1)}}function handleKeyDown(e){if(!_this.flag("isUIL"))switch(e.code){case"Delete":!function deleteLight(){if(!_lightSelected)return;_layout.remove(_lightSelected.feedback),_layout.remove(_lightSelected.overlay.feedback),_lights.remove(_lightSelected),_lightsMeshes.remove(_lightSelected.feedback),Interaction3D.find(_camera).remove(_lightSelected.feedback),onUpdate()}();break;case"KeyT":toggleLights()}}function handlePlaneClick(e){_this.flag("isUIL")||_lightHovered||createLight(_this.editor,e.hit.point)}function handleLightHover(e){switch(e.action){case"over":_lightHovered=e.mesh;break;case"out":_lightHovered=null}}function handleLightClick(e){editLight(_lightsMeshes.indexOf(e.mesh))}function createLight(data,point){point&&(data.position[0]=point.x/100,data.position[1]=point.y/100*-1,data.position[2]=point.z/100);let light=_this.initClass(LevelLight,data);_lights.push(light),_lightsMeshes.push(light.feedback),_layout.add(light.feedback),_layout.add(light.overlay.feedback),point&&(_lightSelected=light,editLight(_lightsMeshes.length-1)),Interaction3D.find(_camera).add(light.feedback,handleLightHover,handleLightClick),onUpdate()}function editLight(index){_lightSelected=_lights[index],_uil.onUpdate=_=>{},_lightSelected&&(_uil.setValue("color",_lightSelected.data.color),_uil.setValue("position",_lightSelected.data.position),_uil.setValue("radius",_lightSelected.data.radius),_uil.setValue("scale",_lightSelected.data.scale),_uil.setValue("shape",_lightSelected.data.shape),_uil.setValue("strength",_lightSelected.data.strength),_uil.setValue("effectFlicker",_lightSelected.data.effectFlicker),_uil.setValue("effectRainbow",_lightSelected.data.effectRainbow),_uil.setValue("overlayAlpha",_lightSelected.data.overlayAlpha),_uil.setValue("overlayColor",_lightSelected.data.overlayColor),_uil.setValue("overlayPosition",_lightSelected.data.overlayPosition),_uil.setValue("overlayRadius",_lightSelected.data.overlayRadius),_uil.setValue("overlayScale",_lightSelected.data.overlayScale)),_uil.onUpdate=_=>{onUILUpdate(),onUpdate()},onUpdate()}function onUILUpdate(){_lightSelected&&_lightSelected.edit(_this.editor)}function onUpdate(){_data=_lights.map(light=>(light.data.effectFlicker||(light.data.effectFlicker=0),light.data.effectRainbow||(light.data.effectRainbow=0),light.data)),_config.setValue("data",JSON.stringify(_data))}function toggleLights(){_elementsVisible=!_elementsVisible,_lights.forEach(light=>{light.feedback.visible=_elementsVisible}),_plane.visible=_elementsVisible,_feedback.visible=_elementsVisible,_this.events.fire(LevelLightsEditor.TOGGLE,{isVisible:_elementsVisible})}function loop(){if(_lightSelected){let position=_lightSelected.feedback.position.clone();position.y+=5,_feedback.position.lerp(position,.1)}}!async function(){!function initUIL(){(_uil=InputUIL.create(`lights_${_name}_editor`)).setLabel("Light"),_uil.addColor("color"),_uil.addVector("position",[0,0,0]),_uil.addNumber("radius",1),_uil.addVector("scale",[1,1,1]),_uil.addNumber("shape",0),_uil.addNumber("strength",1),_uil.addNumber("effectFlicker",0),_uil.addNumber("effectRainbow",0),_uil.addNumber("overlayAlpha",1),_uil.addColor("overlayColor"),_uil.addVector("overlayPosition",[0,0,0]),_uil.addNumber("overlayRadius",1),_uil.addVector("overlayScale",[1,1,1]),_uil.onUpdate=_=>{onUILUpdate(),onUpdate()}}(),function initPlane(){let geometry=World.PLANE,shader=_this.initClass(Shader,"LightsBackground",{depthTest:!1,depthWrite:!1,transparent:!0});(_plane=new Mesh(geometry,shader)).position.x=_layout.mesh.level.width/2,_plane.position.y=-_layout.mesh.level.height/2,_plane.scale.x=_layout.mesh.level.width,_plane.scale.y=_layout.mesh.level.height,_plane.renderOrder=1,_layout.add(_plane)}(),function initFeedback(){let geometry=World.SPHERE,shader=_this.initClass(Shader,"LightsFeedback");_feedback=new Mesh(geometry,shader),_layout.add(_feedback)}(),function initUILHover(){(_uilHover=$gl(308,495,"#ff00ff")).renderOrder=2,_uilHover.interact(handleUILHover),GLUI.Stage.add(_uilHover)}(),_data.forEach(data=>{createLight(data)}),function addHandlers(){_this.events.sub(Keyboard.DOWN,handleKeyDown),Interaction3D.find(_camera).add(_plane,null,handlePlaneClick)}(),toggleLights(),_this.startRender(loop)}(),_this.get("editor",_=>({color:_uil.get("color"),position:_uil.get("position"),radius:_uil.get("radius"),scale:_uil.get("scale"),shape:_uil.get("shape"),strength:_uil.get("strength"),effectFlicker:_uil.get("effectFlicker"),effectRainbow:_uil.get("effectRainbow"),overlayAlpha:_uil.get("overlayAlpha"),overlayColor:_uil.get("overlayColor"),overlayPosition:_uil.get("overlayPosition"),overlayRadius:_uil.get("overlayRadius"),overlayScale:_uil.get("overlayScale")})),_this.get("lights",_=>_lights)}),_=>{LevelLightsEditor.TOGGLE="LevelLightsEditor.TOGGLE"}),Class((function LevelLightsFX(_camera){Inherit(this,FXScene);const _this=this;_this.create(World.NUKE,{type:Texture.FLOAT,multiRenderTarget:!0}),_this.useCamera(_camera),_this.setDPR(Tests.lightingDPR()),FX.Position.instance(_this.nuke),Utils.query("editLight")&&function initDebug(){if(!Utils.query("editLightDebug"))return;let width=.25*Stage.width,height=Stage.height/Stage.width*width,debugBackground=$gl(width,height,"#000000"),debug=$gl(width,height,_this.rt);debugBackground.x=Stage.width-width,debugBackground.y=Stage.height-height,debug.x=Stage.width-width,debug.y=Stage.height-height,GLUI.Stage.add(debug),GLUI.Stage.add(debugBackground)}(),_this.startRender(_=>_this.render(),World.NUKE),_this.addMesh=function(mesh){mesh.position.multiplyScalar(100),mesh.scale.multiplyScalar(100),_this.scene.add(mesh),FX.Position.instance().add(mesh)}})),Class((function LightGeometries(){Inherit(this,Object3D);const _this=this;var _constructorName=Utils.getConstructorName(_this),_lights=[];!async function(){let loaded=await Initializer3D.queue();for(layer in _this.layout=_this.initClass(SceneLayout,_constructorName),await Initializer3D.uploadAllDistributed(_this.layout),loaded(),_this.layers=await _this.layout.getAllLayers(),_this.layers){let light=_this.layers[layer];_lights.push(light)}"LightGeometries"===Global.PLAYGROUND&&World.SCENE.add(_this.layout.group),_this.flag("isReady",!0)}(),_this.getGeometry=function(index){return _lights[index].geometry.clone()},_this.ready=_=>_this.wait("isReady")}),"singleton"),FX.Class((function Position(_nuke){Inherit(this,FXLayer);const _this=this;_this.create(_nuke,{type:Texture.FLOAT}),_this.setDPR(Tests.lightingDPR()),_this.startRender(_=>_this.render())}),"singleton"),Class((function NPC(_mesh,_shader,_group,_input){Inherit(this,Object3D);const _this=this,CONFIG=_input.get("wildcard")&&0!==_input.get("wildcard").length?require(_input.get("wildcard")):{};var _player,_behavior,_animation;function loop(){if(_behavior(_mesh,_player),_this.dialog){let distance=_player.position.distanceTo(_mesh.position);distance<=200&&(clearTimeout(_this.outTimer),_this.outTimer=!1,_this.flag("speaking")||(_animation&&_animation.play("idle",8),_this.flag("speaking",!0),_this.dialog.start())),distance>500&&_this.flag("speaking")&&!_this.outTimer&&(_this.outTimer=_this.delayedCall(_=>{_animation&&_animation.play("speech",8),_this.flag("speaking",!1),_this.dialog.stop()},5e3))}}function onComplete(){_this.flag("speaking",!1),_this.dialog.stop()}function onViewChange(e){e.view!=Utils.getConstructorName(_this.parent.parent)&&(_this.stopRender(loop),onComplete())}!async function(){_this.flag("speaking",!1),_player=await _this.parent.getLayer("player"),function initDialog(){if(!CONFIG.dialog)return;let name=CONFIG.name,dialog=CONFIG.dialog,camera=_this.parent.camera;_this.dialog=_this.initClass(NPCDialog,name,dialog,camera,_mesh,_player)}(),function initBehavior(){_behavior=CONFIG.behavior?CONFIG.behavior:_=>{}}(),function initAnimation(){if(!CONFIG.animation)return;_animation=_this.initClass(SpriteAnimation,_mesh,CONFIG.animation,_input,_group)}(),function addHandlers(){_this.events.sub(ViewController.CHANGE,onViewChange),_this.dialog&&_this.events.sub(_this.dialog,Events.COMPLETE,onComplete)}(),await _this.wait(100),_this.startRender(loop)}()})),Class((function NPCDialog(_name,_dialog,_camera,_npc,_player){Inherit(this,Object3D);const _this=this;var _index,_messages,_view,_position=new Vector3;async function render(dialog){try{await step(async function setDialog(dialog){let message="function"==typeof dialog.message?dialog.message(_player):dialog.message;message&&await _view.message(message);dialog.end&&!dialog.response&&(dialog.response="Goodbye");dialog.response||(dialog.response="...")}(dialog)),await step(_this.wait(500)),await step(async function readyToContinue(){let index=_index,promise=Promise.create(),progress=_=>{if(_this.events.unsub(_view,Events.PROGRESS,progress),_index!==index)throw"dialog bailed";promise.resolve()};return _this.events.sub(_view,Events.PROGRESS,progress),promise}()),function endMessage(){_index++;let next=_messages[_index];_view.clear(!next),next?render(next):hide()}()}catch(e){"dialog bailed"!==e&&console.error(e)}}async function step(action){let id=_this.flag("id");if(!_this.flag("active"))throw"dialog bailed";if(await action,!_this.flag("active")||id!==_this.flag("id"))throw"dialog bailed"}function hide(){_view.disableInteractions(),_this.events.fire(NPCDialog.VISIBILITY,{visible:!1}),_view.element.alpha=1e-6,_view.clear(!0),_this.flag("active",!1)}function loop(){if(!_this.flag("active"))return;_position.setFromMatrixPosition(_npc.matrixWorld),_position.project(_camera.camera);let width=Stage.width/2,height=Stage.height/2;_view.element.x=_position.x*width+width,_view.element.y=-_position.y*height+height}(_view=DialogView.instance()).disableInteractions(),_this.startRender(loop),this.start=async function(){_index=0,_messages=_dialog.slice(),_this.flag("id",Utils.timestamp()),_view.enableInteractions(),function show(){_this.events.fire(NPCDialog.VISIBILITY,{visible:!0}),_view.clear(!0),_view.element.alpha=1,_this.flag("active",!0)}(),_this.flag("active")&&(Track.event(Level.CURRENT,"talk",_name),await render(_messages[_index]))},this.stop=function(){hide()}}),_=>{NPCDialog.VISIBILITY="npc_dialog_visibility"}),Class((function Pet(_mesh,_shader){Inherit(this,Component);const _this=this;var _index,_current,_target=new Vector2,_movement=new Vector2,_noise=new Vector2,_ease=(new Vector2,new Vector2(.01,1));function getTexture(src,scale){let texture=Utils3D.getTexture(src,scale);return texture.minFilter=texture.magFilter=Texture.NEAREST,texture}function loop(t){if(!_index||!_this.flag("free"))return;_this.flag("last",_current),_movement.distanceTo(_mesh.rail[_current])<100&&(_current=function findNextGroundedIndex(){let i=_current,min=0+5*_index;if(_current<min&&_mesh.rail[_current].grounded)return _current;for(;i>=min;){if(_mesh.rail[i].grounded)return _current-1;i--}return Math.max(_current-1,0)}(),_this.flag("idle",_this.flag("last")===_current));_this.flag("idle");let rate=.1+Math.range(Math.cos(.02*t+7*_index),-1,1,.25,.4),current=_mesh.rail[_current];_movement.lerp(current,rate*_ease.y);let mult=Math.range(Math.cos(30*_index),-1,1,.8,1.2);_noise.x=10*Math.cos(.01*t*mult+3*_index),_noise.y=-Math.abs(10*Math.sin(.011*t*mult+2*_index)),_target.lerp(_movement,_ease.x),_mesh.transform.x=_target.x+_noise.x*_ease.y,_mesh.transform.y=_target.y+_noise.y*_ease.y+30;let direction=_mesh.transform.x-_this.flag("lastX")>0?1:-1;_shader.set("uDirection",direction),_this.flag("lastX",_mesh.transform.x)}_this.flag("lastX",0),async function(){!function initShader(){_shader.addUniforms({tMap:{value:null,getTexture:getTexture},uIndex:{value:0,batchUnique:!0},uDirection:{value:1,batchUnique:!0},uAlpha:{value:0,batchUnique:!0},transparent:!0})}(),await _this.wait(_mesh,"transform"),_mesh.transform.scale=1e-6,_movement.copy(_mesh.transform),_this.startRender(loop)}(),_mesh.target=(prev,index)=>{prev,_index=index,_current=0},_mesh.current=_=>_current,_mesh.inc=_=>{_this.flag("free")&&(_current=Math.min(_current+1,_mesh.rail.length-1))},_mesh.free=async door=>{_mesh.transform.x=door.region.x+.5*door.region.width-.5*_mesh.transform.width,_mesh.transform.y=door.region.y,_target.copy(_mesh.transform),_movement.copy(_mesh.transform),_shader.set("uAlpha",1),_ease.x=0,_ease.y=0,await _this.wait(500),Track.event(Level.CURRENT,"release-pet",_mesh.name),_this.events.fire(AudioController.PLAY,{name:"freePet"}),tween(_mesh.transform,{scale:1.85},740,"easeOutElastic"),tween(_ease,{x:.666,y:1},500,"easeInCubic",150),_this.flag("free",!0)},_mesh.idle=_=>_this.flag("idle")})),Class((function Pets(_player,_doors,_layers,_level){Inherit(this,Component);const _this=this;var _pets=[],_last=new Vector2,_v2=new Vector2,_prev=!1,_index=2,_rail=[];function findDoor(layer){let nearest=_doors.list.sort((a,b)=>_v2.copy(a.region).distanceTo(layer.transform)-_v2.copy(b.region).distanceTo(layer.transform)).find(door=>void 0===door.onUnlock);return nearest&&(nearest.onUnlock=function(){layer.target(_prev,_index),layer.free(nearest),_prev=layer,_index+=2}),nearest}function loop(){if(_last.distanceTo(_player.movement.position)<10)return;let grounded=_player.movement.grounded,{x:x,y:y}=_player.movement.position,{scaleX:scaleX,scaleY:scaleY}=_player.transform,point={x:x,y:y,scaleX:scaleX,scaleY:scaleY,grounded:grounded};for(_last.copy(point),_rail.unshift(point);_rail.length>512;)_rail.pop();for(let pet of _pets)pet.inc()}!async function(){await _level.ready(),await _doors.ready(),await _player.ready(),function initPets(){for(let key in _layers){let layer=_layers[key];layer.shaderClass&&layer.shaderClass.constructor&&"Pet"===layer.shaderClass.constructor.name&&(layer.door=findDoor(layer),layer.rail=_rail,layer.name=key,layer.shader.set("uIndex",_pets.length),_pets.push(layer)),key.includes("pets-batch")&&(layer.frustumCulled=!1,layer.renderOrder=9999,layer.depthWrite=!1,layer.depthTest=!1)}}(),0!==_pets.length&&(_last.copy(_player.transform),_this.startRender(loop))}(),Dev.expose("freeAll",_=>{let doors=_doors.list;for(let door of doors)door.onUnlock&&door.onUnlock(),door.onUnlock=_=>!1})})),Class((function Player(_mesh,_shader,_group,_input){Inherit(this,Component);const _this=this;!async function(){await async function initScale(){await _this.wait(_mesh,"transform"),Player.WIDTH=_mesh.transform.width,Player.HEIGHT=_mesh.transform.height*Math.range(_mesh.transform.height,100,175,1,.78),Player.FEET=30}(),function initInput(){_mesh.input=_this.initClass(PlayerInput)}(),function initMovement(){_mesh.movement=_this.initClass(PlayerMovement,_mesh,_this.parent,_this.parent.parent)}(),function initAnimation(){_mesh.animation=_this.initClass(PlayerAnimation,_mesh,_mesh.movement,_this.parent.parent,_group,_input)}(),function initCollision(){_mesh.collision=_this.initClass(PlayerCollision,_mesh,_this.parent)}(),function initProjectiles(){_mesh.projectiles=_this.initClass(PlayerProjectiles,_mesh,_this.parent)}(),function initInventory(){_mesh.inventory=_this.initClass(PlayerInventory)}(),function initHealth(){_mesh.health=_this.initClass(PlayerHealth,_mesh)}(),function initHacks(){_mesh.hacks=_this.initClass(PlayerHacks,_mesh)}(),function initVFX(){_mesh.vfx=_this.initClass(PlayerVFX,_mesh)}(),_this.flag("isReady",!0),Dev.expose("player",_mesh)}(),this.get("mesh",_=>_mesh),this.get("level",_=>_this.parent.parent),_mesh.level=_this.parent.parent,this.ready=_mesh.ready=_=>_this.wait("isReady")}),_=>{Player.COLLISION="player_collision",Player.WIDTH=100,Player.HEIGHT=100,Player.FEET=10}),Class((function PlayerAnimation(_mesh,_movement,_level,_input,_group){Inherit(this,Component);const _this=this,CONFIG=require("Player");var _animation;function loop(){let rate=1,level=_this.parent.parent.parent;level&&(rate*=level.timeScale);let speed=Math.abs(_movement.velocity.x)*rate;speed<=.01*rate?_animation.play("idle",3*rate):_animation.play("walk",Math.range(speed,0,7,0,12)*rate)}async function applyColor(){let index;do{index=Math.floor(Math.random()*CONFIG.colors.length)}while(_this.flag("lastColor")===index);_this.flag("lastColor",index);let coloring=CONFIG.colors[index];_mesh.shader.set("uRealColor",0),_mesh.shader.set("uColor1",new Color(coloring[0])),_mesh.shader.set("uColor2",new Color(coloring[1])),await _level.ready(),_this.events.fire(LevelLayout.PLAYER_LIGHT,{color:new Color(coloring[0])})}function onReset(){applyColor()}!function initAnimation(){_animation=_this.initClass(SpriteAnimation,_mesh,"Player",_group,_input)}(),applyColor(),function addHandlers(){_this.events.sub(Level.RESET,onReset)}(),_this.startRender(loop)})),Class((function PlayerCollision(_player,_scene){Inherit(this,Component);const HACKS=require("Hacks"),_this=this;var _thread,_movement=_player.movement;function loop(){!function platforms(){let[width,height,feet]=[Player.WIDTH,Player.HEIGHT,Player.FEET],[position,velocity]=[_movement.position,_movement.velocity];_thread.platformsHitTest({position:position,velocity:velocity,width:width,height:height,feet:feet},onPlatformCollision)}(),function barriers(){let[width,height,feet]=[Player.WIDTH,Player.HEIGHT,Player.FEET],[position,velocity]=[_movement.position,_movement.velocity];_thread.barriersHitTest({position:position,velocity:velocity,width:width,height:height,feet:feet},onBarrierCollision)}(),function hazards(){let[width,height,feet]=[Player.WIDTH,Player.HEIGHT,Player.FEET],[position,velocity]=[_movement.position,_movement.velocity];_thread.hazardsHitTest({position:position,velocity:velocity,width:width,height:height,feet:feet},onHazardCollision)}(),function coins(){let coins=_scene.parent.coins.coins,[width,height]=[Player.WIDTH,Player.HEIGHT],[position,velocity]=[_movement.position,_movement.velocity];_thread.coinsHitTest({position:position,velocity:velocity,width:width,height:height,coins:coins},onCoinCollision)}(),function enemies(){let enemies=_scene.parent.enemies.mobs,[width,height]=[Player.WIDTH,Player.HEIGHT],[position,velocity]=[_movement.position,_movement.velocity];_thread.enemiesHitTest({position:position,velocity:velocity,width:width,height:height,enemies:enemies},onEnemyCollision)}(),function projectiles(){let projectiles=_player.projectiles.weapon.shot,enemies=_scene.parent.enemies.mobs,enemyProjectiles=_scene.parent.enemies.projectiles,[width,height]=[Player.WIDTH,Player.HEIGHT],[position]=[_movement.position];for(let projectile of projectiles)_thread.projectileHitTest({projectile:projectile,enemies:enemies},onProjectileEnemyCollision),_thread.projectileBreakableHitTest({projectile:projectile},onProjectileBreakableCollision);_thread.enemyProjectileHitTest({position:position,width:width,height:height,enemyProjectiles:enemyProjectiles},onEnemyProjectileCollision)}()}function onHack({type:type}){switch(type){case"disableEnemies":_this.flag("disableEnemies",!0,HACKS.disableEnemies.duration);break;case"invincible":_this.flag("invincible",!0,HACKS.invincible.duration)}}function onPlatformCollision({collision:collision}){_movement.flag("platform",collision)}function onBarrierCollision({pos:pos,vel:vel,grounded:grounded}){_movement.position.copy(pos),_movement.velocity.copy(vel),grounded&&(_movement.flag("grounded",grounded),_movement.flag("undroppable",!0,1e3/30))}function onHazardCollision({collision:collision}){_this.events.fire(Player.COLLISION,{hazards:collision})}function onCoinCollision({collision:collision}){_this.events.fire(Player.COLLISION,{coins:collision})}function onEnemyCollision({collision:collision}){if(!_this.flag("disableEnemies")){if(_this.flag("invincible"))for(let enemy of collision)enemy.die=!0;_this.events.fire(Player.COLLISION,{enemies:collision,type:"playerHit"})}}function onProjectileEnemyCollision({collision:collision,projectile:projectile}){_this.flag("disableEnemies")||_this.events.fire(Player.COLLISION,{projectiles:collision,projectile:projectile,type:"projectileHit"})}function onEnemyProjectileCollision({collision:collision}){_this.flag("disableEnemies")||_this.flag("invincible")||_this.events.fire(Player.COLLISION,{projectiles:collision,type:"enemyHit"})}function onProjectileBreakableCollision({collision:collision,projectile:projectile}){_this.events.fire(Player.COLLISION,{breakable:collision,projectile:projectile})}!async function(){await _scene.parent.ready(),function initThread(){_thread=_this.initClass(PlayerCollisionThread)}(),await async function getLevelLayout(){let layout=await _scene.getLayer("layout");await layout.ready();let[platforms,barriers,hazards,breakable,gate,doors]=[layout.platforms,layout.barriers,layout.hazards,layout.breakable,layout.gate,layout.doors];_thread.loadEnv({platforms:platforms,barriers:barriers,hazards:hazards,breakable:breakable,gate:gate,doors:doors})}(),function addHandlers(){_this.events.sub(Hacks.EVENT,onHack)}(),_this.startRender(loop)}(),this.unlockGate=function(){_thread.unlockGate()},this.lockGate=function(){_thread.lockGate()},this.openDoors=function(meshes){_thread.openDoors(meshes)},this.closeDoors=function(meshes){_thread.closeDoors(meshes)}})),Class((function PlayerCollisionThread(){const COLLISION_FILTER_DIST=Math.pow(250,2);var _blocks,_platforms=[],_barriers=[],_hazards=[],_breakable=[],_gate=[],_doors=[],PLAYER_WIDTH=100,PLAYER_HEIGHT=100,PLAYER_FEET=10,EMPTY_VEC={x:0,y:0},_v2=new Vector2,_vel=new Vector2,_pos=new Vector2;function detectBodyCollision(objects,player,velocity){return detectCollision(objects,player.x+velocity.x,player.y+velocity.y,player.x+velocity.x+PLAYER_WIDTH,player.y+velocity.y+PLAYER_HEIGHT)}function detectBarrierCollision(objects,player,velocity){return detectCollision(objects,player.x+velocity.x+.5*(PLAYER_WIDTH-PLAYER_FEET),player.y+velocity.y,player.x+velocity.x+PLAYER_WIDTH-.5*(PLAYER_WIDTH-PLAYER_FEET),player.y+velocity.y+PLAYER_HEIGHT)}function detectCollision(objects,aMinX,aMinY,aMaxX,aMaxY){return objects.filter(box=>{let bMinX=box.x,bMinY=box.y,bMaxX=box.x+box.width,bMaxY=box.y+box.height;return aMinX<=bMaxX&&aMaxX>=bMinX&&aMinY<=bMaxY&&aMaxY>=bMinY})}this.loadEnv=function({platforms:platforms,barriers:barriers,hazards:hazards,breakable:breakable,gate:gate,doors:doors}){_platforms=platforms,_barriers=barriers,_hazards=hazards,_breakable=breakable,_gate=gate,_doors=doors,_blocks=[..._barriers,..._breakable,..._gate]},this.platformsHitTest=function({position:position,velocity:velocity,width:width,height:height,feet:feet},callback){[PLAYER_WIDTH,PLAYER_HEIGHT,PLAYER_FEET]=[width,height,feet],callback({collision:function detectGroundCollision(objects,player,velocity){if(velocity.y<0)return 0;let hitting=detectCollision(objects,player.x+velocity.x+.5*(PLAYER_WIDTH-PLAYER_FEET),player.y+velocity.y+PLAYER_HEIGHT+PLAYER_FEET,player.x+velocity.x+PLAYER_WIDTH-.5*(PLAYER_WIDTH-PLAYER_FEET),player.y+velocity.y+PLAYER_HEIGHT),floor=0;return hitting.map(box=>floor=Math.max(floor,box.y)),floor}(_platforms.filter(platform=>_v2.copy(platform).distanceToSquared(position)<COLLISION_FILTER_DIST),position,velocity)})},this.barriersHitTest=function({position:position,velocity:velocity,width:width,height:height,feet:feet},callback){[PLAYER_WIDTH,PLAYER_HEIGHT,PLAYER_FEET]=[width,height,feet];let collision=detectBarrierCollision(_blocks.filter(block=>!block.open&&!block.broken&&_v2.copy(block).distanceToSquared(position)<COLLISION_FILTER_DIST),position,EMPTY_VEC);if(0===collision.length)return;_vel.copy(velocity),_pos.copy(position);let grounded=!1;for(let item of collision){let hit=detectBarrierCollision([item],_pos,EMPTY_VEC)[0];if(!hit)continue;let inset=.25*(width-feet),bottom=.5*Math.abs(_pos.y+height-hit.y),top=Math.abs(_pos.y-(hit.y+hit.height)),left=Math.abs(_pos.x+width-inset-hit.x),right=Math.abs(_pos.x+inset-(hit.x+hit.width));switch(Math.min(bottom,top,right,left)){case bottom:_pos.y-=bottom,_vel.y=Math.min(_vel.y,0),0===_vel.y&&(grounded=!0);break;case top:_pos.y+=top,_vel.y=Math.max(_vel.y,0);break;case left:_pos.x-=velocity.x,_vel.x=Math.min(_vel.x,0);break;case right:_pos.x-=velocity.x,_vel.x=Math.max(_vel.x,0)}}callback({pos:_pos,vel:_vel,grounded:grounded})},this.hazardsHitTest=function({position:position,velocity:velocity,width:width,height:height,feet:feet},callback){[PLAYER_WIDTH,PLAYER_HEIGHT,PLAYER_FEET]=[width,height,feet];let collision=function detectHazardCollision(objects,player,velocity){return detectCollision(objects,player.x+velocity.x,player.y+velocity.y,player.x+velocity.x+PLAYER_WIDTH,player.y+velocity.y+.5*PLAYER_HEIGHT)}(_hazards.filter(hazard=>_v2.copy(hazard).distanceToSquared(position)<COLLISION_FILTER_DIST),position,velocity);collision.length>0&&callback({collision:collision})},this.coinsHitTest=function({position:position,velocity:velocity,width:width,height:height,coins:coins},callback){[PLAYER_WIDTH,PLAYER_HEIGHT]=[width,height];let collision=detectBodyCollision(coins.filter(coin=>_v2.copy(coin).distanceToSquared(position)<COLLISION_FILTER_DIST),position,velocity);collision.length>0&&callback({collision:collision})},this.enemiesHitTest=function({position:position,velocity:velocity,width:width,height:height,enemies:enemies},callback){[PLAYER_WIDTH,PLAYER_HEIGHT]=[width,height];let collision=function detectEnemyCollision(objects,player,velocity){let offset=.125*PLAYER_WIDTH;return detectCollision(objects,player.x+velocity.x+offset,player.y+velocity.y+offset,player.x+velocity.x+PLAYER_WIDTH-2*offset,player.y+velocity.y+PLAYER_HEIGHT-2*offset)}(enemies.filter(enemy=>_v2.copy(enemy).distanceToSquared(position)<COLLISION_FILTER_DIST),position,velocity);collision=collision.filter(enemy=>!0!==enemy.die),collision=collision.map(enemy=>(enemy.die=position.y+.9*height<enemy.y+.35*height,enemy)),0!==collision.length&&callback({collision:collision})},this.projectileHitTest=function({projectile:projectile,enemies:enemies},callback){if([PLAYER_WIDTH,PLAYER_HEIGHT]=[projectile.width,projectile.height],PLAYER_HEIGHT=100,"enemy"===projectile.src)return;projectile.y+=25;let collision=detectBodyCollision(enemies,projectile,EMPTY_VEC);collision=collision.filter(enemy=>!0!==enemy.die),collision=collision.map(enemy=>(enemy.die=!0,enemy)),0!==collision.length&&callback({collision:collision,projectile:projectile})},this.enemyProjectileHitTest=function({position:position,width:width,height:height,enemyProjectiles:enemyProjectiles},callback){[PLAYER_WIDTH,PLAYER_HEIGHT]=[width,height],PLAYER_WIDTH*=.25;let collision=detectBodyCollision(enemyProjectiles,position,EMPTY_VEC);0!==collision.length&&callback({collision:collision})},this.projectileBreakableHitTest=function({projectile:projectile},callback){[PLAYER_WIDTH,PLAYER_HEIGHT]=[.1*projectile.width,.1*projectile.height];let collision=detectBodyCollision(_breakable,projectile,EMPTY_VEC);collision=collision.filter(block=>!0!==block.broken),collision=collision.map(block=>(block.broken=!0,block)),0!==collision.length&&callback({collision:collision,projectile:projectile})},this.unlockGate=function(){for(let gate of _gate)gate.open=!0},this.lockGate=function(){for(let gate of _gate)gate.open=!1},this.openDoors=function(meshes){for(let mesh of meshes)for(let door of _doors)mesh.index===door.index&&(door.open=!0)},this.closeDoors=function(meshes){for(let mesh of meshes)for(let door of _doors)mesh.index===door.index&&(door.open=!1)}})),Class((function PlayerHacks(_mesh){Inherit(this,Component);const _this=this,HACKS=require("Hacks");var _invincible=new Vector2,_jumping=new Vector2;new Vector2;function loop(time){!function setInvincible(time){let invincible=_this.flag("invincible"),warn=_this.flag("warnInvincibleDisable")&&invincible,flash=time/150%1>.5?0:1;_invincible.x=invincible?1:0,_invincible.y=warn?1*flash:0,_mesh.shader.uniforms.uInvincible&&_mesh.shader.set("uInvincible",_invincible)}(time),function setJumping(time){let jumping=_this.flag("jumping"),warn=_this.flag("warnJumpingDisable")&&jumping,flash=time/150%1>.5?0:1;_jumping.x=jumping?1:0,_jumping.y=warn?1*flash:0,_mesh.shader.uniforms.uJumping&&_mesh.shader.set("uJumping",_jumping)}(time)}function onHack({type:type}){switch(type){case"invincible":!function onInvincible(){let duration=HACKS.invincible.duration,warning=duration-1500;_this.flag("invincible",!0,duration),clearTimeout(_this.warningInvincibleTimer),_this.warningInvincibleTimer=_this.delayedCall(_=>{_this.flag("warnInvincibleDisable",!0,1500)},warning)}();break;case"jumping":!function onJumping(){let duration=HACKS.jumping.duration,warning=duration-1500;_this.flag("jumping",!0,duration),clearTimeout(_this.warningJumpingTimer),_this.warningJumpingTimer=_this.delayedCall(_=>{_this.flag("warnJumpingDisable",!0,1500)},warning)}();break;case"speedBoost":!function onSpeedBoost(){let duration=HACKS.speedBoost.duration,warning=duration-1500;_this.flag("speedBoost",!0,duration),clearTimeout(_this.warningSpeedBoostTimer),_this.warningSpeedBoostTimer=_this.delayedCall(_=>{_this.flag("warnSpeedBoostDisable",!0,1500)},warning)}()}}function onCollected({type:type}){let effect=!1;switch(type){case"random":effect=Object.keys(HACKS).random();break;case"jump":effect="jumping";break;case"speed":effect="speedBoost";break;case"invincible":effect="invincible";break;case"disable":effect="disableEnemies"}effect&&_this.events.fire(Hacks.EVENT,{type:effect})}!function addHandlers(){_this.events.sub(Hacks.EVENT,onHack),_this.events.sub(Coins.COLLECTED,onCollected)}(),_this.startRender(loop)})),Class((function PlayerHealth(_player){Inherit(this,Component);const _this=this,HACKS=require("Hacks"),Config=require("Health"),MAX_HEALTH=Config.maxHealth,INVULNERABLE_DURATION=Config.invulnerableDuration,DAMAGE_PER_HIT=Config.damagePerHit;var _health=MAX_HEALTH;function onPlayerHealthDamage({src:src,type:type}={}){_this.flag("invincible")||_this.flag("invulnerable")||(_this.flag("invulnerable",!0,INVULNERABLE_DURATION),_health-=DAMAGE_PER_HIT,_this.events.fire(PlayerHealth.UPDATE,{health:_health}),Track.event(Level.CURRENT,"hurt",src,type),1===_health&&function lowHealth(){_this.events.fire(AudioController.PLAY,{name:"lowHealth",type:"track"})}(),_health<=0?function reset(src,type){_this.events.fire(Level.RESET,{died:!0,src:src,type:type})}(src,type):function ouch(){let angle=Math.range(Math.random(),0,1,.15*-Math.PI,.15*Math.PI)-.5*Math.PI;_this.events.fire(AudioController.PLAY,{name:"hurt"});let gamepad=!!(_player.input&&_player.input.input&&_player.input.input.gamepad)&&_player.input.input.gamepad;gamepad&&!1===gamepad.playEffect&&(gamepad.playEffect={duration:250,strongMagnitude:.75});_player.movement.velocity.x=15*Math.cos(angle),_player.movement.velocity.y=15*Math.sin(angle),_player.movement.flag("tookDamage",!0,500),_this.startRender(flash,8),_this.delayedCall(_=>{_this.stopRender(flash),_player.shader.set("uAlpha",1)},INVULNERABLE_DURATION-500)}())}function onPlayerCollision({enemies:enemies,projectiles:projectiles,type:type}){if("projectileHit"===type)return;if(_this.flag("invincible"))return;if(!(projectiles||enemies&&0!==enemies.length))return;if(enemies)for(let enemy of enemies)if(!0===enemy.die)return;onPlayerHealthDamage({src:"enemy",type:enemies&&enemies[0]?enemies[0].name:"projectile"})}function onHack({type:type}){switch(type){case"invincible":_this.flag("invincible",!0,HACKS.invincible.duration)}}async function onReset({src:src,type:type,died:died}){src&&type&&Track.event(Level.CURRENT,"death",src,type),_this.events.fire(AudioController.PLAY,{name:"playerDeath"}),_this.events.fire(AudioController.PAUSE,{name:"lowHealth",type:"track"}),_player.movement.flag("tookDamage",!0,500),_health=MAX_HEALTH,await _this.wait(50);let gamepad=!!(_player.input&&_player.input.input&&_player.input.input.gamepad)&&_player.input.input.gamepad;gamepad&&(gamepad.playEffect={duration:450,strongMagnitude:1})}function onEnd(){_this.events.fire(AudioController.PAUSE,{name:"lowHealth",type:"track"})}function flash(){let alpha=_player.shader.uniforms.uAlpha.value;_player.shader.set("uAlpha",1===alpha?.15:1)}!function addHandlers(){_this.events.sub(PlayerHealth.DAMAGE,onPlayerHealthDamage),_this.events.sub(Player.COLLISION,onPlayerCollision),_this.events.sub(Level.RESET,onReset),_this.events.sub(Level.END,onEnd),_this.events.sub(Hacks.EVENT,onHack)}(),this.get("value",_=>_health)}),_=>{PlayerHealth.DAMAGE="player_health_damage",PlayerHealth.UPDATE="player_health_update"}),Class((function PlayerInput(){Inherit(this,Component);const _this=this;!function initInput(){_this.input=_this.initClass(Device.mobile?PlayerInputMobile:PlayerInputDesktop)}(),_this.show=function(){Device.mobile&&_this.input.show()},_this.hide=function(){Device.mobile&&_this.input.hide()}}),_=>{PlayerInput.DIRECTION="player_input_direction",PlayerInput.ACTION="player_input_action",PlayerInput.JUMP="player_input_jump"}),Class((function PlayerInputDesktop(){Inherit(this,Component);const _this=this,CONFIG=require("Controls").desktop;var _direction=0;function onKeyDown({keyCode:keyCode}){(CONFIG.left.includes(keyCode)||CONFIG.right.includes(keyCode))&&(CONFIG.left.includes(keyCode)&&(_direction=-1),CONFIG.right.includes(keyCode)&&(_direction=1),_this.flag("canDash")&&(_this.flag("canDash",!1),_this.flag("preventDash")||_this.events.fire(PlayerInput.ACTION,{dash:_direction}),_this.flag("preventDash",!0,500)),_this.events.fire(PlayerInput.DIRECTION,{direction:_direction})),CONFIG.jump.includes(keyCode)&&_this.events.fire(PlayerInput.JUMP,{amount:1}),CONFIG.down.includes(keyCode)&&_this.events.fire(PlayerInput.JUMP,{amount:-1}),CONFIG.action.includes(keyCode)&&_this.events.fire(PlayerInput.ACTION,{shoot:!0})}function onKeyUp({keyCode:keyCode}){(CONFIG.left.includes(keyCode)||CONFIG.right.includes(keyCode))&&(CONFIG.left.includes(keyCode)&&-1===_direction&&(_direction=0),CONFIG.right.includes(keyCode)&&1===_direction&&(_direction=0),_this.flag("preventDash")?_this.flag("canDash",!1):_this.flag("canDash",!0,100),_this.events.fire(PlayerInput.DIRECTION,{direction:_direction})),CONFIG.jump.includes(keyCode)&&_this.events.fire(PlayerInput.JUMP,{amount:0}),CONFIG.down.includes(keyCode)&&_this.events.fire(PlayerInput.JUMP,{amount:0}),CONFIG.action.includes(keyCode)&&_this.events.fire(PlayerInput.ACTION,{shoot:!1})}!function initGamepad(){_this.gamepad=_this.initClass(PlayerInputGamepad)}(),function addHandlers(){_this.events.sub(Keyboard.DOWN,onKeyDown),_this.events.sub(Keyboard.UP,onKeyUp)}()})),Class((function PlayerInputGamepad(){Inherit(this,Component);const _this=this;var _controls=_this.parent;function loop(){if(null===PlayerInputGamepad.INPUT)return;let gamepad=navigator.getGamepads()[PlayerInputGamepad.INPUT];gamepad&&gamepad.axes&&(!function applyMotion(gamepad){let x=gamepad.axes[0],y=gamepad.axes[1];Math.abs(x)<.2&&(x=0);Math.abs(y)<.2&&(y=0);_controls.events.fire(PlayerInput.DIRECTION,{direction:x}),y>.75?(_this.flag("dropping",!0),_controls.events.fire(PlayerInput.JUMP,{amount:-y})):_this.flag("dropping",!1)}(gamepad),function applyLook(gamepad){let x=gamepad.axes[2],y=gamepad.axes[3];Math.abs(x)<.075&&(x*=0);Math.abs(y)<.075&&(y*=0);_this.offset.x=Math.lerp(x,_this.offset.x,.125),_this.offset.y=Math.lerp(-y,_this.offset.y,.125)}(gamepad),function applyShoot(gamepad){let shoot=gamepad.buttons[7].pressed;_this.events.fire(PlayerInput.ACTION,{shoot:shoot})}(gamepad),function applyJump(gamepad){if(_this.flag("dropping"))return;let amount=gamepad.buttons[0].pressed?1:0;_this.events.fire(PlayerInput.JUMP,{amount:amount})}(gamepad),function applyRumble(gamepad){if(!gamepad.vibrationActuator)return;if(!_this.playEffect)return;try{let effect=Object.assign({},_this.playEffect);_this.playEffect=!1,gamepad.vibrationActuator.playEffect("dual-rumble",effect)}catch(e){}}(gamepad))}_this.playEffect=!1,_this.startRender(loop),this.offset=new Vector3}),_=>{PlayerInputGamepad.INPUT=null,Hydra.ready().then(_=>{__window.bind("gamepadconnected",(function onGamepadConnection(e){PlayerInputGamepad.INPUT=e.gamepad.index})),__window.bind("gamepaddisconnected",(function onGamepadDisconnection(){PlayerInputGamepad.INPUT=null}))})}),Class((function PlayerInputMobile(){Inherit(this,Component);const _this=this,CONFIG=require("Controls").mobile,SENSITIVITY=CONFIG.sensitivity,DEAD_ZONE=CONFIG.deadZone,JUMP="a"===CONFIG.jump?"jump-button":"action-button",ACTION="b"===CONFIG.action?"action-button":"jump-button";var _view,_knob,_area,_jump,_shoot,_joystick=new Vector2,_lerp=new Vector2;new Vector2;function updateJoystick(e){let x=!1===e?.5:e.hit.uv.x,y=!1===e?.5:1-e.hit.uv.y,angle=Math.atan2(y-.5,x-.5),xTarget=x*_area.width,yTarget=y*_area.height,dist=Math.min(170,Math.hypot(xTarget-.5*_area.width,yTarget-.5*_area.height));_joystick.x=Math.cos(angle)*dist,_joystick.y=Math.sin(angle)*dist}function loop(){!function positionKnob(){_lerp.lerp(_joystick,.25),_knob.x=_lerp.x+_area.x+.5*(_area.width-_knob.width),_knob.y=_lerp.y+_area.y+.5*(_area.height-_knob.height)}(),function applyDirection(){let direction=Math.range(_joystick.x*SENSITIVITY,-170,170,-1,1,!0);Math.abs(direction)<DEAD_ZONE&&(direction=0);_this.events.fire(PlayerInput.DIRECTION,{direction:direction})}(),function applyDrop(){Math.range(_joystick.y,-170,170,-1,1)>.75?(_this.flag("dropping",!0),_this.events.fire(PlayerInput.JUMP,{amount:-1})):_this.flag("dropping")&&(_this.flag("dropping",!1),_this.events.fire(PlayerInput.JUMP,{amount:0}))}()}function onReset(){_this.events.fire(PlayerInput.ACTION,{shoot:!1}),_this.events.fire(PlayerInput.JUMP,{amount:0}),_this.flag("movingJoystick",!1),updateJoystick(!1)}function onStart(e){switch(e.hit.object.name){case ACTION:_shoot.tween({alpha:1},100,"easeOutSine"),_this.events.fire(PlayerInput.ACTION,{shoot:!0});break;case JUMP:_jump.tween({alpha:1},100,"easeOutSine"),_this.events.fire(PlayerInput.JUMP,{amount:1});break;case"joystick-area":_area.tween({alpha:.4},300,"easeOutSine"),_knob.tween({alpha:1},100,"easeOutSine"),_this.flag("movingJoystick",!0),updateJoystick(e)}}function onMove(e){switch(e.hit.object.name){case"joystick-area":updateJoystick(e)}}function onEnd(e){switch(e.hit.object.name){case ACTION:_shoot.tween({alpha:.5},300,"easeOutSine"),_this.events.fire(PlayerInput.ACTION,{shoot:!1});break;case JUMP:_jump.tween({alpha:.5},300,"easeOutSine"),_this.events.fire(PlayerInput.JUMP,{amount:0});break;case"joystick-area":_area.tween({alpha:.2},300,"easeOutSine"),_knob.tween({alpha:.7},300,"easeOutSine"),_this.flag("movingJoystick",!1),updateJoystick(!1)}}!async function(){await async function initView(){_view=_this.initClass(PlayerInputMobileView),await _view.ready()}(),function getLayers(){(_area=_view.layers["joystick-area"]).alpha=.2,(_knob=_view.layers["joystick-knob"]).alpha=.7,(_jump=_view.layers["jump-button"]).alpha=.5,(_shoot=_view.layers["action-button"]).alpha=.5,updateJoystick(!1)}(),function addHandlers(){_this.events.sub(Level.RESET,onReset),_this.events.sub(PlayerInputMobile.START,onStart),_this.events.sub(PlayerInputMobile.MOVE,onMove),_this.events.sub(PlayerInputMobile.END,onEnd)}(),_this.startRender(loop)}(),_this.show=function(){_view.show()},_this.hide=function(){_view.hide()}}),_=>{PlayerInputMobile.START="player_input_mobile_start",PlayerInputMobile.MOVE="player_input_mobile_move",PlayerInputMobile.END="player_input_mobile_end"}),Class((function PlayerInputMobileView(){Inherit(this,GLUIElement);const _this=this;var $this,_ray,_interaction=[];function resize(){let scale=function getScale(){return 1920/1080<Stage.width/Stage.height?Stage.height/1080:Stage.width/1920}();$this.x=.5*(Stage.width-1920*scale),$this.y=.5*(Stage.height-1080*scale),$this.scale=scale;let moveX=Math.range(Stage.width/Stage.height,1.7,3,0,400);for(var i in _this.layers){let layer=_this.layers[i];i.includes(["background"])||(layer.saveX||(layer.saveX=layer.x),layer.x=layer.saveX+moveX*(layer.saveX<960?-1:1))}}function onStart(e){if(_this.flag("dialogVisible"))return;if(!e.touches)return;let hits=[];for(let touch of e.touches)hits.push(..._ray.checkHit(_interaction,{x:touch.screenX,y:touch.screenY},Stage));if(0!==hits.length)for(let item of _interaction)for(let hit of hits)hit.object.id===item.id&&(item.isTouching||(item.isTouching=!0,item.touch=hit,_this.events.fire(PlayerInputMobile.START,{hit:hit})))}function onMove(e){if(_this.flag("dialogVisible"))return;if(!e.touches)return;e.preventDefault();let hits=[];for(let touch of e.touches)hits.push(..._ray.checkHit(_interaction,{x:touch.screenX,y:touch.screenY},Stage));if(0!==hits.length)for(let item of _interaction)for(let hit of hits)hit.object.id===item.id&&(item.touch=hit,item.isTouching?_this.events.fire(PlayerInputMobile.MOVE,{hit:hit}):(item.isTouching=!0,_this.events.fire(PlayerInputMobile.START,{hit:hit})))}function onEnd(e){let hits=[];for(let touch of e.touches)hits.push(..._ray.checkHit(_interaction,{x:touch.screenX,y:touch.screenY},Stage));for(let item of _interaction){if(!item.isTouching)continue;let touching=!1;for(let hit of hits)hit.object.id===item.id&&(touching=!0);touching||(item.isTouching=!1,_this.events.fire(PlayerInputMobile.END,{hit:item.touch}))}}!async function(){!function initGL(){($this=_this.element).alpha=Global.PLAYGROUND?1:0,GLUI.Stage.add($this)}(),await async function initLayout(){_this.layout=_this.initClass(StageLayout,"player_mobile_input",{glui:!0}),_this.layers=await _this.layout.getAllLayers(),$this.add(_this.layout.element)}(),function applyStyles(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","area"])&&(layer.mesh.isTouching=!1,layer.mesh.name=id,_interaction.push(layer.mesh))}}(),function addHandlers(){(_ray=new Raycaster(GLUI.Stage.camera)).testVisibility=!1,Stage.bind("touchstart",onStart),Stage.bind("touchmove",onMove),Stage.bind("touchend",onEnd),_this.onResize(resize)}(),_this.flag("isReady",!0)}(),this.show=function(){$this.tween({alpha:1},400,"easeOutCubic")},this.hide=function(){$this.tween({alpha:0},400,"easeOutCubic")},this.ready=_=>_this.wait("isReady"),this.onDestroy=function(){Stage.unbind("touchstart",onStart),Stage.unbind("touchmove",onMove),Stage.unbind("touchend",onEnd)}})),Class((function PlayerInventory(){Inherit(this,Component);var _items={coins:0,keys:0,items:0};this.get("items",_=>_items),this.add=function(key="coins",number=1){return void 0===_items[key]&&(_items[key]=0),_items[key]+=number,_items[key]},this.remove=function(key="coins",number=1){return!(void 0===_items[key]||_items[key]-number<0)&&(_items[key]-=number,number)}})),Class((function PlayerMovement(_mesh,_scene,_level){Inherit(this,Component);const _this=this,HACKS=require("Hacks"),CONFIG=require("Movement"),MAX_PLAYER_SPEED=CONFIG.maxSpeed,MAX_PLAYER_JUMP=CONFIG.maxJump,PLAYER_ACCELERATION=CONFIG.acceleration;var _reset=new Vector2,_movement=new Vector2,_velocity=new Vector2,_position=new Vector2,_stretch=new Vector2(1,0);function loop(){_this.flag("locked")||(!function applyStretch(){let last=_this.flag("last")||0,horizontal=_this.flag("hitEnemy")||_this.flag("grounded")||_this.flag("hitBounce"),delta=Math.abs(_velocity.y-last)*(horizontal?1:-1),dist=1-_stretch.x,vel=Math.clamp(.005*delta,-.2,.2);_stretch.y+=vel,_stretch.y+=(dist>0?1:-1)*Math.range(Math.abs(dist),0,1,0,.2),_stretch.x+=_stretch.y,_stretch.y*=.65,_mesh.transform.scaleX=_stretch.x/1,_mesh.transform.scaleY=1/_stretch.x,_this.flag("last",_velocity.y)}(),function applyJumping(){_this.flag("grounded")&&function resetJump(){clearTimeout(_this.jumpTimer),clearTimeout(_this.doubleJumpTimer),_this.jumpTimer=!1,_this.doubleJumpTimer=!1,_this.flag("canJump",!0),_this.flag("canDoubleJump",!1),_this.flag("canDash",!0)}();_movement.y>=0&&_this.flag("canDrop",!0);_movement.y>0&&_this.flag("canJump")&&function performSingleJump(){applyJumpVelocity(),!1===_this.jumpTimer&&(_this.events.fire(AudioController.PLAY,{name:"jump"}),Track.event(Level.CURRENT,"jump"),_this.jumpTimer=_this.delayedCall(_=>{_this.flag("canJump",!1)},1/_level.timeScale*175))}();0!==_movement.y||_this.flag("grounded")||!1!==_this.doubleJumpTimer||resetDoubleJump();_velocity.y>0&&_this.flag("multiJump")&&!_this.flag("canDoubleJump")&&resetDoubleJump();_movement.y>0&&_this.flag("canDoubleJump")&&function performDoubleJump(){applyJumpVelocity(),!1===_this.doubleJumpTimer&&(_this.events.fire(AudioController.PLAY,{name:"jump"}),Track.event(Level.CURRENT,"jump"),_this.doubleJumpTimer=_this.delayedCall(_=>{_this.flag("canDoubleJump",!1)},1/_level.timeScale*175))}()}(),function applyMovement(){if(_this.flag("tookDamage"))return;let acceleration=0===_movement.x?_this.flag("grounded")?.2:.035:.25;acceleration*=!_this.flag("grounded")&&Math.abs(_movement.x)<.1?.45:1,acceleration*=PLAYER_ACCELERATION*_level.timeScale*Render.HZ_MULTIPLIER;let speed=_movement.x*MAX_PLAYER_SPEED*_level.timeScale;_mesh.shader.uniforms.uDirection&&(_movement.x>0&&_mesh.shader.set("uDirection",1),_movement.x<0&&_mesh.shader.set("uDirection",-1));_this.flag("speedBoost")&&(speed*=HACKS.speedBoost.amount);_velocity.x=Math.lerp(speed,_velocity.x,acceleration),_this.flag("hasLanded")!==_this.flag("grounded")&&(_this.flag("hasLanded",_this.flag("grounded")),_this.flag("hasLanded")&&_this.events.fire(AudioController.PLAY,{name:"land"}))}(),function applyLanding(){_velocity.y<0&&_this.flag("powerDrop",!1);if(_this.flag("tookDamage"))return _this.flag("powerDrop",!1);if(!_this.flag("grounded")||!_this.flag("powerDrop"))return;_this.events.fire(CameraFollow.SHAKE,{amount:66,delay:100}),_this.flag("powerDrop",!1)}(),function applyGroundRumble(){_this.flag("grounded")||_this.flag("groundRumble",!0);if(!_this.flag("grounded")||!_this.flag("groundRumble"))return;_this.flag("groundRumble",!1);let gamepad=!!(_mesh.input&&_mesh.input.input&&_mesh.input.input.gamepad)&&_mesh.input.input.gamepad;gamepad&&!1===gamepad.playEffect&&(gamepad.playEffect={duration:100,strongMagnitude:.1})}(),function applyGravity(){_velocity.y+=CONFIG.gravity*_level.timeScale*Render.HZ_MULTIPLIER,function handlePlatforms(){_this.flag("onGround",!1),!!_this.flag("platform")&&_position.y<=_this.flag("platform")&&_velocity.y>0&&!_this.flag("dropping")&&(_this.flag("grounded",!0),_velocity.y=0,_position.y=_this.flag("platform")-Player.HEIGHT);_this.flag("grounded")&&_this.flag("onGround",!0);0!==_velocity.y&&_this.flag("grounded",!1)}()}(),function applyDrop(){if(_this.flag("tookDamage"))return;if(_this.flag("preventDrop"))return;if(!_this.flag("canDrop"))return;if(_movement.y>=0||_this.flag("dropping"))return;if(_this.flag("canDrop",!1),_this.flag("grounded"))return _this.flag("dropping",!0,1/_level.timeScale*200);if(_this.flag("undroppable"))return;_this.flag("preventDrop",!0,1/_level.timeScale*200),_this.flag("powerDrop",!0),_velocity.y=CONFIG.powerDropSpeed*_level.timeScale,_velocity.x*=CONFIG.powerDropXMultiplier*_level.timeScale}(),function applyPosition(){_position.x+=_velocity.x*Render.HZ_MULTIPLIER,_position.y+=_velocity.y*Render.HZ_MULTIPLIER,_mesh.transform.x=Math.lerp(_position.x,_mesh.transform.x,.5*_level.timeScale),_mesh.transform.y=Math.lerp(_position.y,_mesh.transform.y,.5*_level.timeScale),_mesh.transform.x+=Math.range(_mesh.transform.scaleX,1,0,0,.125*_mesh.transform.width),_mesh.transform.y+=Math.range(_mesh.transform.scaleY,1,0,0,.5*_mesh.transform.height),_mesh.velocity.copy(_velocity),_mesh.transform.z=-1e4}(),function applyOutOfBounds(){if(_position.y<_this.flag("lowest"))return;_this.events.fire(Level.RESET,{died:!0,src:"fall",type:"fall"})}())}function resetDoubleJump(){_this.flag("canDoubleJump",!0),clearTimeout(_this.doubleJumpTimer),_this.doubleJumpTimer=!1}function applyJumpVelocity(){_this.flag("tookDamage")||(_velocity.y=-_movement.y*MAX_PLAYER_JUMP*_level.timeScale)}function onDirection({direction:direction}){_movement.x=direction}function onJump({amount:amount}){_movement.y=amount}function onAction(e){}function onReset(){_this.respawn&&_this.respawn(_reset),_position.copy(_reset),_velocity.set(0,0)}function onHack({type:type}){switch(type){case"speedBoost":_this.flag("speedBoost",!0,HACKS.speedBoost.duration);break;case"jumping":_this.flag("multiJump",!0,HACKS.jumping.duration)}}_this.flag("floor",0),_this.flag("canDrop",!0),_this.flag("locked",!0),_this.flag("groundRumble",!1),async function(){!function addHandlers(){Utils.query("debugCamera")||(_this.events.sub(PlayerInput.DIRECTION,onDirection),_this.events.sub(PlayerInput.ACTION,onAction),_this.events.sub(PlayerInput.JUMP,onJump));_this.events.sub(Level.RESET,onReset),_this.events.sub(Hacks.EVENT,onHack)}(),_mesh.velocity=new Vector2,await _scene.parent.ready(),await _this.wait(_mesh,"transform"),await async function getLevelLayout(){let layout=await _scene.getLayer("layout");await layout.ready(),_this.flag("lowest",layout.lowestPoint()+200)}(),function initPosition(){_position.x=_mesh.transform.x,_position.y=_mesh.transform.y,_reset.copy(_position)}(),_this.startRender(loop),Dev.expose("movement",_this)}(),this.get("position",_=>_position),this.get("velocity",_=>_velocity),this.get("movement",_=>_movement),this.get("grounded",_=>_this.flag("onGround")),this.resetToStart=function(){_position.copy(_reset),_velocity.set(0,0)}})),Class((function PlayerProjectiles(_player,_scene){Inherit(this,Component);const _this=this;var _index=0,_projectiles=[];function onDirection({direction:direction}){0!==direction&&(_this.weapon.direction=direction>0?1:-1)}function onAction(e){void 0!==e.shoot&&_this.weapon.shoot(e.shoot),void 0!==e.weapon&&_this.weapon.select(e.weapon)}!function initProjectiles(){let batch=new MeshBatch,geom=World.PLANE,texture=Utils3D.getTexture("assets/images/player/bullets.png"),enemyTexture=Utils3D.getTexture("assets/images/player/enemy-bullet.png");texture.minFilter=texture.magFilter=Texture.NEAREST,enemyTexture.minFilter=enemyTexture.magFilter=Texture.NEAREST;let shader=_this.initClass(Shader,"PlayerProjectiles",{tSprite:{value:texture},tEnemySprite:{value:enemyTexture},uSpriteWidth:{value:4},blending:Shader.ADDITIVE_BLENDING,transparent:!0,depthWrite:!1,depthTest:!1});for(;_projectiles.length<64;){let projectile=new Mesh(geom,shader);projectile.batchNeedsUpdate=!1,projectile.attributes={color:new Color,sprite:_projectiles.length%4,enemyShot:0},projectile.renderOrder=999999,_projectiles.push(projectile),batch.add(projectile)}_scene.add(batch),batch.ready().then(_=>{batch.renderOrder=999999,batch.frustumCulled=!1})}(),function initWeapon(){_this.weapon=_this.initClass(PlayerWeapon,_player),_this.weapon.direction=1,_this.weapon.select()}(),function addHandlers(){_this.events.sub(PlayerInput.DIRECTION,onDirection),_this.events.sub(PlayerInput.ACTION,onAction)}(),this.get("mesh",_=>{}),this.getProjectiles=function(amount=1){let projectiles=[];for(;projectiles.length<amount;)projectiles.push(_projectiles[_index]),_index=(_index+1)%64;return projectiles}})),Class((function PlayerWeapon(_player){Inherit(this,Component);const _this=this,WEAPONS=require("Weapons");function fire(){if(!1===_this.flag("firingState"))return _this.stopRender(fire);_this.flag("preventFire",!0,1e3/_this.rate);let meshes=_this.parent.getProjectiles(_this.perShot);for(let mesh of meshes)_this.fire(mesh);_this.events.fire(CameraFollow.SHAKE,{amount:_this.shake}),_this.events.fire(AudioController.PLAY,{name:"shoot"}),_player.movement.velocity.x+=_this.shake*-_this.direction*.25,Track.event(Level.CURRENT,"shoot")}function loop(time,delta){let i=_this.shot.length-1;for(;i>=0;){let projectile=_this.shot[i],scale=100;_this.update(projectile),projectile.x=projectile.mesh.position.x,projectile.y=-projectile.mesh.position.y,projectile.width=_this.size*scale,projectile.height=_this.size*scale,projectile.life-=delta,projectile.life<=0&&(_this.reset(projectile),_this.shot.splice(i,1)),i--}}function defaultMovement(projectile,position){position.x+=projectile.speed*projectile.direction*.01*Render.HZ_MULTIPLIER}function onCollision({projectile:projectile}){if(!projectile)return;_this.shot.find(p=>p.id===projectile.id).life=0}_this.style="#dddddd",_this.perShot=1,_this.rate=3,_this.speed=30,_this.size=.25,_this.direction=1,_this.life=2e3,_this.shake=15,_this.shot=[],function addHandlers(){_this.events.sub(Player.COLLISION,onCollision)}(),_this.startRender(loop),this.reset=function(projectile){projectile.mesh.position.set(0,1e3,0),defer(_=>projectile.mesh.batchNeedsUpdate=!1)},this.update=function(projectile){projectile.update(projectile,projectile.mesh.position)},this.fire=function(mesh){let position=_this.findParent("Player").mesh.position;mesh.position.set(position.x+.5*_this.direction,position.y,0),mesh.scale.setScalar(.5*_this.size*1e3),mesh.attributes.enemyShot=0,mesh.batchNeedsUpdate=!0,_this.shot.push({mesh:mesh,life:_this.life,direction:_this.direction,speed:_this.speed,update:_this.flag("weapon").update||defaultMovement,random:Math.random(),src:"player"})},this.shoot=function(state){_this.flag("firingState",state),state&&!_this.flag("preventFire")&&_this.startRender(fire,_this.rate)},this.select=function(index=0){let weapon=WEAPONS[index];for(let key in weapon)"update"!==key&&(_this[key]=weapon[key]);_this.flag("weapon",weapon)}})),Class((function PlayerShader(_mesh,_shader){Inherit(this,Component);_shader.addUniforms({tMap:{value:Utils3D.getTexture("assets/images/_scenelayout/uv.jpg")},uInvincible:{value:new Vector2},uJumping:{value:new Vector2},uSpeedBoost:{value:new Vector2},uAlpha:{value:1},uDirection:{value:1},transparent:!0})})),Class((function PlayerVFX(_player){Inherit(this,Object3D);const _this=this;_this.flag("bufferTotal",0),_this.flag("bufferIndex",0);!async function(){await async function initVFX(){_this.disable=_this.initClass(PlayerVFXDisable,_player),_this.invincible=_this.initClass(PlayerVFXInvincible,_player),_this.jumping=_this.initClass(PlayerVFXJumping,_player),_this.speed=_this.initClass(PlayerVFXSpeed,_player),_this.flag("isReady",!0)}(),function initScene(){_this.group.scale.copy(_player.scale),_player._parent.add(_this.group),_this.startRender(_=>{_this.group.position.copy(_player.position)})}()}(),this.ready=_=>_this.wait("isReady")})),Class((function PlayerVFXClass(){Inherit(this,Component);const _this=this;_this.planes=[],_this.initBuffer=async function(n=0,shader,attributes={}){if(n<=0||_this.batch)return;let batch=new MeshBatch,geom=World.PLANE;for(;_this.planes.length<n;){let mesh=new Mesh(geom,shader);mesh.attributes=Object.assign({},attributes),_this.planes.push(mesh),batch.add(mesh)}batch.renderOrder=9999999,_this.parent.add(batch),_this.batch=batch}})),Class((function PlayerVFXDisable(_player){Inherit(this,PlayerVFXClass);const _this=this,HACKS=require("Hacks");var _target,_shader;async function onHack({type:type}){if("disableEnemies"!==type)return;_this.batch.visible=!0,await defer(),_this.flag("active",!0),_shader.tween("uAlpha",1,300,"easeOutCubic"),_target.setScalar(2);for(let plane of _this.planes)tween(plane.scale,_target,300,"easeOutCubic");let duration=HACKS.disableEnemies.duration,warning=duration-1500;clearTimeout(_this.warningTimer),_this.warningTimer=_this.delayedCall(_=>{_target.setScalar(1e-5);for(let plane of _this.planes)tween(plane.scale,_target,500,"easeOutCubic",1e3);_shader.tween("uAlpha",0,500,"easeInCubic",1e3).onComplete(_=>{_this.batch.visible=!1})},warning)}!function initShader(){_shader=_this.initClass(Shader,"PlayerVFXDisable",{uColor:{value:new Color("#e415dd")},uAlpha:{value:0},blending:Shader.ADDITIVE_BLENDING,depthTest:!1,depthWrite:!1,transparent:!0})}(),_this.initBuffer(1,_shader),function initPlanes(){_target=(new Vector3).setScalar(1e-5);for(let plane of _this.planes)plane.scale.setScalar(1e-5);_this.batch.visible=!1}(),function addHandlers(){_this.events.sub(Hacks.EVENT,onHack)}()})),Class((function PlayerVFXInvincible(_player){Inherit(this,PlayerVFXClass);const _this=this;!async function(){await _this.initBuffer(0)}()})),Class((function PlayerVFXJumping(_player){Inherit(this,PlayerVFXClass);const _this=this,HACKS=require("Hacks");var _shader,_target;function loop(t){if(!_this.flag("active"))return;let shift=1===_player.shader.get("uDirection")?-.2:.2;for(let[i,plane]of _this.planes.entries()){let spacing=.5,mult=i/2===Math.floor(i/2)?-1:1,angle=-.0025*t+i/32*2*Math.PI,distance=.5+.1*Math.cos(i/32*50+.004*t),offset=mult*spacing+shift,x=offset,y=.25;x+=Math.cos(angle)*distance*mult,y+=Math.sin(angle)*distance*1.75,plane.position.x=x,plane.position.y=y;let alpha=Math.range(y,-.15,.35,1,0,!0);alpha*=Math.range(Math.abs(x),0,Math.abs(offset),1,0,!0),plane.attributes.opacity=alpha}}async function onHack({type:type}){if("jumping"!==type)return;_this.batch.visible=!0,await defer(),_this.flag("active",!0),_shader.tween("uAlpha",1,300,"easeOutCubic"),_target.setScalar(.1);for(let plane of _this.planes)tween(plane.scale,_target,300,"easeOutCubic");let duration=HACKS.jumping.duration,warning=duration-1500;clearTimeout(_this.warningTimer),_this.warningTimer=_this.delayedCall(_=>{_target.setScalar(1e-5);for(let plane of _this.planes)tween(plane.scale,_target,1500,"easeOutCubic");_shader.tween("uAlpha",0,1500,"easeOutCubic"),_this.delayedCall(_=>{_this.batch.visible=!1,_this.flag("active",!1)},1500)},warning)}!async function(){!function initShader(){let texture=Utils3D.getTexture("assets/images/player/up.png");texture.minFilter=texture.magFilter=Texture.NEAREST,_shader=_this.initClass(Shader,"PlayerVFXJumping",{tMap:{value:texture},uAlpha:{value:1},blending:Shader.ADDITIVE_BLENDING,depthTest:!1,depthWrite:!1,transparent:!0})}(),await _this.initBuffer(32,_shader,{opacity:1}),function initPlanes(){for(let plane of _this.planes)plane.scale.setScalar(1e-6);_this.batch.visible=!1,_target=new Vector3}(),function addHandlers(){_this.events.sub(Hacks.EVENT,onHack)}(),_this.startRender(loop)}()})),Class((function PlayerVFXSpeed(_player){Inherit(this,PlayerVFXClass);const _this=this,HACKS=require("Hacks");var _p1,_p2,_shader;function loop(){_p2.lerp(_p1,.5),_p1.lerp(_player.position,.5),_this.flag("active")&&(_this.planes[0].position.set(0,0,0).sub(_player.position).add(_p1).multiplyScalar(.01),_this.planes[1].position.set(0,0,0).sub(_player.position).add(_p2).multiplyScalar(.01),function copyUniforms(){let exclude=["uAlpha","transparent","tMap"];for(let key in _player.shader.uniforms)exclude.includes(key)||_shader.set(key,_player.shader.get(key))}())}async function onHack({type:type}){if("speedBoost"!==type)return;_this.batch.visible=!0,await _this.wait(50),_this.flag("active",!0),_shader.tween("uAlpha",.25,300,"easeOutCubic");let duration=HACKS.speedBoost.duration,warning=duration-1500;clearTimeout(_this.warningSpeedBoostTimer),_this.warningSpeedBoostTimer=_this.delayedCall(_=>{_shader.tween("uAlpha",0,1500,"easeOutCubic").onComplete(_=>{_this.flag("active",!1),_this.batch.visible=!1})},warning)}!function initShader(){(_shader=_player.shader.clone()).set("uAlpha",0),_shader.depthTest=!1,_shader.depthWrite=!1}(),function initVectors(){_p1=new Vector3,_p2=new Vector3,_p1.copy(_player.position),_p2.copy(_player.position)}(),_this.initBuffer(2,_shader),_this.startRender(loop),_this.batch.visible=!1,function addHandlers(){_this.events.sub(Hacks.EVENT,onHack)}()})),Class((function Playground(){Inherit(this,Component);const _this=this;let _view;!async function(){await UILStorage.ready(),Global.PLAYGROUND=Utils.query("p"),function initThree(){World.instance(),Stage.add(World.ELEMENT)}(),function initView(){let request=Global.PLAYGROUND.split("/")[0],view=window["Playground"+request]||window[request]||null;if(!view)throw`No Playground class ${request} found.`;_view=view.instance?view.instance():_this.initClass(view),_view.element&&Stage.add(_view.element);if(_view.rt&&_view.scene&&_view.nuke)if(request.includes("Figma")){let dimensions=_view.dimensions,$obj=$gl(dimensions[0],dimensions[1],_view.rt.texture);$obj.x=40,$obj.y=40,"portrait"===Utils.query("orientation")&&($obj.scale=.5,$obj.y=-300),GLUI.Stage.add($obj)}else{let shader=_this.initClass(Shader,"ScreenQuad",{tMap:{value:_view}}),mesh=new Mesh(World.QUAD,shader);mesh.frustumCulled=!1,World.SCENE.add(mesh)}else World.SCENE.add(_view.group||_view.mesh||_view.object3D||new Group);Dev.expose("view",_view)}(),defer(window.onresize)}()}),"singleton"),Class((function PlaygroundSprite(){Inherit(this,Object3D);const _this=this;!async function(){_this.layout=_this.initClass(SceneLayout,"SpritePlayground"+Utils.query("name")),_this.group.add(_this.layout.group),_this.layers=await _this.layout.getAllLayers()}()})),Class((function ClickSFX(){Inherit(this,Component);const _this=this;function onChange({view:view}){_this.flag("enabled",0!==view.indexOf("Level"))}function onClick(){_this.flag("enabled")}_this.flag("enabled",!0),function addHandlers(){let input=_this.initClass(Interaction,Stage);_this.events.sub(ViewController.CHANGE,onChange),_this.events.sub(input,Interaction.END,onClick)}()}),"singleton"),FX.Class((function UIBloomLayer(_nuke){Inherit(this,FXLayer);const _this=this;_this.create(_nuke),_this.startRender(_=>{_this.render()})}),"singleton"),Class((function VFXUI(){Inherit(this,Component);World.NUKE;!async function(){FX.UIBloomLayer.instance()}()}),"singleton"),Class((function ViewController(){Inherit(this,Object3D);const _this=this;var _mesh,_shader,_state,_viewActive,$debug,$lbt,$lbb,$circle,_effects={},_transitions={},_views={};function resize(){resizeLetterbox(),resizeCircle()}function resizeLetterbox(){$lbt.x=0,$lbb.x=0,$lbt.size(Stage.width,.15*Stage.height),$lbb.size(Stage.width,.15*Stage.height),_this.flag("letterboxing")?($lbt.y=0,$lbb.y=Stage.height-$lbb.height):($lbt.y=-$lbt.height,$lbb.y=Stage.height)}function resizeCircle(){let size=Math.max(Stage.width,Stage.height);$circle.size(size,size),$circle.x=.5*(Stage.width-size),$circle.y=.5*(Stage.height-size)}function handleChange({view:view}){switch(_state=view,view){case"LevelGummiLeaks":case"LevelDataMine":case"LevelCitricAlley":case"LevelSugarRoad":case"LevelExoticPetShop":case"ResultsView":case"PrizesView":_this.events.fire(AudioController.PAUSE,{name:"siteMainTrack",type:"track"});break;default:_this.events.fire(AudioController.PLAY,{name:"siteMainTrack",type:"track"})}}!async function(){Utils.getConstructorName(_this),World.SCENE.add(_this.group),await Data.ready(),ClickSFX.instance(),function initMesh(){_shader=_this.initClass(Shader,"ScreenQuad",{tMap:{value:null},transparent:!0}),(_mesh=new Mesh(World.QUAD,_shader)).frustumCulled=!1,_this.add(_mesh)}(),function initViews(){if(Global.PLAYGROUND&&"Level"===Global.PLAYGROUND.slice(0,5))return;Levels.instance().getList().map((level,index)=>{_views["IntroLevel"+index]=_this.initClass(window[level.intro],level.level)}),["CompleteView","ErrorView","IntroView","InvalidView","LandingView","SelectionView","SuccessView","ResultsView"].forEach(key=>{_views[key]=_this.initClass(window[key])})}(),function initTransitions(){["BasicTransition","GlitchTransition","GlitchVideoTransition","IntroTransition"].forEach(key=>{_transitions[key]=_this.initClass(window[key])})}(),function addHandlers(){_this.events.sub(ViewController.CHANGE,handleChange)}(),await async function initFirstView(){if(_this.flag("initialized",!0),Global.PLAYGROUND&&"Level"===Global.PLAYGROUND.slice(0,5))return;let is404Page=location.pathname.indexOf("404")>-1;_viewActive=!Config.PROD&&Utils.query("skipIntro")?_views.LandingView:"XX"===Utils.query("code")||is404Page?_views.ErrorView:"YY"===Utils.query("code")?_views.InvalidView:_views.IntroView;_shader.set("tMap",_viewActive),_this.events.fire(ViewController.CHANGE,{view:_viewActive.constructor.name})}(),"ViewController"===Utils.query("debug")&&function initDebug(){$debug=$gl(.2*Stage.width,.2*Stage.height,_viewActive),GLUI.Stage.add($debug)}(),function initLetterbox(){$lbt=$gl(Stage.width,.15*Stage.height,"#000000","normal"),$lbb=$gl(Stage.width,.15*Stage.height,"#000000","normal"),$lbt.setZ(99999),$lbb.setZ(99999),GLUI.Stage.add($lbt),GLUI.Stage.add($lbb)}(),function initCircle(){($circle=$gl(Stage.width,Stage.height,"assets/images/_scenelayout/uv.jpg","normal")).setZ(99999);let shader=_this.initClass(Shader,"UICircleShader",{uProgress:{value:0},uColor:{value:new Color("#000000")},uAspectRatio:{value:Stage.width/Stage.height},uAlpha:{value:1},transparent:!0});$circle.useShader(shader),GLUI.Stage.add($circle)}(),_this.onResize(resize),_this.flag("isReady",!0)}(),_this.get("state",_=>_state),_this.initLevel=async function(level){_views[level]||(_views[level]=_this.initClass(window[level])),await _views[level].ready()},_this.clearLevel=async function(level){if(!_views[level])return;_views[level]=_views[level].destroy();let{index:index,intro:intro}=Config.TRACK_LEVEL[level],name="IntroLevel"+index;_views[name]=_views[name].destroy(),_views[name]=_this.initClass(window[intro],level)},_this.transition=async function(nextViewName,data,transitionName="GlitchTransition"){if(_this.flag("transitioning"))return;_this.flag("transitioning",!0),Tests.GlitchTransition()||"GlitchTransition"!==transitionName||(transitionName="GlitchVideoTransition");let t=_transitions[transitionName];if(!t.shader)throw`Transition ${transitionName} does not have .shader property`;let previousView=_viewActive,nextView=_views[nextViewName];nextView.data=data,nextView.visible=!0,nextView.enableRT&&nextView.enableRT(),previousView.hideDOM&&previousView.hideDOM(),previousView.animateOut(),previousView.enableRT&&previousView.enableRT(),_this.events.fire(ViewController.CHANGE,{view:nextViewName}),_mesh.shader=t.shader,await t.play(previousView,nextView),(_viewActive=nextView).showGLUI(),$debug&&$debug.shader.set("tMap",_viewActive),_shader.set("tMap",_viewActive),_mesh.shader=_shader,previousView.visible=!1,_this.flag("transitioning",!1)},_this.show=function(){Utils.query("skipIntro")?_viewActive.showGLUI():_viewActive.enableRT&&_viewActive.enableRT(),_viewActive.animateIn(),_viewActive.visible=!0},_this.effect=async function(name,data){if(!Tests.ScreenEffects())return;if(_this.flag("transitioning"))return;await _this.ready(),_effects[name]||(_effects[name]=_this.initClass(window[name]));let effect=_effects[name];effect.shader.set("tMap",_viewActive),_mesh.shader=effect.shader,await effect.play(data),_this.flag("transitioning")||(_mesh.shader=_shader)},_this.letterbox=async function(state=!1,rate=1e3){if(!0!==rate){if(_this.flag("letterboxing")===state)return;await _this.ready(),_this.flag("letterboxing",!state),resizeLetterbox(),_this.flag("letterboxing",state);let top=state?0:-$lbt.height,bottom=state?Stage.height-$lbb.height:Stage.height;return tween($lbt,{y:top},rate,"easeOutQuint"),tween($lbb,{y:bottom},rate,"easeOutQuint").promise()}{await _this.ready();let top=Math.range(state,0,1,-$lbt.height,0,!0),bottom=Math.range(state,0,1,Stage.height,Stage.height-$lbb.height,!0);$lbt.y=top,$lbb.y=bottom,_this.flag("letterboxing","unset")}},this.circle=async function(state=!1,rate=1e3){if(!0!==rate){if(_this.flag("circle")===state)return;return await _this.ready(),_this.flag("circle",state),resizeCircle(),$circle.shader.set("uProgress",state?0:1),$circle.shader.tween("uProgress",state?1:0,rate,state?"easeOutSine":"easeInSine").promise()}await _this.ready(),resizeCircle(),$circle.shader.set("uProgress",state)},_this.ready=_=>_this.wait("isReady")}),"singleton",_=>{ViewController.CHANGE="viewcontroller_change"}),Class((function World(){Inherit(this,Component);const _this=this;let _renderer,_scene,_camera,_nuke,_controls;function resize(){_renderer.setSize(Stage.width,Stage.height),_camera.aspect=Stage.width/Stage.height,_camera.updateProjectionMatrix()}function loop(t,delta){_controls&&_controls.enabled&&_controls.update(),RenderManager.render()}World.DPR=Tests.getDPR(),function initWorld(){World.PLANE=new PlaneGeometry(1,1),World.QUAD=Utils3D.getQuad(),World.BOX=new BoxGeometry(1,1,1),World.SPHERE=new SphereGeometry(1,16,16),World.TEST=World.PLANE_LIGHT=new PlaneGeometry(1,1).toNonIndexed(),World.PLANE_HIGH=new PlaneGeometry(1,1,16,16).toNonIndexed(),RenderManager.initialize(RenderManager.NORMAL,{powerPreference:"high-performance"}),_renderer=RenderManager.gl,_scene=RenderManager.scene,_camera=RenderManager.camera.worldCamera,_nuke=RenderManager.nuke,World.SCENE=_scene,World.RENDERER=_renderer,World.ELEMENT=$(_renderer.domElement),World.CAMERA=_camera,World.NUKE=_nuke}(),function initControls(){if(!Utils.query("orbit"))return;if(!window.DebugControls)return;let Controls=Utils.query("wasd")?WASDControls:DebugControls;_controls=new Controls(_camera,World.ELEMENT.div),RenderManager.type==RenderManager.NORMAL?(_camera.position.set(0,0,6),_camera.target=new Vector3(0,0,0),_camera.lookAt(_camera.target),_controls.target=_camera.target):_controls.enabled=!1,World.CONTROLS=_controls}(),function addHandlers(){_this.events.sub(Events.RESIZE,resize)}(),Utils.query("uilOnly")||Render.onDrawFrame(loop),RenderManager.type==RenderManager.NORMAL&&Camera.instance(_camera)}),(function(){var _instance;World.instance=function(){return _instance||(_instance=new World),_instance}})),Class((function TestView(){Inherit(this,FXScene);this.create(World.NUKE,{type:Texture.FLOAT})})),Class((function DialogView(){Inherit(this,GLUIElement);const _this=this;var $this,$message;function resize(){$this.scale=Stage.height/800*.575}!function initGL(){($this=_this.element).alpha=1e-5,GLUI.Stage.add($this)}(),function initMessage(){($message=$glText("message",UI.FONT_PRIMARY,21,{shader:"NPCDialog",color:"#ffffff",width:600,lineHeight:1.75})).setZ(2),$message.x=-275,$message.y=0,$this.add($message),$message.loaded().then(_=>{$message.text.shader.addUniforms({uTransition:{value:0},uLetterCount:{value:0}})})}(),function addHandlers(){_this.onResize(resize)}(),this.message=function(string=""){return async function render($text,string){let promise=Promise.create(),duration=125+25*string.length;$text.alpha=1e-4,$text.setText(string),await _this.wait(150),await $text.loaded(),$text.text.shader.set("uTransition",0),$text.text.shader.set("uLetterCount",$text.text.geometry.letterCount);let height=$text.dimensions.height;return $text.y=-height-75,await _this.wait(50),$text.alpha=1,$text.text.shader.tween("uTransition",1,duration,"linear"),_this.delayedCall(promise.resolve,duration),promise}($message,string)},this.response=function(string=""){},this.clear=function(all=!1){$message.setText(" ")},this.options=function(options){},_this.enableInteractions=function(){},_this.disableInteractions=function(){}}),"singleton"),Class((function Fog(){Inherit(this,Component);const _this=this;var _fog;!async function(){await defer();let camera=World.CAMERA;if(_fog=_this.initClass(CloudFog,{dpr:1,resolution:.5,camera:camera,enabled:Tests.renderClouds(),disableNoise:!Tests.renderCloudNoise()}),_this.rt=_fog.rt,_this.isPlayground()){let $glui=$gl(Stage.width,Stage.height,_fog);GLUI.Stage.add($glui)}}()}),"singleton"),Class((function GlitchEffect(){Inherit(this,Component);const _this=this;_this.shader=_this.initClass(Shader,"GlitchEffect",{tMap:{value:null},uGlitch:{value:0},transparent:!0}),this.play=async function({level:level=20,ramp:ramp=250,duration:duration=100}={}){_this.shader.set("uGlitch",0),await _this.shader.tween("uGlitch",level,ramp,"easeInQuint").promise(),await _this.shader.tween("uGlitch",0,.5*ramp,"easeInQuint",duration).promise(),_this.shader.set("uGlitch",0)}})),Class((function IntroEffect(){Inherit(this,Component);const _this=this;!function(){_this.shader=_this.initClass(Shader,"Transition","IntroEffect",{tMap:{value:null},tGlitch:{value:null},transparent:!0});let src=Tests.videoTexture()?"assets/videos/glitch.mp4":"assets/images/fallback/glitch.jpg";_this.video=_this.initClass(VideoTexture,src,{autoplay:!1})}(),this.play=async function(){_this.video.start(),_this.shader.set("tGlitch",_this.video.texture),await _this.wait(IntroEffect.DELAY),_this.video.stop()}}),_=>{IntroEffect.DELAY=1e3}),Class((function Fallback(){Inherit(this,Element);const _this=this;var $this,$container;!function initHTML(){($this=_this.element).size("100%").bg("#000000")}(),function initBG(){$this.create("bg").size("100%").css({opacity:.666,backgroundSize:"cover",backgroundPosition:"center center"}).bg("assets/images/unsupported/background.jpg")}(),function initContainer(){($container=$this.create("container").size(320,200).center(!0,!1).css({top:"53%"})).html('Your browser or device does not<br />support the full experience. </br> </br>Please upgrade to the latest version of <a style="color: inherit; position: static; display: inline" href="https://www.google.com/chrome/browser/desktop/" target="_blank">Google Chrome</a>'),$container.fontStyle("lomo-web-pixel",18,"#ffffff").css({textAlign:"center",textTransform:"uppercase",fontWeight:700})}(),function initLogo(){$this.create("logo").size(187,90).bg("assets/images/ui/trolli.png").center(!0,!1).css({top:"50%",marginTop:-120}).css({backgroundSize:"contain",backgroundPosition:"center center",backgroundRepeat:"no-repeat"})}(),Track.page("/fallback")})),Class((function ErrorView(){Inherit(this,FeedbackView,{type:"error"})})),Class((function FeedbackView({type:type="error"}={}){Inherit(this,GameView,{logo:"center"});const _this=this;var _background,_title,_description,_titleText,_descriptionText,_shader,_time=0;function onResize(){Mobile.setOrientation(),_title.x=Stage.width/2,_title.y=Stage.height/2-10*_title.scale,_description.x=Stage.width/2,_description.y=Stage.height/2+30*_description.scale,_background.width=Stage.width,_background.height=Stage.height}function loop(){(_time+=.01)>2&&(_time=0,ViewController.instance().effect("GlitchEffect"))}!async function(){await Data.ready(),"error"===type?(_titleText=Data.COPY.expired,_descriptionText=Data.COPY.expiredDesc):"invalid"===type&&(_titleText=Data.COPY.invalid,_descriptionText=Data.COPY.invalidDesc),await function initBackground(){_shader=_this.initClass(Shader,"FeedbackViewShader",{uAlpha:{value:1},uColor:{value:new Color(Colors.instance().getColor("DARK_BLUE"))},uGrain:{value:.075},uGlitch:{value:1},uResolution:{value:new Vector2(Stage.width,Stage.height)},tText:{value:Utils3D.getRepeatTexture("assets/images/ui/console.png")},transparent:!0}),(_background=$gl(Stage.width,Stage.height,_shader)).setZ(-1),_background.useShader(_shader),_this.glui.add(_background)}(),await function initTitle(){_title=_this.initClass(UITitle,_titleText,{fontSize:17,letterSpacing:.04}),_this.glui.add(_title.element),_this.elements.push(_title)}(),await function initDescription(){_description=_this.initClass(UIDescription,_descriptionText,{width:250}),_this.glui.add(_description.element),_this.elements.push(_description)}(),function addHandlers(){_this.onResize(onResize)}(),await _description.ready(),Global.PLAYGROUND&&Global.PLAYGROUND.includes(["FeedbackView","InvalidView","ErrorView"])&&(_this.visible=!0,GLUI.Stage.add(_this.glui)),_this.startRender(loop),_this.onResizeDelayed(onResize)}(),_this.animateIn=function(){},_this.animateOut=function(){return Promise.resolve()}})),Class((function InvalidView(){Inherit(this,FeedbackView,{type:"invalid"})})),Class((function SuccessView(){Inherit(this,GameView,{logo:"left"});const _this=this;var _title,_description,_play,_close,_footer;function onResize(){_title.x=Stage.width/2,_title.y=Stage.height/2-90*_title.scale,_description.x=Stage.width/2,_description.y=Stage.height/2-35*_description.scale,_play.x=Stage.width/2,_play.y=Stage.height/2+65*_play.scale,_footer.resize()}!async function(){await Data.ready(),await function initTitle(){let title=Account.instance().isLoggedIn()?Data.COPY.successRegistered:Data.COPY.successTitle;_title=_this.initClass(UITitle,title,{fontSize:22,align:"center"}),_this.glui.add(_title.element),_this.elements.push(_title)}(),await function initDescription(){_description=_this.initClass(UIDescription,Data.COPY.successDesc,{width:430}),_this.glui.add(_description.element),_this.elements.push(_description)}(),await function initPlay(){_play=_this.initClass(UIButton,Data.COPY.successCta1,{onClick:_=>{Track.event("Register","click","play"),ViewController.instance().transition("SelectionView")}}),_this.glui.add(_play.element),_this.elements.push(_play)}(),await function initClose(){_close=_this.initClass(UIClose,{onClick:_=>ViewController.instance().transition("LandingView")}),_this.glui.add(_close.element),_this.elements.push(_close)}(),await async function initFooter(){_footer=_this.initClass(UIFooter,_this,_this.glui),await _footer.ready(),_this.elements.push(_footer.privacy),_this.elements.push(_footer.information)}(),function addHandlers(){_this.onResize(onResize)}(),await _play.ready(),"SuccessView"===Global.PLAYGROUND&&(_this.visible=!0,GLUI.Stage.add(_this.glui)),_this.onResizeDelayed(onResize)}(),_this.onActive=function(){},_this.animateIn=function(){Track.page("/register/success","Register Success"),_this.hideDOM(),_this.data&&_this.data.message&&(_title.setText(Data.COPY.successTitle),_description.text.setText(_this.data.message))},_this.animateOut=function(){return Promise.resolve()}})),Class((function GameView({audio:audio,background:background=!0,isFirstRender:isFirstRender=!1,logo:logo,logoRedirect:logoRedirect=!0}={}){Inherit(this,FXScene);const _this=this;_this.glui=$gl(),_this.gluiScene=new Scene;var $background,$logo,$audio,_isFirstRender=isFirstRender;new Vector2;function onResize(){$background&&($background.width=Stage.width,$background.height=Stage.height)}function loop(){_this.render(),_this.flag("isRT")&&GLUI.Stage.renderToRT(_this.gluiScene,_this.rt)}!async function(){let name=Utils.getConstructorName(_this).slice().replace("View","");_this.flag("name",name),GLSEO.registerPage(_this.glui,name),_this.glui.seo.enabled=!1,_this.elements=[],_this.visible=!1,background&&async function initBackground(){await ScreensBackground.instance().ready();let{shader:shader}=ScreensBackground.instance();($background=$gl(Stage.width,Stage.height,shader)).setZ(-2),$background.useShader(shader),_this.glui.add($background)}(),logo&&async function initLogo(){$logo=UILogo.instance()}(),audio&&async function initAudio(){$audio=UIAudio.instance()}(),_this.onResize(onResize),_this.create(World.NUKE),_this.startRender(loop)}(),_this.onVisible=async function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0);let delay=_this.uiDelay||300;_this.onActive&&await _this.onActive();let elementDelay=delay;_isFirstRender&&(elementDelay+=600),_this.elements.forEach((child,index)=>{!1!==child.autoplay&&child.animateIn&&(child.animateIn(elementDelay),elementDelay+=150,child.delay&&(elementDelay+=child.delay))}),_isFirstRender&&(_isFirstRender=!1,_this.wrapper.tween({scale:1},6e3,"easeOutQuart")),_this.showDOM&&_this.showDOM(),_this.preAnimateIn&&_this.preAnimateIn(),await _this.wait("gluiVisible"),_this.animateIn(),await _this.wait(delay),_this.elements.forEach((child,index)=>{child.enableInteractions&&child.enableInteractions()}),_this.glui.seo.enabled=!0},_this.onInvisible=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.glui.seo.enabled=!1,_this.elements.forEach((child,index)=>{child.animateOut&&child.animateOut(100*index),child.disableInteractions&&child.disableInteractions()}),_this.animateOut())},_this.showDOM=async function(){let delay=GlitchTransition.DELAY/2+100*_this.elements.length;UILogo.instance().reposition(logo),_this.$dom&&(_this.$dom.element.css({opacity:0,pointerEvents:"auto",visibility:"visible"}),_this.$dom.element.tween({opacity:1},400,"easeOutCubic",delay)),$audio&&$audio.animateIn(delay),$logo&&(await $logo.animateIn(delay),logoRedirect&&$logo.enableInteractions())},_this.hideDOM=async function(){_this.$dom&&_this.$dom.element.tween({opacity:0,pointerEvents:"none"},400,"easeOutCubic",GlitchTransition.DELAY/3,_=>{_this.$dom.element.css({visibility:"hidden"})}),$audio&&$audio.animateOut(GlitchTransition.DELAY/2),$logo&&logoRedirect&&$logo.disableInteractions()},_this.showGLUI=function(){GLUI.Stage.add(_this.glui),_this.flag("gluiVisible",!0)},_this.enableRT=function(){_this.flag("isRT",!0),_this.gluiScene.add(_this.glui.group),$background&&($background.visible=!0)},_this.onResizeDelayed=function(onComplete){_this.delayedCall(async _=>{_this.elements.forEach(element=>element.resize()),onComplete&&onComplete()},100)}})),Class((function IntroAccessShader(_mesh,_shader){Inherit(this,Component);_shader.addUniforms({uColor:{value:new Color(Colors.instance().getColor("DARK_BLUE"))},uGrain:{value:.05}})})),Class((function IntroScreenShader(_mesh,_shader){Inherit(this,Component);const _this=this;var _video;!function(){let src=Tests.videoTexture()?"assets/videos/screens.mp4":"assets/images/fallback/screens.jpg";(_video=_this.initClass(VideoTexture,src)).start(),_shader.addUniforms({uAlpha:{value:.75},uPattern:{value:new Vector2(0,0)},tScreens:{value:_video},transparent:!0})}()})),Class((function IntroTitleShader(_mesh,_shader){Inherit(this,Component);_shader.addUniforms({uOpacity:{value:.1}})})),Class((function IntroView(){Inherit(this,FXScene);const _this=this;var _layers,_titles,_camera=Camera.instance().createLocal();new Vector2;function onResize(){Mobile.setOrientation(),"portrait"!==Mobile.orientation&&_this.flag("isRotated",!0)}function loop(t){_this.render(),_titles.forEach((title,index)=>{if(_this.skipIntro&&index>0)return void(title.visible=!1);let dif=title.group.position.z-_camera.worldCamera.position.z,alphaIn=Math.range(dif,-25,-Math.range(title.ogText.length,20,40,50,60),1,0,!0),alphaOut=Math.range(dif,-3,-6,0,1,!0);title.text.alpha=alphaIn*alphaOut;let text=title.ogText.slice(0,Math.range(alphaIn,0,1,1,title.ogText.length));text.length<title.ogText.length&&Math.floor(t)%1==0&&(text+="_"),title.text.setText(text),!title.glitched&&dif>-10&&(title.glitched=!0,ViewController.instance().effect("GlitchEffect"))})}!async function(){_this.visible=!1,_this.create(),_this.setResolution(Tests.getIntroResolution()),Utils.query("orbit")||_this.useCamera(_camera.worldCamera),await Data.ready(),_this.layout=_this.initClass(SceneLayout,"intro_view",{data:Data.COPY}),(_layers=await _this.layout.getAllLayers()).camera.still(0),_layers.camera.lock(_camera),_layers.cameraEnd.still(0),(_titles=[_layers.accessTitle,_layers.welcomeTitle,_layers.welcomeTitle2,_layers.welcomeTitle3]).forEach(title=>{title.ogText=title.text.text.string}),"IntroView"===Global.PLAYGROUND&&(_this.visible=!0,_this.animateIn()),_this.scene.add(_this.layout.group),_this.startRender(loop),function addHandlers(){_this.onResize(onResize)}(),_this.flag("isReady",!0)}(),_this.ready=_=>_this.wait("isReady"),_this.animateIn=async function(){if(await _this.ready(),Track.page("/intro","Intro"),UIRotation.instance().resize(),_this.delayedCall(_=>{Global.PLAYGROUND||ViewController.instance().effect("GlitchEffect")},100),Device.mobile&&await _this.wait("isRotated"),UIRotation.instance().showBackground(),UIRotation.instance().animateOut(),Storage.get("seen_intro")&&!Global.PLAYGROUND){_this.skipIntro=!0;let time=15e3;_layers.cameraEnd.transition(time,"linear",_camera),_layers.welcomeBackground.shader.set("uAlpha",0),_layers.welcomeBackground.shader.tween("uAlpha",1,1800,"easeInQuart",500),_layers.welcomeBackground.shader.tween("uTransition",1,1800,"easeInQuart",500),Global.PLAYGROUND||_this.delayedCall(_=>{_layers.welcomeBackground.shader.tween("uAlpha",0,1500,"easeInSine"),ViewController.instance().transition("LandingView",null,"IntroTransition")},3300)}else{let time=15e3;_layers.cameraEnd.transition(time,"linear",_camera),_layers.welcomeBackground.shader.set("uAlpha",0),_layers.welcomeBackground.shader.tween("uAlpha",1,1800,"easeInQuart",500),_layers.welcomeBackground.shader.tween("uTransition",1,1800,"easeInQuart",500),Global.PLAYGROUND||_this.delayedCall(_=>{Storage.set("seen_intro",!0),_layers.welcomeBackground.shader.tween("uAlpha",0,1500,"easeInSine"),ViewController.instance().transition("LandingView",null,"IntroTransition")},time-2e3)}_this.delayedCall(_=>{Mobile.fullscreen(),Mobile.setOrientation("landscape")},2e3)},_this.animateOut=async function(){return await _this.ready(),ScreensBackground.instance().animateIn(),Promise.resolve()}})),Class((function IntroWelcomeShader(_mesh,_shader){Inherit(this,Component);_shader.addUniforms({uColor:{value:new Color(Colors.instance().getColor("DARK_BLUE"))},uPixelation:{value:50},uTransition:{value:0},uVelocity:{value:.15},tMap:{value:Utils3D.getRepeatTexture("assets/images/intro/wormhole.jpg")},uAlpha:{value:1}}),_mesh.shader=_shader,MouseFluid.instance().applyTo(_shader)})),Class((function LandingView(){Inherit(this,GameView,{audio:!0,isFirstRender:!0,logo:"center",logoRedirect:!1});const _this=this;var _play,_skip,_footer,$logo,_mouse=new Vector2;function loop(){Device.mobile||(_mouse.lerp(Mouse.tilt,.07),_this.wrapper.x=_mouse.x*Stage.width*.006,_this.wrapper.y=_mouse.y*Stage.width*.003)}function onResize(){_play.x=Stage.width/2,_play.y=Stage.height/2+45*_play.scale,_skip&&(_skip.x=_play.x,_skip.y=_play.y+42*_play.scale),$logo&&($logo.scale=_play.scale,$logo.x=Stage.width/2,$logo.y=Stage.height/2),_footer.resize()}async function handlePlay(){Track.event("Landing","click","get-eaten"),ViewController.instance().transition("SelectionView")}_this.uiDelay=1e3,async function(){await function initWrapper(){_this.wrapper=$gl(Stage.width,Stage.height),_this.wrapper.scale=Device.mobile.phone?1:.7,_this.glui.add(_this.wrapper)}(),function initLogo(){($logo=_this.wrapper.create()).image=$logo.create(408.6,366*.45,Data.COPY.introLogo),$logo.image.x=.5*-$logo.image.width,$logo.image.y=.9*-$logo.image.height;let shader=_this.initClass(Shader,"LandingLogo",{uVisible:{value:0},transparent:!0,blending:Shader.ADDITIVE_BLENDING});$logo.image.useShader(shader)}(),await async function initPlay(){_play=_this.initClass(UIButton,Data.COPY.landingCta1,{color:Colors.instance().getColor("AQUA"),onClick:handlePlay,width:230}),_this.wrapper.add(_play.element),_this.elements.push(_play),await _play.ready()}(),await async function initFooter(){_footer=_this.initClass(UIFooter,_this,_this.wrapper),await _footer.ready(),_this.elements.push(_footer.privacy),_this.elements.push(_footer.information)}(),function addHandlers(){_this.onResize(onResize)}(),"LandingView"===Global.PLAYGROUND&&(_this.visible=!0,GLUI.Stage.add(_this.glui),ScreensBackground.instance().animateIn(),$logo.image.shader.set("uVisible",0),$logo.image.shader.tween("uVisible",1,1500,"easeInOutCubic")),_this.startRender(loop),_this.onResizeDelayed(onResize)}(),_this.preAnimateIn=function(){$logo.image.shader.set("uVisible",0),$logo.image.shader.tween("uVisible",1,2500,"easeInOutCubic",600)},_this.animateIn=async function(){UILogo.instance().disableInteractions(),Track.page("/landing","Landing"),await ScreensBackground.instance().ready(),ScreensBackground.instance().enable(),ScreensBackground.instance().animateIn()},_this.animateOut=function(){return UILogo.instance().enableInteractions(),_this.flag("processing",!1),Promise.resolve()}})),Class((function LevelView(_player,playground,config){Inherit(this,GameView,{background:!1,audio:!0,logo:"left"});const _this=this,CMS=Data.LEVELS[Config.CMS_LEVEL[config.level]],DURATION=60*(isNaN(parseFloat(CMS.duration))?10:parseFloat(CMS.duration))*1e3;var START,END,_timer,_coins,_items,_health,_hacks,_punishment,_hackTimer,$coins,$time,$items,_penalty=0;function loop(){_player&&_player.inventory&&(position($coins,_coins),position($items,_items,_player.inventory.items.keys>=5),_this.flag("active")&&(!function updateTime(){let remaining=getTimeRemaining(),str=StringUtils.formatTime(remaining);if(0===remaining)return _this.events.fire(Level.END);if(_this.flag("lastTime")===str)return;_timer.setText(str),_this.flag("lastTime",str)}(),function blinkTime(){let remaining=getTimeRemaining(),visible=remaining<6e4&&remaining%1e3>500?1e-5:1;_timer.$text.alpha=visible,remaining<6e4&&!_this.flag("warning")&&function warnTrack(){_this.flag("warning",!0),_this.events.fire(AudioController.PLAY,{name:"lowTime",type:"track"})}();remaining>6e4&&_this.flag("warning")&&endWarnTrack()}()))}function position($icon,_label,pulse=!1){$icon.origin||($icon.pos=(new Vector2).copy($icon),$icon.origin=(new Vector2).copy($icon),$icon.velocity=new Vector2);let angle=Math.atan2($icon.origin.y-$icon.y,$icon.origin.x-$icon.x),power=$icon.origin.distanceTo($icon.pos);pulse&&($icon.velocity.y+=.5*Math.cos(Render.TIME/100)),$icon.velocity.x+=Math.cos(angle)*power*.1,$icon.velocity.y+=Math.sin(angle)*power*.1,$icon.velocity.multiplyScalar(.8),$icon.x+=$icon.velocity.x,$icon.y+=$icon.velocity.y,$icon.pos.copy($icon),_label.element.y=Math.lerp(_label.element.y,$icon.y+.5*$icon.height-15,.01)}function getTimeRemaining(){let now=(new Date).getTime();return Math.max(0,END-now-_penalty)}function endWarnTrack(){_this.flag("warning",!1),_this.events.fire(AudioController.PAUSE,{name:"lowTime",type:"track"})}function onLevelStart(){START=(new Date).getTime(),END=START+DURATION,_this.flag("active",!0),endWarnTrack()}function onLevelEnd({success:success}){_this.flag("active",!1),_this.flag("completion",getTimeRemaining()),Track.event(Level.CURRENT,"end",_this.flag("completion")/1e3,success),endWarnTrack()}function onResize(){let scale=function getScale(){return 1920/1080<Stage.width/Stage.height?Stage.height/1080:Stage.width/1920}();_this.container.x=.5*(Stage.width-1920*scale),_this.container.y=0*(Stage.height-1080*scale),_this.container.scale=scale}function onCollected({type:type}){switch(type){case"coins":!function onCoinCollected(){let number=_player.inventory.items.coins;_this.delayedCall(_=>{_coins.element.alpha=1e-5;let text=StringUtils.padInt(number,3,"0");_coins.setText(text);let angle=Math.random()*Math.PI*2;$coins.velocity.x+=8*Math.cos(angle),$coins.velocity.y+=8*Math.sin(angle),_this.events.fire(AudioController.PLAY,{name:"coin"}),tween(_coins.element,{alpha:1},125,"easeOutCubic",10)},500)}();break;case"keys":!function onItemCollected(){let number=_player.inventory.items.keys;_this.delayedCall(_=>{_items.element.alpha=1e-5,_items.setText(number+"/5"),number>=5&&(_this.events.fire(AudioController.PLAY,{name:"collectAll"}),_items.$text.setColor(Colors.instance().getColor("AQUA")));let angle=Math.random()*Math.PI*2;$items.velocity.x+=8*Math.cos(angle),$items.velocity.y+=8*Math.sin(angle),_this.events.fire(AudioController.PLAY,{name:"key"}),tween(_items.element,{alpha:1},125,"easeOutCubic",10)},500)}()}}function onReset({died:died}){died&&(_penalty+=3e4,function flash($el,times=5,rate=300){!function blink(){$el.alpha=1e-5,_this.delayedCall(_=>$el.alpha=1,rate/2),times>0&&_this.delayedCall(blink,rate),times--}()}(_timer.element),_punishment.element.y=40,_punishment.animateIn(),_this.punishTween&&clearTween(_this.punishTween),clearTimeout(_this.punishTimer),_this.punishTween=tween(_punishment.element,{y:-100},1e3,"linear",1e3),_this.punishTimer=_this.delayedCall(_=>{_punishment.animateOut()},1500))}!function initView(){_this.glui.alpha=_this.isPlayground()?1:1e-5,_this.container=$gl(),_this.glui.add(_this.container)}(),function initVignette(){let shader=_this.initClass(Shader,"UIVignette",{uColor:new Color("#000000"),uFalloff:{value:new Vector2(0,1)},uAlpha:{value:1},transparent:!0}),$vignette=$gl(1200,250,"assets/images/_scenelayout/uv.jpg");$vignette.useShader(shader),$vignette.x=360,$vignette.y=-50,$vignette.setZ(-1),$vignette.alpha=.75,_this.container.add($vignette)}(),async function initTimer(){let $timeGroup=$gl();_timer=_this.initClass(UILabel,"10:00",{color:Colors.instance().getColor("WHITE"),align:"left",fontSize:30,font:UI.FONT_ACCENT,isScalable:!1}),($time=$gl(64,64,"assets/images/ui/time.png")).scale=.666,_timer.element.x=74,_timer.element.y=15,$timeGroup.add($time),$timeGroup.add(_timer.element),$timeGroup.y=50;let timerWidth=await _timer.width;$timeGroup.x=960-(timerWidth+64+20)/2,_this.container.add($timeGroup),_timer.animateOut()}(),function initPunishment(){(_punishment=_this.initClass(UILabel,"-00:30",{color:Colors.instance().getColor("RED"),align:"center",fontSize:20,font:UI.FONT_ACCENT,isScalable:!1})).element.x=960,_this.container.add(_punishment.element)}(),function initCoins(){(_coins=_this.initClass(UILabel,"000",{color:Colors.instance().getColor("WHITE"),align:"left",fontSize:30,font:UI.FONT_ACCENT,isScalable:!1})).element.x=576,_coins.element.y=75,($coins=$gl(64,64,"assets/images/ui/peach.png")).scale=.666,$coins.x=_coins.element.x-64-15,$coins.y=50,_this.container.add($coins),_this.container.add(_coins.element),_coins.animateIn()}(),async function initItems(){($items=$gl(60,65,"assets/images/ui/key.png")).scale=.666,$items.x=1248,$items.y=50,_items=_this.initClass(UILabel,"0/5",{color:Colors.instance().getColor("WHITE"),align:"left",fontSize:30,font:UI.FONT_ACCENT,isScalable:!1});let itemsWidth=await _items.width;_items.element.x=$items.x+itemsWidth-10,_items.element.y=75,config.showKeysUI&&(_items.animateIn(),_this.container.add($items),_this.container.add(_items.element))}(),function initHealth(){(_health=_this.initClass(LevelViewHealth,_player)).element.x=960,_health.element.y=140,_this.container.add(_health.element)}(),function initHacks(){(_hacks=_this.initClass(LevelViewHacks)).element.x=960,_hacks.element.y=340,_this.container.add(_hacks.element),(_hackTimer=_this.initClass(LevelViewHacksTimer)).element.x=960,_hackTimer.element.y=225,_this.container.add(_hackTimer.element)}(),function addHandlers(){_this.events.sub(Level.START,onLevelStart),_this.events.sub(Level.END,onLevelEnd),_this.events.sub(Coins.COLLECTED,onCollected),_this.events.sub(Level.RESET,onReset),_this.onResize(onResize)}(),function initPlayground(){if(!_this.isPlayground()&&!playground)return;if(_this.visible=!0,GLUI.Stage.add(_this.glui),!Utils.query("debugCamera"))return;let $crosshairs=$gl(0,0);$crosshairs.x1=$crosshairs.create(30,1,"#aaaaaa"),$crosshairs.x1.x=-15,$crosshairs.x2=$crosshairs.create(1,30,"#aaaaaa"),$crosshairs.x2.y=-15,$crosshairs.setZ(999999999),_this.onResize(_=>{$crosshairs.x=Stage.width/2,$crosshairs.y=Stage.height/2}),GLUI.Stage.add($crosshairs),_this.isPlayground()&&(DialogView.instance().name("debug name"),DialogView.instance().message("Est temp oribus velit aut porro repellat."),DialogView.instance().response("goodbye"))}(),_this.startRender(loop),this.onDestroy=function(){_this.glui.remove(),_this.container.remove(_health.element),_this.container.remove(_hackTimer.element),_health.destroy(),_hackTimer.destroy()},this.get("time",_=>_this.flag("completion")),this.animateIn=function(){tween(_this.glui,{alpha:1},500,"easeOutCubic"),_this.showDOM();for(let el of[_timer,_coins,_items])el.animateIn()},this.animateOut=function(){tween(_this.glui,{alpha:1e-4},500,"easeOutCubic"),_this.hideDOM();for(let el of[_timer,_coins,_items])el.animateOut()}})),Class((function LevelViewHacks(){Inherit(this,GLUIElement);const _this=this;var $this,_messages=[];function rumble(){if(!Tests.ReduceMotion())for(let[i,$message]of _messages.entries()){if(i===_messages.length-1)continue;let angle=Math.random(0,2*Math.PI,6),distance=Math.random(2,8,6);$message.x=Math.cos(angle)*distance,$message.y=Math.sin(angle)*distance}}function onHack({type:type}){switch(type){case"disableEnemies":displayMessage("ENEMIES DISABLED");break;case"invincible":displayMessage("INVINCIBILITY");break;case"jumping":displayMessage("INFINITE JUMP");break;case"speedBoost":displayMessage("SPEED BOOST")}}function displayMessage(string){for(let $message of _messages)$message.setText(string);$this.alpha=1e-5,$this.scale=.75,$this.visible=!0,_this.startRender(rumble),$this.clearTween(),tween($this,{alpha:1,scale:1},350,"easeOutCubic",10).onComplete(_=>{tween($this,{scale:1.5,alpha:1e-6},350,"easeOutCubic",1e3).onComplete(_=>{_this.stopRender(rumble),$this.visible=!1})})}!function initGL(){($this=_this.element).alpha=1e-6,$this.visible=!1}(),function initText(){for(let[i,color]of["#000000","#02f0e2","#ff5260","#ffffff"].entries()){let $message=$glText("INFINITE JUMP",UI.FONT_PRIMARY,45,{color:color,lineHeight:1.75,align:"center"});$message.setZ(2+i),$this.add($message),_messages.push($message)}}(),function addHandlers(){_this.events.sub(Hacks.EVENT,onHack)}()})),Class((function LevelViewHacksTimer(){Inherit(this,GLUIElement);const _this=this,CONFIG=require("Hacks");var $this,$bar,_shader;function onHack({type:type}){let data=CONFIG[type];if(!data)return;let duration=data.duration;$this.alpha=1e-6,$this.scale=.75,$this.visible=!0,_shader.set("uProgress",1),_shader.set("uWarning",0),_shader.tween("uWarning",1,0,"linear",duration-2500),_shader.tween("uProgress",0,duration,"linear").onComplete(_=>{$this.tween({scale:1.5,alpha:1e-6},100,"easeOutCubic").onComplete(_=>{$this.visible=!1})}),$this.clearTween().tween({scale:1,alpha:1},100,"easeOutCubic")}!function initGL(){($this=_this.element).alpha=1e-6,$this.visible=!1}(),function initBar(){($bar=$this.create(350,16,"assets/images/_scenelayout/uv.jpg")).x=-175,_shader=_this.initClass(Shader,"LevelViewHacksTimer",{tMask:{value:Utils3D.getTexture("assets/images/ui/timer-mask.jpg")},uProgress:{value:1},uWarning:{value:0},uAlpha:{value:1},transparent:!0}),$bar.useShader(_shader)}(),function addHandlers(){_this.events.sub(Hacks.EVENT,onHack)}()})),Class((function LevelViewHealth(_player){Inherit(this,GLUIElement);const _this=this,CONFIG=require("Health");var $this,$healthBar;new Vector2,new Vector2;function onDamage({health:health}){let critical=1===health;$healthBar.shader.tween("uHealth",health/CONFIG.maxHealth,1e3,"easeOutElastic"),$healthBar.shader.tween("uCritical",critical?1:0,350,"easeOutCubic"),_this.flag("critical",critical)}async function onReset(){_this.flag("critical",!1),await _this.wait(1e3),$healthBar.shader.tween("uHealth",1,450,"easeInOutCubic"),$healthBar.shader.tween("uCritical",0,350,"easeOutCubic")}!function initGL(){$this=_this.element}(),function initHearts(){let total=CONFIG.maxHealth,width=60*total+10*(total-1),x=-width/2;$healthBar=$this.create(width,width/5,"assets/images/ui/health-bar.png");let texture=Utils3D.getTexture("assets/images/ui/health-bar.png");texture.minFilter=texture.magFilter=Texture.NEAREST;let shader=_this.initClass(Shader,"LevelHealthBarShader",{tIcon:{value:texture},uAlpha:{value:1},uHealth:{value:1},uCritical:{value:0},transparent:!0});$healthBar.x=x,$healthBar.useShader(shader)}(),function addHandlers(){_this.events.sub(PlayerHealth.UPDATE,onDamage),_this.events.sub(Level.RESET,onReset)}()})),Class((function LoaderView(){Inherit(this,Element);const _this=this,$this=_this.element;var $blocks,$blocksItems=[],$blocksFills=[],_promises=[];function loop(time){$blocksItems.forEach(($block,index)=>{$block.transform({y:10*Math.sin(index/2+time/5)})}),$blocksFills.forEach(($block,index)=>{let val=360*Math.abs(Math.sin((time+index)/20));$block.css({boxShadow:`0px 0px 50px hsl(${val}, 100%, 50%)`,background:`hsl(${val}, 100%, 50%)`})})}Track.page("/loading","Loading"),function initHTML(){$this.size("100%").bg("#0B0920").setZ(1e4)}(),function initBlocks(){($blocks=$this.create("Blocks")).css({display:"flex",padding:Device.mobile?"0.5rem":"0.25rem",justifyContent:"space-between",width:Device.mobile?"27rem":"14rem"}).center().transform({x:"-50%",y:"-50%"});for(let i=0;i<18;i++){let $block=$blocks.create("Block"),$blockFill=$block.create("Block__Fill");$block.css({border:"2px solid rgba(255, 255, 255, 0.06)",background:"rgba(255, 255, 255, 0.06)",display:"block",height:Device.mobile?"3.6rem":"1.8rem",position:"relative",width:Device.mobile?"1.2rem":"0.65rem"}).transform({y:10*Math.sin(i)}),$blockFill.css({background:"#F700FC",boxShadow:"0px 0px 50px #F700FC",height:"100%",opacity:0,width:"100%"}),$blocksItems.push($block),$blocksFills.push($blockFill)}}(),_this.startRender(loop,30),this.progress=function(e){let length=Math.floor(e.percent*$blocksFills.length);$blocksFills.forEach(($block,index)=>{if(!$block.isLoaded&&index<length){$block.isLoaded=!0;let promise=new Promise(resolve=>{$block.tween({opacity:1},400,"easeOutCubic",50*index,_=>{resolve()})});_promises.push(promise)}})},this.animateOut=async function(callback){await Promise.all(_promises),$blocks.tween({opacity:0,x:"-50%",y:"-50%"},500,"easeInOutSine"),callback&&callback()}})),Class((function LoginView(){Inherit(this,GameView,{audio:!0,logo:"center"});const _this=this;var _title,_link,_form,_footer,$message,$formContainer;function handleLinkClick(){ViewController.instance().transition("RegistrationView")}async function handleFormSubmit(value){const loginResponse=await Api.login(value);!1===loginResponse.success?(console.log("Login Error",loginResponse.message),$message.text("Please enter a valid email"),_form.element.tween({opacity:0},400,"easeOutCubic"),$message.css({visibility:"visible"}),$message.tween({opacity:1,x:"-50%",y:"-50%"},400,"easeOutCubic",300,()=>{$message.tween({opacity:0,x:"-50%",y:"-50%"},400,"easeOutCubic",3e3,()=>{$message.css({visibility:"hidden"}),_form.element.tween({opacity:1},400,"easeOutCubic")})})):(Account.instance().login(value),ViewController.instance().transition("SuccessView"))}function onResize(){_title.x=Stage.width/2,_title.y=Stage.height/2-40*_title.scale,_link.x=Stage.width/2,_link.y=Stage.height/2+100*_link.scale,_footer.resize()}!async function(){await Data.ready(),await function initHTML(){_this.$dom=_this.initClass(Element),_this.$dom.element.css({visibility:"hidden"}).size("100%").setZ(100),Stage.add(_this.$dom.element)}(),await function initTitle(){_title=_this.initClass(UITitle,Data.COPY.landingTitle,{width:600}),_this.glui.add(_title.element),_this.elements.push(_title)}(),await function initForm(){($formContainer=_this.$dom.element.create("form")).center().transform({x:"-50%",y:"-50%"}),$formContainer.css({marginTop:"6rem"}),(_form=_this.initClass(DOMFormInline,{placeholder:"Email",button:"Login >",onSubmit:handleFormSubmit,regex:Regex.EMAIL,required:!0},[$formContainer])).element.css({position:"relative"}),($message=$formContainer.create("message")).fontStyle(UI.FONT_TERTIARY,"1.6rem",Colors.instance().getColor("WHITE")).css({textTransform:"uppercase",width:"100%",textAlign:"center",opacity:0}),$message.center().transform({x:"-50%",y:"-50%"})}(),await function initLink(){_link=_this.initClass(UILink,Data.COPY.regCreate,{fontSize:8,onClick:handleLinkClick,width:230}),_this.glui.add(_link.element),_this.elements.push(_link)}(),await async function initFooter(){_footer=_this.initClass(UIFooter,_this,_this.glui),await _footer.ready(),_this.elements.push(_footer.privacy),_this.elements.push(_footer.information)}(),function addHandlers(){_this.onResize(onResize)}(),"LoginView"===Global.PLAYGROUND&&(_this.visible=!0,GLUI.Stage.add(_this.glui)),_this.onResizeDelayed(onResize)}(),_this.animateIn=function(){Track.page("/register/existing","Register Existing")},_this.animateOut=function(){return Promise.resolve()}})),Class((function ModalView(){Inherit(this,GameView,{audio:!1,logo:"left"});const _this=this;var $image,_close,_returnPath,_returnData;function onResize(){$image.scale=DOMResize.instance().scale,$image.x=Stage.width/2-$image.width/2,$image.y=Stage.height/2-$image.height/2,_close.x=Stage.width-_close.width-30*_close.scale,_close.y=30*_close.scale}!async function(){await Data.ready(),function initImage(){$image=$gl(433,243,"assets/images/ui/help.jpg"),_this.glui.add($image)}(),function initClose(){_close=_this.initClass(UIClose,{onClick:_=>{_this.events.fire(ModalView.CLOSED),ViewController.instance().transition(_returnPath,_returnData)}}),_this.glui.add(_close.element),_this.elements.push(_close)}(),function addHandlers(){_this.onResize(onResize)}(),await _close.ready(),"ModalView"===Global.PLAYGROUND&&(_this.visible=!0,GLUI.Stage.add(_this.glui)),_this.flag("initialized",!0),_this.onResizeDelayed(onResize)}(),_this.animateIn=function(){_this.events.fire(ModalView.OPEN)},_this.set("data",async data=>{if(await _this.wait(_this,"initialized"),Track.page("/modal/"+data.track.toLowerCase().split(" ").join("-"),"Modal "+data.track),data.img){let texture=Utils3D.getTexture(data.img,{premultiplyAlpha:!1});$image.shader.uniforms.tMap.value=texture}_returnPath=data.returnPath,_returnData=data.returnData}),_this.animateOut=function(){return Promise.resolve()}}),()=>{ModalView.OPEN="modal_view_open",ModalView.CLOSED="modal_view_closed"}),Class((function RedeemView(){Inherit(this,GameView,{audio:!1,logo:"left"});const _this=this;var _title,_subtitle,_form,_link,_description,_close,_footer,$formContainer,$message;async function handleFormSubmit(value){console.log("Redeem",value);const redeemResponse=await Api.redeemUPC(value);if(console.log(redeemResponse),redeemResponse.success&&!1!==redeemResponse.success){let displayMessage;!0===redeemResponse.winner?displayMessage=Data.COPY.redeemSuccess:null===redeemResponse.winner?displayMessage=Data.COPY.redeemLimited:!1===redeemResponse.winner&&(displayMessage=Data.COPY.redeemInvalid),!1!==redeemResponse.winner?(Track.page("/register/redeemed","Redeemed"),showMessage(displayMessage,!0)):showMessage(displayMessage)}else showMessage("This code may not be valid or has already been redeemed. Please try another code")}function showMessage(message,isSuccess=!1){$message.text(message),_form.element.tween({opacity:0},400,"easeOutCubic"),_form.clear(),$message.css({visibility:"visible"}),$message.tween({opacity:1,x:"-50%",y:"-50%"},400,"easeOutCubic",300,()=>{$message.tween({opacity:0,x:"-50%",y:"-50%"},400,"easeOutCubic",3e3,()=>{isSuccess?ViewController.instance().transition("SuccessView",{redeemed:!0}):($message.css({visibility:"hidden"}),_form.element.tween({opacity:1},400,"easeOutCubic"))})})}function onResize(){_title.x=Stage.width/2,_title.y=Stage.height/2-140*_title.scale,_subtitle.x=Stage.width/2,_subtitle.y=Stage.height/2-65*_subtitle.scale,_link.x=Stage.width/2,_link.y=Stage.height/2+45*_link.scale,_description.x=Stage.width/2,_description.y=Stage.height/2+85*_description.scale,_close.x=Stage.width-_close.width-30*_close.scale,_close.y=30*_close.scale,_footer.resize()}!async function(){await Data.ready(),await function initHTML(){_this.$dom=_this.initClass(Element),_this.$dom.element.css({color:Colors.instance().getColor("WHITE"),visibility:"hidden"}).size("100%").setZ(100),Stage.add(_this.$dom.element)}(),await function initTitle(){_title=_this.initClass(UITitle,Data.COPY.redeemTitle,{fontSize:15,width:600}),_this.glui.add(_title.element),_this.elements.push(_title)}(),await function initSubtitle(){_subtitle=_this.initClass(UIDescription,Data.COPY.redeemSubtitle),_this.glui.add(_subtitle.element),_this.elements.push(_subtitle)}(),await function initForm(){($formContainer=_this.$dom.element.create("form")).center().transform({x:"-50%",y:"-50%"}),(_form=_this.initClass(DOMFormInline,{placeholder:"UPC Code",button:"Submit >",required:!0,onSubmit:handleFormSubmit},[$formContainer])).element.css({position:"relative"}),($message=$formContainer.create("message")).fontStyle(UI.FONT_TERTIARY,"1.6rem",Colors.instance().getColor("WHITE")).css({textTransform:"uppercase",width:"100%",textAlign:"center",opacity:0}),$message.center().transform({x:"-50%",y:"-50%"})}(),await function initLink(){_link=_this.initClass(UILink,Data.COPY.redeemHelp,{color:Colors.instance().getColor("AQUA"),onClick:_=>ViewController.instance().transition("ModalView",{img:"assets/images/ui/help.jpg",track:"Redeem Help",returnPath:"RedeemView"})}),_this.glui.add(_link.element),_this.elements.push(_link)}(),await function initDescription(){_description=_this.initClass(UIDescription,Data.COPY.redeemDesc,{width:400}),_this.glui.add(_description.element),_this.elements.push(_description)}(),await function initClose(){_close=_this.initClass(UIClose,{onClick:_=>ViewController.instance().transition("LandingView")}),_this.glui.add(_close.element),_this.elements.push(_close)}(),await async function initFooter(){_footer=_this.initClass(UIFooter,_this,_this.glui),await _footer.ready(),_this.elements.push(_footer.privacy),_this.elements.push(_footer.information)}(),function addHandlers(){_this.onResize(onResize)}(),await _description.ready(),"RedeemView"===Global.PLAYGROUND&&(_this.visible=!0,GLUI.Stage.add(_this.glui)),_this.onResizeDelayed(onResize)}(),_this.animateIn=function(){Track.page("/register/redeem","Redeem")},_this.animateOut=function(){return Promise.resolve()}})),Class((function RedeemViewHelp(){Inherit(this,GameView,{audio:!1,logo:"left"});const _this=this;var $image,_close;function onResize(){$image.scale=DOMResize.instance().scale,$image.x=Stage.width/2-$image.width/2,$image.y=Stage.height/2-$image.height/2,_close.x=Stage.width-_close.width-30*_close.scale,_close.y=30*_close.scale}!async function(){await Data.ready(),function initImage(){$image=$gl(433,243,"assets/images/ui/help.jpg"),_this.glui.add($image)}(),function initClose(){_close=_this.initClass(UIClose,{onClick:_=>ViewController.instance().transition("RedeemView")}),_this.glui.add(_close.element),_this.elements.push(_close)}(),function addHandlers(){_this.onResize(onResize)}(),await _close.ready(),"RedeemViewHelp"===Global.PLAYGROUND&&(_this.visible=!0,GLUI.Stage.add(_this.glui)),_this.onResizeDelayed(onResize)}(),_this.animateIn=function(){},_this.animateOut=function(){return Promise.resolve()}})),Class((function RegistrationView(){Inherit(this,GameView,{audio:!1,logo:"left"});const _this=this;var $box,$scroll,$wrapper,$form,$header,$headerTitle,$headerDescription,$headerLink,_headerTitle,_headerDescription,_headerLink,$personal,$personalFields,$address,$addressTitle,$addressDescription,$addressFields,_addressTitle,_addressDescription,$walmart,$walmartTitle,$walmartFields,_walmartTitle,$finalCheckboxes,$checkboxFields,$footer,$footerButton,_footerButton,$feedback,_feedback,_close,_scroll={current:0,target:0,lerp:.15},_data={},_fields=[],_fieldsRadios=[];const FIELDS_PERSONAL=[{label:"first_name",placeholder:"First Name",regex:Regex.NAME,required:!0,type:"text"},{label:"last_name",placeholder:"Last Name",regex:Regex.NAME,required:!0,type:"text"},{label:"email",placeholder:"Email",regex:Regex.EMAIL,required:!0,size:"full",type:"email"}],FIELDS_ADDRESS=[{label:"address1",placeholder:"Street",required:!0,size:"full",type:"text"},{label:"address2",placeholder:"Apt, Suite or Unit",type:"text"},{label:"city",placeholder:"City",required:!0,type:"text"},{label:"state",placeholder:"State",required:!0,type:"select",options:Object.keys({AL:"Alabama",AK:"Alaska",AS:"American Samoa",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",DC:"District Of Columbia",FM:"Federated States Of Micronesia",FL:"Florida",GA:"Georgia",GU:"Guam",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MH:"Marshall Islands",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",MP:"Northern Mariana Islands",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PW:"Palau",PA:"Pennsylvania",PR:"Puerto Rico",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VI:"Virgin Islands",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"}).map(key=>({label:key,value:key}))},{label:"zip",placeholder:"ZIP",regex:Regex.ZIP,required:!0,type:"text"}],FIELDS_WALMART=[{label:"Yes",value:"Yes",id:"walmart"},{label:"No",value:"No",id:"walmart"}],FIELDS_CHECKBOXES=[{label:Data.COPY.regAge,value:"Yes",id:"age",size:"full",splitLast:!0},{label:Data.COPY.regOptIn,value:"Yes",id:"primary_opt_in",size:"full",required:!1}];function onInputFocusChange(e){switch(e.action){case"in":Device.mobile&&(_this.flag("inputFocused",!0),_this.elements.forEach(el=>{el.element.alpha=0}));break;case"out":Device.mobile&&_this.delayedCall(()=>{_this.elements.forEach(el=>{el.element.alpha=1}),_this.flag("inputFocused",!1)},2e3)}}function onResize(){if(_this.flag("inputFocused")&&Device.mobile&&Stage.height<Stage.width)return;if(_this.flag("isVisible")&&Device.mobile&&Stage.height>Stage.width)return void $box.css({opacity:0,visibility:"none"});_this.flag("isVisible")&&$box.css({opacity:1,visibility:"visible"});let{scrollTop:scrollTop}=_this.$dom.element.div;_headerTitle.x=Stage.width/2,_headerTitle.yOrigin=-$headerTitle.div.getBoundingClientRect().top+scrollTop,_headerDescription.x=Stage.width/2,_headerDescription.yOrigin=-$headerDescription.div.getBoundingClientRect().top+scrollTop,_headerLink.x=Stage.width/2,_headerLink.yOrigin=-$headerLink.div.getBoundingClientRect().top+scrollTop,_addressTitle.x=Stage.width/2,_addressTitle.yOrigin=-$addressTitle.div.getBoundingClientRect().top+scrollTop,_addressDescription.x=Stage.width/2,_addressDescription.yOrigin=-$addressDescription.div.getBoundingClientRect().top+scrollTop,_walmartTitle.x=Stage.width/2,_walmartTitle.yOrigin=-$walmartTitle.div.getBoundingClientRect().top+scrollTop,_footerButton.x=Stage.width/2,_footerButton.yOrigin=-$footerButton.div.getBoundingClientRect().top+scrollTop,_feedback.x=Stage.width/2,_feedback.yOrigin=-$feedback.div.getBoundingClientRect().top+scrollTop,$scroll.css({height:$box.div.clientHeight})}function handleScroll(){let{scrollTop:scrollTop}=_this.$dom.element.div;_scroll.target=scrollTop}function loop(){_this.flag("inputFocused")||Device.mobile&&Stage.height>Stage.width||(_scroll.current=Math.lerp(_scroll.target,_scroll.current,_scroll.lerp),$box.transform({y:-_scroll.current}),_headerTitle.element.group.position.y=_headerTitle.yOrigin+_scroll.current,_headerDescription.element.group.position.y=_headerDescription.yOrigin+_scroll.current,_headerLink.element.group.position.y=_headerLink.yOrigin+_scroll.current,_addressTitle.element.group.position.y=_addressTitle.yOrigin+_scroll.current,_addressDescription.element.group.position.y=_addressDescription.yOrigin+_scroll.current,_walmartTitle.element.group.position.y=_walmartTitle.yOrigin+_scroll.current,_footerButton.element.group.position.y=_footerButton.yOrigin+_scroll.current,_feedback.element.group.position.y=_feedback.yOrigin+_scroll.current,ScreensBackground.instance().onScroll(_scroll.current))}function handleWalmartChange({name:name,value:value}){_data[name]="Yes"===value?1:0,_fieldsRadios.forEach(field=>{field.name===name&&field.check()})}function handleLogin(){Track.event("Register","click","already-registered"),ViewController.instance().transition("LoginView")}async function handleSubmit(){let isValid=!0;if(_fields.forEach(field=>{"radio"===field.type?field.checked&&(_data[field.name]=field.value):(field.isValid||(isValid=!1),_data[field.name]=field.value)}),_data.walmart||0===_data.walmart||1===_data.walmart||(isValid=!1,_fieldsRadios.forEach(field=>{field.name.includes("walmart")&&field.check(!0)})),_data.age||(isValid=!1,_fieldsRadios.forEach(field=>{"age"==field.name&&field.check(!0)}),$feedback.text(Data.COPY.regAgeError),_feedback.setText(Data.COPY.regAgeError),_feedback.animateIn()),void 0!==_data.not_bot&&1!==_data.not_bot&&(isValid=!1,_fieldsRadios.forEach(field=>{"not_bot"===field.name&&field.check(!0)})),NaN===Number(_data.zip)?isValid=!1:_data.zip=Number(_data.zip),isValid){$feedback.text(""),_feedback.setText(""),_feedback.animateOut(),Track.event("Register","click","submit"),delete _data.not_bot;const createResponse=await Api.createProfile(_data);await Api.login(_data.email),Api.PROFILE.webkey&&Api.PROFILE.gameplays&&createResponse.result?(Account.instance().login(_data.email),ViewController.instance().transition("SuccessView")):($feedback.text(Data.COPY.regAlready),_feedback.setText(Data.COPY.regAlready),_feedback.animateIn())}}Config.BOT&&FIELDS_CHECKBOXES.push({label:"I am not a robot",value:1,id:"not_bot",size:"full",required:!0}),async function(){await Data.ready(),await function initHTML(){_this.$dom=_this.initClass(Element),_this.$dom.element.css({color:Colors.instance().getColor("WHITE"),overflow:"auto",visibility:"hidden"}).size("100%").setZ(100),Stage.add(_this.$dom.element)}(),await function initWrapper(){($box=_this.$dom.element.create("Box")).css({color:Colors.instance().getColor("WHITE"),display:"flex",overflow:"hidden",pointerEvents:"none",position:"fixed",width:"100%"}).setZ(100),($wrapper=$box.create("Wrapper")).css({margin:"auto",padding:"7rem 0",position:"static",width:"39.7rem"}),($scroll=_this.$dom.element.create("Scroll")).css({position:"relative"})}(),await function initHeader(){($header=$wrapper.create("Header","header")).css({position:"static"}),($headerTitle=$header.create("Header__Title","h1")).text(Data.COPY.regTitle),$headerTitle.css({height:"5.7rem",marginBottom:"3rem",marginTop:0,opacity:0,position:"static"}),_headerTitle=_this.initClass(UITitle,Data.COPY.regTitle,{fontSize:16,width:410}),_this.glui.add(_headerTitle.element),_this.elements.push(_headerTitle),($headerDescription=$header.create("Header__Description","p")).text(Data.COPY.regDesc),$headerDescription.css({height:"4rem",margin:0,opacity:0,position:"static"}),_headerDescription=_this.initClass(UIDescription,Data.COPY.regDesc,{width:410}),_this.glui.add(_headerDescription.element),_this.elements.push(_headerDescription),($headerLink=$header.create("Header__Link","button")).attr("type","button"),$headerLink.css({height:"2rem",margin:"3rem 0 0",opacity:0,padding:0,position:"static"}),_headerLink=_this.initClass(UILink,Data.COPY.regAlready,{onClick:handleLogin}),_this.glui.add(_headerLink.element),_this.elements.push(_headerLink)}(),await function initForm(){($form=$wrapper.create("Form","form")).attr("autocomplete","off"),$form.css({marginTop:"2rem",position:"static"}),function initFormPersonal(){($personal=$form.create("Form__Personal")).css({position:"static"}),($personalFields=$personal.create("Form__Personal__Fields")).css({display:"flex",flexWrap:"wrap",justifyContent:"space-between",position:"static",width:"39.7rem"}),FIELDS_PERSONAL.forEach(field=>{let $personalField=_this.initClass(DOMInput,{...field},[$personalFields]);_fields.push($personalField)})}(),function initFormAddress(){($address=$form.create("Form__Address")).css({marginTop:"3rem",position:"static"}),($addressTitle=$address.create("Form__Address__Title","h2")).text(Data.COPY.regMailing),$addressTitle.css({height:"2.7rem",margin:0,opacity:0,position:"static"}),_addressTitle=_this.initClass(UITitle,Data.COPY.regMailing,{fontSize:16}),_this.glui.add(_addressTitle.element),_this.elements.push(_addressTitle),($addressDescription=$address.create("Form__Address__Description","p")).text(Data.COPY.regMailingSubtitle),$addressDescription.css({height:"1.3rem",margin:0,marginTop:"1.5rem",opacity:0,position:"static"}),_addressDescription=_this.initClass(UIDescription,Data.COPY.regMailingSubtitle,{width:"41rem"}),_this.glui.add(_addressDescription.element),_this.elements.push(_addressDescription),($addressFields=$address.create("Form__Address__Fields")).css({display:"flex",flexWrap:"wrap",justifyContent:"space-between",marginTop:"2rem",position:"static",width:"39.7rem"}),FIELDS_ADDRESS.forEach(field=>{let $addressField;$addressField="text"==field.type?_this.initClass(DOMInput,{...field},[$addressFields]):_this.initClass(DOMSelect,{...field},[$addressFields]),_fields.push($addressField)})}(),function initFormWalmart(){($walmart=$form.create("Form__Walmart")).css({marginTop:"3rem",position:"static"}),($walmartTitle=$walmart.create("Form__Walmart__Title","h2")).text(Data.COPY.regShop),$walmartTitle.css({height:"1.3rem",margin:0,fontWeight:"normal",opacity:0,position:"static"}),_walmartTitle=_this.initClass(UIDescription,Data.COPY.regShop,{width:"41rem"}),_this.glui.add(_walmartTitle.element),_this.elements.push(_walmartTitle),($walmartFields=$walmart.create("Form__Walmart__Fields")).css({display:"flex",flexWrap:"wrap",justifyContent:"space-between",marginTop:"1rem",position:"static",width:"39.7rem"}),FIELDS_WALMART.forEach(field=>{let $walmartField=_this.initClass(DOMRadio,{...field,onChange:handleWalmartChange},[$walmartFields]);_fieldsRadios.push($walmartField)})}(),function initFormCheckboxes(){($finalCheckboxes=$form.create("Form__Checkboxes")).css({marginTop:"3rem",position:"static"}),($checkboxFields=$finalCheckboxes.create("Form__Checkboxes__Fields")).css({display:"flex",flexDirection:"column",justifyContent:"space-between",marginTop:"1rem",position:"static",width:"39.7rem"}),FIELDS_CHECKBOXES.forEach(field=>{let $checkboxField=_this.initClass(DOMRadio,{...field,onClick:({name:name,value:value})=>{_data[name]=!0===value?1:0}},[$checkboxFields]);_fieldsRadios.push($checkboxField)})}(),function initFormButton(){($footer=$form.create("Form__Footer")).css({marginTop:"3rem",position:"static"}),($footerButton=$footer.create("Form__F ooter__Button","button")).css({display:"block",height:"4rem",marginTop:"3rem",opacity:0,position:"static"}),window._CONFIG_&&window._CONFIG_.CAPTCHA&&$footerButton.attr("disabled",window._CONFIG_.CAPTCHA.score<.4?"true":"false");_footerButton=_this.initClass(UIButton,Data.COPY.regSubmit,{color:Colors.instance().getColor("MAGENTA"),onClick:handleSubmit}),_this.glui.add(_footerButton.element),_this.elements.push(_footerButton)}()}(),await function initClose(){_close=_this.initClass(UIClose,{onClick:_=>ViewController.instance().transition("LandingView")}),_this.glui.add(_close.element),_this.elements.push(_close)}(),await function initFeedbackMessage(){($feedback=$form.create("feedback","h2")).text(""),$feedback.css({height:"1.3rem",margin:0,marginTop:"3rem",fontWeight:"normal",opacity:0,position:"static"}),_feedback=_this.initClass(UILabel,"",{width:"41rem",color:Colors.instance().getColor("RED")}),_this.glui.add(_feedback.element),_this.elements.push(_feedback)}(),function addHandlers(){_this.$dom.element.bind("scroll",handleScroll),_this.onResize(onResize),_this.events.sub(DOMInput.FOCUS_CHANGE,onInputFocusChange)}(),_this.startRender(loop),await _footerButton.ready(),"RegistrationView"===Global.PLAYGROUND&&(_this.visible=!0,GLUI.Stage.add(_this.glui)),_this.onResizeDelayed(_=>{onResize(),_this.startRender(loop)})}(),_this.animateIn=function(){Track.page("/register","Register"),$box.div.scrollTop=0},_this.animateOut=function(){return Promise.resolve()}})),Class((function CompleteView(){Inherit(this,GameView,{logo:"left",audio:!0});const _this=this;var _prizesView,_resultsView,_play,_shareLabel,_buy,_fb,_twitter,_footer,_toggle;async function onResize(){_play.x=Stage.width/2,_play.y=Stage.height-75*_play.scale,_buy.x=65*_buy.scale,_buy.y=Stage.height-75*_buy.scale,_twitter.x=Stage.width-35*_twitter.scale,_twitter.y=Stage.height-63*_twitter.scale,_fb.x=_twitter.x-50*_fb.scale,_fb.y=_twitter.y,_shareLabel.x=_fb.x-_fb.width/2*_fb.scale,_shareLabel.y=_fb.y-_fb.height/2*_fb.scale-20*_shareLabel.scale,_footer.resize()}function handleShareClick(type){let url=window.location.origin,trackType=Level.CURRENT+"Prizes";"fb"==type?(Track.event(trackType,"click","share","facebook"),Share.facebook(url)):(Track.event(trackType,"click","share","twitter"),Share.twitter("I wiggled my way through the web with @Trolli_USA and you can too. Just buy a pack and play",url))}!async function(){await Data.ready(),function initResults(){_resultsView=_this.initClass(ResultsView),_this.glui.add(_resultsView.element),_this.elements.push(_resultsView)}(),function initPrizes(){_prizesView=_this.initClass(PrizesView),_this.glui.add(_prizesView.element),_this.elements.push(_prizesView)}(),function initToggle(){_toggle=_this.initClass(UIToggle,{options:[{label:"Results",value:"ResultsView",cb:()=>{tween(_resultsView.element,{alpha:1},300,"easeOutCubic"),_resultsView.animateIn(),tween(_prizesView.element,{alpha:.001},300,"easeOutCubic")}}],color:Colors.instance().getColor("AQUA")})}(),await function initPlayAgain(){_play=_this.initClass(UIButton,Global.ALL_UNLOCKED?"REPLAY A LEVEL":Data.COPY.selectCtaRepeat,{color:Colors.instance().getColor("AQUA"),width:240,onClick:()=>{Track.event(Level.CURRENT+"Prizes","click","play-next"),ViewController.instance().clearLevel(_this.data.level),ViewController.instance().transition("SelectionView")}}),_this.glui.add(_play.element),_this.elements.push(_play)}(),await function initBuy(){_buy=_this.initClass(UIButton,"Buy now",{color:Colors.instance().getColor("MAGENTA"),width:100,onClick:()=>{Track.event(Level.CURRENT+"Prizes","click","buy-now"),window.open("https://www.trolli.com/where-to-buy.html","_blank")}}),_this.glui.add(_buy.element),_this.elements.push(_buy)}(),await function initShare(){_fb=_this.initClass(UIIconButton,{color:Colors.instance().getColor("MAGENTA"),height:39,width:39,imageHeight:20,imageWidth:10,src:"assets/images/ui/facebook.png",onClick:()=>{handleShareClick("fb")}}),_this.glui.add(_fb.element),_this.elements.push(_fb),_twitter=_this.initClass(UIIconButton,{color:Colors.instance().getColor("AQUA"),height:39,width:39,imageHeight:15,imageWidth:20,src:"assets/images/ui/twitter.png",onClick:()=>{handleShareClick("twitter")}}),_this.glui.add(_twitter.element),_this.elements.push(_twitter),_shareLabel=_this.initClass(UILabel,Data.COPY.completeShare,{align:"left",fontSize:8,lineHeight:1.4,color:Colors.instance().getColor("MAGENTA")}),_this.glui.add(_shareLabel.element),_this.elements.push(_shareLabel)}(),await async function initFooter(){_footer=_this.initClass(UIFooter,_this,_this.glui),await _footer.ready(),_this.elements.push(_footer.privacy),_this.elements.push(_footer.information)}(),await _footer.ready(),function addHandlers(){_this.onResize(onResize)}(),"CompleteView"===Global.PLAYGROUND&&(_this.data={coins:200,level:"LevelGummiLeaks",prize:{success:!0,winner:!0,reward:"a digital edition of Concrete Genie",msg:"winner"},success:!0,time:1e3},_resultsView.setData(_this.data),GLUI.Stage.add(_this.glui),_this.visible=!0,_this.animateIn(),_this.elements.forEach((child,index)=>{child.enableInteractions&&child.enableInteractions()})),_this.flag("isReady",!0)}(),_this.onActive=async function(){_footer.setReturnData(_this.data),_resultsView.setData(_this.data)},_this.animateIn=async function(){_this.onResizeDelayed(onResize),_this.showDOM(),ScreensBackground.instance().enable(),await ScreensBackground.instance().ready(),ScreensBackground.instance().animateIn(),_toggle.animateIn(),_toggle.enableInteractions(),_this.elements.forEach((child,index)=>{child.animateIn&&child.animateIn()}),tween(_resultsView.element,{alpha:1},300,"easeOutCubic"),_resultsView.animateIn(),_prizesView.element.alpha=.001},_this.animateOut=function(){return ScreensBackground.instance().animateOut(),_toggle.select(0),_toggle.animateOut(),_this.elements.forEach((child,index)=>{child.animateOut&&child.animateOut()}),Promise.resolve()}})),Class((function PrizesView(){Inherit(this,GLUIComponent);const _this=this,SCORING=require("Scoring");var _isPlayground,_message,_item,_endedGame,_endedGameAuxiliar,_endedGameLink,_sweepsToDisplay,_levelsConfig,_canAwardSweeps=!1;function handleEndedGameLink(){Track.event(Level.CURRENT+"End","click","prizes-trolli-link"),window.open("https://www.trolli.com/","_blank")}async function onResize(){_this.element.width=Stage.width,_this.element.height=Stage.height,_this.elements.forEach(element=>element.resize());let midWidth=Stage.width/2,midHeight=Stage.height/2;_endedGame.element.x=midWidth,_endedGame.element.y=midHeight-70*_endedGame.scale,_endedGameAuxiliar.element.x=midWidth,_endedGameAuxiliar.element.y=_endedGame.element.y+100*_endedGame.scale,_endedGameLink.element.x=midWidth+163*_endedGame.scale,_endedGameLink.element.y=_endedGame.element.y+100*_endedGame.scale}function onLevelComplete(){_canAwardSweeps=!0}_this.elements=[],async function(){_this.element.width=Stage.width,_this.element.height=Stage.height,_isPlayground="PrizesView"===Global.PLAYGROUND,await Data.ready(),_this.data={level:"LevelGummiLeaks",coins:275,entries:5,prize:{result:""},time:42e4},await async function initEndendGame(){_endedGame=_this.initClass(UIDescription,"The Deliciously Dark Escape sweepstakes \n ended at 11:59pm ET on 12/31. \n Codes can be redeemed through 3/31/21.",{align:"center",fontSize:8,lineHeight:3,fontFamily:UI.FONT_TERTIARY}),_endedGameAuxiliar=_this.initClass(UIDescription,"Check out what else we have going on at                   ",{align:"center",fontSize:8,lineHeight:3,fontFamily:UI.FONT_TERTIARY}),_this.element.add(_endedGame.element),_this.elements.push(_endedGame),_this.element.add(_endedGameAuxiliar.element),_this.elements.push(_endedGameAuxiliar)}(),await async function initEndendGameLink(){_endedGameLink=_this.initClass(UILink,"trolli.com!",{color:Colors.instance().getColor("MAGENTA"),fontSize:8,onClick:handleEndedGameLink}),_this.element.add(_endedGameLink.element),_this.elements.push(_endedGameLink),await _endedGameLink.ready()}(),function addHandlers(){_this.onResize(onResize),_this.events.sub(Level.COMPLETE,onLevelComplete)}(),_isPlayground&&(GLUI.Stage.add(_this.element),_this.visible=!0,_this.animateIn(),_this.elements.forEach((child,index)=>{child.enableInteractions&&child.enableInteractions()})),_levelsConfig=Data.LEVELS,_this.flag("isReady",!0)}(),_this.setData=async function(data){_this.data=data;const getPrize=_this.data.prize;if(getPrize){let displayCopy=function checkPrizeResult(iwPrizeResponse){let displayMessage;return!0===iwPrizeResponse.winner?displayMessage=Data.COPY.completePrizeWin.replace("{PRIZE}",iwPrizeResponse.reward):null===iwPrizeResponse.winner?displayMessage=Data.COPY.completePrizeLimited:!1===iwPrizeResponse.winner&&(displayMessage=Data.COPY.completePrizeLose),displayMessage}(getPrize);_message.setText(displayCopy)}else _message.setText(Data.COPY.completeUnregistered);getPrize&&getPrize.reward&&"a Trolli Coupon"==getPrize.reward?await async function initItem(){(_item=_this.initClass(UIIcon,{width:33.75,height:45,src:"assets/images/ui/bag.png"})).element.alpha=0,_this.element.add(_item.element),_this.elements.push(_item)}():getPrize&&getPrize.reward&&getPrize.reward},_this.animateIn=async function(){await _this.wait(_this,"isReady"),onResize(),_this.elements.forEach((child,index)=>{child.animateIn&&child.animateIn()});let{route:route,name:name}=Config.TRACK_LEVEL[_this.data.level];Track.page(`/level/${route}/prizes`,`Level ${name} Prizes`);let level=_levelsConfig[Config.CMS_LEVEL[_this.data.level]],{score:score,time:time,coins:coins,hint:hint,maxCoins:maxCoins}=SCORING.calculate(_this.data.coins,_this.data.time,parseInt(level.levelMinTime),parseInt(level.levelMaxTime),parseInt(level.levelMinCoins),parseInt(level.levelMaxCoins),parseInt(level.levelWeightTime),parseInt(level.levelWeightCoins)),sweepsToAward=2*score;if(_canAwardSweeps){const sweepsResponse=await Api.awardSweeps(sweepsToAward);_sweepsToDisplay=(sweepsResponse.awarded,sweepsResponse.awarded),_canAwardSweeps=!1}_item&&tween(_item.element,{alpha:1},400,"easeOutCubic",1e3),sweepsToAward>0&&0===_sweepsToDisplay||tween(_endedGame,{alpha:1},300,"easeOutCubic",300),_this.events.fire(AudioController.PLAY,{name:"resultsCounter"}),_this.elements.forEach((child,index)=>{child.enableInteractions&&child.enableInteractions()})},_this.animateOut=function(){return tween(_endedGame,{alpha:0},300,"easeOutCubic",0),_this.elements.forEach((child,index)=>{child.animateOut&&child.animateOut()}),Promise.resolve()}})),Class((function ResultsView(){Inherit(this,GLUIComponent);const _this=this,SCORING=require("Scoring"),ICON_DIMENSIONS=[25,25];var _isPlayground,_time,_timeIcon,_coins,_coinsGoal,_coinIcon,_stars,_message,_levelsConfig;function onEnded({name:name}){"results"===name&&_this.events.fire(AudioController.PLAY,{name:"siteMainTrack",type:"track"})}async function onResize(){_this.elements.forEach(element=>element.resize()),_this.element.width=Stage.width,_this.element.height=Stage.height;let midWidth=Stage.width/2,mainElementOffset=Stage.height/2;Stage.width>=2e3?mainElementOffset-=200:Stage.width<2e3&&Stage.width>=1440?mainElementOffset-=150:mainElementOffset-=75,_timeIcon.y=mainElementOffset+2*_timeIcon.scale,_timeIcon.x=midWidth+25*+_timeIcon.scale,_time.x=_timeIcon.x+(ICON_DIMENSIONS[0]*_timeIcon.scale+10*_timeIcon.scale),_time.y=mainElementOffset;let offset=55*_time.scale;_coinIcon.y=mainElementOffset+offset+2*_coinIcon.scale,_coinIcon.x=midWidth+25*+_coinIcon.scale,_coins.y=mainElementOffset+offset,_coins.x=_coinIcon.x+(ICON_DIMENSIONS[0]*_coinIcon.scale+10*_coinIcon.scale),_coinsGoal.y=mainElementOffset+offset+5*_coinsGoal.scale;let coinsWidth=await _coins.width;_coinsGoal.x=_coins.element.x+(coinsWidth+10)*_coins.scale,_stars.element.y=mainElementOffset-_stars.height/2+45*_stars.scale,_stars.element.x=midWidth-_stars.width/2-100*_stars.scale,_message.x=midWidth,_message.y=mainElementOffset+115*_message.scale}_this.elements=[],async function(){_this.element.width=Stage.width,_this.element.height=Stage.height,_isPlayground="ResultsView"===Global.PLAYGROUND,_this.data={level:"LevelGummiLeaks",coins:275,entries:5,prize:!0,time:42e4},await Data.ready(),await async function initStars(){_stars=_this.initClass(UIStars,{size:Device.mobile?50:60,center:!0}),_this.element.add(_stars.element),_this.elements.push(_stars)}(),await async function initTime(){_time=_this.initClass(UICompleteText,"00:00",{align:"left",fontSize:25}),_timeIcon=_this.initClass(UIIcon,{width:ICON_DIMENSIONS[0],height:ICON_DIMENSIONS[1],src:"assets/images/ui/time.png"}),_this.element.add(_timeIcon.element),_this.element.add(_time.element),_this.elements.push(_time),_this.elements.push(_timeIcon)}(),await async function initCoins(){_coins=_this.initClass(UICompleteText,"000",{align:"left",fontSize:25}),_coinsGoal=_this.initClass(UICompleteText,"/000",{align:"left",fontSize:18}),_coinIcon=_this.initClass(UIIcon,{width:ICON_DIMENSIONS[0],height:ICON_DIMENSIONS[1],src:"assets/images/ui/peach.png"}),_this.element.add(_coins.element),_this.element.add(_coinsGoal.element),_this.element.add(_coinIcon.element),_this.elements.push(_coins),_this.elements.push(_coinsGoal),_this.elements.push(_coinIcon)}(),await async function initMessage(){_message=_this.initClass(UILabel,"",{align:"center",fontSize:8}),_this.element.add(_message.element),_this.elements.push(_message)}(),function addHandlers(){_this.events.sub(AudioController.ENDED,onEnded),_this.onResize(onResize)}(),_isPlayground&&(GLUI.Stage.add(_this.element),_this.visible=!0,_this.elements.forEach((child,index)=>{child.enableInteractions&&child.enableInteractions()}),_this.animateIn()),_levelsConfig=Data.LEVELS,_this.flag("initialized",!0)}(),_this.setData=function(data){_this.data=data},_this.animateIn=async function(){await _this.wait(_this,"initialized"),_this.elements.forEach((child,index)=>{child.animateIn&&child.animateIn()}),onResize(),_this.events.fire(AudioController.PLAY,{name:"results",type:"track"});let{route:route,name:name}=Config.TRACK_LEVEL[_this.data.level];Track.page(`/level/${route}/results`,`Level ${name} Results`);let level=_levelsConfig[Config.CMS_LEVEL[_this.data.level]],{score:score,time:time,coins:coins,hint:hint,maxCoins:maxCoins}=SCORING.calculate(_this.data.coins,_this.data.time,parseInt(level.levelMinTime),parseInt(level.levelMaxTime),parseInt(level.levelMinCoins),parseInt(level.levelMaxCoins),parseInt(level.levelWeightTime),parseInt(level.levelWeightCoins));switch(hint){case"congrats":_message.setText(Data.COPY.completeHintCongrats);break;case"coins":_message.setText(Data.COPY.completeHintCoins);break;case"time":_message.setText(Data.COPY.completeHintTime);break;default:_message.setText(Data.COPY.completeHintCongrats)}let text=new Vector3(0,0,0);_time.setText(StringUtils.formatTime(text.x)),tween(text,{x:_this.data.time,y:_this.data.coins,z:maxCoins},2e3,"easeOutCubic",500).onUpdate(_=>{_coins.setText(""+StringUtils.padInt(Math.floor(text.y))),_time.setText(StringUtils.formatTime(text.x)),_coinsGoal.setText("/"+StringUtils.padInt(Math.floor(text.z)))}),_this.events.fire(AudioController.PLAY,{name:"resultsCounter"}),Account.instance().setLevel(_this.data.level,score),_stars.set(score,!1),_this.elements.forEach((child,index)=>{child.enableInteractions&&child.enableInteractions()})},_this.animateOut=async function(){return _this.elements.forEach((child,index)=>{child.animateOut&&child.animateOut()}),Promise.resolve()}})),Class((function SelectionView(){Inherit(this,GameView,{audio:!0,logo:"left"});const _this=this;var _video,_title,_levels,_levelsWidth,_slider,_footer,_pagination,$levels,$container,$element,$wrap,$levelsContainer;function getLevelPosition(level,index){return(level.width+100)*index*level.scale}function getLevelWidth(level){return(level.width+100)*level.scale}function getWidthDiff(){return 1.4*_levels[0].scale*_levels[0].width-_levels[0].width*_levels[0].scale}function onResize(){_slider.jumpTo(0),_title.x=Stage.width/2,_title.y=Math.max(Stage.height/2-167*_title.scale,15),_levelsWidth=30*_title.scale,_levels.forEach((level,index)=>{let $level=$levels[index];$level.x=getLevelPosition(level,index),$level.index=index,_levelsWidth+=getLevelWidth(_levels[0])}),$wrap.height=Stage.height-60,$wrap.width=Stage.width,$wrap.x=Stage.width/2-getLevelWidth(_levels[0])/2+getWidthDiff()/2,$container.width=_levelsWidth,$container.y=Stage.height/2-10*_pagination.scale,_slider.width=getLevelWidth(_levels[0]),_pagination.x=Stage.width/2,_pagination.y=$container.y+135*_pagination.scale,-Stage.width+_levelsWidth,_footer.resize()}function onPress({keyCode:keyCode}){if(_this.flag("isActive"))switch(keyCode){case 39:_slider.next();break;case 37:_slider.prev()}}function handleLevelSelect({index:index}){_this.clicked=!0,ViewController.instance().transition("IntroLevel"+index)}function handleSliderUpdate(e){if(!_this.clicked){if(_this.flag("isActive")){let level=Config.LEVEL_ORDER[e.slide],{name:name}=Config.TRACK_LEVEL[level];Track.event("LevelSelect","view",name)}$levels.forEach(($level,lvlIndex)=>{if(lvlIndex==e.slide){let widthDiff=getWidthDiff();tween($level,{scale:1.4,x:getLevelPosition(_levels[0],lvlIndex)-widthDiff/2},700,"easeOutBack"),_this.flag("isActive")&&_levels[lvlIndex].highlight()}else tween($level,{scale:1,x:getLevelPosition(_levels[0],lvlIndex)},700,"easeOutBack"),_levels[lvlIndex].unHighlight()}),e.slide,_pagination.update(e.slide)}}function handlePaginationChange(e){_slider.moveTo(e.index)}function loop(){}!async function(){$element=$gl(Stage.width,Stage.height),_this.glui.add($element),$element.scale=.9,$element.alpha=1e-4,await Data.ready(),await function initTexture(){let src=Tests.videoTexture()?"assets/videos/levels.mp4":"assets/images/fallback/levels.jpg";(_video=_this.initClass(VideoTexture,src,{autoplay:!1})).start()}(),await function initTitle(){_title=_this.initClass(UITitle,Data.COPY.selectTitle,{fontSize:11,letterSpacing:-.075,width:600}),_this.glui.add(_title.element),_this.elements.push(_title)}(),await function initLevels(){_levelsWidth=30,$levels=[],$levelsContainer=$gl(),_levels=Levels.instance().getList().map((data,index)=>{let $wrap=$gl(),level=_this.initClass(SelectionViewLevel,{...data,index:index,score:Account.instance().getLevel(data.level),title:""+data.title},_video);return $wrap.x=getLevelPosition(level,index),$wrap.add(level.element),$levelsContainer.add($wrap),$levels.push($wrap),_levelsWidth+=getLevelWidth(level),_this.elements.push(level),level})}(),await function initPagination(){$wrap=$gl(Stage.width,Stage.height),$element.add($wrap),($container=$gl(_levelsWidth,200)).y=Stage.height/2,$container.add($levelsContainer),$wrap.add($container),(_slider=_this.initClass(Interaction.Slider,$container,{x:1},{hit:Stage,width:getLevelWidth(_levels[0]),slides:$levels.length})).views=_levels,(_pagination=_this.initClass(SelectionViewPagination)).enableInteractions(),_pagination.update(0),_this.glui.add(_pagination.element),_this.elements.push(_pagination)}(),await async function initFooter(){_footer=_this.initClass(UIFooter,_this,_this.glui),await _footer.ready(),_this.elements.push(_footer.privacy),_this.elements.push(_footer.information)}(),function addHandlers(){_this.onResize(onResize),_this.events.sub(Interaction.Slider.UPDATE,handleSliderUpdate),_this.events.sub(SelectionViewLevel.SELECT,handleLevelSelect),_this.events.sub(SelectionViewPagination.UPDATE,handlePaginationChange),_this.events.sub(Keyboard.UP,onPress)}(),_this.startRender(loop),"SelectionView"===Global.PLAYGROUND&&(_this.visible=!0,_this.animateIn(),GLUI.Stage.add(_this.glui)),_this.onResizeDelayed(onResize)}(),_this.enableInteractions=function(){_this.elements.forEach(el=>{el.enableInteractions&&el.enableInteractions()})},_this.disableInteractions=function(){},_this.onActive=function(){_this.showDOM(),_levels.forEach(level=>{level.onActive()})},_this.animateIn=function(){_this.clicked=!1,_this.flag("isActive",!0),Track.page("/level/select","Level Select"),ScreensBackground.instance().animateOut(),_this.showDOM(),ScreensBackground.instance().shader.tween("uLevelSelect",1,2e3,"easeOutCubic"),$element.scale=.9,$element.alpha=1e-4,$element.tween({scale:1,alpha:1},3e3,"easeOutQuart"),_this.enableInteractions();let index=0;_levels.forEach((level,i)=>{level.locked||(index=i)}),Global.ALL_UNLOCKED=index==_levels.length-1,_slider.jumpTo(index),_this.delayedCall(_levels[index].highlight,200)},_this.animateOut=function(){return _this.flag("isActive",!1),ScreensBackground.instance().shader.tween("uLevelSelect",0,1e3,"easeOutCubic"),_this.disableInteractions(),_levels.forEach(level=>{level.unHighlight()}),Promise.resolve()}})),Global.ALL_UNLOCKED=!1,Class((function SelectionViewLevel({color:color=Colors.instance().getColor("AQUA"),index:index,score:score,title:title="[Area 1] Gummi Leaks",video:video=[0,0]}={},_video){Inherit(this,GLUIComponent,{isScalable:!0});const _this=this;var _title,_focus,$media,_button,$lock,_scoreText,_scoreStars,_isHighlighted=!1,$wrapper=$gl(220,123.75),_color=new Color(color);function checkLocked(){if(0==index)_this.locked=!1;else{let prevScore=getScore(index-1);_this.locked=!prevScore||prevScore<0}}function getScore(levelIndex){let levelData=Levels.instance().getItem(levelIndex);return Account.instance().getLevel(levelData.level)}function onResize(){_scoreStars&&_scoreText&&(_scoreStars.element.x=$media.width/2-_scoreStars.width/2,_scoreStars.element.y=$media.height/2-4*_scoreStars.height-10,_scoreText.x=110,_scoreText.y=_scoreStars.element.y-20*_scoreStars.scale)}function hover(e){switch(e.action){case"over":ScreensBackground.instance().shader.tween("uLevelSelectHover",1,1500,"easeOutCubic"),$wrapper.tween({scale:1.02},300,"easeOutBack"),tween($media.shader.uniforms.uRainbow,{value:1},300,"easeOutBack");break;case"out":ScreensBackground.instance().shader.tween("uLevelSelectHover",0,2e3,"easeOutCubic"),$wrapper.tween({scale:1},500,"easeOutBack"),tween($media.shader.uniforms.uRainbow,{value:0},500,"easeOutBack")}}!async function(){_this.element.add($wrapper),_this.element.alpha=.001,checkLocked(),await async function initMedia(){let shader=_this.initClass(Shader,"SelectionViewLevelShader",{uAlpha:{value:1},uColor:{value:new Color(color)},uPattern:{value:video},uSkip:{value:0},uRainbow:{value:0},uSize:{value:new Vector2(220,123.75)},tVideo:{value:null},transparent:!0});($media=$gl(220,123.75,shader)).useShader(shader),$media.setZ(-1),$media.y=-61.875,$media.shader.set("uPattern",new Vector2(video[0],video[1])),$media.shader.set("tVideo",_video.texture),$wrapper.add($media)}(),await async function initText(){(_title=_this.initClass(UILabel,"Level "+(index+1),{align:"center",color:color,width:180,fontSize:8,isScalable:!1,letterSpacing:.05})).x=110,_title.y=-76.875,_title.z=1,$wrapper.add(_title.element)}(),await async function initFocusText(){(_focus=_this.initClass(UILabel,title,{fontSize:12,width:180,color:"#FFFFFF",font:UI.FONT_ACCENT,lineHeight:1.7,isScalable:!1})).x=110;let height=await _focus.height;_focus.y=-height/2+5,_focus.z=1,$wrapper.add(_focus.element)}(),await async function initButton(){(_button=_this.initClass(UIButton,Data.COPY.selectCta,{background:color,backgroundOpacity:1,color:Colors.instance().getColor("WHITE"),additive:!1,fontSize:9,height:32,isScalable:!1,onClick:_=>_this.events.fire(SelectionViewLevel.SELECT,{index:index}),width:108})).x=110,_button.y=56.875,_button.z=2,$wrapper.add(_button.element)}(),function initLock(){($lock=$gl(20,20,"assets/images/ui/lock.png")).x=$media.width/2-10,$lock.y=-10,$lock.alpha=.001,$wrapper.add($lock)}(),function addHandlers(){_this.events.sub(_button,Events.HOVER,hover),_this.onResize(onResize)}(),"SelectionViewLevel"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,_this.onActive(),GLUI.Stage.add(_this.element)),_this.flag("isReady",!0)}(),_this.set("alpha",async alpha=>{await _this.ready(),_title.alpha=alpha}),_this.get("width",_=>220),_this.onActive=function(){checkLocked(),_this.locked?($lock.alpha=1,$media.shader.set("uSkip",1)):($lock.alpha=0,$media.shader.set("uSkip",0)),score=getScore(index)},_this.animateIn=async function(delay){await _this.ready(),_this.element.tween({alpha:1},200,"easeOutSine",delay),_title.animateIn(delay+300),$media.alpha=.001,$media.scale=1.1,$media.tween({alpha:1,scale:1},400,"easeOutCubic",delay)},_this.animateOut=async function(delay){await _this.ready(),_title.animateOut(delay),$media.alpha=.001,_button.animateOut(delay+200),score&&_scoreStars&&await _scoreText.animateOut(delay),_isHighlighted=!1},_this.highlight=async function(delay=0){_isHighlighted||(await _this.ready(),_isHighlighted=!0,checkLocked(),ScreensBackground.instance().shader.tween("uLevelColor",_color,2e3,"easeOutSine"),_this.locked||(_focus.animateIn(delay+300),_button.animateIn(delay+500)),score&&_scoreStars&&(tween(_scoreStars.element,{alpha:0},200,"easeOutCubic",delay),_scoreText.animateOut(delay)))},_this.unHighlight=async function(delay=0){_isHighlighted&&(await _this.ready(),_isHighlighted=!1,_focus.animateOut(),_button.animateOut(delay+200),score&&_scoreStars&&(tween(_scoreStars.element,{alpha:1},500,"easeOutCubic",delay+200),_scoreText.animateIn(delay)))},_this.enableInteractions=async function(){await _this.wait(_this,"isReady"),_button.enableInteractions()},_this.disableInteractions=async function(){await _this.wait(_this,"isReady"),_button.disableInteractions()}}),_=>{SelectionViewLevel.SELECT="selectionviewlevel_select"}),Class((function SelectionViewPagination(){Inherit(this,GLUIComponent,{isScalable:!0});const _this=this;var $buttons,_batch,_levels=Levels.instance().getList(),width=0,_index=0;function animateButtons(){$buttons.forEach(($button,buttonIndex)=>{let transition=buttonIndex===_index?0:1;tween($button,{scale:buttonIndex===_index?1:.5},400,"easeOutCubic"),tween($button.shader.uniforms.uTransition,{value:transition},400,"easeOutCubic")})}function handleHover(e){switch(e.action){case"over":!function handleHoverOver(e){e.object.tween({alpha:.5},400,"easeOutCubic")}(e);break;case"out":!function handleHoverOut(e){e.object.tween({alpha:1},400,"easeOutCubic")}(e)}}function handleClick(e){e.object.tween({alpha:1},400,"easeOutCubic"),_this.events.fire(SelectionViewPagination.UPDATE,{index:e.object.index})}!async function(){await function initButtons(){_batch=new GLUIBatch,_this.element.add(_batch),$buttons=_levels.map((level,index)=>{let shader=_this.initClass(Shader,"SelectionViewPaginationSquareShader",{uAlpha:{value:1e-4},uBackground:{value:new Color(level.color)},uBackgroundOpacity:{value:1},uSize:{value:new Vector2(22,22)},uTransition:{value:1},transparent:!0}),$button=$gl(22,22,shader);return $button.index=index,$button.scale=.5,$button.x=30*index,$button.useShader(shader),_this.element.add($button),$button}),width=30*_levels.length,_this.element.alpha=0}(),animateButtons(),"SelectionViewPagination"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,_this.animateOut(),_this.animateIn(),_this.enableInteractions(),GLUI.Stage.add(_this.element)),_this.flag("isReady",!0)}(),_this.get("index",_=>_index),_this.get("width",()=>width*_this.scale),_this.set("x",async x=>{await _this.ready(),_this.element.x=x-width*_this.scale/2}),_this.set("y",y=>{_this.element.y=y-11*_this.scale}),_this.ready=async function(){return _this.wait(_this,"isReady")},_this.update=function(index){_index!=index&&(_index=index,animateButtons())},_this.animateIn=async function(delay=0){delay&&await _this.wait(delay),TweenUIL.create(_this.constructorName+"_animateIn",{element:_this.element,buttons:$buttons},null,!0)},_this.animateOut=async function(delay=0){delay&&await _this.wait(delay),TweenUIL.create(_this.constructorName+"_animateOut",{element:_this.element,buttons:$buttons},null,!0)},_this.enableInteractions=async function(){await _this.ready(),$buttons.forEach($button=>{$button.interact(handleHover,handleClick)})},_this.disableInteractions=async function(){await _this.ready(),$buttons.forEach($button=>{$button.clearInteract()})}}),_=>{SelectionViewPagination.UPDATE="selectionviewpagination_change"}),Class((function BasicTransition(){Inherit(this,Component);const _this=this;_this.shader=_this.initClass(Shader,"Transition","BasicTransition",{tFrom:{value:null},tTo:{value:null},uTransition:{value:0},transparent:!0}),this.play=async function(fromView,toView){_this.shader.set("uTransition",0),_this.shader.set("tFrom",fromView),_this.shader.set("tTo",toView),await _this.shader.tween("uTransition",1,1e3,"easeOutCubic").promise()}})),Class((function GlitchTransition(){Inherit(this,Component);const _this=this;_this.shader=_this.initClass(Shader,"Transition","GlitchTransition",{tFrom:{value:null},tTo:{value:null},uTransition:{value:0},transparent:!0}),this.play=async function(fromView,toView){_this.shader.set("uTransition",0),_this.shader.set("tFrom",fromView),_this.shader.set("tTo",toView),_this.delayedCall(_=>_this.shader.set("uTransition",1),GlitchTransition.DELAY/2),await _this.wait(GlitchTransition.DELAY)}}),_=>{GlitchTransition.DELAY=800}),Class((function GlitchVideoTransition(){Inherit(this,Component);const _this=this;!function(){_this.shader=_this.initClass(Shader,"Transition","GlitchVideoTransition",{tFrom:{value:null},tTo:{value:null},uTransition:{value:0},tGlitch:{value:null},transparent:!0});let src=Tests.videoTexture()?"assets/videos/glitch.mp4":"assets/images/fallback/glitch.jpg";_this.video=_this.initClass(VideoTexture,src,{autoplay:!1})}(),this.play=async function(fromView,toView){_this.video.start(),_this.shader.set("uTransition",0),_this.shader.set("tFrom",fromView),_this.shader.set("tTo",toView),_this.shader.set("tGlitch",_this.video.texture),_this.delayedCall(_=>_this.shader.set("uTransition",1),GlitchVideoTransition.DELAY/2),await _this.wait(GlitchVideoTransition.DELAY),_this.video.stop()}}),_=>{GlitchVideoTransition.DELAY=1e3}),Class((function IntroTransition(){Inherit(this,Component);const _this=this;_this.shader=_this.initClass(Shader,"Transition","IntroTransition",{uZoom:{value:0},tFrom:{value:null},tTo:{value:null},uTransition:{value:0},transparent:!0}),this.play=async function(fromView,toView){_this.shader.set("uZoom",1),_this.shader.set("uTransition",0),_this.shader.set("tFrom",fromView),_this.shader.set("tTo",toView),_this.shader.tween("uZoom",4,2e3,"easeInCubic"),await _this.shader.tween("uTransition",1,2e3,"easeInOutCubic").promise()}})),Class((function DOMAudio(){Inherit(this,Element);const $this=this.element;function handleHover(e){switch(e.action){case"over":!function handleHoverOver(){$this.tween({opacity:.5},400,"easeOutCubic")}();break;case"out":!function handleHoverOut(){$this.tween({opacity:1},400,"easeOutCubic")}()}}function handleClick(){$this.div.classList.contains("DOMAudio--Disable")?($this.div.classList.remove("DOMAudio--Disable"),Storage.set("muted",!1),GlobalAudio3D.muted=!1,Track.event("Global","click","audio","unmute")):($this.div.classList.add("DOMAudio--Disable"),Storage.set("muted",!0),GlobalAudio3D.muted=!0,Track.event("Global","click","audio","mute"))}!function initButton(){$this.attr("type","button"),$this.css({display:"flex",height:"1.8rem",justifyContent:"space-between",opacity:0,position:"absolute",right:"3rem",top:"3rem",visibility:"hidden",width:"1.8rem"})}(),function initBars(){for(let i=0;i<5;i++)$this.create("DOMAudio__Bar").css({background:Colors.instance().getColor("WHITE"),height:"1.8rem",position:"relative",width:"0.2rem"})}(),function addHandlers(){$this.interact(handleHover,handleClick)}(),async function initState(){await Storage.get("muted")&&(GlobalAudio3D.muted=!0,$this.div.classList.add("DOMAudio--Disable"))}(),"DOMAudio"===Global.PLAYGROUND&&$this.center(),Stage.add($this),this.animateIn=function(delay){$this.css({visibility:"visible"}),$this.tween({opacity:1},400,"easeOutCubic",delay)},this.animateOut=function(delay){$this.tween({opacity:0},400,"easeOutCubic",delay,_=>{$this.css({visibility:"hidden"})})}}),"singleton"),Class((function DOMButton(_text="Button",{color:color=Colors.instance().getColor("AQUA"),onClick:onClick,width:width="18.8rem"}={}){Inherit(this,Element);const $this=this.element;var $button,$box,$text,$hover;function handleHover(e){switch(e.action){case"over":!function handleHoverOver(){$hover.tween({y:"0%"},400,"easeOutCubic"),$text.tween({color:Colors.instance().getColor("BLACK")},400,"easeOutCubic")}();break;case"out":!function handleHoverOut(){$hover.tween({y:"100%"},400,"easeOutCubic"),$text.tween({color:color},400,"easeOutCubic")}()}}function handleClick(){onClick&&onClick()}$this.css({padding:"0.1rem 0",position:"relative"}),function initButton(){($button=$this.create("DOMButton__Button","button")).attr("type","button"),$button.fontStyle(UI.FONT_TERTIARY,"1.8rem",Colors.instance().getColor("WHITE")).css({alignItems:"center",color:color,display:"flex",height:"3.4rem",justifyContent:"center",padding:"0 2rem",position:"relative",textTransform:"uppercase",width:width}),($text=$button.create("DOMButton__Text")).css({position:"relative",whiteSpace:"nowrap",zIndex:1}),$text.text(_text)}(),function initBox(){$button.create("DOMButton__Background").css({background:color,opacity:.08}).size("100%"),($box=$button.create("DOMButton__Box")).css({boxShadow:"\n                0 -0.2rem 0 0 currentColor,\n                0 0.2rem 0 0 currentColor,\n                -0.2rem 0 0 0 currentColor,\n                0.2rem 0 0 0 currentColor\n            ",overflow:"hidden"}).size("100%")}(),function initHover(){($hover=$box.create("DOMButton__Hover")).css({background:color,zIndex:0}).size("100%").transform({y:"100%"})}(),function addHandlers(){$box.interact(handleHover,handleClick)}(),"DOMButton"===Global.PLAYGROUND&&($this.center().transform({x:"-50%",y:"-50%"}),$button.css({margin:"auto"}))})),Class((function DOMFormInline({button:button="Button",maxlength:maxlength,onSubmit:onSubmit,placeholder:placeholder="Placeholder",regex:regex,required:required}={},wrapper){Inherit(this,Element,null,wrapper);const _this=this,$this=_this.element;var _input;function handleSubmit(){_input.check()&&onSubmit&&onSubmit(_input.value)}$this.css({alignItems:"center",display:"flex",justifyContent:"space-between",width:"39.7rem"}),"DOMFormInline"===Global.PLAYGROUND&&$this.center().transform({x:"-50%",y:"-50%"}),function initInput(){(_input=_this.initClass(DOMInput,{maxlength:maxlength,placeholder:placeholder,required:required,regex:regex,size:"full"})).element.css({marginRight:"1rem"})}(),function initButton(){_this.initClass(DOMButton,button,{color:Colors.instance().getColor("MAGENTA"),onClick:handleSubmit,width:"11.5rem"})}(),_this.get("element",_=>$this),_this.clear=function(){_input.clear()}})),Class((function DOMInput({disabled:disabled,label:label="Label",maxLength:maxLength=64,placeholder:placeholder="Placeholder",regex:regex,required:required,size:size="half",type:type="text"}={}){Inherit(this,Element);const _this=this,$this=_this.element,background="rgba(255, 255, 255, 0.08)";var $input,$border;function handleOver(e){_this.flag("isFocused")||$border.tween({opacity:.25},400,"easeOutCubic")}function handleOut(e){_this.flag("isFocused")||$border.tween({opacity:0},400,"easeOutCubic")}function handleFocus(){_this.flag("isFocused",!0),_this.events.fire(DOMInput.FOCUS_CHANGE,{action:"in"}),$border.tween({opacity:1},400,"easeOutCubic")}function handleBlur(){_this.flag("isFocused",!1),_this.events.fire(DOMInput.FOCUS_CHANGE,{action:"out"}),$border.tween({opacity:0},400,"easeOutCubic")}function handleChange(){_this.valid=_this.isValid}$this.css({margin:"1rem 0",padding:"0.3rem 0",position:"relative",width:"full"===size?"100%":"18.8rem"}),function initInput(){($input=$this.create("DOMInput__Field","input")).attr("aria-labelledby",label+"_label"),$input.attr("name",label),$input.attr("placeholder",`${placeholder}${required?" *":""}`),$input.attr("tabindex","0"),$input.attr("type",type),$input.attr("maxlength",maxLength),"android"==Device.system.os&&$input.attr("autocomplete","off"),disabled&&$input.attr("disabled",disabled),$input.fontStyle(UI.FONT_TERTIARY,"1.6rem",Colors.instance().getColor("WHITE")).css({background:background,boxShadow:`0 -0.6rem 0 -0.3rem ${background}, 0 0.6rem 0 -0.3rem ${background}`,height:"3.4rem",padding:"0 2rem 0.2rem",pointerEvents:"auto",position:"relative",textTransform:"uppercase",width:"100%"})}(),function initBorder(){($border=$this.create("DOMInput__Border")).size("100%").css({borderColor:"#fff",borderStyle:"solid",borderLeftWidth:"0.3rem",borderRightWidth:"0.3rem",boxShadow:"0 -0.3rem 0 -0.15rem #fff, 0 0.3rem 0 -0.15rem #fff",left:0,opacity:0,pointerEvents:"none",top:0})}(),function addHandlers(){$input.bind("mouseenter",handleOver),$input.bind("mouseout",handleOut),$input.bind("focusin",handleFocus),$input.bind("focusout",handleBlur),$input.bind("change",handleChange),$input.bind("input",handleChange)}(),"DOMInput"===Global.PLAYGROUND&&($this.center().transform({x:"-50%",y:"-50%"}),$input.css({margin:"auto"})),_this.get("element",_=>$this),_this.get("type",_=>$input.attr("type")),_this.get("name",_=>$input.attr("name")),_this.get("value",_=>$input.div.value.trim()),_this.get("isValid",_=>{let requiredState=!1;requiredState=!!(required&&_this.value&&_this.value.length>0)||!(required&&(!_this.value||_this.value&&_this.value.length<1));let isValid=!1;return isValid=regex?regex.test(_this.value)&&requiredState:requiredState,isValid?$input.tween({color:Colors.instance().getColor("WHITE")},400,"easeOutCubic"):$input.tween({color:Colors.instance().getColor("RED")},400,"easeOutCubic"),isValid}),_this.check=function(){return _this.isValid},_this.clear=function(){$input.div.value=""}}),()=>{DOMInput.FOCUS_CHANGE="DomInput_focus_change"}),Class((function DOMRadio({checked:checked=!1,label:label="label",onChange:onChange,size:size="half",value:value="Value",id:id="id",onClick:onClick,required:required=!0,splitLast:splitLast=!1}={}){Inherit(this,Element);const _this=this,$this=_this.element;var $label,$bullet,$bulletCheck,$input,$textWrap,$text,_toggled=!1;function handleClick(){_toggled=!_toggled,$input.div.checked=_toggled,_this.value=$input.div.value,_this.check(),onClick&&onClick({name:_this.name,value:$input.div.checked})}function handleChange(){_this.value=$input.div.value.trim(),onChange&&onChange({name:_this.name,value:_this.value}),_this.check()}$this.css({margin:"1rem 0",padding:"0.1rem 0",position:"relative"}),"DOMRadio"===Global.PLAYGROUND&&$this.center().transform({x:"-50%",y:"-50%"}),function initLabel(){($label=$this.create("DOMRadio__Label","label")).fontStyle(UI.FONT_TERTIARY,"1.8rem",Colors.instance().getColor("WHITE")).css({alignItems:"center",color:checked?Colors.instance().getColor("AQUA"):Colors.instance().getColor("WHITE"),cursor:"pointer",display:"flex",justifyContent:"center",padding:"0 2rem",pointerEvents:"auto",position:"relative",width:"full"===size?"39.7rem":"18.8rem"})}(),function initBullet(){($bullet=$label.create("DOMRadio__Bullet","span")).css({background:"rgba(255, 255, 255, 0.08)",borderColor:"currentColor",borderStyle:"solid",borderWidth:"0.2rem",height:"2rem",marginRight:"1rem",width:"2rem"}),($bulletCheck=$bullet.create("DOMRadio__Bullet__Check","span")).css({borderColor:"currentColor",borderStyle:"solid",borderWidth:"0 0 0.2rem 0.2rem",display:"block",height:"0.6rem",left:"50%",opacity:0,pointerEvents:"none",top:"50%",width:"1.2rem"}).transform({rotation:-45,x:"-50%",y:"-80%"})}(),function initInput(){($input=$label.create("DOMRadio__Field","input")).attr("name",id),$input.attr("type","radio"),$input.attr("value",value),$input.css({left:"-99999rem"})}(),function initText(){($textWrap=$label.create("DOMRadio__Text-Wrap","div")).css({position:"relative",display:"flex",flexWrap:"wrap",width:"calc(100% - 4rem)"});let text=label;if(splitLast){let split=text.split(" ");split.forEach((word,index)=>{let $word=$textWrap.create("DOMRadio__Text","span");if($word.text(word),index!=split.length-1){let $space=$textWrap.create("DOMRadio__Text","span");$space.text(" "),$space.css({whiteSpace:"pre"})}else $word.css({color:Colors.instance().getColor("AQUA")}),$word.interact(()=>{},()=>{window.open(Data.COPY.legalLink,"_blank")})})}else($text=$textWrap.create("DOMRadio__Text","span")).css({pointerEvents:"none"}),$text.text(text)}(),function addHandlers(){onChange?($input.bind("input",handleChange),$input.bind("change",handleChange)):onClick&&$bullet.interact(()=>{},handleClick)}(),_this.get("input",_=>$input.div),_this.get("checked",_=>$input.div.checked),_this.get("name",_=>$input.attr("name")),_this.get("type",_=>"radio"),_this.check=function(isEmpty=!1){isEmpty&&required?$label.tween({color:Colors.instance().getColor("RED")},400,"easeOutCubic"):_this.checked?($label.tween({color:Colors.instance().getColor("AQUA")},400,"easeOutCubic"),$bulletCheck.tween({opacity:1,rotation:-45,x:"-50%",y:"-80%"},400,"easeOutCubic")):($label.tween({color:Colors.instance().getColor("WHITE")},400,"easeOutCubic"),$bulletCheck.tween({opacity:0,rotation:-45,x:"-50%",y:"-80%"},400,"easeOutCubic"))}})),Class((function DOMScrollFeedback(_element){Inherit(this,Element);const _this=this,$this=_this.element;var $block,_transform;function loop(){let{scrollTop:scrollTop,scrollHeight:scrollHeight}=_element.div,percent=Math.map(scrollTop,0,scrollHeight-Stage.height,0,1);$block.transform({y:_transform*percent})}$this.css({height:"calc(100% - 9rem - 5rem)",right:"3.75rem",top:"9rem",width:"1rem"}),_this.delayedCall(_=>{!function initBlock(){($block=$this.create("DOMScrollFeedback__Block")).css({background:Colors.instance().getColor("WHITE"),height:150,left:0,opacity:.1,top:0,width:"100%"}),_transform=$this.div.clientHeight-150}(),_this.startRender(loop)},100),_this.enable=function(){},_this.disable=function(){}})),Class((function DOMSelect({disabled:disabled,label:label="Label",maxLength:maxLength=64,placeholder:placeholder="Placeholder",regex:regex,required:required,size:size="half",type:type="text",options:options=[]}={}){Inherit(this,Element);const _this=this,$this=_this.element,background="rgba(255, 255, 255, 0.08)";var $input,$border;function handleOver(e){_this.flag("isFocused")||$border.tween({opacity:.25},400,"easeOutCubic")}function handleOut(e){_this.flag("isFocused")||$border.tween({opacity:0},400,"easeOutCubic")}function handleFocus(){_this.flag("isFocused",!0),_this.events.fire(DOMInput.FOCUS_CHANGE,{action:"in"}),$border.tween({opacity:1},400,"easeOutCubic")}function handleBlur(){_this.flag("isFocused",!1),_this.events.fire(DOMInput.FOCUS_CHANGE,{action:"out"}),$border.tween({opacity:0},400,"easeOutCubic")}function handleChange(){_this.valid=_this.isValid}options.unshift({label:required?label+"*":label,value:"none"}),$this.css({margin:"1rem 0",padding:"0.3rem 0",position:"relative",width:"full"===size?"100%":"18.8rem"}),function initInput(){($input=$this.create("DOMInput__Field","select")).attr("aria-labelledby",label+"_label"),$input.attr("name",label),$input.attr("placeholder",`${placeholder}${required?" *":""}`),$input.attr("tabindex","0"),"android"==Device.system.os&&$input.attr("autocomplete","off"),disabled&&$input.attr("disabled",disabled),$input.fontStyle(UI.FONT_TERTIARY,"1.6rem",Colors.instance().getColor("WHITE")).css({background:background,boxShadow:`0 -0.6rem 0 -0.3rem ${background}, 0 0.6rem 0 -0.3rem ${background}`,height:"3.4rem",padding:"0 2rem 0.2rem",pointerEvents:"auto",position:"relative",textTransform:"uppercase",width:"100%",border:"none",outline:"none","-webkit-appearance":"none"});for(let option of options){let $option=$input.create("option","option");$option.text(option.label),$option.attr("value",option.value),$option.css({background:"#251f35"})}}(),function initBorder(){($border=$this.create("DOMInput__Border")).size("100%").css({borderColor:"#fff",borderStyle:"solid",borderLeftWidth:"0.3rem",borderRightWidth:"0.3rem",boxShadow:"0 -0.3rem 0 -0.15rem #fff, 0 0.3rem 0 -0.15rem #fff",left:0,opacity:0,pointerEvents:"none",top:0})}(),function addHandlers(){$input.bind("mouseenter",handleOver),$input.bind("mouseout",handleOut),$input.bind("focusin",handleFocus),$input.bind("focusout",handleBlur),$input.bind("change",handleChange),$input.bind("input",handleChange)}(),"DOMSelect"===Global.PLAYGROUND&&($this.center().transform({x:"-50%",y:"-50%"}),$input.css({margin:"auto"})),_this.get("element",_=>$this),_this.get("type",_=>$input.attr("type")),_this.get("name",_=>$input.attr("name")),_this.get("value",_=>$input.div.value.trim()),_this.get("isValid",_=>{let isValid=!1;return isValid=!(!required||"none"==_this.value)||!required,isValid?$input.tween({color:Colors.instance().getColor("WHITE")},400,"easeOutCubic"):$input.tween({color:Colors.instance().getColor("RED")},400,"easeOutCubic"),isValid}),_this.check=function(){return _this.isValid},_this.clear=function(){$input.div.value=""}}),()=>{DOMInput.FOCUS_CHANGE="DomInput_focus_change"}),Class((function UIAudio(scaleable=!0){Inherit(this,GLUIComponent,{isScalable:scaleable});const _this=this;var _batch,_width,_height,$bars=[],_muted=Storage.get("muted"),_enabled=!0;function loop(t){$bars.forEach(($bar,i)=>{let y=.6+.4*Math.sin(.003*t+.75*i);GlobalAudio3D.muted&&(y=.2),$bar.scaleY+=.1*(y-$bar.scaleY),$bar.y=20*(1-$bar._scaleY)})}function onModalOpen(){_enabled=!1}function onModalClosed(){_enabled=!0}function onResize(){_this.element.x=Stage.width-(30+_width/2)*_this.scale,_this.element.y=20*_this.scale}function handleClick(){_enabled&&((_muted=!_muted)?(Storage.set("muted",!0),GlobalAudio3D.muted=!0):(Storage.set("muted",!1),GlobalAudio3D.muted=!1))}function handleHover(e){if(_enabled)switch(e.action){case"over":tween(_this.element,{alpha:1},300,"easeOutCubic");break;case"out":tween(_this.element,{alpha:.75},500,"easeOutCubic")}}!async function(){GLUI.Stage.add(_this.element),_this.scale=DOMResize.instance().scale,Device.mobile||(_this.scale*=.8),_batch=_this.initClass(GLUIBatch),_this.element.add(_batch),_this.element.alpha=.75,async function initState(){if(!(await Storage.get("muted")))return;GlobalAudio3D.muted=!0}(),function initBars(){_width=10,_height=18;let $box=$gl(_width,20,"#FF0000");$box.alpha=.01,$box.interact(handleHover,handleClick),_this.element.add($box);for(let i=0;i<5;i++){let $bar=$gl(2,_height,"#FFFFFF");$bar.x=4*i,$bar.moveY=0;let animOffset=0;switch(i){case 0:animOffset=.2;break;case 1:animOffset=.1;break;case 2:animOffset=.6;break;case 3:animOffset=.4;break;case 4:animOffset=.8;break;default:animOffset=1}_batch.add($bar),$bars.push($bar)}}(),onResize(),_this.onResize(onResize),function addListeners(){_this.events.sub(ModalView.OPEN,onModalOpen),_this.events.sub(ModalView.CLOSED,onModalClosed)}(),_this.startRender(loop),_this.flag("isReady",!0)}(),_this.get("width",()=>_width),_this.get("height",()=>_height),_this.animateIn=async function(delay=0){return _enabled=!0,_this.element.tween({alpha:.75},1e3,"easeOutCubic",delay).promise()},_this.animateOut=async function(delay=0){return _enabled=!1,_this.element.tween({alpha:0},1e3,"easeOutCubic",delay).promise()}}),"singleton"),Class((function UIBounceTitle(_text="You've\nbeen eaten!",{align:align="center",autoplay:autoplay,color:color="#ffffff",fontSize:fontSize=30,letterSpacing:letterSpacing=-.05,lineHeight:lineHeight=1.4,width:width=600,handleResize:handleResize=!0}={}){Inherit(this,GLUIComponent,{isScalable:!0});const _this=this;var $title,$blue,$red,_batch=new GLUIBatchText;async function onResize(){handleResize&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2-45*_this.scale)}!async function(){_this.autoplay=autoplay,_this.element.alpha=0,await async function initText(){$title=await $glText(_text,UI.FONT_TERTIARY,fontSize,{align:align,color:color,letterSpacing:letterSpacing,lineHeight:lineHeight,width:width}),_batch.add($title)}(),await async function initBlue(){($blue=await $glText(_text,UI.FONT_TERTIARY,fontSize,{align:align,color:"#00ffff",letterSpacing:letterSpacing,lineHeight:lineHeight,width:width})).x=4,$blue.y=-2,$blue.setZ(-1),_batch.add($blue)}(),await async function initRed(){($red=await $glText(_text,UI.FONT_TERTIARY,fontSize,{align:align,color:"#ff00ff",letterSpacing:letterSpacing,lineHeight:lineHeight,width:width})).x=-2,$red.y=4,$red.setZ(-1),_batch.add($red)}(),_this.element.add(_batch),_this.animateOut(),function addHandlers(){_this.onResize(onResize)}(),handleResize&&GLUI.Stage.add(_this.element),"UIBounceTitle"===Global.PLAYGROUND&&_this.delayedCall(_=>{_this.animateIn()},100),_this.element.scale=DOMResize.instance().scale,_this.delayedCall(_=>{onResize()},1e3),_this.flag("isReady",!0)}(),_this.onDestroy=function(){_batch&&_batch.remove&&(_batch.remove(),_batch=null)},_this.animateIn=async function(delay=0){delay&&await _this.wait(delay),tween(_this.element,{alpha:1},300,"easeOutCubic"),await TweenUIL.create(_this.constructorName+"_animateIn",{title:_this.element},null,!0).promise()},_this.animateOut=async function(delay=0){delay&&await _this.wait(delay),tween(_this.element,{alpha:0},300,"easeOutCubic"),await TweenUIL.create(_this.constructorName+"_animateOut",{title:_this.element},null,!0).promise()}})),Class((function UIButton(_text="Play Game",{alpha:alpha=1,background:background,backgroundOpacity:backgroundOpacity=.1,additive:additive=!0,color:color=Colors.instance().getColor("AQUA"),fontSize:fontSize=11,height:height=39,isScalable:isScalable=!0,onClick:onClick,width:width=174}={}){Inherit(this,GLUIComponent,{isScalable:isScalable});const _this=this;var $box,_boxShader,$text,_textShader,_onOver,_onOut;const HEIGHT=height,WIDTH=width;function handleHover(e){if(!_this.flag("isDisabled"))switch(e.action){case"over":!function handleHoverOver(){ScreensBackground.instance().changeTexture(),_onOver.play(),_this.events.fire(Events.HOVER,{action:"over"})}();break;case"out":!function handleHoverOut(){_onOut.play(),_this.events.fire(Events.HOVER,{action:"out"})}()}}function handleClick(){_this.delayedCall(_onOut.play,500),_this.flag("isDisabled")||(onClick&&onClick(),_this.events.fire(AudioController.PLAY,{name:"click"}))}!async function(){_text=StringUtils.formatUI(_text),await async function initText(){($text=await $glText(_text,UI.FONT_TERTIARY,fontSize,{align:"center",color:color,lineHeight:1})).color=color,$text.multiTween=!0,await $text.loaded(),_this.element.add($text)}(),await function initBox(){_boxShader=_this.initClass(Shader,"UIButtonShader",{uAlpha:{value:1e-4},uBackground:{value:new Color(background||color)},uBackgroundOpacity:{value:backgroundOpacity},uSize:{value:new Vector2(WIDTH,HEIGHT)},uTransition:{value:1},transparent:!0}),($box=$gl(WIDTH,HEIGHT,_boxShader,!additive)).x=-WIDTH/2,$box.y=-HEIGHT/2+$text.dimensions.height/2,$box.useShader(_boxShader),$box.alpha=0,_this.element.add($box)}(),function initShader(){_textShader=_this.initClass(Shader,"UILabelShader",{uAlpha:{value:1},uColor:{value:new Color(color)},uGlyphCount:{value:$text.length()},uTransition:{value:0},transparent:!0}),$text.useShader(_textShader)}(),"UIButton"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,GLUI.Stage.add(_this.element),_this.animateOut(),_this.animateIn(),_this.enableInteractions()),function addHovers(){_onOver=TweenUIL.create(_this.constructorName+"_onOver",{boxShader:_boxShader,text:$text,textShader:_textShader},null,!0,!1),_onOut=TweenUIL.create(_this.constructorName+"_onOut",{boxShader:_boxShader,text:$text,textShader:_textShader},null,!0,!1)}(),_this.flag("isReady",!0)}(),_this.get("height",_=>HEIGHT),_this.get("width",_=>WIDTH),_this.enableInteractions=async function(){await _this.ready(),$box.interact(handleHover,handleClick,"button",_text)},_this.disableInteractions=async function(){await _this.ready(),$box.clearInteract()},_this.animateIn=async function(delay){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateIn",{alpha:alpha,element:_this.element,box:$box,text:$text,shader:_textShader,string:_text},null,!0).promise()},_this.animateOut=async function(delay=0){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateOut",{element:_this.element},null,!0).promise()},_this.disable=function(){_this.flag("isDisabled",!0),$box.shader.uniforms.uBackground.value=new Color(Colors.instance().getColor("DISABLED")),$text.color=Colors.instance().getColor("DISABLED"),$text.setColor(Colors.instance().getColor("DISABLED"))}})),Class((function UIIconButton({width:width=100,height:height=100,imageWidth:imageWidth=20,imageHeight:imageHeight=20,alpha:alpha=1,background:background,backgroundOpacity:backgroundOpacity=.1,isScalable:isScalable=!0,color:color=Colors.instance().getColor("AQUA"),src:src="assets/images/_scenelayout/uv.jpg",onClick:onClick}={}){Inherit(this,GLUIComponent,{isScalable:isScalable});const _this=this;var $box,_boxShader,$icon,_iconShader,_onOver,_onOut;const HEIGHT=height,WIDTH=width;function handleHover(e){switch(e.action){case"over":!function handleHoverOver(){_onOver.play()}();break;case"out":!function handleHoverOut(){_onOut.play()}()}}function handleClick(){_onOut.play(),_this.flag("isDisabled")||onClick&&onClick()}!async function(){await async function initIcon(){($icon=$gl(imageWidth,imageHeight,src)).x=-imageWidth/2,$icon.y=-imageHeight/2,$icon.color=color,_iconShader=_this.initClass(Shader,"UIIconButtonShader",{uColor:{value:new Color(color)},tMap:{value:Utils3D.getTexture(src)}}),$icon.setZ(2),$icon.useShader(_iconShader),$icon.alpha=0,_this.element.add($icon)}(),await function initBox(){_boxShader=_this.initClass(Shader,"UIButtonShader",{uAlpha:{value:1e-4},uBackground:{value:new Color(background||color)},uBackgroundOpacity:{value:backgroundOpacity},uSize:{value:new Vector2(WIDTH,HEIGHT)},uTransition:{value:1},transparent:!0}),($box=$gl(WIDTH,HEIGHT,_boxShader)).x=-WIDTH/2,$box.y=-HEIGHT/2,$box.useShader(_boxShader),$box.alpha=0,_this.element.add($box)}(),"UIIconButton"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,GLUI.Stage.add(_this.element),_this.animateOut(),_this.animateIn(),_this.enableInteractions()),function addHovers(){_onOver=TweenUIL.create(_this.constructorName+"_onOver",{boxShader:_boxShader,iconShader:_iconShader,icon:$icon},null,!0,!1),_onOut=TweenUIL.create(_this.constructorName+"_onOut",{boxShader:_boxShader,iconShader:_iconShader,icon:$icon,color:color},null,!0,!1)}(),_this.flag("isReady",!0)}(),_this.get("height",_=>HEIGHT),_this.get("width",_=>WIDTH),_this.enableInteractions=async function(){await _this.ready(),$box.interact(handleHover,handleClick,"button")},_this.disableInteractions=async function(){await _this.ready(),$box.clearInteract()},_this.animateIn=async function(delay){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateIn",{alpha:alpha,element:_this.element,box:$box,icon:$icon},null,!0).promise()},_this.animateOut=async function(delay=0){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateOut",{element:_this.element},null,!0).promise()},_this.disable=function(){_this.flag("isDisabled",!0),$box.shader.uniforms.uBackground.value=new Color(Colors.instance().getColor("DISABLED"))}})),Class((function UIChat({color:color=Colors.instance().getColor("GREEN"),title:title="[Area 1] Gummi Leaks",description:description="The story of gummi leaks started when one of the worms escaped the..."}={}){Inherit(this,GLUIComponent,{isScalable:!0});const _this=this;var _title,$titleBackground,_description,$descriptionBackground;function onResize(){}!async function(){await async function initTitle(){_title=_this.initClass(UILabel,StringUtils.formatUI(title),{align:"left",color:Colors.instance().getColor("BLACK"),fontSize:8,isScalable:!1,letterSpacing:.02,lineHeight:1}),await _title.ready();let width=await _title.width;$titleBackground=$gl(width+26,28,color);let shader=_this.initClass(Shader,"UIChatBackground",{uBackground:{value:new Color(color)},uBackgroundOpacity:{value:1},uRadius:{value:200},uSize:{value:new Vector2($titleBackground.width/2,$titleBackground.height/2)},transparent:!0});$titleBackground.useShader(shader),$titleBackground.x=0,$titleBackground.y=0,_title.x=13,_title.y=$titleBackground.height/2-4,_title.z=2,$titleBackground.alpha=0,_this.element.add($titleBackground)}(),await async function initDescription(){_description=_this.initClass(UILabel,StringUtils.formatUI(description),{align:"left",fontSize:8,isScalable:!1,letterSpacing:.05,lineHeight:2,width:280}),await _description.ready();let heightDescription=await _description.height;$descriptionBackground=$gl(306,heightDescription+26,color);let shader=_this.initClass(Shader,"UIChatBackground",{uBackground:{value:new Color(Colors.instance().getColor("WHITE"))},uBackgroundOpacity:{value:.2},uRadius:{value:200},uSize:{value:new Vector2($descriptionBackground.width/2,$descriptionBackground.height/2)},transparent:!0});$descriptionBackground.useShader(shader),$descriptionBackground.y=$titleBackground.height+$titleBackground.y+5,_description.x=13,_description.y=26+heightDescription/2,$descriptionBackground.alpha=0,_this.element.add($descriptionBackground)}(),"UIChat"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,GLUI.Stage.add(_this.element),_this.animateOut(),_this.animateIn()),function addHandlers(){_this.onResize(onResize)}(),_this.flag("isReady",!0)}(),_this.set("y",async y=>{await _this.ready(),_this.element.y=Stage.height-y-($titleBackground.height+$descriptionBackground.height+5)*DOMResize.instance().scale}),_this.animateIn=async function(delay=0){delay&&await _this.wait(delay),await Promise.all([TweenUIL.create(_this.constructorName+"_animateIn",{titleBackground:$titleBackground,descriptionBackground:$descriptionBackground},null,!0).promise(),_title.animateIn(100),_description.animateIn(100)])},_this.animateOut=async function(delay=0){return delay&&await _this.wait(delay),Promise.resolve()}})),Class((function UIClose({onClick:onClick}={}){Inherit(this,GLUIComponent,{isScalable:!0});const _this=this;var $close,_onOver,_onOut;function handleHover(e){switch(e.action){case"over":!function handleHoverOver(){_onOver.play()}();break;case"out":!function handleHoverOut(){_onOut.play()}()}}function handleClick(){_onOut.play(),onClick&&onClick()}async function onResize(){_this.element.x=Stage.width-30*DOMResize.instance().scale,_this.element.y=30*DOMResize.instance().scale}!async function(){await function initClose(){($close=$gl(18,18,"assets/images/ui/close.png")).x=-18,_this.element.alpha=0,_this.element.add($close)}(),async function addHovers(){_onOver=await TweenUIL.create(_this.constructorName+"_onOver",{element:_this.element},null,!0,!1),_onOut=await TweenUIL.create(_this.constructorName+"_onOut",{element:_this.element},null,!0,!1)}(),function addHandlers(){_this.onResize(onResize)}(),"UIClose"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,GLUI.Stage.add(_this.element),_this.animateOut(),_this.animateIn(),_this.enableInteractions()),_this.flag("isReady",!0)}(),_this.get("height",_=>18),_this.get("width",_=>18),_this.enableInteractions=function(){$close.interact(handleHover,handleClick)},_this.disableInteractions=function(){$close.clearInteract()},_this.animateIn=async function(delay=0){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateIn",{element:_this.element},null,!0).promise()},_this.animateOut=async function(delay=0){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateOut",{element:_this.element},null,!0).promise()}})),Class((function UICompleteText(_text="Label",{align:align="center",alpha:alpha=1,color:color="#ffffff",fontSize:fontSize=50,isScalable:isScalable=!0,lineHeight:lineHeight=1,onClick:onClick,width:width}={}){Inherit(this,GLUIComponent,{isScalable:isScalable});const _this=this;var _batch,$text,$shadow,_onOver,_onOut,_textShader,_shadowShader;function handleHover(e){switch(e.action){case"over":!function handleHoverOver(){_onOver.play()}();break;case"out":!function handleHoverOut(){_onOut.play()}()}}function handleClick(){_onOut.play(),onClick&&onClick()}!async function(){_batch=_this.initClass(GLUIBatchText),_text=StringUtils.formatUI(_text),_this.element.add(_batch),await async function initTexts(){$text=await $glText(_text,UI.FONT_ACCENT,fontSize,{align:align,color:color,letterSpacing:.1,lineHeight:lineHeight,width:width}),($shadow=await $glText(_text,UI.FONT_ACCENT,fontSize,{align:align,color:color,letterSpacing:.1,lineHeight:lineHeight,width:width})).excludeSEO=!0,await Promise.all([$text.loaded(),$shadow.loaded()])}(),async function initShaders(){_textShader=_this.initClass(Shader,"UICompleteText",{uAlpha:{value:1},uColor:{value:new Color(color)},uGlyphCount:{value:$text.length()},uTransition:{value:1},uRainbow:{value:0},transparent:!0}),$text.useShader(_textShader),await $text.text.ready(),_this.element.add($text),_shadowShader=_this.initClass(Shader,"UICompleteText",{uAlpha:{value:1},uColor:{value:new Color(color)},uGlyphCount:{value:$text.length()},uTransition:{value:1},uRainbow:{value:1},transparent:!0}),$shadow.useShader(_shadowShader),_this.element.add($shadow)}(),function positionShadow(){$shadow.y=1.5,$shadow.x=2.5}(),"UICompleteText"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,GLUI.Stage.add(_this.element),_this.animateOut(),_this.animateIn(),_this.enableInteractions(!0)),function addHovers(){_onOver=TweenUIL.create(_this.constructorName+"_onOver",{text:$text,string:_text},null,!0,!1),_onOut=TweenUIL.create(_this.constructorName+"_onOut",{text:$text,string:_text},null,!0,!1)}(),_this.flag("isReady",!0)}(),_this.setText=async function(string=""){_this.flag("isReady")&&(_text=StringUtils.formatUI(string),$text.setText(_text),$shadow.setText(_text))},_this.get("$text",_=>$text),_this.get("height",async _=>(await _this.ready(),await $text.loaded(),$text.dimensions.height)),_this.get("width",async _=>(await _this.ready(),await $text.loaded(),$text.dimensions.width)),_this.enableInteractions=function(){("UILabel"===Global.PLAYGROUND||onClick)&&$text.interact(handleHover,handleClick,"label",_text)},_this.disableInteractions=function(){$text.clearInteract()},_this.animateIn=async function(delay){await _this.ready(),delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateIn",{alpha:alpha,text:$text,shadow:$shadow,shader:_textShader,shadowShader:_shadowShader,string:_text},null,!0).promise()},_this.animateOut=async function(delay){await _this.ready(),delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateOut",{text:$text,shadow:$shadow,shader:_textShader,shadowShader:_shadowShader},null,!0).promise()},_this.onDestroy=function(){_batch.remove(),_batch=null}})),Class((function GLUIComponent({isScalable:isScalable=!1}={}){Inherit(this,GLUIElement);const _this=this;function onResize(){isScalable&&_this.element&&(_this.scale=DOMResize.instance().scale)}!async function(){_this.constructorName=Utils.getConstructorName(_this),isScalable&&_this.onResize(onResize)}(),_this.set("alpha",alpha=>!!_this.element&&(_this.element.alpha=alpha)),_this.set("scale",scale=>!!_this.element&&(_this.element.scale=scale)),_this.set("x",x=>!!_this.element&&(_this.element.x=x)),_this.set("y",y=>!!_this.element&&(_this.element.y=y)),_this.set("z",z=>!!_this.element&&_this.element.setZ(z)),_this.set("alpha",_=>!!_this.element&&_this.element.alpha),_this.get("scale",_=>_this.element?_this.element.scale:1),_this.get("x",_=>_this.element?_this.element.x:0),_this.get("y",_=>_this.element?_this.element.y:0),_this.get("z",_=>_this.element?_this.element.mesh.renderOrder:0),_this.resize=_=>onResize(),_this.show=function(){_this.element&&(_this.element.alpha=1)},_this.hide=function(){_this.element&&(_this.element.alpha=0)},_this.ready=function(){return _this.wait(_this,"isReady")}})),Class((function UIDescription(_text="Description",{align:align="center",color:color="#ffffff",fontSize:fontSize=12,isScalable:isScalable=!0,lineHeight:lineHeight=1.6,width:width,fontFamily:fontFamily=UI.FONT_SECONDARY}={}){Inherit(this,GLUIComponent,{isScalable:isScalable});const _this=this;var $text;!async function(){await async function initText(){$text=await $glText(_text,fontFamily,fontSize,{align:align,color:color,letterSpacing:.02,lineHeight:lineHeight,width:width}),_this.element.alpha=0,_this.element.add($text)}(),"UIDescription"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,GLUI.Stage.add(_this.element),_this.animateOut(),_this.animateIn()),_this.flag("isReady",!0)}(),_this.get("text",_=>$text),_this.get("width",_=>_this.element.dimensions.width),_this.setText=text=>$text.setText(text),_this.set("width",width=>_this.element.width=width),_this.animateIn=async function(delay=0){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateIn",{element:_this.element},null,!0).promise()},_this.animateOut=async function(delay=0){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateOut",{element:_this.element},null,!0).promise()}})),Class((function UIEnding(_text="You've\nbeen",{align:align="center",autoplay:autoplay,color:color="#ffffff",fontSize:fontSize=30,letterSpacing:letterSpacing=-.05,lineHeight:lineHeight=1.4,width:width=600}={}){Inherit(this,GLUIComponent,{isScalable:!1});const _this=this;var _bounce,_particleBatch,_images=[],_imageData=[{color:Colors.instance().getColor("MAGENTA"),offset:new Vector2(0,0),alpha:1},{color:"#FFFFFF",offset:new Vector2(-5,-10),alpha:.3},{color:Colors.instance().getColor("AQUA"),offset:new Vector2(5,10),alpha:.3}];async function onResize(){_this.element.x=Stage.width/2,_this.element.y=Stage.height/2-45*_this.scale,_images.forEach(image=>{image.y=(100+image.data.offset.y+-100*image.scale)/2,image.x=(-400+image.data.offset.x)*image.scale/2}),_bounce.y=_images[0].y-100*_bounce.scale}!async function(){_this.element.alpha=0,await async function initBounce(){_bounce=_this.initClass(UIBounceTitle,_text,{align:align,autoplay:autoplay,color:color,fontSize:fontSize,letterSpacing:letterSpacing,lineHeight:lineHeight,handleResize:!1}),_this.element.add(_bounce.element)}(),_imageData.forEach(async data=>{await async function initEnding(data){let image=_this.initClass(UIIcon,{width:400,height:100,src:"assets/images/ui/eaten.png",shader:"UIEndingImageShader",uniforms:{uColor:{value:new Color(data.color)},uAlpha:{value:data.alpha},transparent:!0,blending:Shader.ADDITIVE_BLENDING}});image.element.alpha=0,image.data=data,_this.element.add(image.element),_images.push(image)}(data)}),_this.animateOut(),GLUI.Stage.add(_this.element),function addHandlers(){_this.onResize(onResize)}(),"UIEnding"===Global.PLAYGROUND&&_this.delayedCall(_=>{_this.animateIn()},100),_this.delayedCall(()=>{onResize()},100),_this.flag("isReady",!0)}(),_this.animateIn=async function(delay=1500){delay&&await _this.wait(delay),tween(_this.element,{alpha:1},300,"easeOutCubic"),_bounce.animateIn(),function initParticles(){const COLORS=["#FFFFFF",Colors.instance().getColor("MAGENTA"),Colors.instance().getColor("AQUA")];(_particleBatch=_this.initClass(GLUIBatch)).alpha=0,_this.element.add(_particleBatch);for(let i=0;i<200;i++){let $particle=$gl(30*Math.random(.3,1,2),10*Math.random(.2,1,2),COLORS.random());$particle.y=Stage.height*(2*Math.random()-1),$particle.x=Stage.width*(2*Math.random()-1),$particle.velocity=Math.random(.2,1,2),_this.startRender(()=>{$particle.x+=10*$particle.velocity,$particle.x>Stage.width&&($particle.x=-Stage.width)}),_particleBatch.add($particle)}}(),_images.forEach(image=>{!function wobble(image){image.origin||(image.velocity=new Vector2(image.data.offset.x,image.data.offset.y),image.origin=new Vector2(image.x,image.y));let angle=Math.random(0,2*Math.PI,7),power=Math.random(5,8,7);image.velocity.x+=Math.cos(angle)*power,image.velocity.y+=Math.sin(angle)*power,image.wobbling||_this.startRender((function(time){image.wobbling=!0,image.x+=1.25*Math.cos(2*time),image.y+=2*Math.sin(1.5*time)}),30)}(image)}),await TweenUIL.create(_this.constructorName+"_animateIn",{ending:_this.element,images:_images},null,!0).promise()},_this.animateOut=async function(delay=0){delay&&await _this.wait(delay),tween(_this.element,{alpha:0},300,"easeOutCubic"),_bounce.animateOut(),_particleBatch&&_particleBatch.destroy&&_particleBatch.destroy(),await TweenUIL.create(_this.constructorName+"_animateOut",{ending:_this.element,images:_images},null,!0).promise()}})),Class((function UIFooter(_parent,_wrapper,_returnData={}){Inherit(this,Component);const _this=this;var _privacy,_information,_elements=[];let fontSize=Device.mobile.phone?8:6;function handlePrivacyPolicy(){Track.event("Global","click","privacy"),window.open(Data.COPY.privacyLink,"_blank")}function handleInformation(){Track.event("Global","click","information"),window.open(Data.COPY.informationLink,"_blank")}!async function(){await async function initPrivacy(){_privacy=_parent.initClass(UILabel,Data.COPY.privacy,{align:"center",fontSize:fontSize,onClick:handlePrivacyPolicy}),_elements.push(_privacy.element),_wrapper.add(_privacy.element),await _privacy.ready()}(),await async function initInformation(){_information=_parent.initClass(UILabel,Data.COPY.information,{align:"center",fontSize:fontSize,onClick:handleInformation}),_elements.push(_information.element),_wrapper.add(_information.element),await _information.ready()}(),_this.flag("isReady",!0)}(),_this.setReturnData=function(data){data},_this.get("privacy",_=>_privacy),_this.get("information",_=>_information),_this.resize=_=>function onResize(){_privacy.x=.4*Stage.width,_privacy.y=Stage.height-25*_privacy.scale,_information.x=.6*Stage.width,_information.y=Stage.height-25*_information.scale,Stage.height<300||Device.mobile&&!Fullscreen.isOpen?_elements.forEach(el=>{el.alpha=0}):_elements.forEach(el=>{el.alpha=1})}(),_this.ready=function(){return _this.wait("isReady")}})),Class((function UIIcon({width:width=50,height:height=50,src:src="",shader:shader=null,uniforms:uniforms={}}={}){Inherit(this,GLUIComponent,{isScalable:!0});const _this=this;var $icon;_this._width=width,async function(){!function initIcon(){if($icon=$gl(width,height,src),shader){let _shader=_this.initClass(Shader,shader,uniforms);$icon.useShader(_shader)}_this.element.add($icon)}(),function onResize(){_this.scale=DOMResize.instance().scale}(),_this.flag("isReady",!0)}(),this.get("width",()=>_this._width),_this.animateIn=async function(delay=0){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateIn",{element:_this.element},null,!0).promise()},_this.animateOut=async function(delay=0){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateOut",{element:_this.element},null,!0).promise()}}),"singleton"),Class((function UILabel(_text="Label",{align:align="center",alpha:alpha=1,color:color="#ffffff",fontSize:fontSize=10,isScalable:isScalable=!0,lineHeight:lineHeight=1,onClick:onClick,font:font=UI.FONT_TERTIARY,width:width}={}){Inherit(this,GLUIComponent,{isScalable:isScalable});const _this=this,padding_x=30,padding_y=30;var $text,$wrap,_onOver,_onOut,_shader;function handleHover(e){switch(e.action){case"over":!function handleHoverOver(){_onOver.play()}();break;case"out":!function handleHoverOut(){_onOut.play()}()}}function handleClick(){_onOut.play(),onClick&&onClick()}!async function(){_text=StringUtils.formatUI(_text),await async function initText(){$text=await $glText(_text,font,fontSize,{align:align,color:color,letterSpacing:.1,lineHeight:lineHeight,width:width}),await $text.loaded(),$wrap=$gl($text.dimensions.width+padding_x,$text.dimensions.height+padding_y,"#FFFFFF");let shader=_this.initClass(Shader,"UIToggleButtonShader",{uAlpha:{value:0},transparent:!0});$wrap.useShader(shader);let wrapShift=0,textShift=0;switch(align){case"center":wrapShift=-padding_x,textShift=padding_x;break;case"left":wrapShift=-padding_x/2,textShift=padding_x/2;break;case"right":wrapShift=2*-padding_x,textShift=2*padding_x}$wrap.x=wrapShift,$wrap.y=-padding_y/2,$text.x+=textShift,$text.y+=padding_y/2,$wrap.add($text),_this.element.add($wrap)}(),function initShader(){_shader=_this.initClass(Shader,"UILabelShader",{uAlpha:{value:1},uColor:{value:new Color(color)},uGlyphCount:{value:$text.length()},uTransition:{value:0},transparent:!0}),$text.useShader(_shader)}(),"UILabel"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,GLUI.Stage.add(_this.element),_this.animateOut(),_this.animateIn(),_this.enableInteractions(!0)),function addHovers(){_onOver=TweenUIL.create(_this.constructorName+"_onOver",{text:$text,string:_text},null,!0,!1),_onOut=TweenUIL.create(_this.constructorName+"_onOut",{text:$text,string:_text},null,!0,!1)}(),_this.flag("isReady",!0)}(),_this.setText=async function(string=""){await _this.wait(_this,"isReady"),_text=StringUtils.formatUI(string),$text.setText(_text)},_this.get("$text",_=>$text),_this.get("$wrap",_=>$wrap),_this.get("height",async _=>(await _this.ready(),$text.dimensions.height+padding_x)),_this.get("width",async _=>(await _this.ready(),$text.dimensions.width+padding_y)),_this.enableInteractions=function(){("UILabel"===Global.PLAYGROUND||onClick)&&$wrap.interact(handleHover,handleClick,"label",_text)},_this.disableInteractions=function(){$wrap.clearInteract()},_this.animateIn=async function(delay){await _this.ready(),_this.flag("isActive")||(_this.flag("isActive",!0),delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateIn",{alpha:alpha,text:$text,shader:_shader,string:_text},null,!0).promise())},_this.animateOut=async function(delay){await _this.ready(),_this.flag("isActive")&&(_this.flag("isActive",!1),delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateOut",{text:$text,shader:_shader},null,!0).promise())}})),Class((function UILink(_text="Skip For Now",{alpha:alpha=1,color:color=Colors.instance().getColor("MAGENTA"),fontSize:fontSize=11,isScalable:isScalable=!0,onClick:onClick}={}){Inherit(this,GLUIComponent,{isScalable:isScalable});const _this=this;var $text,$underscore,_shader,_onOver,_onOut;function handleHover(e){switch(e.action){case"over":!function handleHoverOver(){_onOver.play()}();break;case"out":!function handleHoverOut(){_onOut.play()}()}}function handleClick(){_onOut.play(),onClick&&onClick()}!async function(){_text=StringUtils.formatUI(_text),await async function initText(){($text=await $glText(_text,UI.FONT_TERTIARY,fontSize,{align:"center",color:color,lineHeight:1})).color=color,_this.element.add($text),await $text.loaded()}(),function initShader(){_shader=_this.initClass(Shader,"UILabelShader",{uAlpha:{value:1},uColor:{value:new Color(color)},uGlyphCount:{value:$text.length()},uTransition:{value:0},transparent:!0}),$text.useShader(_shader)}(),function initUnderscore(){($underscore=$gl($text.dimensions.width,2,color)).x=-$text.dimensions.width/2,$underscore.y=fontSize+5,$underscore.scaleX=0,_this.element.add($underscore)}(),"UILink"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,GLUI.Stage.add(_this.element),_this.animateIn(),_this.animateOut(),_this.enableInteractions()),function addHovers(){_onOver=TweenUIL.create(_this.constructorName+"_onOver",{alpha:alpha,text:$text,shader:_shader,string:_text,underscore:$underscore},null,!0,!1),_onOut=TweenUIL.create(_this.constructorName+"_onOut",{text:$text,string:_text,underscore:$underscore},null,!0,!1)}(),_this.flag("isReady",!0)}(),_this.enableInteractions=function(){$text.interact(handleHover,handleClick,"link",_text)},_this.disableInteractions=function(){$text.clearInteract()},_this.animateIn=async function(delay){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateIn",{alpha:alpha,text:$text,shader:_shader,string:_text,underscore:$underscore},null,!0).promise()},_this.animateOut=async function(delay){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateOut",{text:$text,underscore:$underscore},null,!0).promise()}})),Class((function UILogo(_type="center",scalable=!0,autoResize=!0){Inherit(this,GLUIComponent,{isScalable:scalable});const _this=this;function handleHover(e){switch(e.action){case"over":!function handleHoverOver(){_this.element.tween({alpha:.5},400,"easeOutCubic")}();break;case"out":!function handleHoverOut(){_this.element.tween({alpha:1},400,"easeOutCubic")}()}}function handleClick(){ViewController.instance().transition("LandingView"),ViewController.instance().clearLevel(Level.PLAYING),Track.event("Global","click","logo")}function onResize(){_this.scale=.7*DOMResize.instance().scale,"center"===_type?(_this.element.height=49,_this.element.width=77,_this.element.x=Stage.width/2-_this.element.width/2*_this.scale,_this.element.y=38*_this.scale):(_this.element.height=34,_this.element.width=55,_this.element.x=30*_this.scale,_this.element.y=25*_this.scale)}!async function(){GLUI.Stage.add(_this.element),await function initTrolli(){_this.hit=_this.create(77,49,"assets/images/ui/trolli.png"),_this.element.setZ(9),_this.element.alpha=1e-5}(),"UILogo"===Global.PLAYGROUND&&(_this.animateOut(),_this.animateIn()),_this.scale=DOMResize.instance().scale*(Device.mobile?.8:.6),autoResize&&(!function addHandlers(){_this.onResize(onResize)}(),onResize()),_this.flag("isReady",!0)}(),_this.enableInteractions=async function(){await _this.ready(),_this.hit.interact(handleHover,handleClick)},_this.disableInteractions=async function(){await _this.ready(),_this.hit.clearInteract()},_this.animateIn=async function(delay=0){_this.flag("isActive")||(_this.flag("isActive",!0),delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateIn",{element:_this.element},null,!0).promise())},_this.animateOut=async function(delay=0){_this.flag("isActive")&&(_this.flag("isActive",!1),(delay+=1e3)&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateOut",{element:_this.element},null,!0).promise())},_this.reposition=async function(type){_type=type,onResize()}}),"singleton"),Class((function UIRotation(){Inherit(this,GLUIComponent,{isScalable:!1});const _this=this;var $background,$icon,_description,$logo;function onResize(){Stage.width<Stage.height?_this.animateIn():_this.animateOut(),$background.width=Stage.width,$background.height=Stage.height,$logo.x=Stage.width/2-$logo.width/2,$logo.y=Stage.height/2-($logo.height/2+80),$icon.x=Stage.width/2-$icon.width/2,$icon.y=Stage.height/2-($icon.height/2-30),_description.x=Stage.width/2,_description.y=$icon.y+70}!async function(){await async function initBackground(){($background=$gl(Stage.width,Stage.height,Colors.instance().getColor("DARK_BLUE"),"normal")).x=0,$background.y=0,$background.alpha=0;let shader=_this.initClass(Shader,"IntroAccessShader",{uGrain:{value:.05}});$background.useShader(shader),_this.element.add($background)}(),await async function initIcon(){$icon=$gl(52,52,"assets/images/ui/rotate.png"),_this.element.add($icon)}(),await async function initLogo(){$logo=$gl(115.5,73.5,"assets/images/ui/trolli.png"),_this.element.add($logo)}(),await async function initDescription(){_description=_this.initClass(UIDescription,"Please rotate\nyour device.",{isScalable:!1,width:200}),_this.delayedCall(_=>{_description.animateIn()},100),_this.element.add(_description.element)}(),_this.element.setZ(100),GLUI.Stage.add(_this.element),function addHandlers(){_this.onResize(onResize)}(),_this.hide(),_this.flag("isReady",!0)}(),_this.animateIn=async function(){await _this.ready(),Device.mobile&&(_this.show(),_this.showBackground(),$background.setZ(100),$icon.setZ(101),$logo.setZ(101),_description.text.setZ(102))},_this.animateOut=function(){_this.hide()},_this.showBackground=function(){$background.alpha=1}}),"singleton"),Class((function UIStars({size:size=75,center:center=!1}={}){Inherit(this,GLUIComponent,{isScalable:!0});const _this=this;var $stars=[],width=0;function onResize(){_this.scale=DOMResize.instance().scale,Stage.width>2e3&&(_this.scale*=.8)}!async function(){await function initStars(){for(let i=0;i<3;i++){let $star=$gl(size,size,"assets/images/ui/star_full.png"),shader=_this.initClass(Shader,"UIStars",{tOff:{value:Utils3D.getTexture("assets/images/ui/star_empty.png")},tOn:{value:Utils3D.getTexture("assets/images/ui/star_full.png")},uFill:{value:0},uBorderColor:{value:new Color("#6700FF")}});$star.useShader(shader),$star.x=(size+.1*size)*i,width+=size+.1*size,center&&1==i&&($star.y=-size),$stars.push($star),_this.element.add($star)}_this.element.width=width}(),"UIStars"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2-width/2,_this.element.y=Stage.height/2-size/2,GLUI.Stage.add(_this.element),_this.set(2.5)),_this.scale=DOMResize.instance().scale,Stage.width>2e3&&(_this.scale*=.8),_this.onResize(onResize),_this.flag("isReady",!0)}(),_this.get("height",_=>size),_this.get("width",_=>width),_this.set=async function(index=0,reset=!0,duration=2e3,delay=500){for(let[i,$star]of $stars.entries()){let start=-i,end=index-i;reset&&$star.shader.set("uFill",start),$star.shader.tween("uFill",end,duration,"easeOutCubic",delay)}await _this.wait(delay+duration)},_this.animateOut=function(){for(let[i,$star]of $stars.entries())$star.alpha=0},_this.animateIn=function(){for(let[i,$star]of $stars.entries())$star.alpha=1}})),Class((function UITitle(_text="Title",{align:align="center",alpha:alpha=1,autoplay:autoplay,color:color="#ffffff",fontSize:fontSize=23,isScalable:isScalable=!0,letterSpacing:letterSpacing=0,lineHeight:lineHeight=1.6,width:width}={}){Inherit(this,GLUIComponent,{isScalable:isScalable});const _this=this;var $title,_shader;!async function(){_this.autoplay=autoplay,_text=StringUtils.formatUI(_text),await async function initText(){$title=await $glText(_text,UI.FONT_PRIMARY,fontSize,{align:align,color:color,letterSpacing:letterSpacing,lineHeight:lineHeight,width:width}),_this.element.add($title)}(),await function initShader(){_shader=_this.initClass(Shader,"UITitleShader",{uAlpha:{value:1},uColor:{value:new Color(color)},uGlyphCount:{value:$title.length()},uTransition:{value:0},transparent:!0}),$title.useShader(_shader)}(),"UITitle"===Global.PLAYGROUND&&(_this.element.x=Stage.width/2,_this.element.y=Stage.height/2,GLUI.Stage.add(_this.element),_this.animateOut(),_this.animateIn()),_this.flag("isReady",!0)}(),_this.setText=function(text){_text=StringUtils.formatUI(text),$title.setText(_text)},_this.animateIn=async function(delay=0){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateIn",{alpha:alpha,title:$title,shader:_shader,string:_text},null,!0).play()},_this.animateOut=async function(delay=0){delay&&await _this.wait(delay),await TweenUIL.create(_this.constructorName+"_animateOut",{title:$title,shader:_shader},null,!0).play()}})),Class((function UIToggle({color:color="#ffffff",fontSize:fontSize=13,isScalable:isScalable=!0,letterSpacing:letterSpacing=0,lineHeight:lineHeight=1.6,options:options=[{label:"Test 1",value:"Test 1",cb:null},{label:"Test 2",value:"Test 2",cb:null}]}={}){Inherit(this,GLUIComponent,{isScalable:isScalable});const _this=this;var $underline,_width=0,_index=0,$elements=[],$texts=[];function initText(option){let text=StringUtils.formatUI(option.label);return $glText(text,UI.FONT_TERTIARY,fontSize,{color:option.color?option.color:color,letterSpacing:letterSpacing,lineHeight:lineHeight})}function initSeparator(height){return $gl(3,height,color)}function initUnderline(){let target=$texts[_index];($underline=$gl(target.parent.width-5,3,color)).x=target.parent.x+5,$underline.y=target.dimensions.height+15,_this.element.add($underline)}function switchIndex(index){if(index==_index)return;let target=$texts[_index=index];tween($underline,{width:target.parent.width-5,x:target.parent.x+5},300,"easeOutCubic",0,()=>{_this.events.fire(UIToggle.INDEX_CHANGE,{index:_index,value:target.value})})}function handleHover(){}function handleClick(e){e.object.cb&&e.object.cb(),switchIndex(e.object.index)}async function onResize(){await _this.wait(_this,"init");let toggleWidth=_width;_this.x=Stage.width/2-toggleWidth/2*_this.scale,_this.y=25*_this.scale}!async function(){await async function parseOptions(){for(let index=0;index<options.length;index++){let option=options[index];await new Promise(async(resolve,reject)=>{let $text=initText(option);await $text.loaded();const padding_x=30,padding_y=30;let halfPadX=padding_x/2,halfPadY=padding_y/2,$parent=$gl($text.dimensions.width+padding_x,$text.dimensions.height+padding_y,"#FFFFFF"),shader=_this.initClass(Shader,"UIToggleButtonShader",{uAlpha:{value:0},transparent:!0});if($parent.useShader(shader),$parent.index=index,$text.value=option.value,$parent.cb=option.cb,_width+=$text.dimensions.width,index>0){let $separator=initSeparator($text.dimensions.height),$prev=$texts[index-1];$separator.x=$prev?$texts[index-1].x+$texts[index-1].dimensions.width+30:0,$parent.x=$separator.x+30,_width+=62,_this.element.add($separator)}else $parent.x=halfPadX+5;$parent.x-=halfPadX,$parent.y-=halfPadY,$text.y+=halfPadX,$text.x+=halfPadY,$parent.add($text),_this.element.add($parent),$texts.push($text),$elements.push($parent),index==options.length-1&&(initUnderline(),_this.init=!0,_this.scale=DOMResize.instance().scale),resolve()})}}(),function addHandlers(){_this.onResize(onResize)}(),onResize(),GLUI.Stage.add(_this.element),_this.element.alpha=0,_this.flag("isReady",!0)}(),this.select=function(index){switchIndex(index)},this.get("width",async()=>(await _this.wait(_this,"init"),_width)),_this.animateIn=async function(){return tween(_this.element,{alpha:1},400,"easeOutCubic").promise()},_this.animateOut=function(){return tween(_this.element,{alpha:0},400,"easeOutCubic").promise()},_this.enableInteractions=async function(){await _this.ready(),$elements.forEach($element=>{$element.interact(handleHover,handleClick)})},_this.disableInteractions=async function(){await _this.ready(),$elements.forEach($element=>{$element.clearInteract()})}}),()=>{UIToggle.INDEX_CHANGE="UIToggle_index_change"}),Class((function ScreensBackground(){Inherit(this,FXScene);const _this=this;var _layout,_layers,_video,_planesBatch,_debug,_shader,_planes=[],_camera=Camera.instance().createLocal(),_rotation=0,_direction=1,_scroll={target:0,value:0},_positions=[new Vector2(0,0),new Vector2(0,1),new Vector2(0,2),new Vector2(1,0),new Vector2(1,1),new Vector2(1,2),new Vector2(2,0),new Vector2(2,1),new Vector2(2,2)];function changeRandom(){let plane=_planes.random(),pattern=_positions.random();for(;plane.shader.uniforms.uPattern.value==pattern;)pattern=_positions.random();plane.shader.set("uPattern",pattern),plane.shader.set("uFlip",Utils.headsTails(0,1)),_this.delayedCall(changeRandom,300)}function loop(){Utils.query("orbit")||_layers.camera&&_layers.camera.group&&(_scroll.value=Math.lerp(_scroll.target,_scroll.value,.1),_layers.camera.group.rotation.x=.1*-_scroll.value+_rotation-.05*_planesBatch.group.position.z,_rotation-=.0015*_direction),_planes.forEach(plane=>{plane.quaternion.copy(_camera.worldCamera.quaternion)}),_this.render()}!async function(){_this.create(),_this.setDPR(Tests.ScreensBackgroundDPR()),Utils.query("orbit")||_this.useCamera(_camera.worldCamera),await async function initLayout(){_layout=_this.initClass(SceneLayout,"screens_background"),(_layers=await _layout.getAllLayers()).camera.lock(_camera)}(),await function initShader(){_this.shader=_shader=_this.initClass(Shader,"ScreensBackgroundShader",{uColor:{value:new Color(Colors.instance().getColor("DARK_BLUE"))},uLevelColor:{value:new Color},uLevelSelect:{value:0},uLevelSelectHover:{value:0},uGrain:{value:.1},uScanlines:{value:.025},uTransition:{value:1},tScreens:{value:_this},fLightPos:{value:new Vector2(.5,.5)},fExposure:{value:.2},fDecay:{value:.93},fDensity:{value:.96},fWeight:{value:.4},fClamp:{value:1},transparent:!0,blending:Shader.ADDITIVE_BLENDING,depthTest:!1,depthWrite:!1}),ShaderUIL.add(_shader),Tests.mouseFluid()&&MouseFluid.instance().applyTo(_shader)}(),await function initVideo(){let src=Tests.videoTexture()?"assets/videos/screens.mp4":"assets/images/fallback/screens.jpg";_video=_this.initClass(VideoTexture,src)}(),await function initPlanes(){(_planesBatch=new MeshBatch).group.position.z=15,_planesBatch.frustumCulled=!1,[{amount:5,position:.5},{amount:8,position:1.1},{amount:9,position:1.6},{amount:8,position:2.1},{amount:6,position:2.6}].forEach(({amount:amount,position:position})=>{for(let column=0;column<amount;column++){let shader=_this.initClass(Shader,"ScreensBackgroundImage",{uAlpha:{value:.4},uLineMod:{value:.02},uLineStep:{value:.01},uLineAlpha:{value:.92},uLineSpeed:{value:1},uVisible:{value:Global.PLAYGROUND?1:0,batchUnique:!0},uFlip:{value:Utils.headsTails(0,1),batchUnique:!0},uPattern:{value:_positions.random(_positions.length-1),batchUnique:!0},uHover:{value:0},tVideo:{value:_video.texture},transparent:!0,blending:Shader.ADDITIVE_BLENDING,depthTest:!1,depthWrite:!1});ShaderUIL.add(shader);let phi=position,theta=column*(360/amount)*Math.PI/180,plane=new Mesh(World.PLANE_HIGH,shader),planeSize=Math.random(5,9,5);plane.scale.x=planeSize,plane.scale.y=planeSize,plane.position.x=Math.sin(phi)*Math.cos(theta),plane.position.y=Math.cos(phi),plane.position.z=Math.sin(phi)*Math.sin(theta),plane.position.normalize(),plane.position.multiplyScalar(20),_planes.push(plane),_planesBatch.add(plane)}}),_layout.add(_planesBatch)}(),Tests.ScreensBackgroundVolumetricLight()&&await function initPass(){[new Vector2(1.5*_this.nuke.dpr,0),new Vector2(0,1.5*_this.nuke.dpr)].forEach(value=>{let pass=new NukePass("LightBlur",{uDir:{value:value}});_this.nuke.add(pass)})}(),!Config.PROD&&Utils.query("debug")&&await function initDebug(){(_debug=$gl(Stage.width,Stage.height,"assets/images/_scenelayout/mask.jpg")).useShader(_shader),GLUI.Stage.add(_debug)}(),"ScreensBackground"===Global.PLAYGROUND&&_this.delayedCall(_=>{_this.animateIn()},500),_this.scene.add(_layout.group),_this.delayedCall(changeRandom,500),_this.startRender(loop),_this.flag("isReady",!0)}(),_this.onScroll=function(scroll){let value=.005*scroll;_direction=_scroll.target<value?-1:1,_scroll.target=value},_this.changeTexture=function(){_planes.forEach(plane=>{let pattern=_positions.random();for(;plane.shader.uniforms.uPattern.value==pattern;)pattern=_positions.random();plane.shader.uniforms.uPattern.value=pattern,plane.shader.uniforms.uFlip.value=Utils.headsTails(0,1),plane.shader.set("uHover",1),plane.shader.tween("uHover",0,1500,"easeOutSine")})},_this.animateIn=async function(){this.flag("isVisible")||(_this.flag("isVisible",!0),await _this.wait("isReady"),_video.start(),_planesBatch.group.position.z=-10,tween(_planesBatch.group.position,{z:0},6e3,"easeOutCubic"),tween(_this.shader.uniforms.uTransition,{value:1},2e3,"easeOutCubic"),_planes.forEach(plane=>{plane.shader.set("uVisible",0),plane.shader.tween("uVisible",1,2500,"easeOutCubic",Math.random(0,1e3))}))},_this.animateOut=function(){this.flag("isVisible")&&(_this.flag("isVisible",!1),_video.stop(),tween(_planesBatch.group.position,{z:5},2e3,"easeOutCubic"),tween(_this.shader.uniforms.uTransition,{value:.15},2e3,"easeOutCubic"))},_this.disable=function(){MouseFluid.instance().visible=!1,_this.visible=!1},_this.enable=function(){Tests.mouseFluid()&&(MouseFluid.instance().visible=!0),_this.visible=!0},_this.ready=function(){return _this.wait("isReady")}}),"singleton"),Class((function IntroGummiLeaks(_level){Inherit(this,IntroLevel,_level)})),Class((function LevelGummiLeaks(){Inherit(this,Level)})),Class((function City(_mesh,_shader){Inherit(this,Component);const _this=this;function getPixelatedTexture(src,scale){let texture=Utils3D.getTexture(src,scale);return texture.wrapS=texture.wrapT=Texture.REPEAT,texture.minFilter=texture.magFilter=Texture.NEAREST,texture}function onReset(){_shader.tween("uTrippy",0,500,"easeOutCubic")}function onEnd({success:success}){success&&_shader.tween("uTrippy",1,3750,"easeInQuad")}!function addHandlers(){_this.events.sub(Level.RESET,onReset),_this.events.sub(Level.END,onEnd)}(),_shader.addUniforms({tMap:{value:null,getTexture:getPixelatedTexture},uColor1:{value:new Color},uColor2:{value:new Color},uFogRange:{value:new Vector2},uVerticalFogRange:{value:new Vector2},uVerticalFogColor:{value:new Color},uTile:{value:new Vector2},uCloudsRange:{value:new Vector2},uSpeed:{value:1},uTrippy:{value:0},uTrippyRange:{value:320},uIdleBounce:{value:0},uTransitionOrigin:{value:new Vector3(-140,65,0)}}),Dev.expose("cityShader",_shader)})),Class((function Rain(_mesh,_shader){Inherit(this,Component);const _this=this;function onReset(){_shader.tween("uTrippy",0,500,"easeOutCubic")}function onEnd({success:success}){success&&_shader.tween("uTrippy",1,500,"easeOutSine")}Tests.enableRain()&&(function addHandlers(){_this.events.sub(Level.RESET,onReset),_this.events.sub(Level.END,onEnd)}(),_shader.addUniforms({uAlphaCutoff:{value:.5},uRange:{value:new Vector2(0,.05)},uFogRange:{value:new Vector2(0,-150)},uSpeed:{value:.4},uTile1:{value:.065},uTile2:{value:2e3},uTile3:{value:12.18},uColor1:{value:new Color},uColor2:{value:new Color},uFogColor:{value:new Color},uTrippy:{value:0}}))})),Class((function RainLayout(){Inherit(this,Object3D);const _this=this;!async function(){Tests.enableRain()&&(_this.layout=_this.initClass(SceneLayout,"RainLayout"))}()})),Class((function Sky(_mesh,_shader){Inherit(this,Component);const _this=this;function onReset(){_shader.tween("uTrippy",0,500,"easeOutCubic")}function onEnd({success:success}){success&&_shader.tween("uTrippy",1,1e3,"easeOutQuad",2500)}!function addHandlers(){_this.events.sub(Level.RESET,onReset),_this.events.sub(Level.END,onEnd)}(),_shader.addUniforms({uRange:{value:new Vector2(0,1)},uTile:{value:new Vector2(0,1)},uColor1:{value:new Color},uColor2:{value:new Color},uNoiseSpeed:{value:1},uNoiseStrength:{value:1},uTrippy:{value:0,ignoreUIL:!0}})})),Class((function IntroDataMine(_level){Inherit(this,IntroLevel,_level)})),Class((function LevelDataMine(){Inherit(this,Level)})),Class((function IntroCitricAlley(_level){Inherit(this,IntroLevel,_level)})),Class((function LevelCitricAlley(){Inherit(this,Level)})),Class((function IntroSugarRoad(_level){Inherit(this,IntroLevel,_level)})),Class((function LevelSugarRoad(){Inherit(this,Level)})),Class((function SugarRoadGlitch(_mesh,_shader,_input,_group){Inherit(this,Component);const _this=this,CONFIG=require("SugarRoadGlitch");var _player,_v2=new Vector2;function getTexture(src,scale){let texture=Utils3D.getTexture(src,scale);return texture.wrapS=texture.wrapT=Texture.REPEAT,texture.minFilter=texture.magFilter=Texture.NEAREST,texture}function getSpawn(vec2){let spawns=CONFIG.spawns.slice(),current=_mesh.transform,min=_this.flag("depth")-500;spawns=spawns.filter(point=>point.y<min).sort((a,b)=>_v2.copy(a).distanceTo(current)-_v2.copy(b).distanceTo(current)),spawns[0]&&vec2.copy(spawns[0])}function onStart(){if(Hydra.LOCAL&&Utils.query("disableGlitch"))return;let{start:start,end:end,onScreenProgress:onScreenProgress,offScreenProgress:offScreenProgress}=CONFIG;(_player=_this.parent.layers.player).movement.respawn=getSpawn,_mesh.transform.y=start,_this.startRender((function move(){_this.flag("depth",_mesh.transform.y-.5*_mesh.transform.height+275);let distance=-(_player.transform.y-_this.flag("depth")),amount=Math.range(distance,700,1100,onScreenProgress,offScreenProgress,!0);if(distance<=0){let data={src:"hazard",type:"glitch"};distance<-300?_this.events.fire(Level.RESET,{died:!0,src:data.src,type:data.type}):_this.events.fire(PlayerHealth.DAMAGE,data),amount*=.1}_mesh.transform.y-=amount,_mesh.transform.y=Math.max(end,_mesh.transform.y)}))}_this.flag("depth",0),Utils.query("debugGlitch")&&function initDebug(){let batch=new MeshBatch,shader=Utils3D.getTestShader(),geom=World.SPHERE,transforms=[];shader.addUniforms({depthWrite:!1,depthTest:!1});for(let spawn of CONFIG.spawns){let mesh=new Mesh(geom,shader);mesh.renderOrder=999999999,mesh.transform=new LevelTransform(mesh),mesh.transform.x=spawn.x,mesh.transform.y=spawn.y,mesh.transform.z=-1e3,transforms.push(mesh.transform),batch.add(mesh)}batch.frustumCulled=!1,batch.renderOrder=999999999,_mesh._parent.add(batch.group),_this.startRender(_=>{for(let t of transforms)t.update()})}(),function initShader(){_shader.addUniforms({tGlitchMap:{value:null,getTexture:getTexture},uColor:{value:new Color},uSurface:{value:.1},uWaveFrequency:{value:1},uWaveHeight:{value:1},uWaveSpeed:{value:1},uNoiseScale:{value:new Vector2(1,1)},uGlitchAmount:{value:1},uAlpha:{value:1},blending:Shader.ADDITIVE_BLENDING}),_mesh.renderOrder=999999999}(),function addHandlers(){_this.events.sub(Level.START,onStart)}()})),Class((function IntroExoticPetShop(_level){Inherit(this,IntroLevel,_level)})),Class((function LevelExoticPetShop(){Inherit(this,Level)})),Class((function LevelDemo(){Inherit(this,Level)})),Class((function LevelDesign(){Inherit(this,Level)})),Class((function LevelTest(){Inherit(this,Level)})),Class((function SpineTest(){Inherit(this,Object3D);const _this=this;!async function(){_this.layout=_this.initClass(SceneLayout,"spine_test");let test=await _this.layout.getLayer("animation");console.log(test),await _this.wait(2e3),test.animate("walk"),await _this.wait(2e3),test.animate("jump")}()})),Class((function Main(){Utils.query("performance")?Performance.displayResults():Tests.fallback()?Stage.add(new Fallback):function init(){if(Mobile.fullscreen(),Mobile.setOrientation("landscape"),GLUI.init(),!Config.PROD&&window.location.search.includes("p="))return AssetLoader.loadAssets(Assets.list().filter(["data","shaders"])).then(Playground.instance);Container.instance()}()}));
window._MINIFIED_=true;
window._BUILT_=true;