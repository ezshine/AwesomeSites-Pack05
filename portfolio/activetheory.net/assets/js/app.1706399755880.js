"undefined"==typeof console&&(window.console={},console.log=console.error=console.info=console.debug=console.warn=console.trace=function(){}),window.performance=window.performance&&window.performance.now?window.performance:Date,Date.now=Date.now||function(){return+new Date},window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(){const start=Date.now();return function(callback){window.setTimeout((()=>callback(Date.now()-start)),1e3/60)}}()),window.defer=window.requestAnimationFrame,window.clearTimeout=function(){const _clearTimeout=window.clearTimeout;return function(ref){return window.Timer&&Timer.__clearTimeout(ref)||_clearTimeout(ref)}}(),window.requestIdleCallback=function(){const _requestIdleCallback=window.requestIdleCallback;return function(callback,max){return _requestIdleCallback?_requestIdleCallback(callback,max?{timeout:max}:null):defer((()=>{callback({didTimeout:!1})}),0)}}(),window.onIdle=window.requestIdleCallback,"undefined"==typeof Float32Array&&(Float32Array=Array),Math.sign=function(x){return 0===(x=+x)||isNaN(x)?Number(x):x>0?1:-1},Math._round=Math.round,Math.round=function(value,precision=0){let p=Math.pow(10,precision);return Math._round(value*p)/p},Math._random=Math.random,Math.rand=Math.random=function(min,max,precision=0){return void 0===min?Math._random():min===max?min:(min=min||0,max=max||1,0==precision?Math.floor(Math._random()*(max+1-min)+min):Math.round(min+Math._random()*(max-min),precision))},Math.degrees=function(radians){return radians*(180/Math.PI)},Math.radians=function(degrees){return degrees*(Math.PI/180)},Math.clamp=function(value,min=0,max=1){return Math.min(Math.max(value,Math.min(min,max)),Math.max(min,max))},Math.map=Math.range=function(value,oldMin=-1,oldMax=1,newMin=0,newMax=1,isClamp){const newValue=(value-oldMin)*(newMax-newMin)/(oldMax-oldMin)+newMin;return isClamp?Math.clamp(newValue,Math.min(newMin,newMax),Math.max(newMin,newMax)):newValue},Math.mix=function(a,b,alpha){return a*(1-alpha)+b*alpha},Math.step=function(edge,value){return value<edge?0:1},Math.smoothStep=function(min,max,value){const x=Math.max(0,Math.min(1,(value-min)/(max-min)));return x*x*(3-2*x)},Math.fract=function(value){return value-Math.floor(value)},Math.lerp=function(target,value,alpha,calcHz=!0){return value+(target-value)*(alpha=calcHz?Math.framerateNormalizeLerpAlpha(alpha):Math.clamp(alpha))};{const mainThread=!!window.document;Math.framerateNormalizeLerpAlpha=function(t){return t=Math.clamp(t),mainThread?1-Math.exp(Math.log(1-t)*Render.FRAME_HZ_MULTIPLIER):t}}Math.mod=function(value,n){return(value%n+n)%n},Object.defineProperty(Array.prototype,"shuffle",{writable:!0,value:function(){let randomIndex,currentIndex=this.length;for(;0!=currentIndex;)randomIndex=Math.floor(Math.random()*currentIndex),currentIndex--,[this[currentIndex],this[randomIndex]]=[this[randomIndex],this[currentIndex]];return this}}),Array.storeRandom=function(arr){arr.randomStore=[]},Object.defineProperty(Array.prototype,"random",{writable:!0,value:function(range){let value=Math.random(0,this.length-1);if(arguments.length&&!this.randomStore&&Array.storeRandom(this),!this.randomStore)return this[value];if(range>this.length-1&&(range=this.length),range>1){for(;~this.randomStore.indexOf(value);)(value+=1)>this.length-1&&(value=0);this.randomStore.push(value),this.randomStore.length>=range&&this.randomStore.shift()}return this[value]}}),Object.defineProperty(Array.prototype,"remove",{writable:!0,value:function(element){if(!this.indexOf)return;const index=this.indexOf(element);return~index?this.splice(index,1):void 0}}),Object.defineProperty(Array.prototype,"last",{writable:!0,value:function(){return this[this.length-1]}}),window.Promise=window.Promise||{},Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function flat(){var depth=isNaN(arguments[0])?1:Number(arguments[0]);return depth?Array.prototype.reduce.call(this,(function(acc,cur){return Array.isArray(cur)?acc.push.apply(acc,flat.call(cur,depth-1)):acc.push(cur),acc}),[]):Array.prototype.slice.call(this)},writable:!0}),Promise.create=function(){const promise=new Promise(((resolve,reject)=>{this.temp_resolve=resolve,this.temp_reject=reject}));return promise.resolve=this.temp_resolve,promise.reject=this.temp_reject,delete this.temp_resolve,delete this.temp_reject,promise},Promise.catchAll=function(array){return Promise.all(array.map((promise=>promise&&"function"==typeof promise.catch?promise.catch((error=>{Promise.reject(error)})):promise)))},Promise.timeout=function(promise,timeout){Array.isArray(promise)&&(promise=Promise.all(promise));var timeoutPromise=Promise.create(),ref=Timer.create(timeoutPromise.resolve,timeout);return Promise.race([promise,timeoutPromise]).finally((function(){Timer.__clearTimeout(ref)}))},function(){function notRegExp(it){if(function isRegExp(it){if(!("object"==typeof it?null!==it:"function"==typeof it))return!1;var match=it["undefined"!=typeof Symbol?Symbol.match:"match"];return void 0!==match?!!match:"RegExp"===Object.prototype.toString.call(it).slice(8,-1)}(it))throw new Error("First argument to String.prototype.includes must not be a regular expression");return it}Object.defineProperty(String.prototype,"includes",{writable:!0,value:function(str){if(!Array.isArray(str))return!!~this.indexOf(notRegExp(str));for(let i=str.length-1;i>=0;i--)if(~this.indexOf(notRegExp(str[i])))return!0;return!1}})}(),Object.defineProperty(String.prototype,"equals",{writable:!0,value:function(str){let compare=String(this);if(!Array.isArray(str))return str===compare;for(let i=str.length-1;i>=0;i--)if(str[i]===compare)return!0;return!1}}),Object.defineProperty(String.prototype,"strpos",{writable:!0,value:function(str){return console.warn("strpos deprecated: use .includes()"),this.includes(str)}}),Object.defineProperty(String.prototype,"clip",{writable:!0,value:function(num,end=""){return this.length>num?this.slice(0,Math.max(0,num-end.length)).trim()+end:this.slice()}}),Object.defineProperty(String.prototype,"capitalize",{writable:!0,value:function(){return this.charAt(0).toUpperCase()+this.slice(1)}}),Object.defineProperty(String.prototype,"replaceAll",{writable:!0,value:function(find,replace){return this.split(find).join(replace)}}),Object.defineProperty(String.prototype,"replaceAt",{writable:!0,value:function(index,replacement){return this.substr(0,index)+replacement+this.substr(index+replacement.length)}}),(!window.fetch||!window.AURA&&location.protocol.includes("file"))&&(window.fetch=function(url,options){options=options||{};const promise=Promise.create(),request=new XMLHttpRequest;request.open(options.method||"get",url),url.includes(".ktx")&&(request.responseType="arraybuffer");for(let i in options.headers)request.setRequestHeader(i,options.headers[i]);function response(){let header,keys=[],all=[],headers={};return request.getAllResponseHeaders().replace(/^(.*?):\s*([\s\S]*?)$/gm,((m,key,value)=>{keys.push(key=key.toLowerCase()),all.push([key,value]),header=headers[key],headers[key]=header?`${header},${value}`:value})),{ok:1==(request.status/200|0),status:request.status,statusText:request.statusText,url:request.responseURL,clone:response,text:()=>Promise.resolve(request.responseText),json:()=>Promise.resolve(request.responseText).then(JSON.parse),xml:()=>Promise.resolve(request.responseXML),blob:()=>Promise.resolve(new Blob([request.response])),arrayBuffer:()=>Promise.resolve(request.response),headers:{keys:()=>keys,entries:()=>all,get:n=>headers[n.toLowerCase()],has:n=>n.toLowerCase()in headers}}}return request.onload=()=>{promise.resolve(response())},request.onerror=promise.reject,request.send(options.body),promise}),window.get=function(url,options={credentials:"same-origin"}){let promise=Promise.create();return options.method="GET",fetch(url,options).then((function handleResponse(e){if(!e.ok)return promise.reject(e);e.text().then((text=>{if(text.charAt(0).includes(["[","{"]))try{promise.resolve(JSON.parse(text))}catch(err){promise.resolve(text)}else promise.resolve(text)}))})).catch(promise.reject),promise},window.post=function(url,body={},options={}){let promise=Promise.create();return options.method="POST",body&&(options.body="object"==typeof body||Array.isArray(body)?JSON.stringify(body):body),options.headers||(options.headers={"content-type":"application/json"}),fetch(url,options).then((function handleResponse(e){if(!e.ok)return promise.reject(e);e.text().then((text=>{if(text.charAt(0).includes("[")||text.charAt(0).includes("{"))try{promise.resolve(JSON.parse(text))}catch(err){promise.resolve(text)}else promise.resolve(text)}))})).catch(promise.reject),promise},window.put=function(url,body,options={}){let promise=Promise.create();return options.method="PUT",body&&(options.body="object"==typeof body||Array.isArray(body)?JSON.stringify(body):body),fetch(url,options).then((function handleResponse(e){if(!e.ok)return promise.reject(e);e.text().then((text=>{if(text.charAt(0).includes(["[","{"]))try{promise.resolve(JSON.parse(text))}catch(err){promise.resolve(text)}else promise.resolve(text)}))})).catch(promise.reject),promise},"undefined"==typeof WeakRef&&function(){var targetProp="undefined"!=typeof Symbol?Symbol("WeakRefTarget"):"@@WeakRefTarget";function WeakRef(target){this[targetProp]=target}WeakRef.prototype.deref=function(){return this[targetProp]},window.WeakRef=WeakRef}(),window.Class=function(_class,_type,_static){const _this=this||window,_name=_class.name||_class.toString().match(/function ?([^\(]+)/)[1];"function"==typeof _type&&(_static=_type,_type=null),(_type=(_type||"").toLowerCase())?"static"==_type?_this[_name]=new _class:"singleton"==_type&&(_this[_name]=_class,function(){let _instance;_this[_name].instance=function(){return _instance||(_instance=new _class(...arguments)),_instance}}(),_static&&_static()):(_this[_name]=_class,_static&&_static()),this&&this!==window&&(this[_name]._namespace=this.__namespace)},window.Inherit=function(child,parent){const args=[].slice.call(arguments,2);parent.apply(child,args);const save={};for(let method in child)save[method]=child[method];const addSuperMethods=()=>{for(let method in save)if(child[method]&&child[method]!==save[method]){if("destroy"==method&&!child.__element)throw"Do not override destroy directly, use onDestroy :: "+child.constructor.toString();let name=method;do{name=`_${name}`}while(child[name]);child[name]=save[method]}};child.__afterInitClass?child.__afterInitClass.push(addSuperMethods):defer(addSuperMethods)},window.Namespace=function(obj){"string"==typeof obj?window[obj]||(window[obj]={Class:Class,__namespace:obj}):(obj.Class=Class,obj.__namespace=obj.constructor.name||obj.constructor.toString().match(/function ([^\(]+)/)[1])},window.Global={},window.THREAD=!1,Class((function Hydra(){const _this=this,_readyPromise=Promise.create();var _base,_callbacks=[];function initLoad(){return document&&window?window._NODE_?setTimeout(loaded,1):window._AURA_?window.Main?setTimeout(loaded,1):setTimeout(initLoad,1):void("complete"===document.readyState?setTimeout(loaded,1):window.addEventListener("load",loaded,!1)):setTimeout(initLoad,1)}function loaded(){if(window.removeEventListener("load",loaded,!1),window._HYDRA_BEFORE_READY){let promise=window._HYDRA_BEFORE_READY;return delete window._HYDRA_BEFORE_READY,promise.then(loaded)}_this.LOCAL=(!window._BUILT_||location.pathname.toLowerCase().includes("platform"))&&(location.hostname.indexOf("local")>-1||"10"==location.hostname.split(".")[0]||"192"==location.hostname.split(".")[0]||/atdev.online$/.test(location.hostname))&&(""==location.port||"3000"===location.port),_callbacks.forEach((cb=>cb())),_callbacks=null,_readyPromise.resolve(),window.Main&&_readyPromise.then((()=>Hydra.Main=new window.Main))}this.HASH=window.location.hash.slice(1),this.LOCAL=!window._BUILT_&&(location.hostname.indexOf("local")>-1||"10"==location.hostname.split(".")[0]||"192"==location.hostname.split(".")[0]||/atdev.online$/.test(location.hostname))&&(""==location.port||"3000"===location.port),initLoad(),this.__triggerReady=function(){_callbacks||loaded()},this.ready=function(callback){if(!callback)return _readyPromise;_callbacks?_callbacks.push(callback):callback()},this.absolutePath=function(path){if(window.AURA)return path;let base=window.HYDRA_BASE_PATH??_base;if(void 0===base)try{if(document.getElementsByTagName("base").length>0){var a=document.createElement("a");a.href=document.getElementsByTagName("base")[0].href,base=a.pathname,_base=base}}catch(e){_base=null}let pathname=base??location.pathname;pathname.includes("/index.html")&&(pathname=pathname.replace("/index.html",""));let port=Number(location.port)>1e3?`:${location.port}`:"";return path.includes("http")?path:(location.protocol.length?location.protocol+"//":"")+(location.hostname+port+pathname+"/"+path).replace("//","/")}}),"Static"),Class((function Utils(){var _queries={},_searchParams=new URLSearchParams(window.location.search);this.query=this.queryParams=function(key,value){if(void 0!==value&&(_queries[key]=value),void 0!==_queries[key])return _queries[key];if(_searchParams)"0"===(value=_searchParams.get(key))?value=0:"false"===value||null===value?value=!1:""===value&&(value=!0);else{let escapedKey=encodeURIComponent(key).replace(/[\.\+\*]/g,"\\$&");"0"==(value=decodeURIComponent(window.location.search.replace(new RegExp(`^(?:.*?[&?]${escapedKey}(?:=([^&]*)|[&$]))?.*$`,"i"),"$1")))?value=0:"false"==value?value=!1:value.length||(value=new RegExp(`[&?]${escapedKey}(?:[&=]|$)`,"i").test(window.location.search))}return _queries[key]=value,value},this.addQuery=function(query,value){if(_queries[query]===value)return _queries[query];let url=new URL(location.href);return url.searchParams.set(query,value),_searchParams=url.searchParams,window.history.replaceState({},document.title,url.toString()),_queries[query]=value},this.removeQuery=function(query){let url=new URL(location.href);return url.searchParams.delete(query),_searchParams=url.searchParams,window.history.replaceState({},document.title,url.toString()),delete _queries[query]},this.addQueryToPath=function(path,hash){return[[path,_searchParams.toString()].filter(Boolean).join("?"),hash].filter(Boolean).join("#")},this.addParam=function(url,param,value){let index=url.indexOf("?"),prefix=url.substring(0,index+1),suffix=url.substring(index+1),searchParams=new URLSearchParams(suffix);return searchParams.append(param,value),prefix+searchParams.toString()},this.removeParam=function(url,param){let index=url.indexOf("?"),prefix=url.substring(0,index+1),suffix=url.substring(index+1),searchParams=new URLSearchParams(suffix);return searchParams.delete(param),prefix+searchParams.toString()},this.getConstructorName=function(obj){return obj?(obj.___constructorName||(obj.___constructorName="function"==typeof obj?obj.toString().match(/function ([^\(]+)/)?.[1]:obj.constructor.name||obj.constructor.toString().match(/function ([^\(]+)/)?.[1]),obj.___constructorName):obj},this.nullObject=function(object){if(object&&(object.destroy||object.div))for(var key in object)void 0!==object[key]&&(object[key]=null);return null},this.cloneObject=function(obj){return JSON.parse(JSON.stringify(obj))},this.headsTails=function(n0,n1){return Math.random(0,1)?n1:n0},this.mergeObject=function(){for(var obj={},i=0;i<arguments.length;i++){var o=arguments[i];for(var key in o)obj[key]=o[key]}return obj},this.timestamp=this.uuid=function(){return Date.now()+"xx-4xx-yxx-xxx".replace(/[xy]/g,(function(c){let r=16*Math.random()|0;return("x"==c?r:3&r|8).toString(16)}))},this.randomColor=function(){var color="#"+Math.floor(16777215*Math.random()).toString(16);return color.length<7&&(color=this.randomColor()),color},this.numberWithCommas=function(num){return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},this.padInt=function(num,digits,isLimit){isLimit&&(num=Math.min(num,Math.pow(10,digits)-1));let str=Math.floor(num).toString();return Math.pow(10,Math.max(0,digits-str.length)).toString().slice(1)+str},this.copyToClipboard=function(string){try{var el=document.createElement("textarea"),range=document.createRange();el.contentEditable=!0,el.readOnly=!0,el.value=string,document.body.appendChild(el),el.select(),range.selectNodeContents(el);var s=window.getSelection();return s.removeAllRanges(),s.addRange(range),el.setSelectionRange(0,string.length),document.execCommand("copy"),document.body.removeChild(el),!0}catch(e){return!1}},this.stringList=function(items=[],limit=0,options={}){if(0===items.length)return"";let output="",printed=0;"object"==typeof limit&&(options=limit,limit=0),options.oxford=!0===options.oxford,options.more=!1!==options.more&&(options.more?options.more:"more"),options.and=options.and?options.and:"&",options.comma=options.comma?options.comma:",",isNaN(options.limit)||(limit=options.limit),0===limit&&(limit=items.length);do{output=`${output}${items.shift()}${options.comma} `,printed++}while(items.length>1&&printed+1<limit);if(output=output.trim(),output=output.slice(0,output.length-1),1===items.length)output=`${output}${options.oxford&&printed>1?options.comma:""} ${options.and} ${items.shift()}`;else if(items.length>1&&options.more){let more=`${items.length} ${options.more}`;output=`${output}${options.oxford&&printed>1?options.comma:""} ${options.and} ${more}`}return output},this.debounce=function(callback,time=100,data){clearTimeout(callback.__interval),callback.__interval=Timer.create((_=>callback(data)),time)}}),"Static"),Class((function Render(){const _this=this,_render=[],_native=[],_drawFrame=[],_multipliers=[];let _renderIndex=null,_nativeIndex=null;var _last=performance.now(),_localTSL=0,_elapsed=0,_capLast=0,_sampleRefreshRate=[],_firstSample=!1,_saveRefreshRate=60,rAF=requestAnimationFrame,_refreshScale=1,_canCap=0,_screenHash=getScreenHash();function render(tsl){if(_last>=tsl)return void(THREAD||_this.isPaused||rAF(render));if(_native.length){let multiplier=60/_saveRefreshRate;for(_nativeIndex=_native.length-1;_nativeIndex>-1;_nativeIndex--){let callback=_native[_nativeIndex];try{callback(multiplier)}catch(error){handleRenderCallbackError(callback,error)}}_nativeIndex=null}if(_this.capFPS>0&&++_canCap>31){let delta=tsl-_capLast;if(_capLast=tsl,(_elapsed+=delta)<1e3/_this.capFPS)return void(THREAD||_this.isPaused||rAF(render));_this.REFRESH_RATE=_this.capFPS,_this.HZ_MULTIPLIER=60/_this.REFRESH_RATE*_refreshScale,_elapsed=0}if(_this.timeScaleUniform.value=1,_multipliers.length)for(let i=0;i<_multipliers.length;i++){let obj=_multipliers[i];_this.timeScaleUniform.value*=obj.value}_this.DT=tsl-_last,_last=tsl;let delta=_this.DT*_this.timeScaleUniform.value;if(delta=Math.min(200,delta),_sampleRefreshRate&&!_this.capFPS){let fps=1e3/_this.DT;if(_sampleRefreshRate.push(fps),_sampleRefreshRate.length>30){_sampleRefreshRate.sort(((a,b)=>a-b));let rate=_sampleRefreshRate[Math.round(_sampleRefreshRate.length/2)];rate=_this.REFRESH_TABLE.reduce(((prev,curr)=>Math.abs(curr-rate)<Math.abs(prev-rate)?curr:prev)),_this.REFRESH_RATE=_saveRefreshRate=_firstSample?Math.max(_this.REFRESH_RATE,rate):rate,_this.HZ_MULTIPLIER=60/_this.REFRESH_RATE*_refreshScale,_sampleRefreshRate=null,_firstSample=!0}}for(_this.TIME=tsl,_this.DELTA=delta,_this.startFrame&&_this.startFrame(tsl,delta),_localTSL+=delta,_renderIndex=_render.length-1;_renderIndex>=0;_renderIndex--){var callback=_render[_renderIndex];if(callback)try{if(callback.fps){if(tsl-callback.last<1e3/callback.fps)continue;callback(++callback.frame),callback.last=tsl;continue}callback(tsl,delta)}catch(error){handleRenderCallbackError(callback,error)}else _render.splice(_renderIndex,1)}_renderIndex=null;for(let i=_drawFrame.length-1;i>-1;i--)_drawFrame[i](tsl,delta);_this.drawFrame&&_this.drawFrame(tsl,delta),_this.endFrame&&_this.endFrame(tsl,delta),THREAD||_this.isPaused||rAF(render)}function handleRenderCallbackError(callback,error){if(Hydra.LOCAL)throw error;let evt={callback:callback,error:error,preventStopRender:!1};Events.emitter._fireEvent(_this.RENDER_CALLBACK_ERROR,evt),evt.preventStopRender||_this.stop(callback)}function getScreenHash(){return window.screen?`${window.screen.width}x${window.screen.height}.${window.screen.pixelDepth}`:"none"}function checkMoveScreen(){var newScreen=getScreenHash();_screenHash!==newScreen&&(_screenHash=newScreen,_sampleRefreshRate=null,_firstSample=!1)}this.timeScaleUniform={value:1,type:"f",ignoreUIL:!0},this.REFRESH_TABLE=[30,60,72,90,100,120,144,240],this.REFRESH_RATE=60,this.HZ_MULTIPLIER=1,this.RENDER_CALLBACK_ERROR="render_callback_error",this.capFPS=null,THREAD||(rAF(render),setInterval((_=>_sampleRefreshRate=[]),3e3),setInterval(checkMoveScreen,5e3)),this.now=function(){return _localTSL},this.setRefreshScale=function(scale){_refreshScale=scale,_sampleRefreshRate=[]},this.start=function(callback,fps,native){fps&&(callback.fps=fps,callback.last=-1/0,callback.frame=-1),native?~_native.indexOf(callback)||(_native.unshift(callback),null!==_nativeIndex&&(_nativeIndex+=1)):~_render.indexOf(callback)||(_render.unshift(callback),null!==_renderIndex&&(_renderIndex+=1))},this.stop=function(callback){let i=_render.indexOf(callback);i>=0&&(_render.splice(i,1),null!==_renderIndex&&i<_renderIndex&&(_renderIndex-=1)),i=_native.indexOf(callback),i>=0&&(_native.splice(i,1),null!==_nativeIndex&&i<_nativeIndex&&(_nativeIndex-=1))},this.tick=function(){THREAD&&(this.TIME=performance.now(),render(this.TIME))},this.forceRender=function(time){this.TIME=time,render(this.TIME)},this.Worker=function(_callback,_budget=4){Inherit(this,Component);let _scope=this,_elapsed=0;function loop(){if(!_scope.dead){for(;_elapsed<_budget;){if(_scope.dead||_scope.paused)return;const start=performance.now();_callback&&_callback(),_elapsed+=performance.now()-start}_elapsed=0}}this.startRender(loop),this.stop=function(){this.dead=!0,this.stopRender(loop)},this.pause=function(){this.paused=!0,this.stopRender(loop)},this.resume=function(){this.paused=!1,this.startRender(loop)},this.setCallback=function(cb){_callback=cb}},this.pause=function(){_this.isPaused=!0},this.resume=function(){_this.isPaused&&(_this.isPaused=!1,rAF(render))},this.useRAF=function(raf){_firstSample=null,_last=performance.now(),(rAF=raf)(render)},this.onDrawFrame=function(cb){_drawFrame.push(cb)},this.setTimeScale=function(v){_this.timeScaleUniform.value=v},this.getTimeScale=function(){return _this.timeScaleUniform.value},this.createTimeMultiplier=function(){let obj={value:1};return _multipliers.push(obj),obj},this.destroyTimeMultiplier=function(obj){_multipliers.remove(obj)},this.tweenTimeScale=function(value,time,ease,delay){return tween(_this.timeScaleUniform,{value:value},time,ease,delay,null,null,!0)},Object.defineProperty(_this,"FRAME_HZ_MULTIPLIER",{get:()=>60/(1e3/_this.DELTA)*_refreshScale,enumerable:!0})}),"Static"),Class((function Timer(){const _this=this,_callbacks=[],_discard=[],_deferA=[],_deferB=[];var _defer=_deferA,_deferNextTicks=[];function loop(t,delta){for(let i=_discard.length-1;i>=0;i--){let obj=_discard[i];obj.callback=null,_callbacks.remove(obj)}_discard.length&&(_discard.length=0);for(let i=_callbacks.length-1;i>=0;i--){let obj=_callbacks[i];obj?(obj.scaledTime?obj.current+=delta:obj.current+=Render.DT,obj.current>=obj.time&&(obj.callback&&obj.callback(),_discard.push(obj))):_callbacks.remove(obj)}for(let i=_defer.length-1;i>-1;i--)_defer[i]();_defer.length=0,_defer=_defer==_deferA?_deferB:_deferA}function handleDeferNextTick(e){if(null!=e&&e.source===window&&"_hydraDeferNextTick"===e.data&&(e.stopPropagation(),_deferNextTicks.length>0)){_deferNextTicks.shift()()}}Render.start(loop),window.addEventListener("message",handleDeferNextTick,!0),this.__clearTimeout=function(ref){const obj=function find(ref){for(let i=_callbacks.length-1;i>-1;i--)if(_callbacks[i].ref==ref)return _callbacks[i]}(ref);return!!obj&&(obj.callback=null,_callbacks.remove(obj),!0)},this.create=function(callback,time,scaledTime){if(window._NODE_)return setTimeout(callback,time);const obj={time:Math.max(1,time||1),current:0,ref:Utils.timestamp(),callback:callback,scaledTime:scaledTime};return _callbacks.unshift(obj),obj.ref},this.delayedCall=function(time){let promise=Promise.create();return _this.create(promise.resolve,time),promise},window.defer=this.defer=function(callback){let promise;return callback||(promise=Promise.create(),callback=promise.resolve),(_defer==_deferA?_deferB:_deferA).unshift(callback),promise},window.deferNextTick=this.deferNextTick=function(callback){let promise;return callback||(promise=Promise.create(),callback=promise.resolve),_deferNextTicks.push(callback),callback.time=performance.now(),window.postMessage("_hydraDeferNextTick","*"),promise}}),"static"),Class((function Events(){const _this=this;this.events={};const _e={},_linked=[];let _emitter;this.events.sub=function(obj,evt,callback){if("object"!=typeof obj&&(callback=evt,evt=obj,obj=null),!obj)return Events.emitter._addEvent(evt,callback.resolve?callback.resolve:callback,this),callback;let emitter=obj.events.emitter();return emitter._addEvent(evt,callback.resolve?callback.resolve:callback,this),emitter._saveLink(this),_linked.push(emitter),callback},this.events.wait=async function(obj,evt){const promise=Promise.create(),args=[obj,evt,e=>{_this.events.unsub(...args),promise.resolve(e)}];return"object"!=typeof obj&&args.splice(1,1),_this.events.sub(...args),promise},this.events.unsub=function(obj,evt,callback){if("object"!=typeof obj&&(callback=evt,evt=obj,obj=null),!obj)return Events.emitter._removeEvent(evt,callback.resolve?callback.resolve:callback);obj.events.emitter()._removeEvent(evt,callback.resolve?callback.resolve:callback)},this.events.fire=function(evt,obj,isLocalOnly){(obj=obj||_e).target=this,Events.emitter._check(evt),_emitter&&_emitter._fireEvent(evt,obj)||isLocalOnly||Events.emitter._fireEvent(evt,obj)},this.events.bubble=function(obj,evt){_this.events.sub(obj,evt,(e=>_this.events.fire(evt,e)))},this.events.destroy=function(){return Events.emitter._destroyEvents(this),_linked&&_linked.forEach((emitter=>emitter._destroyEvents(this))),_emitter&&_emitter.links&&_emitter.links.forEach((obj=>obj.events&&obj.events._unlink(_emitter))),null},this.events.emitter=function(){return _emitter||(_emitter=Events.emitter.createLocalEmitter()),_emitter},this.events._unlink=function(emitter){_linked.remove(emitter)}}),(()=>{Events.emitter=new function Emitter(){const prototype=Emitter.prototype;if(this.events=[],void 0!==prototype._check)return;prototype._check=function(evt){if(void 0===evt)throw"Undefined event"},prototype._addEvent=function(evt,callback,object){this._check(evt),this.events.push({evt:evt,object:object,callback:callback})},prototype._removeEvent=function(eventString,callback){this._check(eventString);for(let i=this.events.length-1;i>=0;i--)this.events[i].evt===eventString&&this.events[i].callback===callback&&this._markForDeletion(i)},prototype._sweepEvents=function(){for(let i=0;i<this.events.length;i++)this.events[i].markedForDeletion&&(delete this.events[i].markedForDeletion,this.events.splice(i,1),--i)},prototype._markForDeletion=function(i){this.events[i].markedForDeletion=!0,this._sweepScheduled||(this._sweepScheduled=!0,defer((()=>{this._sweepScheduled=!1,this._sweepEvents()})))},prototype._fireEvent=function(eventString,obj){this._check&&this._check(eventString),obj=obj||_e;let called=!1;for(let i=0;i<this.events.length;i++){let evt=this.events[i];evt.evt!=eventString||evt.markedForDeletion||(evt.callback(obj),called=!0)}return called},prototype._destroyEvents=function(object){for(var i=this.events.length-1;i>=0;i--)this.events[i].object===object&&this._markForDeletion(i)},prototype._saveLink=function(obj){this.links||(this.links=[]),~this.links.indexOf(obj)||this.links.push(obj)},prototype.createLocalEmitter=function(){return new Emitter}},Events.broadcast=Events.emitter._fireEvent,Events.VISIBILITY="hydra_visibility",Events.HASH_UPDATE="hydra_hash_update",Events.COMPLETE="hydra_complete",Events.PROGRESS="hydra_progress",Events.CONNECTIVITY="hydra_connectivity",Events.UPDATE="hydra_update",Events.LOADED="hydra_loaded",Events.END="hydra_end",Events.FAIL="hydra_fail",Events.SELECT="hydra_select",Events.ERROR="hydra_error",Events.READY="hydra_ready",Events.RESIZE="hydra_resize",Events.CLICK="hydra_click",Events.HOVER="hydra_hover",Events.MESSAGE="hydra_message",Events.ORIENTATION="orientation",Events.BACKGROUND="background",Events.BACK="hydra_back",Events.PREVIOUS="hydra_previous",Events.NEXT="hydra_next",Events.RELOAD="hydra_reload",Events.UNLOAD="hydra_unload",Events.FULLSCREEN="hydra_fullscreen",Events.WEBGL_CONTEXT_LOSS="hydra_webgl_context_loss";const _e={};Hydra.ready((()=>{let box;!function(){let _last,_lastTime=performance.now();function onfocus(){Render.blurTime=-1,"focus"!=_last&&Events.emitter._fireEvent(Events.VISIBILITY,{type:"focus"}),_last="focus"}function onblur(){Render.blurTime=Date.now(),"blur"!=_last&&Events.emitter._fireEvent(Events.VISIBILITY,{type:"blur"}),_last="blur"}Timer.create((function addVisibilityHandler(){let hidden,eventName;if([["msHidden","msvisibilitychange"],["webkitHidden","webkitvisibilitychange"],["hidden","visibilitychange"]].forEach((d=>{void 0!==document[d[0]]&&(hidden=d[0],eventName=d[1])})),!eventName){const root="ie"==Device.browser?document:window;return root.onfocus=onfocus,void(root.onblur=onblur)}document.addEventListener(eventName,(()=>{const time=performance.now();time-_lastTime>10&&(!1===document[hidden]?onfocus():onblur()),_lastTime=time}))}),250),window.addEventListener("online",(_=>Events.emitter._fireEvent(Events.CONNECTIVITY,{online:!0}))),window.addEventListener("offline",(_=>Events.emitter._fireEvent(Events.CONNECTIVITY,{online:!1}))),window.onbeforeunload=_=>(Events.emitter._fireEvent(Events.UNLOAD),null)}(),window.Stage=window.Stage||{},"social"==Device.system.browser&&"ios"==Device.system.os&&(box=document.createElement("div"),box.style.position="fixed",box.style.top=box.style.left=box.style.right=box.style.bottom="0px",box.style.zIndex="-1",box.style.opacity="0",box.style.pointerEvents="none",document.body.appendChild(box)),updateStage();let timer,iosResize="ios"===Device.system.os,html=!!iosResize&&document.querySelector("html"),delay=iosResize?500:16;function updateStage(){if(box){let bbox=box.getBoundingClientRect();Stage.width=bbox.width||window.innerWidth||document.body.clientWidth||document.documentElement.offsetWidth,Stage.height=bbox.height||window.innerHeight||document.body.clientHeight||document.documentElement.offsetHeight,document.body.parentElement.scrollTop=document.body.scrollTop=0,document.documentElement.style.width=document.body.style.width=`${Stage.width}px`,document.documentElement.style.height=document.body.style.height=`${Stage.height}px`,Events.emitter._fireEvent(Events.RESIZE)}else Stage.width=window.innerWidth||document.body.clientWidth||document.documentElement.offsetWidth,Stage.height=Stage.isNormalMobileScroll&&Stage.div.offsetHeight||window.innerHeight||document.body.clientHeight||document.documentElement.offsetHeight}window.addEventListener("resize",(function handleResize(){clearTimeout(timer),timer=setTimeout((_=>{updateStage(),html&&Math.min(window.screen.width,window.screen.height)!==Stage.height&&!Mobile.isAllowNativeScroll&&(html.scrollTop=-1),Events.emitter._fireEvent(Events.RESIZE)}),delay)})),window.onorientationchange=window.onresize,"social"==Device.system.browser&&(Stage.height>=screen.height||Stage.width>=screen.width)&&setTimeout(updateStage,1e3),defer(window.onresize)}))})),Class((function Device(){var vid,_this=this;this.agent=navigator.userAgent.toLowerCase(),this.detect=function(match){return this.agent.includes(match)},this.touchCapable=!!navigator.maxTouchPoints,this.pixelRatio=window.devicePixelRatio,this.system={},this.system.retina=window.devicePixelRatio>1,this.system.webworker=void 0!==window.Worker,window._NODE_||(this.system.geolocation=void 0!==navigator.geolocation),window._NODE_||(this.system.pushstate=void 0!==window.history.pushState),this.system.webcam=!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.mediaDevices),this.system.language=window.navigator.userLanguage||window.navigator.language,this.system.webaudio=void 0!==window.AudioContext,this.system.xr={},this.system.detectXR=async function(){if(window.AURA)return _this.system.xr.vr=!0,void(_this.system.xr.ar=!0);if(!navigator.xr)return _this.system.xr.vr=!1,void(_this.system.xr.ar=!1);try{[_this.system.xr.vr,_this.system.xr.ar]=await Promise.all([navigator.xr.isSessionSupported("immersive-vr"),navigator.xr.isSessionSupported("immersive-ar")])}catch(e){}"android"==_this.system.os&&(_this.detect("oculus")||(_this.system.xr.vr=!1))};try{this.system.localStorage=void 0!==window.localStorage}catch(e){this.system.localStorage=!1}this.system.fullscreen=document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled,this.system.os=_this.detect(["ipad","iphone","ios"])||function detectIpad(){let aspect=Math.max(screen.width,screen.height)/Math.min(screen.width,screen.height);return _this.detect("mac")&&_this.touchCapable&&Math.abs(aspect-4/3)<Math.abs(aspect-1.6)}()?"ios":_this.detect(["android","kindle"])?"android":_this.detect(["blackberry"])?"blackberry":_this.detect(["mac os"])?"mac":_this.detect(["windows","iemobile"])?"windows":_this.detect(["linux"])?"linux":"unknown",this.system.version=function(){try{if("ios"==_this.system.os){if(_this.agent.includes("intel mac")){let split=_this.agent.split("version/")[1].split(" ")[0].split(".");return Number(split[0]+"."+split[1])}var num=_this.agent.split("os ")[1].split("_"),main=num[0],sub=num[1].split(" ")[0];return Number(main+"."+sub)}if("android"==_this.system.os){var version=_this.agent.split("android ")[1].split(";")[0];return version.length>3&&(version=version.slice(0,-2)),"."==version.charAt(version.length-1)&&(version=version.slice(0,-1)),Number(version)}if("windows"==_this.system.os)return _this.agent.includes("rv:11")?11:Number(_this.agent.split("windows phone ")[1].split(";")[0])}catch(e){}return-1}(),this.system.browser="ios"==_this.system.os?_this.detect(["twitter","fbios","instagram"])?"social":_this.detect(["crios"])?"chrome":_this.detect(["fxios"])?"firefox":_this.detect(["safari"])?"safari":"unknown":"android"==_this.system.os?_this.detect(["twitter","fb","facebook","instagram"])?"social":_this.detect(["chrome"])?"chrome":_this.detect(["firefox"])?"firefox":"browser":_this.detect(["msie"])||_this.detect(["trident"])&&_this.detect(["rv:"])||_this.detect(["windows"])&&_this.detect(["edge"])?"ie":_this.detect(["chrome"])?"chrome":_this.detect(["safari"])?"safari":_this.detect(["firefox"])?"firefox":"unknown",this.system.browserVersion=function(){try{if("chrome"==_this.system.browser)return _this.detect("crios")?Number(_this.agent.split("crios/")[1].split(".")[0]):Number(_this.agent.split("chrome/")[1].split(".")[0]);if("firefox"==_this.system.browser)return Number(_this.agent.split("firefox/")[1].split(".")[0]);if("safari"==_this.system.browser)return Number(_this.agent.split("version/")[1].split(".")[0].split(".")[0]);if("ie"==_this.system.browser)return _this.detect(["msie"])?Number(_this.agent.split("msie ")[1].split(".")[0]):_this.detect(["rv:"])?Number(_this.agent.split("rv:")[1].split(".")[0]):Number(_this.agent.split("edge/")[1].split(".")[0])}catch(e){return-1}}(),this.mobile=!(window._NODE_||!("ontouchstart"in window)&&!("onpointerdown"in window)||!_this.system.os.includes(["ios","android","magicleap"]))&&{},_this.detect("oculusbrowser")&&(this.mobile=!0),_this.detect("quest")&&(this.mobile=!0),this.mobile&&this.detect(["windows"])&&!this.detect(["touch"])&&(this.mobile=!1),this.mobile&&(this.mobile.tablet=Math.max(window.screen?screen.width:window.innerWidth,window.screen?screen.height:window.innerHeight)>1e3,this.mobile.phone=!this.mobile.tablet,this.mobile.pwa=!(!window.matchMedia||!window.matchMedia("(display-mode: standalone)").matches)||!!window.navigator.standalone,Hydra.ready((()=>{_this.mobile.native=!(!Mobile.NativeCore||!Mobile.NativeCore.active)||!!window._AURA_}))),this.media={},this.media.audio=!!document.createElement("audio").canPlayType&&(_this.detect(["firefox","opera"])?"ogg":"mp3"),this.media.video=((vid=document.createElement("video")).setAttribute("muted",!0),vid.setAttribute("loop",!0),vid.setAttribute("autoplay",!0),vid.setAttribute("preload",!0),vid.setAttribute("playsinline",!0),vid.setAttribute("webkit-playsinline",!0),vid.autoplay=!0,vid.muted=!0,vid.src="data:video/mp4;base64,AAAAIGZ0eXBtcDQyAAACAG1wNDJpc28yYXZjMW1wNDEAAANObW9vdgAAAGxtdmhkAAAAAOA5QnjgOUJ4AAAD6AAAAEMAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAmt0cmFrAAAAXHRraGQAAAAD4DlCeOA5QngAAAABAAAAAAAAAEMAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAACAAAAAgAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAABDAAAAAAABAAAAAAHjbWRpYQAAACBtZGhkAAAAAOA5QnjgOUJ4AAFfkAAAF3BVxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAABjm1pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAU5zdGJsAAAAznN0c2QAAAAAAAAAAQAAAL5hdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAACAAIABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAAMWF2Y0MBTUAo/+EAGWdNQCjspLYC1BgYGQAAAwABAAK/IA8YMZYBAAVo6uEyyAAAABNjb2xybmNseAAGAAYABgAAAAAQcGFzcAAAAAEAAAABAAAAFGJ0cnQAAAAAAAF1IAABdSAAAAAYc3R0cwAAAAAAAAABAAAAAgAAC7gAAAAUc3RzcwAAAAAAAAABAAAAAQAAABxzdHNjAAAAAAAAAAEAAAABAAAAAgAAAAEAAAAcc3RzegAAAAAAAAAAAAAAAgAAAxAAAAAMAAAAFHN0Y28AAAAAAAAAAQAAA34AAABvdWR0YQAAAGdtZXRhAAAAAAAAACFoZGxyAAAAAAAAAABtZGlyYXBwbAAAAAAAAAAAAAAAADppbHN0AAAAMql0b28AAAAqZGF0YQAAAAEAAAAASGFuZEJyYWtlIDEuNi4xIDIwMjMwMTIyMDAAAAAIZnJlZQAAAyRtZGF0AAAC9AYF///w3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE2NCByMzEwMCBlZDBmN2E2IC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAyMiAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTIgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MToweDExMSBtZT1oZXggc3VibWU9NiBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MCBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTEgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTEga2V5aW50PTMwMCBrZXlpbnRfbWluPTMwIHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9MzAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMi4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCB2YnZfbWF4cmF0ZT0yMDAwMCB2YnZfYnVmc2l6ZT0yNTAwMCBjcmZfbWF4PTAuMCBuYWxfaHJkPW5vbmUgZmlsbGVyPTAgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAABRliIQAK//+9q78yyt0fpUs1YVPgQAAAAhBmiFsQn/+Vg==",vid.play(),vid.addEventListener("canplaythrough",(_=>{vid.paused&&_this.mobile&&(_this.mobile.lowPowerMode=!0),setTimeout((_=>vid.pause()),500)})),!!vid.canPlayType&&(vid.canPlayType("video/webm;")?"webm":"mp4")),this.media.webrtc=!!(window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection||window.oRTCPeerConnection||window.RTCPeerConnection),this.graphics={},this.graphics.webgl=function(){let DISABLED=!1;Object.defineProperty(_this.graphics,"webgl",{get:()=>{if(DISABLED)return!1;if(_this.graphics._webglContext)return _this.graphics._webglContext;try{const names=["webgl2","webgl","experimental-webgl"],canvas=document.createElement("canvas");let gl;canvas.addEventListener("webglcontextlost",(()=>Events.emitter._fireEvent(Events.WEBGL_CONTEXT_LOSS)),!1);for(let i=0;i<names.length&&("webgl2"===names[i]&&Utils.query("compat")||(gl=canvas.getContext(names[i]),!gl));i++);if(gl.isContextLost())return window.__WEBGL_CONTEXT_LOSS=!0,DISABLED=!0,!1;let output={gpu:"unknown"};if(output.renderer=gl.getParameter(gl.RENDERER).toLowerCase(),output.version=gl.getParameter(gl.VERSION).toLowerCase(),output.glsl=gl.getParameter(gl.SHADING_LANGUAGE_VERSION).toLowerCase(),output.extensions=gl.getSupportedExtensions(),output.webgl2=output.version.includes(["webgl 2","webgl2"]),output.canvas=canvas,output.context=gl,"firefox"===_this.system.browser&&_this.system.browserVersion>=92)output.gpu=output.renderer;else{let info=gl.getExtension("WEBGL_debug_renderer_info");if(info){let gpu=info.UNMASKED_RENDERER_WEBGL;output.gpu=gl.getParameter(gpu).toLowerCase()}}return output.detect=function(matches){if(output.gpu&&output.gpu.toLowerCase().includes(matches))return!0;if(output.version&&output.version.toLowerCase().includes(matches))return!0;for(let i=0;i<output.extensions.length;i++)if(output.extensions[i].toLowerCase().includes(matches))return!0;return!1},output.webgl2||output.detect("instance")||window.AURA||(DISABLED=!0),_this.graphics._webglContext=output,output}catch(e){return!1}},set:v=>{!1===v&&(DISABLED=!0)}})}(),this.graphics.metal=function(){if(!window.Metal)return!1;let output={};return output.gpu=Metal.device.getName().toLowerCase(),output.detect=function(matches){return output.gpu.includes(matches)},output}(),this.graphics.gpu=function(){if(!_this.graphics.webgl&&!_this.graphics.metal)return!1;let output={};return["metal","webgl"].forEach((name=>{_this.graphics[name]&&!output.identifier&&(output.detect=_this.graphics[name].detect,output.identifier=_this.graphics[name].gpu)})),output}(),this.graphics.canvas=!!document.createElement("canvas").getContext;const checkForStyle=function(){let _tagDiv;return function(prop){_tagDiv=_tagDiv||document.createElement("div");const vendors=["Khtml","ms","O","Moz","Webkit"];if(prop in _tagDiv.style)return!0;prop=prop.replace(/^[a-z]/,(val=>val.toUpperCase()));for(let i=vendors.length-1;i>=0;i--)if(vendors[i]+prop in _tagDiv.style)return!0;return!1}}();this.styles={},this.styles.filter=checkForStyle("filter"),this.styles.blendMode=checkForStyle("mix-blend-mode"),this.tween={},this.tween.transition=checkForStyle("transition"),this.tween.css2d=checkForStyle("transform"),this.tween.css3d=checkForStyle("perspective"),this.social=_this.agent.includes("instagram")?"instagram":_this.agent.includes("fban")||_this.agent.includes("fbav")||_this.agent.includes("fbios")?"facebook":(_this.agent.includes("twitter")||!(!document.referrer||!document.referrer.includes("//t.co/")))&&"twitter"}),"Static"),Class((function Component(){if(this.initClass)return;Inherit(this,Events);const _this=this,_setters={},_flags={},_timers=[],_loops=[];var _onDestroy,_appStateBindings;function defineSetter(_this,prop){_setters[prop]={},Object.defineProperty(_this,prop,{set:function(v){_setters[prop]&&_setters[prop].s&&_setters[prop].s.call(_this,v),v=null},get:function(){if(_setters[prop]&&_setters[prop].g)return _setters[prop].g.apply(_this)}})}this.classes={},this.findParent=function(type){let p=_this.parent;for(;p;){if(p._cachedName||(p._cachedName=Utils.getConstructorName(p)),p._cachedName==type)return p;p=p.parent}},this.set=function(prop,callback){_setters[prop]||defineSetter(this,prop),_setters[prop].s=callback},this.get=function(prop,callback){_setters[prop]||defineSetter(this,prop),_setters[prop].g=callback},this.isPlayground=function(name){return!("boolean"!=typeof name||!Global.PLAYGROUND)||Global.PLAYGROUND&&Global.PLAYGROUND==(name||Utils.getConstructorName(_this))},this.initClass=function(clss){if(!clss)throw console.trace(),"unable to locate class";if(clss.instance)return clss.instance();const args=[].slice.call(arguments,1),child=Object.create(clss.prototype);if(child.parent=this,child.__afterInitClass=[],clss.apply(child,args),child.destroy){const id=Utils.timestamp();this.classes[id]=child,this.classes[id].__id=id}if(child.element){const last=arguments[arguments.length-1];Array.isArray(last)&&1==last.length&&last[0]instanceof child.element.constructor?last[0].add(child.element):this.element&&this.element.add&&null!==last&&this.element.add(child.element)}if(child.group){const last=arguments[arguments.length-1];this.group&&null!==last&&this.group.add(child.group)}if("undefined"!=typeof Hydra&&Hydra.LOCAL){let key=Utils.getConstructorName(child);key&&(Component.HMR.has(key)||Component.HMR.set(key,[]),Component.HMR.get(key).push({ref:child,args:args}))}return child.__afterInitClass.forEach((callback=>{callback()})),delete child.__afterInitClass,child},this.delayedCall=function(callback,time,scaledTime){const timer=Timer.create((()=>{_this&&_this.destroy&&callback&&callback()}),time,scaledTime);return _timers.push(timer),_timers.length>50&&_timers.shift(),timer},this.clearTimers=function(){for(let i=_timers.length-1;i>=0;i--)clearTimeout(_timers[i]);_timers.length=0},this.startRender=function(callback,fps,obj){"number"!=typeof fps&&(obj=fps,fps=void 0);for(let i=0;i<_loops.length;i++)if(_loops[i].callback==callback)return;let flagInvisible=_=>{_this._invisible||(_this._invisible=!0,_this.onInvisible&&_this.onInvisible())},loop=(a,b,c,d)=>{if(!_this.startRender)return!1;let p=_this;for(;p;){if(!1===p.visible)return flagInvisible();if(p.group&&!1===p.group.visible)return flagInvisible();p=p.parent}!1!==_this._invisible&&(_this._invisible=!1,_this.onVisible&&_this.onVisible());try{callback(a,b,c,d)}catch(error){let evt={callback:callback,error:error,component:_this,preventStopRender:!1};Events.emitter._fireEvent(Render.RENDER_CALLBACK_ERROR,evt),evt.preventStopRender||_this.stopRender(callback,obj)}return!0};_loops.push({callback:callback,loop:loop}),obj?obj==RenderManager.NATIVE_FRAMERATE?Render.start(loop,null,!0):RenderManager.schedule(loop,obj):Render.start(loop,fps)},this.onResize=function(callback,callInitial=!0){callInitial&&callback(),this.events.sub(Events.RESIZE,callback)},this.stopRender=function(callback,obj){for(let i=0;i<_loops.length;i++)if(_loops[i].callback==callback){let loop=_loops[i].loop;obj&&RenderManager.unschedule(loop,obj),Render.stop(loop),_loops.splice(i,1)}},this.clearRenders=function(){for(let i=0;i<_loops.length;i++)Render.stop(_loops[i].loop);_loops.length=0},this.wait=function(object,key,callback){const promise=Promise.create();let condition,appState;if("string"==typeof object&&(callback=key,key=object,object=_this),key?.includes?.("/")&&(appState=AppState),object.isAppState&&(appState=object),"number"==typeof object&&1===arguments.length)return _this.delayedCall(promise.resolve,object),promise;if("function"==typeof object&&1===arguments.length&&(condition=object,object=_this),"function"==typeof object&&"string"==typeof callback){let _object=object;object=key,key=callback,callback=_object}if(callback=callback||promise.resolve,condition||(appState?condition=()=>!!appState.get(key):"!"===key?.charAt?.(0)?(key=key.slice(1),condition=()=>!(object[key]||"function"==typeof object.flag&&object.flag(key))):condition=()=>!!object[key]||!("function"!=typeof object.flag||!object.flag(key))),condition())callback();else{Render.start((function test(){if(!object||!_this.flag||null===object.destroy)return Render.stop(test);condition()&&(callback(),Render.stop(test))}))}return promise},this.bindState=function(appState,key,...rest){if(appState.then)return(async()=>_this.bindState(await appState,key,...rest))();"object"!=typeof appState||appState.constructor!==Object||appState.isAppState||(appState=AppState.createLocal(appState)),_appStateBindings||(_appStateBindings=[]);let binding=(appState._bind||appState.bind).bind(appState)(key,...rest);return _appStateBindings.push(binding),binding._bindOnDestroy((()=>{_appStateBindings.remove(binding)})),binding},this.flag=function(name,value,time){if(void 0===value)return _flags[name];_flags[name]=value,time&&(clearTimeout(_flags[name+"_timer"]),_flags[name+"_timer"]=this.delayedCall((()=>{_flags[name]=!_flags[name]}),time))},this.destroy=function(){this.removeDispatch&&this.removeDispatch(),this.onDestroy&&this.onDestroy(),this.fxDestroy&&this.fxDestroy(),_onDestroy&&_onDestroy.forEach((cb=>cb()));for(let id in this.classes){var clss=this.classes[id];clss&&clss.destroy&&clss.destroy()}if(this.classes=null,Hydra.LOCAL){let key=Utils.getConstructorName(this),array=Component.HMR.get(key);array&&array.remove(this)}if(this.clearRenders&&this.clearRenders(),this.clearTimers&&this.clearTimers(),this.element&&window.GLUI&&this.element instanceof GLUIObject&&this.element.remove(),this.events&&(this.events=this.events.destroy()),this.parent&&this.parent.__destroyChild&&this.parent.__destroyChild(this.__id),_appStateBindings)for(;_appStateBindings.length>0;)_appStateBindings[_appStateBindings.length-1].destroy?.();return Utils.nullObject(this)},this._bindOnDestroy=function(cb){_onDestroy||(_onDestroy=[]),_onDestroy.push(cb)},this.__destroyChild=function(name){delete this.classes[name]},this.navigate=function(route){let p=_this.parent;for(;p;)p.navigate&&p.navigate(route),p=p.parent}}),(_=>{Component.HMR=new Map,Component.HMR_INSTANCE_RELOADED="Component.HMR_INSTANCE_RELOADED"})),Class((function Model(){Inherit(this,Component),Namespace(this);const _this=this,_storage={},_requests={};let _data=0,_triggered=0;this.push=function(name,val){_storage[name]=val},this.pull=function(name){return _storage[name]},this.waitForData=this.promiseData=function(num=1){_data+=num},this.fulfillData=this.resolveData=function(){_triggered++,_triggered==_data&&(_this.dataReady=!0)},this.ready=function(callback){let promise=Promise.create();return callback&&promise.then(callback),_this.wait(_this,"dataReady").then(promise.resolve),promise},this.initWithData=function(data){for(var key in _this.STATIC_DATA=data,_this){var model=_this[key],init=!1;for(var i in data)i.toLowerCase().replace(/-/g,"")==key.toLowerCase()&&(init=!0,model.init&&model.init(data[i]));!init&&model.init&&model.init()}_this.init&&_this.init(data)},this.loadData=function(url,callback){let promise=Promise.create();callback||(callback=promise.resolve);var _this=this;return get(url+"?"+Utils.timestamp()).then((d=>{defer((()=>{_this.initWithData(d),callback(d)}))})),promise},this.handleRequest=function(type,callback){_requests[type]=callback},this.makeRequest=async function(type,data,mockData={}){if(!_requests[type])return console.warn(`Missing data handler for ${type} with mockData`,mockData),"function"==typeof mockData&&(mockData=mockData()),Array.isArray(mockData)?new StateArray(mockData):AppState.createLocal(mockData);let result=await _requests[type](data,mockData);if(!(result instanceof StateArray||result.createLocal))throw`makeRequest ${type} must return either an AppState or StateArray`;return result},this.request=async function(type,data,mockData){if("function"==typeof data&&(mockData=data,data=null),mockData&&(mockData=mockData()),!_requests[type])return Array.isArray(mockData)?new StateArray(mockData):AppState.createLocal(mockData);let result=await _requests[type](data,mockData);if(Array.isArray(result)?result=new StateArray(result):"object"==typeof result&&(result=AppState.createLocal(result)),!(result instanceof StateArray||result.createLocal))throw`makeRequest ${type} must return either an AppState or StateArray`;return result}})),Class((function Data(){Inherit(this,Model)}),"static"),Class((function Modules(){const _modules={},_constructors={};function exec(){for(let m in _modules)for(let key in _modules[m]){let module=_modules[m][key];module._ready||(module._ready=!0,module.exec&&module.exec())}}defer(exec),this.Module=function(module){let m=new module,name=module.toString().slice(0,100).match(/function ([^\(]+)/);name?(m._ready=!0,name=name[1],_modules[name]={index:m},_constructors[name]=module):(_modules[m.module]||(_modules[m.module]={}),_modules[m.module][m.path]=m)},this.require=function(path){let root;return path.includes("/")?(root=path.split("/")[0],path=path.replace(root+"/","")):(root=path,path="index"),function requireModule(root,path){let module=_modules[root];if(!module)throw`Module ${root} not found`;return module=module[path],module._ready||(module._ready=!0,module.exec&&module.exec()),module}(root,path).exports},this.getConstructor=function(name){return _constructors[name]},this.modulesReady=async function(){let modules=[...arguments].flat();await Promise.all(modules.map((name=>Modules.moduleReady(name))))},this.moduleReady=function(name){let promise=Promise.create(),check=function(){_modules[name]&&(Render.stop(check),promise.resolve())};return Render.start(check),promise},window.Module=this.Module,window._NODE_||(window.requireNative=window.require,window.require=this.require)}),"Static"),Class((function StateWrapper(_array){const _this=this;Inherit(this,Component),this.bind=this.listen=function(key,callback){_array.forEach((async obj=>{await obj.wait("__ready"),_this.bindState(obj.state,key,(data=>{callback({target:obj,data:data})}))}))}})),Class((function StateInitializer(Class,_ref,_params,_stateRef){Inherit(this,Component);const _this=this;var _initTime=Render.TIME;function parseState(state){return state.includes("/")||(state=_this.parent.fragName+"/"+state),state}function onInit(bool){if(_initTime=Render.TIME,bool){for(let key in _params)_params[key].includes?.("#x#")&&(_params[key]=_params[key].replace(/#x#/g,"")),_params[key].includes?.("_this.")&&(_params[key]=_this.parent[_params[key].split("_this.")[1]]);_this.parent[_ref]=_this.parent.initClass(Class,_params)}else _this.parent[_ref]=_this.parent[_ref]?.destroy()}async function onInit3D(){await _this.wait(Math.max(1e3-(Render.TIME-_initTime),0)),await _this.wait((_=>!!_this.parent[_ref]));let ref=_this.parent[_ref];ref.nuke&&await Initializer3D.uploadNuke(ref.nuke);const group=ref.layout||ref.scene||ref.group||ref.element?.group;group&&await Initializer3D.uploadAllAsync(group)}this.ref=_ref,function(){if(!_stateRef.init)throw"StateInitializer required init parameter";_stateRef.init.includes?.("#x#")?eval(_stateRef.init.replace(/#x#/g,""))&&onInit(!0):"true"==_stateRef.init||1==_stateRef.init?onInit(!0):_this.bindState(AppState,parseState(_stateRef.init),onInit),_stateRef.init3d&&_this.bindState(AppState,parseState(_stateRef.init3d),onInit3D)}(),this.force=function(){AppState.set(parseState(_stateRef.init),!0)}})),Class((function Initialization(){this.initSync=async function(obj){await Initializer3D.uploadAll(obj)},this.initAsync=async function(obj){await Initializer3D.uploadAllAsync(obj)}})),Class((function FragUIHelper(_obj,_root){Inherit(this,Component);const _this=this,invalidDomAttrs=["refname","refname","_innertext","_type","_placeholder"],_createdObjs=new Map;function isLowerCase(str){return str==str.toLowerCase()}function isCustomComponentType(type){return!isLowerCase(type)&&"UI"!==type&&"GLObject"!==type&&"glObject"!==type&&"glObj"!==type&&"GLText"!==type&&"glText"!==type&&"HydraObject"!==type}function findStateObject(text){return text.match(/\$(.*)\./)[1]}function getPropByString(obj,propString){if(!propString)return obj;for(var props=propString.split("."),i=0,iLen=props.length-1;i<iLen;i++){var candidate=obj[props[i]];if(void 0===candidate)break;obj=candidate}return obj[props[i]]}function parseTextBindings(text){let binds=[];for(;text.match(/\$(.*)\./);){let match=text.match(/\$(.*)\./),split=text.split(match[0]);split[0]=split[0]+"@[",split[1]=split[1].split(" ");let name=split[1][0];split[1][0]+="]",split[1]=split[1].join(" "),text=split.join(""),binds.push(name)}return[binds,text]}function parseTextGlobalBindings(text){let binds=[];for(;text.match(/\$(\w*)\/(\w*)/);){let match=text.match(/\$(\w*)\/(\w*)/),split=text.split(match[0]);split[0]=split[0]+"@[",split[1]=split[1].split(" ");let name=match[0].slice(1).trim();split[1][0]=name,split[1][0]+="]",split[1]=split[1].join(" "),text=split.join(""),binds.push(name)}return[binds,text]}function parseCSSTransformStr(obj){let data={};return obj.split(",").forEach((param=>{let[a,b]=param.split(":");a=a.trim(),b=b.trim(),isNaN(b)||(b=Number(b)),data[a]=b})),data}function doConstructor(obj){switch(obj._type){case"UI":return _this.parent.element||_this.parent.getDOMElement?.();case"GLObject":case"glObject":case"glObj":return obj.width&&obj.height&&obj.bg?$gl(Number(obj.width),Number(obj.height),obj.bg):$gl();case"GLText":case"glText":if(obj._innerText.match?.(/\$(.*)\./)){let{font:font,fontSize:fontSize,fontColor:fontColor,_innerText:_innerText,...options}=obj,$text=$glText(obj._innerText,obj.font,Number(obj.fontSize),{color:fontColor,...options}),state=findStateObject(obj._innerText),ref=state;if(ref.includes(".")){let split=state.split(".");ref=split[0],split.shift(),state=split.join(".")}return _this.wait(_this.parent,ref).then((_=>{let[binds,text]=parseTextBindings(obj._innerText);$obj.html(text),_this.parent.bindState(ref==state?_this.parent[ref]:getPropByString(_this.parent[ref],state),binds,$obj)})),$text}if(obj._innerText.match?.(/\$(\w*)\/(\w*)/)){let[binds,text]=parseTextGlobalBindings(obj._innerText),{font:font,fontSize:fontSize,fontColor:fontColor,_innerText:_innerText,...options}=obj,$text=$glText(obj._innerText,obj.font,Number(obj.fontSize),{color:fontColor,...options});return _this.parent.bindState(AppState,binds,$text),$text}{let{font:font,fontSize:fontSize,fontColor:fontColor,_innerText:_innerText,...options}=obj;return $glText(obj._innerText,obj.font,Number(obj.fontSize),{color:fontColor,...options})}default:let $obj=$(obj.className||obj.refName||"h","HydraObject"!=obj._type?obj._type:"div");if(obj.width&&obj.height&&$obj.size(obj.width,obj.height),obj.font&&$obj.fontStyle(obj.font,Number(obj.fontSize),obj.fontColor),obj._innerText)if(obj._innerText.match?.(/\$(.*)\./)){let state=findStateObject(obj._innerText),ref=state;if(ref.includes(".")){let split=state.split(".");ref=split[0],split.shift(),state=split.join(".")}_this.wait(_this.parent,ref).then((_=>{let[binds,text]=parseTextBindings(obj._innerText);$obj.html?.(text),_this.parent?.bindState(ref==state?_this.parent[ref]:getPropByString(_this.parent[ref],state),binds,$obj)}))}else if(obj._innerText.match?.(/\$(\w*)\/(\w*)/)){let[binds,text]=parseTextGlobalBindings(obj._innerText);$obj.html(text),_this.parent.bindState(AppState,binds,$obj)}else $obj.html(obj._innerText);return $obj}}function applyValues(obj,$obj){const callObjKeyVal=key=>new Promise((resolve=>{const applyValue=val=>{(!($obj instanceof GLUIObject||$obj instanceof GLUIText)||"width"!==key&&"height"!==key)&&("function"==typeof $obj[key]?$obj[key](val):($obj instanceof HydraObject&&(invalidDomAttrs.includes(key.toLowerCase())||$obj.attr(key,val)),$obj[key]=val))},callFn=async()=>{let val=isNaN(obj[key])?obj[key]:Number(obj[key]);if("string"==typeof val){if(val.match(/\$(.*)\./)){let stateStr=findStateObject(val),state=_this.parent[stateStr];state||(await _this.wait(_this.parent,stateStr),state=_this.parent[stateStr]),state.then&&(state=await state);let[binds]=parseTextBindings(val);return _this.parent.bindState(state,binds,(dataVal=>applyValue(dataVal)))}if(val.match(/\$(\w*)\/(\w*)/)){let[binds]=parseTextGlobalBindings(val);return _this.parent.bindState(AppState,binds,(dataVal=>applyValue(dataVal)))}if(val.startsWith("$")&&"$element"!=val)return applyValue(_this.parent[val.slice(1)])}applyValue(val)};if(_this.parent.__afterInitClass)return _this.parent.__afterInitClass.push((()=>resolve(callFn())));resolve(callFn())}));for(let key in obj)if("_type"!==key&&"refName"!==key&&"children"!==key&&"display"!==key){if("shader"==key){let shader=_this.initClass(Shader,obj[key],{tMap:{value:null}});if(window[shader.vsName]){let mesh=$obj.mesh||{};mesh.shaderClass=_this.parent.initClass(window[shader.vsName],mesh,shader)}$obj.useShader(shader)}if(obj.width&&obj.height&&$obj.size&&$obj.size(isNaN(obj.width)?obj.width:Number(obj.width),isNaN(obj.height)?obj.height:Number(obj.height)),"css"==key||"transform"==key)$obj[key](parseCSSTransformStr(obj[key]));else if("onClick"==key||"onHover"==key)$obj.useShader?(_this.wait((_=>!!_this.parent[obj[key].slice(1)])).then((_=>{const interactHandle=_this.parent[obj[key].slice(1)];$obj["__interact"+key]=interactHandle})),_this.wait((_=>!!$obj.__interactonHover&&!!$obj.__interactonClick)).then((_=>{$obj.__interactonHover&&($obj.interact($obj.__interactonHover,$obj.__interactonClick,obj.seoLink,obj.seoText),delete $obj.__interactonClick,delete $obj.__interactonHover)}))):_this.wait((_=>!!_this.parent[obj[key].slice(1)])).then((_=>{const interactHandle=_this.parent[obj[key].slice(1)];let hoverFn="onHover"===key?interactHandle:null,clickFn="onClick"===key?interactHandle:null;$obj.interact(hoverFn,clickFn,obj.seoLink,obj.seoText)}));else if("function"==typeof $obj[key]){if("size"==key){let size=obj.size.split(",");size.map((x=>Number(x))),$obj.size(size[0],size[1]);continue}1===obj[key]&&(obj[key]=void 0),callObjKeyVal(key)}else callObjKeyVal(key)}}function convertToUsableRef(str){str.startsWith("$")&&(str=str.slice(1));let ref=str,state=str;if(str.includes(".")){let split=str.split(".");state=split[0],split.shift(),ref=split.join(".")}return[state,ref]}function create(obj,parent,isDeferredPhase=!1){if(isCustomComponentType(obj._type)){if(propsRequireDefer(obj)){if(!isDeferredPhase)return obj._placeholder=document.createElement("span"),void(parent.element||parent)?.add(obj._placeholder)}else if(isDeferredPhase)return createChildren(obj,_createdObjs.get(obj),isDeferredPhase);let params={},paramsState;for(let key in obj)if("_type"!==key&&"refName"!==key&&"children"!==key&&"display"!==key&&"_placeholder"!==key){if(params[key]=obj[key],params[key].startsWith?.("#x#")){let cleanStr=params[key].replace(/\#x\#/g,"");if(!cleanStr.startsWith("$")&&cleanStr.includes("(")){params[key]=eval(cleanStr);continue}params[key]=cleanStr}if(params[key].match?.(/\$(.*)\./)){let[state,ref]=convertToUsableRef(params[key]);if(state==ref)params[key]=_this.parent[state];else if(_this.parent[state]?.isAppState&&ref.indexOf(".")<0){let[binds,text]=parseTextBindings(params[key]),binding=newValue=>{paramsState?paramsState[key]=newValue:params[key]=newValue};binding._string=text,_this.parent.bindState(_this.parent[state],binds,binding)}else params[key]=getPropByString(_this.parent[state],ref)}else if(params[key].match?.(/\$(\w*)\/(\w*)/)){let[binds,text]=parseTextGlobalBindings(params[key]),binding=newValue=>{paramsState?paramsState[key]=newValue:params[key]=newValue};binding._string=text,_this.parent.bindState(AppState,binds,binding)}else if(params[key].startsWith?.("$")){let pk=params[key],value=_this.parent[pk.slice(1)];null==value?(params["wait_"+key]=_this.wait(_this.parent,pk.slice(1)).then((_=>_this.parent[pk.slice(1)])),params[key]=void 0):params[key]=value}}"ViewState"==obj._type&&(params.__parent=parent);let $obj=_this.parent.initClass(window[obj._type],paramsState=AppState.createLocal(params,!0),isDeferredPhase?null:[parent.element||parent]);if(isDeferredPhase){if($obj.element){obj._placeholder.replaceWith($obj.element.div);const $parent=parent.element||parent;$parent&&$parent._children.push($obj.element),$obj.element.onMountedHook&&($obj.element.onMountedHook(),delete $obj.element.onMountedHook)}delete obj._placeholder}return _this.parent[obj.refName]=$obj,_createdObjs.set(obj,$obj),createChildren(obj,$obj,isDeferredPhase),void(params.css&&$obj.element.css(parseCSSTransformStr(params.css)))}if(isDeferredPhase)return createChildren(obj,_createdObjs.get(obj),isDeferredPhase);let $obj=doConstructor(obj);if(obj.addTo){let addTo=obj.addTo.includes(".")||"Stage"==obj.addTo?eval(obj.addTo):_this.parent.element;addTo.add($obj)}else parent&&parent.add($obj);applyValues(obj,$obj),$obj?.transform?.(),obj.refName&&(_this.parent[obj.refName]=$obj),_createdObjs.set(obj,$obj),createChildren(obj,$obj,isDeferredPhase)}async function createChildren(obj,$obj,isDeferredPhase=!1){obj.children.forEach((o=>create(o,$obj,isDeferredPhase))),!isDeferredPhase&&obj===_obj&&anyChildrenRequireDefer(obj)&&(await defer(),obj.children.forEach((o=>create(o,$obj,!0)))),obj===_obj&&_createdObjs.clear()}function propsRequireDefer(obj){if(isCustomComponentType(obj._type))for(let key in obj){if("_type"===key||"refName"===key||"children"===key||"display"===key||"_placeholder"===key)continue;let param=obj[key];if(param.startsWith?.("$"))return!0}return!1}function anyChildrenRequireDefer(obj){return obj.children.some((o=>!!propsRequireDefer(o)||anyChildrenRequireDefer(o)))}_obj.addTo||"UI"==_obj._type||(_obj.addTo="$element"),_root&&applyValues(_root,_this.parent.element),create(_obj)})),Class((function XComponent(){const _this=this;var _state;function createState(){return _state||((_state=AppState.createLocal())._bind=_state.bind,_state.bind=function(key,callback){_this.bindState(_state,key,callback)},_state.fire=function(key,value){_state.set(key,value,!0)},AppState.set(_this.fragName+"/state",_state),_state)}_this.fragName="overwritten in descendent",_this.contexts="overwritten in descendent",_this.help=function(){console.groupCollapsed(`Fragment ${_this.fragName} Overview`),console.log(`Your context(s) are: ${_this.contexts}`),console.log("You have access to the following $ methods:");for(let key in _this)"_"!=key.charAt(0)&&(key.includes(["flag","initClass","classes","events","parent","findParent","bindState"])||console.log("$"+key));console.groupEnd()},_this.set=function(key,value){void 0===value&&(value=Utils.uuid()),key.includes("/")||(key=_this.fragName+"/"+key),AppState.set(key,value)},_this.fire=function(key,value){void 0===value&&(value=Utils.uuid()),key.includes("/")||(key=_this.fragName+"/"+key),AppState.set(key,value,!0)},_this.bind=_this.listen=function(key,callback,ref){if("function"==typeof ref&&"string"==typeof callback){let rref=key;key=callback,callback=ref,ref=rref}ref?(ref.state&&ref.state.isAppState&&(ref=ref.state),ref.isAppState?_this.bindState(ref,key,callback):_this.events.sub(ref,key,callback)):key.startsWith("hydra_")?_this.events.sub(key,callback):(key.includes("/")||(key=_this.fragName+"/"+key),_this.bindState(AppState,key,callback))},_this.get=function(key,noPromise){key.includes("/")||(key=_this.fragName+"/"+key);let value=AppState.get(key);if(void 0!==value||noPromise)return value;{let timer,promise=Promise.create();const cb=_=>{value=AppState.get(key),void 0!==value&&(clearTimeout(timer),promise.resolve(value),Render.stop(cb))};return Render.start(cb,24),Hydra.LOCAL&&(timer=_this.delayedCall((_=>{console.warn(`$get ${key} has timed out after 5 seconds`)}),5e3)),promise}},_this.state||Object.defineProperty(_this,"state",{set:function(v){throw"Don't override state!"},get:function(){return createState()}}),this.createUIL=function(){let input=InputUIL.create.apply(this,arguments),appState=AppState.createLocal();return input.state=appState,input.onUpdate=key=>{let val=input.get(key);isNaN(val)||(val=Number(val)),appState.set(key,val)},defer((_=>{input.keys.forEach(input.onUpdate)})),input},this.requestData=Data.makeRequest,this.fulfillDataRequest=Data.request,this._bindOnDestroy((_=>{_state?.destroy?.(),AppState.clearKeysMatching(_this.fragName+"/")})),this.gl=window.$gl,this.glText=window.$glText,this.createState=createState,this.createFragment=this.initClass,_this.waitLayers=async _=>{_this.parent.layout?.getAllLayers&&(_this.layers=await _this.parent.layout.getAllLayers()),_this.parent?.getAllLayers&&(_this.layers=await _this.parent.getAllLayers())}})),Class((function LinkedList(){var prototype=LinkedList.prototype;this.length=0,this.first=null,this.last=null,this.current=null,this.prev=null,void 0===prototype.push&&(prototype.push=function(obj){this.first?(obj.__next=this.first,obj.__prev=this.last,this.last.__next=obj,this.last=obj):(this.first=obj,this.last=obj,obj.__prev=obj,obj.__next=obj),this.length++},prototype.remove=function(obj){obj&&obj.__next&&(this.length<=1?this.empty():(obj==this.first?(this.first=obj.__next,this.last.__next=this.first,this.first.__prev=this.last):obj==this.last?(this.last=obj.__prev,this.last.__next=this.first,this.first.__prev=this.last):(obj.__prev.__next=obj.__next,obj.__next.__prev=obj.__prev),this.length--),obj.__prev=null,obj.__next=null)},prototype.empty=function(){this.first=null,this.last=null,this.current=null,this.prev=null,this.length=0},prototype.start=function(){return this.current=this.first,this.prev=this.current,this.current},prototype.next=function(){if(this.current&&(this.current=this.current.__next,1!=this.length&&this.prev.__next!=this.first))return this.prev=this.current,this.current},prototype.destroy=function(){return Utils.nullObject(this),null})})),Class((function ObjectPool(_type,_number=10){var _pool=[];this.array=_pool,function(){if(_type)for(var i=0;i<_number;i++)_pool.push(new _type)}(),this.get=function(){return _pool.shift()||(_type?new _type:null)},this.empty=function(){_pool.length=0},this.put=function(obj){obj&&!_pool.includes(obj)&&_pool.push(obj)},this.insert=function(array){void 0===array.push&&(array=[array]);for(var i=0;i<array.length;i++)this.put(array[i])},this.length=function(){return _pool.length},this.randomize=function(){let array=_pool;for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}},this.destroy=function(){for(let i=_pool.length-1;i>=0;i--)_pool[i].destroy&&_pool[i].destroy();return _pool=null}})),Class((function Gate(){var _list=[],_map={};this.create=function(name){let promise=Promise.create();name?_map[name]=promise:_list.push(promise)},this.open=function(name){name&&(_map[name]||(_map[name]=Promise.create()),_map[name].resolve());let promise=_list.shift();promise&&promise.resolve()},this.wait=function(name){return _list.length||name?name?(_map[name]||(_map[name]=Promise.create()),_map[name]):_list[_list.length-1]||Promise.resolve():Promise.resolve()}}),"static"),Class((function Assets(){const _this=this;function AssetList(arr){return arr.__proto__=AssetList.prototype,arr}this.__loaded=[],this.FLIPY=!0,this.CDN=window.HYDRA_ASSETS_CDN??"",this.CORS="anonymous",this.IMAGES={},this.VIDEOS={},this.AUDIOS={},this.SDF={},this.JSON={push:function(prop,value){this[prop]=value,Object.defineProperty(this,prop,{get:()=>JSON.parse(JSON.stringify(value))})}},Object.defineProperty(this.JSON,"push",{enumerable:!1,writable:!0}),this.SVG={},AssetList.prototype=new Array,AssetList.prototype.filter=function(items){for(let i=this.length-1;i>=0;i--)this[i].includes(items)||this.splice(i,1);return this},AssetList.prototype.exclude=function(items){for(let i=this.length-1;i>=0;i--)this[i].includes(items)&&this.splice(i,1);return this},AssetList.prototype.prepend=function(prefix){for(let i=this.length-1;i>=0;i--)this[i]=prefix+this[i];return this},AssetList.prototype.append=function(suffix){for(let i=this.length-1;i>=0;i--)this[i]=this[i]+suffix;return this},this.list=function(){return window.ASSETS||console.warn("ASSETS list not available"),new AssetList(window.ASSETS.slice(0)||[])},this.BASE_PATH=window.HYDRA_ASSETS_BASE_PATH||"",this.getPath=function(path){if(path.includes("~"))return _this.BASE_PATH+path.replace("~","");if(path.includes("//"))return path;if(path=function parseResolution(path){if(!window.ASSETS||!ASSETS.RES)return path;var res=ASSETS.RES[path],ratio=Math.min(Device.pixelRatio,3);if(!res)return path;if(!res["x"+ratio])return path;var split=path.split("/"),file=split[split.length-1];return split=file.split("."),path.replace(file,split[0]+"-"+ratio+"x."+split[1])}(path),_this.replacementPaths)for(let pathKey in _this.replacementPaths)if(path.startsWith(pathKey))return path=path.replace(pathKey,_this.replacementPaths[pathKey]);if(_this.dictionary)for(let pathKey in _this.dictionary)if(_this.dictionary[pathKey].includes(path.split("?")[0]))return pathKey+path;return this.CDN&&!~path.indexOf(this.CDN)&&(path=this.CDN+path),path},this.registerPathReplacement=function(path,replacedPath){_this.replacementPaths||(_this.replacementPaths={}),_this.replacementPaths[path]=replacedPath},this.registerPath=function(path,assets){_this.dictionary||(_this.dictionary={}),_this.dictionary[path]=assets},this.loadImage=function(path,isStore){var img=new Image;return img.crossOrigin=this.CORS,img.src=_this.getPath(path),img.loadPromise=function(){let promise=Promise.create();return img.onload=promise.resolve,promise},isStore&&(this.IMAGES[path]=img),img},this.decodeImage=function(path,params,promise){promise||(promise=Promise.create());let img=_this.loadImage(path);return img.onload=()=>promise.resolve(img),img.onerror=()=>_this.decodeImage("assets/images/_scenelayout/uv.jpg",params,promise),promise};const _supportsWebP=function(){try{return 0==document.createElement("canvas").toDataURL("image/webp").indexOf("data:image/webp")}catch(e){return!1}}();this.supportsWebP=function(){return!!_supportsWebP},this.perfImage=function(path){let result=path;return _this.supportsWebP()&&path.includes([".jpg",".png"])&&(result=`${path.substring(0,path.lastIndexOf("."))}.webp`),result}}),"static"),Class((function AssetLoader(_assets,_callback,ASSETS=Assets){Inherit(this,Events);const _this=this;let _total=_assets.length,_loaded=0,_lastFiredPercent=0;function loadAsset(){let path=_assets.splice(_assets.length-1,1)[0];const name=path.split("assets/").last().split(".")[0],ext=path.split(".").last().split("?")[0].toLowerCase();let timeout=Timer.create(timedOut,AssetLoader.TIMEOUT,path);if(!Assets.preventCache&&~Assets.__loaded.indexOf(path))return loaded();if(ext.includes(["jpg","jpeg","png","gif"])){let image=ASSETS.loadImage(path);return image.complete?loaded():(image.onload=loaded,void(image.onerror=loaded))}function loaded(){timeout&&clearTimeout(timeout),increment(),_assets.length&&loadAsset()}ext.includes(["mp4","webm"])?fetch(path).then((async response=>{let blob=await response.blob();Assets.VIDEOS[name]=URL.createObjectURL(blob),loaded()})).catch((e=>{console.warn(e),loaded()})):ext.includes(["mp3"])?fetch(path).then((async response=>{let blob=await response.blob();Assets.AUDIOS[name]=URL.createObjectURL(blob),loaded()})).catch((e=>{console.warn(e),loaded()})):get(Assets.getPath(path),Assets.HEADERS).then((data=>{Assets.__loaded.push(path),"json"==ext&&ASSETS.JSON.push(name,data),"svg"==ext&&(ASSETS.SVG[name]=data),"fnt"==ext&&(ASSETS.SDF[name.split("/")[1]]=data),"js"==ext&&window.eval(data),ext.includes(["fs","vs","glsl"])&&window.Shaders&&Shaders.parse(data,path),loaded()})).catch((e=>{console.warn(e),loaded()}))}function increment(){let percent=Math.max(_lastFiredPercent,Math.min(1,++_loaded/_total));_this.events.fire(Events.PROGRESS,{percent:percent}),_lastFiredPercent=percent,_loaded>=_total&&defer(complete)}function complete(){_this.completed||(_this.completed=!0,defer((()=>{_callback&&_callback(),_this.events.fire(Events.COMPLETE)})))}function timedOut(path){console.warn("Asset timed out",path)}!function(){if(!Array.isArray(_assets))throw"AssetLoader requires array of assets to load";_assets=_assets.slice(0).reverse(),function init(){if(!_assets.length)return complete();for(let i=0;i<AssetLoader.SPLIT;i++)_assets.length&&loadAsset()}()}(),this.loadModules=function(){if(!window._BUILT_)return;this.add(1);let module=window._ES5_?"es5-modules":"modules",src=window._CACHE_?"assets/js/"+module+"."+window._CACHE_+".js":"assets/js/"+module+".js";src=Assets.getPath(src);let s=document.createElement("link");return s.href=src,s.rel="preload",s.as="script",document.head.appendChild(s),s=document.createElement("script"),s.src=src,s.async=!0,document.head.appendChild(s),AssetLoader.waitForLib("_MODULES_").then((_=>_this.trigger(1)))},this.add=function(num){_total+=num||1},this.trigger=function(num){for(let i=0;i<(num||1);i++)increment()}}),(()=>{AssetLoader.SPLIT=2,AssetLoader.TIMEOUT=5e3,AssetLoader.loadAllAssets=function(callback){let promise=Promise.create();return callback||(callback=promise.resolve),promise.loader=new AssetLoader(Assets.list(),(()=>{callback&&callback(),promise.loader&&promise.loader.destroy&&(promise.loader=promise.loader.destroy())})),promise},AssetLoader.loadAssets=function(list,callback){let promise=Promise.create();return callback||(callback=promise.resolve),promise.loader=new AssetLoader(list,(()=>{callback&&callback(),promise.loader&&promise.loader.destroy&&(promise.loader=promise.loader.destroy())})),promise},AssetLoader.waitForLib=function(name,callback){let promise=Promise.create();return callback||(callback=promise.resolve),Render.start((function check(){window[name]&&(Render.stop(check),callback&&callback())})),promise},AssetLoader.waitForModules=function(){return AssetLoader.waitForLib(window._BUILT_?"_MODULES_":"zUtils3D")}})),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).goober={})}(this,(function(e){let t={data:""},n=e=>"undefined"!=typeof window?((e?e.querySelector("#_goober"):window._goober)||Object.assign((e||document.head).appendChild(document.createElement("style")),{innerHTML:" ",id:"_goober"})).firstChild:e||t,o=/(?:([A-Z0-9-%@]+) *:? *([^{;]+?);|([^;}{]*?) *{)|(})/gi,r=/\/\*[^]*?\*\/|\s\s+|\n/g,l=(e,t)=>{let n,o="",r="",a="";for(let s in e){let c=e[s];"object"==typeof c?(n=t?t.replace(/([^,])+/g,(e=>s.replace(/([^,])+/g,(t=>/&/.test(t)?t.replace(/&/g,e):e?e+" "+t:t)))):s,r+="@"==s[0]?"f"==s[1]?l(c,s):s+"{"+l(c,"k"==s[1]?"":t)+"}":l(c,n)):"@"==s[0]&&"i"==s[1]?o=s+" "+c+";":(s=s.replace(/[A-Z]/g,"-$&").toLowerCase(),a+=l.p?l.p(s,c):s+":"+c+";")}return a[0]?(n=t?t+"{"+a+"}":a,o+n+r):o+r},a={},s=e=>{let t="";for(let n in e)t+=n+("object"==typeof e[n]?s(e[n]):e[n]);return t},c=(e,t,n,c,i)=>{let f="object"==typeof e?s(e):e,p=a[f]||(a[f]=(e=>{let t=0,n=11;for(;t<e.length;)n=101*n+e.charCodeAt(t++)>>>0;return"go"+n})(f));if(!a[p]){let t="object"==typeof e?e:(e=>{let t,n=[{}];for(;t=o.exec(e.replace(r,""));)t[4]&&n.shift(),t[3]?n.unshift(n[0][t[3]]=n[0][t[3]]||{}):t[4]||(n[0][t[1]]=t[2]);return n[0]})(e);a[p]=l(i?{["@keyframes "+p]:t}:t,n?"":"."+p)}return((e,t,n)=>{-1==t.data.indexOf(e)&&(t.data=n?e+t.data:t.data+e)})(a[p],t,c),p};function f(e){let t=this||{},o=e.call?e(t.p):e;return c(o.unshift?o.raw?((e,t,n)=>e.reduce(((e,o,r)=>{let a=t[r];if(a&&a.call){let e=a(n),t=e&&e.props&&e.props.className||/^go/.test(e)&&e;a=t?"."+t:e&&"object"==typeof e?e.props?"":l(e,""):e}return e+o+(null==a?"":a)}),""))(o,[].slice.call(arguments,1),t.p):o.reduce(((e,n)=>n?Object.assign(e,n.call?n(t.p):n):e),{}):o,n(t.target),t.g,t.o,t.k)}let p,d,u,g=f.bind({g:1}),b=f.bind({k:1});e.css=f,e.extractCss=e=>{let t=n(e),o=t.data;return t.data="",o},e.glob=g,e.keyframes=b,e.setup=function(e,t,n,o){l.p=t,p=e,d=n,u=o},e.styled=function(e,t){let n=this||{};return function(){let o=arguments;function r(l,a){let s=Object.assign({},l),c=s.className||r.className;n.p=Object.assign({theme:d&&d()},s),n.o=/ *go\d+/.test(c),s.className=f.apply(n,o)+(c?" "+c:""),t&&(s.ref=a);let i=s.as||e;return u&&i[0]&&u(s),p(i,s)}return t?t(r):r}}})),function(i,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((i=i||self).gooberPrefixer={})}(this,(function(i){var n=new Map([["align-self","-ms-grid-row-align"],["color-adjust","-webkit-print-color-adjust"],["column-gap","grid-column-gap"],["gap","grid-gap"],["grid-template-columns","-ms-grid-columns"],["grid-template-rows","-ms-grid-rows"],["justify-self","-ms-grid-column-align"],["margin-inline-end","-webkit-margin-end"],["margin-inline-start","-webkit-margin-start"],["overflow-wrap","word-wrap"],["padding-inline-end","-webkit-padding-end"],["padding-inline-start","-webkit-padding-start"],["row-gap","grid-row-gap"],["scroll-margin-bottom","scroll-snap-margin-bottom"],["scroll-margin-left","scroll-snap-margin-left"],["scroll-margin-right","scroll-snap-margin-right"],["scroll-margin-top","scroll-snap-margin-top"],["scroll-margin","scroll-snap-margin"],["text-combine-upright","-ms-text-combine-horizontal"]]);i.prefix=function(i,r){let t="";const e=n.get(i);e&&(t+=`${e}:${r};`);const o=function(i){var n=/^(?:(text-(?:decoration$|e|or|si)|back(?:ground-cl|d|f)|box-d|(?:mask(?:$|-[ispro]|-cl)))|(tab-|column(?!-s)|text-align-l)|(ap)|(u|hy))/i.exec(i);return n?n[1]?1:n[2]?2:n[3]?3:5:0}(i);1&o&&(t+=`-webkit-${i}:${r};`),2&o&&(t+=`-moz-${i}:${r};`),4&o&&(t+=`-ms-${i}:${r};`);const a=function(i,n){var r=/^(?:(pos)|(background-i)|((?:max-|min-)?(?:block-s|inl|he|widt))|(dis))/i.exec(i);return r?r[1]?/^sti/i.test(n)?1:0:r[2]?/^image-/i.test(n)?1:0:r[3]?"-"===n[3]?2:0:/^(inline-)?grid$/i.test(n)?4:0:0}(i,r);return 1&a?t+=`${i}:-webkit-${r};`:2&a?t+=`${i}:-moz-${r};`:4&a&&(t+=`${i}:-ms-${r};`),t+=`${i}:${r};`,t}})),function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("goober")):"function"==typeof define&&define.amd?define(["exports","goober"],o):o((e=e||self).gooberGlobal={},e.goober)}(this,(function(e,o){let n=o.css.bind({g:1});e.createGlobalStyles=function(){const e=o.styled.call({g:1},"div").apply(null,arguments);return function(o){return e(o),null}},e.glob=n})),Hydra.ready((function(){if(window.__window=$(window),window.__document=$(document),window.__body=$(document.getElementsByTagName("body")[0]),window.Stage=window.Stage&&window.Stage.style?$(window.Stage):__body.create("#Stage"),window.HYDRA_MOBILE_SCROLL&&Device.mobile){Stage.isNormalMobileScroll=!0,Stage.size("100%","100vh");const resizeObserver=new ResizeObserver((entries=>{let size=entries[0].contentRect||entries[0].contentBoxSize;Stage.width=size.width,Stage.height=size.height,resizeObserver.unobserve(Stage.div)}));resizeObserver.observe(Stage.div)}else Stage.size("100%");Stage.__useFragment=!0,Stage.width=window.innerWidth||document.body.clientWidth||document.documentElement.offsetWidth,Stage.height=Stage.isNormalMobileScroll&&Stage.div.offsetHeight||window.innerHeight||document.body.clientHeight||document.documentElement.offsetHeight})),Class((function HydraCSS(){var _tag,_obj,_style,_needsUpdate,_this=this;function objToCSS(key){var match=key.match(/[A-Z]/),camelIndex=match?match.index:null;if(camelIndex){var start=key.slice(0,camelIndex),end=key.slice(camelIndex);key=start+"-"+end.toLowerCase()}return key}function setHTML(){_tag.innerHTML=_style,_needsUpdate=!1}Hydra.ready((function(){_obj={},_style="",(_tag=document.createElement("style")).type="text/css",document.getElementsByTagName("head")[0].appendChild(_tag)})),this._read=function(){return _style},this._write=function(css){_style=css,_needsUpdate||(_needsUpdate=!0,defer(setHTML))},this.style=function(selector,obj={}){_obj[selector]||(_obj[selector]={}),Object.assign(_obj[selector],obj),function render(){var s="";for(let selector in _obj){let obj=_obj[selector];for(var key in s+=`${selector} {`,obj){var prop=objToCSS(key),val=obj[key];"string"!=typeof val&&"opacity"!=key&&(val+="px"),s+=prop+":"+val+"!important;"}s+="}"}_this._write(s)}()},this.get=function(selector,prop){if(!_obj[selector])return prop?null:{};let obj=Object.assign({},_obj[selector]);return prop?obj[prop]:obj},this.textSize=function($obj){var $clone=$obj.clone();$clone.css({position:"relative",cssFloat:"left",styleFloat:"left",marginTop:-99999,width:"",height:""}),__body.addChild($clone);var width=$clone.div.offsetWidth,height=$clone.div.offsetHeight;return $clone.remove(),{width:width,height:height}},this.prefix=function(style){return""==_this.styles.vendor?style.charAt(0).toLowerCase()+style.slice(1):_this.styles.vendor+style},this._toCSS=objToCSS}),"Static"),Class((function HydraObject(_selector,_type,_exists,_useFragment){this._children=new LinkedList,this._onDestroy,this.__useFragment=_useFragment,this._initSelector(_selector,_type,_exists)}),(()=>{var prototype=HydraObject.prototype;const svgElements=["svg","path","rect","circle","filter","clippath","clipPath","ellipse","image","mask","polygon","g","animate","line","linearGradient","marker","mpath","polyline","set","stop","text"];prototype._initSelector=function(_selector,_type,_exists){if(_selector&&"string"!=typeof _selector)this.div=_selector;else{var first=_selector?_selector.charAt(0):null,name=_selector?_selector.slice(1):null;if("."!=first&&"#"!=first&&(name=_selector,first="."),_exists){if("#"!=first)throw"Hydra Selectors Require #ID";this.div=document.getElementById(name)}else this._type=_type||"div",svgElements.includes(this._type)?(this.div=document.createElementNS("http://www.w3.org/2000/svg",this._type),"svg"===this._type&&this.div.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink")):(this.div=document.createElement(this._type),first&&("#"==first?this.div.id=name:this.div.className=name))}this.div.hydraObject=this},prototype.add=function(child,before=null){this.div;var _this=this,doInsertChild=function(childDiv){before&&(before.element&&before.element instanceof HydraObject?before=before.element.div:before.div?before=before.div:before.nodeName||(before=null)),before&&before.parentNode!==_this.div&&(before=null),_this.div.insertBefore(childDiv,before)},insertChild=function(childDiv){_this.__useFragment?(_this._fragment||(_this._fragment=document.createDocumentFragment(),defer((function(){if(!_this._fragment||!_this.div)return void delete _this._fragment;const hydraObjectsWithMountedHooks=Array.prototype.map.call(_this._fragment.childNodes,(childDiv=>childDiv.hydraObject)).filter(($child=>$child?.onMountedHook));if(Array.prototype.every.call(_this._fragment.childNodes,(childDiv=>!childDiv._fragmentBefore)))_this.div.appendChild(_this._fragment);else for(;_this._fragment.childNodes.length;)childDiv=_this._fragment.childNodes[0],before=childDiv._fragmentBefore,delete childDiv._fragmentBefore,doInsertChild(childDiv);delete _this._fragment,hydraObjectsWithMountedHooks.forEach(($child=>{$child.onMountedHook(),delete $child.onMountedHook}))}))),_this._fragment.appendChild(childDiv),childDiv._fragmentBefore=before):(doInsertChild(childDiv),childDiv.hydraObject?.onMountedHook&&(childDiv.hydraObject.onMountedHook(),delete childDiv.hydraObject.onMountedHook))};return child.element&&child.element instanceof HydraObject?(insertChild(child.element.div),this._children.push(child.element),child.element._parent=this,child.element.div.parentNode=this.div):child.div?(insertChild(child.div),this._children.push(child),child._parent=this,child.div.parentNode=this.div):child.nodeName&&(insertChild(child),child.parentNode=this.div),this},prototype.clone=function(){return $(this.div.cloneNode(!0))},prototype.create=function(name,type){var $obj=$(name,type);return this.add($obj),$obj},prototype.empty=function(){for(var child=this._children.start();child;){var next=this._children.next();child&&child.remove&&child.remove(),child=next}return this.div.innerHTML="",this},prototype.parent=function(){return this._parent},prototype.children=function(isHydraChildren=!1){let children=this.div.children?this.div.children:this.div.childNodes;if(isHydraChildren){children=[];for(var child=this._children.start();child;)child&&(children.push(child),child=this._children.next())}return children},prototype.removeChild=function(object,keep){try{object.div.parentNode.removeChild(object.div)}catch(e){}keep||this._children.remove(object)},prototype.remove=function(param){param&&console.warn("HydraObject.remove removes ITSELF from its parent. use removeChild instead"),this._onDestroy&&this._onDestroy.forEach((cb=>cb())),this.removed=!0;var parent=this._parent;parent&&!parent.removed&&parent.removeChild&&parent.removeChild(this,!0);for(var child=this._children.start();child;){var next=this._children.next();child&&child.remove&&child.remove(),child=next}this._children.destroy(),this.div.hydraObject=null,Utils.nullObject(this)},prototype.destroy=function(){this.remove()},prototype._bindOnDestroy=function(cb){this._onDestroy||(this._onDestroy=[]),this._onDestroy.push(cb)},window.$=function(selector,type,exists){return new HydraObject(selector,type,exists)},$.fn=HydraObject.prototype})),function(){$.fn.text=function(text){return void 0!==text?(this.__cacheText!=text&&(this.div.textContent=text),this.__cacheText=text,this):this.div.textContent},$.fn.html=function(text,force){return!text||text.includes("<")||force?void 0!==text?(this.div.innerHTML=text,this):this.div.innerHTML:this.text(text)},$.fn.hide=function(){return this.div.style.display="none",this},$.fn.show=function(){return this.div.style.display="",this},$.fn.visible=function(){return this.div.style.visibility="visible",this},$.fn.invisible=function(){return this.div.style.visibility="hidden",this},$.fn.setZ=function(z){return this.div.style.zIndex=z,this},$.fn.clearAlpha=function(){return this.div.style.opacity="",this},$.fn.size=function(w,h,noScale){return"string"==typeof w?(void 0===h?h="100%":"string"!=typeof h&&(h+="px"),this.div.style.width=w,this.div.style.height=h):(this.div.style.width=w+"px",this.div.style.height=h+"px",noScale||(this.div.style.backgroundSize=w+"px "+h+"px")),this.width=w,this.height=h,this},$.fn.mouseEnabled=function(bool){return this.div.style.pointerEvents=bool?"auto":"none",this},$.fn.fontStyle=function(family,size,color,style){var font={};return family&&(font.fontFamily=family),size&&(font.fontSize=size),color&&(font.color=color),style&&(font.fontStyle=style),this.css(font),this},$.fn.font=function(font){return this.css("font",font),this},$.fn.bg=function(src,x,y,repeat){return src?(src.includes(".")&&(src=Assets.getPath(src)),src.includes(".")?this.div.style.backgroundImage="url("+src+")":this.div.style.backgroundColor=src,void 0!==x&&(x="number"==typeof x?x+"px":x,y="number"==typeof y?y+"px":y,this.div.style.backgroundPosition=x+" "+y),repeat&&(this.div.style.backgroundSize="",this.div.style.backgroundRepeat=repeat),"cover"!=x&&"contain"!=x||(this.div.style.backgroundSize=x,this.div.style.backgroundPosition=void 0!==y?y+" "+repeat:"center"),this):this},$.fn.svgMask=function(src){return src?(src.includes(".")&&(src=Assets.getPath(src)),this.div.style.maskImage=`url(${src})`,this.div.style.webkitMaskImage=`url(${src})`,this):this},$.fn.center=function(x,y,noPos){var css={};return void 0===x?(css.left="50%",css.top="50%",css.marginLeft=-this.width/2,css.marginTop=-this.height/2):(x&&(css.left="50%",css.marginLeft=-this.width/2),y&&(css.top="50%",css.marginTop=-this.height/2)),noPos&&(delete css.left,delete css.top),this.css(css),this},$.fn.max=function(width,height){let w,h;return void 0!==width&&(w="number"==typeof width?width+"px":width,this.div.style.maxWidth=w),void 0!==height?(h="number"==typeof height?height+"px":height,this.div.style.maxHeight=h):(h=w,this.div.style.maxHeight=h),this},$.fn.min=function(width,height){let w,h;return void 0!==width&&(w="number"==typeof width?width+"px":width,this.div.style.minWidth=w),void 0!==height?(h="number"==typeof height?height+"px":height,this.div.style.minHeight=h):(h=w,this.div.style.minHeight=h),this},$.fn.flex=function(inline){return this.div.style.display=inline?"inline-flex":"flex",this.div.style.justifyContent="center",this.div.style.alignItems="center",this.div.classList.add("relative-children"),this},$.fn.order=function(opts={}){let s=this.div.style;return"none"===opts.flexWrap&&(opts.flexWrap="nowrap"),opts.direction&&(s.flexDirection=opts.direction),opts.wrap&&(s.flexWrap=opts.wrap),opts.order&&(s.order=opts.order),this},$.fn.align=function(opts={}){let s=this.div.style;function flex(str,contentMode=!1){return"start"===str?"flex-start":"end"===str?"flex-end":"between"===str?contentMode?"space-between":"flex-between":"around"===str?contentMode?"space-around":"flex-around":"none"===str?"nowrap":str}return opts.justify&&(s.justifyContent=flex(opts.justify)),opts.items&&(s.alignItems=flex(opts.items)),opts.self&&(s.alignSelf=flex(opts.self)),opts.content&&(s.alignContent=flex(opts.content,!0)),this},$.fn.flexibility=function(opts={}){let s=this.div.style;return"undefined"!==opts.grow&&(s.flexGrow=opts.grow),"undefined"!==opts.shrink&&(s.flexGrow=opts.shrink),void 0!==opts.basis&&(s.flexBasis="number"==typeof opts.basis?opts.basis+"px":opts.basis),this},$.fn.mask=function(arg){let maskPrefix="Moz"===HydraCSS.styles.vendor?"mask":HydraCSS.prefix("Mask");return this.div.style[maskPrefix]=(arg.includes(".")?"url("+arg+")":arg)+" no-repeat",this.div.style[maskPrefix+"Size"]="contain",this},$.fn.blendMode=function(mode,bg){return bg?this.div.style["background-blend-mode"]=mode:this.div.style["mix-blend-mode"]=mode,this};const DEFAULT_UNITS={animationDelay:"ms",animationDuration:"ms",transitionDelay:"ms",transitionDuration:"ms",perspectiveOriginX:"%",perspectiveOriginY:"%",transformOrigin:"%",transformOriginX:"%",transformOriginY:"%",transformOriginZ:"%",rotate:"deg",animationIterationCount:!1,borderImageSlice:!1,borderImageWidth:!1,columnCount:!1,counterIncrement:!1,counterReset:!1,flex:!1,flexGrow:!1,flexShrink:!1,fontSizeAdjust:!1,fontWeight:!1,lineHeight:!1,navIndex:!1,opacity:!1,order:!1,orphans:!1,tabSize:!1,widows:!1,zIndex:!1,scale:!1};$.fn.css=function(obj,value){if("boolean"==typeof value&&(value=null),"object"!=typeof obj){if(value)return this.div.style[obj]=value,this;var style=this.div.style[obj];if("number"!=typeof style){if(!style)return!1;style.includes("px")&&(style=Number(style.slice(0,-2))),"opacity"==obj&&(style=isNaN(Number(this.div.style.opacity))?1:Number(this.div.style.opacity))}return style||(style=0),style}TweenManager._clearCSSTween(this);for(let type in obj){let val=obj[type];if("string"==typeof val||"number"==typeof val){if("number"==typeof val){let unit=DEFAULT_UNITS[type];!1!==unit&&(val+=unit||"px")}"position"==type&&"sticky"==val&&"safari"==Device.system.browser&&(val="-webkit-sticky"),this.div.style[type]=val}}return this},$.fn.transform=function(props){if(Hydra.LOCAL&&props&&!this.__warningShown&&!props._mathTween&&(this.__lastTransform&&performance.now()-this.__lastTransform<20&&(this.__warningCount=++this.__warningCount||1,props.__warningCount2=++props.__warningCount2||1,this.__warningCount>10&&props.__warningCount2!==this.__warningCount&&(console.warn("Are you using .transform() in a loop? Avoid creating a new object {} every frame. Ex. assign .x = 1; and .transform();"),console.log(this),this.__warningShown=!0)),this.__lastTransform=performance.now()),TweenManager._clearCSSTween(this),Device.tween.css2d){if(props)for(var key in props)"number"!=typeof props[key]&&"string"!=typeof props[key]||(this[key]=props[key]);else props=this;var transformString=TweenManager._parseTransform(props);this.__transformCache!=transformString&&(this.div.style[HydraCSS.styles.vendorTransform]=transformString,this.__transformCache=transformString)}return this},$.fn.willChange=function(props){if("boolean"==typeof props)this._willChangeLock=!0===props;else if(this._willChangeLock)return;var string="string"==typeof props;this._willChange&&!string||"null"==typeof props?(this._willChange=!1,this.div.style["will-change"]=""):(this._willChange=!0,this.div.style["will-change"]=string?props:HydraCSS.transformProperty+", opacity")},$.fn.backfaceVisibility=function(visible){this.div.style[HydraCSS.prefix("BackfaceVisibility")]=visible?"visible":"hidden"},$.fn.enable3D=function(perspective,x,y){return Device.tween.css3d?(this.div.style[HydraCSS.prefix("TransformStyle")]="preserve-3d",perspective&&(this.div.style[HydraCSS.prefix("Perspective")]=perspective+"px"),void 0!==x&&(x="number"==typeof x?x+"px":x,y="number"==typeof y?y+"px":y,this.div.style[HydraCSS.prefix("PerspectiveOrigin")]=x+" "+y),this):this},$.fn.disable3D=function(){return this.div.style[HydraCSS.prefix("TransformStyle")]="",this.div.style[HydraCSS.prefix("Perspective")]="",this},$.fn.transformPoint=function(x,y,z){var origin="";return void 0!==x&&(origin+="number"==typeof x?x+"px ":x+" "),void 0!==y&&(origin+="number"==typeof y?y+"px ":y+" "),void 0!==z&&(origin+="number"==typeof z?z+"px":z),this.div.style[HydraCSS.prefix("TransformOrigin")]=origin,this},$.fn.tween=function(props,time,ease,delay,callback,manual){"boolean"==typeof delay?(manual=delay,delay=0,callback=null):"function"==typeof delay&&(callback=delay,delay=0),"boolean"==typeof callback&&(manual=callback,callback=null),delay||(delay=0);var usePromise=null;callback&&callback instanceof Promise&&(usePromise=callback,callback=callback.resolve);var tween=TweenManager._detectTween(this,props,time,ease,delay,callback,manual);return usePromise||tween},$.fn.clearTransform=function(){return"number"==typeof this.x&&(this.x=0),"number"==typeof this.y&&(this.y=0),"number"==typeof this.z&&(this.z=0),"number"==typeof this.scale&&(this.scale=1),"number"==typeof this.scaleX&&(this.scaleX=1),"number"==typeof this.scaleY&&(this.scaleY=1),"number"==typeof this.rotation&&(this.rotation=0),"number"==typeof this.rotationX&&(this.rotationX=0),"number"==typeof this.rotationY&&(this.rotationY=0),"number"==typeof this.rotationZ&&(this.rotationZ=0),"number"==typeof this.skewX&&(this.skewX=0),"number"==typeof this.skewY&&(this.skewY=0),this.div.style[HydraCSS.styles.vendorTransform]="",this.__transformCache="",this},$.fn.clearTween=function(){return this._cssTween&&this._cssTween.stop(),this._mathTween&&this._mathTween.stop(),this},$.fn.stopTween=function(){return console.warn(".stopTween deprecated. use .clearTween instead"),this.clearTween()},$.fn.keypress=function(callback){this.div.onkeypress=function(e){(e=e||window.event).code=e.keyCode?e.keyCode:e.charCode,callback&&callback(e)}},$.fn.keydown=function(callback){this.div.onkeydown=function(e){(e=e||window.event).code=e.keyCode,callback&&callback(e)}},$.fn.keyup=function(callback){this.div.onkeyup=function(e){(e=e||window.event).code=e.keyCode,callback&&callback(e)}},$.fn.attr=function(attr,value){return"string"!=typeof attr?this:void 0===value?this.div.getAttribute(attr):(!1===value||null===value?this.div.removeAttribute(attr):this.div.setAttribute(attr,value),this)},$.fn.val=function(value){return void 0===value?this.div.value:(this.div.value=value,this)},$.fn.change=$.fn.onChange=function(callback){var _this=this;this.div.onchange=this.div.onblur=function(){callback({object:_this,value:_this.div.value||""})}},$.fn.svgSymbol=function(id,width,height){var config=SVG.getSymbolConfig(id),svgHTML='<svg viewBox="0 0 '+config.width+" "+config.height+'" width="'+width+'" height="'+height+'"><use xlink:href="#'+config.id+'" x="0" y="0" /></svg>';this.html(svgHTML,!0)},$.fn.svg=async function(url){let promise=Promise.create();return fetch(url).then((async res=>{let svgHTML=await res.text();this.html(svgHTML,!0),promise.resolve()})),promise},$.fn.overflowScroll=function(dir){var x=!!dir.x,y=!!dir.y,overflow={};return(!x&&!y||x&&y)&&(overflow.overflow="auto"),!x&&y&&(overflow.overflowY="auto",overflow.overflowX="hidden"),x&&!y&&(overflow.overflowX="auto",overflow.overflowY="hidden"),Device.mobile&&(overflow["-webkit-overflow-scrolling"]="touch",Mobile._addOverflowScroll(this)),this.css(overflow)},$.fn.removeOverflowScroll=function(){return this.css({overflow:"hidden",overflowX:"",overflowY:"","-webkit-overflow-scrolling":""}),Device.mobile&&Mobile._removeOverflowScroll(this),this},$.fn.accessible=function(type="label",tabIndex=-1){switch(tabIndex>-1&&this.attr("tabindex",tabIndex),type){case"label":this.attr("aria-label",this.div.textContent);break;case"hidden":this.attr("aria-hidden",!0)}return this},$.fn.tabIndex=function(tabIndex){return this.attr("tabindex",tabIndex),this},$.fn.createObserver=function(callback,{isViewport:isViewport=!1,...options}={}){isViewport&&(options.root=this.div);const observer=this._observer=new IntersectionObserver((array=>{array.forEach((entry=>{entry.object=entry.target.hydraObject})),callback(array)}),options);return this._bindOnDestroy((()=>{observer.disconnect()})),this},$.fn.observe=function(obj=this){return this._observer?.observe(obj.div),this},$.fn.unobserve=function(obj=this){return this._observer?.unobserve(obj.div),this},$.fn.cursor=function(cursor,lock){if(!Device.mobile)return lock&&(this.cursorLock||(this.cursorLock=new Map),"auto"==cursor?this.cursorLock.delete(lock):this.cursorLock.set(lock,cursor)),this.cursorLock&&"auto"==cursor&&this.cursorLock.forEach((v=>{cursor=v})),this.css("cursor",cursor),this},$.fn.classList=function(){return this.div.classList},$.fn.goob=function(styles){let _styles;return _styles="string"==typeof styles?goober.css`${styles}`:goober.css(styles),this.goobClass=_styles,this.div.classList.add(_styles),this},$.fn.glob=function(styles){let key=styles.replace("\n","").slice(0,100);goober.globbed||(goober.globbed={}),goober.globbed[key]||(goober.glob(styles),goober.globbed[key]=1)},$.fn.href=function(str){return this.attr("href",str),this},$.fn.target=function(str){return this.attr("target",str),this},$.fn.ariaLabel=function(str){return this.attr("aria-label",str),this},$.fn.alt=function(str){return this.attr("alt",str),this},$.fn.src=function(str){return this.attr("src",str),this},$.fn.display=function(bool){bool?$this.show():$this.hide()},$.fn.type=function(str){return this.attr("type",str),this},$.fn.id=function(str){return this.attr("id",str),this},$.fn.htmlFor=function(str){return this.attr("for",str),this},$.fn.ariaLabelledBy=function(str){return this.attr("aria-labelledby",str),this},$.fn.checked=function(bool){return this.attr("checked",bool),this},$.fn.min=function(num){return this.attr("min",num),this},$.fn.max=function(num){return this.attr("max",num),this},$.fn.step=function(num){return this.attr("step",num),this},$.fn.value=function(any){return this.attr("value",any),this},$.fn.title=function(str){return this.attr("title",str),this},$.fn.minlength=function(num){return this.attr("minlength",num),this},$.fn.maxlength=function(num){return this.attr("maxlength",num),this},$.fn.rows=function(num){return this.attr("rows",num),this},$.fn.readonly=function(bool){return this.attr("readonly",bool),this}}(),function(){var windowsPointer=!!window.MSGesture,translateEvent=function(evt){if(windowsPointer)switch(evt){case"touchstart":return"pointerdown";case"touchmove":return"MSGestureChange";case"touchend":return"pointerup"}return evt},convertTouchEvent=function(e){var touchEvent={x:0,y:0};if(e.windowsPointer)return e;if(!e)return touchEvent;if(e.touches||e.changedTouches?e.touches.length?(touchEvent.x=e.touches[0].clientX,touchEvent.y=e.touches[0].clientY):(touchEvent.x=e.changedTouches[0].clientX,touchEvent.y=e.changedTouches[0].clientY):(touchEvent.x=e.clientX,touchEvent.y=e.clientY),Mobile.ScreenLock&&Mobile.ScreenLock.isActive&&Mobile.orientationSet&&Mobile.orientation!==Mobile.orientationSet){if(90==window.orientation||0===window.orientation){var x=touchEvent.y;touchEvent.y=touchEvent.x,touchEvent.x=Stage.width-x}if(-90==window.orientation||180===window.orientation){var y=touchEvent.x;touchEvent.x=touchEvent.y,touchEvent.y=Stage.height-y}}return touchEvent};$.fn.click=function(callback){var _this=this;return this.div.addEventListener(translateEvent("click"),(function click(e){return!!_this.div&&(!Mouse._preventClicks&&(e.object="hit"==_this.div.className?_this.parent():_this,e.action="click",callback&&callback(e),void(Mouse.autoPreventClicks&&Mouse.preventClicks())))}),!0),this.div.style.cursor="pointer",this},$.fn.hover=function(callback){var _time,_this=this,_over=!1;function hover(e){if(!_this.div)return!1;var time=performance.now(),original=e.toElement||e.relatedTarget;if(_time&&time-_time<5)return _time=time,!1;switch(_time=time,e.object="hit"==_this.div.className?_this.parent():_this,e.type){case"mouseout":case"mouseleave":e.action="out";break;default:e.action="over"}if(_over){if(Mouse._preventClicks)return!1;if("over"==e.action)return!1;if("out"==e.action&&isAChild(_this.div,original))return!1;_over=!1}else{if("out"==e.action)return!1;_over=!0}callback&&callback(e)}function isAChild(div,object){for(var len=div.children.length-1,i=len;i>-1;i--)if(object==div.children[i])return!0;for(i=len;i>-1;i--)if(isAChild(div.children[i],object))return!0}return this.div.addEventListener(translateEvent("mouseover"),hover,!0),this.div.addEventListener(translateEvent("mouseout"),hover,!0),this},$.fn.press=function(callback){var _this=this;function press(e){if(!_this.div)return!1;if(e.object="hit"==_this.div.className?_this.parent():_this,"mousedown"===e.type)e.action="down";else e.action="up";callback&&callback(e)}return this.div.addEventListener(translateEvent("mousedown"),press,!0),this.div.addEventListener(translateEvent("mouseup"),press,!0),this},$.fn.bind=function(evt,callback){if(this._events=this._events||{},windowsPointer&&this==__window)return Stage.bind(evt,callback);"touchstart"==evt?Device.mobile||(Device.touchCapable?this.bind("mousedown",callback):evt="mousedown"):"touchmove"==evt?(Device.mobile||(Device.touchCapable?this.bind("mousemove",callback):evt="mousemove"),windowsPointer&&!this.div.msGesture&&(this.div.msGesture=new MSGesture,this.div.msGesture.target=this.div)):"touchend"==evt&&(Device.mobile||(Device.touchCapable?this.bind("mouseup",callback):evt="mouseup")),this._events["bind_"+evt]=this._events["bind_"+evt]||[];var _events=this._events["bind_"+evt],e={},target=this.div;function touchEvent(e){windowsPointer&&target.msGesture&&"touchstart"==evt&&target.msGesture.addPointer(e.pointerId),Device.mobile||"touchstart"!=evt||e.preventDefault();var touch=convertTouchEvent(e);if(windowsPointer){var windowsEvt=e;(e={}).preventDefault=()=>windowsEvt.preventDefault(),e.stopPropagation=()=>windowsEvt.stopPropagation(),e.x=Number(windowsEvt.clientX),e.y=Number(windowsEvt.clientY),e.target=windowsEvt.target,e.currentTarget=windowsEvt.currentTarget,e.path=[];for(var node=e.target;node;)e.path.push(node),node=node.parentElement||null;e.windowsPointer=!0}else e.x=touch.x,e.y=touch.y;for(var i=0;i<_events.length;i++){var ev=_events[i];ev.target==e.currentTarget&&ev.callback(e)}}return e.callback=callback,e.target=this.div,_events.push(e),this._events["fn_"+evt]||(this._events["fn_"+evt]=touchEvent,this.div.addEventListener(translateEvent(evt),touchEvent,{capture:!0,passive:!1})),this},$.fn.unbind=function(evt,callback){if(this._events=this._events||{},windowsPointer&&this==__window)return Stage.unbind(evt,callback);"touchstart"==evt?Device.mobile||(Device.touchCapable?this.unbind("mousedown",callback):evt="mousedown"):"touchmove"==evt?Device.mobile||(Device.touchCapable?this.unbind("mousemove",callback):evt="mousemove"):"touchend"==evt&&(Device.mobile||(Device.touchCapable?this.unbind("mouseup",callback):evt="mouseup"));var _events=this._events["bind_"+evt];if(!_events)return this;for(var i=0;i<_events.length;i++){_events[i].callback==callback&&_events.splice(i,1)}return this._events["fn_"+evt]&&!_events.length&&(this.div.removeEventListener(translateEvent(evt),this._events["fn_"+evt],!Device.mobile||{passive:!0}),this._events["fn_"+evt]=null),this},$.fn.interact=function(overCallback,clickCallback,seoLink,seoText,zIndex,options){const position=getComputedStyle(this.div).position;if(position&&"static"!==position||this.css({position:"relative"}),!this.hit){"object"==typeof arguments[arguments.length-1]&&(options=arguments[arguments.length-1],[overCallback,clickCallback,seoLink,seoText,zIndex]=Array.prototype.slice.call(arguments,0,-1),options.overCallback&&(overCallback=options.overCallback),options.clickCallback&&(clickCallback=options.clickCallback),options.seoLink&&(seoLink=options.seoLink),options.seoText&&(seoText=options.seoText),options.zIndex&&(zIndex=options.zIndex)),options||(options={}),this.hit=$(".hit",seoLink?"a":void 0),this.hit.css({width:"100%",height:"100%",zIndex:zIndex||99999,top:0,left:0,position:"absolute"}),this.add(this.hit);var _this=this;seoLink&&(this.hit.attr("href","#"===seoLink||seoLink.includes("mailto:")?seoLink:Hydra.absolutePath(seoLink)),this.hit.text(seoText||this.div.textContent),this.hit.css({fontSize:0}),this.hit.accessible(),"function"==typeof overCallback&&(this.hit.div.onfocus=_=>overCallback({action:"over",object:this}),this.hit.div.onblur=_=>overCallback({action:"out",object:this})),this.hit.div.onclick=e=>{e.preventDefault(),e.object=_this,e.action="click",clicked(e)}),options.role&&(this.hit.attr("role",options.role),"button"===options.role&&(this.hit.div.onkeydown=e=>{switch(e.key){case" ":case"Spacebar":e.preventDefault(),e.stopPropagation(),e.object=_this,e.action="click",clicked(e)}}))}let time=Render.TIME;function clicked(e){clickCallback&&Render.TIME-time>250&&clickCallback(e),time=Render.TIME}Device.mobile?this.hit.touchClick(overCallback,clicked):this.hit.hover(overCallback).click(clicked)},$.fn.clearInteract=function(){this.hit&&(this.hit=this.hit.destroy())},$.fn.disableInteract=function(){this.hit&&this.hit.css({pointerEvents:"none"})},$.fn.enableInteract=function(){this.hit&&this.hit.css({pointerEvents:"auto"})},$.fn.touchSwipe=function(callback,distance){if(!window.addEventListener)return this;var _startX,_startY,_this=this,_distance=distance||75,_moving=!1,_move={};function touchMove(e){if(!_this.div)return!1;if(_moving){var touch=convertTouchEvent(e),dx=_startX-touch.x,dy=_startY-touch.y;_move.direction=null,_move.moving=null,_move.x=null,_move.y=null,_move.evt=e,Math.abs(dx)>=_distance?(touchEnd(),_move.direction=dx>0?"left":"right"):Math.abs(dy)>=_distance?(touchEnd(),_move.direction=dy>0?"up":"down"):(_move.moving=!0,_move.x=dx,_move.y=dy),callback&&callback(_move,e)}}function touchEnd(e){if(!_this.div)return!1;_startX=_startY=_moving=!1,_this.div.removeEventListener(translateEvent("touchmove"),touchMove)}return Device.mobile&&(this.div.addEventListener(translateEvent("touchstart"),(function touchStart(e){var touch=convertTouchEvent(e);if(!_this.div)return!1;1==e.touches.length&&(_startX=touch.x,_startY=touch.y,_moving=!0,_this.div.addEventListener(translateEvent("touchmove"),touchMove,{passive:!0}))}),{passive:!0}),this.div.addEventListener(translateEvent("touchend"),touchEnd,{passive:!0}),this.div.addEventListener(translateEvent("touchcancel"),touchEnd,{passive:!0})),this},$.fn.touchClick=function(hover,click){if(!window.addEventListener)return this;var _time,_move,_this=this,_start={},_touch={};function setTouch(e){var touch=convertTouchEvent(e);e.touchX=touch.x,e.touchY=touch.y,_start.x=e.touchX,_start.y=e.touchY}return Device.mobile&&(this.div.addEventListener(translateEvent("touchstart"),(function touchStart(e){if(!_this.div)return!1;_time=performance.now(),e.action="over",e.object="hit"==_this.div.className?_this.parent():_this,setTouch(e),hover&&!_move&&hover(e)}),{passive:!0}),this.div.addEventListener(translateEvent("touchend"),(function touchEnd(e){if(!_this.div)return!1;var time=performance.now();if(_touch=convertTouchEvent(e),_move=function findDistance(p1,p2){var dx=p2.x-p1.x,dy=p2.y-p1.y;return Math.sqrt(dx*dx+dy*dy)}(_start,_touch)>25,e.object="hit"==_this.div.className?_this.parent():_this,setTouch(e),_time&&time-_time<750){if(Mouse._preventClicks)return!1;click&&!_move&&(!0,e.action="click",click&&!_move&&click(e),Mouse.autoPreventClicks&&Mouse.preventClicks())}hover&&(e.action="out",Mouse._preventFire||hover(e));_move=!1}),{passive:!0})),this}}(),Class((function Element(type="div"){Inherit(this,Component);var name=Utils.getConstructorName(this);this.__element=!0,this.element=$("."+name,type),this.element.__useFragment=!0,this.destroy=function(){this.element&&this.element.remove&&(this.element=this.element.remove()),this._destroy&&this._destroy()},this.querySelector=async function(selector){if(await defer(),Array.isArray(selector)){let values=[];return selector.forEach((s=>{values.push($(this.element.div.querySelector(s)))})),values}return $(this.element.div.querySelector(selector))},this.querySelectorAll=async function(selector){await defer();let list=this.element.div.querySelectorAll(selector),values=[];for(let i=0;i<list.length;i++)values.push($(list[i]));return values}})),(()=>{var ap=Object.create,Et=Object.defineProperty,sp=Object.defineProperties,pp=Object.getOwnPropertyDescriptor,lp=Object.getOwnPropertyDescriptors,up=Object.getOwnPropertyNames,ln=Object.getOwnPropertySymbols,fp=Object.getPrototypeOf,un=Object.prototype.hasOwnProperty,cp=Object.prototype.propertyIsEnumerable,lo=(e,t,r)=>t in e?Et(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,_=(e,t)=>{for(var r in t||(t={}))un.call(t,r)&&lo(e,r,t[r]);if(ln)for(var r of ln(t))cp.call(t,r)&&lo(e,r,t[r]);return e},V=(e,t)=>sp(e,lp(t)),fn=e=>Et(e,"__esModule",{value:!0}),Kt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),uo=(e,t)=>{for(var r in fn(e),t)Et(e,r,{get:t[r],enumerable:!0})},Gt=e=>((e,t,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let o of up(t))!un.call(e,o)&&"default"!==o&&Et(e,o,{get:()=>t[o],enumerable:!(r=pp(t,o))||r.enumerable});return e})(fn(Et(null!=e?ap(fp(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e),d=(e,t,r)=>(lo(e,"symbol"!=typeof t?t+"":t,r),r),fi=Kt(((Ej,ui)=>{ui.exports=function(){function e(t,r,o,n){this.set(t,r,o,n)}return e.prototype.set=function(t,r,o,n){this._cx=3*t,this._bx=3*(o-t)-this._cx,this._ax=1-this._cx-this._bx,this._cy=3*r,this._by=3*(n-r)-this._cy,this._ay=1-this._cy-this._by},e.epsilon=1e-6,e.prototype._sampleCurveX=function(t){return((this._ax*t+this._bx)*t+this._cx)*t},e.prototype._sampleCurveY=function(t){return((this._ay*t+this._by)*t+this._cy)*t},e.prototype._sampleCurveDerivativeX=function(t){return(3*this._ax*t+2*this._bx)*t+this._cx},e.prototype._solveCurveX=function(t,r){var o,n,i,a,s,l;for(i=void 0,a=void 0,s=void 0,l=void 0,o=void 0,n=void 0,s=t,n=0;n<8;){if(l=this._sampleCurveX(s)-t,Math.abs(l)<r)return s;if(o=this._sampleCurveDerivativeX(s),Math.abs(o)<r)break;s-=l/o,n++}if((s=t)<(i=0))return i;if(s>(a=1))return a;for(;i<a;){if(l=this._sampleCurveX(s),Math.abs(l-t)<r)return s;t>l?i=s:a=s,s=.5*(a-i)+i}return s},e.prototype.solve=function(t,r){return this._sampleCurveY(this._solveCurveX(t,r))},e.prototype.solveSimple=function(t){return this._sampleCurveY(this._solveCurveX(t,1e-6))},e}()})),ks=Kt(((eO,Cs)=>{var Lr,No;Lr=[],No=[],Cs.exports=function Yh(e,t,r){var o,n,i,a,s,l,p,u;if(e===t)return 0;if(o=e.length,n=t.length,0===o)return n;if(0===n)return o;for(r&&(e=e.toLowerCase(),t=t.toLowerCase()),p=0;p<o;)No[p]=e.charCodeAt(p),Lr[p]=++p;for(u=0;u<n;)for(i=t.charCodeAt(u),a=s=u++,p=-1;++p<o;)l=i===No[p]?s:s+1,s=Lr[p],Lr[p]=a=s>a?l>a?a+1:l:l>s?s+1:l;return a}})),Rs=Kt(((tO,Es)=>{var Ds=ks();Es.exports=function Xh(){var e,t,r,o,n,i=0,a=arguments[0],s=arguments[1],l=s.length,p=arguments[2];p&&(o=p.threshold,n=p.ignoreCase),void 0===o&&(o=0);for(var u=0;u<l;++u)(e=(t=n?Ds(a,s[u],!0):Ds(a,s[u]))>a.length?1-t/s[u].length:1-t/a.length)>i&&(i=e,r=s[u]);return i>=o?r:null}})),qo=Kt(((fw,zs)=>{"use strict";zs.exports=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){if(t.constructor!==r.constructor)return!1;var o,n,i;if(Array.isArray(t)){if((o=t.length)!=r.length)return!1;for(n=o;0!=n--;)if(!e(t[n],r[n]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if((o=(i=Object.keys(t)).length)!==Object.keys(r).length)return!1;for(n=o;0!=n--;)if(!Object.prototype.hasOwnProperty.call(r,i[n]))return!1;for(n=o;0!=n--;){var a=i[n];if(!e(t[a],r[a]))return!1}return!0}return t!=t&&r!=r}})),pn={};uo(pn,{createRafDriver:()=>Ft,getProject:()=>np,notify:()=>pe,onChange:()=>Rr,setCoreRafDriver:()=>zr,types:()=>Yr,val:()=>ip});var sn={};uo(sn,{createRafDriver:()=>Ft,getProject:()=>np,notify:()=>pe,onChange:()=>Rr,setCoreRafDriver:()=>zr,types:()=>Yr,val:()=>ip});var $=Array.isArray,Ht="object"==typeof window&&window&&window.Object===Object&&window,gp="object"==typeof self&&self&&self.Object===Object&&self,N=Ht||gp||Function("return this")(),W=N.Symbol,cn=Object.prototype,Pp=cn.hasOwnProperty,jp=cn.toString,Rt=W?W.toStringTag:void 0;var dn=function _p(e){var t=Pp.call(e,Rt),r=e[Rt];try{e[Rt]=void 0;var o=!0}catch(i){}var n=jp.call(e);return o&&(t?e[Rt]=r:delete e[Rt]),n},Tp=Object.prototype.toString;var mn=function xp(e){return Tp.call(e)},hn=W?W.toStringTag:void 0;var X=function Ap(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":hn&&hn in Object(e)?dn(e):mn(e)};var B=function Op(e){return null!=e&&"object"==typeof e};var Te=function Cp(e){return"symbol"==typeof e||B(e)&&"[object Symbol]"==X(e)},kp=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Dp=/^\w*$/;var et=function Ep(e,t){if($(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!Te(e))||(Dp.test(e)||!kp.test(e)||null!=t&&e in Object(t))};var M=function Rp(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};var e,Jt=function $p(e){if(!M(e))return!1;var t=X(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},Yt=N["__core-js_shared__"],gn=(e=/[^.]+$/.exec(Yt&&Yt.keys&&Yt.keys.IE_PROTO||""))?"Symbol(src)_1."+e:"";var yn=function Fp(e){return!!gn&&gn in e},qp=Function.prototype.toString;var me=function zp(e){if(null!=e){try{return qp.call(e)}catch(t){}try{return e+""}catch(t){}}return""},Kp=/^\[object .+?Constructor\]$/,Gp=Function.prototype,Hp=Object.prototype,Jp=Gp.toString,Yp=Hp.hasOwnProperty,Xp=RegExp("^"+Jp.call(Yp).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var bn=function Zp(e){return!(!M(e)||yn(e))&&(Jt(e)?Xp:Kp).test(me(e))};var Pn=function Qp(e,t){return null==e?void 0:e[t]};var K=function el(e,t){var r=Pn(e,t);return bn(r)?r:void 0},he=K(Object,"create");var jn=function rl(){this.__data__=he?he(null):{},this.size=0};var _n=function ol(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},al=Object.prototype.hasOwnProperty;var vn=function sl(e){var t=this.__data__;if(he){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return al.call(t,e)?t[e]:void 0},ll=Object.prototype.hasOwnProperty;var Tn=function ul(e){var t=this.__data__;return he?void 0!==t[e]:ll.call(t,e)};var xn=function cl(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=he&&void 0===t?"__lodash_hash_undefined__":t,this};function tt(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var o=e[t];this.set(o[0],o[1])}}tt.prototype.clear=jn,tt.prototype.delete=_n,tt.prototype.get=vn,tt.prototype.has=Tn,tt.prototype.set=xn;var fo=tt;var Sn=function dl(){this.__data__=[],this.size=0};var rt=function ml(e,t){return e===t||e!=e&&t!=t};var xe=function hl(e,t){for(var r=e.length;r--;)if(rt(e[r][0],t))return r;return-1},yl=Array.prototype.splice;var In=function bl(e){var t=this.__data__,r=xe(t,e);return!(r<0)&&(r==t.length-1?t.pop():yl.call(t,r,1),--this.size,!0)};var An=function Pl(e){var t=this.__data__,r=xe(t,e);return r<0?void 0:t[r][1]};var On=function jl(e){return xe(this.__data__,e)>-1};var wn=function _l(e,t){var r=this.__data__,o=xe(r,e);return o<0?(++this.size,r.push([e,t])):r[o][1]=t,this};function ot(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var o=e[t];this.set(o[0],o[1])}}ot.prototype.clear=Sn,ot.prototype.delete=In,ot.prototype.get=An,ot.prototype.has=On,ot.prototype.set=wn;var Se=ot,Ie=K(N,"Map");var Cn=function Tl(){this.size=0,this.__data__={hash:new fo,map:new(Ie||Se),string:new fo}};var kn=function xl(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e};var Ae=function Sl(e,t){var r=e.__data__;return kn(t)?r["string"==typeof t?"string":"hash"]:r.map};var Dn=function Il(e){var t=Ae(this,e).delete(e);return this.size-=t?1:0,t};var En=function Al(e){return Ae(this,e).get(e)};var Rn=function Ol(e){return Ae(this,e).has(e)};var Vn=function wl(e,t){var r=Ae(this,e),o=r.size;return r.set(e,t),this.size+=r.size==o?0:1,this};function nt(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var o=e[t];this.set(o[0],o[1])}}nt.prototype.clear=Cn,nt.prototype.delete=Dn,nt.prototype.get=En,nt.prototype.has=Rn,nt.prototype.set=Vn;var Be=nt;function co(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var r=function(){var o=arguments,n=t?t.apply(this,o):o[0],i=r.cache;if(i.has(n))return i.get(n);var a=e.apply(this,o);return r.cache=i.set(n,a)||i,a};return r.cache=new(co.Cache||Be),r}co.Cache=Be;var Nn=co;var Ln=function Dl(e){var t=Nn(e,(function(o){return 500===r.size&&r.clear(),o})),r=t.cache;return t},El=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Rl=/\\(\\)?/g,Vl=Ln((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(El,(function(r,o,n,i){t.push(n?i.replace(Rl,"$1"):o||r)})),t})),Mn=Vl;var $n=function Nl(e,t){for(var r=-1,o=null==e?0:e.length,n=Array(o);++r<o;)n[r]=t(e[r],r,e);return n},Bn=W?W.prototype:void 0,Fn=Bn?Bn.toString:void 0;var Xt=function Un(e){if("string"==typeof e)return e;if($(e))return $n(e,Un)+"";if(Te(e))return Fn?Fn.call(e):"";var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t};var Zt=function Ml(e){return null==e?"":Xt(e)};var Oe=function $l(e,t){return $(e)?e:et(e,t)?[e]:Mn(Zt(e))};var re=function Fl(e){if("string"==typeof e||Te(e))return e;var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t};var it=function Ul(e,t){for(var r=0,o=(t=Oe(t,e)).length;null!=e&&r<o;)e=e[re(t[r++])];return r&&r==o?e:void 0};var at=function ql(e,t,r){var o=null==e?void 0:it(e,t);return void 0===o?r:o};var Qt=function zl(e,t){return function(r){return e(t(r))}},st=Qt(Object.getPrototypeOf,Object),Gl=Function.prototype,Hl=Object.prototype,qn=Gl.toString,Jl=Hl.hasOwnProperty,Yl=qn.call(Object);var Vt=function Xl(e){if(!B(e)||"[object Object]"!=X(e))return!1;var t=st(e);if(null===t)return!0;var r=Jl.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&qn.call(r)==Yl};var er=function Zl(e){var t=null==e?0:e.length;return t?e[t-1]:void 0},mo=new WeakMap,zn=new WeakMap,Wn=Symbol("pointerMeta"),Ql={get(e,t){if(t===Wn)return mo.get(e);let r=zn.get(e);r||(r=new Map,zn.set(e,r));let o=r.get(t);if(void 0!==o)return o;let n=mo.get(e),i=Kn({root:n.root,path:[...n.path,t]});return r.set(t,i),i}},pt=e=>e[Wn],Z=e=>{let{root:t,path:r}=pt(e);return{root:t,path:r}};function Kn(e){var o;let t={root:e.root,path:null!=(o=e.path)?o:[]},r={};return mo.set(r,t),new Proxy(r,Ql)}var ge=Kn,ae=e=>e&&!!pt(e);var tr=(e,t,r)=>{if(0===t.length)return r(e);if(Array.isArray(e)){let[o,...n]=t;o=parseInt(String(o),10),isNaN(o)&&(o=0);let i=e[o],a=tr(i,n,r);if(i===a)return e;let s=[...e];return s.splice(o,1,a),s}if("object"==typeof e&&null!==e){let[o,...n]=t,i=e[o],a=tr(i,n,r);return i===a?e:V(_({},e),{[o]:a})}{let[o,...n]=t;return{[o]:tr(void 0,n,r)}}},lt=class{constructor(){this._head=void 0}peek(){return this._head&&this._head.data}pop(){let t=this._head;if(t)return this._head=t.next,t.data}push(t){let r={next:this._head,data:t};this._head=r}};function we(e){return!(!e||!e.isPrism||!0!==e.isPrism)}function Gn(){let t=new lt,r=()=>{};return{type:"Dataverse_discoveryMechanism",startIgnoringDependencies:()=>{t.push(r)},stopIgnoringDependencies:()=>{t.peek()!==r||t.pop()},reportResolutionStart:p=>{let u=t.peek();u&&u(p),t.push(r)},reportResolutionEnd:p=>{t.pop()},pushCollector:p=>{t.push(p)},popCollector:p=>{if(t.peek()!==p)throw new Error("Popped collector is not on top of the stack");t.pop()}}}var{startIgnoringDependencies:ut,stopIgnoringDependencies:ft,reportResolutionEnd:Hn,reportResolutionStart:Jn,pushCollector:Yn,popCollector:Xn}=function eu(){let e="__dataverse_discoveryMechanism_sharedStack",t="undefined"!=typeof window||"undefined"!=typeof window?window:{};if(t){let r=t[e];if(r&&"object"==typeof r&&"Dataverse_discoveryMechanism"===r.type)return r;{let o=Gn();return t[e]=o,o}}return Gn()}(),Zn=()=>{},Qn=class{constructor(t,r){this._fn=t,this._prismInstance=r,this._didMarkDependentsAsStale=!1,this._isFresh=!1,this._cacheOfDendencyValues=new Map,this._dependents=new Set,this._dependencies=new Set,this._possiblyStaleDeps=new Set,this._scope=new rr(this),this._lastValue=void 0,this._forciblySetToStale=!1,this._reactToDependencyGoingStale=t=>{this._possiblyStaleDeps.add(t),this._markAsStale()};for(let o of this._dependencies)o._addDependent(this._reactToDependencyGoingStale);ut(),this.getValue(),ft()}get hasDependents(){return this._dependents.size>0}removeDependent(t){this._dependents.delete(t)}addDependent(t){this._dependents.add(t)}destroy(){for(let t of this._dependencies)t._removeDependent(this._reactToDependencyGoingStale);ti(this._scope)}getValue(){if(!this._isFresh){let t=this._recalculate();this._lastValue=t,this._isFresh=!0,this._didMarkDependentsAsStale=!1,this._forciblySetToStale=!1}return this._lastValue}_recalculate(){let t;if(!this._forciblySetToStale&&this._possiblyStaleDeps.size>0){let n=!1;ut();for(let i of this._possiblyStaleDeps)if(this._cacheOfDendencyValues.get(i)!==i.getValue()){n=!0;break}if(ft(),this._possiblyStaleDeps.clear(),!n)return this._lastValue}let r=new Set;this._cacheOfDendencyValues.clear();let o=n=>{r.add(n),this._addDependency(n)};Yn(o),G.push(this._scope);try{t=this._fn()}catch(n){console.error(n)}finally{G.pop()!==this._scope&&console.warn("The Prism hook stack has slipped. This is a bug.")}Xn(o);for(let n of this._dependencies)r.has(n)||this._removeDependency(n);this._dependencies=r,ut();for(let n of r)this._cacheOfDendencyValues.set(n,n.getValue());return ft(),t}forceStale(){this._forciblySetToStale=!0,this._markAsStale()}_markAsStale(){if(!this._didMarkDependentsAsStale){this._didMarkDependentsAsStale=!0,this._isFresh=!1;for(let t of this._dependents)t(this._prismInstance)}}_addDependency(t){this._dependencies.has(t)||(this._dependencies.add(t),t._addDependent(this._reactToDependencyGoingStale))}_removeDependency(t){!this._dependencies.has(t)||(this._dependencies.delete(t),t._removeDependent(this._reactToDependencyGoingStale))}},tu={},ei=class{constructor(t){this._fn=t,this.isPrism=!0,this._state={hot:!1,handle:void 0}}get isHot(){return this._state.hot}onChange(t,r,o=!1){let n=()=>{t.onThisOrNextTick(a)},i=tu,a=()=>{let l=this.getValue();l!==i&&(i=l,r(l))};return this._addDependent(n),o&&(i=this.getValue(),r(i)),()=>{this._removeDependent(n),t.offThisOrNextTick(a),t.offNextTick(a)}}onStale(t){let o=()=>t();return this._addDependent(o),()=>{this._removeDependent(o)}}keepHot(){return this.onStale((()=>{}))}_addDependent(t){this._state.hot||this._goHot(),this._state.handle.addDependent(t)}_goHot(){let t=new Qn(this._fn,this);this._state={hot:!0,handle:t}}_removeDependent(t){let r=this._state;if(!r.hot)return;let o=r.handle;o.removeDependent(t),o.hasDependents||(this._state={hot:!1,handle:void 0},o.destroy())}getValue(){Jn(this);let r,t=this._state;return r=t.hot?t.handle.getValue():function uu(e){let r,t=new nr;G.push(t);try{r=e()}catch(o){console.error(o)}finally{G.pop()!==t&&console.warn("The Prism hook stack has slipped. This is a bug.")}return r}(this._fn),Hn(this),r}},rr=class{constructor(t){this._hotHandle=t,this._refs=new Map,this.isPrismScope=!0,this.subs={},this.effects=new Map,this.memos=new Map}ref(t,r){let o=this._refs.get(t);if(void 0!==o)return o;{let n={current:r};return this._refs.set(t,n),n}}effect(t,r,o){let n=this.effects.get(t);void 0===n&&(n={cleanup:Zn,deps:void 0},this.effects.set(t,n)),ri(n.deps,o)&&(n.cleanup(),ut(),n.cleanup=or(r,Zn).value,ft(),n.deps=o)}memo(t,r,o){let n=this.memos.get(t);return void 0===n&&(n={cachedValue:null,deps:void 0},this.memos.set(t,n)),ri(n.deps,o)&&(ut(),n.cachedValue=or(r,void 0).value,ft(),n.deps=o),n.cachedValue}state(t,r){let{value:o,setValue:n}=this.memo("state/"+t,(()=>{let i={current:r};return{value:i,setValue:s=>{i.current=s,this._hotHandle.forceStale()}}}),[]);return[o.current,n]}sub(t){return this.subs[t]||(this.subs[t]=new rr(this._hotHandle)),this.subs[t]}cleanupEffects(){for(let t of this.effects.values())or(t.cleanup,void 0);this.effects.clear()}source(t,r){return this.effect("$$source/blah",(()=>t((()=>{this._hotHandle.forceStale()}))),[t]),r()}};function ti(e){for(let t of Object.values(e.subs))ti(t);e.cleanupEffects()}function or(e,t){try{return{value:e(),ok:!0}}catch(r){return setTimeout((function(){throw r})),{value:t,ok:!1}}}var G=new lt;function ri(e,t){if(void 0===e||void 0===t)return!0;let r=e.length;if(r!==t.length)return!0;for(let o=0;o<r;o++)if(e[o]!==t[o])return!0;return!1}function oi(e,t,r){let o=G.peek();if(!o)throw new Error("prism.memo() is called outside of a prism() call.");return o.memo(e,t,r)}var se=e=>new ei(e),nr=class{effect(t,r,o){console.warn("prism.effect() does not run in cold prisms")}memo(t,r,o){return r()}state(t,r){return[r,()=>{}]}ref(t,r){return{current:r}}sub(t){return new nr}source(t,r){return r()}};se.ref=function ru(e,t){let r=G.peek();if(!r)throw new Error("prism.ref() is called outside of a prism() call.");return r.ref(e,t)},se.effect=function ou(e,t,r){let o=G.peek();if(!o)throw new Error("prism.effect() is called outside of a prism() call.");return o.effect(e,t,r)},se.memo=oi,se.ensurePrism=function iu(){if(!G.peek())throw new Error("The parent function is called outside of a prism() call.")},se.state=function nu(e,t){let r=G.peek();if(!r)throw new Error("prism.state() is called outside of a prism() call.");return r.state(e,t)},se.scope=function au(e,t){let r=G.peek();if(!r)throw new Error("prism.scope() is called outside of a prism() call.");let o=r.sub(e);G.push(o);let n=or(t,void 0).value;return G.pop(),n},se.sub=function su(e,t,r){return oi(e,(()=>se(t)),r).getValue()},se.inPrism=function pu(){return!!G.peek()},se.source=function lu(e,t){let r=G.peek();if(!r)throw new Error("prism.source() is called outside of a prism() call.");return r.source(e,t)};var Ce,o,g=se;(o=Ce||(Ce={}))[o.Dict=0]="Dict",o[o.Array=1]="Array",o[o.Other=2]="Other";var go=e=>Array.isArray(e)?1:Vt(e)?0:2,ni=(e,t,r=go(e))=>0===r&&"string"==typeof t||1===r&&fu(t)?e[t]:void 0,fu=e=>{let t="number"==typeof e?e:parseInt(e,10);return!isNaN(t)&&t>=0&&t<1/0&&(0|t)===t},ir=class{constructor(t,r){this._parent=t,this._path=r,this.children=new Map,this.identityChangeListeners=new Set}addIdentityChangeListener(t){this.identityChangeListeners.add(t)}removeIdentityChangeListener(t){this.identityChangeListeners.delete(t),this._checkForGC()}removeChild(t){this.children.delete(t),this._checkForGC()}getChild(t){return this.children.get(t)}getOrCreateChild(t){let r=this.children.get(t);return r||(r=r=new ir(this,this._path.concat([t])),this.children.set(t,r)),r}_checkForGC(){this.identityChangeListeners.size>0||this.children.size>0||this._parent&&this._parent.removeChild(er(this._path))}},I=class{constructor(t){this.$$isPointerToPrismProvider=!0,this.pointer=ge({root:this,path:[]}),this.prism=this.pointerToPrism(this.pointer),this._onPointerValueChange=(t,r)=>{let{path:o}=Z(t),n=this._getOrCreateScopeForPath(o);return n.identityChangeListeners.add(r),()=>{n.identityChangeListeners.delete(r)}},this._currentState=t,this._rootScope=new ir(void 0,[])}set(t){let r=this._currentState;this._currentState=t,this._checkUpdates(this._rootScope,r,t)}get(){return this._currentState}getByPointer(t){let r=ae(t)?t:t(this.pointer),o=Z(r).path;return this._getIn(o)}_getIn(t){return 0===t.length?this.get():at(this.get(),t)}reduce(t){this.set(t(this.get()))}reduceByPointer(t,r){let o=ae(t)?t:t(this.pointer),n=Z(o).path,i=function ho(e,t,r){return 0===t.length?r(e):tr(e,t,r)}(this.get(),n,r);this.set(i)}setByPointer(t,r){this.reduceByPointer(t,(()=>r))}_checkUpdates(t,r,o){if(r===o)return;for(let a of t.identityChangeListeners)a(o);if(0===t.children.size)return;let n=go(r),i=go(o);if(2!==n||n!==i)for(let[a,s]of t.children){let l=ni(r,a,n),p=ni(o,a,i);this._checkUpdates(s,l,p)}}_getOrCreateScopeForPath(t){let r=this._rootScope;for(let o of t)r=r.getOrCreateChild(o);return r}pointerToPrism(t){let{path:r}=Z(t),o=i=>this._onPointerValueChange(t,i),n=()=>this._getIn(r);return g((()=>g.source(o,n)))}},ii=new WeakMap;var ke=e=>{let t=pt(e),r=ii.get(t);if(!r){let o=t.root;if(!function cu(e){return"object"==typeof e&&null!==e&&!0===e.$$isPointerToPrismProvider}(o))throw new Error("Cannot run pointerToPrism() on a pointer whose root is not an PointerToPrismProvider");r=o.pointerToPrism(e),ii.set(t,r)}return r},j=e=>ae(e)?ke(e).getValue():we(e)?e.getValue():e,ct=class{constructor(t){this._conf=t,this._ticking=!1,this._dormant=!0,this._numberOfDormantTicks=0,this.__ticks=0,this._scheduledForThisOrNextTick=new Set,this._scheduledForNextTick=new Set,this._timeAtCurrentTick=0}get dormant(){return this._dormant}onThisOrNextTick(t){this._scheduledForThisOrNextTick.add(t),this._dormant&&this._goActive()}onNextTick(t){this._scheduledForNextTick.add(t),this._dormant&&this._goActive()}offThisOrNextTick(t){this._scheduledForThisOrNextTick.delete(t)}offNextTick(t){this._scheduledForNextTick.delete(t)}get time(){return this._ticking?this._timeAtCurrentTick:performance.now()}_goActive(){var t,r;!this._dormant||(this._dormant=!1,null==(r=null==(t=this._conf)?void 0:t.onActive)||r.call(t))}_goDormant(){var t,r;this._dormant||(this._dormant=!0,this._numberOfDormantTicks=0,null==(r=null==(t=this._conf)?void 0:t.onDormant)||r.call(t))}tick(t=performance.now()){if(this.__ticks++,!this._dormant&&0===this._scheduledForNextTick.size&&0===this._scheduledForThisOrNextTick.size&&(this._numberOfDormantTicks++,this._numberOfDormantTicks>=180))this._goDormant();else{this._ticking=!0,this._timeAtCurrentTick=t;for(let r of this._scheduledForNextTick)this._scheduledForThisOrNextTick.add(r);this._scheduledForNextTick.clear(),this._tick(0),this._ticking=!1}}_tick(t){let r=this.time;if(t>10&&console.warn("_tick() recursing for 10 times"),t>100)throw new Error("Maximum recursion limit for _tick()");let o=this._scheduledForThisOrNextTick;this._scheduledForThisOrNextTick=new Set;for(let n of o)n(r);if(this._scheduledForThisOrNextTick.size>0)return this._tick(t+1)}},Fe=class{constructor(t){this.$$isPointerToPrismProvider=!0,this._currentPointerBox=new I(t),this.pointer=ge({root:this,path:[]})}setPointer(t){this._currentPointerBox.set(t)}pointerToPrism(t){let{path:r}=pt(t);return g((()=>{let o=this._currentPointerBox.prism.getValue(),n=r.reduce(((i,a)=>i[a]),o);return j(n)}))}},mu=new class{constructor(){d(this,"atom",new I({projects:{}}))}add(t,r){this.atom.setByPointer((o=>o.projects[t]),r)}get(t){return this.atom.get().projects[t]}has(t){return!!this.get(t)}remove(t){this.atom.setByPointer((r=>r.projects[t]),void 0)}},Ue=mu,si=new WeakMap;function T(e){return si.get(e)}function ue(e,t){si.set(e,t)}var ar=[];function sr(e,t){return 0===t.length?e:at(e,t)}var De=class{constructor(){d(this,"_values",{})}get(t,r){if(this.has(t))return this._values[t];{let o=r();return this._values[t]=o,o}}has(t){return this._values.hasOwnProperty(t)}},hu=function(){try{var e=K(Object,"defineProperty");return e({},"",{}),e}catch(t){}}(),yo=hu;var dt=function gu(e,t,r){"__proto__"==t&&yo?yo(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r},bu=Object.prototype.hasOwnProperty;var mt=function Pu(e,t,r){var o=e[t];(!bu.call(e,t)||!rt(o,r)||void 0===r&&!(t in e))&&dt(e,t,r)},_u=/^(?:0|[1-9]\d*)$/;var ht=function vu(e,t){var r=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==r||"symbol"!=r&&_u.test(e))&&e>-1&&e%1==0&&e<t};var pi=function Tu(e,t,r,o){if(!M(e))return e;for(var n=-1,i=(t=Oe(t,e)).length,a=i-1,s=e;null!=s&&++n<i;){var l=re(t[n]),p=r;if("__proto__"===l||"constructor"===l||"prototype"===l)return e;if(n!=a){var u=s[l];void 0===(p=o?o(u,l,s):void 0)&&(p=M(u)?u:ht(t[n+1])?[]:{})}mt(s,l,p),s=s[l]}return e};var li=function xu(e,t,r){return null==e?e:pi(e,t,r)},bo=new WeakMap;function jo(e){if(bo.has(e))return bo.get(e);let t="compound"===e.type?function Iu(e){let t={};for(let[r,o]of Object.entries(e.props))t[r]=jo(o);return t}(e):"enum"===e.type?function Su(e){let t={$case:e.defaultCase};for(let[r,o]of Object.entries(e.cases))t[r]=jo(o);return t}(e):e.default;return bo.set(e,t),t}var ci=Gt(fi());function _o(e,t,r){return g((()=>{let o=j(t);return g.memo("driver",(()=>o?"BasicKeyframedTrack"===o.type?function Ou(e,t,r){return g((()=>{let o=g.ref("state",{started:!1}),n=o.current,i=r.getValue();return(!n.started||i<n.validFrom||n.validTo<=i)&&(o.current=n=function wu(e,t,r){let o=t.getValue();if(0===r.keyframes.length)return{started:!0,validFrom:-1/0,validTo:1/0,der:di};let n=0;for(;;){let i=r.keyframes[n];if(!i)return qe.error;let a=n===r.keyframes.length-1;if(o<i.position)return 0===n?qe.beforeFirstKeyframe(i):qe.error;if(i.position===o)return a?qe.lastKeyframe(i):qe.between(i,r.keyframes[n+1],t);if(n===r.keyframes.length-1)return qe.lastKeyframe(i);{let s=n+1;if(r.keyframes[s].position<=o){n=s;continue}return qe.between(i,r.keyframes[n+1],t)}}}(0,r,t)),n.der.getValue()}))}(0,o,r):(e.logger.error("Track type not yet supported."),g((()=>{}))):g((()=>{}))),[o]).getValue()}))}var di=g((()=>{}));var qe={beforeFirstKeyframe:e=>({started:!0,validFrom:-1/0,validTo:e.position,der:g((()=>({left:e.value,progression:0})))}),lastKeyframe:e=>({started:!0,validFrom:e.position,validTo:1/0,der:g((()=>({left:e.value,progression:0})))}),between(e,t,r){if(!e.connectedRight)return{started:!0,validFrom:e.position,validTo:t.position,der:g((()=>({left:e.value,progression:0})))};let o=i=>(i-e.position)/(t.position-e.position);if(!e.type||"bezier"===e.type){let i=new ci.default(e.handles[2],e.handles[3],t.handles[0],t.handles[1]),a=g((()=>{let s=o(r.getValue()),l=i.solveSimple(s);return{left:e.value,right:t.value,progression:l}}));return{started:!0,validFrom:e.position,validTo:t.position,der:a}}let n=g((()=>{let i=o(r.getValue()),a=Math.floor(i);return{left:e.value,right:t.value,progression:a}}));return{started:!0,validFrom:e.position,validTo:t.position,der:n}},error:{started:!0,validFrom:-1/0,validTo:1/0,der:di}};function gt(e,t,r){let n=r.get(e);if(n&&n.override===t)return n.merged;let i=_({},e);for(let a of Object.keys(t)){let s=t[a],l=e[a];i[a]="object"==typeof s&&"object"==typeof l?gt(l,s,r):void 0===s?l:s}return r.set(e,{override:t,merged:i}),i}function ze(e,t){let r=e;for(let o of t)r=r[o];return r}var Cu=/\s/;var hi=function ku(e){for(var t=e.length;t--&&Cu.test(e.charAt(t)););return t},Du=/^\s+/;var gi=function Eu(e){return e&&e.slice(0,hi(e)+1).replace(Du,"")},Ru=/^[-+]0x[0-9a-f]+$/i,Vu=/^0b[01]+$/i,Nu=/^0o[0-7]+$/i,Lu=parseInt;var ye=function Mu(e){if("number"==typeof e)return e;if(Te(e))return NaN;if(M(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=M(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=gi(e);var r=Vu.test(e);return r||Nu.test(e)?Lu(e.slice(2),r?2:8):Ru.test(e)?NaN:+e};var Pi=function Bu(e){return e?Infinity===(e=ye(e))||-Infinity===e?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0};var pr=function Fu(e){var t=Pi(e),r=t%1;return t==t?r?t-r:t:0};var ji=function Uu(e){return e},lr=K(N,"WeakMap"),_i=Object.create,zu=function(){function e(){}return function(t){if(!M(t))return{};if(_i)return _i(t);e.prototype=t;var r=new e;return e.prototype=void 0,r}}(),vi=zu;var Ti=function Wu(e,t){var r=-1,o=e.length;for(t||(t=Array(o));++r<o;)t[r]=e[r];return t};var xi=function Ku(e,t){for(var r=-1,o=null==e?0:e.length;++r<o&&!1!==t(e[r],r,e););return e};var Ee=function Gu(e,t,r,o){var n=!r;r||(r={});for(var i=-1,a=t.length;++i<a;){var s=t[i],l=o?o(r[s],e[s],s,r,e):void 0;void 0===l&&(l=e[s]),n?dt(r,s,l):mt(r,s,l)}return r};var yt=function Ju(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991};var ur=function Yu(e){return null!=e&&yt(e.length)&&!Jt(e)},Xu=Object.prototype;var bt=function Zu(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Xu)};var Si=function Qu(e,t){for(var r=-1,o=Array(e);++r<e;)o[r]=t(r);return o};var vo=function tf(e){return B(e)&&"[object Arguments]"==X(e)},Ii=Object.prototype,rf=Ii.hasOwnProperty,of=Ii.propertyIsEnumerable,nf=vo(function(){return arguments}())?vo:function(e){return B(e)&&rf.call(e,"callee")&&!of.call(e,"callee")},fr=nf;var Ai=function af(){return!1},Oi="object"==typeof exports&&exports&&!exports.nodeType&&exports,wi=Oi&&"object"==typeof module&&module&&!module.nodeType&&module,Ci=wi&&wi.exports===Oi?N.Buffer:void 0,We=(Ci?Ci.isBuffer:void 0)||Ai,E={};E["[object Float32Array]"]=E["[object Float64Array]"]=E["[object Int8Array]"]=E["[object Int16Array]"]=E["[object Int32Array]"]=E["[object Uint8Array]"]=E["[object Uint8ClampedArray]"]=E["[object Uint16Array]"]=E["[object Uint32Array]"]=!0,E["[object Arguments]"]=E["[object Array]"]=E["[object ArrayBuffer]"]=E["[object Boolean]"]=E["[object DataView]"]=E["[object Date]"]=E["[object Error]"]=E["[object Function]"]=E["[object Map]"]=E["[object Number]"]=E["[object Object]"]=E["[object RegExp]"]=E["[object Set]"]=E["[object String]"]=E["[object WeakMap]"]=!1;var ki=function Rf(e){return B(e)&&yt(e.length)&&!!E[X(e)]};var Pt=function Vf(e){return function(t){return e(t)}},Di="object"==typeof exports&&exports&&!exports.nodeType&&exports,Nt=Di&&"object"==typeof module&&module&&!module.nodeType&&module,To=Nt&&Nt.exports===Di&&Ht.process,be=function(){try{return Nt&&Nt.require&&Nt.require("util").types||To&&To.binding&&To.binding("util")}catch(t){}}(),Ei=be&&be.isTypedArray,cr=Ei?Pt(Ei):ki,Bf=Object.prototype.hasOwnProperty;var dr=function Ff(e,t){var r=$(e),o=!r&&fr(e),n=!r&&!o&&We(e),i=!r&&!o&&!n&&cr(e),a=r||o||n||i,s=a?Si(e.length,String):[],l=s.length;for(var p in e)(t||Bf.call(e,p))&&(!a||!("length"==p||n&&("offset"==p||"parent"==p)||i&&("buffer"==p||"byteLength"==p||"byteOffset"==p)||ht(p,l)))&&s.push(p);return s},Ri=Qt(Object.keys,Object),zf=Object.prototype.hasOwnProperty;var Vi=function Wf(e){if(!bt(e))return Ri(e);var t=[];for(var r in Object(e))zf.call(e,r)&&"constructor"!=r&&t.push(r);return t};var fe=function Kf(e){return ur(e)?dr(e):Vi(e)};var Ni=function Gf(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t},Jf=Object.prototype.hasOwnProperty;var Li=function Yf(e){if(!M(e))return Ni(e);var t=bt(e),r=[];for(var o in e)"constructor"==o&&(t||!Jf.call(e,o))||r.push(o);return r};var jt=function Xf(e){return ur(e)?dr(e,!0):Li(e)};var mr=function Zf(e,t){for(var r=-1,o=t.length,n=e.length;++r<o;)e[n+r]=t[r];return e};var hr=function Qf(e,t,r){var o=-1,n=e.length;t<0&&(t=-t>n?0:n+t),(r=r>n?n:r)<0&&(r+=n),n=t>r?0:r-t>>>0,t>>>=0;for(var i=Array(n);++o<n;)i[o]=e[o+t];return i};var Mi=function ec(e,t,r){var o=e.length;return r=void 0===r?o:r,!t&&r>=o?e:hr(e,t,r)},pc=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");var _t=function lc(e){return pc.test(e)};var $i=function uc(e){return e.split("")},Bi="\\ud800-\\udfff",gc="["+Bi+"]",xo="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",So="\\ud83c[\\udffb-\\udfff]",Fi="[^"+Bi+"]",Ui="(?:\\ud83c[\\udde6-\\uddff]){2}",qi="[\\ud800-\\udbff][\\udc00-\\udfff]",zi="(?:"+xo+"|"+So+")"+"?",Wi="[\\ufe0e\\ufe0f]?",jc=Wi+zi+("(?:\\u200d(?:"+[Fi,Ui,qi].join("|")+")"+Wi+zi+")*"),_c="(?:"+[Fi+xo+"?",xo,Ui,qi,gc].join("|")+")",vc=RegExp(So+"(?="+So+")|"+_c+jc,"g");var Ki=function Tc(e){return e.match(vc)||[]};var Gi=function xc(e){return _t(e)?Ki(e):$i(e)};var Hi=function Sc(e,t,r){return e==e&&(void 0!==r&&(e=e<=r?e:r),void 0!==t&&(e=e>=t?e:t)),e};var Lt=function Ic(e,t,r){return void 0===r&&(r=t,t=void 0),void 0!==r&&(r=(r=ye(r))==r?r:0),void 0!==t&&(t=(t=ye(t))==t?t:0),Hi(ye(e),t,r)};var Ji=function Ac(){this.__data__=new Se,this.size=0};var Yi=function Oc(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r};var Xi=function wc(e){return this.__data__.get(e)};var Zi=function Cc(e){return this.__data__.has(e)};var Qi=function Dc(e,t){var r=this.__data__;if(r instanceof Se){var o=r.__data__;if(!Ie||o.length<199)return o.push([e,t]),this.size=++r.size,this;r=this.__data__=new Be(o)}return r.set(e,t),this.size=r.size,this};function vt(e){var t=this.__data__=new Se(e);this.size=t.size}vt.prototype.clear=Ji,vt.prototype.delete=Yi,vt.prototype.get=Xi,vt.prototype.has=Zi,vt.prototype.set=Qi;var Re=vt;var ea=function Ec(e,t){return e&&Ee(t,fe(t),e)};var ta=function Rc(e,t){return e&&Ee(t,jt(t),e)},ra="object"==typeof exports&&exports&&!exports.nodeType&&exports,oa=ra&&"object"==typeof module&&module&&!module.nodeType&&module,na=oa&&oa.exports===ra?N.Buffer:void 0,ia=na?na.allocUnsafe:void 0;var aa=function Nc(e,t){if(t)return e.slice();var r=e.length,o=ia?ia(r):new e.constructor(r);return e.copy(o),o};var sa=function Lc(e,t){for(var r=-1,o=null==e?0:e.length,n=0,i=[];++r<o;){var a=e[r];t(a,r,e)&&(i[n++]=a)}return i};var gr=function Mc(){return[]},Bc=Object.prototype.propertyIsEnumerable,pa=Object.getOwnPropertySymbols,Fc=pa?function(e){return null==e?[]:(e=Object(e),sa(pa(e),(function(t){return Bc.call(e,t)})))}:gr,Tt=Fc;var la=function Uc(e,t){return Ee(e,Tt(e),t)},zc=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)mr(t,Tt(e)),e=st(e);return t}:gr,yr=zc;var ua=function Wc(e,t){return Ee(e,yr(e),t)};var br=function Kc(e,t,r){var o=t(e);return $(e)?o:mr(o,r(e))};var Mt=function Gc(e){return br(e,fe,Tt)};var fa=function Hc(e){return br(e,jt,yr)},Pr=K(N,"DataView"),jr=K(N,"Promise"),_r=K(N,"Set"),ca="[object Map]",da="[object Promise]",ma="[object Set]",ha="[object WeakMap]",ga="[object DataView]",Qc=me(Pr),ed=me(Ie),td=me(jr),rd=me(_r),od=me(lr),Ke=X;(Pr&&Ke(new Pr(new ArrayBuffer(1)))!=ga||Ie&&Ke(new Ie)!=ca||jr&&Ke(jr.resolve())!=da||_r&&Ke(new _r)!=ma||lr&&Ke(new lr)!=ha)&&(Ke=function(e){var t=X(e),r="[object Object]"==t?e.constructor:void 0,o=r?me(r):"";if(o)switch(o){case Qc:return ga;case ed:return ca;case td:return da;case rd:return ma;case od:return ha}return t});var Pe=Ke,id=Object.prototype.hasOwnProperty;var ya=function ad(e){var t=e.length,r=new e.constructor(t);return t&&"string"==typeof e[0]&&id.call(e,"index")&&(r.index=e.index,r.input=e.input),r},xt=N.Uint8Array;var St=function pd(e){var t=new e.constructor(e.byteLength);return new xt(t).set(new xt(e)),t};var ba=function ld(e,t){var r=t?St(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)},ud=/\w*$/;var Pa=function fd(e){var t=new e.constructor(e.source,ud.exec(e));return t.lastIndex=e.lastIndex,t},ja=W?W.prototype:void 0,_a=ja?ja.valueOf:void 0;var va=function cd(e){return _a?Object(_a.call(e)):{}};var Ta=function dd(e,t){var r=t?St(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)};var xa=function Ed(e,t,r){var o=e.constructor;switch(t){case"[object ArrayBuffer]":return St(e);case"[object Boolean]":case"[object Date]":return new o(+e);case"[object DataView]":return ba(e,r);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return Ta(e,r);case"[object Map]":case"[object Set]":return new o;case"[object Number]":case"[object String]":return new o(e);case"[object RegExp]":return Pa(e);case"[object Symbol]":return va(e)}};var Sa=function Rd(e){return"function"!=typeof e.constructor||bt(e)?{}:vi(st(e))};var Ia=function Nd(e){return B(e)&&"[object Map]"==Pe(e)},Aa=be&&be.isMap,Oa=Aa?Pt(Aa):Ia;var wa=function $d(e){return B(e)&&"[object Set]"==Pe(e)},Ca=be&&be.isSet,ka=Ca?Pt(Ca):wa,Da="[object Arguments]",Ea="[object Function]",Ra="[object Object]",C={};C[Da]=C["[object Array]"]=C["[object ArrayBuffer]"]=C["[object DataView]"]=C["[object Boolean]"]=C["[object Date]"]=C["[object Float32Array]"]=C["[object Float64Array]"]=C["[object Int8Array]"]=C["[object Int16Array]"]=C["[object Int32Array]"]=C["[object Map]"]=C["[object Number]"]=C[Ra]=C["[object RegExp]"]=C["[object Set]"]=C["[object String]"]=C["[object Symbol]"]=C["[object Uint8Array]"]=C["[object Uint8ClampedArray]"]=C["[object Uint16Array]"]=C["[object Uint32Array]"]=!0,C["[object Error]"]=C[Ea]=C["[object WeakMap]"]=!1;var Va=function vr(e,t,r,o,n,i){var a,s=1&t,l=2&t,p=4&t;if(r&&(a=n?r(e,o,n,i):r(e)),void 0!==a)return a;if(!M(e))return e;var u=$(e);if(u){if(a=ya(e),!s)return Ti(e,a)}else{var c=Pe(e),m=c==Ea||"[object GeneratorFunction]"==c;if(We(e))return aa(e,s);if(c==Ra||c==Da||m&&!n){if(a=l||m?{}:Sa(e),!s)return l?ua(e,ta(a,e)):la(e,ea(a,e))}else{if(!C[c])return n?e:{};a=xa(e,c,s)}}i||(i=new Re);var f=i.get(e);if(f)return f;i.set(e,a),ka(e)?e.forEach((function(b){a.add(vr(b,t,r,b,e,i))})):Oa(e)&&e.forEach((function(b,P){a.set(P,vr(b,t,r,P,e,i))}));var v=u?void 0:(p?l?fa:Mt:l?jt:fe)(e);return xi(v||e,(function(b,P){v&&(b=e[P=b]),mt(a,P,vr(b,t,r,P,e,i))})),a};var Io=function hm(e){return Va(e,5)};var Na=function ym(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this};var La=function bm(e){return this.__data__.has(e)};function Tr(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new Be;++t<r;)this.add(e[t])}Tr.prototype.add=Tr.prototype.push=Na,Tr.prototype.has=La;var Ma=Tr;var $a=function Pm(e,t){for(var r=-1,o=null==e?0:e.length;++r<o;)if(t(e[r],r,e))return!0;return!1};var Ba=function jm(e,t){return e.has(t)};var xr=function Tm(e,t,r,o,n,i){var a=1&r,s=e.length,l=t.length;if(s!=l&&!(a&&l>s))return!1;var p=i.get(e),u=i.get(t);if(p&&u)return p==t&&u==e;var c=-1,m=!0,f=2&r?new Ma:void 0;for(i.set(e,t),i.set(t,e);++c<s;){var y=e[c],v=t[c];if(o)var b=a?o(v,y,c,t,e,i):o(y,v,c,e,t,i);if(void 0!==b){if(b)continue;m=!1;break}if(f){if(!$a(t,(function(P,x){if(!Ba(f,x)&&(y===P||n(y,P,r,o,i)))return f.push(x)}))){m=!1;break}}else if(y!==v&&!n(y,v,r,o,i)){m=!1;break}}return i.delete(e),i.delete(t),m};var Fa=function xm(e){var t=-1,r=Array(e.size);return e.forEach((function(o,n){r[++t]=[n,o]})),r};var Ua=function Sm(e){var t=-1,r=Array(e.size);return e.forEach((function(o){r[++t]=o})),r},qa=W?W.prototype:void 0,Ao=qa?qa.valueOf:void 0;var za=function $m(e,t,r,o,n,i,a){switch(r){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!i(new xt(e),new xt(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return rt(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var s=Fa;case"[object Set]":var l=1&o;if(s||(s=Ua),e.size!=t.size&&!l)return!1;var p=a.get(e);if(p)return p==t;o|=2,a.set(e,t);var u=xr(s(e),s(t),o,n,i,a);return a.delete(e),u;case"[object Symbol]":if(Ao)return Ao.call(e)==Ao.call(t)}return!1},Um=Object.prototype.hasOwnProperty;var Wa=function qm(e,t,r,o,n,i){var a=1&r,s=Mt(e),l=s.length;if(l!=Mt(t).length&&!a)return!1;for(var c=l;c--;){var m=s[c];if(!(a?m in t:Um.call(t,m)))return!1}var f=i.get(e),y=i.get(t);if(f&&y)return f==t&&y==e;var v=!0;i.set(e,t),i.set(t,e);for(var b=a;++c<l;){var P=e[m=s[c]],x=t[m];if(o)var O=a?o(x,P,m,t,e,i):o(P,x,m,e,t,i);if(!(void 0===O?P===x||n(P,x,r,o,i):O)){v=!1;break}b||(b="constructor"==m)}if(v&&!b){var U=e.constructor,q=t.constructor;U!=q&&"constructor"in e&&"constructor"in t&&!("function"==typeof U&&U instanceof U&&"function"==typeof q&&q instanceof q)&&(v=!1)}return i.delete(e),i.delete(t),v},Ka="[object Arguments]",Ga="[object Array]",Sr="[object Object]",Ha=Object.prototype.hasOwnProperty;var Ja=function Km(e,t,r,o,n,i){var a=$(e),s=$(t),l=a?Ga:Pe(e),p=s?Ga:Pe(t),u=(l=l==Ka?Sr:l)==Sr,c=(p=p==Ka?Sr:p)==Sr,m=l==p;if(m&&We(e)){if(!We(t))return!1;a=!0,u=!1}if(m&&!u)return i||(i=new Re),a||cr(e)?xr(e,t,r,o,n,i):za(e,t,l,r,o,n,i);if(!(1&r)){var f=u&&Ha.call(e,"__wrapped__"),y=c&&Ha.call(t,"__wrapped__");if(f||y){var v=f?e.value():e,b=y?t.value():t;return i||(i=new Re),n(v,b,r,o,i)}}return!!m&&(i||(i=new Re),Wa(e,t,r,o,n,i))};var Ir=function Ya(e,t,r,o,n){return e===t||(null==e||null==t||!B(e)&&!B(t)?e!=e&&t!=t:Ja(e,t,r,o,Ya,n))};var Xa=function Jm(e,t,r,o){var n=r.length,i=n,a=!o;if(null==e)return!i;for(e=Object(e);n--;){var s=r[n];if(a&&s[2]?s[1]!==e[s[0]]:!(s[0]in e))return!1}for(;++n<i;){var l=(s=r[n])[0],p=e[l],u=s[1];if(a&&s[2]){if(void 0===p&&!(l in e))return!1}else{var c=new Re;if(o)var m=o(p,u,l,e,t,c);if(!(void 0===m?Ir(u,p,3,o,c):m))return!1}}return!0};var Ar=function Ym(e){return e==e&&!M(e)};var Za=function Xm(e){for(var t=fe(e),r=t.length;r--;){var o=t[r],n=e[o];t[r]=[o,n,Ar(n)]}return t};var Or=function Zm(e,t){return function(r){return null!=r&&(r[e]===t&&(void 0!==t||e in Object(r)))}};var Qa=function Qm(e){var t=Za(e);return 1==t.length&&t[0][2]?Or(t[0][0],t[0][1]):function(r){return r===e||Xa(r,e,t)}};var es=function eh(e,t){return null!=e&&t in Object(e)};var ts=function th(e,t,r){for(var o=-1,n=(t=Oe(t,e)).length,i=!1;++o<n;){var a=re(t[o]);if(!(i=null!=e&&r(e,a)))break;e=e[a]}return i||++o!=n?i:!!(n=null==e?0:e.length)&&yt(n)&&ht(a,n)&&($(e)||fr(e))};var rs=function rh(e,t){return null!=e&&ts(e,t,es)};var os=function ih(e,t){return et(e)&&Ar(t)?Or(re(e),t):function(r){var o=at(r,e);return void 0===o&&o===t?rs(r,e):Ir(t,o,3)}};var wr=function ah(e){return function(t){return null==t?void 0:t[e]}};var ns=function sh(e){return function(t){return it(t,e)}};var is=function ph(e){return et(e)?wr(re(e)):ns(e)};var as=function lh(e){return"function"==typeof e?e:null==e?ji:"object"==typeof e?$(e)?os(e[0],e[1]):Qa(e):is(e)};var ss=function uh(e){return function(t,r,o){for(var n=-1,i=Object(t),a=o(t),s=a.length;s--;){var l=a[e?s:++n];if(!1===r(i[l],l,i))break}return t}},ps=ss();var ls=function ch(e,t){return e&&ps(e,t,fe)},Cr=function(){return N.Date.now()},hh=Math.max,gh=Math.min;var Oo=function yh(e,t,r){var o,n,i,a,s,l,p=0,u=!1,c=!1,m=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function f(A){var z=o,J=n;return o=n=void 0,p=A,a=e.apply(J,z)}function b(A){var z=A-l;return void 0===l||z>=t||z<0||c&&A-p>=i}function P(){var A=Cr();if(b(A))return x(A);s=setTimeout(P,function v(A){var le=t-(A-l);return c?gh(le,i-(A-p)):le}(A))}function x(A){return s=void 0,m&&o?f(A):(o=n=void 0,a)}function q(){var A=Cr(),z=b(A);if(o=arguments,n=this,l=A,z){if(void 0===s)return function y(A){return p=A,s=setTimeout(P,t),u?f(A):a}(l);if(c)return clearTimeout(s),s=setTimeout(P,t),f(l)}return void 0===s&&(s=setTimeout(P,t)),a}return t=ye(t)||0,M(r)&&(u=!!r.leading,i=(c="maxWait"in r)?hh(ye(r.maxWait)||0,t):i,m="trailing"in r?!!r.trailing:m),q.cancel=function O(){void 0!==s&&clearTimeout(s),p=0,o=l=n=s=void 0},q.flush=function U(){return void 0===s?a:x(Cr())},q};var us=function bh(e,t){return t.length<2?e:it(e,hr(t,0,-1))};var wo=function Ph(e){return"number"==typeof e&&e==pr(e)};var Co=function jh(e,t){var r={};return t=as(t,3),ls(e,(function(o,n,i){dt(r,n,t(o,n,i))})),r};var fs=function _h(e,t){return t=Oe(t,e),null==(e=us(e,t))||delete e[re(er(t))]},Th=Math.floor;var ko=function xh(e,t){var r="";if(!e||t<1||t>9007199254740991)return r;do{t%2&&(r+=e),(t=Th(t/2))&&(e+=e)}while(t);return r},cs=wr("length"),ds="\\ud800-\\udfff",kh="["+ds+"]",Do="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",Eo="\\ud83c[\\udffb-\\udfff]",ms="[^"+ds+"]",hs="(?:\\ud83c[\\udde6-\\uddff]){2}",gs="[\\ud800-\\udbff][\\udc00-\\udfff]",ys="(?:"+Do+"|"+Eo+")"+"?",bs="[\\ufe0e\\ufe0f]?",Vh=bs+ys+("(?:\\u200d(?:"+[ms,hs,gs].join("|")+")"+bs+ys+")*"),Nh="(?:"+[ms+Do+"?",Do,hs,gs,kh].join("|")+")",Ps=RegExp(Eo+"(?="+Eo+")|"+Nh+Vh,"g");var js=function Lh(e){for(var t=Ps.lastIndex=0;Ps.test(e);)++t;return t};var kr=function Mh(e){return _t(e)?js(e):cs(e)},$h=Math.ceil;var _s=function Bh(e,t){var r=(t=void 0===t?" ":Xt(t)).length;if(r<2)return r?ko(t,e):t;var o=ko(t,$h(e/kr(t)));return _t(t)?Mi(Gi(o),0,e).join(""):o.slice(0,e)};var Ge=function Fh(e,t,r){e=Zt(e);var o=(t=pr(t))?kr(e):0;return t&&o<t?_s(t-o,r)+e:e};var Dr=function Uh(e,t){return null==e||fs(e,t)},Er=class{constructor(t){d(this,"_cache",new De),d(this,"_keepHotUntapDebounce"),ue(this,t)}get type(){return"Theatre_SheetObject_PublicAPI"}get props(){return T(this).propsP}get sheet(){return T(this).sheet.publicApi}get project(){return T(this).sheet.project.publicApi}get address(){return _({},T(this).address)}_valuesPrism(){return this._cache.get("_valuesPrism",(()=>{let t=T(this);return g((()=>j(t.getValues().getValue())))}))}onValuesChange(t,r){return Rr(this._valuesPrism(),t,r)}get value(){let t=this._valuesPrism();if(!t.isHot){null!=this._keepHotUntapDebounce&&this._keepHotUntapDebounce.flush();let r=t.keepHot();this._keepHotUntapDebounce=Oo((()=>{r(),this._keepHotUntapDebounce=void 0}),5e3)}return this._keepHotUntapDebounce&&this._keepHotUntapDebounce(),t.getValue()}set initialValue(t){T(this).setInitialValue(t)}};function It(e){return"compound"===e.type||"enum"===e.type}function $t(e,t){if(!e)return;let[r,...o]=t;return void 0===r?e:It(e)?$t("enum"===e.type?e.cases[r]:e.props[r],o):void 0}function Ts(e){return!It(e)}var F,R,S,n,h,f,qh=function Ro(e){let t=new WeakMap;return r=>(t.has(r)||t.set(r,e(r)),t.get(r))}((e=>{if("enum"===e.type)throw new Error("Not implemented yet for enums");for(let t in e.props){let r=e.props[t];if(!It(r))return!0;if(qh(r))return!0}return!1})),Vr=class{constructor(t,r,o){this.sheet=t,this.template=r,this.nativeObject=o,d(this,"$$isPointerToPrismProvider",!0),d(this,"address"),d(this,"publicApi"),d(this,"_initialValue",new I({})),d(this,"_cache",new De),d(this,"_logger"),d(this,"_internalUtilCtx"),this._logger=t._logger.named("SheetObject",r.address.objectKey),this._logger._trace("creating object"),this._internalUtilCtx={logger:this._logger.utilFor.internal()},this.address=V(_({},r.address),{sheetInstanceId:t.address.sheetInstanceId}),this.publicApi=new Er(this)}get type(){return"Theatre_SheetObject"}getValues(){return this._cache.get("getValues()",(()=>g((()=>{let p,n=gt(j(this.template.getDefaultValues()),j(this._initialValue.pointer),g.memo("withInitialCache",(()=>new WeakMap),[])),l=gt(n,j(this.template.getStaticValues()),g.memo("withStatics",(()=>new WeakMap),[]));{let c=g.memo("seq",(()=>this.getSequencedValues()),[]),m=g.memo("withSeqsCache",(()=>new WeakMap),[]);p=j(j(c)),l=gt(l,p,m)}return((e,t)=>{let r=g.memo(e,(()=>new I(t)),[]);return r.set(t),r})("finalAtom",l).pointer}))))}getValueByPointer(t){let r=j(this.getValues()),{path:o}=Z(t);return j(ze(r,o))}pointerToPrism(t){let{path:r}=Z(t);return g((()=>{let o=j(this.getValues());return j(ze(o,r))}))}getSequencedValues(){return g((()=>{let t=g.memo("tracksToProcess",(()=>this.template.getArrayOfValidSequenceTracks()),[]),r=j(t),o=new I({}),n=j(this.template.configPointer);return g.effect("processTracks",(()=>{let i=[];for(let{trackId:a,pathToProp:s}of r){let l=this._trackIdToPrism(a),p=$t(n,s),u=p.deserializeAndSanitize,c=p.interpolate,m=()=>{let y=l.getValue();if(!y)return o.setByPointer((O=>ze(O,s)),void 0);let v=u(y.left),b=void 0===v?p.default:v;if(void 0===y.right)return o.setByPointer((O=>ze(O,s)),b);let P=u(y.right),x=void 0===P?p.default:P;return o.setByPointer((O=>ze(O,s)),c(b,x,y.progression))},f=l.onStale(m);m(),i.push(f)}return()=>{for(let a of i)a()}}),[n,...r]),o.pointer}))}_trackIdToPrism(t){let r=this.template.project.pointers.historic.sheetsById[this.address.sheetId].sequence.tracksByObject[this.address.objectKey].trackData[t],o=this.sheet.getSequence().positionPrism;return _o(this._internalUtilCtx,r,o)}get propsP(){return this._cache.get("propsP",(()=>ge({root:this,path:[]})))}validateValue(t,r){}setInitialValue(t){this.validateValue(this.propsP,t),this._initialValue.set(t)}};function k(e){return function(r,o){return e(r,o())}}!function(o){o[o.GENERAL=1]="GENERAL",o[o.TODO=2]="TODO",o[o.TROUBLESHOOTING=4]="TROUBLESHOOTING"}(F||(F={})),function(o){o[o.INTERNAL=8]="INTERNAL",o[o.DEV=16]="DEV",o[o.PUBLIC=32]="PUBLIC"}(R||(R={})),(n=S||(S={}))[n.TRACE=64]="TRACE",n[n.DEBUG=128]="DEBUG",n[n.WARN=256]="WARN",n[n.ERROR=512]="ERROR",(f=h||(h={}))[f.ERROR_PUBLIC=545]="ERROR_PUBLIC",f[f.ERROR_DEV=529]="ERROR_DEV",f[f._HMM=524]="_HMM",f[f._TODO=522]="_TODO",f[f._ERROR=521]="_ERROR",f[f.WARN_PUBLIC=289]="WARN_PUBLIC",f[f.WARN_DEV=273]="WARN_DEV",f[f._KAPOW=268]="_KAPOW",f[f._WARN=265]="_WARN",f[f.DEBUG_DEV=145]="DEBUG_DEV",f[f._DEBUG=137]="_DEBUG",f[f.TRACE_DEV=81]="TRACE_DEV",f[f._TRACE=73]="_TRACE";var Q={_hmm:ee(524),_todo:ee(522),_error:ee(521),errorDev:ee(529),errorPublic:ee(545),_kapow:ee(268),_warn:ee(265),warnDev:ee(273),warnPublic:ee(289),_debug:ee(137),debugDev:ee(145),_trace:ee(73),traceDev:ee(81)};function ee(e){return Object.freeze({audience:He(e,8)?"internal":He(e,16)?"dev":"public",category:He(e,4)?"troubleshooting":He(e,2)?"todo":"general",level:He(e,512)?512:He(e,256)?256:He(e,128)?128:64})}function He(e,t){return(e&t)===t}function D(e,t){return(32==(32&t)||(16==(16&t)?e.dev:8==(8&t)&&e.internal))&&e.min<=t}var je={loggingConsoleStyle:!0,loggerConsoleStyle:!0,includes:Object.freeze({internal:!1,dev:!1,min:256}),filtered:function(){},include:function(){return{}},create:null,creatExt:null,named(e,t,r){return this.create({names:[...e.names,{name:t,key:r}]})},style:{bold:void 0,italic:void 0,cssMemo:new Map([["",""]]),collapseOnRE:/[a-z- ]+/g,color:void 0,collapsed(e){if(e.length<5)return e;let t=e.replace(this.collapseOnRE,"");return this.cssMemo.has(t)||this.cssMemo.set(t,this.css(e)),t},css(e){var o,n,i,a;let t=this.cssMemo.get(e);if(t)return t;let r=`color:${null!=(n=null==(o=this.color)?void 0:o.call(this,e))?n:`hsl(${(e.charCodeAt(0)+e.charCodeAt(e.length-1))%360}, 100%, 60%)`}`;return(null==(i=this.bold)?void 0:i.test(e))&&(r+=";font-weight:600"),(null==(a=this.italic)?void 0:a.test(e))&&(r+=";font-style:italic"),this.cssMemo.set(e,r),r}}};function Bt(e=console,t={}){let r=V(_({},je),{includes:_({},je.includes)}),o={styled:Kh.bind(r,e),noStyle:Hh.bind(r,e)},n=Wh.bind(r);function i(){return r.loggingConsoleStyle&&r.loggerConsoleStyle?o.styled:o.noStyle}return r.create=i(),{configureLogger(a){var s;"console"===a?(r.loggerConsoleStyle=je.loggerConsoleStyle,r.create=i()):"console"===a.type?(r.loggerConsoleStyle=null!=(s=a.style)?s:je.loggerConsoleStyle,r.create=i()):"keyed"===a.type?(r.creatExt=l=>a.keyed(l.names),r.create=n):"named"===a.type&&(r.creatExt=zh.bind(null,a.named),r.create=n)},configureLogging(a){var s,l,p,u,c;r.includes.dev=null!=(s=a.dev)?s:je.includes.dev,r.includes.internal=null!=(l=a.internal)?l:je.includes.internal,r.includes.min=null!=(p=a.min)?p:je.includes.min,r.include=null!=(u=a.include)?u:je.include,r.loggingConsoleStyle=null!=(c=a.consoleStyle)?c:je.loggingConsoleStyle,r.create=i()},getLogger:()=>r.create({names:[]})}}function zh(e,t){let r=[];for(let{name:o,key:n}of t.names)r.push(null==n?o:`${o} (${n})`);return e(r)}function Wh(e){let t=_(_({},this.includes),this.include(e)),r=this.filtered,o=this.named.bind(this,e),n=this.creatExt(e),i=D(t,524),a=D(t,522),s=D(t,521),l=D(t,529),p=D(t,545),u=D(t,265),c=D(t,268),m=D(t,273),f=D(t,289),y=D(t,137),v=D(t,145),b=D(t,73),P=D(t,81),x=i?n.error.bind(n,Q._hmm):r.bind(e,524),O=a?n.error.bind(n,Q._todo):r.bind(e,522),U=s?n.error.bind(n,Q._error):r.bind(e,521),q=l?n.error.bind(n,Q.errorDev):r.bind(e,529),A=p?n.error.bind(n,Q.errorPublic):r.bind(e,545),z=c?n.warn.bind(n,Q._kapow):r.bind(e,268),J=u?n.warn.bind(n,Q._warn):r.bind(e,265),le=m?n.warn.bind(n,Q.warnDev):r.bind(e,273),Ve=f?n.warn.bind(n,Q.warnPublic):r.bind(e,273),Ne=y?n.debug.bind(n,Q._debug):r.bind(e,137),Le=v?n.debug.bind(n,Q.debugDev):r.bind(e,145),Me=b?n.trace.bind(n,Q._trace):r.bind(e,73),$e=P?n.trace.bind(n,Q.traceDev):r.bind(e,81),L={_hmm:x,_todo:O,_error:U,errorDev:q,errorPublic:A,_kapow:z,_warn:J,warnDev:le,warnPublic:Ve,_debug:Ne,debugDev:Le,_trace:Me,traceDev:$e,lazy:{_hmm:i?k(x):x,_todo:a?k(O):O,_error:s?k(U):U,errorDev:l?k(q):q,errorPublic:p?k(A):A,_kapow:c?k(z):z,_warn:u?k(J):J,warnDev:m?k(le):le,warnPublic:f?k(Ve):Ve,_debug:y?k(Ne):Ne,debugDev:v?k(Le):Le,_trace:b?k(Me):Me,traceDev:P?k($e):$e},named:o,utilFor:{internal:()=>({debug:L._debug,error:L._error,warn:L._warn,trace:L._trace,named:(Y,w)=>L.named(Y,w).utilFor.internal()}),dev:()=>({debug:L.debugDev,error:L.errorDev,warn:L.warnDev,trace:L.traceDev,named:(Y,w)=>L.named(Y,w).utilFor.dev()}),public:()=>({error:L.errorPublic,warn:L.warnPublic,debug(Y,w){L._warn(`(public "debug" filtered out) ${Y}`,w)},trace(Y,w){L._warn(`(public "trace" filtered out) ${Y}`,w)},named:(Y,w)=>L.named(Y,w).utilFor.public()})}};return L}function Kh(e,t){let r=_(_({},this.includes),this.include(t)),o=[],n="";for(let l=0;l<t.names.length;l++){let{name:p,key:u}=t.names[l];if(n+=` %c${p}`,o.push(this.style.css(p)),null!=u){let c=`%c#${u}`;n+=c,o.push(this.style.css(c))}}let i=this.filtered,a=this.named.bind(this,t),s=[n,...o];return xs(i,t,r,e,s,function Gh(e){let t=e.slice(0);for(let r=1;r<t.length;r++)t[r]+=";background-color:#e0005a;padding:2px;color:white";return t}(s),a)}function Hh(e,t){let r=_(_({},this.includes),this.include(t)),o="";for(let s=0;s<t.names.length;s++){let{name:l,key:p}=t.names[s];o+=` ${l}`,null!=p&&(o+=`#${p}`)}let a=[o];return xs(this.filtered,t,r,e,a,a,this.named.bind(this,t))}function xs(e,t,r,o,n,i,a){let s=D(r,524),l=D(r,522),p=D(r,521),u=D(r,529),c=D(r,545),m=D(r,265),f=D(r,268),y=D(r,273),v=D(r,289),b=D(r,137),P=D(r,145),x=D(r,73),O=D(r,81),U=s?o.error.bind(o,...n):e.bind(t,524),q=l?o.error.bind(o,...n):e.bind(t,522),A=p?o.error.bind(o,...n):e.bind(t,521),z=u?o.error.bind(o,...n):e.bind(t,529),J=c?o.error.bind(o,...n):e.bind(t,545),le=f?o.warn.bind(o,...i):e.bind(t,268),Ve=m?o.warn.bind(o,...n):e.bind(t,265),Ne=y?o.warn.bind(o,...n):e.bind(t,273),Le=v?o.warn.bind(o,...n):e.bind(t,273),Me=b?o.info.bind(o,...n):e.bind(t,137),$e=P?o.info.bind(o,...n):e.bind(t,145),L=x?o.debug.bind(o,...n):e.bind(t,73),Y=O?o.debug.bind(o,...n):e.bind(t,81),w={_hmm:U,_todo:q,_error:A,errorDev:z,errorPublic:J,_kapow:le,_warn:Ve,warnDev:Ne,warnPublic:Le,_debug:Me,debugDev:$e,_trace:L,traceDev:Y,lazy:{_hmm:s?k(U):U,_todo:l?k(q):q,_error:p?k(A):A,errorDev:u?k(z):z,errorPublic:c?k(J):J,_kapow:f?k(le):le,_warn:m?k(Ve):Ve,warnDev:y?k(Ne):Ne,warnPublic:v?k(Le):Le,_debug:b?k(Me):Me,debugDev:P?k($e):$e,_trace:x?k(L):L,traceDev:O?k(Y):Y},named:a,utilFor:{internal:()=>({debug:w._debug,error:w._error,warn:w._warn,trace:w._trace,named:(ce,de)=>w.named(ce,de).utilFor.internal()}),dev:()=>({debug:w.debugDev,error:w.errorDev,warn:w.warnDev,trace:w.traceDev,named:(ce,de)=>w.named(ce,de).utilFor.dev()}),public:()=>({error:w.errorPublic,warn:w.warnPublic,debug(ce,de){w._warn(`(public "debug" filtered out) ${ce}`,de)},trace(ce,de){w._warn(`(public "trace" filtered out) ${ce}`,de)},named:(ce,de)=>w.named(ce,de).utilFor.public()})}};return w}var Ss=Bt(console,{_debug:function(){},_error:function(){}});Ss.configureLogging({dev:!0,min:S.TRACE});var At=Ss.getLogger().named("Theatre.js (default logger)").utilFor.dev(),Is=new WeakMap;function As(e,t,r){for(let[o,n]of Object.entries(t.props))if(!It(n)){let i=[...e,o];r.set(JSON.stringify(i),r.size),Os(i,n,r)}for(let[o,n]of Object.entries(t.props))if(It(n)){let i=[...e,o];r.set(JSON.stringify(i),r.size),Os(i,n,r)}}function Os(e,t,r){if("compound"===t.type)As(e,t,r);else{if("enum"===t.type)throw new Error("Enums aren't supported yet");r.set(JSON.stringify(e),r.size)}}function ws(e){return"object"==typeof e&&null!==e&&0===Object.keys(e).length}var Nr=class{constructor(t,r,o,n,i){this.sheetTemplate=t,d(this,"address"),d(this,"type","Theatre_SheetObjectTemplate"),d(this,"_config"),d(this,"_temp_actions_atom"),d(this,"_cache",new De),d(this,"project"),d(this,"pointerToSheetState"),d(this,"pointerToStaticOverrides"),this.address=V(_({},t.address),{objectKey:r}),this._config=new I(n),this._temp_actions_atom=new I(i),this.project=t.project,this.pointerToSheetState=this.sheetTemplate.project.pointers.historic.sheetsById[this.address.sheetId],this.pointerToStaticOverrides=this.pointerToSheetState.staticOverrides.byObject[this.address.objectKey]}get staticConfig(){return this._config.get()}get configPointer(){return this._config.pointer}get _temp_actions(){return this._temp_actions_atom.get()}get _temp_actionsPointer(){return this._temp_actions_atom.pointer}createInstance(t,r,o){return this._config.set(o),new Vr(t,this,r)}reconfigure(t){this._config.set(t)}_temp_setActions(t){this._temp_actions_atom.set(t)}getDefaultValues(){return this._cache.get("getDefaultValues()",(()=>g((()=>function Po(e){return jo(e)}(j(this.configPointer))))))}getStaticValues(){return this._cache.get("getStaticValues",(()=>g((()=>{var n;let t=null!=(n=j(this.pointerToStaticOverrides))?n:{};return j(this.configPointer).deserializeAndSanitize(t)||{}}))))}getArrayOfValidSequenceTracks(){return this._cache.get("getArrayOfValidSequenceTracks",(()=>g((()=>{let t=this.project.pointers.historic.sheetsById[this.address.sheetId],r=j(t.sequence.tracksByObject[this.address.objectKey].trackIdByPropPath);if(!r)return ar;let o=[];if(!r)return ar;let n=j(this.configPointer),i=Object.entries(r);for(let[s,l]of i){let p=Jh(s);if(!p)continue;let u=$t(n,p);!u||!Ts(u)||o.push({pathToProp:p,trackId:l})}let a=function Vo(e){let t=Is.get(e);if(t)return t;let r=new Map;return Is.set(e,r),As([],e,r),r}(n);return o.sort(((s,l)=>{let p=s.pathToProp,u=l.pathToProp;return a.get(JSON.stringify(p))>a.get(JSON.stringify(u))?1:-1})),0===o.length?ar:o}))))}getMapOfValidSequenceTracks_forStudio(){return this._cache.get("getMapOfValidSequenceTracks_forStudio",(()=>g((()=>{let t=j(this.getArrayOfValidSequenceTracks()),r={};for(let{pathToProp:o,trackId:n}of t)li(r,o,n);return r}))))}getStaticButNotSequencedOverrides(){return this._cache.get("getStaticButNotSequencedOverrides",(()=>g((()=>{let t=j(this.getStaticValues()),r=j(this.getArrayOfValidSequenceTracks()),o=Io(t);for(let{pathToProp:n}of r){Dr(o,n);let i=n.slice(0,-1);for(;i.length>0;){if(!ws(sr(o,i)))break;Dr(o,i),i=i.slice(0,-1)}}if(!ws(o))return o}))))}getDefaultsAtPointer(t){let{path:r}=Z(t);return sr(this.getDefaultValues().getValue(),r)}};function Jh(e){try{return JSON.parse(e)}catch(t){return void At.warn(`property ${JSON.stringify(e)} cannot be parsed. Skipping.`)}}Gt(Rs());var Vs=class extends Error{},oe=class extends Vs{};function ne(){let e,t,r=new Promise(((n,i)=>{e=a=>{n(a),o.status="resolved"},t=a=>{i(a),o.status="rejected"}})),o={resolve:e,reject:t,promise:r,status:"pending"};return o}var Ot=()=>{},Mr=class{constructor(){d(this,"_stopPlayCallback",Ot),d(this,"_state",new I({position:0,playing:!1})),d(this,"statePointer"),this.statePointer=this._state.pointer}destroy(){}pause(){this._stopPlayCallback(),this.playing=!1,this._stopPlayCallback=Ot}gotoPosition(t){this._updatePositionInState(t)}_updatePositionInState(t){this._state.setByPointer((r=>r.position),t)}getCurrentPosition(){return this._state.get().position}get playing(){return this._state.get().playing}set playing(t){this._state.setByPointer((r=>r.playing),t)}play(t,r,o,n,i){this.playing&&this.pause(),this.playing=!0;let a=r[1]-r[0];{let f=this.getCurrentPosition();f<r[0]||f>r[1]?"normal"===n||"alternate"===n?this._updatePositionInState(r[0]):("reverse"===n||"alternateReverse"===n)&&this._updatePositionInState(r[1]):"normal"===n||"alternate"===n?f===r[1]&&this._updatePositionInState(r[0]):f===r[0]&&this._updatePositionInState(r[1])}let s=ne(),l=i.time,p=a*t,u=this.getCurrentPosition()-r[0];("reverse"===n||"alternateReverse"===n)&&(u=r[1]-this.getCurrentPosition());let c=f=>{let v=Math.max(f-l,0)/1e3,b=Math.min(v*o+u,p);if(b!==p){let P=Math.floor(b/a),x=b/a%1*a;if("normal"!==n)if("reverse"===n)x=a-x;else{let O=P%2==0;"alternate"===n?O||(x=a-x):O&&(x=a-x)}this._updatePositionInState(x+r[0]),m()}else{if("normal"===n)this._updatePositionInState(r[1]);else if("reverse"===n)this._updatePositionInState(r[0]);else{let P=(t-1)%2==0;"alternate"===n?P?this._updatePositionInState(r[1]):this._updatePositionInState(r[0]):P?this._updatePositionInState(r[0]):this._updatePositionInState(r[1])}this.playing=!1,s.resolve(!0)}};this._stopPlayCallback=()=>{i.offThisOrNextTick(c),i.offNextTick(c),this.playing&&s.resolve(!1)};let m=()=>i.onNextTick(c);return i.onThisOrNextTick(c),s.promise}playDynamicRange(t,r){this.playing&&this.pause(),this.playing=!0;let o=ne(),n=t.keepHot();o.promise.then(n,n);let i=r.time,a=l=>{let p=Math.max(l-i,0);i=l;let u=p/1e3,c=this.getCurrentPosition(),m=t.getValue();if(c<m[0]||c>m[1])this.gotoPosition(m[0]);else{let f=c+u;f>m[1]&&(f=m[0]+(f-m[1])),this.gotoPosition(f)}s()};this._stopPlayCallback=()=>{r.offThisOrNextTick(a),r.offNextTick(a),o.resolve(!1)};let s=()=>r.onNextTick(a);return r.onThisOrNextTick(a),o.promise}},$r="__TheatreJS_CoreBundle",Br=e=>(...t)=>{var r;switch(e){case"success":case"info":At.debug(t.slice(0,2).join("\n"));break;case"warning":At.warn(t.slice(0,2).join("\n"))}return"undefined"!=typeof window?null==(r=window.__TheatreJS_Notifications)?void 0:r.notify[e](...t):void 0},pe={warning:Br("warning"),success:Br("success"),info:Br("info"),error:Br("error")};"undefined"!=typeof window&&(window.addEventListener("error",(e=>{pe.error("An error occurred",`<pre>${e.message}</pre>\n\nSee **console** for details.`)})),window.addEventListener("unhandledrejection",(e=>{pe.error("An error occurred",`<pre>${e.reason}</pre>\n\nSee **console** for details.`)})));var Ur,Fr=class{constructor(t,r,o){this._decodedBuffer=t,this._audioContext=r,this._nodeDestination=o,d(this,"_mainGain"),d(this,"_state",new I({position:0,playing:!1})),d(this,"statePointer"),d(this,"_stopPlayCallback",Ot),this.statePointer=this._state.pointer,this._mainGain=this._audioContext.createGain(),this._mainGain.connect(this._nodeDestination)}playDynamicRange(t,r){let o=ne();this._playing&&this.pause(),this._playing=!0;let n,i=()=>{null==n||n(),n=this._loopInRange(t.getValue(),r).stop},a=t.onStale(i);return i(),this._stopPlayCallback=()=>{null==n||n(),a(),o.resolve(!1)},o.promise}_loopInRange(t,r){let n=this.getCurrentPosition(),i=t[1]-t[0];(n<t[0]||n>t[1]||n===t[1])&&this._updatePositionInState(t[0]),n=this.getCurrentPosition();let a=this._audioContext.createBufferSource();a.buffer=this._decodedBuffer,a.connect(this._mainGain),a.playbackRate.value=1,a.loop=!0,a.loopStart=t[0],a.loopEnd=t[1];let s=r.time,l=n-t[0];a.start(0,n);let p=m=>{let b=(Math.max(m-s,0)/1e3*1+l)/i%1*i;this._updatePositionInState(b+t[0]),u()},u=()=>r.onNextTick(p);return r.onThisOrNextTick(p),{stop:()=>{a.stop(),a.disconnect(),r.offThisOrNextTick(p),r.offNextTick(p)}}}get _playing(){return this._state.get().playing}set _playing(t){this._state.setByPointer((r=>r.playing),t)}destroy(){}pause(){this._stopPlayCallback(),this._playing=!1,this._stopPlayCallback=Ot}gotoPosition(t){this._updatePositionInState(t)}_updatePositionInState(t){this._state.reduce((r=>V(_({},r),{position:t})))}getCurrentPosition(){return this._state.get().position}play(t,r,o,n,i){this._playing&&this.pause(),this._playing=!0;let a=this.getCurrentPosition(),s=r[1]-r[0];if("normal"!==n)throw new oe(`Audio-controlled sequences can only be played in the "normal" direction. '${n}' given.`);(a<r[0]||a>r[1]||a===r[1])&&this._updatePositionInState(r[0]),a=this.getCurrentPosition();let l=ne(),p=this._audioContext.createBufferSource();p.buffer=this._decodedBuffer,p.connect(this._mainGain),p.playbackRate.value=o,t>1e3&&(pe.warning("Can't play sequences with audio more than 1000 times",`The sequence will still play, but only 1000 times. The \`iterationCount: ${t}\` provided to \`sequence.play()\`\nis too high for a sequence with audio.\n\nTo fix this, either set \`iterationCount\` to a lower value, or remove the audio from the sequence.`,[{url:"https://www.theatrejs.com/docs/latest/manual/audio",title:"Using Audio"},{url:"https://www.theatrejs.com/docs/latest/api/core#sequence.attachaudio",title:"Audio API"}]),t=1e3),t>1&&(p.loop=!0,p.loopStart=r[0],p.loopEnd=r[1]);let u=i.time,c=a-r[0],m=s*t;p.start(0,a,m-c);let f=b=>{let x=Math.max(b-u,0)/1e3,O=Math.min(x*o+c,m);if(O!==m){let U=O/s%1*s;this._updatePositionInState(U+r[0]),v()}else this._updatePositionInState(r[1]),this._playing=!1,y(),l.resolve(!0)},y=()=>{p.stop(),p.disconnect()};this._stopPlayCallback=()=>{y(),i.offThisOrNextTick(f),i.offNextTick(f),this._playing&&l.resolve(!1)};let v=()=>i.onNextTick(f);return i.onThisOrNextTick(f),l.promise}},Ms=0;function Ft(e){var i;let r=new ct({onActive(){var a;null==(a=null==e?void 0:e.start)||a.call(e)},onDormant(){var a;null==(a=null==e?void 0:e.stop)||a.call(e)}}),o={tick:a=>{r.tick(a)},id:Ms++,name:null!=(i=null==e?void 0:e.name)?i:`CustomRafDriver-${Ms}`,type:"Theatre_RafDriver_PublicAPI"};return ue(o,{type:"Theatre_RafDriver_PrivateAPI",publicApi:o,ticker:r,start:null==e?void 0:e.start,stop:null==e?void 0:e.stop}),o}function Lo(){return Ur||zr(function eg(){let e=null,o=Ft({name:"DefaultCoreRafDriver",start:()=>{if("undefined"!=typeof window){let n=i=>{o.tick(i),e=window.requestAnimationFrame(n)};e=window.requestAnimationFrame(n)}else o.tick(0),setTimeout((()=>o.tick(1)),0)},stop:()=>{"undefined"!=typeof window&&null!==e&&window.cancelAnimationFrame(e)}});return o}()),Ur}function qr(){return Lo().ticker}function zr(e){if(Ur)throw new Error("`setCoreRafDriver()` is already called.");Ur=T(e)}var Wr=class{get type(){return"Theatre_Sequence_PublicAPI"}constructor(t){ue(this,t)}play(t){let r=T(this);if(r._project.isReady()){let o=(null==t?void 0:t.rafDriver)?T(t.rafDriver).ticker:qr();return r.play(null!=t?t:{},o)}{let o=ne();return o.resolve(!0),o.promise}}pause(){T(this).pause()}get position(){return T(this).position}set position(t){T(this).position=t}async attachAudio(t){let{audioContext:r,destinationNode:o,decodedBuffer:n,gainNode:i}=await async function tg(e){function t(){if(e.audioContext)return Promise.resolve(e.audioContext);let p=new AudioContext;return"running"===p.state||"undefined"==typeof window?Promise.resolve(p):new Promise((u=>{let c=()=>{p.resume()},m=["mousedown","keydown","touchstart"],f={capture:!0,passive:!1};m.forEach((y=>{window.addEventListener(y,c,f)})),p.addEventListener("statechange",(()=>{"running"===p.state&&(m.forEach((y=>{window.removeEventListener(y,c,f)})),u(p))}))}))}async function r(){if(e.source instanceof AudioBuffer)return e.source;let u,c,f,p=ne();if("string"!=typeof e.source)throw new Error("Error validating arguments to sequence.attachAudio(). args.source must either be a string or an instance of AudioBuffer.");try{u=await fetch(e.source)}catch(y){throw console.error(y),new Error(`Could not fetch '${e.source}'. Network error logged above.`)}try{c=await u.arrayBuffer()}catch(y){throw console.error(y),new Error(`Could not read '${e.source}' as an arrayBuffer.`)}(await o).decodeAudioData(c,p.resolve,p.reject);try{f=await p.promise}catch(y){throw console.error(y),new Error(`Could not decode ${e.source} as an audio file.`)}return f}let o=t(),n=r(),[i,a]=await Promise.all([o,n]),s=e.destinationNode||i.destination,l=i.createGain();return l.connect(s),{audioContext:i,decodedBuffer:a,gainNode:l,destinationNode:s}}(t),a=new Fr(n,r,i);return T(this).replacePlaybackController(a),{audioContext:r,destinationNode:o,decodedBuffer:n,gainNode:i}}get pointer(){return T(this).pointer}};var Kr=class{constructor(t,r,o,n,i){this._project=t,this._sheet=r,this._lengthD=o,this._subUnitsPerUnitD=n,d(this,"address"),d(this,"publicApi"),d(this,"_playbackControllerBox"),d(this,"_prismOfStatePointer"),d(this,"_positionD"),d(this,"_positionFormatterD"),d(this,"_playableRangeD"),d(this,"pointer",ge({root:this,path:[]})),d(this,"$$isPointerToPrismProvider",!0),d(this,"_logger"),d(this,"closestGridPosition",(t=>{let o=1/this.subUnitsPerUnit;return parseFloat((Math.round(t/o)*o).toFixed(3))})),this._logger=t._logger.named("Sheet",r.address.sheetId).named("Instance",r.address.sheetInstanceId),this.address=V(_({},this._sheet.address),{sequenceName:"default"}),this.publicApi=new Wr(this),this._playbackControllerBox=new I(null!=i?i:new Mr),this._prismOfStatePointer=g((()=>this._playbackControllerBox.prism.getValue().statePointer)),this._positionD=g((()=>{let a=this._prismOfStatePointer.getValue();return j(a.position)})),this._positionFormatterD=g((()=>{let a=j(this._subUnitsPerUnitD);return new $s(a)}))}pointerToPrism(t){let{path:r}=Z(t);if(0===r.length)return g((()=>({length:j(this.pointer.length),playing:j(this.pointer.playing),position:j(this.pointer.position)})));if(r.length>1)return g((()=>{}));let[o]=r;return"length"===o?this._lengthD:"position"===o?this._positionD:g("playing"===o?()=>j(this._prismOfStatePointer.getValue().playing):()=>{})}get positionFormatter(){return this._positionFormatterD.getValue()}get prismOfStatePointer(){return this._prismOfStatePointer}get length(){return this._lengthD.getValue()}get positionPrism(){return this._positionD}get position(){return this._playbackControllerBox.get().getCurrentPosition()}get subUnitsPerUnit(){return this._subUnitsPerUnitD.getValue()}get positionSnappedToGrid(){return this.closestGridPosition(this.position)}set position(t){let r=t;this.pause(),r>this.length&&(r=this.length);let o=this.length;this._playbackControllerBox.get().gotoPosition(r>o?o:r)}getDurationCold(){return this._lengthD.getValue()}get playing(){return j(this._playbackControllerBox.get().statePointer.playing)}_makeRangeFromSequenceTemplate(){return g((()=>[0,j(this._lengthD)]))}playDynamicRange(t,r){return this._playbackControllerBox.get().playDynamicRange(t,r)}async play(t,r){let o=this.length,n=t&&t.range?t.range:[0,o],i=t&&"number"==typeof t.iterationCount?t.iterationCount:1,a=t&&void 0!==t.rate?t.rate:1,s=t&&t.direction?t.direction:"normal";return await this._play(i,[n[0],n[1]],a,s,r)}_play(t,r,o,n,i){return this._playbackControllerBox.get().play(t,r,o,n,i)}pause(){this._playbackControllerBox.get().pause()}replacePlaybackController(t){this.pause();let r=this._playbackControllerBox.get();this._playbackControllerBox.set(t);let o=r.getCurrentPosition();r.destroy(),t.gotoPosition(o)}},$s=class{constructor(t){this._fps=t}formatSubUnitForGrid(t){let r=t%1,o=1/this._fps;return Math.round(r/o)+"f"}formatFullUnitForGrid(t){let r=t,o="";r>=wt&&(o+=Math.floor(r/wt)+"h",r%=wt),r>=Ye&&(o+=Math.floor(r/Ye)+"m",r%=Ye),r>=Je&&(o+=Math.floor(r/Je)+"s",r%=Je);let n=1/this._fps;return r>=n&&(o+=Math.floor(r/n)+"f",r%=n),0===o.length?"0s":o}formatForPlayhead(t){let r=t,o="";if(r>=wt){let i=Math.floor(r/wt);o+=Ge(i.toString(),2,"0")+"h",r%=wt}if(r>=Ye){let i=Math.floor(r/Ye);o+=Ge(i.toString(),2,"0")+"m",r%=Ye}else o.length>0&&(o+="00m");if(r>=Je){let i=Math.floor(r/Je);o+=Ge(i.toString(),2,"0")+"s",r%=Je}else o+="00s";let n=1/this._fps;if(r>=n){let i=Math.round(r/n);o+=Ge(i.toString(),2,"0")+"f",r%=n}else r/n>.98?(o+=Ge(1..toString(),2,"0")+"f",r%=n):o+="00f";return 0===o.length?"00s00f":o}formatBasic(t){return t.toFixed(2)+"s"}},Je=1,Ye=60*Je,wt=60*Ye,Yr={};function Gr(e,t){return e.length<=t?e:e.substr(0,t-3)+"..."}uo(Yr,{boolean:()=>Fo,compound:()=>Ut,image:()=>sg,number:()=>Bo,rgba:()=>cg,string:()=>Uo,stringLiteral:()=>yg});var Ct=e=>"string"==typeof e?`string("${Gr(e,10)}")`:"number"==typeof e?`number(${Gr(String(e),10)})`:null===e?"null":void 0===e?"undefined":"boolean"==typeof e?String(e):Array.isArray(e)?"array":"object"==typeof e?"object":"unknown";function Hr(e){return V(_({},e),{toString(){return function og(e,{removeAlphaIfOpaque:t=!1}={}){let r=(255*e.a|256).toString(16).slice(1);return`#${(255*e.r|256).toString(16).slice(1)+(255*e.g|256).toString(16).slice(1)+(255*e.b|256).toString(16).slice(1)+(t&&"ff"===r?"":r)}`}(this,{removeAlphaIfOpaque:!0})}})}function Bs(e){function t(r){return r>=.0031308?1.055*r**(1/2.4)-.055:12.92*r}return function ng(e){return Object.fromEntries(Object.entries(e).map((([t,r])=>[t,Lt(r,0,1)])))}({r:t(e.r),g:t(e.g),b:t(e.b),a:e.a})}function Mo(e){function t(r){return r>=.04045?((r+.055)/1.055)**2.4:r/12.92}return{r:t(e.r),g:t(e.g),b:t(e.b),a:e.a}}function $o(e){let t=.4122214708*e.r+.5363325363*e.g+.0514459929*e.b,r=.2119034982*e.r+.6806995451*e.g+.1073969566*e.b,o=.0883024619*e.r+.2817188376*e.g+.6299787005*e.b,n=Math.cbrt(t),i=Math.cbrt(r),a=Math.cbrt(o);return{L:.2104542553*n+.793617785*i-.0040720468*a,a:1.9779984951*n-2.428592205*i+.4505937099*a,b:.0259040371*n+.7827717662*i-.808675766*a,alpha:e.a}}var _e=Symbol("TheatrePropType_Basic");function Us(e){return"object"==typeof e&&!!e&&"TheatrePropType"===e[_e]}function ig(e){if("number"==typeof e)return Bo(e);if("boolean"==typeof e)return Fo(e);if("string"==typeof e)return Uo(e);if("object"==typeof e&&e){if(Us(e))return e;if(Vt(e))return Ut(e);throw new oe(`This value is not a valid prop type: ${Ct(e)}`)}throw new oe(`This value is not a valid prop type: ${Ct(e)}`)}var Ut=(e,t={})=>{let r=function qs(e){let t={};for(let r of Object.keys(e)){let o=e[r];Us(o)?t[r]=o:t[r]=ig(o)}return t}(e),o=new WeakMap;return{type:"compound",props:r,valueType:null,[_e]:"TheatrePropType",label:t.label,default:Co(r,(i=>i.default)),deserializeAndSanitize:i=>{if("object"!=typeof i||!i)return;if(o.has(i))return o.get(i);let a={},s=!1;for(let[l,p]of Object.entries(r))if(Object.prototype.hasOwnProperty.call(i,l)){let u=p.deserializeAndSanitize(i[l]);null!=u&&(s=!0,a[l]=u)}return o.set(i,a),s?a:void 0}}},sg=(e,t={})=>({type:"image",default:{type:"image",id:e},valueType:null,[_e]:"TheatrePropType",label:t.label,interpolate:(o,n,i)=>{var s;return{type:"image",id:(null!=(s=t.interpolate)?s:Jr)(o.id,n.id,i)}},deserializeAndSanitize:pg}),pg=e=>{if(!e)return;let t=!0;return"string"!=typeof e.id&&![null,void 0].includes(e.id)&&(t=!1),"image"!==e.type&&(t=!1),t?e:void 0},Bo=(e,t={})=>{var r;return V(_({type:"number",valueType:0,default:e,[_e]:"TheatrePropType"},t||{}),{label:t.label,nudgeFn:null!=(r=t.nudgeFn)?r:bg,nudgeMultiplier:"number"==typeof t.nudgeMultiplier?t.nudgeMultiplier:void 0,interpolate:fg,deserializeAndSanitize:lg(t.range)})},lg=e=>e?t=>{if("number"==typeof t&&isFinite(t))return Lt(t,e[0],e[1])}:ug,ug=e=>"number"==typeof e&&isFinite(e)?e:void 0,fg=(e,t,r)=>e+r*(t-e),cg=(e={r:0,g:0,b:0,a:1},t={})=>{let r={};for(let o of["r","g","b","a"])r[o]=Math.min(Math.max(e[o],0),1);return{type:"rgba",valueType:null,default:Hr(r),[_e]:"TheatrePropType",label:t.label,interpolate:mg,deserializeAndSanitize:dg}},dg=e=>{if(!e)return;let t=!0;for(let o of["r","g","b","a"])(!Object.prototype.hasOwnProperty.call(e,o)||"number"!=typeof e[o])&&(t=!1);if(!t)return;let r={};for(let o of["r","g","b","a"])r[o]=Math.min(Math.max(e[o],0),1);return Hr(r)},mg=(e,t,r)=>{let o=$o(Mo(e)),n=$o(Mo(t)),a=Bs(function Fs(e){let t=e.L+.3963377774*e.a+.2158037573*e.b,r=e.L-.1055613458*e.a-.0638541728*e.b,o=e.L-.0894841775*e.a-1.291485548*e.b,n=t*t*t,i=r*r*r,a=o*o*o;return{r:4.0767416621*n-3.3077115913*i+.2309699292*a,g:-1.2684380046*n+2.6097574011*i-.3413193965*a,b:-.0041960863*n-.7034186147*i+1.707614701*a,a:e.alpha}}({L:(1-r)*o.L+r*n.L,a:(1-r)*o.a+r*n.a,b:(1-r)*o.b+r*n.b,alpha:(1-r)*o.alpha+r*n.alpha}));return Hr(a)},Fo=(e,t={})=>{var r;return{type:"boolean",default:e,valueType:null,[_e]:"TheatrePropType",label:t.label,interpolate:null!=(r=t.interpolate)?r:Jr,deserializeAndSanitize:hg}},hg=e=>"boolean"==typeof e?e:void 0;function Jr(e){return e}var Uo=(e,t={})=>{var r;return{type:"string",default:e,valueType:null,[_e]:"TheatrePropType",label:t.label,interpolate:null!=(r=t.interpolate)?r:Jr,deserializeAndSanitize:gg}};function gg(e){return"string"==typeof e?e:void 0}function yg(e,t,r={}){var o,n;return{type:"stringLiteral",default:e,valuesAndLabels:_({},t),[_e]:"TheatrePropType",valueType:null,as:null!=(o=r.as)?o:"menu",label:r.label,interpolate:null!=(n=r.interpolate)?n:Jr,deserializeAndSanitize(i){if("string"==typeof i&&Object.prototype.hasOwnProperty.call(t,i))return i}}}var bg=({config:e,deltaX:t,deltaFraction:r,magnitude:o})=>{var i;let{range:n}=e;return e.nudgeMultiplier||!n||n.includes(1/0)||n.includes(-1/0)?t*o*(null!=(i=e.nudgeMultiplier)?i:1):r*(n[1]-n[0])*o};function qt(e,t){let r=(e=>e.replace(/^[\s\/]*/,"").replace(/[\s\/]*$/,"").replace(/\s*\/\s*/g," / "))(e);return r}Gt(qo()),new WeakMap;var Xr=class{get type(){return"Theatre_Sheet_PublicAPI"}constructor(t){ue(this,t)}object(t,r,o){let n=T(this),i=qt(t),a=n.getObject(i),l=null==o?void 0:o.__actions__THIS_API_IS_UNSTABLE_AND_WILL_CHANGE_IN_THE_NEXT_VERSION;if(a)return l&&a.template._temp_setActions(l),a.publicApi;{let p=Ut(r);return n.createObject(i,null,p,l).publicApi}}get sequence(){return T(this).getSequence().publicApi}get project(){return T(this).project.publicApi}get address(){return _({},T(this).address)}detachObject(t){let r=T(this),o=qt(t);if(!r.getObject(o))return pe.warning(`Couldn't delete object "${o}"`,`There is no object with key "${o}".\n\nTo fix this, make sure you are calling \`sheet.deleteObject("${o}")\` with the correct key.`),void console.warn(`Object key "${o}" does not exist.`);r.deleteObject(o)}},Zr=class{constructor(t,r){this.template=t,this.instanceId=r,d(this,"_objects",new I({})),d(this,"_sequence"),d(this,"address"),d(this,"publicApi"),d(this,"project"),d(this,"objectsP",this._objects.pointer),d(this,"type","Theatre_Sheet"),d(this,"_logger"),this._logger=t.project._logger.named("Sheet",r),this._logger._trace("creating sheet"),this.project=t.project,this.address=V(_({},t.address),{sheetInstanceId:this.instanceId}),this.publicApi=new Xr(this)}createObject(t,r,o,n={}){let a=this.template.getObjectTemplate(t,r,o,n).createInstance(this,r,o);return this._objects.setByPointer((s=>s[t]),a),a}getObject(t){return this._objects.get()[t]}deleteObject(t){this._objects.reduce((r=>{let o=_({},r);return delete o[t],o}))}getSequence(){if(!this._sequence){let t=g((()=>{let o=j(this.project.pointers.historic.sheetsById[this.address.sheetId].sequence.length);return _g(o)})),r=g((()=>{let o=j(this.project.pointers.historic.sheetsById[this.address.sheetId].sequence.subUnitsPerUnit);return vg(o)}));this._sequence=new Kr(this.template.project,this,t,r)}return this._sequence}},_g=e=>"number"==typeof e&&isFinite(e)&&e>0?e:10,vg=e=>"number"==typeof e&&wo(e)&&e>=1&&e<=1e3?e:30,Qr=class{constructor(t,r){this.project=t,d(this,"type","Theatre_SheetTemplate"),d(this,"address"),d(this,"_instances",new I({})),d(this,"instancesP",this._instances.pointer),d(this,"_objectTemplates",new I({})),d(this,"objectTemplatesP",this._objectTemplates.pointer),this.address=V(_({},t.address),{sheetId:r})}getInstance(t){let r=this._instances.get()[t];return r||(r=new Zr(this,t),this._instances.setByPointer((o=>o[t]),r)),r}getObjectTemplate(t,r,o,n){let i=this._objectTemplates.get()[t];return i||(i=new Nr(this,t,r,o,n),this._objectTemplates.setByPointer((a=>a[t]),i)),i}},Ws=e=>new Promise((t=>setTimeout(t,e)));function ie(e){for(var t=arguments.length,r=Array(t>1?t-1:0),o=1;o<t;o++)r[o-1]=arguments[o];throw Error("[Immer] minified error nr: "+e+(r.length?" "+r.map((function(a){return"'"+a+"'"})).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function Xe(e){return!!e&&!!e[H]}function Ze(e){return!!e&&(function(t){if(!t||"object"!=typeof t)return!1;var r=Object.getPrototypeOf(t);if(null===r)return!0;var o=Object.hasOwnProperty.call(r,"constructor")&&r.constructor;return o===Object||"function"==typeof o&&Function.toString.call(o)===kg}(e)||Array.isArray(e)||!!e[rp]||!!e.constructor[rp]||Wo(e)||Ko(e))}function zt(e,t,r){void 0===r&&(r=!1),0===kt(e)?(r?Object.keys:nn)(e).forEach((function(o){r&&"symbol"==typeof o||t(o,e[o],e)})):e.forEach((function(o,n){return t(n,o,e)}))}function kt(e){var t=e[H];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:Wo(e)?2:Ko(e)?3:0}function zo(e,t){return 2===kt(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function Gs(e,t,r){var o=kt(e);2===o?e.set(t,r):3===o?(e.delete(t),e.add(r)):e[t]=r}function Wo(e){return wg&&e instanceof Map}function Ko(e){return Cg&&e instanceof Set}function Qe(e){return e.o||e.t}function Go(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=Dg(e);delete t[H];for(var r=nn(t),o=0;o<r.length;o++){var n=r[o],i=t[n];!1===i.writable&&(i.writable=!0,i.configurable=!0),(i.get||i.set)&&(t[n]={configurable:!0,writable:!0,enumerable:i.enumerable,value:e[n]})}return Object.create(Object.getPrototypeOf(e),t)}function Ho(e,t){return void 0===t&&(t=!1),Jo(e)||Xe(e)||!Ze(e)||(kt(e)>1&&(e.set=e.add=e.clear=e.delete=Ig),Object.freeze(e),t&&zt(e,(function(r,o){return Ho(o,!0)}),!0)),e}function Ig(){ie(2)}function Jo(e){return null==e||"object"!=typeof e||Object.isFrozen(e)}function ve(e){var t=Eg[e];return t||ie(18,e),t}function Hs(){return Wt}function Yo(e,t){t&&(ve("Patches"),e.u=[],e.s=[],e.v=t)}function eo(e){Xo(e),e.p.forEach(Ag),e.p=null}function Xo(e){e===Wt&&(Wt=e.l)}function Js(e){return Wt={p:[],l:Wt,h:e,m:!0,_:0}}function Ag(e){var t=e[H];0===t.i||1===t.i?t.j():t.O=!0}function Zo(e,t){t._=t.p.length;var r=t.p[0],o=void 0!==e&&e!==r;return t.h.g||ve("ES5").S(t,e,o),o?(r[H].P&&(eo(t),ie(4)),Ze(e)&&(e=to(t,e),t.l||ro(t,e)),t.u&&ve("Patches").M(r[H],e,t.u,t.s)):e=to(t,r,[]),eo(t),t.u&&t.v(t.u,t.s),e!==tp?e:void 0}function to(e,t,r){if(Jo(t))return t;var o=t[H];if(!o)return zt(t,(function(i,a){return Ys(e,o,t,i,a,r)}),!0),t;if(o.A!==e)return t;if(!o.P)return ro(e,o.t,!0),o.t;if(!o.I){o.I=!0,o.A._--;var n=4===o.i||5===o.i?o.o=Go(o.k):o.o;zt(3===o.i?new Set(n):n,(function(i,a){return Ys(e,o,n,i,a,r)})),ro(e,n,!1),r&&e.u&&ve("Patches").R(o,r,e.u,e.s)}return o.o}function Ys(e,t,r,o,n,i){if(Xe(n)){var a=to(e,n,i&&t&&3!==t.i&&!zo(t.D,o)?i.concat(o):void 0);if(Gs(r,o,a),!Xe(a))return;e.m=!1}if(Ze(n)&&!Jo(n)){if(!e.h.F&&e._<1)return;to(e,n),t&&t.A.l||ro(e,n)}}function ro(e,t,r){void 0===r&&(r=!1),e.h.F&&e.m&&Ho(t,r)}function Qo(e,t){var r=e[H];return(r?Qe(r):e)[t]}function Xs(e,t){if(t in e)for(var r=Object.getPrototypeOf(e);r;){var o=Object.getOwnPropertyDescriptor(r,t);if(o)return o;r=Object.getPrototypeOf(r)}}function en(e){e.P||(e.P=!0,e.l&&en(e.l))}function tn(e){e.o||(e.o=Go(e.t))}function rn(e,t,r){var o=Wo(t)?ve("MapSet").N(t,r):Ko(t)?ve("MapSet").T(t,r):e.g?function(n,i){var a=Array.isArray(n),s={i:a?1:0,A:i?i.A:Hs(),P:!1,I:!1,D:{},l:i,t:n,k:null,o:null,j:null,C:!1},l=s,p=oo;a&&(l=[s],p=no);var u=Proxy.revocable(l,p),c=u.revoke,m=u.proxy;return s.k=m,s.j=c,m}(t,r):ve("ES5").J(t,r);return(r?r.A:Hs()).p.push(o),o}function Og(e){return Xe(e)||ie(22,e),function t(r){if(!Ze(r))return r;var o,n=r[H],i=kt(r);if(n){if(!n.P&&(n.i<4||!ve("ES5").K(n)))return n.t;n.I=!0,o=Zs(r,i),n.I=!1}else o=Zs(r,i);return zt(o,(function(a,s){n&&function xg(e,t){return 2===kt(e)?e.get(t):e[t]}(n.t,a)===s||Gs(o,a,t(s))})),3===i?new Set(o):o}(e)}function Zs(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return Go(e)}var Qs,Wt,on="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),wg="undefined"!=typeof Map,Cg="undefined"!=typeof Set,ep="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,tp=on?Symbol.for("immer-nothing"):((Qs={})["immer-nothing"]=!0,Qs),rp=on?Symbol.for("immer-draftable"):"__$immer_draftable",H=on?Symbol.for("immer-state"):"__$immer_state",kg=("undefined"!=typeof Symbol&&Symbol.iterator,""+Object.prototype.constructor),nn="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,Dg=Object.getOwnPropertyDescriptors||function(e){var t={};return nn(e).forEach((function(r){t[r]=Object.getOwnPropertyDescriptor(e,r)})),t},Eg={},oo={get:function(e,t){if(t===H)return e;var r=Qe(e);if(!zo(r,t))return function(n,i,a){var s,l=Xs(i,a);return l?"value"in l?l.value:null===(s=l.get)||void 0===s?void 0:s.call(n.k):void 0}(e,r,t);var o=r[t];return e.I||!Ze(o)?o:o===Qo(e.t,t)?(tn(e),e.o[t]=rn(e.A.h,o,e)):o},has:function(e,t){return t in Qe(e)},ownKeys:function(e){return Reflect.ownKeys(Qe(e))},set:function(e,t,r){var o=Xs(Qe(e),t);if(null==o?void 0:o.set)return o.set.call(e.k,r),!0;if(!e.P){var n=Qo(Qe(e),t),i=null==n?void 0:n[H];if(i&&i.t===r)return e.o[t]=r,e.D[t]=!1,!0;if(function Sg(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}(r,n)&&(void 0!==r||zo(e.t,t)))return!0;tn(e),en(e)}return e.o[t]===r&&"number"!=typeof r&&(void 0!==r||t in e.o)||(e.o[t]=r,e.D[t]=!0,!0)},deleteProperty:function(e,t){return void 0!==Qo(e.t,t)||t in e.t?(e.D[t]=!1,tn(e),en(e)):delete e.D[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var r=Qe(e),o=Reflect.getOwnPropertyDescriptor(r,t);return o&&{writable:!0,configurable:1!==e.i||"length"!==t,enumerable:o.enumerable,value:r[t]}},defineProperty:function(){ie(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){ie(12)}},no={};zt(oo,(function(e,t){no[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}})),no.deleteProperty=function(e,t){return oo.deleteProperty.call(this,e[0],t)},no.set=function(e,t,r){return oo.set.call(this,e[0],t,r,e[0])};var Rg=function(){function e(r){var o=this;this.g=ep,this.F=!0,this.produce=function(n,i,a){if("function"==typeof n&&"function"!=typeof i){var s=i;i=n;var l=o;return function(f){var y=this;void 0===f&&(f=s);for(var v=arguments.length,b=Array(v>1?v-1:0),P=1;P<v;P++)b[P-1]=arguments[P];return l.produce(f,(function(x){var O;return(O=i).call.apply(O,[y,x].concat(b))}))}}var p;if("function"!=typeof i&&ie(6),void 0!==a&&"function"!=typeof a&&ie(7),Ze(n)){var u=Js(o),c=rn(o,n,void 0),m=!0;try{p=i(c),m=!1}finally{m?eo(u):Xo(u)}return"undefined"!=typeof Promise&&p instanceof Promise?p.then((function(f){return Yo(u,a),Zo(f,u)}),(function(f){throw eo(u),f})):(Yo(u,a),Zo(p,u))}if(!n||"object"!=typeof n)return(p=i(n))===tp?void 0:(void 0===p&&(p=n),o.F&&Ho(p,!0),p);ie(21,n)},this.produceWithPatches=function(n,i){return"function"==typeof n?function(l){for(var p=arguments.length,u=Array(p>1?p-1:0),c=1;c<p;c++)u[c-1]=arguments[c];return o.produceWithPatches(l,(function(m){return n.apply(void 0,[m].concat(u))}))}:[o.produce(n,i,(function(l,p){a=l,s=p})),a,s];var a,s},"boolean"==typeof(null==r?void 0:r.useProxies)&&this.setUseProxies(r.useProxies),"boolean"==typeof(null==r?void 0:r.autoFreeze)&&this.setAutoFreeze(r.autoFreeze)}var t=e.prototype;return t.createDraft=function(r){Ze(r)||ie(8),Xe(r)&&(r=Og(r));var o=Js(this),n=rn(this,r,void 0);return n[H].C=!0,Xo(o),n},t.finishDraft=function(r,o){var i=(r&&r[H]).A;return Yo(i,o),Zo(void 0,i)},t.setAutoFreeze=function(r){this.F=r},t.setUseProxies=function(r){r&&!ep&&ie(20),this.g=r},t.applyPatches=function(r,o){var n;for(n=o.length-1;n>=0;n--){var i=o[n];if(0===i.path.length&&"replace"===i.op){r=i.value;break}}var a=ve("Patches").$;return Xe(r)?a(r,o):this.produce(r,(function(s){return a(s,o.slice(n+1))}))},e}(),te=new Rg,Dt=(te.produce,te.produceWithPatches.bind(te),te.setAutoFreeze.bind(te),te.setUseProxies.bind(te),te.applyPatches.bind(te),te.createDraft.bind(te),te.finishDraft.bind(te),{currentProjectStateDefinitionVersion:"0.4.0"});async function an(e,t,r){await Ws(0),e.transaction((({drafts:o})=>{var u;let n=t.address.projectId;o.ephemeral.coreByProject[n]={lastExportedObject:null,loadingState:{type:"loading"}},o.ahistoric.coreByProject[n]={ahistoricStuff:""};let p=null==(u=function Ks(e){return Xe(e)||ie(23,e),e[H].t}(o.historic))?void 0:u.coreByProject[t.address.projectId];p?r&&-1==p.revisionHistory.indexOf(r.revisionHistory[0])?function l(c){o.ephemeral.coreByProject[n].loadingState={type:"browserStateIsNotBasedOnDiskState",onDiskState:c}}(r):function s(){o.ephemeral.coreByProject[n].loadingState={type:"loaded"}}():r?function a(c){o.ephemeral.coreByProject[n].loadingState={type:"loaded"},o.historic.coreByProject[n]=c}(r):function i(){o.ephemeral.coreByProject[n].loadingState={type:"loaded"},o.historic.coreByProject[n]={sheetsById:{},definitionVersion:Dt.currentProjectStateDefinitionVersion,revisionHistory:[]}}()}))}function op(){}function io(e){var i,a;let t=(null==(i=null==e?void 0:e.logging)?void 0:i.internal)?null!=(a=e.logging.min)?a:S.WARN:1/0,r=t<=S.DEBUG,o=t<=S.ERROR,n=Bt(void 0,{_debug:r?console.debug.bind(console,"_coreLogger(TheatreInternalLogger) debug"):op,_error:o?console.error.bind(console,"_coreLogger(TheatreInternalLogger) error"):op});if(e){let{logger:s,logging:l}=e;s&&n.configureLogger(s),l?n.configureLogging(l):n.configureLogging({dev:!1})}return n.getLogger().named("Theatre")}var ao=class{constructor(t,r={},o){var i;this.config=r,this.publicApi=o,d(this,"pointers"),d(this,"_pointerProxies"),d(this,"address"),d(this,"_studioReadyDeferred"),d(this,"_assetStorageReadyDeferred"),d(this,"_readyPromise"),d(this,"_sheetTemplates",new I({})),d(this,"sheetTemplatesP",this._sheetTemplates.pointer),d(this,"_studio"),d(this,"assetStorage"),d(this,"type","Theatre_Project"),d(this,"_logger"),this._logger=io({logging:{dev:!0}}).named("Project",t),this._logger.traceDev("creating project"),this.address={projectId:t};let n=new I({ahistoric:{ahistoricStuff:""},historic:null!=(i=r.state)?i:{sheetsById:{},definitionVersion:Dt.currentProjectStateDefinitionVersion,revisionHistory:[]},ephemeral:{loadingState:{type:"loaded"},lastExportedObject:null}});this._assetStorageReadyDeferred=ne(),this.assetStorage={getAssetUrl:a=>{var s;return`${null==(s=r.assets)?void 0:s.baseUrl}/${a}`},createAsset:()=>{throw new Error("Please wait for Project.ready to use assets.")}},this._pointerProxies={historic:new Fe(n.pointer.historic),ahistoric:new Fe(n.pointer.ahistoric),ephemeral:new Fe(n.pointer.ephemeral)},this.pointers={historic:this._pointerProxies.historic.pointer,ahistoric:this._pointerProxies.ahistoric.pointer,ephemeral:this._pointerProxies.ephemeral.pointer},Ue.add(t,this),this._studioReadyDeferred=ne(),this._readyPromise=Promise.all([this._studioReadyDeferred.promise,this._assetStorageReadyDeferred.promise]).then((()=>{})),r.state?setTimeout((()=>{this._studio||(this._studioReadyDeferred.resolve(void 0),this._assetStorageReadyDeferred.resolve(void 0),this._logger._trace("ready deferred resolved with no state"))}),0):"undefined"==typeof window?console.error(`Argument config.state in Theatre.getProject("${t}", config) is empty. You can safely ignore this message if you're developing a Next.js/Remix project in development mode. But if you are shipping to your end-users, then you need to set config.state, otherwise your project's state will be empty and nothing will animate. Learn more at https://www.theatrejs.com/docs/latest/manual/projects#state`):setTimeout((()=>{if(!this._studio)throw new Error(`Argument config.state in Theatre.getProject("${t}", config) is empty. This is fine while you are using @theatre/core along with @theatre/studio. But since @theatre/studio is not loaded, the state of project "${t}" will be empty.\n\nTo fix this, you need to add @theatre/studio into the bundle and export the project's state. Learn how to do that at https://www.theatrejs.com/docs/latest/manual/projects#state\n`)}),1e3)}attachToStudio(t){if(this._studio){if(this._studio!==t)throw new Error(`Project ${this.address.projectId} is already attached to studio ${this._studio.address.studioId}`);console.warn(`Project ${this.address.projectId} is already attached to studio ${this._studio.address.studioId}`)}else this._studio=t,t.initialized.then((async()=>{var r;await an(t,this,this.config.state),this._pointerProxies.historic.setPointer(t.atomP.historic.coreByProject[this.address.projectId]),this._pointerProxies.ahistoric.setPointer(t.atomP.ahistoric.coreByProject[this.address.projectId]),this._pointerProxies.ephemeral.setPointer(t.atomP.ephemeral.coreByProject[this.address.projectId]),t.createAssetStorage(this,null==(r=this.config.assets)?void 0:r.baseUrl).then((o=>{this.assetStorage=o,this._assetStorageReadyDeferred.resolve(void 0)})),this._studioReadyDeferred.resolve(void 0)}))}get isAttachedToStudio(){return!!this._studio}get ready(){return this._readyPromise}isReady(){return"resolved"===this._studioReadyDeferred.status&&"resolved"===this._assetStorageReadyDeferred.status}getOrCreateSheet(t,r="default"){let o=this._sheetTemplates.get()[t];return o||(o=new Qr(this,t),this._sheetTemplates.reduce((n=>V(_({},n),{[t]:o})))),o.getInstance(r)}destroy(){this._studio?console.warn(`Project ${this.address.projectId} is attached to studio ${this._studio.address.studioId} so will not be destroyed`):Ue.remove(this.address.projectId)}},so=class{get type(){return"Theatre_Project_PublicAPI"}constructor(t,r={}){ue(this,new ao(t,r,this))}get ready(){return T(this).ready}get isReady(){return T(this).isReady()}get address(){return _({},T(this).address)}getAssetUrl(t){if(this.isReady)return t.id?T(this).assetStorage.getAssetUrl(t.id):void 0;console.error("Calling `project.getAssetUrl()` before `project.ready` is resolved, will always return `undefined`. Either use `project.ready.then(() => project.getAssetUrl())` or `await project.ready` before calling `project.getAssetUrl()`.")}sheet(t,r="default"){let o=qt(t);return T(this).getOrCreateSheet(o,r).publicApi}destroy(){T(this).destroy()}};Gt(qo());function np(e,t={}){let r=Ue.get(e);if(r)return r.publicApi;let n=io().named("Project",e);return t.state?(Lg(e,t.state),n._debug("deep validated config.state on disk")):n._debug("no config.state"),new so(e,t)}var Lg=(e,t)=>{((e,t)=>{if(Array.isArray(t)||null==t||t.definitionVersion!==Dt.currentProjectStateDefinitionVersion)throw new oe(`Error validating conf.state in Theatre.getProject(${JSON.stringify(e)}, conf). The state seems to be formatted in a way that is unreadable to Theatre.js. Read more at https://www.theatrejs.com/docs/latest/manual/projects#state`)})(e,t)};function Rr(e,t,r){let o=r?T(r).ticker:qr();if(ae(e))return ke(e).onChange(o,t,!0);if(we(e))return e.onChange(o,t,!0);throw new Error("Called onChange(p) where p is neither a pointer nor a prism.")}function ip(e){if(ae(e))return ke(e).getValue();throw new Error("Called val(p) where p is not a pointer.")}var po=class{constructor(){d(this,"_studio")}get type(){return"Theatre_CoreBundle"}get version(){return"0.6.1-dev.5"}getBitsForStudio(t,r){if(this._studio)throw new Error("@theatre/core is already attached to @theatre/studio");this._studio=t,r({projectsP:Ue.atom.pointer.projects,privateAPI:T,coreExports:sn,getCoreRafDriver:Lo})}};!function Mg(){if("undefined"==typeof window)return;let e=window[$r];if(void 0!==e)throw"object"==typeof e&&e&&"string"==typeof e.version?new Error("It seems that the module '@theatre/core' is loaded more than once. This could have two possible causes:\n1. You might have two separate versions of Theatre.js in node_modules.\n2. Or this might be a bundling misconfiguration, in case you're using a bundler like Webpack/ESBuild/Rollup.\n\nNote that it **is okay** to import '@theatre/core' multiple times. But those imports should point to the same module."):new Error(`The variable window.${$r} seems to be already set by a module other than @theatre/core.`);let t=new po;window[$r]=t;let r=window.__TheatreJS_StudioBundle;r&&null!==r&&"Theatre_StudioBundle"===r.type&&r.registerCoreBundle(t)}(),window.Theatre={core:pn,get studio(){alert("Theatre.studio is only available in the core-and-studio.js bundle. You're using the core-only.min.js bundle.")}}})(),Hydra.ready((()=>{TweenManager.Transforms=["scale","scaleX","scaleY","x","y","z","rotation","rotationX","rotationY","rotationZ","skewX","skewY","perspective"],TweenManager.CubicEases=[{name:"easeOutCubic",curve:"cubic-bezier(0.215, 0.610, 0.355, 1.000)"},{name:"easeOutQuad",curve:"cubic-bezier(0.250, 0.460, 0.450, 0.940)"},{name:"easeOutQuart",curve:"cubic-bezier(0.165, 0.840, 0.440, 1.000)"},{name:"easeOutQuint",curve:"cubic-bezier(0.230, 1.000, 0.320, 1.000)"},{name:"easeOutSine",curve:"cubic-bezier(0.390, 0.575, 0.565, 1.000)"},{name:"easeOutExpo",curve:"cubic-bezier(0.190, 1.000, 0.220, 1.000)"},{name:"easeOutCirc",curve:"cubic-bezier(0.075, 0.820, 0.165, 1.000)"},{name:"easeOutBack",curve:"cubic-bezier(0.175, 0.885, 0.320, 1.275)"},{name:"easeInCubic",curve:"cubic-bezier(0.550, 0.055, 0.675, 0.190)"},{name:"easeInQuad",curve:"cubic-bezier(0.550, 0.085, 0.680, 0.530)"},{name:"easeInQuart",curve:"cubic-bezier(0.895, 0.030, 0.685, 0.220)"},{name:"easeInQuint",curve:"cubic-bezier(0.755, 0.050, 0.855, 0.060)"},{name:"easeInSine",curve:"cubic-bezier(0.470, 0.000, 0.745, 0.715)"},{name:"easeInCirc",curve:"cubic-bezier(0.600, 0.040, 0.980, 0.335)"},{name:"easeInBack",curve:"cubic-bezier(0.600, -0.280, 0.735, 0.045)"},{name:"easeInOutCubic",curve:"cubic-bezier(0.645, 0.045, 0.355, 1.000)"},{name:"easeInOutQuad",curve:"cubic-bezier(0.455, 0.030, 0.515, 0.955)"},{name:"easeInOutQuart",curve:"cubic-bezier(0.770, 0.000, 0.175, 1.000)"},{name:"easeInOutQuint",curve:"cubic-bezier(0.860, 0.000, 0.070, 1.000)"},{name:"easeInOutSine",curve:"cubic-bezier(0.445, 0.050, 0.550, 0.950)"},{name:"easeInOutExpo",curve:"cubic-bezier(1.000, 0.000, 0.000, 1.000)"},{name:"easeInOutCirc",curve:"cubic-bezier(0.785, 0.135, 0.150, 0.860)"},{name:"easeInOutBack",curve:"cubic-bezier(0.680, -0.550, 0.265, 1.550)"},{name:"easeInOut",curve:"cubic-bezier(.42,0,.58,1)"},{name:"linear",curve:"linear"}],TweenManager.useCSSTrans=function(props,ease,object){return!(props.math||"string"==typeof ease&&ease.includes(["Elastic","Bounce"])||object.multiTween||TweenManager._inspectEase(ease).path||!Device.tween.transition)},TweenManager._detectTween=function(object,props,time,ease,delay,callback){return TweenManager.useCSSTrans(props,ease,object)?new CSSTransition(object,props,time,ease,delay,callback):new FrameTween(object,props,time,ease,delay,callback)},TweenManager._parseTransform=function(props){var unitRequiresCSSTween=["%","vw","vh","em"],transforms="",translate="";if(props.perspective>0&&(transforms+="perspective("+props.perspective+"px)"),void 0!==props.x||void 0!==props.y||void 0!==props.z){var x=props.x||0,y=props.y||0,z=props.z||0;translate+=x+("string"==typeof props.x&&props.x.includes(unitRequiresCSSTween)?"":"px")+", ",translate+=y+("string"==typeof props.y&&props.y.includes(unitRequiresCSSTween)?"":"px"),Device.tween.css3d?transforms+="translate3d("+(translate+=", "+z+"px")+")":transforms+="translate("+translate+")"}return void 0!==props.scale?transforms+="scale("+props.scale+")":(void 0!==props.scaleX&&(transforms+="scaleX("+props.scaleX+")"),void 0!==props.scaleY&&(transforms+="scaleY("+props.scaleY+")")),void 0!==props.rotation&&(transforms+="rotate("+props.rotation+"deg)"),void 0!==props.rotationX&&(transforms+="rotateX("+props.rotationX+"deg)"),void 0!==props.rotationY&&(transforms+="rotateY("+props.rotationY+"deg)"),void 0!==props.rotationZ&&(transforms+="rotateZ("+props.rotationZ+"deg)"),void 0!==props.skewX&&(transforms+="skewX("+props.skewX+"deg)"),void 0!==props.skewY&&(transforms+="skewY("+props.skewY+"deg)"),transforms},TweenManager._clearCSSTween=function(obj){obj&&!obj._cssTween&&obj.div._transition&&!obj.persistTween&&(obj.div.style[HydraCSS.styles.vendorTransition]="",obj.div._transition=!1,obj._cssTween=null)},TweenManager._isTransform=function(key){return TweenManager.Transforms.indexOf(key)>-1},TweenManager._getAllTransforms=function(object){for(var obj={},i=TweenManager.Transforms.length-1;i>-1;i--){var tf=TweenManager.Transforms[i],val=object[tf];0===val||"number"!=typeof val&&"string"!=typeof val||(obj[tf]=val)}return obj};const prefix=function(){let pre="",dom="";try{var styles=window.getComputedStyle(document.documentElement,"");return pre=(Array.prototype.slice.call(styles).join("").match(/-(moz|webkit|ms)-/)||""===styles.OLink&&["","o"])[1],dom="WebKit|Moz|MS|O".match(new RegExp("("+pre+")","i"))[1],{unprefixed:"ie"==Device.system.browser&&!Device.detect("msie 9"),dom:dom,lowercase:pre,css:"-"+pre+"-",js:("ie"==Device.system.browser?pre[0]:pre[0].toUpperCase())+pre.substr(1)}}catch(e){return{unprefixed:!0,dom:"",lowercase:"",css:"",js:""}}}();HydraCSS.styles={},HydraCSS.styles.vendor=prefix.unprefixed?"":prefix.js,HydraCSS.styles.vendorTransition=HydraCSS.styles.vendor.length?HydraCSS.styles.vendor+"Transition":"transition",HydraCSS.styles.vendorTransform=HydraCSS.styles.vendor.length?HydraCSS.styles.vendor+"Transform":"transform",HydraCSS.vendor=prefix.css,HydraCSS.transformProperty=function(){switch(prefix.lowercase){case"moz":return"-moz-transform";case"webkit":return"-webkit-transform";case"o":return"-o-transform";case"ms":return"-ms-transform";default:return"transform"}}(),HydraCSS.tween={},HydraCSS.tween.complete=prefix.unprefixed?"transitionend":prefix.lowercase+"TransitionEnd"})),Class((function CSSTransition(_object,_props,_time,_ease,_delay,_callback){const _this=this;let _transformProps,_transitionProps;function killed(){return!_this||_this.kill||!_object||!_object.div}function clearCSSTween(){killed()||(_this.playing=!1,_object._cssTween=null,_object.willChange(null),_object=_props=null,Utils.nullObject(_this))}this.playing=!0,function(){if("number"!=typeof _time)throw"CSSTween Requires object, props, time, ease";!function initProperties(){var transform=TweenManager._getAllTransforms(_object),properties=[];for(var key in _props)TweenManager._isTransform(key)?(transform.use=!0,transform[key]=_props[key],delete _props[key]):("number"==typeof _props[key]||key.includes(["-","color"]))&&properties.push(key);transform.use&&(properties.push(HydraCSS.transformProperty),delete transform.use);_transformProps=transform,_transitionProps=properties}(),async function initCSSTween(values){if(killed())return;_object._cssTween&&(_object._cssTween.kill=!0);_object._cssTween=_this,_object.div._transition=!0;var strings=function buildStrings(time,ease,delay){for(var props="",str="",len=_transitionProps.length,i=0;i<len;i++){var transitionProp=_transitionProps[i];props+=(props.length?", ":"")+transitionProp,str+=(str.length?", ":"")+transitionProp+" "+time+"ms "+TweenManager._getEase(ease)+" "+delay+"ms"}return{props:props,transition:str}}(_time,_ease,_delay);_object.willChange(strings.props);var time=values?values.time:_time,delay=values?values.delay:_delay,props=values?values.props:_props,transformProps=values?values.transform:_transformProps,singleFrame=1e3/Render.REFRESH_RATE;if(_this.time=_time,_this.delay=_delay,await Timer.delayedCall(3*singleFrame),killed())return;if(_object.div.style[HydraCSS.styles.vendorTransition]=strings.transition,_this.playing=!0,"safari"==Device.system.browser){if(Device.system.browserVersion<11&&await Timer.delayedCall(singleFrame),killed())return;_object.css(props),_object.transform(transformProps)}else _object.css(props),_object.transform(transformProps);Timer.create((function(){killed()||(clearCSSTween(),_callback&&_callback(),_this.completePromise&&_this.completePromise.resolve())}),time+delay)}()}(),this.stop=function(){this.playing&&(this.kill=!0,this.playing=!1,_object.div.style[HydraCSS.styles.vendorTransition]="",_object.div._transition=!1,_object.willChange(null),_object._cssTween=null,Utils.nullObject(this))},this.onComplete=function(callback){return _callback=callback,this},this.promise=function(){return _this.completePromise||(_this.completePromise=Promise.create()),_this.completePromise}})),Class((function FrameTween(_object,_props,_time,_ease,_delay,_callback,_manual){var _endValues,_transformEnd,_transformStart,_startValues,_isTransform,_isCSS,_transformProps,_cssTween,_transformTween,_update,_this=this;function copy(obj){let newObj={};for(let key in obj)"number"==typeof obj[key]&&(newObj[key]=obj[key]);return newObj}function clear(){_object._cssTweens&&_object._cssTweens.remove(_this),_this.playing=!1,_object._cssTween=null,_object=_props=null}function update(){if(!function killed(){return _this.kill||!_object||!_object.div||!_object.css}()){if(_isCSS&&_object.css(_props),_isTransform)if(_object.multiTween){for(var key in _transformProps)"number"==typeof _transformProps[key]&&(_object[key]=_transformProps[key]);_object.transform()}else _object.transform(_transformProps);_update&&_update()}}function tweenComplete(){_this.playing&&(clear(),_callback&&_callback(),_this.completePromise&&_this.completePromise.resolve())}this.playing=!0,_this.object=_object,_this.props=_props,_this.time=_time,_this.ease=_ease,_this.delay=_delay,defer((function(){if(_this.overrideValues){let values=_this.overrideValues(_this,_object,_props,_time,_ease,_delay);values&&(_this.props=_props=values.props||_props,_this.time=_time=values.time||_time,_this.ease=_ease=values.ease||_ease,_this.delay=_delay=values.delay||_delay)}if("object"==typeof _ease&&(_ease="easeOutCubic"),_object&&_props){if(_this.object=_object,"number"!=typeof _time)throw"FrameTween Requires object, props, time, ease";!function initValues(){_props.math&&delete _props.math;Device.tween.transition&&_object.div&&_object.div._transition&&(_object.div.style[HydraCSS.styles.vendorTransition]="",_object.div._transition=!1);_this.time=_time,_this.delay=_delay,_endValues={},_transformEnd={},_transformStart={},_startValues={},_object.multiTween||(void 0===_props.x&&(_props.x=_object.x),void 0===_props.y&&(_props.y=_object.y),void 0===_props.z&&(_props.z=_object.z));for(var key in _props)if(key.includes(["damping","spring"]))_endValues[key]=_props[key],_transformEnd[key]=_props[key];else if(TweenManager._isTransform(key))_isTransform=!0,_transformStart[key]=_object[key]||("scale"==key?1:0),_transformEnd[key]=_props[key];else{_isCSS=!0;var v=_props[key];"string"==typeof v?_object.div.style[key]=v:"number"==typeof v&&(_startValues[key]=_object.css?Number(_object.css(key)):0,_endValues[key]=v)}}(),function startTween(){!_object._cssTween||_manual||_object.multiTween||(_object._cssTween.kill=!0);_this.time=_time,_this.delay=_delay,_object.multiTween&&(_object._cssTweens||(_object._cssTweens=[]),_object._cssTweens.push(_this));_object._cssTween=_this,_this.playing=!0,_props=copy(_startValues),_transformProps=copy(_transformStart),_isCSS&&(_cssTween=tween(_props,_endValues,_time,_ease,_delay,null,_manual).onUpdate(update).onComplete(tweenComplete));_isTransform&&(_transformTween=tween(_transformProps,_transformEnd,_time,_ease,_delay,null,_manual).onComplete(_isCSS?null:tweenComplete).onUpdate(_isCSS?null:update))}()}})),this.stop=function(){this.playing&&(_cssTween&&_cssTween.stop&&_cssTween.stop(),_transformTween&&_transformTween.stop&&_transformTween.stop(),clear())},this.interpolate=function(elapsed){_cssTween&&_cssTween.interpolate(elapsed),_transformTween&&_transformTween.interpolate(elapsed),update()},this.getValues=function(){return{start:_startValues,transformStart:_transformStart,end:_endValues,transformEnd:_transformEnd}},this.setEase=function(ease){_cssTween&&_cssTween.setEase(ease),_transformTween&&_transformTween.setEase(ease)},this.onUpdate=function(){return this},this.onComplete=function(callback){return _callback=callback,this},this.promise=function(){return _this.completePromise||(_this.completePromise=Promise.create()),_this.completePromise}}));class DOMAttribute{constructor({name:name,value:value,belongsTo:belongsTo,bindingLookup:bindingLookup}){this.name=name,this.value=value,this.belongsTo=belongsTo,this.bindingLookup=bindingLookup}}class TemplateRoot{constructor(string,values){this.string=string,this.values=values}consolidate(){let template=this.string;const consolidatedValues={};for(const[marker,value]of Object.entries(this.values))if(value instanceof TemplateHTML){const[innerTemplate,innerValues]=value.consolidate();template=template.replace(marker,innerTemplate),Object.assign(consolidatedValues,innerValues)}else if(Array.isArray(value)){let childTemplate="";for(let k=0;k<value.length;k++){const[innerString,innerValue]=value[k].consolidate();childTemplate+=innerString,Object.assign(consolidatedValues,innerValue)}template=template.replace(marker,childTemplate)}else consolidatedValues[marker]=value;return[template,consolidatedValues]}modifyMarkers(template,config,dataMarkers,bindings){let count=0;return template.replace(/@([a-z]+)="\{\{(hydra-[0-9]+)\}\}"/g,(function(_,event,marker){const dataMarker="data-attach-event-"+count++;return dataMarkers.push(dataMarker),`${dataMarker}="${event}|${marker}"`})).replace(/\{\{hydra-[0-9]+\}\}/g,(function(marker){if(config[marker]&&config[marker].state)return bindings.push({lookup:marker.trim()}),marker;if(config[marker]["@style"]){const styles=config[marker]["@style"];if(!styles||"object"!=typeof styles)return void console.error("@style must contain an object");let styleString="";return Object.keys(styles).forEach((prop=>{const kebabProp=prop.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g,"$1-$2").toLowerCase();styleString+=`${kebabProp}: ${styles[prop]};\n`})),styleString}return config[marker]}))}}class TemplateHTML extends TemplateRoot{constructor(string,values){super(string,values)}inflate(root,cssElement){let[template,config]=this.consolidate(),dataMarkers=[],nestedComponents=[],bindings=new LinkedList,scrollTop=root.firstChild?.scrollTop;const t=this.modifyMarkers(template,config,dataMarkers,bindings);for(;root.firstChild;)root.removeChild(root.firstChild);root.flatBindings&&root.flatBindings.forEach((b=>b.destroy())),root.flatBindings=[];let fragment=document.createDocumentFragment(),newNode=DOMTemplate.parser.parseFromString(t,"text/html"),els=newNode.body.firstChild.querySelectorAll("*"),length=els.length;fragment.appendChild(newNode.body.firstChild),cssElement&&fragment.appendChild(cssElement);for(let index=length-1;index>-1;index--){let el=els[index];~el.tagName.indexOf("-")&&nestedComponents.push(el);let innerText=el.innerText,innerHTML=el.innerHTML,attributes=[...el.attributes].map((a=>({name:a.name,value:a.value})));if(~innerHTML.indexOf("<"))continue;let binding=bindings.start();for(;binding;){let bindingLookup=binding.lookup;if(attributes.forEach((attr=>{if(~attr?.value?.indexOf(bindingLookup)){let obj=config[bindingLookup];const attrObject=new DOMAttribute({name:attr.name,value:el.getAttribute(attr.name),belongsTo:el,bindingLookup:bindingLookup});root.flatBindings.push(obj.state.bind(obj.key,attrObject))}})),~innerText.indexOf(bindingLookup)){let obj=config[bindingLookup];~innerText.indexOf("@[")&&(el.innerText=innerText.replace(bindingLookup,obj.key)),root.flatBindings.push(obj.state.bind(obj.key,el))}binding=bindings.next()}}root.appendChild(fragment),dataMarkers.forEach((dataMarker=>{const element=root.querySelector(`[${dataMarker}]`),dataEvent=element.getAttribute(dataMarker),[event,marker]=dataEvent.split("|");element.removeAttribute(dataMarker),element.addEventListener(`${event}`,config[`{{${marker}}}`])})),defer((()=>{nestedComponents.forEach((template=>{const className=template.tagName.toLowerCase().replace(/(^\w|-\w)/g,(str=>str.replace(/-/,"").toUpperCase()));$(`#${template.id}`,className,!0).add(new window[className])}))})),scrollTop&&(root.firstChild.scrollTop=scrollTop)}}class TemplateCSS extends TemplateRoot{constructor(string,values){super(string,values)}inflate(root){let[template,config]=this.consolidate(),bindings=new LinkedList,element=document.createElement("style");return element.innerHTML=this.modifyMarkers(template,config,[],bindings),element}}function styleMap(object){return Object.keys(object).map((key=>object[key]?key:"")).join(" ")}!function(){let markerID=0;function makeMarker(){return`{{hydra-${markerID++}}}`}function html(strings,...values){const config={};let string="";for(let i=0;i<strings.length-1;i++){const marker=makeMarker();string+=strings[i],string+=marker,config[marker]=values[i]}return string+=strings[strings.length-1],new TemplateHTML(string,config)}function css(strings,...values){const config={};let string="";for(let i=0;i<strings.length-1;i++){const marker=makeMarker();string+=strings[i],string+=marker,config[marker]=values[i]}return string+=strings[strings.length-1],new TemplateCSS(string,config)}Class((function DOMTemplate(){Inherit(this,Element);const _this=this;if(this.data=[],Hydra.LOCAL&&window.UILSocket){let name=Utils.getConstructorName(_this);_this.events.sub(UILSocket.JS_FILE,(e=>{e.file.includes(name)&&(DOMTemplate.updateGlobalStyles(),_this.update())}))}function update(){let cssContent;_this.dynamicStyle&&(cssContent=_this.dynamicStyle(css).inflate(_this.element.div)),_this.render?.(html).inflate?.(_this.element.div,cssContent),_this.postRender?.()}this.update=function(){DOMTemplate.clearScheduled(update),DOMTemplate.schedule(update)},this.render=function(html){throw new Error("render() needs to be overwritten.")},this.setSourceData=function(data){_this.data=data,this.update(),_this.events.sub(data,Events.UPDATE,this.update)},_this.update()}),(_=>{DOMTemplate.parser=new DOMParser;const queue=[],worker=new Render.Worker((_=>{let callback=queue.shift();callback?callback():worker.pause()}),2);var _css;worker.pause(),DOMTemplate.schedule=function(callback){queue.push(callback),worker.resume()},DOMTemplate.clearScheduled=function(callback){for(let i=0;i<queue.length;i++){if(queue[i]==callback)return queue.splice(i,1)}},DOMTemplate.updateGlobalStyles=function(){Utils.debounce((async _=>{let css=await get(Assets.getPath("assets/css/style-scss.css"));_css||(_css=$(document.head).create("DOMTemplate-hotload","style")),_css.div.innerHTML=css}),20)}}))}(),Class((function Interaction(_object){Inherit(this,Events);const _this=this;var _touchId,_velocity=[],_moved=0,_time=performance.now();function Vec2(){this.x=0,this.y=0,this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)}}var _vec2Pool=new ObjectPool(Vec2,10);let _distance,_timeDown,_timeMove;function loop(){_moved++>10&&(_this.velocity.x=_this.velocity.y=0,_this.delta.x=_this.delta.y=0)}function down(e){const hitCondition=!!_this.hitReturn&&("hit"==e.target.className&&e.target.hydraObject!=_object);if(_this.isTouching&&!_this.multiTouch||hitCondition||Interaction.hitIsBound(e.target,_object))return;_this.isTouching=!0;let x=e.x,y=e.y;e.changedTouches&&!_touchId&&(x=e.changedTouches[0].clientX,y=e.changedTouches[0].clientY,_touchId=e.changedTouches[0].identifier),e.touches&&"number"==typeof e.touches[0].force&&(e.force=e.touches[0].force),e.x=_this.x=x,e.y=_this.y=y,_this.hold.x=_this.last.x=x,_this.hold.y=_this.last.y=y,_this.delta.x=_this.move.x=_this.velocity.x=0,_this.delta.y=_this.move.y=_this.velocity.y=0,_distance=0,_this.events.fire(Interaction.START,e,!0),_timeDown=_timeMove=Render.TIME}function move(e){if(!_this.isTouching&&!_this.unlocked)return;let now=performance.now();if(now-_time<16)return;_time=now;let x=e.x,y=e.y;if(e.touches)for(let i=0;i<e.touches.length;i++){let touch=e.touches[i];touch.identifier==_touchId&&(x=touch.clientX,y=touch.clientY)}_this.isTouching&&(_this.move.x=x-_this.hold.x,_this.move.y=y-_this.hold.y),e.touches&&"number"==typeof e.touches[0].force&&(e.force=e.touches[0].force),e.x=_this.x=x,e.y=_this.y=y,_this.delta.x=x-_this.last.x,_this.delta.y=y-_this.last.y,_this.last.x=x,_this.last.y=y,_moved=0,_distance+=_this.delta.length();let delta=Render.TIME-(_timeMove||Render.TIME);if(_timeMove=Render.TIME,delta>.01){let velocity=_vec2Pool.get();velocity.x=Math.abs(_this.delta.x)/delta,velocity.y=Math.abs(_this.delta.y)/delta,_velocity.push(velocity),_velocity.length>5&&_vec2Pool.put(_velocity.shift())}_this.velocity.x=_this.velocity.y=0;for(let i=0;i<_velocity.length;i++)_this.velocity.x+=_velocity[i].x,_this.velocity.y+=_velocity[i].y;_this.velocity.x/=_velocity.length,_this.velocity.y/=_velocity.length,_this.velocity.x=_this.velocity.x||0,_this.velocity.y=_this.velocity.y||0,_this.events.fire(Interaction.MOVE,e,!0),_this.isTouching&&_this.events.fire(Interaction.DRAG,e,!0)}function up(e){if(e&&e.changedTouches){let someTouchIdentified=!1;for(let i=0;i<e.changedTouches.length;i++)e.changedTouches[i].identifier===_touchId&&(someTouchIdentified=!0);if(!someTouchIdentified)return}if(!_this.isTouching&&!_this.unlocked)return;_this.isTouching=!1,_this.move.x=0,_this.move.y=0,Math.max(.001,Render.TIME-(_timeMove||Render.TIME))>=40&&(_this.delta.x=0,_this.delta.y=0),_distance<20&&Render.TIME-_timeDown<1e3&&!e.isLeaveEvent&&_this.events.fire(Interaction.CLICK,e,!0),_this.events.fire(Interaction.END,e,!0),_touchId=null,Device.mobile&&(_this.velocity.x=_this.velocity.y=0)}function leave(){_this.ignoreLeave||(_this.delta.x=0,_this.delta.y=0,up({isLeaveEvent:!0}))}this.x=0,this.y=0,this.hold=new Vec2,this.last=new Vec2,this.delta=new Vec2,this.move=new Vec2,this.velocity=new Vec2,this.hitReturn=!0,function(){if(!_object instanceof HydraObject)throw"Interaction.Input requires a HydraObject";!function addHandlers(){_object==Stage||_object==__window?Interaction.bind("touchstart",down):(_object.bind("touchstart",down),Interaction.bindObject(_object));Interaction.bind("touchmove",move),Interaction.bind("touchend",up),Interaction.bind("leave",leave)}(),Render.start(loop)}(),this.onDestroy=function(){Interaction.unbind("touchstart",down),Interaction.unbind("touchmove",move),Interaction.unbind("touchend",up),Render.stop(loop),Interaction.unbindObject(_object),_object&&_object.unbind&&_object.unbind("touchstart",down)}}),(()=>{Namespace(Interaction),Interaction.CLICK="interaction_click",Interaction.START="interaction_start",Interaction.MOVE="interaction_move",Interaction.DRAG="interaction_drag",Interaction.END="interaction_end";const _objects=[],_events={touchstart:[],touchmove:[],touchend:[],leave:[]};function touchMove(e){_events.touchmove.forEach((c=>c(e)))}function touchStart(e){_events.touchstart.forEach((c=>c(e)))}function touchEnd(e){_events.touchend.forEach((c=>c(e)))}function leave(e){e.leave=!0,_events.leave.forEach((c=>c(e)))}Hydra.ready((async()=>{await defer(),__window.bind("touchstart",touchStart),__window.bind("touchmove",touchMove),__window.bind("touchend",touchEnd),__window.bind("touchcancel",touchEnd),__window.bind("contextmenu",touchEnd),__window.bind("mouseleave",leave),__window.bind("mouseout",leave)})),Interaction.bind=function(evt,callback){_events[evt].push(callback)},Interaction.unbind=function(evt,callback){_events[evt].remove(callback)},Interaction.bindObject=function(obj){_objects.push(obj)},Interaction.unbindObject=function(obj){_objects.remove(obj)},Interaction.hitIsBound=function(element,boundObj){let obj=element.hydraObject;if(!obj)return!1;for(;obj;){if(obj!=boundObj&&_objects.includes(obj))return!0;obj=obj._parent}return!1}})),Class((function Mouse(){Inherit(this,Events);const _this=this;this.x=0,this.y=0,this.normal={x:0,y:0},this.tilt={x:0,y:0},this.inverseNormal={x:0,y:0},this.resetOnRelease=!1;const _offset={x:0,y:0};function init(){_this.x=Stage.width/2,_this.y=Stage.height/2,defer((_=>{_this.resetOnRelease&&Device.mobile&&(_this.x=Stage.width/2,_this.y=Stage.height/2)})),_this.input=new Interaction(__window),_this.input.unlocked=!0,_this.events.sub(_this.input,Interaction.START,start),_this.events.sub(_this.input,Interaction.MOVE,update),_this.events.sub(_this.input,Interaction.END,end),_this.hold=_this.input.hold,_this.last=_this.input.last,_this.delta=_this.input.delta,_this.move=_this.input.move,_this.velocity=_this.input.velocity,defer((()=>{_this.events.sub(Events.RESIZE,resize),resize()}))}function start(e){_this.down=!0,update(e)}function update(e){_this.force&&(e=_this.force),_this.x=e.x,_this.y=e.y,Stage.width&&Stage.height&&(_this.normal.x=e.x/Stage.width-_offset.x,_this.normal.y=e.y/Stage.height-_offset.y,_this.tilt.x=2*_this.normal.x-1,_this.tilt.y=1-2*_this.normal.y,_this.inverseNormal.x=_this.normal.x,_this.inverseNormal.y=1-_this.normal.y)}function end(e){_this.down=!1,Device.mobile&&_this.resetOnRelease&&update({x:Stage.width/2,y:Stage.height/2})}function resize(){Stage.css("top")&&(_offset.y=Stage.css("top")/Stage.height),Stage.css("left")&&(_offset.x=Stage.css("left")/Stage.width)}Hydra.ready(init),_this.update=update}),"Static"),Class((function Keyboard(){Inherit(this,Component);var _this=this;function addListeners(){__window.keydown(keydown),__window.keyup(keyup),__window.keypress(keypress),window.addEventListener("focus",onFocus)}function keydown(e){_this.pressing.includes(e.key)||_this.pressing.push(e.key),_this.events.fire(_this.DOWN,e),2==_this.pressing.length&&_this.pressing.includes("Meta")&&_this.pressing.includes("Shift")&&(_this.pressing.length=0)}function keyup(e){_this.pressing.remove(e.key),_this.events.fire(_this.UP,e)}function keypress(e){_this.events.fire(_this.PRESS,e)}function onFocus(){_this.pressing.length=0}this.pressing=[],_this.DOWN="keyboard_down",_this.PRESS="keyboard_press",_this.UP="keyboard_up",Hydra.ready(addListeners)}),"static"),Class((function Mobile(){Inherit(this,Component),Namespace(this);const _this=this;var $html,$featureDetects,_is100vh=!1;function preventNativeScroll(e){if(_this.isAllowNativeScroll)return;let target=e.target;if(target.closest("label, input, textarea, select, a, button"))return;let prevent=target.hydraObject;for(;target.parentNode&&prevent;)target._scrollParent&&(prevent=!1),target=target.parentNode;prevent&&e.preventDefault()}function resize(){updateOrientation(),checkResizeRefresh(),updateMobileFullscreen(),_this.isAllowNativeScroll||(document.body.scrollTop=0)}function updateOrientation(){_this.orientation=Stage.width>Stage.height?"landscape":"portrait",_this.orientationSet&&(window.Fullscreen?.isOpen||Device.mobile?.pwa)&&window.screen&&window.screen.orientation&&window.screen.orientation.lock(_this.orientationSet)}Hydra.ready((()=>{if(Device.mobile){if(Stage.isNormalMobileScroll&&(_this.isAllowNativeScroll=!0,_this.isPreventResizeReload=!1),function initFeatureDetects(){$featureDetects=__body.create("feature-detects")}(),function addHandlers(){_this.events.sub(Events.RESIZE,resize),Device.mobile.native||Stage.isNormalMobileScroll||window.addEventListener("touchstart",preventNativeScroll,{passive:!1})}(),Device.mobile?.phone&&!Device.mobile.native&&!Stage.isNormalMobileScroll){$html=$(document.documentElement);let ios="safari"===Device.system.browser;ios?$html.div.classList.add("ios"):$html.div.classList.add("mob"),_is100vh=!0,ios&&(__body.css({height:"100%"}).div.scrollTop=0),updateMobileFullscreen()}Device.mobile.native&&Stage.css({width:"100vw",height:"100vh"})}}));const checkResizeRefresh=function(){let _lastWidth;return function(){_this.isPreventResizeReload||_lastWidth!=Stage.width&&(_lastWidth=Stage.width,("ios"===Device.system.os||"android"==Device.system.os&&Device.system.version>=7)&&(!Device.mobile.tablet||Math.max(Stage.width,Stage.height)>800||window.location.reload()))}}();function updateMobileFullscreen(){if(!Stage.isNormalMobileScroll&&$html){let vh100=$featureDetects.div.offsetHeight;$html.div.offsetHeight!==Stage.height?Stage.height===vh100?($html.css({height:""}),Stage.css({height:"100%"}),_is100vh=!0):($html.css({height:Stage.height}),Stage.css({height:Stage.height}),_is100vh=!1):_is100vh||Stage.height!==vh100||($html.css({height:""}),Stage.css({height:"100%"}),_is100vh=!0)}}this.vibrate=function(duration){navigator.vibrate&&navigator.vibrate(duration)},this.fullscreen=function(){if(Device.mobile&&!Device.mobile.native&&!Device.mobile.pwa&&!Dev.emulator){if(!window.Fullscreen)throw"Mobile.fullscreen requires Fullscreen module";"android"!==Device.system.os||Device.detect("oculus")||(__window.bind("touchend",(()=>{Fullscreen.open()})),_this.ScreenLock&&_this.ScreenLock.isActive&&window.onresize())}},this.setOrientation=function(orientation,isForce){if(_this.System&&_this.NativeCore.active)return _this.System.orientation=_this.System[orientation.toUpperCase()];if(_this.orientationSet=orientation,updateOrientation(),isForce){if(!_this.ScreenLock)throw"Mobile.setOrientation isForce argument requires ScreenLock module";"any"===orientation?_this.ScreenLock.unlock():_this.ScreenLock.lock()}},this.isKeyboardOpen=function(){return Device.mobile&&document.activeElement.tagName.toLowerCase().includes(["textarea","input"])},this.allowNativeScroll=function(enabled=!0){_this.isAllowNativeScroll=enabled;let action=enabled?"unset":"";[$(document.documentElement),__body,Stage].forEach(($el=>$el.css({touchAction:action,MSContentZooming:action,MSTouchAction:action})))},this.preventResizeReload=function(){_this.isPreventResizeReload=!0},this._addOverflowScroll=function($obj){$obj.div._scrollParent=!0,Device.mobile.native||($obj.div._preventEvent=function(e){e.stopPropagation()},$obj.bind("touchmove",$obj.div._preventEvent))},this._removeOverflowScroll=function($obj){$obj.unbind("touchmove",$obj.div._preventEvent)},this.get("phone",(()=>{throw"Mobile.phone is removed. Use Device.mobile.phone"})),this.get("tablet",(()=>{throw"Mobile.tablet is removed. Use Device.mobile.tablet"})),this.get("os",(()=>{throw"Mobile.os is removed. Use Device.system.os"})),function(){var _props=["--safe-area-inset-top","--safe-area-inset-right","--safe-area-inset-bottom","--safe-area-inset-left"];function getSafeAreaInset(index){if(!$featureDetects)return 0;let style=getComputedStyle($featureDetects.div);return parseInt(style.getPropertyValue(_props[index]))||0}_this.getSafeAreaInsets=()=>_props.map(((_,i)=>getSafeAreaInset(i))),_this.getSafeAreaInsetTop=()=>getSafeAreaInset(0),_this.getSafeAreaInsetRight=()=>getSafeAreaInset(1),_this.getSafeAreaInsetBottom=()=>getSafeAreaInset(2),_this.getSafeAreaInsetLeft=()=>getSafeAreaInset(3)}()}),"Static"),Class((function PushState(_isHash){Inherit(this,Component);const _this=this;let _store,_useInternal,_root="";function getState(){return _useInternal?new String(_store):_isHash?String(window.location.hash.slice(3)):("/"!==_root&&""!==_root?location.pathname.split(_root)[1]:location.pathname.slice(1))||""}function handleStateChange(state,forced){if(state===_store&&!forced)return;if(_this.flag("isInitializingUseInternal"))return;if(_this.isLocked&&!forced){if(!_store)return;return void(_useInternal||(_isHash?window.location.hash="!/"+_store:window.history.pushState(null,null,Utils.addQueryToPath(_root+_store))))}let prevValue=_store;_store=state,_this.events.fire(Events.UPDATE,{prevValue:prevValue,value:state,split:state.split("/")}),_this.onStateUpdate?.({prevValue:prevValue,value:state,split:state.split("/")})}"boolean"!=typeof _isHash&&(_isHash=Hydra.LOCAL||!Device.system.pushstate),this.isLocked=!1,_this.flag("isNotBlocked",!0),function addHandlers(){if(_isHash)return window.addEventListener("hashchange",(()=>handleStateChange(getState())),!1);window.onpopstate=history.onpushstate=()=>handleStateChange(getState())}(),_store=getState(),_this.flag("isInitializing",!0),deferNextTick((()=>{_this.flag("isInitializing",!1)})),this.getState=this._getState=function(){return Device.mobile.native?Storage.get("app_state")||"":getState()},this.setRoot=function(root){_root="/"===root.charAt(0)?root:"/"+root},this.setState=this._setState=async function(state,forced){if("/"==state.charAt(0)&&(state=state.slice(1)),_this.events.fire(PushState.SET_STATE),await _this.wait("isNotBlocked"),Device.mobile.native&&Storage.set("app_state",state),state!==_store||forced)return _useInternal?_store=state:_isHash?window.location.hash="!/"+state:window.history.pushState(null,null,Utils.addQueryToPath(_root+state)),_this.fireChangeWhenSet&&handleStateChange(getState(),forced),_store=state,!0},this.enableBlocker=function(){_this.flag("isNotBlocked",!1)},this.disableBlocker=function(){_this.flag("isNotBlocked",!0)},this.replaceState=function(state){state!==_store&&(_store=state,_useInternal?_store=state:_isHash?window.location.hash="!/"+state:window.history.replaceState(null,null,Utils.addQueryToPath(_root+state)))},this.setTitle=function(title){document.title=title},this.lock=function(){this.isLocked=!0,_this.events.fire(PushState.LOCK)},this.unlock=function(){this.isLocked=!1,_this.events.fire(PushState.UNLOCK)},this.useHash=function(){_isHash=!0},this.useInternal=function(){_this.flag("isInitializing")&&""!==_store&&(_this.flag("isInitializingUseInternal",!0),_this.replaceState(""),deferNextTick((()=>{_this.flag("isInitializingUseInternal",!1)}))),_useInternal=!0}}),(_=>{PushState.SET_STATE="push_state_set_state",PushState.LOCK="push_state_lock",PushState.UNLOCK="push_state_unlock"})),Class((function Router(_isHash,_rootPath){Inherit(this,PushState,_isHash);const _this=this;var _debounce,_prevView,_nextView,_404Route,_prevRoute,_callbacks=[],_routesFlattened=[];function matchRoute(path){let params;const matchedRoute=_routesFlattened.find((route=>{const result=route.matcher.exec({pathname:`/${path}`});return!(!result||!result.pathname)&&(params=result.pathname.groups,!0)}));return!!matchedRoute&&{...matchedRoute.route,params:params}}function handleState(e){let value=e?.value;if(value||(value=_this.getState()),_this.virtualRoutes)return AppState.set("Router/state",String(value));let route=null,cb=null;if(_this.lock(),_callbacks.forEach((callback=>{route||(route=matchRoute(value),cb=callback)})),route&&route.redirect){let redirectedRoute=matchRoute(route.redirect);if(redirectedRoute){if(route.updateURL)return _this.unlock(),void _this.setState(route.redirect);route=redirectedRoute}}route||(value="404",route=_404Route),AppState.set("Router/state",String(value)),AppState.set("Router/route",route),async function doRoute(route,path,callback){if(_nextView=route?.view,"$"==_nextView?.charAt?.(0)){let ref=_nextView.slice(1);if(_this[ref])_nextView=_this[ref];else for(let key in _this.classes){let obj=_this.classes[key];obj.ref==ref&&obj.force(),_nextView=_this[ref]}_nextView&&(_nextView.visible=!0)}let params=null;await(callback?.(_prevView,_nextView,path,route.params,route)),await(_nextView?.onRouteChange?.({params:params,path:path,name:route.name,children:route.children,meta:route.meta})),_prevView=_nextView,AppState.set("Router/previous",_prevRoute?.path),AppState.set("Router/previousRoute",_prevRoute),_this.currentRoute={...route,params:params},_this.unlock(),_prevRoute=route}(route,value,cb)}function handleInstanceReloaded({oldInstance:oldInstance,newInstance:newInstance}){_prevView===oldInstance&&(_prevView=newInstance)}function addChildrenRoutes(element,parentPath){element.children&&element.children.length&&element.children.forEach((child=>{const path=`${parentPath}/${child.path}`;_routesFlattened.push({path:`${parentPath}/${child.path}`,route:child,matcher:new URLPattern({pathname:path})}),addChildrenRoutes(child,path)}))}_this.currentRoute=null,_this.fireChangeWhenSet=!0,function setRootPath(val){let rootPath;rootPath="string"==typeof _rootPath?_rootPath:Hydra.LOCAL?"":"/",_this.setRoot(rootPath)}(),function initEvents(){_this.events.sub(_this,Events.UPDATE,handleState),_this.events.sub(Component.HMR_INSTANCE_RELOADED,handleInstanceReloaded)}(),this._initFragRoutes=function(array){array.forEach((obj=>{obj.view&&(obj.view=_this[obj.view.slice(1)]),obj.lazyView&&(obj.view=obj.lazyView)})),this.registerRoutes(_this.onRouteChange,array)},this.registerRoutes=function(callback,list){if(list.forEach((element=>{if(element.path.startsWith("/"))throw new Error("router paths should not start with /");if(element.redirect&&element.redirect.startsWith("/"))throw new Error("redirect paths must not start with /");const path=`/${element.path}`;_routesFlattened.push({path:path,route:element,matcher:new URLPattern({pathname:path})}),addChildrenRoutes(element,path),"404"===element.path&&(_404Route=element)})),!_404Route)throw new Error('Error: no 404 route defined.  Please define a route whos path is "404" ');_callbacks.push(callback),clearTimeout(_debounce),_debounce=_this.delayedCall(handleState,1)},this.navigate=function(path){_this.isLocked||(path.startsWith("/")&&(path=path.substring(1)),Utils.debounce((()=>{_this.setState(path)}),10))},this.replace=function(path){path.startsWith("/")&&(path=path.substring(1)),Utils.debounce((()=>{_this.replaceState(path)}),10)}})),(()=>{"use strict";var t=/[$_\p{ID_Start}]/u,e=/[$_\u200C\u200D\p{ID_Continue}]/u;function n(t,e){return(e?/^[\x00-\xFF]*$/:/^[\x00-\x7F]*$/).test(t)}function s(s,r=!1){const i=[];let a=0;for(;a<s.length;){const o=s[a],h=function(t){if(!r)throw new TypeError(t);i.push({type:"INVALID_CHAR",index:a,value:s[a++]})};if("*"!==o)if("+"!==o&&"?"!==o)if("\\"!==o)if("{"!==o)if("}"!==o)if(":"!==o)if("("!==o)i.push({type:"CHAR",index:a,value:s[a++]});else{let t=1,e="",r=a+1,o=!1;if("?"===s[r]){h(`Pattern cannot start with "?" at ${r}`);continue}for(;r<s.length;){if(!n(s[r],!1)){h(`Invalid character '${s[r]}' at ${r}.`),o=!0;break}if("\\"!==s[r]){if(")"===s[r]){if(t--,0===t){r++;break}}else if("("===s[r]&&(t++,"?"!==s[r+1])){h(`Capturing groups are not allowed at ${r}`),o=!0;break}e+=s[r++]}else e+=s[r++]+s[r++]}if(o)continue;if(t){h(`Unbalanced pattern at ${a}`);continue}if(!e){h(`Missing pattern at ${a}`);continue}i.push({type:"PATTERN",index:a,value:e}),a=r}else{let n="",r=a+1;for(;r<s.length;){const i=s.substr(r,1);if(!(r===a+1&&t.test(i)||r!==a+1&&e.test(i)))break;n+=s[r++]}if(!n){h(`Missing parameter name at ${a}`);continue}i.push({type:"NAME",index:a,value:n}),a=r}else i.push({type:"CLOSE",index:a,value:s[a++]});else i.push({type:"OPEN",index:a,value:s[a++]});else i.push({type:"ESCAPED_CHAR",index:a++,value:s[a++]});else i.push({type:"MODIFIER",index:a,value:s[a++]});else i.push({type:"ASTERISK",index:a,value:s[a++]})}return i.push({type:"END",index:a,value:""}),i}function r(t,e={}){const n=s(t),{prefixes:r="./"}=e,a=`[^${i(e.delimiter||"/#?")}]+?`,o=[];let h=0,p=0,c="",u=new Set;const f=t=>{if(p<n.length&&n[p].type===t)return n[p++].value},l=()=>f("MODIFIER")||f("ASTERISK"),m=t=>{const e=f(t);if(void 0!==e)return e;const{type:s,index:r}=n[p];throw new TypeError(`Unexpected ${s} at ${r}, expected ${t}`)},d=()=>{let t,e="";for(;t=f("CHAR")||f("ESCAPED_CHAR");)e+=t;return e},g=e.encodePart||(t=>t);for(;p<n.length;){const t=f("CHAR"),e=f("NAME");let n=f("PATTERN");if(e||n||!f("ASTERISK")||(n=".*"),e||n){let s=t||"";-1===r.indexOf(s)&&(c+=s,s=""),c&&(o.push(g(c)),c="");const i=e||h++;if(u.has(i))throw new TypeError(`Duplicate name '${i}'.`);u.add(i),o.push({name:i,prefix:g(s),suffix:"",pattern:n||a,modifier:l()||""});continue}const s=t||f("ESCAPED_CHAR");if(s)c+=s;else if(f("OPEN")){const t=d(),e=f("NAME")||"";let n=f("PATTERN")||"";e||n||!f("ASTERISK")||(n=".*");const s=d();m("CLOSE");const r=l()||"";if(!e&&!n&&!r){c+=t;continue}if(!e&&!n&&!t)continue;c&&(o.push(g(c)),c=""),o.push({name:e||(n?h++:""),pattern:e&&!n?a:n,prefix:g(t),suffix:g(s),modifier:r})}else c&&(o.push(g(c)),c=""),m("END")}return o}function i(t){return t.replace(/([.+*?^${}()[\]|/\\])/g,"\\$1")}function a(t){return t&&t.sensitive?"u":"ui"}function o(t,e,n={}){const{strict:s=!1,start:r=!0,end:o=!0,encode:h=(t=>t)}=n,p=`[${i(n.endsWith||"")}]|$`,c=`[${i(n.delimiter||"/#?")}]`;let u=r?"^":"";for(const n of t)if("string"==typeof n)u+=i(h(n));else{const t=i(h(n.prefix)),s=i(h(n.suffix));if(n.pattern)if(e&&e.push(n),t||s)if("+"===n.modifier||"*"===n.modifier){const e="*"===n.modifier?"?":"";u+=`(?:${t}((?:${n.pattern})(?:${s}${t}(?:${n.pattern}))*)${s})${e}`}else u+=`(?:${t}(${n.pattern})${s})${n.modifier}`;else"+"===n.modifier||"*"===n.modifier?u+=`((?:${n.pattern})${n.modifier})`:u+=`(${n.pattern})${n.modifier}`;else u+=`(?:${t}${s})${n.modifier}`}if(o)s||(u+=`${c}?`),u+=n.endsWith?`(?=${p})`:"$";else{const e=t[t.length-1],n="string"==typeof e?c.indexOf(e[e.length-1])>-1:void 0===e;s||(u+=`(?:${c}(?=${p}))?`),n||(u+=`(?=${c}|${p})`)}return new RegExp(u,a(n))}function h(t,e,n){return t instanceof RegExp?function(t,e){if(!e)return t;const n=/\((?:\?<(.*?)>)?(?!\?)/g;let s=0,r=n.exec(t.source);for(;r;)e.push({name:r[1]||s++,prefix:"",suffix:"",modifier:"",pattern:""}),r=n.exec(t.source);return t}(t,e):Array.isArray(t)?function(t,e,n){const s=t.map((t=>h(t,e,n).source));return new RegExp(`(?:${s.join("|")})`,a(n))}(t,e,n):function(t,e,n){return o(r(t,n),e,n)}(t,e,n)}var p={delimiter:"",prefixes:"",sensitive:!0,strict:!0},c={delimiter:".",prefixes:"",sensitive:!0,strict:!0},u={delimiter:"/",prefixes:"/",sensitive:!0,strict:!0};function f(t,e){return t.startsWith(e)?t.substring(e.length,t.length):t}function l(t){return!(!t||t.length<2||"["!==t[0]&&("\\"!==t[0]&&"{"!==t[0]||"["!==t[1]))}var m=["ftp","file","http","https","ws","wss"];function d(t){if(!t)return!0;for(const e of m)if(t.test(e))return!0;return!1}function g(t){switch(t){case"ws":case"http":return"80";case"wws":case"https":return"443";case"ftp":return"21";default:return""}}function x(t){if(""===t)return t;if(/^[-+.A-Za-z0-9]*$/.test(t))return t.toLowerCase();throw new TypeError(`Invalid protocol '${t}'.`)}function S(t){if(""===t)return t;const e=new URL("https://example.com");return e.username=t,e.username}function w(t){if(""===t)return t;const e=new URL("https://example.com");return e.password=t,e.password}function k(t){if(""===t)return t;if(/[\t\n\r #%/:<>?@[\]^\\|]/g.test(t))throw new TypeError(`Invalid hostname '${t}'`);const e=new URL("https://example.com");return e.hostname=t,e.hostname}function y(t){if(""===t)return t;if(/[^0-9a-fA-F[\]:]/g.test(t))throw new TypeError(`Invalid IPv6 hostname '${t}'`);return t.toLowerCase()}function P(t){if(""===t)return t;if(/^[0-9]*$/.test(t)&&parseInt(t)<=65535)return t;throw new TypeError(`Invalid port '${t}'.`)}function R(t){if(""===t)return t;const e=new URL("https://example.com");return e.pathname="/"!==t[0]?"/-"+t:t,"/"!==t[0]?e.pathname.substring(2,e.pathname.length):e.pathname}function b(t){return""===t?t:new URL(`data:${t}`).pathname}function $(t){if(""===t)return t;const e=new URL("https://example.com");return e.search=t,e.search.substring(1,e.search.length)}function I(t){if(""===t)return t;const e=new URL("https://example.com");return e.hash=t,e.hash.substring(1,e.hash.length)}var C=["protocol","username","password","hostname","port","pathname","search","hash"],E="*";function L(t,e){if("string"!=typeof t)throw new TypeError("parameter 1 is not of type 'string'.");const n=new URL(t,e);return{protocol:n.protocol.substring(0,n.protocol.length-1),username:n.username,password:n.password,hostname:n.hostname,port:n.port,pathname:n.pathname,search:""!=n.search?n.search.substring(1,n.search.length):void 0,hash:""!=n.hash?n.hash.substring(1,n.hash.length):void 0}}function v(t,e,n){let s;if("string"==typeof e.baseURL)try{s=new URL(e.baseURL),t.protocol=s.protocol?s.protocol.substring(0,s.protocol.length-1):"",t.username=s.username,t.password=s.password,t.hostname=s.hostname,t.port=s.port,t.pathname=s.pathname,t.search=s.search?s.search.substring(1,s.search.length):"",t.hash=s.hash?s.hash.substring(1,s.hash.length):""}catch{throw new TypeError(`invalid baseURL '${e.baseURL}'.`)}if("string"==typeof e.protocol&&(t.protocol=function(t,e){var n;return t=(n=t).endsWith(":")?n.substr(0,n.length-1):n,e||""===t?t:x(t)}(e.protocol,n)),"string"==typeof e.username&&(t.username=function(t,e){if(e||""===t)return t;const n=new URL("https://example.com");return n.username=t,n.username}(e.username,n)),"string"==typeof e.password&&(t.password=function(t,e){if(e||""===t)return t;const n=new URL("https://example.com");return n.password=t,n.password}(e.password,n)),"string"==typeof e.hostname&&(t.hostname=function(t,e){return e||""===t?t:l(t)?y(t):k(t)}(e.hostname,n)),"string"==typeof e.port&&(t.port=function(t,e,n){return g(e)===t&&(t=""),n||""===t?t:P(t)}(e.port,t.protocol,n)),"string"==typeof e.pathname){if(t.pathname=e.pathname,s&&!function(t,e){return!(!t.length||"/"!==t[0]&&(!e||t.length<2||"\\"!=t[0]&&"{"!=t[0]||"/"!=t[1]))}(t.pathname,n)){const e=s.pathname.lastIndexOf("/");e>=0&&(t.pathname=s.pathname.substring(0,e+1)+t.pathname)}t.pathname=function(t,e,n){if(n||""===t)return t;if(e&&!m.includes(e))return new URL(`${e}:${t}`).pathname;const s="/"==t[0];return t=new URL(s?t:"/-"+t,"https://example.com").pathname,s||(t=t.substring(2,t.length)),t}(t.pathname,t.protocol,n)}return"string"==typeof e.search&&(t.search=function(t,e){if(t=f(t,"?"),e||""===t)return t;const n=new URL("https://example.com");return n.search=t,n.search?n.search.substring(1,n.search.length):""}(e.search,n)),"string"==typeof e.hash&&(t.hash=function(t,e){if(t=f(t,"#"),e||""===t)return t;const n=new URL("https://example.com");return n.hash=t,n.hash?n.hash.substring(1,n.hash.length):""}(e.hash,n)),t}function A(t){return t.replace(/([+*?:{}()\\])/g,"\\$1")}function T(t,e){const n=`[^${s=e.delimiter||"/#?",s.replace(/([.+*?^${}()[\]|/\\])/g,"\\$1")}]+?`;var s;const r=/[$_\u200C\u200D\p{ID_Continue}]/u;let i="";for(let s=0;s<t.length;++s){const a=t[s],o=s>0?t[s-1]:null,h=s<t.length-1?t[s+1]:null;if("string"==typeof a){i+=A(a);continue}if(""===a.pattern){if(""===a.modifier){i+=A(a.prefix);continue}i+=`{${A(a.prefix)}}${a.modifier}`;continue}const p="number"!=typeof a.name,c=void 0!==e.prefixes?e.prefixes:"./";let u=""!==a.suffix||""!==a.prefix&&(1!==a.prefix.length||!c.includes(a.prefix));if(!u&&p&&a.pattern===n&&""===a.modifier&&h&&!h.prefix&&!h.suffix)if("string"==typeof h){const t=h.length>0?h[0]:"";u=r.test(t)}else u="number"==typeof h.name;if(!u&&""===a.prefix&&o&&"string"==typeof o&&o.length>0){const t=o[o.length-1];u=c.includes(t)}u&&(i+="{"),i+=A(a.prefix),p&&(i+=`:${a.name}`),".*"===a.pattern?p||o&&"string"!=typeof o&&!o.modifier&&!u&&""===a.prefix?i+="(.*)":i+="*":a.pattern===n?p||(i+=`(${n})`):i+=`(${a.pattern})`,a.pattern===n&&p&&""!==a.suffix&&r.test(a.suffix[0])&&(i+="\\"),i+=A(a.suffix),u&&(i+="}"),i+=a.modifier}return i}var U=class{constructor(t={},e){this.regexp={},this.keys={},this.component_pattern={};try{if("string"==typeof t){const n=new class{constructor(t){this.tokenList=[],this.internalResult={},this.tokenIndex=0,this.tokenIncrement=1,this.componentStart=0,this.state=0,this.groupDepth=0,this.hostnameIPv6BracketDepth=0,this.shouldTreatAsStandardURL=!1,this.input=t}get result(){return this.internalResult}parse(){for(this.tokenList=s(this.input,!0);this.tokenIndex<this.tokenList.length;this.tokenIndex+=this.tokenIncrement){if(this.tokenIncrement=1,"END"===this.tokenList[this.tokenIndex].type){if(0===this.state){this.rewind(),this.isHashPrefix()?this.changeState(9,1):this.isSearchPrefix()?(this.changeState(8,1),this.internalResult.hash=""):(this.changeState(7,0),this.internalResult.search="",this.internalResult.hash="");continue}if(2===this.state){this.rewindAndSetState(5);continue}this.changeState(10,0);break}if(this.groupDepth>0){if(!this.isGroupClose())continue;this.groupDepth-=1}if(this.isGroupOpen())this.groupDepth+=1;else switch(this.state){case 0:this.isProtocolSuffix()&&(this.internalResult.username="",this.internalResult.password="",this.internalResult.hostname="",this.internalResult.port="",this.internalResult.pathname="",this.internalResult.search="",this.internalResult.hash="",this.rewindAndSetState(1));break;case 1:if(this.isProtocolSuffix()){this.computeShouldTreatAsStandardURL();let t=7,e=1;this.shouldTreatAsStandardURL&&(this.internalResult.pathname="/"),this.nextIsAuthoritySlashes()?(t=2,e=3):this.shouldTreatAsStandardURL&&(t=2),this.changeState(t,e)}break;case 2:this.isIdentityTerminator()?this.rewindAndSetState(3):(this.isPathnameStart()||this.isSearchPrefix()||this.isHashPrefix())&&this.rewindAndSetState(5);break;case 3:this.isPasswordPrefix()?this.changeState(4,1):this.isIdentityTerminator()&&this.changeState(5,1);break;case 4:this.isIdentityTerminator()&&this.changeState(5,1);break;case 5:this.isIPv6Open()?this.hostnameIPv6BracketDepth+=1:this.isIPv6Close()&&(this.hostnameIPv6BracketDepth-=1),this.isPortPrefix()&&!this.hostnameIPv6BracketDepth?this.changeState(6,1):this.isPathnameStart()?this.changeState(7,0):this.isSearchPrefix()?this.changeState(8,1):this.isHashPrefix()&&this.changeState(9,1);break;case 6:this.isPathnameStart()?this.changeState(7,0):this.isSearchPrefix()?this.changeState(8,1):this.isHashPrefix()&&this.changeState(9,1);break;case 7:this.isSearchPrefix()?this.changeState(8,1):this.isHashPrefix()&&this.changeState(9,1);break;case 8:this.isHashPrefix()&&this.changeState(9,1)}}}changeState(t,e){switch(this.state){case 0:case 2:case 10:break;case 1:this.internalResult.protocol=this.makeComponentString();break;case 3:this.internalResult.username=this.makeComponentString();break;case 4:this.internalResult.password=this.makeComponentString();break;case 5:this.internalResult.hostname=this.makeComponentString();break;case 6:this.internalResult.port=this.makeComponentString();break;case 7:this.internalResult.pathname=this.makeComponentString();break;case 8:this.internalResult.search=this.makeComponentString();break;case 9:this.internalResult.hash=this.makeComponentString()}this.changeStateWithoutSettingComponent(t,e)}changeStateWithoutSettingComponent(t,e){this.state=t,this.componentStart=this.tokenIndex+e,this.tokenIndex+=e,this.tokenIncrement=0}rewind(){this.tokenIndex=this.componentStart,this.tokenIncrement=0}rewindAndSetState(t){this.rewind(),this.state=t}safeToken(t){return t<0&&(t=this.tokenList.length-t),t<this.tokenList.length?this.tokenList[t]:this.tokenList[this.tokenList.length-1]}isNonSpecialPatternChar(t,e){const n=this.safeToken(t);return n.value===e&&("CHAR"===n.type||"ESCAPED_CHAR"===n.type||"INVALID_CHAR"===n.type)}isProtocolSuffix(){return this.isNonSpecialPatternChar(this.tokenIndex,":")}nextIsAuthoritySlashes(){return this.isNonSpecialPatternChar(this.tokenIndex+1,"/")&&this.isNonSpecialPatternChar(this.tokenIndex+2,"/")}isIdentityTerminator(){return this.isNonSpecialPatternChar(this.tokenIndex,"@")}isPasswordPrefix(){return this.isNonSpecialPatternChar(this.tokenIndex,":")}isPortPrefix(){return this.isNonSpecialPatternChar(this.tokenIndex,":")}isPathnameStart(){return this.isNonSpecialPatternChar(this.tokenIndex,"/")}isSearchPrefix(){if(this.isNonSpecialPatternChar(this.tokenIndex,"?"))return!0;if("?"!==this.tokenList[this.tokenIndex].value)return!1;const t=this.safeToken(this.tokenIndex-1);return"NAME"!==t.type&&"PATTERN"!==t.type&&"CLOSE"!==t.type&&"ASTERISK"!==t.type}isHashPrefix(){return this.isNonSpecialPatternChar(this.tokenIndex,"#")}isGroupOpen(){return"OPEN"==this.tokenList[this.tokenIndex].type}isGroupClose(){return"CLOSE"==this.tokenList[this.tokenIndex].type}isIPv6Open(){return this.isNonSpecialPatternChar(this.tokenIndex,"[")}isIPv6Close(){return this.isNonSpecialPatternChar(this.tokenIndex,"]")}makeComponentString(){const t=this.tokenList[this.tokenIndex],e=this.safeToken(this.componentStart).index;return this.input.substring(e,t.index)}computeShouldTreatAsStandardURL(){const t={};Object.assign(t,p),t.encodePart=x;const e=h(this.makeComponentString(),void 0,t);this.shouldTreatAsStandardURL=d(e)}}(t);if(n.parse(),t=n.result,e){if("string"!=typeof e)throw new TypeError("'baseURL' parameter is not of type 'string'.");t.baseURL=e}else if("string"!=typeof t.protocol)throw new TypeError("A base URL must be provided for a relative constructor string.")}else if(e)throw new TypeError("parameter 1 is not of type 'string'.");if(!t||"object"!=typeof t)throw new TypeError("parameter 1 is not of type 'string' and cannot convert to dictionary.");const n={pathname:E,protocol:E,username:E,password:E,hostname:E,port:E,search:E,hash:E};let i;for(i of(this.pattern=v(n,t,!0),g(this.pattern.protocol)===this.pattern.port&&(this.pattern.port=""),C)){if(!(i in this.pattern))continue;const t={},e=this.pattern[i];switch(this.keys[i]=[],i){case"protocol":Object.assign(t,p),t.encodePart=x;break;case"username":Object.assign(t,p),t.encodePart=S;break;case"password":Object.assign(t,p),t.encodePart=w;break;case"hostname":Object.assign(t,c),l(e)?t.encodePart=y:t.encodePart=k;break;case"port":Object.assign(t,p),t.encodePart=P;break;case"pathname":d(this.regexp.protocol)?(Object.assign(t,u),t.encodePart=R):(Object.assign(t,p),t.encodePart=b);break;case"search":Object.assign(t,p),t.encodePart=$;break;case"hash":Object.assign(t,p),t.encodePart=I}try{const n=r(e,t);this.regexp[i]=o(n,this.keys[i],t),this.component_pattern[i]=T(n,t)}catch{throw new TypeError(`invalid ${i} pattern '${this.pattern[i]}'.`)}}}catch(t){throw new TypeError(`Failed to construct 'URLPattern': ${t.message}`)}}test(t={},e){let n,s={pathname:"",protocol:"",username:"",password:"",hostname:"",port:"",search:"",hash:""};if("string"!=typeof t&&e)throw new TypeError("parameter 1 is not of type 'string'.");if(void 0===t)return!1;try{s=v(s,"object"==typeof t?t:L(t,e),!1)}catch(t){return!1}for(n in this.pattern)if(!this.regexp[n].exec(s[n]))return!1;return!0}exec(t={},e){let n={pathname:"",protocol:"",username:"",password:"",hostname:"",port:"",search:"",hash:""};if("string"!=typeof t&&e)throw new TypeError("parameter 1 is not of type 'string'.");if(void 0===t)return;try{n=v(n,"object"==typeof t?t:L(t,e),!1)}catch(t){return null}let s,r={};for(s in r.inputs=e?[t,e]:[t],this.pattern){let t=this.regexp[s].exec(n[s]);if(!t)return null;let e={};for(let[n,r]of this.keys[s].entries())if("string"==typeof r.name||"number"==typeof r.name){let s=t[n+1];e[r.name]=s}r[s]={input:n[s]||"",groups:e}}return r}get protocol(){return this.component_pattern.protocol}get username(){return this.component_pattern.username}get password(){return this.component_pattern.password}get hostname(){return this.component_pattern.hostname}get port(){return this.component_pattern.port}get pathname(){return this.component_pattern.pathname}get search(){return this.component_pattern.search}get hash(){return this.component_pattern.hash}};globalThis.URLPattern||(globalThis.URLPattern=U),window.URLPattern=U})();{var iGLUI;Class((function AppState(_default){this.map=new Map,this.bindings=new Map,_default&&this.setAll(_default);const prototype=AppState.prototype;void 0===prototype.set&&(prototype.set=function(key,value,force){if(this.readonly)return console.warn("This AppState is locked and can not make changes");this.map.set(key,value),this.onUpdate&&this.onUpdate(key,value);let array=this.bindings.get(key);if(array){let len=array.length;for(let i=0;i<len;i++){let b=array[i];b&&b.update?b.update(key,value,force):(array.splice(i,1),i-=1,len=array.length)}}},prototype.get=function(key){return this.map.get(key)},prototype.getMap=function(){return this.map},prototype.toJSON=function(){return Object.fromEntries(this.map)},prototype.bind=function(keys,...rest){const _this=this;if(!rest.length)return{state:_this,key:keys};Array.isArray(keys)||(keys=[keys]);const obj=1===rest.length?rest[0]:rest;let binding=new StateBinding(keys,obj,this);return keys.forEach((key=>{_this.bindings.has(key)?_this.bindings.get(key).push(binding):_this.bindings.set(key,[binding]);let value=_this.map.get(key);void 0!==value&&binding.update(key,value)})),binding},prototype.createLocal=function(obj,fixProps){if(fixProps)for(let key in obj){let val=obj[key];"true"===val&&(obj[key]=!0),"false"===val&&(obj[key]=!1),isNaN(val)||(obj[key]=Number(val))}let appState=new AppState(obj);return new Proxy(appState,{set:(target,property="",value)=>(property.includes(["origin","onUpdate"])?appState[property]=value:appState.set(property,value),!0),get:(target,property)=>target[property]?target[property]:appState.get(property)})},prototype.setAll=function(obj){const _this=this;for(let key in obj)_this.set(key,obj[key])},prototype.lock=function(){this.readonly=!0},prototype.unlock=function(){this.readonly=!1},prototype.clearKeysMatching=function(str){let keys=this.map.keys();for(let key of keys)key.startsWith(str)&&this.map.delete(key)},prototype.isAppState=!0)}),"static");class StateBinding{constructor(_keys,_obj,_ref){if(this._keys=_keys,this._obj=_obj,this._string="",this._oldValue="",this._type="",this._bindingLookup="",this._onDestroy,this._ref=_ref,void 0===iGLUI&&(iGLUI=!!window.GLUI),_obj instanceof HTMLElement)"INPUT"==_obj.nodeName?this._string=_obj.value:this._string=_obj.innerText,this._type="HTMLElement";else if(_obj instanceof DOMAttribute)this._string=_obj.value,this._name=_obj.name,this._belongsTo=_obj.belongsTo,this._bindingLookup=_obj.bindingLookup,this._type="DOMAttribute";else if("function"==typeof Sprite&&_obj instanceof Sprite)this._string=_obj.id,this._type="Sprite";else if(_obj instanceof HydraObject)"input"==_obj._type?this._string=_obj.val():this._string=_obj.text(),this._type="HydraObject";else if(iGLUI&&_obj instanceof GLUIText)this._string=_obj.getTextString(),this._type="GLUIText";else if(_obj.createLocal&&(this._type="appState"),_obj.onStateChange&&(this._type="class"),"function"==typeof _obj&&(this._type="function"),Array.isArray(_obj)&&_obj.every((el=>"function"==typeof el))){this._type="piped";const lastFunctionInChain=this._obj.pop();this._operators=this._obj,this._obj=lastFunctionInChain,this._count=0}}parse(key,value){if(!this._string||!this._string.includes("@["))return value;const _this=this;let string=this._string;return this._keys.forEach((key=>{string=string.replace(`@[${key}]`,_this._ref.get(key))})),string}async operateOnValue(value){return await this._operators.reduce((async(prev,fn)=>{const prevResolved=await prev;return(await fn)(prevResolved,this._count++,this)}),value)}update(key,value,force){let newValue=this.parse(key,value);if(!(newValue!==this._oldValue||value&&value.push||force))return;let oldValue=this._oldValue;this._oldValue=newValue;try{switch(this._type){case"HTMLElement":"input"==this._obj._type?this._obj.value=newValue:this._obj.innerText=newValue;break;case"DOMAttribute":this._obj.belongsTo.setAttribute(this._obj.name,this._obj.value.replace(this._obj.bindingLookup,newValue));break;case"Sprite":this._obj.id=newValue;break;case"HydraObject":"input"==this._obj._type?this._obj.val(newValue):this._obj.text(newValue);break;case"GLUIText":this._obj.setText(newValue);break;case"function":this._obj(value,oldValue);break;case"piped":this.operateOnValue(value).then((val=>this._obj(val)),(reject=>null));break;case"class":this._obj.onStateChange(value);break;case"appState":this._obj.set(key,value)}}catch(err){throw console.error("AppState binding failed to execute. You should probably be using _this.bindState instead"),console.error(err),err}return!0}_bindOnDestroy(cb){this._onDestroy||(this._onDestroy=[]),this._onDestroy.push(cb)}destroy(){this._onDestroy&&this._onDestroy.forEach((cb=>cb())),this._keys=null,this._obj=null,this._string=null,this._oldValue=null,this._type=null,this._operators=null,this._count=null,this.update=null}}window.StateBinding=StateBinding}Class((function AppStateOperators(_default){Inherit(this,Component),this.map=fn=>value=>fn(value),this.tap=fn=>value=>(fn(value),value),this.filter=fn=>(value,emittedCount)=>fn(value,emittedCount)?value:Promise.reject(),this.skip=skipCount=>this.filter(((_,emittedCount)=>skipCount<=emittedCount)),this.untilDestroyed=ctx=>{let checked=!1;return(value,_,binding)=>(checked||(checked=!0,ctx._bindOnDestroy((_=>{Hydra.LOCAL&&console.log("binding destroyed "),binding.destroy?.()}))),value)}}),"static"),Class((function AppStore(){const _this=this;this.state=AppState.createLocal();const _mutations={},_actions={};let _subscribers=[],_actionSubscribers=[];function registerMutation(type,handler){(_mutations[type]||(_mutations[type]=[])).push((function wrappedMutationHandler(payload){handler.call(_this,_this.state,payload)}))}function registerAction(type,handler){(_actions[type]||(_actions[type]=[])).push((function wrappedActionHandler(payload){let res=handler.call(_this,{dispatch:_this.dispatch,commit:_this.commit,state:_this.state,rootState:_this.state},payload);return function isPromise(val){return val&&"function"==typeof val.then}(res)||(res=Promise.resolve(res)),res}))}function genericSubscribe(fn,subscribers,options){return subscribers.indexOf(fn)<0&&(options&&options.prepend?subscribers.unshift(fn):subscribers.push(fn)),()=>{const i=subscribers.indexOf(fn);i>-1&&subscribers.splice(i,1)}}this.createAppStore=function(_params){!function setInitState(_params){const{state:state}=_params;for(let key in state)_this.state.set(key,state[key])}(_params),function mapMutations(_params){const{mutations:mutations}=_params;for(let key in mutations)registerMutation(key,mutations[key])}(_params),function mapActions(_params){const{actions:actions}=_params;for(let key in actions)registerAction(key,actions[key])}(_params)},this.commit=function(type,payload){const mutation={type:type,payload:payload},entry=_mutations[type];entry?(entry.forEach((function commitIterator(handler){handler(payload)})),_subscribers.slice().forEach((sub=>sub(mutation,this.state)))):Hydra.LOCAL&&console.error(`Error: no mutation for type ${type}`)},this.dispatch=function(type,payload){const action={type:type,payload:payload},entry=_actions[type];entry||Hydra.LOCAL&&console.error(`Error: no action for type ${type}`);try{_actionSubscribers.slice().filter((sub=>sub.before)).forEach((sub=>sub.before(action,_this.state)))}catch(e){Hydra.LOCAL&&(console.warn("Error in before action subscribers: "),console.error(e))}const result=entry.length>1?Promise.all(entry.map((handler=>handler(payload)))):entry[0](payload);return new Promise(((resolve,reject)=>{result.then((res=>{try{_actionSubscribers.filter((sub=>sub.after)).forEach((sub=>sub.after(action,_this.state)))}catch(e){Hydra.LOCAL&&(console.warn("Error in after action subscribers: "),console.error(e))}resolve(res)}),(error=>{try{_actionSubscribers.filter((sub=>sub.error)).forEach((sub=>sub.error(action,_this.state,error)))}catch(e){Hydra.LOCAL&&(console.warn("Error in error action subscribers: "),console.error(e))}reject(error)}))}))},this.subscribeAction=function(key,fn,options){let subs={};return"function"==typeof fn?subs.before=function subscriberEmptyBeforeWrapper(action){action.type===key&&fn(action)}:(fn.before&&(subs.before=function subscriberBeforeWrapper(action){action.type===key&&fn.before(action)}),fn.after&&(subs.after=function subscriberAfterWrapper(action){action.type===key&&fn.after(action)})),genericSubscribe(subs,_actionSubscribers,options)},this.subscribe=function(key,fn,options){return genericSubscribe((function subscriberWrapper(mutation){mutation.type===key&&fn(mutation)}),_subscribers,options)},this.bind=this.state.bind,this.map=this.state.map,this.bindings=this.state.bindings,this.watch=this.state.bind,this.get=this.state.get})),Class((function StateArray(_src=[],_filterFn=null){Inherit(this,Events);const _this=this;var _data=[];function wrap(obj){if("object"!=typeof obj||Array.isArray(obj))throw"StateArray entries must be {objects}!";if(obj._uid||(obj._uid=Utils.uuid()),obj.createLocal)return obj;let state=AppState.createLocal(obj);return state.origin=obj,state}if(Object.defineProperty(_this,"length",{get:function(){return _data.length}}),this.setFilter=function(fn,refresh=!0){_filterFn=fn,refresh&&this.refresh(_data.filter(fn))},this.push=function(obj){if(_filterFn&&!_filterFn(obj))return;let state=wrap(obj);return _data.push(state),function setInterfaceAtIndex(index){void 0===_this[index]&&Object.defineProperty(_this,index,{set:function(v){for(let key in v)_data[index].set(key,v[key])},get:function(){return _data[index]}})}(_data.length-1),_this.events.fire(Events.UPDATE,{type:"add",state:state}),state},this.remove=function(obj){for(let i=0;i<_data.length;i++){let state=_data[i];state.origin!==obj&&state!==obj||(_data.splice(i,1),_this.events.fire(Events.UPDATE,{type:"remove",state:state},!0))}},this.update=async function(obj){var _found=!1;for(let i=0;i<_data.length;i++){var state=_data[i];if(state.origin._uid===obj._uid||state._uid===obj._uid)return await state.setAll(obj),_this.events.fire(Events.UPDATE,{type:"modify",state:state,index:i}),_found=!0}return _found},this.forEach=function(cb){_data.forEach((function(...args){return cb.apply(this,args)}))},this.find=function(cb){return _data.find((function(...args){return cb.apply(this,args)}))},this.insertAtIdx=function(idx,obj){if(obj._uid||(obj=wrap(obj)),!_data[Math.abs(idx)])throw"There is no item at index "+idx+" in this StateArray";_data.splice(idx,0,obj);const newData=_data.filter((()=>!0));this.refresh(newData)},this.map=function(cb){let array=[];return _data.forEach((function(...args){return array.push(cb.apply(this,args))})),array},this.find=function(cb){return _data.find((function(...args){return cb.apply(this,args)}))},this.toJSON=function(){let array=[];return _data.forEach((appState=>{array.push(appState.toJSON())})),array},this.getMap=function(){let array=[];return _data.forEach((appState=>{array.push(appState.getMap())})),array},this.indexOf=function(obj){for(let i=0;i<_data.length;i++){let state=_data[i];if(state.origin===obj||state===obj)return i}},this.refresh=function(array){Array.isArray(array)||array instanceof StateArray||(array=[array]),_this.events.fire(StateArray.REFRESH,{type:"refresh"},!0);let i=_data.length;for(;i--;){let state=_data.pop();_this.events.fire(Events.UPDATE,{type:"remove",state:state},!0)}_data.length=0,array.forEach(_this.push)},this.sort=function(cb){let array=[];_data.forEach((d=>array.push(d))),array.sort(cb),_this.refresh(array)},this.includes=function(obj){return this.indexOf(obj)>-1},this.reflow=function(){this.refresh(_data.map((d=>d.origin)))},!Array.isArray(_src))throw"StateArray can only take an array as a parameter";_src.forEach(_this.push)}),(_=>{StateArray.REFRESH="state_array_refresh"})),Class((function ViewState(ViewClass,...rest){Inherit(this,Component);const _this=this;var _stateArray,_params,_dynamicViewClass,_callbacks={},_bindings=[],_removals=[];"object"==typeof ViewClass&&ViewClass.view&&(ViewClass=(_params=ViewClass).view,rest=[_params],delete _params.view,_this.listen=function(key,callback){_bindings.push(key),_callbacks[key]=callback},_this.onAddView=_params.onAddView,_this.onRemoveView=_params.onRemoveView),"function"==typeof ViewClass&&_this.parent.contexts&&(_dynamicViewClass=!0),"string"==typeof ViewClass&&(ViewClass=window[ViewClass]);var _instances=this.views=[];function remove(data){_this.animating=!0;for(let i=0;i<_instances.length;i++){let inst=_instances[i];if(data==inst.data){let promise=_this.onRemoveView?.(inst,i)||inst.onRemoveView?.(i);promise&&promise.then&&(_removals.push(promise),_this.disableAutoDestroy||promise.then((_=>inst.destroy?.()))),_instances.splice(i,1),0===_instances.length&&_this.onEmpty?.(),promise&&promise.then||_this.disableAutoDestroy||!inst.destroy||inst.destroy();break}}if(ViewState.clearScheduled(data,_this),_removals.length){let removals=_removals.slice();Promise.all(removals).then((_=>{removals.forEach((removal=>{_removals.remove(removal)})),0===_removals.length&&(_this.animating=!1)}))}}async function dataUpdate(e){switch(e.type){case"add":for(;_removals.length;)await Promise.all(_removals);_this.dataFilter(e.state)&&ViewState.schedule(_this,_dynamicViewClass?ViewClass(e.state):ViewClass,e.state,_stateArray.indexOf(e.state),rest);break;case"remove":remove(e.state);break;case"modify":_this.dataFilter(e.state)?function update(data,index){var _exists=!1;for(let i=0;i<_instances.length;i++){let inst=_instances[i];if(data._uid===inst.data._uid)return _this.onUpdateView?.(_instances[i],i),void(_exists=!0)}_exists||ViewState.schedule(_this,_dynamicViewClass?ViewClass(data):ViewClass,data,_stateArray.indexOf(data))}(e.state,e.index):remove(e.state)}}this.hmr=function(view){ViewClass=window[view],this.setSourceData(_stateArray)},this.setSourceData=function(array){if(!Array.isArray(array)||array instanceof StateArray||(array=new StateArray(array)),!(array instanceof StateArray||Array.isArray(array)))throw"ViewState::setSourceData must be instance of StateArray";_stateArray=_this.stateArray=array,_this.events.sub(array,Events.UPDATE,dataUpdate),array.forEach((state=>{_this.dataFilter(state)&&ViewState.schedule(_this,_dynamicViewClass?ViewClass(state):ViewClass,state,_stateArray.indexOf(state),rest)}))},this.dataFilter=function(data){return!0},this.onInitialize=function(instance){let unfilteredIndex=_stateArray.indexOf(instance.data),filteredIndex=-1;for(let i=0;i<_instances.length;++i){let data=_instances[i].data;if(_stateArray.indexOf(data)>unfilteredIndex){filteredIndex=i;break}}if(filteredIndex<0&&(filteredIndex=_instances.length),instance.element&&_this.parent.element&&_this.parent.element.add){let before=null;filteredIndex<_instances.length&&_instances[filteredIndex].element&&(before=_instances[filteredIndex]),_this.parent.element.add(instance.element,before)}_instances.splice(filteredIndex,0,instance),_this.listen&&instance.state&&_bindings.forEach((key=>{_this.bindState(instance.state,key,(data=>{_callbacks[key]?.({target:instance,data:data})}))})),_params?.__parent&&_params.__parent.add(instance),(instance.group||instance.mesh)&&_this.parent.group?.add(instance.group||instance.mesh),_this.onAddView?.(instance,filteredIndex)},_params?.data&&this.setSourceData(_params.data),_params?.wait_data&&_params.wait_data.then((data=>{_params.data=data,_this.setSourceData(data)}))}),(_=>{const queue=[],worker=new Render.Worker((_=>{let obj=queue.shift();if(obj){let{ref:ref,ViewClass:ViewClass,data:data,index:index,additionalArgs:additionalArgs}=obj;if(!ref.initClass)return;let args=[];additionalArgs.forEach((arg=>{args.push(...arg)}));let inst=ref.initClass(ViewClass,data,index,...args,null);inst.data=data,ref.onInitialize(inst)}else worker.pause()}),2);worker.pause(),ViewState.clearScheduled=function(data,ref){for(let i=0;i<queue.length;i++){let obj=queue[i];if(obj.data===data&&obj.ref==ref)return queue.splice(i,1)}},ViewState.schedule=function(ref,ViewClass,data,index,...rest){ref.initClass&&(queue.push({ref:ref,ViewClass:ViewClass,data:data,index:index,additionalArgs:rest}),worker.resume())}})),Class((function ViewStateElement(){this.viewStateElement=!0})),Class((function StateComponent(){const _this=this;let _mutationsUnsubscribers=[],_actionsUnsubscribers=[];this.unsubscribeMutations=function(){_mutationsUnsubscribers.forEach((u=>u()))},this.unsubscribeActions=function(){_actionsUnsubscribers.forEach((u=>u()))},this.unsubscribeAll=function(){_this.unsubscribeMutations(),_this.unsubscribeActions()},this.subscribeMutation=function(store,type,fn){_mutationsUnsubscribers.push(store.subscribe(type,fn))},this.subscribeAction=function(store,type,fn){_actionsUnsubscribers.push(store.subscribeAction(type,fn))},this.commit=function(store,type,payload){store.commit(type,payload)},this.dispatch=async function(store,type,payload){await store.dispatch(type,payload)},this.getState=function(store,key){return store.get(key)},this.watch=function(store,key,fn,callInitial=!0){let hasCalled=!1;const callback=params=>{hasCalled||callInitial?fn(params):hasCalled=!0};return _this.bindState?_this.bindState(store,key,callback):store.watch(key,callback)},this.bind=this.watch,"function"==typeof this._bindOnDestroy&&this._bindOnDestroy((()=>{_this.unsubscribeAll()}))})),Class((function Dev(){const _this=this;let _post,_inter,_timerName;Utils.timestamp();function postError(error){let device=getDebugInfo(),tests=getTests();post(_post+"&type=error",{error:error,device:device,tests:tests}).catch((function(){Hydra.LOCAL&&console.log("Error while posting to server")}))}function getDebugInfo(){return{gpu:Device.graphics.webgl?Device.graphics.webgl.gpu:"WEBGL UNAVAILABLE",version:Device.graphics.webgl?Device.graphics.webgl.version:"WEBGL UNAVAILABLE",tier:window.GPU&&window.GPU.initialized?Device.mobile?GPU.M_TIER:GPU.TIER:"",mobile:JSON.stringify(Device.mobile),userAgent:Device.agent,dpr:Device.pixelRatio,renderDPR:window.GPU&&window.GPU.initialized?RenderManager.DPR:"",screenSize:`${screen.width} x ${screen.height}`,stageSize:`${window.innerWidth} x ${window.innerHeight}`,href:window.location.href,targetFPS:Render.REFRESH_RATE}}function getTests(){let tests={};try{if(window.Tests)for(let key in Tests)"function"==typeof Tests[key]&&(tests[key]=Tests[key]())}catch(e){}return tests}function handleRenderCallbackError(info){console.error("Error in render callback",info)}_post="https://us-central1-at-services.cloudfunctions.net/logger?projectId="+window.UIL_ID,Events.emitter._addEvent(Render.RENDER_CALLBACK_ERROR,handleRenderCallbackError),this.catchErrors=function catchErrors(){window.onerror=function(message,file,line,column,e){postError({message:message,file:file,line:line,column:column,stack:e&&e.stack.toString()})},window.addEventListener("unhandledrejection",(e=>{postError({type:"unhandledrejection",message:e.reason.message,stack:e.reason.stack})})),Events.emitter._addEvent(Render.RENDER_CALLBACK_ERROR,(({callback:callback,error:error,component:component})=>{let name=callback.name;component&&(name=`${name} in ${Utils.getConstructorName(component)}`),postError({message:`Error in render callback ${name}: ${"string"==typeof error?error:error.message}`,file:error.fileName,line:error.lineNumber,column:error.columnNumber,stack:error.stack?.toString()})})),Events.emitter._removeEvent(Render.RENDER_CALLBACK_ERROR,handleRenderCallbackError)},this.emulator=Device.mobile&&navigator.platform&&navigator.platform.toLowerCase().includes(["mac","windows"]),this.expose=function(name,val,force){(Hydra.LOCAL||force)&&(window[name]=val)},this.unsupported=function(needsAlert){needsAlert&&alert("Hi! This build is not yet ready for this device, things may not work as expected. Refer to build schedule for when this device will be supported.")},this.checkForLeaks=function(flag,array){if(window.AURA)return;let exceptions=["_ga","_typeface_js","_xdc_","_babelPolyfill","$jscomp"];window.HYDRA_LEAKS_EXCEPTIONS&&(exceptions=exceptions.concat(window.HYDRA_LEAKS_EXCEPTIONS));var matchArray=function(prop){if(!array)return!1;for(var i=0;i<array.length;i++)if(prop.includes(array[i]))return!0;return!1};clearInterval(_inter),flag&&(_inter=setInterval((function(){for(var prop in window)if(!prop.includes("webkit")){var obj;try{obj=window[prop]}catch(e){}if(obj&&"function"!=typeof obj&&prop.length>2){if(prop.includes(exceptions)||matchArray(prop))continue;var char1=prop.charAt(0),char2=prop.charAt(1);if(("_"==char1||"$"==char1)&&char2!==char2.toUpperCase())throw console.log(window[prop]),"Hydra Warning:: "+prop+" leaking into global scope"}}}),1e3))},this.postErrorsToServer=_=>{},this.postPerfLog=function(perf){let device=getDebugInfo(),tests=getTests();post(_post+"&type=perf",{perf:perf,device:device,tests:tests}).catch((function(){Hydra.LOCAL&&console.log("Error whle posting to server")}))},this.startTimer=function(name){_timerName=name||"Timer",console.time&&!window._NODE_?console.time(_timerName):_timer=performance.now()},this.stopTimer=function(){console.time&&!window._NODE_?console.timeEnd(_timerName):console.log("Render "+_timerName+": "+(performance.now()-_timer))},this.writeFile=function(file,data){let promise=Promise.create(),protocol=location.protocol,port="https:"===protocol?":8018":":8017",url=protocol+"//"+location.hostname+port+(_this.filesPath||location.pathname)+file;return post(url,data,{headers:{"content-type":"text/plain"}}).then((e=>{"OK"!=e?(console.warn(`Unable to write to ${file}`),promise.reject()):promise.resolve()})),promise},this.execUILScript=async function(name,data){if(!Hydra.LOCAL)return;let url=`${location.protocol}//${location.hostname}:8017${_this.pathName||location.pathname}/uil/${name}`,response=await post(url,data,{headers:{"Content-Type":"text/plain"}});if("ERROR"===response||!1===response.success)throw response;return response},this.auditCompressedTextures=function(){let compressedKeys=[],changes=0;UILStorage.getKeys().forEach((key=>{let element=UILStorage.get(key);if("string"==typeof element){let json;try{json=JSON.parse(element),json.src&&(!0===json.compressed?console.warn(`The texture ${json.src} is a ktx1 asset. Please convert it to ktx2.`):"ktx2"===json.compressed&&compressedKeys.push({key:key,src:json.src.split("?")[0]}))}catch(e){}}})),UILStorage.getKeys().forEach((key=>{let element=UILStorage.get(key);if("string"==typeof element){let json;try{json=JSON.parse(element),json.src&&compressedKeys.find((el=>json.src.split("?")[0]===el.src.split("?")[0]))&&"ktx2"!==json.compressed&&(changes++,console.log(`Changed ${json.src.split("?")[0]} in ${key} to use ktx2 compression.`),UILStorage.set(key,JSON.stringify({...json,src:json.src.split("?")[0],compressed:"ktx2"})),_this.events.fire(UILControlImage.AUDIT))}catch(e){}}})),changes?console.warn("Changes to UIL from auditCompressedTextures will not be saved until saving UIL and refreshing. Use Cmd+S or Ctrl+S to save and refresh any open SceneLayouts."):console.log("auditCompressedTextures did not find any textures that had instances using both uncompressed and compressed versions.")},Hydra.LOCAL&&_this.checkForLeaks(!0)}),"static"),Class((function Service(){Inherit(this,Component);var _sw,_this=this;function getSWAssets(){if(!window.ASSETS.SW||_this.cached)return[];var assets=window.ASSETS.SW;return assets.forEach(((asset,i)=>{asset.includes(".js")&&(asset=assets[i].replace(".js",".js?"+window._CACHE_))})),assets}function handleRegistration(e){}function handleReady(e){_this.isReady=!0,_this.events.fire(Events.READY,e,!0),_sw=navigator.serviceWorker.controller,function checkCache(){Storage.get("service_cache")!=window._CACHE_&&_this.post("clearCache")}()}function handleError(e){e&&(_this.events.fire(Events.ERROR,e,!0),_this.active=!1)}function handleMessage(e){var data=e.data;data.evt&&_this.events.fire(data.evt,data)}this.active=!1,this.ready=!1,this.cached=!1,this.offline=!1,this.disabled=!1,this.ready=function(){return this.wait(this,"isReady")},this.init=function(){Hydra.ready((()=>{!("serviceWorker"in navigator)||Hydra.LOCAL&&""==location.port||window.process||_this.disabled||function initWorker(){_this.active=!0,navigator.serviceWorker.register(`${window._SW_PATH_?window._SW_PATH_:""}sw.js`).then(handleRegistration).then(handleReady).then(handleError)}()}))},this.cache=function(assets=[]){assets=Array.from(assets);_this.active&&_this.wait(_this,"ready",(function(){_this.post("upload",{assets:assets,cdn:Assets.CDN,hostname:location.hostname,sw:getSWAssets(),offline:_this.offline}),Storage.set("service_cache",window._CACHE_),_this.cached=!0}))},this.post=function(fn,data={}){if(!_this.active)return;_this.wait(_this,"ready",(function(){let mc=new MessageChannel;mc.port1.onmessage=handleMessage,data.fn=fn,_sw&&_sw.postMessage(data,[mc.port2])}))}}),"static"),Class((function Storage(){var _storage,_this=this,_sessionData={};function cookie(key,value,expires){var options;if(arguments.length>1&&(null===value||"object"!=typeof value)){if((options={}).path="/",options.expires=expires||1,null===value&&(options.expires=-1),"number"==typeof options.expires){var days=options.expires,t=options.expires=new Date;t.setDate(t.getDate()+days)}return document.cookie=[encodeURIComponent(key),"=",options.raw?String(value):encodeURIComponent(String(value)),options.expires?"; expires="+options.expires.toUTCString():"",options.path?"; path="+options.path:"",options.domain?"; domain="+options.domain:"",options.secure?"; secure":""].join("")}var result,decode=(options=value||{}).raw?function(s){return s}:decodeURIComponent;return(result=new RegExp("(?:^|; )"+encodeURIComponent(key)+"=([^;]*)").exec(document.cookie))?decode(result[1]):null}this.noTracking=!1,function testStorage(){try{if(window.localStorage)try{window.localStorage.test=1,window.localStorage.removeItem("test"),_storage=!0}catch(e){_storage=!1}else _storage=!1}catch(e){_storage=!1}}(),this.setCookie=function(key,value,expires){cookie(key,value,expires)},this.getCookie=function(key){return cookie(key)},this.set=function(key,value){_this.noTracking?_sessionData[key]=value:(null!=value&&"object"==typeof value&&(value=JSON.stringify(value)),_storage?null===value?window.localStorage.removeItem(key):window.localStorage[key]=value:cookie(key,value,365))},this.get=function(key){if(_this.noTracking)return _sessionData[key];var val,char0;(val=_storage?window.localStorage[key]:cookie(key))&&(val.charAt&&(char0=val.charAt(0)),"{"!=char0&&"["!=char0||(val=JSON.parse(val)),"true"!=val&&"false"!=val||(val="true"==val));return val}}),"Static"),Class((function Thread(_class){Inherit(this,Component);var _this=this,_worker,_callbacks,_path,_mvc,_msg={};function init(){let file=window._ES5_?"/hydra-thread-es5.js":"/hydra-thread.js";_callbacks={},_worker=new Worker(Thread.PATH+file)}function importClasses(){importClass(Utils),importClass(Component),importClass(Events),importClass(_class,!0),importES5()}function importClass(_class,scoped){if(_class){var code;if(scoped){for(code=(code=_class.toString().replace("{","!!!")).split("!!!")[1];code.includes("this.");){var name=code.slice(code.indexOf("this.")).split("this.")[1].split(/\s*=/)[0];code=code.replace("this","self"),createMethod(name)}code=(code=code.slice(0,-1)).replace(/_self/g,"_this")}else if("function"!=typeof _class){if((code=_class.constructor.toString()).includes("[native"))return;code=(_class._namespace?_class._namespace+".":"")+"Class("+code+', "static");'}else code=(_class._namespace?_class._namespace+".":"")+"Class("+_class.toString()+");";_worker.postMessage({code:code})}}function createMethod(name){_this[name]=function(message={},callback,buffer){let promise;return Array.isArray(callback)&&(buffer=callback,callback=void 0),Array.isArray(buffer)&&((message={msg:message,transfer:!0}).buffer=buffer),void 0===callback&&(promise=Promise.create(),callback=promise.resolve),_this.send(name,message,callback),promise}}function importES5(){window._ES5_&&(["_createSuper","_isNativeReflectConstruct"].forEach((name=>{let code=window[name].toString();code.includes("[native")||_worker.postMessage({code:code})})),_worker.postMessage({code:"function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o);};return _getPrototypeOf(o);}"}))}function addListeners(){_worker.addEventListener("message",workerMessage)}function workerMessage(e){if(e.data.console)console.log(e.data.message);else if(e.data.id){(callback=_callbacks[e.data.id])&&callback(e.data.message),delete _callbacks[e.data.id]}else if(e.data.emit){(callback=_callbacks[e.data.evt])&&callback(e.data.msg)}else{var callback;(callback=_callbacks.transfer)&&callback(e.data)}}init(),importClasses(),addListeners(),this.on=function(evt,callback){_callbacks[evt]=callback},this.off=function(evt){delete _callbacks[evt]},this.loadFunction=function(){let names=[];for(var i=0;i<arguments.length;i++)split=void 0,name=void 0,split=(code=(code=(code=arguments[i]).toString()).replace("(","!!!")).split("!!!"),name=split[0].split(" ")[1],code="self."+name+" = function("+split[1],_worker.postMessage({code:code}),createMethod(name),names.push(name);var code,split,name;return names},this.importScript=function(path){_worker.postMessage({path:Thread.absolutePath(path),importScript:!0})},this.importCode=function(code){_worker.postMessage({code:code})},this.importClass=function(){for(var i=0;i<arguments.length;i++){importClass(arguments[i])}},this.importModules=this.importModule=function(){for(var i=0;i<arguments.length;i++){let code=Modules.getConstructor(arguments[i]).toString();_worker.postMessage({code:`Module(${code})`})}},this.importES6Class=function(name){if(window._ES5_){let Class=window[name],base=Class.toString(),proto=[],sup,matches=/(_this\w+)\s*=\s*(_super\w+)\.call/g.exec(base);if(matches){let superVar=matches[2],superConstructor=Object.getPrototypeOf(Class);if(!superConstructor.toString().includes("[native")){let superName=Utils.getConstructorName(superConstructor);sup=`_inherits(${name}, ${superName}); var ${superVar} = _createSuper(${name});`}}Object.getOwnPropertyNames(Class.prototype).forEach((fn=>{"constructor"!=fn&&Class.prototype[fn]&&proto.push({key:fn,string:Class.prototype[fn].toString()})})),_worker.postMessage({es5:base,name:name,proto:proto,sup:sup})}else _worker.postMessage({es6:`(${eval(name)})`,name:name})},this.send=function(name,message,callback){if("string"==typeof name){(message=message||{}).fn=name}else callback=message,message=name;Thread.UNIQUE_ID>999999&&(Thread.UNIQUE_ID=1);var id=Thread.UNIQUE_ID++;callback&&(_callbacks[id]=callback),message.transfer?(message.msg.id=id,message.msg.fn=message.fn,message.msg.transfer=!0,_worker.postMessage(message.msg,message.buffer)):(_msg.message=message,_msg.id=id,_worker.postMessage(_msg))},this.onDestroy=function(){_worker.terminate&&_worker.terminate()}}),(()=>{var _shared;Thread.PATH=window._THREAD_PATH_||"assets/js/hydra",Thread.UNIQUE_ID=1,Thread.absolutePath=Hydra.absolutePath,Thread.cluster=function(){return new function(){let index=0,array=[];this.push=function(thread){array.push(thread)},this.get=function(){let thread=array[index];return index++,index>=array.length&&(index=0),thread},this.array=array}},Thread.upload=function(...args){let name;Thread.shared();for(let i=0;i<_shared.array.length;i++)name=_shared.array[i].loadFunction(...args);return name},Thread.uploadClass=function(...args){let name;Thread.shared();for(let i=0;i<_shared.array.length;i++)name=_shared.array[i].importClass(...args);return name},Thread.shared=function(list){if(!_shared){_shared=Thread.cluster();let hardware=navigator.hardwareConcurrency||4,count=Math.max(Math.min(hardware,8),4);for(let i=0;i<count;i++)_shared.push(new Thread)}return list?_shared:_shared.get()}})),Class((function TweenManager(){Namespace(this);var _this=this,_tweens=[];function updateTweens(time,dt){for(let i=_tweens.length-1;i>=0;i--){let tween=_tweens[i];tween.update?tween.update(dt):_this._removeMathTween(tween)}}function findEase(name){for(var eases=_this.CubicEases,i=eases.length-1;i>-1;i--)if(eases[i].name==name)return eases[i];return!1}this.CubicEases=[],Render.start(updateTweens),this._addMathTween=function(tween){_tweens.push(tween)},this._removeMathTween=function(tween){_tweens.remove(tween)},this._getEase=function(name,values){var ease=findEase(name);return!!ease&&(values?ease.path?ease.path.solve:ease.values:ease.curve)},this._inspectEase=function(name){return findEase(name)},this.tween=function(object,props,time,ease,delay,complete,isManual,scaledTime){"number"!=typeof delay&&(update=complete,complete=delay,delay=0);const tween=new MathTween(object,props,time,ease,delay,complete,isManual,scaledTime);let usePromise=null;return complete&&complete instanceof Promise&&(usePromise=complete,complete=complete.resolve),usePromise||tween},this.clearTween=function(object){if(object._mathTween&&object._mathTween.stop&&object._mathTween.stop(),object._mathTweens){for(var tweens=object._mathTweens,i=0;i<tweens.length;i++){var tw=tweens[i];tw&&tw.stop&&tw.stop()}object._mathTweens=null}},this.addCustomEase=function(ease){var add=!0;if("object"!=typeof ease||!ease.name||!ease.curve)throw"TweenManager :: addCustomEase requires {name, curve}";for(var i=_this.CubicEases.length-1;i>-1;i--)ease.name==_this.CubicEases[i].name&&(add=!1);if(add){if("m"==ease.curve.charAt(0).toLowerCase()){if(!window.EasingPath)throw"Using custom eases requires easingpath module";ease.path=new EasingPath(ease.curve)}else ease.values=function stringToValues(str){for(var values=str.split("(")[1].slice(0,-1).split(","),i=0;i<values.length;i++)values[i]=parseFloat(values[i]);return values}(ease.curve);_this.CubicEases.push(ease)}return ease},Math.interpolate=function(start,end,alpha,ease){const fn=_this.Interpolation.convertEase(ease);return Math.mix(start,end,"function"==typeof fn?fn(alpha):_this.Interpolation.solve(fn,alpha))},window.tween=this.tween,window.clearTween=this.clearTween}),"Static"),TweenManager.Class((function Interpolation(){const _this=this;function calculateBezier(aT,aA1,aA2){return((A(aA1,aA2)*aT+B(aA1,aA2))*aT+C(aA1))*aT}function A(aA1,aA2){return 1-3*aA2+3*aA1}function B(aA1,aA2){return 3*aA2-6*aA1}function C(aA1){return 3*aA1}this.convertEase=function(ease){var fn=function(){switch(ease){case"easeInQuad":return TweenManager.Interpolation.Quad.In;case"easeInCubic":return TweenManager.Interpolation.Cubic.In;case"easeInQuart":return TweenManager.Interpolation.Quart.In;case"easeInQuint":return TweenManager.Interpolation.Quint.In;case"easeInSine":return TweenManager.Interpolation.Sine.In;case"easeInExpo":return TweenManager.Interpolation.Expo.In;case"easeInCirc":return TweenManager.Interpolation.Circ.In;case"easeInElastic":return TweenManager.Interpolation.Elastic.In;case"easeInBack":return TweenManager.Interpolation.Back.In;case"easeInBounce":return TweenManager.Interpolation.Bounce.In;case"easeOutQuad":return TweenManager.Interpolation.Quad.Out;case"easeOutCubic":return TweenManager.Interpolation.Cubic.Out;case"easeOutQuart":return TweenManager.Interpolation.Quart.Out;case"easeOutQuint":return TweenManager.Interpolation.Quint.Out;case"easeOutSine":return TweenManager.Interpolation.Sine.Out;case"easeOutExpo":return TweenManager.Interpolation.Expo.Out;case"easeOutCirc":return TweenManager.Interpolation.Circ.Out;case"easeOutElastic":return TweenManager.Interpolation.Elastic.Out;case"easeOutBack":return TweenManager.Interpolation.Back.Out;case"easeOutBounce":return TweenManager.Interpolation.Bounce.Out;case"easeInOutQuad":return TweenManager.Interpolation.Quad.InOut;case"easeInOutCubic":return TweenManager.Interpolation.Cubic.InOut;case"easeInOutQuart":return TweenManager.Interpolation.Quart.InOut;case"easeInOutQuint":return TweenManager.Interpolation.Quint.InOut;case"easeInOutSine":return TweenManager.Interpolation.Sine.InOut;case"easeInOutExpo":return TweenManager.Interpolation.Expo.InOut;case"easeInOutCirc":return TweenManager.Interpolation.Circ.InOut;case"easeInOutElastic":return TweenManager.Interpolation.Elastic.InOut;case"easeInOutBack":return TweenManager.Interpolation.Back.InOut;case"easeInOutBounce":return TweenManager.Interpolation.Bounce.InOut;case"linear":return TweenManager.Interpolation.Linear.None}}();if(!fn){var curve=TweenManager._getEase(ease,!0);fn=curve||TweenManager.Interpolation.Cubic.Out}return fn},this.solve=function(values,elapsed){return values[0]==values[1]&&values[2]==values[3]?elapsed:calculateBezier(function getTForX(aX,mX1,mX2){for(var aT,aA1,aA2,aGuessT=aX,i=0;i<4;i++){var currentSlope=(aT=aGuessT,3*A(aA1=mX1,aA2=mX2)*aT*aT+2*B(aA1,aA2)*aT+C(aA1));if(0==currentSlope)return aGuessT;aGuessT-=(calculateBezier(aGuessT,mX1,mX2)-aX)/currentSlope}return aGuessT}(elapsed,values[0],values[2]),values[1],values[3])},this.Linear={None:function(k){return k}},this.Quad={In:function(k){return k*k},Out:function(k){return k*(2-k)},InOut:function(k){return(k*=2)<1?.5*k*k:-.5*(--k*(k-2)-1)}},this.Cubic={In:function(k){return k*k*k},Out:function(k){return--k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k:.5*((k-=2)*k*k+2)}},this.Quart={In:function(k){return k*k*k*k},Out:function(k){return 1- --k*k*k*k},InOut:function(k){return(k*=2)<1?.5*k*k*k*k:-.5*((k-=2)*k*k*k-2)}},this.Quint={In:function(k){return k*k*k*k*k},Out:function(k){return--k*k*k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k*k*k:.5*((k-=2)*k*k*k*k+2)}},this.Sine={In:function(k){return 1-Math.cos(k*Math.PI/2)},Out:function(k){return Math.sin(k*Math.PI/2)},InOut:function(k){return.5*(1-Math.cos(Math.PI*k))}},this.Expo={In:function(k){return 0===k?0:Math.pow(1024,k-1)},Out:function(k){return 1===k?1:1-Math.pow(2,-10*k)},InOut:function(k){return 0===k?0:1===k?1:(k*=2)<1?.5*Math.pow(1024,k-1):.5*(2-Math.pow(2,-10*(k-1)))}},this.Circ={In:function(k){return 1-Math.sqrt(1-k*k)},Out:function(k){return Math.sqrt(1- --k*k)},InOut:function(k){return(k*=2)<1?-.5*(Math.sqrt(1-k*k)-1):.5*(Math.sqrt(1-(k-=2)*k)+1)}},this.Elastic={In:function(k,a=1,p=.4){var s;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),-a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p))},Out:function(k,a=1,p=.4){var s;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),a*Math.pow(2,-10*k)*Math.sin((k-s)*(2*Math.PI)/p)+1)},InOut:function(k,a=1,p=.4){var s;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),(k*=2)<1?a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)*-.5:a*Math.pow(2,-10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)*.5+1)}},this.Back={In:function(k){var s=1.70158;return k*k*((s+1)*k-s)},Out:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},InOut:function(k){var s=2.5949095;return(k*=2)<1?k*k*((s+1)*k-s)*.5:.5*((k-=2)*k*((s+1)*k+s)+2)}},this.Bounce={In:function(k){return 1-_this.Bounce.Out(1-k)},Out:function(k){return k<1/2.75?7.5625*k*k:k<2/2.75?7.5625*(k-=1.5/2.75)*k+.75:k<2.5/2.75?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375},InOut:function(k){return k<.5?.5*_this.Bounce.In(2*k):.5*_this.Bounce.Out(2*k-1)+.5}}}),"Static"),Class((function MathTween(_object,_props,_time,_ease,_delay,_callback,_manual,_scaledTime){var _startTime,_startValues,_endValues,_easeFunction,_paused,_newEase,_spring,_damping,_update,_currentTime,_this=this,_elapsed=0;function clear(){if(!_object&&!_props)return!1;_object._mathTween=null,TweenManager._removeMathTween(_this),Utils.nullObject(_this),_object._mathTweens&&_object._mathTweens.remove(_this._tweenWrapper)}_this.object=_object,_this.props=_props,_this.time=_time,_this.ease=_ease,_this.delay=_delay,defer((function(){if(!_this.stopped){if(_this.overrideValues){let values=_this.overrideValues(_this,_object,_props,_time,_ease,_delay);values&&(_this.props=_props=values.props||_props,_this.time=_time=values.time||_time,_this.ease=_ease=values.ease||_ease,_this.delay=_delay=values.delay||_delay)}if(_object&&_props){if(_this.object=_object,"number"!=typeof _time)throw"MathTween Requires object, props, time, ease";!function start(){_object.multiTween||!_object._mathTween||_manual||TweenManager.clearTween(_object);_manual||TweenManager._addMathTween(_this);_this.time=_time,_this.delay=_delay;let propString=function getPropString(){let string="";for(let key in _props)"number"==typeof _props[key]&&(string+=key+" ");return string}();_object._mathTween=_this,_object.multiTween&&(_object._mathTweens||(_object._mathTweens=[]),_object._mathTweens.forEach((t=>{t.props==propString&&t.tween.stop()})),_this._tweenWrapper={props:propString,tween:_this},_object._mathTweens.push(_this._tweenWrapper));_ease||(_ease="linear");"string"==typeof _ease&&(_ease=TweenManager.Interpolation.convertEase(_ease),_easeFunction="function"==typeof _ease);_startTime=_scaledTime?Render.now():performance.now(),_currentTime=_startTime,_startTime+=_delay,_endValues=_props,_startValues={},_props.spring&&(_spring=_props.spring);_props.damping&&(_damping=_props.damping);for(var prop in _this.startValues=_startValues,_endValues)"number"==typeof _object[prop]&&(_startValues[prop]=_object[prop])}()}}})),this.update=function(dt){if(_paused)return;if((_currentTime+=_scaledTime?dt:Render.DT)<_startTime)return;_elapsed=(_elapsed=(_currentTime-_startTime)/_time)>1?1:_elapsed;let delta=this.interpolate(_elapsed);_update&&_update(delta),1==_elapsed&&(_callback&&_callback(),_this.completePromise&&_this.completePromise.resolve(),clear())},this.pause=function(){_paused=!0},this.resume=function(){_paused=!1},this.stop=function(){return _this.stopped=!0,clear(),null},this.setEase=function(ease){_newEase!=ease&&(_newEase=ease,_ease=TweenManager.Interpolation.convertEase(ease),_easeFunction="function"==typeof _ease)},this.getValues=function(){return{start:_startValues,end:_endValues}},this.interpolate=function(elapsed){var delta=_easeFunction?_ease(elapsed,_spring,_damping):TweenManager.Interpolation.solve(_ease,elapsed);for(var prop in _startValues)if("number"==typeof _startValues[prop]&&"number"==typeof _endValues[prop]){var start=_startValues[prop],end=_endValues[prop];_object[prop]=start+(end-start)*delta}return delta},this.onUpdate=function(callback){return _update=callback,this},this.onComplete=function(callback){return _callback=callback,this},this.promise=function(){return _this.completePromise||(_this.completePromise=Promise.create()),_this.completePromise},this.setElapsed=function(elapsed){_startTime=performance.now(),_currentTime=_startTime+_time*elapsed}})),Class((function TweenTimeline(){Inherit(this,Component);const _this=this;let _tween,_total=0;const _tweens=[];function calculate(){_tweens.sort((function(a,b){const ta=a.time+a.delay;return b.time+b.delay-ta}));const first=_tweens[0];_total=first.time+first.delay}function loop(){let time=_this.elapsed*_total;for(let i=_tweens.length-1;i>-1;i--){let t=_tweens[i],relativeTime=time-t.delay,elapsed=Math.clamp(relativeTime/t.time,0,1);t.interpolate(elapsed)}_this.events.fire(Events.UPDATE,_this,!0)}this.elapsed=0,this.get("timeRemaining",(()=>_total-_this.elapsed*_total)),this.add=function(object,props,time,ease,delay=0){let tween;return(object instanceof MathTween||object instanceof FrameTween)&&(props=object.props,time=object.time,ease=object.ease,delay=object.delay,object=object.object),tween=object instanceof HydraObject?new FrameTween(object,props,time,ease,delay,null,!0):new MathTween(object,props,time,ease,delay,null,!0),_tweens.push(tween),defer(calculate),tween},this.tween=function(to,time,ease,delay,callback){return _this.clearTween(),_tween=tween(_this,{elapsed:to},time,ease,delay).onUpdate(loop).onComplete(callback),_tween},this.clearTween=function(){_tween&&_tween.stop&&_tween.stop()},this.start=function(){_this.startRender(loop)},this.stop=function(){_this.stopRender(loop)},this.update=function(){loop()},this.onDestroy=function(){_this.clearTween(),Render.stop(loop);for(var i=0;i<_tweens.length;i++)_tweens[i].stop()}})),Class((function CMSData(){Inherit(this,Model);const _this=this,_data={},dataVersion=window.PROD?"latest":"dev";let _workPages=new StateArray,_workData=[],_lastRoute="";(async()=>{await Hydra.ready(),await _this.createBigJson(),Data.handleRequest("workItems",((data,mockData)=>_workPages.length?_workPages:new StateArray(mockData()))),_this.flag("isReady",!0)})(),AppState.bind("Router/state",(val=>{if(val.includes("work/")){let slug=val.replace("work/",""),project=_workData.find((elem=>elem.perma===slug));project&&(_workPages.includes(project)||(_workPages.remove(_workPages[_workPages.length-1]),_workPages.insertAtIdx(0,project)))}else"work"!==val||_lastRoute||_this.delayedCall((_=>_workPages.reflow()),400);_lastRoute=val}));let response={};AppState.bind("CMSData/slug",(({slug:slug,message:message})=>{let project=_workData.find((elem=>elem.perma===slug));project&&(response={...project,body:message,ai:!0},AppState.set("ViewController/navigate",`work/${slug}`))})),AppState.bind("CMSData/readyForResponse",(_=>{response.body&&(AppState.set("WorkDetailContent/updateText",response,!0),response={})})),_this.filter=function(tag){_workPages.refresh(_workData.filter((element=>element.tags.includes(tag))).shuffle().slice(0,14))},_this.cleanup=function(data){const{id:id,createdAt:createdAt,updatedAt:updatedAt,globalType:globalType,...cleaned}=data;return cleaned},_this.reshape=function(data,index){let dateString=`${new Date(data.completionDate).getFullYear()}\n${data.clientName}\n${data.tags.toLowerCase()}`;return!data.uiColor&&Hydra.LOCAL&&console.log("Color Missing",data.name),{seo:data.name,title:data.name,subhead:data.description,priority:data.priority,color:data.uiColor||"dddddd",date:dateString,projectLogo:data.projectLogo,clientName:data.clientName,body:data.description,perma:data.slug,caseStudyURL:data.caseStudyURL,projectURL:data.projectURL,videoURL:data.video.url,thumbnailURL:data.video.thumbnail,tags:data.tags.toLowerCase(),index:index}},_this.createBigJson=async function(){const pages=["metadata","projects"];window.CMS_DATA=window.CMS_DATA||{};for await(const key of pages){if(window.CMS_DATA[key]){_data[key]=window.CMS_DATA[key];continue}const data=await get(`https://storage.googleapis.com/activetheory-v6.appspot.com/cms/${key}-${dataVersion}.json?v=CMS_DATA_${Date.now()}`).catch((e=>console.log(e)));data&&("projects"===key?(_workData=data.map(((page,index)=>_this.reshape(page,index))).sort(((a,b)=>a.priority-b.priority)),window.CMS_DATA.projects=_workData,_workPages.refresh([..._workData.slice(0,14).shuffle()]),_this.workPages=_workPages):(window.CMS_DATA[key]=_this.cleanup(data),_data[key]=data))}},_this.ready=async function(){await _this.wait("isReady")}}),"static"),window.ASSETS=["assets/shaders/compiled.vs"],ASSETS.SW=["assets/js/app.1706399755880.js"],window.UIL_ASSETS_GEOMETRIES=[{filename:"hexgrid/hexagon.bin",bytes:617,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon.json",bytes:12997,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_bottomhalf.bin",bytes:541,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_bottomhalf.json",bytes:10080,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_full.bin",bytes:623,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_full.json",bytes:13125,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_gem.bin",bytes:501,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_gem.json",bytes:10116,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_lefthalf.bin",bytes:514,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_lefthalf.json",bytes:8106,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_nobevel_hard.bin",bytes:409,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_nobevel_hard.json",bytes:5472,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_nobevel_med.bin",bytes:409,lastChange:"2024-01-27T23:54:55.527Z"},{filename:"hexgrid/hexagon_nobevel_med.json",bytes:5671,lastChange:"2024-01-27T23:54:55.531Z"},{filename:"hexgrid/hexagon_nobevel_soft.bin",bytes:415,lastChange:"2024-01-27T23:54:55.531Z"},{filename:"hexgrid/hexagon_nobevel_soft.json",bytes:6643,lastChange:"2024-01-27T23:54:55.531Z"},{filename:"hexgrid/hexagon_righthalf.bin",bytes:536,lastChange:"2024-01-27T23:54:55.531Z"},{filename:"hexgrid/hexagon_righthalf.json",bytes:8118,lastChange:"2024-01-27T23:54:55.531Z"},{filename:"hexgrid/hexagon_tophalf.bin",bytes:590,lastChange:"2024-01-27T23:54:55.531Z"},{filename:"hexgrid/hexagon_tophalf.json",bytes:10028,lastChange:"2024-01-27T23:54:55.531Z"},{filename:"home/jellyfish.bin",bytes:24517,lastChange:"2024-01-27T23:54:55.531Z"},{filename:"home/jellyfish.json",bytes:1774016,lastChange:"2024-01-27T23:54:55.539Z"},{filename:"home/logo.json",bytes:147442,lastChange:"2024-01-27T23:54:55.539Z"},{filename:"jellyfish/bulb3.json",bytes:7081,lastChange:"2024-01-27T23:54:55.539Z"},{filename:"logo/AT_logo.bin",bytes:11676,lastChange:"2024-01-27T23:54:55.539Z"},{filename:"logo_animation/A_logo_base.bin",bytes:7579,lastChange:"2024-01-27T23:54:55.539Z"},{filename:"logo_animation/A_logo_base.json",bytes:576458,lastChange:"2024-01-27T23:54:55.539Z"},{filename:"logo_animation/A_logoanimation_N.json",bytes:3860753,lastChange:"2024-01-27T23:54:55.547Z"},{filename:"logo_animation/A_logoanimation_P.json",bytes:3874374,lastChange:"2024-01-27T23:54:55.555Z"},{filename:"logo_animation/A_logorest.json",bytes:181383,lastChange:"2024-01-27T23:54:55.555Z"},{filename:"logo_animation/ring_logo_base.bin",bytes:6504,lastChange:"2024-01-27T23:54:55.555Z"},{filename:"logo_animation/ring_logo_base.json",bytes:533092,lastChange:"2024-01-27T23:54:55.555Z"},{filename:"logo_animation/ring_logoanimation_N.json",bytes:2851800,lastChange:"2024-01-27T23:54:55.559Z"},{filename:"logo_animation/ring_logoanimation_P.json",bytes:2822277,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"logo_animation/ring_logorest.json",bytes:131395,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/2x1.bin",bytes:500,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/2x1.json",bytes:10344,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/2x2.bin",bytes:470,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/2x2.json",bytes:10529,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/2x3.bin",bytes:484,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/2x3.json",bytes:10517,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/2x4.bin",bytes:481,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/2x4.json",bytes:10290,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/3x1.bin",bytes:493,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/3x1.json",bytes:10319,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/3x4.bin",bytes:481,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/3x4.json",bytes:10632,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/5x2.bin",bytes:485,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/5x2.json",bytes:10587,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/5x3.bin",bytes:485,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"panels/5x3.json",bytes:10325,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"particles/at_logo.bin",bytes:2609,lastChange:"2024-01-27T23:54:55.567Z"},{filename:"particles/flower_spine-1024.bin",bytes:7319229,lastChange:"2024-01-27T23:54:55.583Z"},{filename:"particles/flower_spine-128.bin",bytes:133260,lastChange:"2024-01-27T23:54:55.583Z"},{filename:"particles/flower_spine-256.bin",bytes:488380,lastChange:"2024-01-27T23:54:55.583Z"},{filename:"particles/flower_spine-512.bin",bytes:1873490,lastChange:"2024-01-27T23:54:55.587Z"},{filename:"particles/forest-1024.bin",bytes:3083106,lastChange:"2024-01-27T23:54:55.595Z"},{filename:"particles/forest-128.bin",bytes:117132,lastChange:"2024-01-27T23:54:55.595Z"},{filename:"particles/forest-256.bin",bytes:401817,lastChange:"2024-01-27T23:54:55.595Z"},{filename:"particles/forest-512.bin",bytes:876944,lastChange:"2024-01-27T23:54:55.595Z"},{filename:"particles/tree-128.bin",bytes:820400,lastChange:"2024-01-27T23:54:55.599Z"},{filename:"particles/tree-256.bin",bytes:1572720,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/bush.bin",bytes:32724,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/bush.json",bytes:1008539,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/bush_instances.bin",bytes:1038,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/bush_instances.json",bytes:4405,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/caustic_plane.bin",bytes:288,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/caustic_plane.json",bytes:733,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/floor.bin",bytes:353,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/floor.json",bytes:571,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/glass.bin",bytes:1214,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/glass.json",bytes:69091,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/land.bin",bytes:11931,lastChange:"2024-01-27T23:54:55.607Z"},{filename:"room/land.json",bytes:858677,lastChange:"2024-01-27T23:54:55.611Z"},{filename:"room/light.bin",bytes:343,lastChange:"2024-01-27T23:54:55.611Z"},{filename:"room/light.json",bytes:2438,lastChange:"2024-01-27T23:54:55.611Z"},{filename:"room/prop.bin",bytes:1584,lastChange:"2024-01-27T23:54:55.611Z"},{filename:"room/prop.json",bytes:113864,lastChange:"2024-01-27T23:54:55.615Z"},{filename:"room/walls.bin",bytes:437,lastChange:"2024-01-27T23:54:55.615Z"},{filename:"room/walls.json",bytes:2827,lastChange:"2024-01-27T23:54:55.615Z"},{filename:"spine/spine.bin",bytes:15117,lastChange:"2024-01-27T23:54:55.615Z"},{filename:"spine/spine.json",bytes:1446457,lastChange:"2024-01-27T23:54:55.615Z"},{filename:"tree_room/cables.bin",bytes:87527,lastChange:"2024-01-27T23:54:55.615Z"},{filename:"tree_room/cables.json",bytes:5747844,lastChange:"2024-01-27T23:54:55.639Z"},{filename:"tree_room/mask.bin",bytes:1663,lastChange:"2024-01-27T23:54:55.639Z"},{filename:"tree_room/mask.json",bytes:76236,lastChange:"2024-01-27T23:54:55.639Z"},{filename:"tree_room/pillars.bin",bytes:3278,lastChange:"2024-01-27T23:54:55.639Z"},{filename:"tree_room/pillars.json",bytes:177901,lastChange:"2024-01-27T23:54:55.639Z"},{filename:"tree_room/rock_L.bin",bytes:5004,lastChange:"2024-01-27T23:54:55.639Z"},{filename:"tree_room/rock_L.json",bytes:277142,lastChange:"2024-01-27T23:54:55.643Z"},{filename:"tree_room/rock_R.bin",bytes:12253,lastChange:"2024-01-27T23:54:55.643Z"},{filename:"tree_room/rock_R.json",bytes:950266,lastChange:"2024-01-27T23:54:55.647Z"},{filename:"tree_room/rocky_soil.bin",bytes:68637,lastChange:"2024-01-27T23:54:55.647Z"},{filename:"tree_room/rocky_soil.json",bytes:6397432,lastChange:"2024-01-27T23:54:55.671Z"},{filename:"tree_room/sand.bin",bytes:6714,lastChange:"2024-01-27T23:54:55.671Z"},{filename:"tree_room/sand.json",bytes:531248,lastChange:"2024-01-27T23:54:55.671Z"},{filename:"tree_room/structure.bin",bytes:145133,lastChange:"2024-01-27T23:54:55.675Z"},{filename:"tree_room/structure.json",bytes:13120879,lastChange:"2024-01-27T23:54:55.723Z"},{filename:"tree_room/tree.bin",bytes:555893,lastChange:"2024-01-27T23:54:55.727Z"},{filename:"tree_room/tree.json",bytes:33329808,lastChange:"2024-01-27T23:54:55.863Z"},{filename:"tree_room/treePCv3-128.bin",bytes:83020,lastChange:"2024-01-27T23:54:55.863Z"},{filename:"tree_room/treePCv3-128.json",bytes:1226047,lastChange:"2024-01-27T23:54:55.867Z"},{filename:"tree_room/treePCv3-256.bin",bytes:309738,lastChange:"2024-01-27T23:54:55.867Z"},{filename:"tree_room/treePCv3-256.json",bytes:4900620,lastChange:"2024-01-27T23:54:55.895Z"},{filename:"tree_room/tree_leaves.bin",bytes:119158,lastChange:"2024-01-27T23:54:55.895Z"},{filename:"tree_room/tree_leaves.json",bytes:3188740,lastChange:"2024-01-27T23:54:55.911Z"},{filename:"tree_room/tree_trunk.bin",bytes:240352,lastChange:"2024-01-27T23:54:55.911Z"},{filename:"tree_room/tree_trunk.json",bytes:20659103,lastChange:"2024-01-27T23:54:56.003Z"},{filename:"tree_room/walls.bin",bytes:7394,lastChange:"2024-01-27T23:54:56.003Z"},{filename:"tree_room/walls.json",bytes:634977,lastChange:"2024-01-27T23:54:56.007Z"},{filename:"tree_room/water.bin",bytes:279,lastChange:"2024-01-27T23:54:56.007Z"},{filename:"tree_room/water.json",bytes:490,lastChange:"2024-01-27T23:54:56.007Z"},{filename:"work/chainlink.bin",bytes:5774,lastChange:"2024-01-27T23:54:56.007Z"},{filename:"work/chainlink.json",bytes:472723,lastChange:"2024-01-27T23:54:56.007Z"},{filename:"work/cube.bin",bytes:2067,lastChange:"2024-01-27T23:54:56.007Z"},{filename:"work/cube.json",bytes:130520,lastChange:"2024-01-27T23:54:56.007Z"},{filename:"work/spline_animation_test_v04-SPLINES.json",bytes:223521,lastChange:"2024-01-27T23:54:56.011Z"},{filename:"work/splines_anim4-SPLINES.json",bytes:41076,lastChange:"2024-01-27T23:54:56.011Z"},{filename:"work/splines_anim5-SPLINES.json",bytes:41052,lastChange:"2024-01-27T23:54:56.011Z"},{filename:"work/swirlSplines-SPLINES.json",bytes:54038,lastChange:"2024-01-27T23:54:56.011Z"},{filename:"work/swirl_12-SPLINES.json",bytes:510918,lastChange:"2024-01-27T23:54:56.015Z"}],window.UIL_ASSETS_TEXTURES=[{filename:"_lighting/arealights.json",bytes:307348,lastChange:"2024-01-27T23:54:56.015Z"},{filename:"_lightvolume/light-mask.jpg",bytes:5236,lastChange:"2024-01-27T23:54:56.015Z"},{filename:"_lightvolume/light.jpg",bytes:17350,lastChange:"2024-01-27T23:54:56.015Z"},{filename:"_scenelayout/black.jpg",bytes:1129,lastChange:"2024-01-27T23:54:56.019Z"},{filename:"_scenelayout/empty_mro.jpg",bytes:1110,lastChange:"2024-01-27T23:54:56.019Z"},{filename:"_scenelayout/empty_mro.ktx2",bytes:492,lastChange:"2024-01-27T23:54:56.019Z"},{filename:"_scenelayout/empty_normal.ktx2",bytes:493,lastChange:"2024-01-27T23:54:56.019Z"},{filename:"_scenelayout/empty_normal.png",bytes:95,lastChange:"2024-01-27T23:54:56.019Z"},{filename:"_scenelayout/invert.cube",bytes:288,lastChange:"2024-01-27T23:54:56.019Z"},{filename:"_scenelayout/mask.jpg",bytes:1129,lastChange:"2024-01-27T23:54:56.019Z"},{filename:"_scenelayout/uv.jpg",bytes:17100,lastChange:"2024-01-27T23:54:56.019Z"},{filename:"_temp/Star 2.png",bytes:442,lastChange:"2024-01-27T23:54:56.019Z"},{filename:"_temp/arrow.png",bytes:697,lastChange:"2024-01-27T23:54:56.019Z"},{filename:"_temp/contact.jpg",bytes:639238,lastChange:"2024-01-27T23:54:56.023Z"},{filename:"_temp/globe.png",bytes:293996,lastChange:"2024-01-27T23:54:56.023Z"},{filename:"_temp/star.png",bytes:790,lastChange:"2024-01-27T23:54:56.023Z"},{filename:"lab.jpg",bytes:136303,lastChange:"2024-01-27T23:54:56.023Z"},{filename:"particle/matcap3.ktx2",bytes:1951,lastChange:"2024-01-27T23:54:56.023Z"},{filename:"particle/matcap3.png",bytes:6734,lastChange:"2024-01-27T23:54:56.027Z"},{filename:"pbr/alien_cracked_2_basecolor.ktx2",bytes:55172,lastChange:"2024-01-27T23:54:56.027Z"},{filename:"pbr/alien_cracked_2_basecolor.png",bytes:239528,lastChange:"2024-01-27T23:54:56.027Z"},{filename:"pbr/alien_cracked_2_mro.png",bytes:223502,lastChange:"2024-01-27T23:54:56.027Z"},{filename:"pbr/alien_cracked_2_normal.png",bytes:251872,lastChange:"2024-01-27T23:54:56.027Z"},{filename:"pbr/black.png",bytes:82,lastChange:"2024-01-27T23:54:56.027Z"},{filename:"pbr/cargo_mro.png",bytes:142067,lastChange:"2024-01-27T23:54:56.027Z"},{filename:"pbr/cargo_normal.png",bytes:137308,lastChange:"2024-01-27T23:54:56.027Z"},{filename:"pbr/cliffs_BaseColor.png",bytes:232168,lastChange:"2024-01-27T23:54:56.031Z"},{filename:"pbr/cliffs_MRO.ktx2",bytes:40978,lastChange:"2024-01-27T23:54:56.031Z"},{filename:"pbr/cliffs_MRO.png",bytes:186154,lastChange:"2024-01-27T23:54:56.031Z"},{filename:"pbr/cliffs_Normal.png",bytes:208758,lastChange:"2024-01-27T23:54:56.031Z"},{filename:"pbr/clovers_BaseColor.png",bytes:249856,lastChange:"2024-01-27T23:54:56.031Z"},{filename:"pbr/clovers_MRO.png",bytes:202798,lastChange:"2024-01-27T23:54:56.031Z"},{filename:"pbr/clovers_Normal.png",bytes:258195,lastChange:"2024-01-27T23:54:56.031Z"},{filename:"pbr/corsica_beach-diffuse-RGBM.png",bytes:90672,lastChange:"2024-01-27T23:54:56.035Z"},{filename:"pbr/corsica_beach-specular-RGBM.png",bytes:732570,lastChange:"2024-01-27T23:54:56.035Z"},{filename:"pbr/cracked_ice_basecolor.ktx2",bytes:51750,lastChange:"2024-01-27T23:54:56.035Z"},{filename:"pbr/cracked_ice_basecolor.png",bytes:223486,lastChange:"2024-01-27T23:54:56.035Z"},{filename:"pbr/cracked_ice_mro.png",bytes:177606,lastChange:"2024-01-27T23:54:56.039Z"},{filename:"pbr/cracked_ice_normal.png",bytes:175958,lastChange:"2024-01-27T23:54:56.039Z"},{filename:"pbr/damaged_road_basecolor.png",bytes:203669,lastChange:"2024-01-27T23:54:56.039Z"},{filename:"pbr/damaged_road_mro.ktx2",bytes:51105,lastChange:"2024-01-27T23:54:56.039Z"},{filename:"pbr/damaged_road_mro.png",bytes:233703,lastChange:"2024-01-27T23:54:56.039Z"},{filename:"pbr/damaged_road_normal.ktx2",bytes:44387,lastChange:"2024-01-27T23:54:56.039Z"},{filename:"pbr/damaged_road_normal.png",bytes:2082201,lastChange:"2024-01-27T23:54:56.051Z"},{filename:"pbr/damaged_road_roughness.jpg",bytes:76284,lastChange:"2024-01-27T23:54:56.051Z"},{filename:"pbr/desert_bedrock_basecolor.png",bytes:238535,lastChange:"2024-01-27T23:54:56.051Z"},{filename:"pbr/desert_bedrock_mro.png",bytes:232044,lastChange:"2024-01-27T23:54:56.055Z"},{filename:"pbr/desert_bedrock_normal.png",bytes:229622,lastChange:"2024-01-27T23:54:56.055Z"},{filename:"pbr/dune_BaseColor.png",bytes:240977,lastChange:"2024-01-27T23:54:56.055Z"},{filename:"pbr/dune_MRO.png",bytes:179187,lastChange:"2024-01-27T23:54:56.055Z"},{filename:"pbr/dune_Normal.png",bytes:218905,lastChange:"2024-01-27T23:54:56.055Z"},{filename:"pbr/gold_leaf_basecolor.png",bytes:183040,lastChange:"2024-01-27T23:54:56.055Z"},{filename:"pbr/gold_leaf_mro.png",bytes:8012,lastChange:"2024-01-27T23:54:56.059Z"},{filename:"pbr/gold_leaf_normal.png",bytes:424192,lastChange:"2024-01-27T23:54:56.059Z"},{filename:"pbr/gold_leaf_normal.png.out",bytes:0,lastChange:"2024-01-27T23:54:56.059Z"},{filename:"pbr/gold_ore_basecolor.png",bytes:643561,lastChange:"2024-01-27T23:54:56.063Z"},{filename:"pbr/gold_ore_mro.png",bytes:544875,lastChange:"2024-01-27T23:54:56.067Z"},{filename:"pbr/gold_ore_normal.png",bytes:654667,lastChange:"2024-01-27T23:54:56.067Z"},{filename:"pbr/grey.png",bytes:70,lastChange:"2024-01-27T23:54:56.067Z"},{filename:"pbr/heatshield_BaseColor.png",bytes:422118,lastChange:"2024-01-27T23:54:56.071Z"},{filename:"pbr/heatshield_MRO.png",bytes:256069,lastChange:"2024-01-27T23:54:56.071Z"},{filename:"pbr/heatshield_Normal.png",bytes:205978,lastChange:"2024-01-27T23:54:56.075Z"},{filename:"pbr/jungle_soil_basecolor.png",bytes:482615,lastChange:"2024-01-27T23:54:56.079Z"},{filename:"pbr/jungle_soil_mro.png",bytes:567617,lastChange:"2024-01-27T23:54:56.079Z"},{filename:"pbr/jungle_soil_normal.ktx2",bytes:54644,lastChange:"2024-01-27T23:54:56.079Z"},{filename:"pbr/jungle_soil_normal.png",bytes:571380,lastChange:"2024-01-27T23:54:56.079Z"},{filename:"pbr/lut.png",bytes:16623,lastChange:"2024-01-27T23:54:56.083Z"},{filename:"pbr/maple_parquet_basecolor.png",bytes:455585,lastChange:"2024-01-27T23:54:56.083Z"},{filename:"pbr/maple_parquet_mro.png",bytes:342840,lastChange:"2024-01-27T23:54:56.087Z"},{filename:"pbr/maple_parquet_normal.png",bytes:307514,lastChange:"2024-01-27T23:54:56.087Z"},{filename:"pbr/mud_basecolor.png",bytes:456327,lastChange:"2024-01-27T23:54:56.091Z"},{filename:"pbr/mud_mro.png",bytes:304742,lastChange:"2024-01-27T23:54:56.095Z"},{filename:"pbr/mud_normal.png",bytes:625607,lastChange:"2024-01-27T23:54:56.095Z"},{filename:"pbr/paddedfabric_BaseColor.png",bytes:227230,lastChange:"2024-01-27T23:54:56.099Z"},{filename:"pbr/paddedfabric_MRO.png",bytes:234588,lastChange:"2024-01-27T23:54:56.099Z"},{filename:"pbr/paddedfabric_Normal.png",bytes:375760,lastChange:"2024-01-27T23:54:56.103Z"},{filename:"pbr/spacepanel_BaseColor.png",bytes:414971,lastChange:"2024-01-27T23:54:56.103Z"},{filename:"pbr/spacepanel_MRO.png",bytes:374776,lastChange:"2024-01-27T23:54:56.107Z"},{filename:"pbr/spacepanel_Normal.png",bytes:188130,lastChange:"2024-01-27T23:54:56.107Z"},{filename:"pbr/spacetiles_BaseColor.png",bytes:386128,lastChange:"2024-01-27T23:54:56.111Z"},{filename:"pbr/spacetiles_MRO.png",bytes:293440,lastChange:"2024-01-27T23:54:56.111Z"},{filename:"pbr/spacetiles_Normal.png",bytes:239662,lastChange:"2024-01-27T23:54:56.115Z"},{filename:"pbr/stylized_grass_BaseColor.png",bytes:372121,lastChange:"2024-01-27T23:54:56.115Z"},{filename:"pbr/stylized_grass_MRO.png",bytes:159043,lastChange:"2024-01-27T23:54:56.119Z"},{filename:"pbr/stylized_grass_Normal.png",bytes:297734,lastChange:"2024-01-27T23:54:56.119Z"},{filename:"pbr/teracotta_basecolor.png",bytes:415564,lastChange:"2024-01-27T23:54:56.123Z"},{filename:"pbr/teracotta_mro.png",bytes:351049,lastChange:"2024-01-27T23:54:56.127Z"},{filename:"pbr/teracotta_normal.png",bytes:406126,lastChange:"2024-01-27T23:54:56.127Z"},{filename:"pbr/tomoco_2-diffuse-sRGB.png",bytes:1996,lastChange:"2024-01-27T23:54:56.127Z"},{filename:"pbr/tomoco_2-specular-sRGB.png",bytes:67278,lastChange:"2024-01-27T23:54:56.127Z"},{filename:"pbr/tomoco_studio-diffuse-RGBM.png",bytes:3613,lastChange:"2024-01-27T23:54:56.127Z"},{filename:"pbr/tomoco_studio-specular-RGBM.png",bytes:93991,lastChange:"2024-01-27T23:54:56.131Z"},{filename:"pbr/wet_paint_basecolor.png",bytes:90754,lastChange:"2024-01-27T23:54:56.131Z"},{filename:"pbr/wet_paint_mro.png",bytes:174228,lastChange:"2024-01-27T23:54:56.131Z"},{filename:"pbr/wet_paint_normal.png",bytes:366403,lastChange:"2024-01-27T23:54:56.135Z"},{filename:"pbr/wood_parquet_basecolor.png",bytes:601896,lastChange:"2024-01-27T23:54:56.139Z"},{filename:"pbr/wood_parquet_mro.png",bytes:200927,lastChange:"2024-01-27T23:54:56.139Z"},{filename:"pbr/wood_parquet_normal.png",bytes:324009,lastChange:"2024-01-27T23:54:56.143Z"},{filename:"pbr/woodplanks_basecolor.png",bytes:336445,lastChange:"2024-01-27T23:54:56.143Z"},{filename:"pbr/woodplanks_mro.png",bytes:351315,lastChange:"2024-01-27T23:54:56.147Z"},{filename:"pbr/woodplanks_normal.ktx2",bytes:39899,lastChange:"2024-01-27T23:54:56.147Z"},{filename:"pbr/woodplanks_normal.png",bytes:316381,lastChange:"2024-01-27T23:54:56.147Z"},{filename:"room/1234.ktx2",bytes:77280,lastChange:"2024-01-27T23:54:56.147Z"},{filename:"room/1234.png",bytes:585845,lastChange:"2024-01-27T23:54:56.151Z"},{filename:"room/Landscape_default_Basecolor.jpg",bytes:525754,lastChange:"2024-01-27T23:54:56.151Z"},{filename:"room/Landscape_default_Basecolor.ktx2",bytes:168665,lastChange:"2024-01-27T23:54:56.151Z"},{filename:"room/Landscape_default_MRO.jpg",bytes:254829,lastChange:"2024-01-27T23:54:56.151Z"},{filename:"room/Landscape_default_MRO.ktx2",bytes:150616,lastChange:"2024-01-27T23:54:56.155Z"},{filename:"room/Landscape_default_Normal.jpg",bytes:496544,lastChange:"2024-01-27T23:54:56.155Z"},{filename:"room/Landscape_default_Normal.ktx2",bytes:169600,lastChange:"2024-01-27T23:54:56.155Z"},{filename:"room/caustic.jpg",bytes:114975,lastChange:"2024-01-27T23:54:56.155Z"},{filename:"room/concrete-polished-normal.jpg",bytes:14094,lastChange:"2024-01-27T23:54:56.155Z"},{filename:"room/concrete-polished-normal.ktx2",bytes:3861,lastChange:"2024-01-27T23:54:56.155Z"},{filename:"room/concrete_light_mro.jpg",bytes:147650,lastChange:"2024-01-27T23:54:56.155Z"},{filename:"room/concrete_light_mro.ktx2",bytes:30851,lastChange:"2024-01-27T23:54:56.155Z"},{filename:"room/damaged_road_normal.jpg",bytes:219612,lastChange:"2024-01-27T23:54:56.159Z"},{filename:"room/floor-lightbounce.jpg",bytes:11996,lastChange:"2024-01-27T23:54:56.159Z"},{filename:"room/floor-lightbounce.ktx2",bytes:13045,lastChange:"2024-01-27T23:54:56.159Z"},{filename:"room/floor_DefaultMaterial_MRO.png",bytes:16903,lastChange:"2024-01-27T23:54:56.159Z"},{filename:"room/floor_DefaultMaterial_Normal.png",bytes:1671655,lastChange:"2024-01-27T23:54:56.159Z"},{filename:"room/floor_diffuse.jpg",bytes:189007,lastChange:"2024-01-27T23:54:56.163Z"},{filename:"room/floor_lightmap.jpg",bytes:149858,lastChange:"2024-01-27T23:54:56.163Z"},{filename:"room/floor_lightmap_bw.jpg",bytes:241016,lastChange:"2024-01-27T23:54:56.163Z"},{filename:"room/floor_lightmap_bw2.jpg",bytes:157668,lastChange:"2024-01-27T23:54:56.163Z"},{filename:"room/land_lightmap_bw.jpg",bytes:242943,lastChange:"2024-01-27T23:54:56.163Z"},{filename:"room/landscape_lightmap.jpg",bytes:64051,lastChange:"2024-01-27T23:54:56.163Z"},{filename:"room/landscape_lightmap2.jpg",bytes:225561,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/matcap-test.jpg",bytes:51288,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/matcap-test.ktx2",bytes:44610,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/matcap.jpg",bytes:6517,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/pano-ATv6-1700435330543-diffuse-sRGB.ktx2",bytes:1905,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/pano-ATv6-1700435330543-diffuse-sRGB.png",bytes:6782,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/pano-ATv6-1700435330543-specular-sRGB.png",bytes:77951,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/pano-ATv6-1700435330543.jpg",bytes:37436,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/pano-ATv6-1700435330543.ktx2",bytes:26680,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/prop_lightmap.jpg",bytes:73853,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/prop_lightmap.ktx2",bytes:32813,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/room_AO.jpg",bytes:138730,lastChange:"2024-01-27T23:54:56.167Z"},{filename:"room/room_combined.jpg",bytes:241713,lastChange:"2024-01-27T23:54:56.171Z"},{filename:"room/room_combined.ktx2",bytes:157955,lastChange:"2024-01-27T23:54:56.171Z"},{filename:"room/room_lightmap_bw.jpg",bytes:258637,lastChange:"2024-01-27T23:54:56.171Z"},{filename:"room/tomoco_studio-diffuse-sRGB.ktx2",bytes:5328,lastChange:"2024-01-27T23:54:56.171Z"},{filename:"room/tomoco_studio-diffuse-sRGB.png",bytes:37012,lastChange:"2024-01-27T23:54:56.171Z"},{filename:"room/tomoco_studio-specular-RGBM.ktx2",bytes:99008,lastChange:"2024-01-27T23:54:56.171Z"},{filename:"room/tomoco_studio-specular-RGBM.png",bytes:811559,lastChange:"2024-01-27T23:54:56.175Z"},{filename:"room/wall-bouncelight.jpg",bytes:12054,lastChange:"2024-01-27T23:54:56.175Z"},{filename:"room/wall-bouncelight.ktx2",bytes:14297,lastChange:"2024-01-27T23:54:56.175Z"},{filename:"room/walls_default_MRO.png",bytes:3351861,lastChange:"2024-01-27T23:54:56.179Z"},{filename:"room/walls_diffuse.jpg",bytes:137675,lastChange:"2024-01-27T23:54:56.183Z"},{filename:"room/walls_lightmap.jpg",bytes:324921,lastChange:"2024-01-27T23:54:56.183Z"},{filename:"tree_room/4141-normal.jpg",bytes:170168,lastChange:"2024-01-27T23:54:56.183Z"},{filename:"tree_room/4141-normal.ktx2",bytes:62662,lastChange:"2024-01-27T23:54:56.183Z"},{filename:"tree_room/CABLES___CyclesBake_COMBINED.jpg",bytes:209206,lastChange:"2024-01-27T23:54:56.183Z"},{filename:"tree_room/CABLES___CyclesBake_COMBINED.ktx2",bytes:100626,lastChange:"2024-01-27T23:54:56.183Z"},{filename:"tree_room/CABLES___PBR_AT_MRO.jpg",bytes:78098,lastChange:"2024-01-27T23:54:56.183Z"},{filename:"tree_room/CABLES___PBR_AT_MRO.ktx2",bytes:28218,lastChange:"2024-01-27T23:54:56.187Z"},{filename:"tree_room/CABLES___PBR_Normal.jpg",bytes:465819,lastChange:"2024-01-27T23:54:56.187Z"},{filename:"tree_room/CABLES___PBR_Normal.ktx2",bytes:131543,lastChange:"2024-01-27T23:54:56.187Z"},{filename:"tree_room/PILLARS___CyclesBake_COMBINED.jpg",bytes:61535,lastChange:"2024-01-27T23:54:56.187Z"},{filename:"tree_room/PILLARS___CyclesBake_COMBINED.ktx2",bytes:48879,lastChange:"2024-01-27T23:54:56.191Z"},{filename:"tree_room/PILLARS___PBR_AT_MRO.jpg",bytes:178004,lastChange:"2024-01-27T23:54:56.191Z"},{filename:"tree_room/PILLARS___PBR_AT_MRO.ktx2",bytes:67994,lastChange:"2024-01-27T23:54:56.191Z"},{filename:"tree_room/PILLARS___PBR_Normal.jpg",bytes:257549,lastChange:"2024-01-27T23:54:56.191Z"},{filename:"tree_room/PILLARS___PBR_Normal.ktx2",bytes:79488,lastChange:"2024-01-27T23:54:56.191Z"},{filename:"tree_room/ROCKY_SOIL___CyclesBake_COMBINED.jpg",bytes:62986,lastChange:"2024-01-27T23:54:56.195Z"},{filename:"tree_room/ROCKY_SOIL___CyclesBake_COMBINED.ktx2",bytes:38157,lastChange:"2024-01-27T23:54:56.195Z"},{filename:"tree_room/ROCKY_SOIL___PBR_AT_MRO.jpg",bytes:216252,lastChange:"2024-01-27T23:54:56.195Z"},{filename:"tree_room/ROCKY_SOIL___PBR_AT_MRO.ktx2",bytes:62877,lastChange:"2024-01-27T23:54:56.195Z"},{filename:"tree_room/ROCKY_SOIL___PBR_Normal.jpg",bytes:1058996,lastChange:"2024-01-27T23:54:56.199Z"},{filename:"tree_room/ROCKY_SOIL___PBR_Normal.ktx2",bytes:174547,lastChange:"2024-01-27T23:54:56.199Z"},{filename:"tree_room/ROCK_L___CyclesBake_COMBINED.jpg",bytes:42346,lastChange:"2024-01-27T23:54:56.199Z"},{filename:"tree_room/ROCK_L___CyclesBake_COMBINED.ktx2",bytes:27408,lastChange:"2024-01-27T23:54:56.199Z"},{filename:"tree_room/ROCK_L___PBR_AT_MRO.jpg",bytes:135135,lastChange:"2024-01-27T23:54:56.199Z"},{filename:"tree_room/ROCK_L___PBR_AT_MRO.ktx2",bytes:48823,lastChange:"2024-01-27T23:54:56.203Z"},{filename:"tree_room/ROCK_L___PBR_Normal.jpg",bytes:613631,lastChange:"2024-01-27T23:54:56.203Z"},{filename:"tree_room/ROCK_L___PBR_Normal.ktx2",bytes:138030,lastChange:"2024-01-27T23:54:56.203Z"},{filename:"tree_room/ROCK_R___CyclesBake_COMBINED.jpg",bytes:85092,lastChange:"2024-01-27T23:54:56.207Z"},{filename:"tree_room/ROCK_R___CyclesBake_COMBINED.ktx2",bytes:50354,lastChange:"2024-01-27T23:54:56.207Z"},{filename:"tree_room/ROCK_R___PBR_AT_MRO.jpg",bytes:141576,lastChange:"2024-01-27T23:54:56.207Z"},{filename:"tree_room/ROCK_R___PBR_AT_MRO.ktx2",bytes:44004,lastChange:"2024-01-27T23:54:56.207Z"},{filename:"tree_room/ROCK_R___PBR_Normal.jpg",bytes:570241,lastChange:"2024-01-27T23:54:56.211Z"},{filename:"tree_room/ROCK_R___PBR_Normal.ktx2",bytes:162237,lastChange:"2024-01-27T23:54:56.211Z"},{filename:"tree_room/SAND___CyclesBake_COMBINED.jpg",bytes:68097,lastChange:"2024-01-27T23:54:56.211Z"},{filename:"tree_room/SAND___CyclesBake_COMBINED.ktx2",bytes:48609,lastChange:"2024-01-27T23:54:56.211Z"},{filename:"tree_room/SAND___PBR_AT_MRO.jpg",bytes:44115,lastChange:"2024-01-27T23:54:56.211Z"},{filename:"tree_room/SAND___PBR_AT_MRO.ktx2",bytes:19974,lastChange:"2024-01-27T23:54:56.211Z"},{filename:"tree_room/SAND___PBR_Normal.jpg",bytes:466738,lastChange:"2024-01-27T23:54:56.215Z"},{filename:"tree_room/SAND___PBR_Normal.ktx2",bytes:126734,lastChange:"2024-01-27T23:54:56.215Z"},{filename:"tree_room/STRUCTURE___CyclesBake_COMBINED.jpg",bytes:276219,lastChange:"2024-01-27T23:54:56.215Z"},{filename:"tree_room/STRUCTURE___CyclesBake_COMBINED.ktx2",bytes:128224,lastChange:"2024-01-27T23:54:56.215Z"},{filename:"tree_room/STRUCTURE___PBR_AT_MRO.jpg",bytes:370630,lastChange:"2024-01-27T23:54:56.219Z"},{filename:"tree_room/STRUCTURE___PBR_AT_MRO.ktx2",bytes:106212,lastChange:"2024-01-27T23:54:56.219Z"},{filename:"tree_room/STRUCTURE___PBR_Normal.jpg",bytes:95808,lastChange:"2024-01-27T23:54:56.219Z"},{filename:"tree_room/STRUCTURE___PBR_Normal.ktx2",bytes:45357,lastChange:"2024-01-27T23:54:56.219Z"},{filename:"tree_room/TREE___CyclesBake_COMBINED.jpg",bytes:13416,lastChange:"2024-01-27T23:54:56.219Z"},{filename:"tree_room/TREE___PBR_Normal.jpg",bytes:14144,lastChange:"2024-01-27T23:54:56.223Z"},{filename:"tree_room/TREE_leaves___CyclesBake_COMBINED.jpg",bytes:700192,lastChange:"2024-01-27T23:54:56.223Z"},{filename:"tree_room/TREE_leaves___PBR_AT_MRO.jpg",bytes:1020148,lastChange:"2024-01-27T23:54:56.227Z"},{filename:"tree_room/TREE_leaves___PBR_Alpha.jpg",bytes:785473,lastChange:"2024-01-27T23:54:56.231Z"},{filename:"tree_room/TREE_trunk_branches___CyclesBake_COMBINED.jpg",bytes:366174,lastChange:"2024-01-27T23:54:56.231Z"},{filename:"tree_room/TREE_trunk_branches___PBR_AT_MRO.jpg",bytes:1078760,lastChange:"2024-01-27T23:54:56.235Z"},{filename:"tree_room/WALLS_CEILING___CyclesBake_COMBINED.jpg",bytes:95813,lastChange:"2024-01-27T23:54:56.235Z"},{filename:"tree_room/WALLS_CEILING___CyclesBake_COMBINED.ktx2",bytes:57497,lastChange:"2024-01-27T23:54:56.235Z"},{filename:"tree_room/WALLS_CEILING___PBR_AT_MRO.jpg",bytes:20199,lastChange:"2024-01-27T23:54:56.235Z"},{filename:"tree_room/WALLS_CEILING___PBR_AT_MRO.ktx2",bytes:2578,lastChange:"2024-01-27T23:54:56.235Z"},{filename:"tree_room/WALLS_CEILING___PBR_Normal.jpg",bytes:84456,lastChange:"2024-01-27T23:54:56.235Z"},{filename:"tree_room/WALLS_CEILING___PBR_Normal.ktx2",bytes:32846,lastChange:"2024-01-27T23:54:56.235Z"},{filename:"tree_room/blck.jpg",bytes:1131,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"tree_room/matcap_tree_room.jpg",bytes:90331,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"tree_room/matcap_tree_room.png",bytes:465123,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"tree_room/waternormals.jpg",bytes:26768,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"ui/arrow.png",bytes:697,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"ui/at-labrds.jpg",bytes:12913,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"ui/close.svg",bytes:766,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"ui/fb.png",bytes:330,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"ui/globe.png",bytes:128953,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"ui/ig.png",bytes:5024,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"ui/in.png",bytes:2886,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"ui/star.png",bytes:790,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"ui/tw.png",bytes:4965,lastChange:"2024-01-27T23:54:56.239Z"},{filename:"unsupported-bg.jpg",bytes:196572,lastChange:"2024-01-27T23:54:56.243Z"},{filename:"work/env1.jpg",bytes:21655,lastChange:"2024-01-27T23:54:56.243Z"},{filename:"work/env1.ktx2",bytes:21416,lastChange:"2024-01-27T23:54:56.243Z"},{filename:"work/ewnv0.jpg",bytes:33874,lastChange:"2024-01-27T23:54:56.243Z"},{filename:"work/frostednormal.jpg",bytes:12487,lastChange:"2024-01-27T23:54:56.243Z"},{filename:"work/frostednormal.png",bytes:1268607,lastChange:"2024-01-27T23:54:56.243Z"},{filename:"work/test.jpg",bytes:48571,lastChange:"2024-01-27T23:54:56.247Z"},{filename:"work/test.ktx2",bytes:22568,lastChange:"2024-01-27T23:54:56.247Z"}],Class((function Antimatter(_num,_config,_renderer=World.RENDERER,_pointData=null){Inherit(this,AntimatterFBO);var _geometry,_this=this,_drawLimit=_num,_size=function findSize(){return _config.pot?Math.pow(2,Math.ceil(Math.log(Math.sqrt(_num))/Math.log(2))):Math.ceil(Math.sqrt(_num))}();async function createBuffer(){let{geometry:geometry,vertices:vertices,attribs:attribs,usedDepth:usedDepth}=await AntimatterUtil.createBufferArray(_size,_num,_config,_pointData);_this.vertices=_this.cloneVertices?vertices.clone():vertices,(_geometry=geometry.clone(!0)).drawRange.end=_drawLimit,_this.vertices.geometry=_geometry,_this.attribs=_this.random=attribs,_this.textureUsedDepth=usedDepth,_this.init(_geometry,_renderer,_size)}defer(createBuffer),this.createFloatArray=function(components=3){return new Float32Array(_size*_size*components)},this.createFloatArrayAsync=async function(components=3,freshCopy){let{array:array}=await AntimatterUtil.createFloatArray(_size*_size*components,freshCopy);return array},this.ready=function(callback){return _this.wait(_this,"vertices")},this.useShader=function(vs,fs,params){"object"==typeof fs&&(params=fs,fs=null),this.vertexShader=vs,this.fragmentShader=fs||vs,this.uniforms=params},this.createMesh=this.getMesh=function(){let shader=_this.createShader(_this.fragmentShader||"AntimatterBasicFrag");return _this.mesh=new Points(_geometry,shader),_this.mesh.frustumCulled=!1,_this.shader=shader,_this.geometry=_geometry,_this.mesh},this.createShader=function(fs){let uniforms=_this.uniforms||{};const nuke=function findNuke(){let p=_this.parent;for(;p;){if(p.nuke)return p.nuke;p=p.parent}for(p=_this.parent;p;){if(p.nuke)return p.nuke;p=p.group?p.group._parent:p.parent||p._parent}return World.NUKE}();_this._nuke=nuke;let obj={tPos:{type:"t",value:_this.vertices.texture,ignoreUIL:!0},tPrevPos:{type:"t",value:_this.vertices.texture,ignoreUIL:!0},uDPR:{value:nuke?.dpr||1,ignoreUIL:!0}};for(let key in uniforms)obj[key]=uniforms[key];let shader=new Shader(_this.vertexShader||"AntimatterPosition",fs,obj),vs=shader.vertexShader;if(vs&&!vs.includes("uniform sampler2D tPos")){let split=vs.split("__ACTIVE_THEORY_LIGHTS__"),defined="uniform sampler2D tPos;";shader.vertexShader=split[0]+"\n"+defined+"\n__ACTIVE_THEORY_LIGHTS__\n"+split[1]}return shader._parentnuke=nuke,shader},this.getLookupArray=function(){return new Float32Array(_this.vertices.geometry.attributes.position.array)},this.getRandomArray=function(){return _geometry.attributes.random.array},this.overrideShader=function(original){let shader=original.clone();shader._parentnuke=_this._nuke,original.copyUniformsTo(shader),shader.uniforms.tPos={type:"t",value:_this.vertices.texture,ignoreUIL:!0},shader.uniforms.tPrevPos={type:"t",value:_this.vertices.texture,ignoreUIL:!0},shader.uniforms.uDPR={value:shader?._parentnuke?.dpr||1,ignoreUIL:!0},_this.shader=shader,_this.mesh.shader=shader},this.upload=async function(needsMesh){_this.preventRender=!0,_geometry.distributeBufferData=!0,await _this.ready(),await _this.vertices.uploadAsync(),await defer(),await _this.random.uploadAsync(),await defer(),_this.mesh&&needsMesh&&(_this.mesh.upload(),await _geometry.uploadBuffersAsync());for(let key in _this.shader.uniforms){let uniform=_this.shader.uniforms[key];uniform.value&&(uniform.value.uploadAsync?await uniform.value.uploadAsync():uniform.value.upload&&(uniform.value.upload(),await defer()))}await _this.wait(100);for(let i=0;i<_this.passes.length;i++)await _this.passes[i].upload();_this.preventRender=!1},this.uploadSync=async function(needsMesh){await _this.ready(),_this.customClass&&_this.customClass.loaded&&await _this.customClass.loaded();for(let i=0;i<4;i++)_this.update()},this.get("particleCount",(_=>_num)),this.get("textureSize",(_=>_size)),this.get("powerOf2",(_=>Math.pow(2,Math.ceil(Math.log(Math.sqrt(_num))/Math.log(2)))))})),Class((function AntimatterAttribute(_data,_components){Inherit(this,Component);var _this=this,_size=Math.sqrt(_data.length/(_components||3));this.size=_size,this.count=_size*_size,this.buffer=_data,this.texture=new DataTexture(_data,_size,_size,4==_components?Texture.RGBAFormat:Texture.RGBFormat,Texture.FLOAT),this.set("needsUpdate",(function(){_this.texture&&(_this.texture.needsUpdate=!0)})),this.bufferData=function(data,components){_this.buffer=data,components!=_components?(_this.texture.destroy(),_this.texture=new DataTexture(data,_size,_size,4==components?Texture.RGBAFormat:Texture.RGBFormat,Texture.FLOAT)):(_this.texture.data=data,_this.texture.needsUpdate=!0),_components=components,_data=data},this.upload=function(){_this.texture.upload()},this.uploadAsync=function(){return _this.texture.distributeTextureData=!0,_this.texture.upload(),_this.texture.uploadAsync()},this.clone=function(){return new AntimatterAttribute(_data,_components)},this.onDestroy=function(){_this.texture&&_this.texture.destroy&&_this.texture.destroy()}})),Class((function AntimatterFBO(){var _this,_gpuGeom,_renderer,_size,_prevRT,_scene,_mesh,_camera,_copy,_geometry;Inherit(this,Component);var _output={type:"t",value:null,ignoreUIL:!0},_prevOutput={type:"t",value:null,ignoreUIL:!0};function copy(input,output){World.RENDERER.blit(input,output)||(_copy.visible=!0,_mesh.visible=!1,_copy.shader.uniforms.tMap.value=input,_renderer.renderSingle(_copy,_camera,output),_copy.visible=!1,_mesh.visible=!0)}this.passes=[],this.init=function(geometry,renderer,size){_this=this,_gpuGeom=geometry.attributes.position.array,_renderer=renderer,_size=size,function initPasses(){_camera=World.CAMERA,_geometry=World.QUAD,_scene=new Scene,(_mesh=new Mesh(_geometry,null)).frustumCulled=!1,_mesh.noMatrices=!0,_mesh.transient=!0,_scene.add(_mesh);let copyShader=AntimatterFBO.getCopyShader();(_copy=new Mesh(_geometry,copyShader)).noMatrices=!0,_scene.add(_copy),_copy.visible=!1}()},this.getGPUGeom=function(){return _gpuGeom},this.addPass=function(pass,index){_this=this,pass.init||pass.initialize(_size),"number"!=typeof index?_this.passes.push(pass):_this.passes.splice(index,0,pass)},this.findPass=function(name){_this=this;for(var i=0;i<_this.passes.length;i++){var pass=_this.passes[i];if(pass.name==name)return pass}},this.removePass=function(pass){_this=this,"number"==typeof pass?_this.passes.splice(pass):_this.passes.remove(pass)},this.update=function(){if((_this=this).mesh&&!_this.preventRender){var output=_output.value||_this.vertices.texture;_this.storeVelocity&&(_prevRT?(copy(_output.value,_prevRT),_prevOutput.value=_prevRT):(_prevOutput.value=output,(_prevRT=_this.passes[0].getRT(0).clone()).upload()));for(var i=0;i<_this.passes.length;i++){var pass=_this.passes[i],needsInit=!pass.init,firstRender=!pass.first;needsInit&&pass.initialize(_size),pass.first=!0,_mesh.shader=pass.shader,_mesh.shader.uniforms.tInput.value=firstRender?_this.vertices.texture:pass.output,pass.ready||(_mesh.shader.uniforms.tInput.value=_this.vertices.texture);var rt=firstRender?pass.getRT(0):pass.getWrite();output=pass.output;_renderer.renderSingle(_scene.children[0],_camera,rt),copy(rt,output),pass.swap()}output&&(_output.value=output,_this.mesh.shader.uniforms.tPos.value=_output.value,_this.mesh.shader.uniforms.tPrevPos.value=_prevOutput.value,_this.mesh.shader.uniforms.uDPR.value=_this.mesh?.shader?._parentnuke?.dpr||1)}},this.onDestroy=function(){_this.vertices&&_this.vertices.destroy&&_this.vertices.destroy(),_this.attribs&&_this.attribs.destroy&&_this.attribs.destroy(),_this.passes.forEach((function(pass){pass.first=!1,_this.persistPasses||pass&&pass.destroy&&pass.destroy()})),_this.mesh.destroy()},this.getOutput=function(){return _output},this.getPrevOutput=function(){return _prevOutput}}),(function(){var _shader;AntimatterFBO.getCopyShader=function(){return _shader||((_shader=new Shader("ScreenQuad")).addUniforms({tMap:{type:"t",value:null}}),_shader._attachmentData={format:Texture.RGBAFormat,type:Texture.FLOAT,attachments:1}),_shader}})),Class((function AntimatterPass(_shader,_uni,_clone){var _this=this;this.UILPrefix="am_"+_shader;const _uniforms={tInput:{type:"t",value:null,ignoreUIL:!0},fSize:{type:"f",value:64,ignoreUIL:!0}};var _rts=[],_read=0,_write=0;function prepareShader(code,type){if("vs"==type)return code;let header=["uniform sampler2D tInput;","uniform float fSize;","varying vec2 vUv;",Shaders.getShader("antimatter.glsl")].join("\n"),mainAt=code.indexOf("void main()"),before=code.slice(0,mainAt),after=code.slice(mainAt);return code=before+header+after,_this.onCreateShader&&(code=_this.onCreateShader(code)),code}function initRT(size){var type="ios"==Device.system.os&&Renderer.type==Render.WEBGL1?Texture.HALF_FLOAT:Texture.FLOAT,parameters={minFilter:Texture.NEAREST,magFilter:Texture.NEAREST,format:Texture.RGBAFormat,type:type},rt=new RenderTarget(size,size,parameters);return rt.texture.generateMipmaps=!1,rt}this.uniforms=_uniforms,this.output=initRT(64),this.name=_shader,this.id=Utils.timestamp(),this.ready=!1,function(){if(_uni)for(var key in _uni.unique&&(_this.UILPrefix+="_"+_uni.unique.replace("/","_"),delete _uni.unique),_uni.customCompile&&(_this.customCompile=_uni.customCompile||"",delete _uni.customCompile),_uni)_uniforms[key]=_uni[key]}(),this.addInput=function(name,attribute){var uniform="object"!=typeof attribute||attribute.height||"string"!=typeof attribute.type?attribute instanceof AntimatterAttribute?{type:"t",value:attribute.texture,ignoreUIL:!0}:attribute instanceof AntimatterPass?{type:"t",value:attribute.output,ignoreUIL:!0}:{type:"t",value:attribute,ignoreUIL:!0}:attribute;let lookup=UILStorage.parse(_this.UILPrefix+name);lookup&&(uniform.value=lookup.value);let uniforms=_shader&&_shader.uniforms?_shader.uniforms:_uniforms;return uniforms[name]=uniform,uniform.ignoreUIL=!0,uniforms[name]},this.addUniforms=function(object){let uniforms=_shader&&_shader.uniforms?_shader.uniforms:_uniforms;for(let key in object){let uniform=object[key],lookup=UILStorage.parse(_this.UILPrefix+key);if(lookup){if(Array.isArray(lookup.value))switch(lookup.value.length){case 2:lookup.value=(new Vector2).fromArray(lookup.value);break;case 3:lookup.value=(new Vector3).fromArray(lookup.value);break;case 4:lookup.value=(new Vector4).fromArray(lookup.value)}uniform.value=lookup.value}uniforms[key]=uniform}},this.getRT=function(index){return _rts[index]},this.getRead=function(){return _rts[_read]},this.getWrite=function(){return _rts[_write]},this.setRead=function(index){_read=index},this.setWrite=function(index){_write=index},this.swap=function(){++_write>2&&(_write=0,_this.ready=!0),++_read>2&&(_this.onInit&&(_this.onInit(),_this.onInit=null),_read=0)},this.initialize=function(size){if(!_this.init){_this.init=!0;for(var i=0;i<3;i++)_rts.push(initRT(size));_this.output.setSize(size,size),_shader instanceof Shader||((_shader=new Shader("AntimatterPass",_shader,{customCompile:_this.customCompile}))._attachmentData={format:Texture.RGBAFormat,type:Texture.FLOAT,attachments:1},_shader.preCompile=prepareShader,_shader.addUniforms(_uniforms),_this.uniforms=_shader.uniforms,_shader.UILPrefix=_this.UILPrefix,_shader.id=Utils.timestamp()),_this.shader=_shader,_shader.uniforms.fSize.value=size}},this.setUniform=function(key,value){_uniforms[key]||(_uniforms[key]={value:value}),_uniforms[key].value=value,_shader&&_shader.uniforms&&(_shader.uniforms[key].value=value)},this.getUniform=function(key){return _shader&&_shader.uniforms?_shader.uniforms[key].value:null},this.tween=function(key,value,time,ease,delay,callback,update){return tween(_shader.uniforms[key],{value:value},time,ease,delay,callback,update)},this.clone=function(){return new AntimatterPass(_shader,_uni)},this.destroy=function(){_rts.forEach((function(rt){rt&&rt.destroy&&rt.destroy()}))},this.upload=async function(){_shader.upload(),await defer();for(let i=0;i<_rts.length;i++)_rts[i].upload(),await defer();for(let key in _shader.uniforms){let uniform=_shader.uniforms[key];uniform.value&&(uniform.value.uploadAsync?await uniform.value.uploadAsync():uniform.value.upload&&(uniform.value.upload(),await defer()))}}})),Class((function AntimatterSpawn(_proton,_group,_input){Inherit(this,Component);const _this=this;var _life,_pass,_velocity,_color,_index=-1,_total=_proton.particleCount,_releasedA=[],_releasedB=[],_temp0=[],_temp1=[],_temp2=[],_vec=new Vector3;function loop(){let count=_releasedA.length;for(let i=count-1;i>-1;i--){let index=_releasedA[i];_life.buffer[4*index+0]=0}_releasedA.length=0,count&&(_life.needsUpdate=!0);let hold=_releasedA;_releasedA=_releasedB,_releasedB=hold}!async function(){await async function initPass(){let[lifeBuffer,velocityBuffer]=await Promise.all([_proton.antimatter.createFloatArrayAsync(4,!0),_proton.antimatter.createFloatArrayAsync(3,!0)]);_life=_this.initClass(AntimatterAttribute,lifeBuffer,4),_velocity=_this.initClass(AntimatterAttribute,velocityBuffer,3),_pass=_this.initClass(AntimatterPass,"AntimatterSpawn",{unique:_input.prefix,uMaxCount:_proton.behavior.uniforms.uMaxCount,tAttribs:_proton.behavior.uniforms.tAttribs,tLife:{value:_life,ignoreUIL:!0},uSetup:{value:1,ignoreUIL:!0},decay:{value:1},HZ:{value:Render.HZ_MULTIPLIER,ignoreUIL:!0},decayRandom:{value:new Vector2(1,1)}}),ShaderUIL.add(_pass,_group).setLabel("Life Shader"),_pass.onInit=_=>{_pass.setUniform("uSetup",0),_this.canEmit=!0},_proton.behavior.addInput("tSpawn",_pass),_proton.behavior.addInput("tVelocity",_velocity),_proton.shader.addUniforms({tLife:{value:_pass.output}}),_proton.antimatter.addPass(_pass,0),_this.lifeOutput=_pass.output}(),_this.startRender(loop)}(),this.emit=function(position,velocity,color){if(!_this.canEmit)return;if(velocity&&position.length!=velocity.length)throw"Position and velocity need to be the same length";if(color&&position.length!=color.length)throw"Position and color need to be the same length";let count=position.length/3;for(let i=0;i<count;i++){let index=++_index;_index>=_total&&(_index=-1),_life.buffer[4*index+0]=1,_life.buffer[4*index+1]=position[3*i+0],_life.buffer[4*index+2]=position[3*i+1],_life.buffer[4*index+3]=position[3*i+2],velocity&&(_velocity.buffer[3*index+0]=velocity[3*i+0],_velocity.buffer[3*index+1]=velocity[3*i+1],_velocity.buffer[3*index+2]=velocity[3*i+2]),color&&_color&&(_color.buffer[3*index+0]=color[3*i+0],_color.buffer[3*index+1]=color[3*i+1],_color.buffer[3*index+2]=color[3*i+2]),_releasedB.push(index)}_life.needsUpdate=!0,velocity&&(_velocity.needsUpdate=!0),color&&_color&&(_color.needsUpdate=!0)},this.release=function(pos,count=1,radius=0,velocity,color){if(!_this.canEmit)return;let positions=_temp0,velocities=velocity?_temp1:null,colors=color?_temp2:null,radX=Array.isArray(radius)?radius[0]:radius,radY=Array.isArray(radius)?radius[1]:radius,radZ=Array.isArray(radius)?radius[2]:radius;for(let i=0;i<count;i++)pos.spherical?(_vec.set(Math.random(-1,1,4),Math.random(-1,1,4),Math.random(-1,1,4)).normalize().multiplyScalar(radX),positions[3*i+0]=pos.x+_vec.x,positions[3*i+1]=pos.y+_vec.y,positions[3*i+2]=pos.z+_vec.z):(positions[3*i+0]=pos.x+Math.random(-1,1,4)*radX,positions[3*i+1]=pos.y+Math.random(-1,1,4)*radY,positions[3*i+2]=pos.z+Math.random(-1,1,4)*radZ),velocities&&(velocities[3*i+0]=velocity.x,velocities[3*i+1]=velocity.y,velocities[3*i+2]=velocity.z),colors&&(colors[3*i+0]=color.r,colors[3*i+1]=color.g,colors[3*i+2]=color.b);_this.emit(positions,velocities,colors),_temp0.length=0,_temp1.length=0,_temp2.length=0},this.upload=async function(){await(_life?.uploadAsync()),await(_velocity?.uploadAsync())},this.useColor=async function(shader){let colorBuffer=await _proton.antimatter.createFloatArrayAsync(3,!0);_color=_this.initClass(AntimatterAttribute,colorBuffer,3),shader||(shader=_proton.shader),shader.addUniforms({tColor:{value:_color}}),_proton.behavior.addInput("tColor",_color)},this.applyToShader=function(shader){shader.uniforms.tLife=_proton.shader.uniforms.tLife,_velocity&&(shader.uniforms.tVelocity={value:_velocity}),_color&&(shader.uniforms.tColor={value:_color})},this.ready=function(){return this.wait("canEmit")},this.get("total",(_=>_total)),this.get("index",(_=>_index)),this.set("index",(i=>_index=i))})),Class((function AntimatterUtil(){Inherit(this,Component);var _thread,_this=this,_promises={};function createBufferArrayAntimatter(e,id){let size=e.size,num=e.num,position=new Float32Array(size*size*3);if(window.NativeUtils)NativeUtils.fillBufferUV(position,num,size);else{let h=.5/size;for(let i=0;i<num;i++)position[3*i+0]=h+i%size/size,position[3*i+1]=h+Math.floor(i/size)/size,position[3*i+2]=i}let{w:w,h:h,d:d}=e.dimensions,usedDepth=num/(size*size),grid=0==w[0]&&0==w[1]&&0==h[0]&&0==h[1];var vertices=new Float32Array(size*size*4);if(window.NativeUtils)grid?NativeUtils.fillBufferGrid(vertices,num,size,usedDepth):NativeUtils.fillBufferRange(vertices,num,w[0],w[1],h[0],h[1],d[0],d[1]);else for(let i=0;i<num;i++)null!=e.pointData?(vertices[4*i+0]=e.pointData.positions[3*i+0],vertices[4*i+1]=e.pointData.positions[3*i+1],vertices[4*i+2]=e.pointData.positions[3*i+2]):grid?(vertices[4*i+0]=Math.range(i%size,0,size,-1,1),vertices[4*i+1]=Math.range(i/size,size*usedDepth*usedDepth,0,-1,1)):(vertices[4*i+0]=Math.random(w[0],w[1],10),vertices[4*i+1]=Math.random(h[0],h[1],10),vertices[4*i+2]=Math.random(d[0],d[1],10)),vertices[4*i+3]=1;var attribs=new Float32Array(size*size*4);if(null!=e.pointData&&e.pointData.random)for(let i=0;i<num;i++)attribs[4*i+0]=e.pointData.random[4*i+0],attribs[4*i+1]=e.pointData.random[4*i+1],attribs[4*i+2]=e.pointData.random[4*i+2],attribs[4*i+3]=e.pointData.random[4*i+3];else if(window.NativeUtils)NativeUtils.fillBufferRandom(attribs,attribs.length);else for(let i=0;i<num;i++)attribs[4*i+0]=Math.random(0,1,10),attribs[4*i+1]=Math.random(0,1,10),attribs[4*i+2]=Math.random(0,1,10),attribs[4*i+3]=Math.random(0,1,10);resolve({geometry:position,vertices:vertices,attribs:attribs,usedDepth:usedDepth},id,[position.buffer,vertices.buffer,attribs.buffer])}function createFloatArrayAntimatter({size:size},id){let array=new Float32Array(size);resolve({array:array},id,[array.buffer])}this.cache=!0,this.createBufferArray=function(size,num,config={},_pointData=null){let key;if(_thread||function initThread(){_thread=!0,Thread.upload(createBufferArrayAntimatter),Thread.upload(createFloatArrayAntimatter)}(),_this.cache&&(key=`buffer_${JSON.stringify(config)}_${size}_${num}`,_promises[key]))return _promises[key];let promise=Promise.create();key&&(_promises[key]=promise);let buffers=[];return _pointData?.positions.buffer&&buffers.push(_pointData?.positions.buffer),Thread.shared().createBufferArrayAntimatter({size:size,num:num,dimensions:config,pointData:_pointData},buffers).then((data=>{data.attribs=new AntimatterAttribute(data.attribs,4),data.vertices=new AntimatterAttribute(data.vertices,4);let geometry=data.geometry;data.geometry=new Geometry,data.geometry.addAttribute("position",new GeometryAttribute(geometry,3)),data.geometry.addAttribute("random",new GeometryAttribute(data.attribs.buffer,4)),promise.resolve(data)})),promise},this.createFloatArray=function(size,freshCopy){if(freshCopy||!_this.cache)return Thread.shared().createFloatArrayAntimatter({size:size});if(_promises[`float_size${size}`])return _promises[`float_size${size}`];return _promises[`float_size${size}`]=Thread.shared().createFloatArrayAntimatter({size:size})}}),"static"),Class((function Audio3D(_options){Inherit(this,Component);const _this=this;var _bindingLabel;const _config=require("Audio3DConfig");function onVisibility(e){if(!_this.context||!GlobalAudio3D.blurs)return;let hasFocus="focus"===e.type;_this.context.visibilityMuted=!hasFocus,(_this.context.playing||_this.flag("wasPlaying"))&&(hasFocus?(_this.flag("wasPlaying",!1),_this.context.play()):(_this.flag("wasPlaying",!0),_this.context.pause()))}!function initContext(){_options||(_options={}),GlobalAudio3D.native?(window._al&&(_this.context=_this.initClass(Audio3DALBuffer)),window.AVFSound&&(_this.context=_this.initClass(Audio3DNBuffer,"AVF")),window.MPAudio&&(_options.stream?_this.context=_this.initClass(Audio3DNBuffer,"MP"):_this.context=_this.initClass(Audio3DNBuffer,"GVR"))):_options.fallback||GlobalAudio3D.fallback?_this.context=_this.initClass(Audio3DFallback):_options.positional&&GlobalAudio3D.resonanceAudio?_this.context=_this.initClass(Audio3DResonanceAudio):_options.simpleBuffer&&"ie"!==Device.system.browser?_this.context=_this.initClass(Audio3DWASimpleBuffer):!0!==_options.stream&&"ie"!==Device.system.browser?_this.context=_this.initClass(Audio3DWABuffer):_this.context=_this.initClass(Audio3DWAStream)}(),function initInterface(){for(let command of _config.commands)_this[command]=_this.context[command];for(let setter of _config.setters)_this.set(setter,(e=>{_this.context&&(_this.context[setter]=e)}));for(let getter of _config.getters)_this.get(getter,(_=>{if(_this.context)return _this.context[getter]}))}(),function addHandlers(){_this.events.sub(_this.context,Events.END,(e=>_this.events.fire(Events.END,e))),_this.events.sub(_this.context,Events.LOADED,(e=>_this.events.fire(Events.LOADED,e))),_this.events.sub(Events.VISIBILITY,onVisibility)}(),function initOptions(){if(_options){for(let option in _options)_config.setters.includes(option)&&(_this.context[option]=_options[option]);_options.label&&(_bindingLabel=GlobalAudio3D.getLabelState(_options.label).bind("mute",(async bool=>{if(!_this.context)return _bindingLabel.destroy();_this.context.muted=bool})))}}(),this.tween=function(){return tween(_this,...arguments)},this.clone=function(){return new Audio3D(_options)},this.onDestroy=function(){_this.context.unload(),_bindingLabel?.destroy?.()}})),Class((function Audio3DLayer(...args){Inherit(this,Component);const _this=this;var _group,_input,_mesh,_audio3D,_config,_key,_autoplay,_volume={value:0},_captionsSetup="undefined"!=typeof CaptionsController;async function fadeIn(){_this.flag("init")||await _this.wait("init");let captionsPath=_config.get("captions");_captionsSetup&&captionsPath&&_config.get("enableCaptions")&&await async function loadCaptions(path){await CaptionsController.instance().load(path)}(captionsPath);let delay=_config.getNumber("delay");if(delay&&await _this.wait(delay),_audio3D.play(),_captionsSetup&&captionsPath&&_config.get("enableCaptions")&&toggleCaptions(!0),0!=_config.getNumber("fadeInTime")){_volume.value=0,_audio3D.volume=0;let volumeTween=tween(_volume,{value:_config.getNumber("volume")},_config.getNumber("fadeInTime"),"easeOutExpo");volumeTween.onUpdate((()=>{_audio3D.volume=_volume.value})),await volumeTween.promise()}}async function fadeOut(){if(_this.flag("init")||await _this.wait("init"),_captionsSetup&&_config.get("captions")&&_config.get("enableCaptions")&&toggleCaptions(!1),0!=_config.getNumber("fadeOutTime")){_volume.value=_config.getNumber("volume");let volumeTween=tween(_volume,{value:0},_config.getNumber("fadeOutTime"),"easeOutExpo",0);volumeTween.onUpdate((()=>{_audio3D.volume=_volume.value})),volumeTween.onComplete((()=>{_audio3D.context&&_audio3D.context.stream&&Audio3DWA.getActiveStreamCount(_audio3D.context.stream)>1||_audio3D.pause()})),await volumeTween.promise()}else{if(_audio3D.context&&_audio3D.context.stream&&Audio3DWA.getActiveStreamCount(_audio3D.context.stream)>1)return;_audio3D.pause()}}function toggleCaptions(bool=!1){bool?CaptionsController.instance().start():CaptionsController.instance().stop()}!function parseArgs(){args.forEach((arg=>{switch(Utils.getConstructorName(arg)){case"InputUILConfig":_input=arg;break;case"UILFolder":_group=arg;break;case"Mesh":_mesh=arg,_this.parent=_mesh,_mesh.audioCount?_mesh.audioCount++:_mesh.audioCount=1,_mesh.findSound||(_mesh.shader.visible=!1,_mesh.findSound=async function(key){if(!Array.isArray(_mesh.scriptClass))return _mesh.scriptClass;for(let scriptClass of _mesh.scriptClass)if(await scriptClass.key==key)return scriptClass})}})),_this.visible=_input.get("visible")}(),function initConfig(){let config=InputUIL.create(_input.prefix+"audio3dLayer"+(_mesh?_mesh.audioCount:""),_group);config.add("path").add("key").add("label").addToggle("autoplay",!1).addToggle("loop",!1).addToggle("stream",!1).addToggle("positional",!1).addNumber("volume",1).addNumber("rolloff",1).addNumber("fadeInTime",0).addNumber("fadeOutTime",0).addNumber("delay",0).addNumber("gain",1).setLabel("Audio"),config.addButton("preview",{label:"Preview",actions:[{title:"Play",callback:fadeIn},{title:"Stop",callback:fadeOut}]}),_captionsSetup&&config.add("captions").addToggle("enableCaptions",!1),config.onUpdate=key=>{if(_audio3D)switch(key){case"autoplay":case"loop":_audio3D[key]=_config.get(key);break;case"volume":case"rolloff":case"gain":_audio3D[key]=_config.getNumber(key)}},_config=config}(),async function initAudio(){GlobalAudio3D.initialized||await GlobalAudio3D.interacted,_key=_config.get("key"),_autoplay=_config.get("autoplay");let path=Assets.getPath(_config.get("path"));if(path){_audio3D=_this.initClass(Audio3D,{src:path,autoplay:!1,volume:_config.getNumber("volume"),loop:_config.get("loop"),stream:_config.get("stream"),positional:_config.get("positional"),label:_config.get("label"),rolloff:_config.getNumber("rolloff")});let gain=_config.get("gain");"string"==typeof gain&&(gain=Number(gain)),isFinite(gain)&&(_audio3D.gain=gain),_mesh&&_mesh.add(_audio3D.group),_this.flag("init",!0)}}(),_this.startRender((()=>{})),this.get("audio",(()=>_audio3D)),this.play=async function(){await fadeIn()},this.stop=async function(){await fadeOut()},this.get("key",(async()=>(await _this.wait("init"),_key))),_this.set("volume",(volume=>{_audio3D.volume=volume})),_this.set("rolloff",(rolloff=>{_audio3D.rolloff=rolloff})),this.onVisible=async function(){_this.flag("init")||await _this.wait("init"),_audio3D&&_autoplay&&await fadeIn()},this.onInvisible=async function(){_this.flag("init")||await _this.wait("init"),_audio3D&&await fadeOut()},this.onDestroy=function(){_audio3D&&fadeOut()}})),Class((function GlobalAudio3D(){Inherit(this,Component);const _this=this;var _volume=1,_muted=!1,_blurs=!0,_playbackRate=1,_poolSize=1,_interacted=Promise.create(),_labelStates={};function initInteraction(e){_this.initialized||(e&&e.preventDefault&&e.preventDefault(),document.removeEventListener(Device.mobile?"touchend":"mouseup",initInteraction,{passive:!1}),"undefined"!=typeof XRDeviceManager&&_this.events.unsub(XRDeviceManager.SESSION_START,initInteraction),Audio3DWA.createPool(_poolSize),_this.initialized=!0,_this.events.fire(Events.READY),_interacted.resolve())}this.native=!1,this.TRANSPARENT=0,this.ACOUSTIC_CEILING_TILES=1,this.BRICK_BARE=2,this.BRICK_PAINTED=3,this.CONCRETE_BLOCK_COARSE=4,this.CONCRETE_BLOCK_PAINTED=5,this.CURTAIN_HEAVY=6,this.FIBER_GLASS_INSULATION=7,this.GLASS_THICK=8,this.GLASS_THIN=9,this.GRASS=10,this.LINOLEUM_ON_CONCRETE=11,this.MARBLE=12,this.METAL=13,this.PARQUET_ON_CONCRETE=14,this.PLASTER_ROUGH=15,this.PLASTER_SMOOTH=16,this.PLYWOOD_PANEL=17,this.POLISHED_CONCRETE_OR_TILE=18,this.SHEET_ROCK=19,this.WATER_OR_ICE_SURFACE=20,this.WOOD_CEILING=21,this.WOOD_PANEL=22,this.LOW=0,this.MED=1,this.HIGH=2,this.RESONANCE_AUDIO="resonance_audio",this.quality=this.HIGH,async function(){await defer(),window.AURA&&function initNative(){_this.native=!0,!window._al||Audio3DAL.init();_this.initialized=!0,_interacted.resolve()}(),function initDebug(){Hydra.LOCAL&&Utils.query("audioDebug")&&(AudioNode.prototype.connect=(func=AudioNode.prototype.connect,function(){var target=arguments[0];return(this.outputs||(this.outputs=[])).push(arguments[0]),(target.inputs||(target.inputs=[])).push(this),func.apply(this,arguments)}));var func}()}(),this.set("volume",(v=>{_volume=v,_this.events.fire(Events.UPDATE,{volume:_volume})})),this.get("volume",(_=>_volume)),this.set("muted",(v=>{_muted=v,_this.events.fire(Events.UPDATE,{muted:_muted})})),this.get("muted",(_=>_muted)),this.set("blurs",(v=>{_blurs=v,_this.events.fire(Events.UPDATE,{blurs:_blurs})})),this.get("blurs",(_=>_blurs)),this.set("playbackRate",(v=>{_playbackRate=v,_this.events.fire(Events.UPDATE,{playbackRate:_playbackRate})})),this.get("playbackRate",(_=>_playbackRate)),this.get("pool",(_=>_poolSize)),this.set("pool",(n=>{_poolSize=n})),this.get("interacted",(_=>_interacted)),this.get("fallback",(_=>!1)),this.setup=function(type="default"){Utils.query("muted")&&Hydra.LOCAL&&(_muted=!0),Device.mobile?_this.events.sub(Mouse.input,Interaction.CLICK,initInteraction):document.addEventListener(Device.mobile?"touchend":"mouseup",initInteraction,{passive:!1}),"undefined"!=typeof XRDeviceManager&&_this.events.sub(XRDeviceManager.SESSION_START,initInteraction),"resonance_audio"!=type||_this.native||_this.fallback||(_this.resonanceAudio=!0,AssetLoader.loadAssets(["assets/js/lib/_resonance/resonance-audio.min.js"]))},this.ready=function(){return _this.wait(_this,"initialized")},this.enableRoom=function(bool){window.GVRAudio&&GVRAudio.enableRoom(bool)},this.setRoomProperties=function(x,y,z,wall,ceiling,floor){window.GVRAudio&&GVRAudio.setRoomProperties(x,y,z,wall,ceiling,floor)},this.setRoomReverbAdjustments=function(gain,time,brightness){window.GVRAudio&&GVRAudio.setRoomReverbAdjustments(gain,time,brightness)},this.muteLabel=function(label){_this.getLabelState(label).set("mute",!0)},this.unmuteLabel=function(label){_this.getLabelState(label).set("mute",!1)},this.getLabelState=function(label){return _labelStates[label]||(_labelStates[label]=AppState.createLocal()),_labelStates[label]}}),"static"),Class((function SFXController(){Inherit(this,Component);const _this=this,POOL_SIZE=1;var _pool,_srcMap={},_preloaded={},_activeSounds={};function init(){!function initPool(){_pool=_this.initClass(ObjectPool);let sfx=[];for(;sfx.length<POOL_SIZE;)sfx.push(generate());_pool.insert(sfx)}(),defer((()=>{let wasMuted=_this.muted;_this.initialized=!0,wasMuted!==_this.muted&&_this.events.fire(_this.muted?SFXController.AUDIO_MUTED:SFXController.AUDIO_UNMUTED)}))}function generate(){return _this.initClass(Audio3D,{simpleBuffer:!0})}function handleToggle(){let nextMuted=!GlobalAudio3D.muted;_this.initialized||(nextMuted=!1),nextMuted!==GlobalAudio3D.muted&&(GlobalAudio3D.muted=nextMuted),_this.initialized&&_this.events.fire(nextMuted?SFXController.AUDIO_MUTED:SFXController.AUDIO_UNMUTED)}function handlePlayRequest({name:name,...options}){_this.play(name,options)}function handleStopRequest({name:name,...options}){_this.stop(name,options)}!async function(){let muted=!0===Storage.get("muted");muted!==GlobalAudio3D.muted&&(GlobalAudio3D.muted=muted),GlobalAudio3D.initialized?init():_this.events.sub(GlobalAudio3D,Events.READY,init),function addListeners(){_this.events.sub(SFXController.TOGGLE_AUDIO,handleToggle),_this.events.sub(SFXController.PLAY_SFX,handlePlayRequest),_this.events.sub(SFXController.STOP_SFX,handleStopRequest)}()}(),this.registerSounds=function(srcMap){_srcMap={..._srcMap,...srcMap},Object.keys(_srcMap).forEach((name=>{_activeSounds[name]=[]}))},this.registerSound=function(name,src){_srcMap[name]=src,_activeSounds[name]=[]},this.preload=async function(name){let src=_srcMap[name];if(!src)return console.warn(`missing sound '${name}'`);let sound=_preloaded[name];return sound||(sound=_preloaded[name]=generate()),sound.src=src,sound.load()},this.play=async function(name,options={}){if(!_this.initialized){let timeout=options.timeout||1e3;if(timeout<0)return;if(await Promise.timeout(_this.wait(_this,"initialized"),timeout),!_this.initialized)return}let sound,preloaded=_preloaded[name];if(preloaded&&(_activeSounds[name].includes(preloaded)?preloaded=void 0:sound=preloaded),!sound){let src=_srcMap[name];if(!src)return console.warn(`missing sound '${name}'`);sound=_pool.get(),null===sound&&(sound=generate()),sound.src=src}if(options.onBeforePlay){if(!1===await options.onBeforePlay(sound))return void(preloaded||_pool.put(sound))}_activeSounds[name].push(sound);let promise=Promise.create();return _this.events.sub(sound,Events.END,(function onSoundEnd(){_this.events.unsub(sound,Events.END,onSoundEnd),preloaded||_pool.put(sound),_activeSounds[name].remove(sound),promise.resolve()})),sound.play(),promise},_this.stop=function(name){let sound=_activeSounds[name][0];sound&&sound.stop()},_this.muted=!1,_this.get("preloaded",(()=>_preloaded)),_this.get("activeSounds",(()=>_activeSounds))}),"singleton",(()=>{SFXController.AUDIO_MUTED="sfx_muted",SFXController.AUDIO_UNMUTED="sfx_unmuted",SFXController.TOGGLE_AUDIO="sfx_toggle_mute",SFXController.PLAY_SFX="SFXAssetsController.PLAY_SFX",SFXController.STOP_SFX="SFXAssetsController.STOP_SFX"})),Module((function Audio3DConfig(){this.exports={getters:["playbackRate","loop","autoplay","volume","rolloff","preload","visibilityMuted","selfDestruct","src","frequency","group","duration","currentTime","activity","playing","filter","panner","delay","progress","reverb","gain","sourceWidth","directivitySharpness","directivityAlpha"],setters:["playbackRate","loop","autoplay","volume","rolloff","preload","visibilityMuted","selfDestruct","src","gain","sourceWidth","directivitySharpness","directivityAlpha"],commands:["play","pause","stop","seek","load","unload","convolve"]}})),Module((function Audio3DSilence(){this.exports="data:audio/mpeg;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAADAAAGhgBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr///////////////////////////////////////////8AAAA5TEFNRTMuOThyAc0AAAAAAAAAABSAJAiqQgAAgAAABobxtI73AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAACFEII9ACZ/sJZwWEoEb8w/////N//////JcxjHjf+7/v/H2PzCCFAiDtGeyBCIx7bJJ1mmEEMy6g8mm2c8nrGABB4h2Mkmn//4z/73u773R5qHHu/j/w7Kxkzh5lWRWdsifCkNAnY9Zc1HvDAhjhSHdFkHFzLmabt/AQxSg2wwzLhHIJOBnAWwVY4zrhIYhhc2kvhYDfQ4hDi2Gmh5KyFn8EcGIrHAngNgIwVIEMf5bzbAiTRoAD///8z/KVhkkWEle6IX+d/z4fvH3BShK1e5kmjkCMoxVmXhd4ROlTKo3iipasvTilY21q19ta30/v/0/idPX1v8PNxJL6ramnOVsdvMv2akO0iSYIzdJFirtzWXCZicS9vHqvSKyqm5XJBdqBwPxyfJdykhWTZ0G0ZyTZGpLKxsNwwoRhsx3tZfhwmeOBVISm3impAC/IT/8hP/EKEM1KMdVdVKM2rHV4x7HVXZvbVVKN/qq8CiV9VL9jjH/6l6qf7MBCjZmOqsAibjcP+qqqv0oxqpa/NVW286hPo1nz2L/h8+jXt//uSxCmDU2IK/ECN98KKtE5IYzNoCfbw+u9i5r8PoadUMFPKqWL4LK3T/LCraMSHGkW4bpLXR/E6LlHOVQxmslKVJ8IULktMN06N0FKCpHCoYsjC4F+Z0NVqdNFoGSTjSiyjzLdnZ2fNqTi2eHKONONKLMPMKLONKLMPQRJGlFxZRoKcJFAYEeIFiRQkUWUeYfef//Ko04soswso40UJAgMw8wosososy0EalnZyjQUGBRQGIFggOWUacWUeYmuadrZziQKKEgQsQLAhQkUJAgMQDghltLO1onp0cpkNInSFMqlYeSEJ5AHsqFdOwy1DA2sRmRJKxdKRfLhfLw5BzUxBTUUzLjk4LjJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVUxBTUUzLjk4LjJVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/7ksRRA8AAAaQAAAAgAAA0gAAABFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU="})),Class((function Audio3DBase(){Inherit(this,Object3D);const _this=this;var _quaternion,_euler,_position=new Vector3;this.audioPosition=function(){return _position=_this.group._parent?_this.group.getWorldPosition():Audio3DWA.getCamera().getWorldPosition()},this.audioPositionInverse=function(){return _position=_this.audioPosition(),_this.group._parent&&_position.applyMatrix4(Audio3DWA.getCamera().matrixWorldInverse),_position},this.audioOrientationInverse=function(){return _quaternion||(_quaternion=new Quaternion,_euler=new Euler),_this.group.parent?(_this.group.getWorldQuaternion(_quaternion),_euler.setFromQuaternion(_quaternion)):_euler.set(0,0,0),_euler},this.listenerPosition=function(){return _this.group._parent&&(_position=Audio3DWA.getCamera().getWorldPosition()),_position}})),Class((function Audio3DFallback(){Inherit(this,Audio3DBase);const _this=this;var _stream,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){initOptions(),(_settings.autoplay||_options.autoplay)&&_this.play()}initOptions(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}(),this.set("src",(src=>{_this.unload(),function destroyStream(){_stream&&_stream.element&&(Audio3DWA.unloadStream(_settings.src),_stream=null)}(),_settings.src=src})),this.get("src",(_=>_settings.src)),this.set("volume",(v=>(v=Math.clamp(v,0,1),_options.volume=v,_stream&&_stream.element&&(_stream.element.volume=_options.muted||_options.globalMuted?0:v*Math.clamp(_options.globalVolume)),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_stream&&(_stream.element.loop=l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("frequency",(_=>0)),this.get("activity",(_=>0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{})),this.get("rolloff",(_=>0)),this.get("loaded",(_=>!0)),this.get("duration",(_=>_stream?_stream.element.duration:0)),this.get("currentTime",(_=>_stream?_stream.element.currentTime:0)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("progress",(_=>_this.currentTime/_this.duration)),this.set("playbackRate",(v=>{_options.playbackRate=v,_stream&&_stream.element&&(_stream.element.playbackRate=v*_options.globalPlaybackRate)})),this.get("playbackRate",(_=>_options.playbackRate)),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted?_options.muteState=_options.muted:void 0!==_options.muteState&&(muted=_options.muteState,delete _options.muteState),_options.muted!==muted&&(_options.muted=muted,_this.volume=_this.volume)})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.play=function(){if(_settings.autoplay=!0,_settings.src&&GlobalAudio3D.initialized&&(function createStream(){_stream||((_stream=Audio3DWA.loadStream(_settings.src)).element.onended=_=>{_this.unload(),_this.events.fire(Events.END)},_this.loop=_this.loop,_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,(_options.autoplay||_settings.autoplay)&&_this.play())}(),!0!==_settings.playing&&(_settings.playing=!0,_this.volume=_options.volume,_stream))){_stream.element.playbackRate=_options.playbackRate,_stream.element.play();try{_stream.element.currentTime=_currentTime}catch(e){}}},this.pause=function(){if(_settings.autoplay=!1,_stream&&GlobalAudio3D.initialized&&_settings.src&&_settings.playing){try{_currentTime=_stream.element.currentTime}catch(e){}_stream.element.pause(),_settings.playing=!1}},this.stop=function(){if(_settings.autoplay=!1,_settings.src&&GlobalAudio3D.initialized&&(_currentTime=0,_settings.playing=!1,_stream&&_stream.element&&_stream.element.stop)){_stream.element.stop();try{_stream.element.currentTime=0}catch(e){}}},this.seek=function(time){if(_settings.src&&(_currentTime=time,_stream&&_stream.element))try{_stream.element.currentTime=time}catch(e){}},this.load=function(){return!0},this.unload=function(){_settings.autoplay=!1,_stream&&_settings.src&&_this.stop()},this.convolve=function(src){}})),Class((function Audio3DN(){Inherit(this,Component);const _this=this;var _init;function loop(){window.GVRAudio&&(GVRAudio.setHeadPos(World.CAMERA.position.x,World.CAMERA.position.y,World.CAMERA.position.z),GVRAudio.setHeadRotation(World.CAMERA.quaternion.x,World.CAMERA.quaternion.y,World.CAMERA.quaternion.z,World.CAMERA.quaternion.w))}this.audioContext=function(){window.GVRAudio&&!_init&&(GVRAudio.initEngine(GlobalAudio3D.quality),_init=!0,_this.startRender(loop))}}),"static"),Class((function Audio3DNBuffer(_backingType){Inherit(this,Audio3DBase);const _this=this;var _backing,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){let pos,orientation;switch(_backingType){case"AVF":pos=_this.audioPositionInverse(),orientation=_this.audioOrientationInverse();break;case"GVR":pos=_this.audioPosition()}pos&&_backing&&(_backing.setPos(pos.x,pos.y,pos.z),orientation&&_backing.setOrientation(orientation.x||0,orientation.y||0,orientation.z||0,0,1,0))}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}Audio3DN.audioContext(),function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update)}(),this.set("src",(src=>{_this.stop(),_settings.src=src,defer((_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume}))})),this.get("src",(_=>_settings.src)),this.get("selfDestruct",(_=>_options.selfDestruct)),this.set("selfDestruct",(d=>{_options.selfDestruct=d})),this.set("volume",(v=>(_options.volume=v,_backing&&_backing.volume(v),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_backing&&_backing.loop(l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("frequency",(_=>[])),this.get("activity",(_=>0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{_options.rolloff=r})),this.get("rolloff",(_=>_options.rolloff)),this.get("loaded",(_=>_settings.loaded)),this.get("currentTime",(_=>_currentTime)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("duration",(_=>0)),this.get("progress",(_=>_this.currentTime/_this.duration)),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted?_options.muteState=_options.muted:void 0!==_options.muteState&&(muted=_options.muteState,delete _options.muteState),_options.muted!==muted&&(_options.muted=muted,_this.volume=_this.volume)})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.set("playbackRate",(v=>{_options.playbackRate=v,_backing&&_backing.setRate(v)})),this.get("playbackRate",(_=>_options.playbackRate)),this.play=async function(){_settings.autoplay=!0,_settings.src&&(_settings.loadingPlay=!0,_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),_settings.playing=!0,_this.volume=_options.volume,_this.playbackRate=_options.playbackRate,_this.startRender(loop),_backing.seek(_currentTime),_backing.play(_options.loop)))},this.pause=function(){_settings.autoplay=!1,_settings.src&&_settings.loaded&&_settings.playing&&(_settings.loadingPlay=!1,_settings.playing=!1,_backing&&_backing.pause(),_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.loaded&&(_currentTime=0,_backing&&_backing.stop(),_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_currentTime=time,_backing&&(_backing.seek(_currentTime),wasPlaying&&_backing.play())}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await function createBuffer(){let promise=Promise.create(),url=_settings.src;switch(url.includes("http")||(url=AURA.rootPath+url),_backingType){case"AVF":_backing=AVFSound.create(url);break;case"MP":_backing=new MPAudio(url);break;case"GVR":_backing=new GVRAudio(url)}return _backing.onComplete=_=>{_this.events.fire(Events.END),_options.selfDestruct&&_this.parent.destroy()},_backing.onUpdate=t=>{_currentTime=t},_backing.onReady=promise.resolve,promise}(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),_backing.destroy())},this.convolve=async function(src){}})),Class((function Audio3DResonance(){Inherit(this,Component);const _this=this;require("Audio3DSilence");var _context,_resonance,_orientation,_cam;function loop(){(_cam=Audio3DWA.getCamera())&&_context&&_context.listener&&(_orientation.set(0,0,-1).applyQuaternion(_cam.quaternion),_resonance.setListenerOrientation(_orientation.x,_orientation.y,_orientation.z,_cam.up.x,_cam.up.y,_cam.up.z),_resonance.setListenerPosition(_cam.position.x,_cam.position.y,_cam.position.z))}this.createAudioInput=async function(url){_context||await _this.resonance();let audioElementSource,stream={};stream.element=Audio3DWA.getElement(),stream.element.crossOrigin="anonymous",stream.element.src=url,audioElementSource=stream.element.mediaSrc?stream.element.mediaSrc:_context.createMediaElementSource(stream.element),stream.element.mediaSrc=audioElementSource;let source=_resonance.createSource();return audioElementSource.connect(source.input),stream.source=source,stream},this.unloadStream=function(stream){stream.element.mediaSrc.disconnect(stream.source.input),Audio3DWA.putElement(stream.element)},this.resonance=async function(refresh){return window.ResonanceAudio||await AssetLoader.waitForLib("ResonanceAudio"),await GlobalAudio3D.ready(),_context&&!refresh||(_context&&(_context.close(),_context=null),_orientation=new Vector3,"running"!==(_context=Audio3DWA.audioContext()).state&&_context.resume(),(_resonance=new ResonanceAudio(_context)).output.connect(_context.destination),Render.start(loop)),_resonance},this.setRoomProperties=function(dimensions,materials){_resonance.setRoomProperties(dimensions,materials)},this.get("initialized",(()=>!!_context))}),"static"),Class((function Audio3DResonanceAudio(){Inherit(this,Audio3DBase);const _this=this;var _stream,_options={},_settings={playing:!1,loaded:!1,loading:!1},_orientation=new Vector3,_currentTime=0;function loop(){let pos;if(pos=_this.audioPosition(),pos&&_stream){_stream.source.setPosition(pos.x,pos.y,pos.z);let euler=_this.audioOrientationInverse();_orientation.set(0,0,-1).applyEuler(euler),_stream.source.setOrientation(_orientation.x||0,_orientation.y||0,_orientation.z||0,_this.group.up.x||0,_this.group.up.y||0,_this.group.up.z||0)}}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.gain=_this.gain,_this.playbackRate=_this.playbackRate}function handleEnded(){_this.unload(),_this.events.fire(Events.END)}!async function(){Audio3DResonance.initialized||await Audio3DResonance.resonance(),function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_options.gain="number"==typeof _options.gain?_options.gain:ResonanceAudio.Utils.DEFAULT_SOURCE_GAIN,_options.sourceWidth="number"==typeof _options.sourceWidth?_options.sourceWidth:ResonanceAudio.Utils.DEFAULT_SOURCE_WIDTH,_options.directivitySharpness="number"==typeof _options.directivitySharpness?_options.directivitySharpness:ResonanceAudio.Utils.DEFAULT_DIRECTIVITY_SHARPNESS,_options.directivityAlpha="number"==typeof _options.directivityAlpha?_options.directivityAlpha:ResonanceAudio.Utils.DEFAULT_DIRECTIVITY_ALPHA}(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update)}()}(),this.set("src",(src=>{_this.stop(),_settings.src=src,defer((_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_this.volume,_this.gain=_this.gain}))})),this.get("src",(_=>_settings.src)),this.get("selfDestruct",(_=>_options.selfDestruct)),this.set("selfDestruct",(d=>{_options.selfDestruct=d})),this.set("volume",(v=>(_options.volume=v,_stream&&(_stream.element.volume=_options.muted||_options.globalMuted?0:v*Math.clamp(_options.globalVolume)),_options.volume))),this.get("volume",(_=>_options.volume)),this.get("gain",(()=>_options.gain)),this.set("gain",(v=>{_options.gain=v,_stream&&_stream.source.setGain(_options.gain*Math.max(1,_options.globalVolume))})),this.set("loop",(l=>(l=!!l,_stream&&(_stream.element.loop=l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("frequency",(_=>[])),this.get("activity",(_=>0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{_options.rolloff=r})),this.get("rolloff",(_=>_options.rolloff)),this.get("loaded",(_=>_settings.loaded)),this.get("currentTime",(_=>_currentTime)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("duration",(_=>_stream?_stream.element.duration:0)),this.get("progress",(_=>_this.currentTime/_this.duration)),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted?_options.muteState=_options.muted:void 0!==_options.muteState&&(muted=_options.muteState,delete _options.muteState),_options.muted!==muted&&(_options.muted=muted,_this.volume=_this.volume)})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.set("playbackRate",(v=>{_options.playbackRate=v})),this.get("playbackRate",(_=>_options.playbackRate)),this.get("sourceWidth",(()=>_options.sourceWidth)),this.set("sourceWidth",(v=>{_options.sourceWidth=v,_stream&&_stream.source.setSourceWidth(_options.sourceWidth)})),this.get("directivitySharpness",(()=>_options.directivitySharpness)),this.set("directivitySharpness",(v=>{_options.directivitySharpness=v,_stream&&_stream.source.setDirectivityPattern(_options.directivityAlpha,_options.directivitySharpness)})),this.get("directivityAlpha",(()=>_options.directivityAlpha)),this.set("directivityAlpha",(v=>{_options.directivityAlpha=v,_stream&&_stream.source.setDirectivityPattern(_options.directivityAlpha,_options.directivitySharpness)})),this.play=async function(){_settings.autoplay=!0,_settings.src&&(_settings.loadingPlay=!0,_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),_settings.playing=!0,_this.volume=_options.volume,_this.playbackRate=_options.playbackRate,_this.startRender(loop),_stream.element.currentTime=_currentTime,_stream.element.play()))},this.pause=function(){_settings.autoplay=!1,_settings.src&&_settings.loaded&&_settings.playing&&(_settings.loadingPlay=!1,_settings.playing=!1,_stream&&_stream.element.pause(),_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.loaded&&(_currentTime=0,_stream&&(_stream.element.pause(),_stream.element.currentTime=0),_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_currentTime=time,_stream&&(_stream.element.seek(_currentTime),wasPlaying&&_stream.element.play())}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){let promise=Promise.create(),url=_settings.src;return(_stream=await Audio3DResonance.createAudioInput(url)).element.addEventListener("ended",handleEnded),_this.loop=_this.loop,_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_this.gain=_this.gain,_this.sourceWidth=_this.sourceWidth,_this.directivitySharpness=_this.directivitySharpness,_this.directivityAlpha=_this.directivityAlpha,_stream.element.currentTime=_currentTime,_stream.element.volume=_this.volume,_stream.element.onloadeddata=promise.resolve,_stream.element.load(),(_options.autoplay||_settings.autoplay)&&_this.play(),promise}(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),function destroyStream(){_stream&&(_settings.loaded=!1,_stream.element.removeEventListener("ended",handleEnded),Audio3DResonance.unloadStream(_stream),_stream=null)}())}})),Class((function Audio3DWA(){Inherit(this,Component);const _this=this,_silence=require("Audio3DSilence");var _context,_orientation,_cam,_pool,_streams={},_buffers={};function loop(){(_cam=_this.getCamera())&&_cam.getWorldQuaternion&&_context&&_context.listener&&(_orientation.set(0,0,-1).applyQuaternion(_cam.getWorldQuaternion()),_context.listener.forwardX?(_context.listener.forwardX.setValueAtTime(_orientation.x,_context.currentTime),_context.listener.forwardY.setValueAtTime(_orientation.y,_context.currentTime),_context.listener.forwardZ.setValueAtTime(_orientation.z,_context.currentTime),_context.listener.upX.setValueAtTime(_cam.up.x,_context.currentTime),_context.listener.upY.setValueAtTime(_cam.up.y,_context.currentTime),_context.listener.upZ.setValueAtTime(_cam.up.z,_context.currentTime)):(_context.listener.setOrientation&&_context.listener.setOrientation(_orientation.x||0,_orientation.y||0,_orientation.z||0,_cam.up.x||0,_cam.up.y||0,_cam.up.z||0),_context.listener.setPosition&&_context.listener.setPosition(_cam.position.x||0,_cam.position.y||0,_cam.position.z||0),_context.listener.setVelocity&&_context.listener.setVelocity(0,0,0)))}function createAudioElement(){let audio;return GlobalAudio3D.fallback?(audio=document.createElement("audio"),audio.style.visibility="hidden",document.body.appendChild(audio),audio.source=document.createElement("source"),audio.appendChild(audio.source),audio.setAttribute("controls",""),audio.source.setAttribute("src",_silence),audio.source.setAttribute("type","audio/mp3"),audio.play()):(audio=new Audio,audio.src=_silence,audio.play().catch((e=>{}))),audio}function handleContextStateChange(){_this.suspended!==_this.flag("interactHandlerActive")&&(_this.suspended?(Device.mobile?_this.events.sub(Mouse.input,Interaction.CLICK,_this.resume):document.addEventListener("mouseup",_this.resume,{passive:!1}),_this.flag("interactHandlerActive",!0)):(Device.mobile?_this.events.unsub(Mouse.input,Interaction.CLICK,_this.resume):document.removeEventListener("mouseup",_this.resume,{passive:!1}),_this.flag("interactHandlerActive",!1)))}this.createPool=function(n=10){_pool=_this.initClass(ObjectPool,createAudioElement,n),_this.flag("init",!0)},this.audioContext=function(refresh){let firstTime=!_context;return _context&&!refresh||(_context&&(_context.close(),_context.removeEventListener("statechange",handleContextStateChange),_context=null),_orientation=new Vector3,(_context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3})).dest=_context.createMediaStreamDestination(),_context.addEventListener("statechange",handleContextStateChange),Render.start(loop),firstTime&&(GlobalAudio3D.initialized?_this.suspended&&handleContextStateChange():GlobalAudio3D.interacted.then(_this.resume))),_context},this.unloadBuffer=function(url){_buffers[url]&&delete _buffers[url]},this.loadBuffer=async function(url){if(!_buffers[url]){_buffers[url]={loaded:Promise.create(),data:null};var response=await fetch(url),buffer=await response.arrayBuffer();_this.audioContext().decodeAudioData(buffer,(data=>{_buffers[url].data=data,_buffers[url].loaded.resolve()}))}return await _buffers[url].loaded,_buffers[url].data},this.unloadStream=function(url){_streams[url]&&(_streams[url].stream.element.src=_silence,_streams[url].stream.element.load(),_streams[url].count--,_pool.put(_streams[url].stream.element),0==_streams[url].count&&defer((_=>{delete _streams[url]})))},this.loadStream=function(url){let isElement="string"!=typeof url&&void 0!==url,element=null;if(isElement&&(element=url,url=element.src?element.src:element.srcObject?element.srcObject.id:""),!_streams[url]){let stream={};_streams[url]={stream:null,count:0},isElement?(stream.element=element,element.setAttribute("muted",!0),element.muted=!0):(stream.element=_this.getElement(),stream.element.crossOrigin="anonymous",stream.element.src=url),GlobalAudio3D.fallback?stream.element.setAttribute("src",url):(stream.element.mediaSrc?stream.source=stream.element.mediaSrc:stream.element.srcObject?(stream.source=_this.audioContext().createMediaStreamSource(stream.element.srcObject),(new Audio).srcObject=element.srcObject):stream.source=_this.audioContext().createMediaElementSource(stream.element),stream.element.mediaSrc=stream.source),isElement||stream.element.load(),_streams[url].stream=stream}return _streams[url].count++,_streams[url].stream},this.getActiveStreamCount=function(stream){for(let key in _streams)if(_streams[key].stream==stream)return _streams[key].count;return-1},this.purge=function(){for(let stream in _streams)_this.unloadStream(stream);for(let buffer in _buffers)_this.unloadBuffer(buffer)},this.getElement=function(){return _pool||_this.createPool(),_pool.get()},this.putElement=function(audio){audio.src=_silence,audio.load(),_pool.put(audio)},this.useCamera=function(camera){_this.CAMERA=camera},this.getCamera=function(){return _this.CAMERA||(_this.CAMERA=World.CAMERA),_this.CAMERA},this.get("suspended",(()=>!_context||("interrupted"===_context.state||"suspended"===_context.state))),this.resume=async function(){_context||_this.audioContext(),_this.suspended&&await _context.resume()}}),"static"),Class((function Audio3DWABuffer(){Inherit(this,Audio3DBase);const _this=this;var _context,_buffer,_stream,_gain,_panner,_analyser,_filter,_delay,_convolver,_position,_frequency,_convolution,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){_context&&(_position=_context.listener.forwardX?_this.audioPosition().sub(_this.listenerPosition()):_this.audioPosition(),_panner.setPosition(_position.x,_position.y,_position.z))}function initContext(){_context=Audio3DWA.audioContext(),_gain=_context.createGain?_context.createGain():_context.createGainNode(),_panner=_context.createPanner(),(_filter=_context.createBiquadFilter()).type="lowshelf",_filter.frequency.value=0,_filter.gain.value=1,_analyser=_context.createAnalyser(),(_delay=_context.createDelay(10)).delayTime.value=0,_analyser.fftSize=32,_frequency=new Uint8Array(_analyser.frequencyBinCount),_analyser.connect(_context.destination),_delay.connect(_analyser),_filter.connect(_delay),_convolver?(_convolver.connect(_filter),_gain.connect(_convolver)):_gain.connect(_filter),_panner.connect(_gain)}function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function destroyBuffer(){if(_buffer&&_stream){_settings.loaded=!1;try{_stream.disconnect(_panner),_convolver?(_convolver.disconnect(_filter),_gain.disconnect(_convolver)):_gain.disconnect(_filter),_analyser.disconnect(_context.destination),_buffer.stop(),_buffer=null,Audio3DWA.unloadBuffer(_settings.src)}catch(e){}}}async function createStream(){_stream||((_stream=_context.createBufferSource()).buffer=_buffer.buffer,_stream.loop=_options.loop,_stream.playbackRate=_options.playbackRate,_stream.onended=_=>{_this&&_this.stop&&(_this.stop(),_this.events.fire(Events.END),_options.selfDestruct&&_this.parent.destroy())},_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.connect(_panner),_settings.loadingPlay&&_stream.start(0,_currentTime))}function destroyStream(){if(_stream){try{_stream.disconnect(_panner),_stream.stop()}catch(e){}_stream=null}}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){destroyBuffer(),destroyStream(),_context=null,_gain=null,_panner=null,_analyser=null,_delay=null,_frequency=null,_filter=null,initContext(),initOptions(),_convolution&&_this.convolve(_convolution),(_options.autoplay||_settings.autoplay)&&_this.play()}!async function(){initContext(),initOptions(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}()}(),this.set("src",(src=>{_this.stop(),_settings.src=src,defer((_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume}))})),this.get("src",(_=>_settings.src)),this.get("selfDestruct",(_=>_options.selfDestruct)),this.set("selfDestruct",(d=>{_options.selfDestruct=d})),this.set("volume",(v=>(_options.volume=v,_gain&&(_gain.gain.value=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_stream&&(_stream.loop=l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("frequency",(_=>_analyser?(_analyser.getByteFrequencyData(_frequency),_frequency):[])),this.get("activity",(_=>_analyser?(_analyser.getByteFrequencyData(_frequency),Math.clamp(_frequency.slice(3,13).reduce(((n1,n2)=>n1+n2),0)/2560,0,1)):0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{_options.rolloff=r,_panner&&(_panner.rolloffFactor=r)})),this.get("rolloff",(_=>_options.rolloff)),this.get("loaded",(_=>_settings.loaded)),this.get("currentTime",(_=>_context&&_buffer?_context.currentTime%_buffer.buffer.duration:0)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted?_options.muteState=_options.muted:void 0!==_options.muteState&&(muted=_options.muteState,delete _options.muteState),_options.muted!==muted&&(_options.muted=muted,_this.volume=_this.volume)})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.set("playbackRate",(v=>{_options.playbackRate=v,_stream&&(_stream.playbackRate.value=v*_options.globalPlaybackRate)})),this.get("playbackRate",(_=>_options.playbackRate)),this.get("filter",(_=>_filter)),this.get("delay",(_=>_delay)),this.get("panner",(_=>_panner)),this.get("duration",(_=>_buffer?_buffer.buffer.duration:0)),this.get("progress",(_=>_this.currentTime/_this.duration)),this.get("context",(_=>_context)),this.get("stream",(_=>_stream)),this.get("buffer",(_=>_buffer)),this.play=async function(){_settings.autoplay=!0,_settings.src&&GlobalAudio3D.initialized&&(_settings.loadingPlay=!0,_stream||_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),await createStream(),_settings.playing=!0,_this.volume=_options.volume,_this.startRender(loop)))},this.pause=function(){_settings.autoplay=!1,_stream&&GlobalAudio3D.initialized&&_settings.src&&_settings.loaded&&_settings.playing&&(_currentTime=_context.currentTime,destroyStream(),_settings.loadingPlay=!1,_settings.playing=!1,_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.src&&GlobalAudio3D.initialized&&_settings.loaded&&(_currentTime=0,destroyStream(),_settings.loading=!1,_settings.loaded=!1,_settings.loadingPlay=!1,_settings.playing=!1,_this.stopRender(loop))},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_this.stop(),_currentTime=time,wasPlaying&&_this.play()}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){(_buffer=_context.createBufferSource()).buffer=await Audio3DWA.loadBuffer(_settings.src),_settings.loaded=!0}(),await createStream(),_options.autoplay||_settings.loadingPlay||destroyStream(),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),destroyBuffer())},this.convolve=async function(src){if(_convolution=src,!1===src)return void(_convolver&&(_convolver.disconnect(),_gain.disconnect(),_gain.connect(_filter),_convolver=null));let buffer=await Audio3DWA.loadBuffer(src);_convolver||(_convolver=_context.createConvolver(),_gain.disconnect(),_convolver.connect(_filter),_gain.connect(_convolver)),_convolver.buffer=buffer}})),Class((function Audio3DWASimpleBuffer(){Inherit(this,Audio3DBase);const _this=this;var _context,_buffer,_stream,_gain,_filter,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function initContext(){_context=Audio3DWA.audioContext(),(_filter=_context.createBiquadFilter()).type="lowpass",_filter.fValue=16e3,_filter.frequency.value=16e3,_filter.connect(_context.destination),(_gain=_context.createGain?_context.createGain():_context.createGainNode()).connect(_filter)}function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.selfDestruct=_options.selfDestruct||!1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function destroyBuffer(){_buffer&&_stream&&(_settings.loaded=!1,_stream.disconnect(_gain),_gain.disconnect(_filter),_filter.disconnect(_context.destination),_buffer.stop(),_buffer=null,Audio3DWA.unloadBuffer(_settings.src))}async function createStream(){_stream||((_stream=_context.createBufferSource()).buffer=_buffer.buffer,_stream.loop=_options.loop,_stream.playbackRate=_options.playbackRate,_stream.onended=_=>{_this.stop(),_options.selfDestruct&&_this.parent.destroy()},_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.connect(_gain),_settings.loadingPlay&&_stream.start(0,_currentTime))}function destroyStream(fromPause=!1){if(_stream){_stream.disconnect(_gain);try{_stream.stop(),fromPause||_this.events.fire(Events.END)}catch(e){}_stream=null}}function muffle({isMuffled:isMuffled}){const logLerp=(a,b,t)=>Math.exp((1-t)*Math.log(a)+t*Math.log(b));let obj={value:0};tween(obj,{value:1},500,"linear").onUpdate((_=>{_filter.fValue=logLerp(500,16e3,isMuffled?1-obj.value:obj.value),_filter.frequency.value=logLerp(500,16e3,isMuffled?1-obj.value:obj.value)}))}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){destroyBuffer(),destroyStream(),_context=null,_gain=null,initContext(),initOptions(),(_options.autoplay||_settings.autoplay)&&_this.play()}initContext(),initOptions(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready),_this.events.sub(GlobalAudio3D,Events.MESSAGE,muffle)}(),this.set("src",(src=>{_this.stop(),_settings.src=src,defer((_=>{if(_options.autoplay)return _this.play();_options.preload&&_this.load(),_this.volume=_options.volume}))})),this.get("src",(_=>_settings.src)),this.get("selfDestruct",(_=>_options.selfDestruct)),this.set("selfDestruct",(d=>{_options.selfDestruct=d})),this.set("volume",(v=>(_options.volume=v,_gain&&(_gain.gain.value=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_stream&&(_stream.loop=l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>_this.ready)),this.get("playing",(_=>_settings.playing)),this.get("loaded",(_=>_settings.loaded)),this.get("currentTime",(_=>_context&&_buffer?_context.currentTime%_buffer.buffer.duration:0)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted?_options.muteState=_options.muted:void 0!==_options.muteState&&(muted=_options.muteState,delete _options.muteState),_options.muted!==muted&&(_options.muted=muted,_this.volume=_this.volume)})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.set("playbackRate",(v=>{_options.playbackRate=v,_stream&&(_stream.playbackRate.value=v*_options.globalPlaybackRate)})),this.get("playbackRate",(_=>_options.playbackRate)),this.get("duration",(_=>_buffer?_buffer.buffer.duration:0)),this.get("progress",(_=>_this.currentTime/_this.duration)),this.get("context",(_=>_context)),this.get("stream",(_=>_stream)),this.get("buffer",(_=>_buffer)),this.play=async function(){_settings.autoplay=!0,_settings.src&&GlobalAudio3D.initialized&&(_settings.loadingPlay=!0,_stream||_settings.loading||_settings.playing||(_settings.loaded||await _this.load(),await createStream(),_settings.playing=!0,_this.volume=_options.volume))},this.pause=function(){_settings.autoplay=!1,_stream&&GlobalAudio3D.initialized&&_settings.src&&_settings.loaded&&_settings.playing&&(_currentTime=_context.currentTime,destroyStream(!0),_settings.loadingPlay=!1,_settings.playing=!1)},this.stop=function(){_settings.autoplay=!1,_settings.src&&GlobalAudio3D.initialized&&_settings.loaded&&(_currentTime=0,destroyStream(),_settings.loading=!1,_settings.loaded=!1,_settings.loadingPlay=!1,_settings.playing=!1)},this.seek=function(time){if(_settings.src){_settings.loadingPlay=!1;var wasPlaying=_settings.playing;_stream&&(_stream.onended=null),_this.stop(),_currentTime=time,wasPlaying&&_this.play()}},this.load=async function(){_settings.src&&(_settings.loading||_settings.loaded||(_settings.loading=!0,_this.ready=await async function createBuffer(){(_buffer=_context.createBufferSource()).buffer=await Audio3DWA.loadBuffer(_settings.src),_settings.loaded=!0}(),await createStream(),_options.autoplay||_settings.loadingPlay||(_stream.onended=null,destroyStream()),_this.events.fire(Events.LOADED),_settings.loadingPlay=!1,_settings.loading=!1,_settings.loaded=!0))},this.unload=function(){_settings.src&&_settings.loaded&&(_this.stop(),destroyBuffer())},this.convolve=async function(src){}})),Class((function Audio3DWAStream(){Inherit(this,Audio3DBase);const _this=this;var _context,_stream,_gain,_panner,_analyser,_filter,_delay,_convolver,_position,_frequency,_convolution,_options={},_settings={playing:!1,loaded:!1,loading:!1},_currentTime=0;function loop(){_context&&(_position=_context.listener.forwardX?_this.audioPosition().sub(_this.listenerPosition()):_this.audioPosition(),_panner.setPosition(_position.x,_position.y,_position.z))}function initContext(){_context=Audio3DWA.audioContext(),_gain=_context.createGain?_context.createGain():_context.createGainNode(),_panner=_context.createPanner(),(_analyser=_context.createAnalyser()).fftSize=32,_frequency=new Uint8Array(_analyser.frequencyBinCount),(_filter=_context.createBiquadFilter()).type="lowshelf",_filter.frequency.value=0,_filter.gain.value=1,(_delay=_context.createDelay(10)).delayTime.value=0}function initOptions(){_options.loop=_options.loop||!1,_options.autoplay=_options.autoplay||!1,_options.volume=void 0===_options.volume?1:_options.volume,_options.playbackRate=_options.playbackRate||1,_options.preload=_options.preload||!1,_options.muted=_options.muted||!1,_options.rolloff=_options.rolloff||1,_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate}function createStream(){_stream||((_stream=Audio3DWA.loadStream(_settings.src)).element.addEventListener("ended",handleEnded),_this.loop=_this.loop,_this.volume=_this.volume,_this.rolloff=_this.rolloff,_this.muted=_this.muted,_stream.source.connect(_panner),_panner.connect(_gain),_convolver?(_gain.connect(_convolver),_convolver.connect(_filter)):_gain.connect(_filter),_filter.connect(_delay),_delay.connect(_analyser),_analyser.connect(_context.destination),_stream.element.currentTime=_currentTime,(_options.autoplay||_settings.autoplay)&&_this.play())}function destroyStream(){_stream&&(_stream.element.removeEventListener("ended",handleEnded),_stream.source.disconnect(_panner),_stream=null)}function update(e){_options.globalMuted=GlobalAudio3D.muted,_options.globalVolume=GlobalAudio3D.volume,_options.globalPlaybackRate=GlobalAudio3D.playbackRate,_this.volume=_this.volume,_this.playbackRate=_this.playbackRate}function ready(){destroyStream(),_context=null,_gain=null,_panner=null,_analyser=null,_delay=null,_filter=null,_frequency=null,initContext(),initOptions(),_convolution&&_this.convolve(_convolution),(_settings.autoplay||_options.autoplay)&&_this.play()}function handleEnded(){_this.unload(),_this.events.fire(Events.END)}initOptions(),initContext(),function addListeners(){_this.events.sub(GlobalAudio3D,Events.UPDATE,update),_this.events.sub(GlobalAudio3D,Events.READY,ready)}(),this.set("src",(src=>{if(destroyStream(),_settings.src=src,_options.autoplay)return _this.play();_options.preload&&_this.load()})),this.get("src",(_=>_settings.src)),this.set("volume",(v=>(v=Math.clamp(v,0,1),_options.volume=v,_gain&&(_gain.gain.value=_options.muted||_options.globalMuted?0:v*_options.globalVolume),_options.volume))),this.get("volume",(_=>_options.volume)),this.set("loop",(l=>(l=!!l,_stream&&(_stream.element.loop=l),_options.loop=l))),this.get("loop",(_=>_options.loop)),this.set("autoplay",(autoplay=>{_options.autoplay=autoplay})),this.get("autoplay",(_=>_options.autoplay)),this.set("preload",(preload=>{_options.preload=preload})),this.get("preload",(_=>_options.preload)),this.get("ready",(_=>!!_stream)),this.get("frequency",(_=>(_analyser&&_analyser.getByteFrequencyData(_frequency),_frequency))),this.get("activity",(_=>_analyser?(_analyser.getByteFrequencyData(_frequency),Math.clamp(_frequency.slice(3,13).reduce(((n1,n2)=>n1+n2),0)/2560,0,1)):0)),this.get("playing",(_=>_settings.playing)),this.set("rolloff",(r=>{_options.rolloff=r,_panner&&(_panner.rolloffFactor=r)})),this.get("rolloff",(_=>_options.rolloff)),this.get("loaded",(_=>!0)),this.get("duration",(_=>_stream?_stream.element.duration:0)),this.get("currentTime",(_=>_stream?_stream.element.currentTime:0)),this.set("currentTime",(t=>{_this.seek(t)})),this.get("progress",(_=>_this.currentTime/_this.duration)),this.set("playbackRate",(v=>{_options.playbackRate=v,_stream&&_stream.element&&(_stream.element.playbackRate=v*_options.globalPlaybackRate)})),this.get("playbackRate",(_=>_options.playbackRate)),this.get("visibilityMuted",(_=>_options.muted)),this.set("visibilityMuted",(muted=>{!0===muted?_options.muteState=_options.muted:void 0!==_options.muteState&&(muted=_options.muteState,delete _options.muteState),_options.muted!==muted&&(_options.muted=muted,_this.volume=_this.volume)})),this.get("muted",(_=>_options.muted)),this.set("muted",(muted=>{_options.muted=muted,_this.volume=_this.volume})),this.get("filter",(_=>_filter)),this.get("delay",(_=>_delay)),this.get("panner",(_=>_panner)),this.play=function(){_settings.autoplay=!0,_settings.src&&(createStream(),_stream&&!0!==_settings.playing&&(_settings.playing=!0,_this.volume=_this.volume,_this.startRender(loop),_stream.element.playbackRate=_options.playbackRate?_options.playbackRate:1,_stream.element.play().catch((e=>{}))))},this.pause=function(){_settings.autoplay=!1,_stream&&_settings.src&&_settings.playing&&(_currentTime=_stream.element.currentTime,_stream.element.pause(),_settings.playing=!1,_this.stopRender(loop))},this.stop=function(){_settings.autoplay=!1,_settings.src&&(_currentTime=0,_settings.playing=!1,_this.stopRender(loop),_stream&&_stream.element&&_stream.element.stop&&(_stream.element.stop(),_stream.element.currentTime=0))},this.seek=function(time){_settings.src&&(_currentTime=time,_stream&&(_stream.element.currentTime=time))},this.load=function(){_settings.src&&(_settings.playing||(createStream(),_stream.element.load()))},this.unload=function(){_settings.autoplay=!1,_settings.src&&(_this.stop&&_this.stop(),destroyStream(),Audio3DWA.unloadStream(_settings.src))},this.convolve=async function(src){if(_convolution=src,!1===src)return void(_convolver&&(_convolver.disconnect(),_gain.disconnect(),_gain.connect(_analyser),_convolver=null));let buffer=await Audio3DWA.loadBuffer(src);_convolver||(_convolver=_context.createConvolver(),_gain.disconnect(),_convolver.connect(_analyser),_gain.connect(_convolver)),_convolver.buffer=buffer},this.get("stream",(_=>_stream))})),Module((function BufferToVertices(){const FACES=["a","b","c"];this.exports={toVertices:function toVertices(geom){!function buildFaces(geom){let attributes=geom.attributes,positions=attributes.position.array,normals=attributes.normal.array,uvs=attributes.uv.array,tempNormals=[],tempUVs=[];geom.vertices=[],geom.faceVertexUvs=[[]],geom.faces=[];let indices=geom.index;function Face3(a,b,c,normal){this.a=a,this.b=b,this.c=c,this.normal=normal}for(let i=0,j=0;i<positions.length;i+=3,j+=2)geom.vertices.push(new Vector3(positions[i],positions[i+1],positions[i+2])),tempNormals.push(new Vector3(normals[i],normals[i+1],normals[i+2])),tempUVs.push(new Vector2(uvs[j],uvs[j+1]));function addFace(a,b,c,materialIndex){let face=new Face3(a,b,c,[tempNormals[a].clone(),tempNormals[b].clone(),tempNormals[c].clone()]);geom.faces.push(face),geom.faceVertexUvs[0].push([tempUVs[a].clone(),tempUVs[b].clone(),tempUVs[c].clone()])}for(var i=0;i<indices.length;i+=3)addFace(indices[i],indices[i+1],indices[i+2]);!function mergeVertices(geom){var v,key,i,il,face,indices,j,jl,verticesMap={},unique=[],changes=[],precisionPoints=4,precision=Math.pow(10,precisionPoints);for(i=0,il=geom.vertices.length;i<il;i++)v=geom.vertices[i],void 0===verticesMap[key=Math.round(v.x*precision)+"_"+Math.round(v.y*precision)+"_"+Math.round(v.z*precision)]?(verticesMap[key]=i,unique.push(geom.vertices[i]),changes[i]=unique.length-1):changes[i]=changes[verticesMap[key]];var faceIndicesToRemove=[];for(i=0,il=geom.faces.length;i<il;i++){(face=geom.faces[i]).a=changes[face.a],face.b=changes[face.b],face.c=changes[face.c],indices=[face.a,face.b,face.c];for(var n=0;n<3;n++)if(indices[n]===indices[(n+1)%3]){faceIndicesToRemove.push(i);break}}for(i=faceIndicesToRemove.length-1;i>=0;i--){var idx=faceIndicesToRemove[i];for(geom.faces.splice(idx,1),j=0,jl=geom.faceVertexUvs.length;j<jl;j++)geom.faceVertexUvs[j].splice(idx,1)}var diff=geom.vertices.length-unique.length;return geom.vertices=unique,diff}(geom)}(geom)},toBuffer:function toBuffer(geom){let faces=geom.faces,array=geom.attributes.position.array;for(let i=0;i<faces.length;i++){let face=faces[i];for(let f=0;f<FACES.length;f++){let index=face[FACES[f]],vertex=geom.vertices[index];array[3*index+0]=vertex.x,array[3*index+1]=vertex.y,array[3*index+2]=vertex.z}}}}})),Class((function CubemapToEquirectangular(_size,_cube){Inherit(this,Component);const _this=this;var _quad,_scene=new Scene,_camera=new OrthographicCamera(-.5,.5,.5,-.5,-1e4,1e4),_output=Utils3D.createRT(_size,_size/2);this.rt=_output,function(){let width=_size,height=_size/2,shader=_this.initClass(Shader,"Cube2Equi",{tCube:{value:_cube.rt||_cube},side:Shader.DOUBLE_SIDE});(_quad=new Mesh(World.QUAD,shader)).frustumCulled=!1,_scene.add(_quad),_quad.scale.set(width/2,height/2,1),_camera.left=width/-2,_camera.right=width/2,_camera.top=height/2,_camera.bottom=height/-2,_camera.updateProjectionMatrix()}(),this.render=function(){World.RENDERER.render(_scene,_camera,_output)},this.toBlob=function(){_this.render();let pixels=World.RENDERER.readPixels(_output,0,0,_size,_size/2),imageData=new ImageData(new Uint8ClampedArray(pixels),_size,_size/2),canvas=document.createElement("canvas");canvas.width=_size,canvas.height=_size/2,canvas.getContext("2d").putImageData(imageData,0,0),canvas.toBlob((function(blob){var url=URL.createObjectURL(blob),fileName="pano-"+document.title+"-"+Date.now()+".png",anchor=document.createElement("a");anchor.href=url,anchor.setAttribute("download",fileName),anchor.className="download-js-link",anchor.innerHTML="downloading...",anchor.style.display="none",document.body.appendChild(anchor),setTimeout((function(){anchor.click(),document.body.removeChild(anchor)}),1)}),"image/png")}})),Class((function ImageDecoder(){Inherit(this,Component);var _ktx1Settings,_this=this;this.scale=1,this.disableFallbackImage=!1;var _offscreen={},doDecodeImage="createImageBitmap"in window?(path,params)=>Thread.shared().decodeImage({path:path,params:params}):(path,params)=>Assets.decodeImage(path,params);function decodeImage(data,id){(async _=>{try{let e=await fetch(data.path,{mode:"cors"});if(200!=e.status)throw`Image not found: ${data.path}`;let blob=await e.blob(),obj={imageOrientation:"flipY",crossOrigin:"anonymous"};data.params&&!1===data.params.premultiplyAlpha&&(obj.premultiplyAlpha="none"),obj.imageOrientation=data.params&&!1===data.params.flipY?void 0:"flipY";let bitmap=await createImageBitmap(blob,obj),message={post:!0,id:id,message:bitmap};self.postMessage(message,[bitmap])}catch(e){resolve({fail:`${data.path} could not be decoded: ${e.message||e}`},id)}})()}function decodeCubeLUT(data,id){(async _=>{try{let cube=await get(data.path,{mode:"cors"});cube=cube.replace(/^#.*?(\n|\r)/gm,"").replace(/^\s*?(\n|\r)/gm,"").trim();let cubesize=findNumberAfterString(cube,"LUT_3D_SIZE",!0),domain_min=findNumberAfterString(cube,"DOMAIN_MIN"),domain_max=findNumberAfterString(cube,"DOMAIN_MAX");cube=removeCubeHeader(cube,"TITLE"),cube=removeCubeHeader(cube,"LUT_3D_SIZE"),cube=removeCubeHeader(cube,"DOMAIN_MIN"),cube=removeCubeHeader(cube,"DOMAIN_MAX");let rgba=[];if(cube.split(/\s+/).filter((substr=>substr.length>0)).forEach(((element,index)=>{rgba.push(+element),(index+1)%3==0&&index!==4*Math.pow(cubesize,3)-1&&rgba.push(1)})),rgba.forEach(((e,i)=>{domain_min&&domain_max&&(rgba[i]=Math.map(rgba[i],domain_min,domain_max,0,1)),rgba[i]=Math.clamp(Math.round(255*rgba[i]),0,255)})),rgba.length!==cubesize**3*4)throw`LUT .cube at ${data.path} has length mismatch: claims cube size of ${cubesize} but has ${rgba.length} elements.`;let imgBmp=new Uint8Array(rgba);resolve({imgBmp:imgBmp,cubesize:cubesize},id)}catch(e){resolve({fail:`${data.path} could not be decoded: ${e.message||e}`},id)}})()}function decodeKtx1CompressedImage(data,id){(async _=>{let ext;data.settings.dxt?ext="dxt":data.settings.etc?ext="astc":data.settings.pvrtc?ext="pvrtc":data.settings.astc&&(ext="astc");let fileName=data.path.split("/");fileName=fileName[fileName.length-1];let e=await fetch(`${data.path}/${fileName}-${ext}.ktx`);if(200!=e.status)throw`Image not found :: ${data.path}`;let arrayBuffer=await e.arrayBuffer(),header=new Int32Array(arrayBuffer,12,13),gliFormat=(header[1],header[2],header[3],header[4]),baseWidth=(header[5],header[6]),baseHeight=header[7],width=baseWidth,height=baseHeight,numberOfArrayElements=header[9],numberOfFaces=header[10],miplevels=header[11],buffers=[],compressedData=[],sizes=[],cube=6===numberOfFaces&&0===numberOfArrayElements,dataOffset=64+header[12];for(let level=0;level<miplevels;level++){let imageSize=new Int32Array(arrayBuffer,dataOffset,1)[0];dataOffset+=4,cube&&(imageSize*=6);let byteArray=new Uint8Array(arrayBuffer,dataOffset,imageSize);dataOffset+=imageSize,dataOffset+=3-(imageSize+3)%4,sizes.push(width),width=Math.max(1,.5*width),height=Math.max(1,.5*height);let clone=new Uint8Array(byteArray);compressedData.push(clone),buffers.push(clone.buffer)}resolve({gliFormat:gliFormat,compressedData:compressedData,sizes:sizes,width:baseWidth,height:baseHeight,cube:cube},id,buffers)})().catch((e=>{console.log(e.toString()),resolve({fail:`${data.path} could not be decoded: ${e.message||e}`},id)}))}function renderOnQuad(image,compressionExtensions){let aspect=image.width/image.height,width=Math.round(aspect>1?128:128*aspect),height=Math.round(aspect>1?128/aspect:128);const gl=new OffscreenCanvas(width,height).getContext("webgl");if(!gl)throw new Error("Unable to initialize offscreen WebGL canvas");function loadShader(gl,shaderSource,shaderType){const shader=gl.createShader(shaderType);gl.shaderSource(shader,shaderSource),gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){const lastError=gl.getShaderInfoLog(shader);throw gl.deleteShader(shader),new Error("Shader compile error: "+lastError)}return shader}let vs=loadShader(gl,"\nattribute vec4 a_position;\nvarying vec2 v_texcoord;\n\nvoid main() {\n    gl_Position = a_position;\n    v_texcoord = a_position.xy * 0.5 + 0.5;\n}",gl.VERTEX_SHADER),fs=loadShader(gl,"\nprecision mediump float;\nvarying vec2 v_texcoord;\nuniform sampler2D u_texture;\n\nvoid main() {\n    gl_FragColor = texture2D(u_texture, v_texcoord);\n}",gl.FRAGMENT_SHADER),program=function createProgram(gl,shaders){const program=gl.createProgram();if(shaders.forEach((function(shader){gl.attachShader(program,shader)})),gl.linkProgram(program),!gl.getProgramParameter(program,gl.LINK_STATUS)){const lastError=gl.getProgramInfoLog(program);throw gl.deleteProgram(program),shaders.forEach((function(shader){gl.deleteShader(shader)})),new Error("Shader link error:"+lastError)}return program}(gl,[vs,fs]);var positionLocation=gl.getAttribLocation(program,"a_position"),positionBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,3,-1,-1,3]),gl.STATIC_DRAW),gl.viewport(0,0,gl.canvas.width,gl.canvas.height),gl.clear(gl.COLOR_BUFFER_BIT);const tex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,tex),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);let ext={};compressionExtensions.forEach((str=>{switch(str){case"astc":ext.astc=gl.getExtension("WEBGL_compressed_texture_astc");break;case"atc":ext.atc=gl.getExtension("WEBGL_compressed_texture_atc");break;case"etc":ext.etc=gl.getExtension("WEBGL_compressed_texture_etc");break;case"etc1":ext.etc1=gl.getExtension("WEBGL_compressed_texture_etc1");break;case"pvrtc":ext.pvrtc=gl.getExtension("WEBGL_compressed_texture_pvrtc")||gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"s3tc":ext.s3tc=gl.getExtension("WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"bptc":ext.bptc=gl.getExtension("EXT_texture_compression_bptc");break;case"s3tc_srgb":ext.s3tc_srgb=gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")}}));let index=image.sizes.findIndex((e=>e.width<=128&&e.height<=128));gl.compressedTexImage2D(gl.TEXTURE_2D,0,image.gliFormat,image.sizes[index].width,image.sizes[index].height,0,image.compressedData[index]),gl.useProgram(program),gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer),gl.enableVertexAttribArray(positionLocation),gl.vertexAttribPointer(positionLocation,2,gl.FLOAT,!1,0,0),gl.drawArrays(gl.TRIANGLES,0,3),gl.useProgram(null);let data=new Uint8Array(65536);return gl.readPixels(0,0,128,128,gl.RGBA,gl.UNSIGNED_BYTE,data),data}function findDominantColors(e,id){function calculateCenterColor(colors){let center=new ColorLAB;return colors.forEach((color=>{center.l+=color.l,center.a+=color.a,center.b+=color.b})),colors.length&&(center.l/=colors.length,center.a/=colors.length,center.b/=colors.length),center}try{let data;if(e.compressionExtensions)data=renderOnQuad(e.image,e.compressionExtensions);else if(e.image){let aspect=e.image.width/e.image.height,max=128,width=Math.round(aspect>1?max:max*aspect),height=Math.round(aspect>1?max/aspect:max),ctx=new OffscreenCanvas(width,height).getContext("2d");ctx.drawImage(e.image,0,0,width,height),data=ctx.getImageData(0,0,width,height).data}else data=e.data;let count=data.length/4,colors=[],j=0;for(let i=0;i<count;++i)data[j+3]>25&&colors.push((new ColorLAB).setRGB(data[j]/255,data[j+1]/255,data[j+2]/255)),j+=4;let results=function kmeans(colors,k,minDiff){let clusters=function getInitialClusters(colors,k){const sums=colors.map((color=>[color.l+color.a+color.b,color]));sums.sort(((a,b)=>a[0]-b[0]));const centroids=[...Array(k)].map(((_,i)=>{const shardSize=Math.floor(sums.length/k);return calculateCenterColor(sums.slice(shardSize*i,i===k-1?sums.length:shardSize*(i+1)).map((sum=>sum[1])))}));for(let i=0;i<centroids.length-1;++i){const color=centroids[i],nextColor=centroids[i+1];color.l===nextColor.l&&color.a===nextColor.a&&color.b===nextColor.b&&(centroids.splice(i+1,1),i-=1)}return centroids.map((color=>[color,[]]))}(colors,k);k=clusters.length;for(let i=1;;i++){let lists=[...Array(k)].map((()=>[]));for(let j=0;j<colors.length;j++){let c=colors[j],smallestDistance=1/0,idx=0;for(let i=0;i<k;i++){let distance=c.deltaECIE94(clusters[i][0]);distance<smallestDistance&&(smallestDistance=distance,idx=i)}lists[idx].push(c)}let diff=0;for(let i=0;i<k;i++){let old=clusters[i],center=calculateCenterColor(lists[i]),newCluster=[center,lists[i]],dist=old[0].deltaECIE94(center);clusters[i]=newCluster,diff=diff>dist?diff:dist}if(diff<minDiff||50===i)break}return clusters}(colors,"number"==typeof e.numColors?e.numColors:4,1/255).filter((cluster=>cluster[1].length));results.sort(((a,b)=>b[1].length-a[1].length)),results=results.map((result=>result[0].getRGB())),resolve({colors:results},id)}catch(e){throw resolve({fail:e.message||e},id),e}}function findNumberAfterString(source,str,toInt=!1){const regex=new RegExp(str+"\\D*([0-9]*\\.?[0-9]+)"),num=source.match(regex);return num&&num[1]?toInt?parseInt(num[1]):parseFloat(num[1]):null}function removeCubeHeader(source,str){const regex=new RegExp(str+"[\\s\\S]*?(\\n+)"),match=source.match(regex);if(match){const newlineIndex=match.index+match[0].length-1;return source.slice(newlineIndex+1)}return source}function checkCapabilities(){if(void 0===_offscreen["2d"]&&(_offscreen["2d"]="OffscreenCanvas"in window&&!!new OffscreenCanvas(1,1).getContext("2d")),void 0===_offscreen.webgl&&(_offscreen.webgl="OffscreenCanvas"in window&&!!new OffscreenCanvas(1,1).getContext("webgl"),_offscreen.webgl)){let compressionExtensions=["compressed_texture","texture_compression"],enabledExtensions=Device.graphics.webgl?.extensions||[],dedupe={};_offscreen.compressionExtensions=enabledExtensions.map((ext=>compressionExtensions.map((name=>{let index=ext.indexOf(name);if(!(index<0))return index+=name.length,"_"===ext.charAt(index)&&(index+=1),ext.substring(index)})).find(Boolean))).filter((ext=>!(!ext||dedupe[ext])&&(dedupe[ext]=!0)))}}!async function(){await Hydra.ready(),Thread.upload(decodeImage),Thread.upload(decodeCubeLUT),Thread.upload(findNumberAfterString),Thread.upload(removeCubeHeader),Thread.upload(renderOnQuad),Thread.upload(findDominantColors),Thread.upload(decodeKtx1CompressedImage)}(),this.decode=async function(path,params={}){let fallback=Thread.absolutePath(Assets.getPath("assets/images/_scenelayout/uv.jpg"));if(path=Thread.absolutePath(Assets.getPath(path)),void 0===_ktx1Settings){_ktx1Settings={dxt:!!Renderer.extensions.s3tc,etc:!!Renderer.extensions.etc1,pvrtc:!!Renderer.extensions.pvrtc,astc:!!Renderer.extensions.astc};let found=!1;for(let key in _ktx1Settings)!0===_ktx1Settings[key]&&(found=!0);found||(_ktx1Settings=null)}let compressedIdentifier=/-compressedKtx2?/.exec(path)?.[0],compressed=!!compressedIdentifier&&(compressedIdentifier.endsWith("2")?"ktx2":"ktx1");if((Utils.query("noKtx")||!_ktx1Settings&&"ktx1"===compressed)&&(path=path.replace(compressedIdentifier,""),compressed=!1),/\.ktx2(?:\?|#|$)/.test(path)&&(compressed="ktx2",Utils.query("noKtx")&&(params.uncompressed=!0)),compressed&&params.hintUsingPixelData&&(checkCapabilities(),_offscreen.webgl||("ktx2"===compressed?params.uncompressed=!0:(path=path.replace(compressedIdentifier,""),compressed=!1))),compressed){try{let bitmap;if(path=path.substring(0,path.lastIndexOf(".")),bitmap="ktx1"===compressed?await Thread.shared().decodeKtx1CompressedImage({path:path,params:params,settings:_ktx1Settings}):await Ktx2Transcoder.transcode({path:`${path}.ktx2`,params:params}),!bitmap.fail)return bitmap}catch(e){}return _this.decode(fallback,params)}{let bitmap=await doDecodeImage(path,params);if(bitmap.fail&&!this.disableFallbackImage){const fallbackBitmap=await doDecodeImage(fallback,params);fallbackBitmap.fail||(bitmap=fallbackBitmap)}if(bitmap.fail)throw new Error(bitmap.fail);return function process(bitmap,scale){if(1==scale*_this.scale)return bitmap;let pow2=Math.isPowerOf2(bitmap.width,bitmap.height),canvas=document.createElement("canvas");return canvas.context=canvas.getContext("2d"),canvas.width=Math.round(bitmap.width*_this.scale*scale),canvas.height=Math.round(bitmap.height*_this.scale*scale),pow2&&scale*_this.scale<1&&(canvas.width=canvas.height=Math.floorPowerOf2(Math.max(canvas.width,canvas.height))),canvas.context.drawImage(bitmap,0,0,canvas.width,canvas.height),canvas}(bitmap,params.scale||1)}},this.decodeCubeLUT=async function(path,params){let fallback=Thread.absolutePath(Assets.getPath("assets/images/_scenelayout/invert.cube"));path=Thread.absolutePath(Assets.getPath(path));try{let bitmap=await Thread.shared().decodeCubeLUT({path:path,params:params});if(bitmap.fail&&!this.disableFallbackImage&&(bitmap=await Thread.shared().decodeCubeLUT({path:fallback,params:params}),bitmap.fail))throw"could not decode "+path;return{imgBmp:bitmap.imgBmp,cubesize:bitmap.cubesize}}catch(e){throw"could not decode "+path}},this.parseColors=async function(image,numColors=4){let result;if(checkCapabilities(),image.sizes)if(_offscreen.webgl)result=await Thread.shared().findDominantColors({image:image,numColors:numColors,compressionExtensions:_offscreen.compressionExtensions});else{let index=image.sizes.findIndex((e=>e.width<=128&&e.height<=128));index=Math.max(0,index);let data=(image=await _this.decode(image.path+"-compressedKtx2",{uncompressed:!0})).compressedData[index];result=await Thread.shared().findDominantColors({data:data,numColors:numColors},[data.buffer])}else if(_offscreen["2d"]){let buffers=[];image instanceof HTMLImageElement&&(image=await createImageBitmap(image),buffers.push(image)),result=await Thread.shared().findDominantColors({image:image,numColors:numColors},buffers)}else{let canvas=document.createElement("canvas");canvas.context=canvas.getContext("2d");let aspect=image.width/image.height,max=128;canvas.width=Math.round(aspect>1?max:max*aspect),canvas.height=Math.round(aspect>1?max/aspect:max),canvas.context.drawImage(image,0,0,canvas.width,canvas.height);let data=canvas.context.getImageData(0,0,canvas.width,canvas.height).data;result=await Thread.shared().findDominantColors({data:data,numColors:numColors},[data.buffer])}if(result.fail)throw new Error(result.fail);return result.colors.map((color=>(new Color).copy(color)))}}),"static"),Class((function Ktx2Transcoder(){Inherit(this,Component);const _this=this;var _transcoderReady,_basisAssets=["~assets/js/lib/basis_transcoder.js","~assets/js/lib/basis_transcoder.wasm"].map(Assets.getPath).map(Thread.absolutePath);async function initBasisTranscoder(){if(_transcoderReady)await _transcoderReady;else{_transcoderReady=Promise.create();let[js,wasmBinary]=await Promise.all(_basisAssets.map((async(path,i)=>{let response=await fetch(path);return 0===i?response.text():response.arrayBuffer()}))),formats=function getSupportedFormats(){let supported={astc:!!Renderer.extensions.astc,etc1:!!Renderer.extensions.etc1,etc2:!!Renderer.extensions.etc,dxt:!!Renderer.extensions.s3tc,bptc:!!Renderer.extensions.bptc,pvrtc:!!Renderer.extensions.pvrtc,uncompressed:!0};Renderer.type===Renderer.WEBGL2&&(supported.etc1=!1);let formats={};return Object.keys(supported).filter((id=>supported[id])).forEach((id=>{let format={id:id,needsPowerOfTwo:!1};switch(formats[id]=format,id){case"astc":format.gliFormat=[Renderer.extensions.astc.COMPRESSED_RGBA_ASTC_4x4_KHR,Renderer.extensions.astc.COMPRESSED_RGBA_ASTC_4x4_KHR];break;case"bptc":format.gliFormat=[Renderer.extensions.bptc.COMPRESSED_RGBA_BPTC_UNORM_EXT,Renderer.extensions.bptc.COMPRESSED_RGBA_BPTC_UNORM_EXT];break;case"dxt":format.gliFormat=[Renderer.extensions.s3tc.COMPRESSED_RGB_S3TC_DXT1_EXT,Renderer.extensions.s3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT];break;case"etc2":format.gliFormat=[Renderer.extensions.etc.COMPRESSED_RGB8_ETC2,Renderer.extensions.etc.COMPRESSED_RGBA8_ETC2_EAC];break;case"etc1":format.gliFormat=[Renderer.extensions.etc.COMPRESSED_RGB_ETC1_WEBGL];break;case"pvrtc":format.gliFormat=[Renderer.extensions.pvrtc.COMPRESSED_RGB_PVRTC_4BPPV1_IMG,Renderer.extensions.pvrtc.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG],format.needsPowerOfTwo=!0;break;case"uncompressed":format.gliFormat=[Renderer.context.RGBA,Renderer.context.RGBA]}})),formats}(),threads=Thread.shared(!0).array;await Promise.all(threads.map((async thread=>{thread.importCode(js),thread.loadFunction(initKtx2TranscoderThread),thread.loadFunction((function transcodeKtx2(){})),await thread.initKtx2TranscoderThread({wasmBinary:wasmBinary,formats:formats})}))),_transcoderReady.resolve(),_this.flag("transcoderLoaded",!0)}}function initKtx2TranscoderThread(e,id){var _formats;async function transcodeKtx2({path:path,params:params},id){let ktx2File;try{let response=await fetch(path);if(200!==response.status)throw new Error(`Image not found :: ${path}`);let arrayBuffer=await response.arrayBuffer();if(ktx2File=new BasisModule.KTX2File(new Uint8Array(arrayBuffer)),!ktx2File.isValid())throw new Error("Invalid or unsupported .ktx2 file");let ktxheader=ktx2File.getHeader(),basisFormat=ktx2File.isUASTC()?"uastc":"etc1s",baseWidth=ktx2File.getWidth(),baseHeight=ktx2File.getHeight(),baseDepth=ktxheader.pixelDepth,layers=ktx2File.getLayers()||1,levels=ktx2File.getLevels(),faceCount=ktx2File.getFaces(),hasAlpha=ktx2File.getHasAlpha(),premultiplyAlpha=!!(1&ktx2File.getDFDFlags()),{transcoderFormat:transcoderFormat,gliFormat:gliFormat,uncompressed:uncompressed}=function getTranscoderFormat(basisFormat,width,height,hasAlpha,params){let format;format=params.uncompressed?_formats.uncompressed:_formats[basisFormat].find((format=>!(hasAlpha&&format.transcoderFormat.length<2||format.needsPowerOfTwo&&!Math.isPowerOf2(width,height))));let uncompressed="uncompressed"===format.id;uncompressed&&!params.uncompressed&&console.warn("No suitable compressed texture format found. Decoding to RGBA32.");let which=hasAlpha?1:0;return{transcoderFormat:format.transcoderFormat[which],gliFormat:format.gliFormat[which],uncompressed:uncompressed}}(basisFormat,baseWidth,baseHeight,hasAlpha,params);if(!baseWidth||!baseHeight||!levels)throw new Error("Invalid texture");if(layers>1)throw new Error("Array textures not implemented");if(!ktx2File.startTranscoding())throw new Error("startTranscoding failed");let buffers=[],compressedData=[],sizes=[],cube=6===faceCount;if(params.isTexture3D&&ktxheader.vkFormat&&baseDepth){const channelCount=4;let data=new Uint8Array(arrayBuffer.slice(baseWidth*baseHeight*baseDepth*ktxheader.typeSize*channelCount*-1));compressedData.push(data),buffers.push(data.buffer),sizes.push({baseWidth:baseWidth,baseHeight:baseHeight,baseDepth:baseDepth})}else for(let level=0;level<levels;level++){let width,height,data,faces=[];for(let faceIndex=0;faceIndex<faceCount;++faceIndex){let levelInfo=ktx2File.getImageLevelInfo(level,0,faceIndex);width=levelInfo.origWidth,height=levelInfo.origHeight;let data=new Uint8Array(ktx2File.getImageTranscodedSizeInBytes(level,0,faceIndex,transcoderFormat));if(!ktx2File.transcodeImage(data,level,0,faceIndex,transcoderFormat,0,-1,-1))throw new Error("transcodeImage failed");faces.push(data)}if(faces.length>1){let totalLength=0;faces.forEach((face=>{totalLength+=face.byteLength})),data=new Uint8Array(totalLength);let offset=0;faces.forEach((face=>{data.set(face,offset),offset+=face.byteLength}))}else data=faces[0];compressedData.push(data),buffers.push(data.buffer),sizes.push({width:width,height:height})}resolve({path:path,gliFormat:gliFormat,compressedData:compressedData,sizes:sizes,width:baseWidth,height:baseHeight,depth:baseDepth,cube:cube,premultiplyAlpha:premultiplyAlpha,uncompressed:uncompressed},id,buffers)}catch(e){console.log(e.toString()),resolve({fail:`${path} could not be decoded: ${e.message||e}`},id)}finally{ktx2File&&(ktx2File.close(),ktx2File.delete())}}var BasisModule={wasmBinary:e.wasmBinary,onRuntimeInitialized:function(){BasisModule.initializeBasis(),function initFormats(formats){Object.keys(formats).forEach((id=>{let format=formats[id];switch(id){case"astc":format.transcoderFormat=[BasisModule.transcoder_texture_format.cTFASTC_4x4_RGBA.value,BasisModule.transcoder_texture_format.cTFASTC_4x4_RGBA.value];break;case"bptc":format.transcoderFormat=[BasisModule.transcoder_texture_format.cTFBC7_RGBA.value,BasisModule.transcoder_texture_format.cTFBC7_RGBA.value];break;case"dxt":format.transcoderFormat=[BasisModule.transcoder_texture_format.cTFBC1_RGB.value,BasisModule.transcoder_texture_format.cTFBC3_RGBA.value];break;case"etc2":format.transcoderFormat=[BasisModule.transcoder_texture_format.cTFETC1_RGB.value,BasisModule.transcoder_texture_format.cTFETC2_RGBA.value];break;case"etc1":format.transcoderFormat=[BasisModule.transcoder_texture_format.cTFETC1_RGB.value];break;case"pvrtc":format.transcoderFormat=[BasisModule.transcoder_texture_format.cTFPVRTC1_4_RGB.value,BasisModule.transcoder_texture_format.cTFPVRTC1_4_RGBA.value];break;case"uncompressed":format.transcoderFormat=[BasisModule.transcoder_texture_format.cTFRGBA32.value,BasisModule.transcoder_texture_format.cTFRGBA32.value]}})),_formats={uastc:[formats.astc,formats.bptc,formats.etc2,formats.etc1,formats.dxt,formats.pvrtc,formats.uncompressed].filter(Boolean),etc1s:[formats.etc2,formats.etc1,formats.bptc,formats.dxt,formats.pvrtc,formats.uncompressed].filter(Boolean),uncompressed:formats.uncompressed}}(e.formats),self.transcodeKtx2=transcodeKtx2,delete self.initKtx2TranscoderThread,resolve(id)}};BASIS(BasisModule)}_this.transcode=async function({path:path,params:params}){_this.flag("transcoderLoaded")||await initBasisTranscoder();let result=await Thread.shared().transcodeKtx2({path:path,params:params});if(result.fail)throw new Error(result.fail);return result}}),"static"),Class((function BaseCamera(_input,_group){Inherit(this,Object3D);const _this=this;var _debugCamera,_type="perspective";function resize(){if(_this.overrideResize)"function"==typeof _this.overrideResize&&_this.overrideResize();else switch(_type){case"perspective":_this.camera.aspect=Stage.width/Stage.height,_this.camera.updateProjectionMatrix();break;case"orthographic":if(_this.width||_this.height)_this.camera.setViewport(_this.width,_this.height);else{let m=900/Stage.height/100;_this.camera.setViewport(Stage.width*m,Stage.height*m)}}}this.camera=new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),this.group.add(this.camera),this.playgroundLock=function(camera=Camera.instance()){if(!Global.PLAYGROUND)return;Utils.getConstructorName(_this.parent).includes(Global.PLAYGROUND.split("/")[0])&&RenderManager.type==RenderManager.NORMAL&&camera.lock(_this.camera)},this.lock=function(camera){if("orthographic"==_type&&!camera.worldCamera.isOrthographicCamera)return console.error("You can't lock an orthographic camera to the main camera. Use an FXScene .setCamera");if(!camera){let p=_this.parent;for(;p;){if(p.useCamera&&p.nuke)return p.useCamera(_this);p=p.parent}}camera=camera||Camera.instance(),RenderManager.type==RenderManager.NORMAL&&camera.lock(_this.camera)},this.transition=function(time,ease,delay,camera=Camera.instance()){"object"==typeof delay&&(camera=delay,delay=0);let p=Promise.create();return camera.transition(_this.camera,time,ease,delay||0),_this.delayedCall((_=>p.resolve()),time+(delay||0)),p},this.manualTransition=function(camera=Camera.instance()){return camera.manualTransition(_this.camera)},this.setFOV=function(fov){"orthographic"!==_type&&fov!=this.camera.fov&&(this.camera.fov=fov,this.camera.updateProjectionMatrix())},this.getFOV=function(){return this.camera.fov},this.useOrthographic=function(w,h){"orthographic"!==_type&&(isNaN(w)||(this.width=w),isNaN(h)||(this.height=h),this.camera&&this.group.remove(this.camera),this.camera=new OrthographicCamera,this.group.add(this.camera),this.camera.position.z=1,_type="orthographic",resize())},this.usePerspective=function(){"perspective"!==_type&&(this.camera&&this.group.remove(this.camera),this.camera=new PerspectiveCamera,this.group.add(this.camera),_type="perspective",resize())},this.useCurve=function(curve){return _this.camera.curve=curve,this},_this.get("zoom",(()=>_this.camera.zoom)),_this.set("zoom",(zoom=>{_this.camera.zoom=zoom,_this.camera.updateProjectionMatrix()})),_this.get("near",(()=>_this.camera.near)),_this.set("near",(near=>{_this.camera.near=near,_this.camera.updateProjectionMatrix()})),_this.get("far",(()=>_this.camera.far)),_this.set("far",(far=>{_this.camera.far=far,_this.camera.updateProjectionMatrix()})),_this.setProjectionProperties=function({fov:fov,near:near,far:far,zoom:zoom}){let needsUpdate=!1;"orthographic"!==_type&&void 0!==fov&&fov!==this.camera.fov&&(this.camera.fov=fov,needsUpdate=!0),void 0!==near&&near!==this.camera.near&&(this.camera.near=near,needsUpdate=!0),void 0!==far&&far!==this.camera.far&&(this.camera.far=far,needsUpdate=!0),void 0!==zoom&&zoom!==this.camera.zoom&&(this.camera.zoom=zoom,needsUpdate=!0),needsUpdate&&_this.camera.updateProjectionMatrix()},function init(){if(_this.startRender((_=>{if(_this.group.updateMatrixWorld(!0),_debugCamera&&_debugCamera.visible){Utils3D.decompose(_this.camera,_debugCamera);let viewportHeight,active=AppState.get("playground_camera_active");viewportHeight=active.isOrthographicCamera?(active.top-active.bottom)/active.zoom:Utils3D.getHeightFromCamera(active,_this.camera.position.distanceTo(active.position)),_debugCamera.scale.setScalar(.025*viewportHeight/.1)}})),_this.onResize(resize),_input){_this.prefix=_input.prefix;let cameraUIL=CameraUIL.add(_this,_group);cameraUIL.setLabel("Camera"),_this.group._cameraUIL=cameraUIL}Global.PLAYGROUND&&AppState.bind("playground_camera_active",(active=>{_this.group._parent&&(active?(_debugCamera||((_debugCamera=new Mesh(new BoxGeometry(.1,.1,.2),new Shader("DebugCamera",{uColor:{value:new Color("#ffffff")},transparent:!0,depthTest:!1}))).renderOrder=9999,_this.delayedCall((_=>_this.group._parent.add(_debugCamera)),50)),_debugCamera.visible=!0):_debugCamera&&(_debugCamera.visible=!1))}))}()})),Class((function Camera(_worldCamera){Inherit(this,Component);const _this=this;var _debug,_prevCamera,_lockCamera,_curve,_manual,_scheduleSlot,_calc=new Vector3,_target=new Group,_anim={weight:0,weight2:0},_center=new Vector3,_cameraTarget=new Group,_cameraTarget2=new Group;function loop(){_scheduleSlot||render()}function render(){if(_debug&&(_debug.visible=!_debug.position.equals(_center)),_manual&&(_anim.weight2=_manual.value),_anim.weight+=(_anim.weight2-_anim.weight)*_this.lerp,_prevCamera){if(_prevCamera.updateMatrixWorld(),_lockCamera.updateMatrixWorld(),_curve){_curve.lerpPos||(_curve.lerpPos=(new Vector3).copy(_prevCamera.getWorldPosition())),_curve.lerpOffset||(_curve.lerpOffset=(new Vector3).copy(_curve.getPointAt(1)).multiplyScalar(-2).add(_lockCamera.getWorldPosition()));let pos=_calc.copy(_curve.getPointAt(_anim.weight)).add(_curve.lerpOffset).add(_lockCamera.getWorldPosition());_curve.lerpPos.lerp(pos,_curve.lerp||1,!1),_target.position.copy(_curve.lerpPos),_anim.weight>=1&&(_curve=_curve.lerpPos=_curve.lerpOffset=null,_this.onCurveComplete&&_this.onCurveComplete())}else _target.position.copy(_prevCamera.getWorldPosition()).lerp(_lockCamera.getWorldPosition(),_anim.weight,!1);_target.quaternion.copy(_prevCamera.getWorldQuaternion()).slerp(_lockCamera.getWorldQuaternion(),_anim.weight,!1);let needsUpdate=!1,zoom=Math.mix(_prevCamera.zoom,_lockCamera.zoom,_anim.weight);_worldCamera.zoom!==zoom&&(_worldCamera.zoom=zoom,needsUpdate=!0);let fov=!_worldCamera.isOrthographicCamera&&Math.mix(_prevCamera.fov,_lockCamera.fov,_anim.weight);fov&&_worldCamera.fov!==fov&&(_worldCamera.fov=fov,needsUpdate=!0);let near=Math.mix(_prevCamera.near,_lockCamera.near,_anim.weight);_worldCamera.near!==near&&(_worldCamera.near=near,needsUpdate=!0);let far=Math.mix(_prevCamera.far,_lockCamera.far,_anim.weight);_worldCamera.far!==far&&(_worldCamera.far=far,needsUpdate=!0),needsUpdate&&_worldCamera.updateProjectionMatrix(),_cameraTarget.position.lerp(_target.position,_this.lerp2,!1),_cameraTarget.quaternion.slerp(_target.quaternion,_this.lerp2,!1)}else if(_lockCamera){_lockCamera.updateMatrixWorld(),Utils3D.decompose(_lockCamera,_cameraTarget);let needsUpdate=!1;_lockCamera.zoom&&_worldCamera.zoom!=_lockCamera.zoom&&(_worldCamera.zoom=_lockCamera.zoom,needsUpdate=!0),_worldCamera.isOrthographicCamera||_worldCamera.fov==_lockCamera.fov||(_worldCamera.fov=_lockCamera.fov,needsUpdate=!0),_worldCamera.near!==_lockCamera.near&&(_worldCamera.near=_lockCamera.near,needsUpdate=!0),_worldCamera.far!==_lockCamera.far&&(_worldCamera.far=_lockCamera.far,needsUpdate=!0),needsUpdate&&_worldCamera.updateProjectionMatrix()}(_prevCamera||_lockCamera)&&(_cameraTarget2.position.lerp(_cameraTarget.position,_this.finalLerp,!1),_cameraTarget2.quaternion.slerp(_cameraTarget.quaternion,_this.finalLerp,!1),_worldCamera.position.lerp(_cameraTarget2.position,_this.finalLerp,!1),_worldCamera.quaternion.slerp(_cameraTarget2.quaternion,_this.finalLerp,!1)),_worldCamera.updateMatrixWorld(),_debug&&(_debug.position.copy(_worldCamera.position),_debug.quaternion.copy(_worldCamera.quaternion)),RenderManager.fire(_this)}this.lerp=1,this.lerp2=1,this.worldCamera=_worldCamera,this.finalLerp=1,this.multiTween=!0,function(){if(RenderManager.type!=RenderManager.NORMAL)return _worldCamera=void 0,void(_this.worldCamera=_worldCamera);_worldCamera.controllingCamera=_this,_this.startRender(loop,RenderManager.AFTER_LOOPS)}(),this.lock=function(camera,scheduleSlot){camera instanceof Camera?(scheduleSlot=camera,camera=camera.worldCamera):camera.controllingCamera&&(scheduleSlot=camera.controllingCamera),_lockCamera=camera,_prevCamera=null,_worldCamera&&(_scheduleSlot&&_this.stopRender(render,_scheduleSlot),(_scheduleSlot=scheduleSlot)&&_this.startRender(render,_scheduleSlot),_lockCamera.zoom&&(_worldCamera.zoom=_lockCamera.zoom),_worldCamera.isOrthographicCamera||(_worldCamera.fov=_lockCamera.fov),_worldCamera.updateProjectionMatrix(),render())},this.transition=function(camera,duration=1e3,ease="easeInOutCubic",scheduleSlotOrDelay){let delay,scheduleSlot;return"number"==typeof scheduleSlotOrDelay?delay=scheduleSlotOrDelay:scheduleSlotOrDelay&&(scheduleSlot=scheduleSlotOrDelay),camera instanceof Camera?(scheduleSlot=camera,camera=camera.worldCamera):camera.controllingCamera&&(scheduleSlot=camera.controllingCamera),_curve&&(_curve=_curve.lerpPos=_curve.lerpOffset=null),camera.curve&&((_curve=camera.curve).lerpPos=camera.lerpPos),_prevCamera===camera?(duration*=.5*Math.smoothStep(.5,1,_anim.weight)+.5,_anim.weight=1-_anim.weight):_anim.weight=0,_manual=void 0,scheduleSlot&&_worldCamera&&(_scheduleSlot&&_this.stopRender(render,_scheduleSlot),_scheduleSlot=scheduleSlot,_this.startRender(render,_scheduleSlot)),_anim.weight2=_anim.weight,_prevCamera=_lockCamera,_lockCamera=camera,tween(_anim,{weight2:1},duration,ease,delay)},this.manualTransition=function(camera){return this.transition(camera).stop(),_manual={value:0}},this.setPrevCamera=function(camera){_prevCamera=camera.camera||camera},this.get("worldCamera",(_=>_worldCamera)),this.get("lockCamera",(_=>_lockCamera)),this.set("debugScale",(s=>{_debug&&_debug.scale.setScalar(s)})),this.createLocal=function(camera){return camera||(camera=World.CAMERA.clone(),_this.onResize((_=>{camera.aspect=Stage.width/Stage.height,camera.updateProjectionMatrix()}))),new Camera(camera.camera||camera)}}),"singleton"),Class((function GazeCamera(_input,_group){Inherit(this,BaseCamera);const _this=this;var _strength={v:1},_cacheObj={},_move=new Vector3,_position=new Vector3,_wobble=new Vector3,_rotation=0,_wobbleAngle=Math.radians(Math.rand(0,360)),_innerGroup=new Group,_viewportFocusOffset=new Vector3,_hasViewportFocusOffset=!1,_manualRender=!1,_quaternion=new Quaternion,_useCustomMove=!1,_prevMoveX=0;const V3_ZERO=new Vector3(0);function loop(){_hasViewportFocusOffset&&_this.camera.position.sub(_viewportFocusOffset);let moveX=0,moveY=0;_useCustomMove?(moveX=Math.clamp(_this.customMove.x,-1,1),moveY=Math.clamp(_this.customMove.y,-1,1)):_this.useAccelerometer&&Mobile.Accelerometer&&Mobile.Accelerometer.connected?(moveX=Math.range(Mobile.Accelerometer.x,-2,2,-1,1,!0),moveY=0):(moveX=Math.range(Mouse.x,0,Stage.width,-1,1,!0),moveY=Math.range(Mouse.y,0,Stage.height,-1,1,!0)),_move.x=_this.position.x+moveX*_strength.v*_this.moveXY.x*_this.strength,_move.y=_this.position.y+moveY*_strength.v*_this.moveXY.y*_this.strength;let deltaX=moveX-_prevMoveX;_prevMoveX=moveX;let rotateStrength=Math.range(Math.abs(deltaX)/Stage.width,0,.02,0,1,!0);if(_rotation=Math.lerp(Math.radians(_this.deltaRotate)*rotateStrength*Math.sign(deltaX),_rotation,.02*_this.deltaLerp*_strength.v),_innerGroup.rotation.z=Math.lerp(_rotation,_innerGroup.rotation.z,.07*_this.deltaLerp),_move.z=_this.position.z,_position.lerp(_move,_this.lerpSpeed2),_position.z+=_this.zoomOffset,_this.camera.position.lerp(_position,_this.lerpSpeed),_this.camera.lookAt(_this.lookAt),(Math.abs(_this.cameraRotation.x)>Base3D.DIRTY_EPSILON||Math.abs(_this.cameraRotation.y)>Base3D.DIRTY_EPSILON||Math.abs(_this.cameraRotation.z)>Base3D.DIRTY_EPSILON)&&(_quaternion.setFromEuler(_this.cameraRotation),_this.camera.quaternion.multiply(_quaternion)),function focusViewport(){let nextHasViewportFocusOffset=Math.abs(_this.viewportFocus.x)>1e-4||Math.abs(_this.viewportFocus.y)>1e-4;nextHasViewportFocusOffset!==_hasViewportFocusOffset&&(nextHasViewportFocusOffset||_viewportFocusOffset.setScalar(0),_hasViewportFocusOffset=nextHasViewportFocusOffset);if(!_hasViewportFocusOffset)return;let localCamera=_cacheObj,camera=_this.camera;camera.matrixDirty&&camera.updateMatrix();localCamera.matrixWorld=camera.matrix,localCamera.projectionMatrix=camera.projectionMatrix,_viewportFocusOffset.copy(_this.lookAt).project(localCamera),isFinite(_viewportFocusOffset.x)||_viewportFocusOffset.set(0,0,0);_viewportFocusOffset.x-=_this.viewportFocus.x,_viewportFocusOffset.y-=_this.viewportFocus.y,_viewportFocusOffset.unproject(localCamera),_viewportFocusOffset.sub(_this.lookAt),_this.camera.position.add(_viewportFocusOffset)}(),_this.wobbleStrength>0){let t=Render.TIME;_wobble.x=Math.cos(_wobbleAngle+t*(75e-5*_this.wobbleSpeed))*(_wobbleAngle+200*Math.sin(t*(95e-5*_this.wobbleSpeed))),_wobble.y=Math.sin(Math.asin(Math.cos(_wobbleAngle+t*(85e-5*_this.wobbleSpeed))))*(150*Math.sin(_wobbleAngle+t*(75e-5*_this.wobbleSpeed))),_wobble.x*=2*Math.sin(_wobbleAngle+t*(75e-5*_this.wobbleSpeed)),_wobble.y*=1.75*Math.cos(_wobbleAngle+t*(65e-5*_this.wobbleSpeed)),_wobble.x*=1.1*Math.cos(_wobbleAngle+t*(75e-5*_this.wobbleSpeed)),_wobble.y*=1.15*Math.sin(_wobbleAngle+t*(25e-5*_this.wobbleSpeed)),_wobble.z=Math.sin(_wobbleAngle+.0025*_wobble.x)*(100*_this.wobbleZ),_wobble.multiplyScalar(.001*_this.wobbleStrength*_strength.v),_innerGroup.position.lerp(_wobble,.07),_this.flag("hasWobble",!0)}else _this.flag("hasWobble")&&(_innerGroup.position.lerp(V3_ZERO,.07),_innerGroup.position.length()<.001&&(_innerGroup.position.set(0,0,0),_this.flag("hasWobble",!1)))}this.strength=1,this.moveXY=new Vector2(4,4),this.position=new function Position(){Inherit(this,Component);var _x=0,_y=0,_z=0;this.get("x",(_=>_x)),this.get("y",(_=>_y)),this.get("z",(_=>_z)),this.set("x",(x=>{_x=x})),this.set("y",(y=>{_y=y})),this.set("z",(z=>{_z=z,_move.z=_z,_this.camera.position.copy(_move),_position.copy(_move)})),this.set=function(x,y,z,noCopy){_x=x,_y=y,_z=z,_move.z=z,noCopy||_this.camera.position.copy(_move),_position.copy(_move)},this.toArray=function(){return[_x,_y,_z]},this.fromArray=function(array){_x=array[0],_y=array[1],_z=array[2],_move.set(_x,_y,_z),_this.camera.position.copy(_move),_position.copy(_move)},this.copy=function(vec){_x=vec.x,_y=vec.y,_z=vec.z,_move.set(_x,_y,_z),_this.camera.position.copy(_move),_position.copy(_move)}},this.lerpSpeed=.05,this.lerpSpeed2=1,this.lookAt=new Vector3(0,0,0),this.cameraRotation=new Euler,this.viewportFocus=new Vector2(0,0),this.deltaRotate=0,this.deltaLerp=1,this.wobbleSpeed=1,this.wobbleStrength=0,this.wobbleZ=1,this.zoomOffset=0,function(){if(_input){_this.prefix=_input.prefix;let cameraUIL=CameraUIL.add(_this,_group);cameraUIL.setLabel("Camera"),_this.group._cameraUIL=cameraUIL}_this.startRender(loop),_innerGroup.add(_this.camera),_this.group.add(_innerGroup)}(),this.orbit=function(time=1e3,ease="easeInOutSine"){return tween(_strength,{v:1},time,ease)},this.still=function(time=300,ease="easeInOutSine"){return tween(_strength,{v:0},time,ease)};var _v1=new Vector3,_v2=new Vector3,_v3=new Vector3;this.move=function(vec){let moveDiff=_v1.subVectors(_move,_this.position),positionDiff=_v2.subVectors(_move,_position),cameraPosDiff=_v3.subVectors(_this.camera.position,_position);_this.position.set(vec.x,vec.y,vec.z,!0),_move.copy(vec).add(moveDiff),_position.copy(_move).add(positionDiff),_this.camera.position.copy(_position).add(cameraPosDiff)},this.get("manualRender",(()=>_manualRender)),this.set("manualRender",(value=>{(value=!!value)!==_manualRender&&((_manualRender=value)?_this.stopRender(loop):_this.startRender(loop))})),this.get("useCustomMove",(()=>_useCustomMove)),this.set("useCustomMove",(value=>{value?(_useCustomMove=!0,_this.customMove||(_this.customMove=new Vector2)):_useCustomMove=!1})),this.update=function(){_manualRender||!Hydra.LOCAL||_this.flag("manualRenderWarned")||(console.warn("Set manualRender to true if using GazeCamera.update()"),_this.flag("manualRenderWarned",!0)),loop()}}));class Base3D{constructor(){this.position=new Vector3D,this.rotation=new Euler,this.quaternion=new Quaternion,this.scale=new Vector3D(1,1,1),this._parent=null,this.up=new Vector3(0,1,0),this.isObject3D=!0,this.children=[],this.childrenLength=0,this.modelViewMatrix=new Matrix4,this.normalMatrix=new Matrix3,this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=!0,this.matrixWorldNeedsUpdate=!1,this.matrixDirty=!0,this.decomposeDirty=!0,this.visible=!0,this.hidden=!1,this.castShadow=!1,this.frustumCulled=!0,this.occlusionCulled=!1,this._renderOrder=0,this.worldPos=new Vector3,this.worldQuat=new Quaternion;const _this=this;this.quaternion.onChange((_=>{_this.matrixDirty=!0,_this.decomposeDirty=!0,_this.onMatrixDirty&&_this.onMatrixDirty(),_this.rotation.setFromQuaternion(_this.quaternion,void 0,!1)})),this.rotation.onChange((_=>{_this.matrixDirty=!0,_this.decomposeDirty=!0,_this.onMatrixDirty&&_this.onMatrixDirty(),_this.quaternion.setFromEuler(_this.rotation,!1)})),this.scale.onChange((_=>{_this.matrixDirty=!0,_this.decomposeDirty=!0,_this.onMatrixDirty&&_this.onMatrixDirty()})),this.position.onChange((_=>{_this.matrixDirty=!0,_this.decomposeDirty=!0,_this.onMatrixDirty&&_this.onMatrixDirty()}))}get renderOrder(){return this._renderOrder}set renderOrder(value){this._renderOrder=value;let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent;for(let i=0;i<this.children.length;i++)this.children[i].renderOrder+=value}applyMatrix(matrix){return this.matrix.multiplyMatrices(matrix,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale),this}applyQuaternion(q){return this.quaternion.premultiply(q),this}setRotationFromAxisAngle(axis,angle){this.quaternion.setFromAxisAngle(axis,angle)}setRotationFromMatrix(m){this.quaternion.setFromRotationMatrix(m)}setRotationFromQuaternion(q){this.quaternion.copy(q)}localToWorld(v){return v.applyMatrix4(this.matrixWorld)}worldToLocal(v){let m1=this.M1||new Matrix4;return this.M1=m1,v.applyMatrix4(m1.getInverse(this.matrixWorld))}lookAt(x,y,z){let m1=this.M1||new Matrix4;this.M1=m1;let v=this.V1||new Vector3;this.V1=v,x.isVector3?v.copy(x):v.set(x,y,z),this.isCamera?m1.lookAt(this.position,v,this.up):m1.lookAt(v,this.position,this.up),this.quaternion.setFromRotationMatrix(m1)}add(object){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.add(arguments[i]);return this}if(object===this)return this;if(object&&object.isScene)throw"You can't add a scene to a group";if(object&&object.isObject3D?(null!==object._parent&&object._parent.remove(object),object._parent=this,this.children.push(object),this.childrenLength=this.children.length):console.error("Object is not instance of Object3D",object),this.isScene)this.displayNeedsUpdate=!0;else{let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent}return this}attach(object){this.updateMatrixWorld(!0);let m1=this.M1||new Matrix4;this.M1=m1;const worldInverse=this.M1.getInverse(this.matrixWorld);null!==object._parent&&(object._parent.updateMatrixWorld(!0),worldInverse.multiply(object._parent.matrixWorld)),object.applyMatrix(worldInverse),this.add(object),object.updateMatrixWorld(!0)}remove(object){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.remove(arguments[i]);return this}if(this.isScene)this.displayNeedsUpdate=!0;else{let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent}this.children.remove(object),this.childrenLength=this.children.length}getWorldPosition(target,sleep){let v=this.V1||new Vector3;this.V1=v,target||(target=v),sleep||this.updateMatrixWorld();let el=this.matrixWorld.elements;return target.x=el[12],target.y=el[13],target.z=el[14],target}getWorldScale(target){let v=this.V1S||new Vector3;this.V1S=v;let v2=this.V12||new Vector3;this.V2=v2;let q=this.Q1||new Quaternion;return this.Q1=q,target||(target=v2),this.updateMatrixWorld(),this.matrixWorld.decompose(v,q,target),target}getWorldQuaternion(target){let v=this.V1Q||new Vector3;this.V1Q=v;let q=this.Q1||new Quaternion;return this.Q1=q,target||(target=q),this.updateMatrixWorld(),this.matrixWorld.decompose(v,target,v),target}traverse(callback){callback(this);let children=this.children;for(let i=0;i<children.length;i++)children[i].traverse(callback)}updateMatrix(){!1!==this.matrixAutoUpdate&&(this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0)}updateMatrixWorld(force){if(!1===this.matrixAutoUpdate)return;if(!force&&!this.determineVisible())return;(this.determineDirty()||force)&&!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==force||(null===this._parent||this.determineNoTransform()?this.matrixWorld.copy(this.matrix):(this.matrixWorld.multiplyMatrices(this._parent.matrixWorld,this.matrix),RenderStats.active&&RenderStats.update("updateMatrixWorld")),this.decomposeDirty=!0,this.matrixWorldNeedsUpdate=!1);const children=this.children;for(let i=this.childrenLength-1;i>-1;i--)children[i].updateMatrixWorld(force);this.matrixDirty=!1}clone(recursive){(new this.constructor).copy(this,recursive)}copy(source,recursive){if(this.name=source.name,this.up.copy(source.up),this.position.copy(source.position),this.quaternion.copy(source.quaternion),this.scale.copy(source.scale),this.matrix.copy(source.matrix),this.matrixWorld.copy(source.matrixWorld),this.matrixAutoUpdate=source.matrixAutoUpdate,this.matrixWorldNeedsUpdate=source.matrixWorldNeedsUpdate,this.visible=source.visible,this.castShadow=source.castShadow,this.receiveShadow=source.receiveShadow,this.frustumCulled=source.frustumCulled,this.renderOrder=source.renderOrder,!0===recursive)for(let i=0;i<source.children.length;i++){let child=source.children[i];this.add(child.clone())}return this}render(){}determineVisible(){if(!this.visible||this.hidden)return!1;let p=this._parent;for(;p;){if(!p.visible||p.hidden)return!1;p=p._parent}return!0}determineDirty(){let p=this._parent;for(;p;){if(p.matrixDirty)return!0;p=p._parent}return this.matrixDirty}determineNoTransform(){return this._parent?this._parent.determineNoTransform()&&this.matrix.isIdentity():this.matrix.isIdentity()}translateX(distance){this.xAxis||(this.xAxis=new Vector3(1,0,0)),this.translateOnAxis(this.xAxis,distance)}translateY(distance){this.yAxis||(this.yAxis=new Vector3(0,1,0)),this.translateOnAxis(this.yAxis,distance)}translateZ(distance){this.zAxis||(this.zAxis=new Vector3(0,0,1)),this.translateOnAxis(this.zAxis,distance)}translateOnAxis(axis,distance){let v=this.V1||new Vector3;return this.V1=v,v.copy(axis).applyQuaternion(this.quaternion),this.position.add(v.multiplyScalar(distance)),this}upload(){this.shader&&(this.shader.upload(this,this.geometry),this.shader.shadow&&this.shader.shadow.upload(this,this.geometry)),this.geometry&&this.geometry.upload(this,this.shader)}destroy(){this.geometry&&this.geometry.destroy&&this.geometry.destroy(this),this.shader&&this.shader.destroy&&this.shader.destroy(this),this.hitDestroy&&this.hitDestroy(),this._gl&&this._gl.ubo&&this._gl.ubo.destroy(),this._gl&&this._gl.vao&&this._gl.vao.destroy(),this._gl&&(this._gl=null),this._parent&&this._parent.remove(this),this.parent&&this.parent.__destroyChild&&this.parent.__destroyChild(this.__id)}}Base3D.DIRTY_EPSILON=1e-4,Class((function Renderer(_params={}){Inherit(this,Component);const _this=this;var _canvas,_gl,_width,_height,_anisotropy,_clearColor,_projScreenMatrix,_frustum,_ubo,_dpr=1,_resolution=new Vector2,_m0=new Matrix4,_m1=new Matrix4,_time={value:0},_stencilActive=!1;function initCameraUBO(camera){camera._ubo=new UBO(0,_gl),camera._ubo.push({value:camera.projectionMatrix}),camera._ubo.push({value:camera.matrixWorldInverse}),camera._ubo.push({value:camera.worldPos}),camera._ubo.push({value:camera.worldQuat}),camera._ubo.push({value:_resolution}),camera._ubo.push(_time),camera._ubo.push(Render.timeScaleUniform),camera._ubo.upload()}function sortFrontToBack(array,sortOrder,camera){for(let i=array.length-1;i>-1;i--){let obj=array[i];obj.__sortVec||(obj.__sortVec=new Vector3),sortOrder==Scene.FRONT_TO_BACK_BOUNDING&&obj.geometry&&obj.geometry.boundingSphere?obj.__sortVec.copy(obj.geometry.boundingSphere.center):obj.__sortVec.setFromMatrixPosition(camera.modelViewMatrix)}array.sort(((a,b)=>b.__sortVec.z-a.__sortVec.z))}function projectObject(object,camera,scene){if(object.isOcclusionMesh&&scene.displayNeedsUpdate&&scene.toRender[0].push(object),object.doNotProject)return;let isVisible=!1;if(void 0!==object.shader){let visible=object.determineVisible()&&object.shader.visible&&!object.shader.neverRender&&!object.hidden;visible&&(object.modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix),null!==object._occlusionMesh&&object.isMesh&&this.useOcclusionQuery&&(object.updateOcclusionMesh(),object._occlusionMesh.matrixWorld.copy(object.matrixWorld),object._occlusionMesh.normalMatrix.copy(object.normalMatrix),object._occlusionMesh.modelViewMatrix.copy(object.modelViewMatrix))),isVisible=visible,(scene.displayNeedsUpdate||object.shader.transparent&&!scene.disableAutoSort&&visible)&&object.getWorldPosition(object.worldPos),scene.displayNeedsUpdate&&scene.toRender[object.shader.transparent?1:0].push(object)}else isVisible=object.visible&&!object.hidden;if(isVisible||scene.displayNeedsUpdate)for(let i=object.childrenLength-1;i>-1;i--)projectObject(object.children[i],camera,scene)}function attachSceneUniforms(object,scene,camera){if(Shader.renderer.appendUniform(object.shader,"normalMatrix",object.normalMatrix),Shader.renderer.appendUniform(object.shader,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader,"modelViewMatrix",object.modelViewMatrix),_ubo?camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader,"projectionMatrix",camera.projectionMatrix),Shader.renderer.appendUniform(object.shader,"viewMatrix",camera.matrixWorldInverse),Shader.renderer.appendUniform(object.shader,"cameraPosition",camera.worldPos),Shader.renderer.appendUniform(object.shader,"cameraQuaternion",camera.worldQuat),Shader.renderer.appendUniform(object.shader,"resolution",_resolution),Shader.renderer.appendUniform(object.shader,"time",_time.value),Shader.renderer.appendUniform(object.shader,"timeScale",Render.timeScaleUniform.value)),_this.shadows&&object.shader.receiveShadow&&!_this.overridePreventShadows){let lights=Lighting.getShadowLights();object._gl||(object._gl={}),object._gl.shadowData||(object._gl.shadowData={combined:new Float32Array(16*lights.length)});for(let i=0;i<lights.length;i++){let light=lights[i];_m1.multiplyMatrices(light.shadow.camera.matrixWorldInverse,object.matrixWorld),_m0.multiplyMatrices(light.shadow.camera.projectionMatrix,_m1),_m0.toArray(object._gl.shadowData.combined,16*i)}scene._shadowData&&scene._shadowData.count&&(object.shader.uniforms.shadowMap.value=scene._shadowData[_this.overridePreventShadows?"emptyMaps":"maps"],Shader.renderer.appendUniform(object.shader,"shadowMatrix",object._gl.shadowData.combined,"matrix"),Shader.renderer.appendUniform(object.shader,"shadowLightPos",scene._shadowData.pos,"vec3"),Shader.renderer.appendUniform(object.shader,"shadowSize",scene._shadowData.size,"float"))}}function attachShadowUniforms(object,scene,light){light._mvm||(light._mvm=new Matrix4),light._nm||(light._nm=new Matrix3),light._mvm.multiplyMatrices(light.shadow.camera.matrixWorldInverse,object.matrixWorld),light._nm.getNormalMatrix(object.modelViewMatrix),Shader.renderer.appendUniform(object.shader.shadow,"normalMatrix",light._nm),Shader.renderer.appendUniform(object.shader.shadow,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader.shadow,"modelViewMatrix",light._mvm),_ubo?light.shadow.camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader.shadow,"projectionMatrix",light.shadow.camera.projectionMatrix),Shader.renderer.appendUniform(object.shader.shadow,"viewMatrix",light.shadow.camera.matrixWorldInverse))}function loop(t,dt){_time.value+=.001*dt}function render(scene,camera,rt){rt&&rt.width?(_resolution.set(rt.width,rt.height),rt.multisample?RenderTarget.renderer.bind(rt._rtMultisample):RenderTarget.renderer.bind(rt)):(Renderer.overrideViewport||(_gl.viewport(0,0,_width*_dpr,_height*_dpr),_resolution.set(_canvas.width,_canvas.height)),_this.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))),camera.getWorldPosition(camera.worldPos),camera.getWorldQuaternion(camera.worldQuat),_frustum.setFromCamera(camera),_ubo&&(camera._ubo?camera._ubo.update():initCameraUBO(camera));for(let l=0;l<2;l++){let len=scene.toRender[l].length;for(let i=0;i<len;i++){let object=scene.toRender[l][i];if(object.onBeforeRender&&object.onBeforeRender(),object._drawing=!1,object.determineVisible()&&object.shader.visible&&!object.shader.neverRender&&!object.neverRender&&(_this.useOcclusionQuery&&object._occlusionGroup&&(object._occlusionGroup.updateOcclusionBoundingBox(),object._occlusionGroup.updateOcclusionVisibility(object?._gl?.occluded)),_this.useOcclusionQuery&&object.isOcclusionMesh&&_this.type==Renderer.WEBGL2&&object._queryMesh.occlusionCulled&&(object.shader.draw(object,object.geometry),attachSceneUniforms(object,scene,camera),object.geometry.draw(object,object.shader,!0)),!1===object.frustumCulled||!0===_frustum.intersectsObject(object))){if(object._drawing=!0,object.shader.nullRender||object?._gl?.occluded||object.isOcclusionMesh)continue;let doubleSideTransparency=object.shader.side===Shader.DOUBLE_SIDE_TRANSPARENCY;doubleSideTransparency&&(object.shader.side=Shader.BACK_SIDE),object.shader.draw(object,object.geometry),attachSceneUniforms(object,scene,camera),object.geometry.draw(object,object.shader),doubleSideTransparency&&(object.shader.side=Shader.FRONT_SIDE,object.shader.draw(object,object.geometry),attachSceneUniforms(object,scene,camera),object.geometry.draw(object,object.shader),object.shader.side=Shader.DOUBLE_SIDE_TRANSPARENCY)}}}rt&&rt.width&&(rt.texture.generateMipmaps&&(_gl.bindTexture(_gl.TEXTURE_2D,rt.texture._gl),_gl.generateMipmap(_gl.TEXTURE_2D),_gl.bindTexture(_gl.TEXTURE_2D,null)),rt.multisample?(_this.blit(rt._rtMultisample,rt),RenderTarget.renderer.unbind(rt._rtMultisample)):RenderTarget.renderer.unbind(rt))}this.autoClear=!0,this.shadows=Renderer.SHADOWS_MED,this.useOcclusionQuery=!1,Renderer.instance=_this,Renderer.CLEAR=[0,0,0,1],function initContext(){let contextAttributes={antialias:void 0!==_params.antialias&&_params.antialias,powerPreference:_params.powerPreference,preserveDrawingBuffer:_params.preserveDrawingBuffer,xrCompatible:_params.xrCompatible,alpha:void 0!==_params.alpha&&_params.alpha,stencil:_params.stencil};if(function iOSContextLoss(){return"ios"===Device.system.os&&Device.system.browserVersion>16.7&&Device.system.browserVersion<17.1}()&&delete contextAttributes.powerPreference,_this.stencil=!!_params.stencil,(_canvas=_params.canvas||document.createElement("canvas")).addEventListener("webglcontextlost",(()=>Events.emitter._fireEvent(Events.WEBGL_CONTEXT_LOSS)),!1),_params.gl?(_gl=_params.gl,_this.type=Device.graphics.webgl.version.includes(["webgl 2","webgl2"])?Renderer.WEBGL2:Renderer.WEBGL1):Device.graphics.webgl?["webgl2","webgl","experimental-webgl"].forEach((name=>{_gl||"webgl2"==name&&_params.forceWebGL1||(_gl=_canvas.getContext(name,contextAttributes),_this.type=_gl&&"webgl2"==name?Renderer.WEBGL2:Renderer.WEBGL1)})):(_gl=new NoGLPolyfill,_this.type=Renderer.WEBGL2),!_gl)throw"Error! Could not create WebGL context";_this.domElement=_canvas,_canvas.style.background="black",Renderer.type=_this.type,Renderer.context=_this.context=_gl}(),function setExtensions(){_this.extensions={},_this.type!=Renderer.WEBGL2?(_this.extensions.VAO=_gl.getExtension("OES_vertex_array_object"),_this.extensions.instancedArrays=_gl.getExtension("ANGLE_instanced_arrays"),_this.extensions.standardDerivatives=_gl.getExtension("OES_standard_derivatives"),_this.extensions.elementIndexUint=_gl.getExtension("OES_element_index_uint"),_this.extensions.depthTextures=_gl.getExtension("WEBGL_depth_texture"),_this.extensions.drawBuffers=_gl.getExtension("WEBGL_draw_buffers"),_this.extensions.halfFloat=_gl.getExtension("OES_texture_half_float"),_this.extensions.float=_gl.getExtension("OES_texture_float"),_this.extensions.colorBufferFloat=_gl.getExtension("WEBGL_color_buffer_float"),_this.extensions.lod=_gl.getExtension("EXT_shader_texture_lod"),_this.extensions.minMax=_gl.getExtension("EXT_blend_minmax")):(_this.extensions.disjointTimerQuery=_gl.getExtension("EXT_disjoint_timer_query_webgl2"),_this.extensions.colorBufferFloat=_gl.getExtension("EXT_color_buffer_float"),_this.extensions.oculusMultiview=_gl.getExtension("OCULUS_multiview"),_this.extensions.oculusMultiview2=_gl.getExtension("OVR_multiview2")),_this.extensions.filterFloat=_gl.getExtension("OES_texture_float_linear"),_this.extensions.anisotropy=_gl.getExtension("EXT_texture_filter_anisotropic")||_gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),_this.extensions.astc=_gl.getExtension("WEBGL_compressed_texture_astc"),_this.extensions.atc=_gl.getExtension("WEBGL_compressed_texture_atc"),_this.extensions.etc=_gl.getExtension("WEBGL_compressed_texture_etc"),_this.extensions.etc1=_gl.getExtension("WEBGL_compressed_texture_etc1"),_this.extensions.pvrtc=_gl.getExtension("WEBGL_compressed_texture_pvrtc")||_gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),_this.extensions.s3tc=_gl.getExtension("WEBGL_compressed_texture_s3tc")||_gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),_this.extensions.bptc=_gl.getExtension("EXT_texture_compression_bptc"),_this.extensions.s3tc_srgb=_gl.getExtension("WEBGL_compressed_texture_s3tc_srgb"),Renderer.extensions=_this.extensions}(),function initRenderers(){Geometry.renderer=new GeometryRendererWebGL(_gl),Texture.renderer=new TextureRendererWebGL(_gl),Shader.renderer=new ShaderRendererWebGL(_gl),RenderTarget.renderer=new FBORendererWebGL(_gl)}(),function initMath(){_projScreenMatrix=new Matrix4,new Vector3,_frustum=new Frustum}(),function initUBO(){_this.type==Renderer.WEBGL2&&(_ubo=!0),Renderer.UBO=_ubo}(),_this.startRender(loop),this.render=function(scene,camera,rt,forceToScreen){_this.preventRender||(scene.displayNeedsUpdate&&(scene.toRender[0].length=0,scene.toRender[1].length=0),_this.modifyCameraBeforeRender&&(camera.renderCamera||(camera.renderCamera=camera.clone()),camera.renderCamera.copy(camera),camera=camera.renderCamera,_this.modifyCameraBeforeRender(camera)),scene.updateMatrixWorld(),camera.parent||camera.updateMatrixWorld(),projectObject(scene,camera,scene),(scene.displayNeedsUpdate||scene.opaqueSortOrder==Scene.FRONT_TO_BACK)&&function sortOpaque(array,sortOrder,camera){for(let i=array.length-1;i>-1;i--){let obj=array[i];obj.shader._gl||obj.shader.upload()}sortOrder==Scene.FRONT_TO_BACK?sortFrontToBack(array,sortOrder,camera):array.sort(((a,b)=>{if(a.renderOrder!==b.renderOrder)return a.renderOrder-b.renderOrder;let aid=a.shader._gl._id,bid=b.shader._gl._id;return aid!==bid?aid-bid:a.id-b.id}))}(scene.toRender[0],scene.opaqueSortOrder,camera),(scene.displayNeedsUpdate||scene.toRender[1].length&&!scene.disableAutoSort)&&function sortTransparent(array,sortOrder,camera){RenderStats.update("SortTransparent",array.length),sortOrder==Scene.FRONT_TO_BACK||sortOrder==Scene.FRONT_TO_BACK_BOUNDING?sortFrontToBack(array,sortOrder,camera):array.sort(((a,b)=>a.renderOrder!==b.renderOrder?a.renderOrder-b.renderOrder:a.worldPos.z!==b.worldPos.z?a.worldPos.z-b.worldPos.z:a.id-b.id))}(scene.toRender[1],scene.transparentSortOrder,camera),_this.shadows&&!_this.overridePreventShadows&&!_this.pauseShadowRendering&&scene.hasShadowLight&&function renderShadows(scene,camera){let render=(light,lightIndex)=>{RenderTarget.renderer.bind(light.shadow.rt),RenderStats.update("ShadowLights"),light.shadow.camera.updateMatrixWorld(),camera.getWorldPosition(camera.worldPos),_frustum.setFromCamera(camera),_ubo&&(light.shadow.camera._ubo?light.shadow.camera._ubo.update():initCameraUBO(light.shadow.camera));for(let l=0;l<2;l++)for(let i=0;i<scene.toRender[l].length;i++){let object=scene.toRender[l][i];object.onBeforeRenderShadow&&object.onBeforeRenderShadow(light,lightIndex)||!0===object.castShadow&&object.determineVisible()&&object.shader.visible&&!object.shader.neverRender&&(!1!==object.frustumCulled&&!0!==_frustum.intersectsObject(object)||(object.shader.shadow||Lighting.initShadowShader(object),object.shader.shadow.draw(object,object.geometry),attachShadowUniforms(object,0,light),object.geometry.draw(object,object.shader.shadow),_ubo&&light.shadow.camera._ubo.unbind(),RenderStats.update("ShadowMesh")))}RenderTarget.renderer.unbind(light.shadow.rt)},lights=Lighting.getShadowLights();scene._shadowData||(scene._shadowData={maps:[],emptyMaps:[],size:new Float32Array(lights.length),pos:new Float32Array(3*lights.length),count:lights.length}),scene._shadowData.count!=lights.length&&(scene._shadowData.size=new Float32Array(lights.length),scene._shadowData.pos=new Float32Array(3*lights.length),scene._shadowData.count=lights.length);for(let i=0;i<lights.length;i++){let light=lights[i];light.prepareRender(),scene._shadowData.maps[i]=light.shadow.rt.depth,scene._shadowData.emptyMaps[i]=Utils3D.getEmptyTexture(),scene._shadowData.size[i]=light.shadow.size,light.position.toArray(scene._shadowData.pos,3*i)}for(let i=0;i<lights.length;i++){let light=lights[i];!light.shadow.frozen&&light.determineVisible()&&render(light,i)}}(scene,camera),rt&&!rt.vrRT||!_this.vrRenderingPath||forceToScreen?rt||!_this.arRenderingPath||forceToScreen?render(scene,camera,rt):_this.arRenderingPath(render,scene,camera):_this.vrRenderingPath(scene,camera,_projScreenMatrix,_frustum,attachSceneUniforms,rt),scene.displayNeedsUpdate=!1,Shader.renderer.resetState())},this.renderSingle=function(object,camera,rt){if(_this.preventRender)return;rt?(_resolution.set(rt.width,rt.height),rt.multisample?RenderTarget.renderer.bind(rt._rtMultisample):RenderTarget.renderer.bind(rt)):(Renderer.overrideViewport||(_gl.viewport(0,0,_width*_dpr,_height*_dpr),_resolution.set(_canvas.width,_canvas.height)),_this.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))),camera.getWorldPosition(camera.worldPos),camera.getWorldQuaternion(camera.worldQuat),object.modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix),object.getWorldPosition(object.worldPos),_ubo&&(camera._ubo?camera.pauseUBO||camera._ubo.update():initCameraUBO(camera));let doubleSideTransparency=object.shader.side===Shader.DOUBLE_SIDE_TRANSPARENCY;doubleSideTransparency&&(object.shader.side=Shader.BACK_SIDE,object.shader._renderFrontFirst&&(object.shader.side=Shader.FRONT_SIDE)),object.shader.draw(object,object.geometry),object.noMatrices||(Shader.renderer.appendUniform(object.shader,"normalMatrix",object.normalMatrix),Shader.renderer.appendUniform(object.shader,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader,"modelViewMatrix",object.modelViewMatrix)),_ubo?camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader,"projectionMatrix",camera.projectionMatrix),Shader.renderer.appendUniform(object.shader,"viewMatrix",camera.matrixWorldInverse),Shader.renderer.appendUniform(object.shader,"cameraPosition",camera.worldPos),Shader.renderer.appendUniform(object.shader,"cameraQuaternion",camera.worldQuat),Shader.renderer.appendUniform(object.shader,"resolution",_resolution),Shader.renderer.appendUniform(object.shader,"time",_time.value),Shader.renderer.appendUniform(object.shader,"timeScale",Render.timeScaleUniform.value)),object.geometry.draw(object,object.shader),doubleSideTransparency&&(object.shader.side=Shader.FRONT_SIDE,object.shader._renderFrontFirst&&(object.shader.side=Shader.BACK_SIDE),object.shader.draw(object,object.geometry),object.geometry.draw(object,object.shader),object.shader.side=Shader.DOUBLE_SIDE_TRANSPARENCY),_ubo&&camera._ubo.unbind(),rt&&(rt.texture.generateMipmaps&&(_gl.bindTexture(_gl.TEXTURE_2D,rt.texture._gl),_gl.generateMipmap(_gl.TEXTURE_2D),_gl.bindTexture(_gl.TEXTURE_2D,null)),rt.multisample?(_this.blit(rt._rtMultisample,rt),RenderTarget.renderer.unbind(rt._rtMultisample)):RenderTarget.renderer.unbind(rt)),Shader.renderer.resetState()},this.setClearColor=function(color,alpha=1){_clearColor=new Color(color),Renderer.CLEAR=[_clearColor.r,_clearColor.g,_clearColor.b,alpha]},this.setClearAlpha=function(alpha){Renderer.CLEAR[3]=alpha},this.getClearColor=function(){return _clearColor||(_clearColor=new Color(0,0,0)),_clearColor},this.getClearAlpha=function(){return Renderer.CLEAR[3]},this.setPixelRatio=function(dpr){_dpr=dpr,this.setSize(_width,_height)},this.setSize=function(width,height){_width=width,_height=height,_canvas.width=width*_dpr,_canvas.height=height*_dpr,_canvas.style.width=`${width}px`,_canvas.style.height=`${height}px`,_resolution.set(_canvas.width,_canvas.height)},this.getMaxAnisotropy=function(){return Device.graphics.webgl&&_this.extensions.anisotropy?(_anisotropy||(_anisotropy=_gl.getParameter(_this.extensions.anisotropy.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),_anisotropy):0},this.readPixels=function(rt,x=0,y=0,width,height,array,type=_gl.UNSIGNED_BYTE){width||(width=rt?rt.width:1),height||(height=rt?rt.height:1),width=Math.round(width),height=Math.round(height),type=type||_gl.UNSIGNED_BYTE;let w=Math.round(width-x),h=Math.round(height-y);return array||(array=new Uint8Array(w*h*4)),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt?rt._gl:null),_gl.readPixels(x,y,width,height,_gl.RGBA,type,array),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),array},this.blit=function(input,output,mask=_gl.COLOR_BUFFER_BIT){if(_this.type!=Renderer.WEBGL2)return!1;if(input._gl||input.upload(),output._gl||output.upload(),_gl.bindFramebuffer(_gl.READ_FRAMEBUFFER,input._gl),_gl.bindFramebuffer(_gl.DRAW_FRAMEBUFFER,output._gl),input===output._rtMultisample&&(output.depth&&(mask|=_gl.DEPTH_BUFFER_BIT),output.stencil&&(mask|=_gl.STENCIL_BUFFER_BIT)),_gl.blitFramebuffer(0,0,input.width,input.height,0,0,output.width,output.height,mask,_gl.NEAREST),input===output._rtMultisample&&output.multi){let attachments=output.attachments;for(let i=1;i<attachments.length;i++){let texture=attachments[i];_gl.readBuffer(_gl[`COLOR_ATTACHMENT${i}`]),_gl.bindFramebuffer(_gl.DRAW_FRAMEBUFFER,texture._blitFramebuffer),_gl.blitFramebuffer(0,0,input.width,input.height,0,0,output.width,output.height,_gl.COLOR_BUFFER_BIT,_gl.NEAREST)}_gl.readBuffer(_gl.COLOR_ATTACHMENT0)}return _gl.bindFramebuffer(_gl.READ_FRAMEBUFFER,null),_gl.bindFramebuffer(_gl.DRAW_FRAMEBUFFER,null),!0},this.setupStencilMask=function(ref=1){_stencilActive||(_gl.enable(_gl.STENCIL_TEST),_gl.clear(_gl.STENCIL_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT)),_stencilActive=!0,_gl.stencilFunc(_gl.ALWAYS,ref,255),_gl.stencilOp(_gl.KEEP,_gl.KEEP,_gl.REPLACE),_gl.stencilMask(255),_gl.colorMask(!1,!1,!1,!1),_gl.disable(_gl.DEPTH_TEST)},this.setupStencilDraw=function(mode,ref=1){_gl.colorMask(!0,!0,!0,!0),_gl.enable(_gl.DEPTH_TEST),_gl.stencilFunc("inside"==mode?_gl.EQUAL:_gl.NOTEQUAL,ref,255),_gl.stencilOp(_gl.KEEP,_gl.KEEP,_gl.KEEP)},this.clearStencil=function(){_gl.disable(_gl.STENCIL_TEST),_stencilActive=!1},this.clearDepth=function(rt){rt&&!rt._gl&&rt.upload(),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),_gl.clear(_gl.DEPTH_BUFFER_BIT),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},this.clearColor=function(rt){rt&&!rt._gl&&rt.upload(),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT),rt&&_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},this.get("resolution",(_=>_resolution)),this.get("time",(_=>_time)),this.get("canvas",(_=>_canvas))}),(_=>{Renderer.WEBGL1="webgl1",Renderer.WEBGL2="webgl2",Renderer.STATIC_SHADOWS="static_shadows",Renderer.SHADOWS_LOW="shadows_low",Renderer.SHADOWS_MED="shadows_med",Renderer.SHADOWS_HIGH="shadows_high",Renderer.ID=0}));class CameraBase3D extends Base3D{constructor(){super(),this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4,this.isCamera=!0}copy(source,recursive){return Base3D.prototype.copy.call(this,source,recursive),this.matrixWorldInverse.copy(source.matrixWorldInverse),this.projectionMatrix.copy(source.projectionMatrix),this}updateMatrixWorld(force){Base3D.prototype.updateMatrixWorld.call(this,force),this.offsetMatrixWorld&&this.matrixWorld.multiply(this.offsetMatrixWorld),this.matrixWorldInverse.getInverse(this.matrixWorld)}clone(){return(new this.constructor).copy(this)}}class CubeCamera extends Base3D{constructor(near=.1,far=1e3,cubeResolution=512){super();this.px=new PerspectiveCamera(90,1,near,far),this.px.up.set(0,-1,0),this.px.lookAt(new Vector3(1,0,0)),this.add(this.px),this.nx=new PerspectiveCamera(90,1,near,far),this.nx.up.set(0,-1,0),this.nx.lookAt(new Vector3(-1,0,0)),this.add(this.nx),this.py=new PerspectiveCamera(90,1,near,far),this.py.up.set(0,0,1),this.py.lookAt(new Vector3(0,1,0)),this.add(this.py),this.ny=new PerspectiveCamera(90,1,near,far),this.ny.up.set(0,0,-1),this.ny.lookAt(new Vector3(0,-1,0)),this.add(this.ny),this.pz=new PerspectiveCamera(90,1,near,far),this.pz.up.set(0,-1,0),this.pz.lookAt(new Vector3(0,0,1)),this.add(this.pz),this.nz=new PerspectiveCamera(90,1,near,far),this.nz.up.set(0,-1,0),this.nz.lookAt(new Vector3(0,0,-1)),this.add(this.nz),this.rt=new CubeRenderTarget(cubeResolution,cubeResolution)}render(scene=World.SCENE,renderer=World.RENDERER){let rt=this.rt;this.updateMatrixWorld(!0),this.beforeRender&&this.beforeRender(this.px),rt.activeFace=0,renderer.render(scene,this.px,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.nx),rt.activeFace=1,renderer.render(scene,this.nx,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.py),rt.activeFace=2,renderer.render(scene,this.py,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.ny),rt.activeFace=3,renderer.render(scene,this.ny,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.pz),rt.activeFace=4,renderer.render(scene,this.pz,rt),this.afterRender&&this.afterRender(rt),this.beforeRender&&this.beforeRender(this.nz),rt.activeFace=5,renderer.render(scene,this.nz,rt),this.afterRender&&this.afterRender(rt)}}class OrthographicCamera extends CameraBase3D{constructor(left,right,top,bottom,near,far){super(),this.isOrthographicCamera=!0,this.zoom=1,this.left=left,this.right=right,this.top=top,this.bottom=bottom,this.near=void 0!==near?near:.1,this.far=void 0!==far?far:2e3,this.position.z=1,this.updateProjectionMatrix()}clone(){return(new OrthographicCamera).copy(this)}copy(source,recursive){return CameraBase3D.prototype.copy.call(this,source,recursive),this.left=source.left,this.right=source.right,this.top=source.top,this.bottom=source.bottom,this.near=source.near,this.far=source.far,this.zoom=source.zoom,this.view=null===source.view?null:Object.assign({},source.view),this}updateProjectionMatrix(){let dx=(this.right-this.left)/(2*this.zoom),dy=(this.top-this.bottom)/(2*this.zoom),cx=(this.right+this.left)/2,cy=(this.top+this.bottom)/2,left=cx-dx,right=cx+dx,top=cy+dy,bottom=cy-dy;this.projectionMatrix.makeOrthographic(left,right,top,bottom,this.near,this.far)}setViewport(width,height){this.left=width/-2,this.right=width/2,this.top=height/2,this.bottom=height/-2,this.updateProjectionMatrix()}}class PerspectiveCamera extends CameraBase3D{constructor(fov,aspect,near,far){super(),this.type="PerspectiveCamera",this.fov=fov||50,this.zoom=1,this.near=near||.1,this.far=far||2e3,this.focus=10,this.aspect=aspect||1,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}clone(){return(new PerspectiveCamera).copy(this)}copy(source,recursive){return CameraBase3D.prototype.copy.call(this,source,recursive),this.fov=source.fov,this.zoom=source.zoom,this.near=source.near,this.far=source.far,this.focus=source.focus,this.aspect=source.aspect,this.filmGauge=source.filmGauge,this.filmOffset=source.filmOffset,this}setFocalLength(focalLength){let vExtentSlope=.5*this.getFilmHeight()/focalLength;this.fov=Math.degrees(2*Math.atan(vExtentSlope)),this.updateProjectionMatrix()}getFocalLength(){let vExtentSlope=Math.tan(Math.radians(.5*this.fov));return.5*this.getFilmHeight()/vExtentSlope}getEffectiveFOV(){return Math.degrees(2*Math.atan(Math.tan(Math.radians(.5*this.fov))/this.zoom))}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}updateProjectionMatrix(){let near=this.near,top=near*Math.tan(Math.radians(.5*this.fov))/this.zoom,height=2*top,width=this.aspect*height,left=-.5*width,skew=(this.view,this.filmOffset);0!==skew&&(left+=near*skew/this.getFilmWidth()),this.projectionMatrix.makePerspective(left,left+width,top,top-height,near,this.far)}}class Geometry{constructor(){this.attributes=Geometry.createAttributes(this),this.drawRange={start:0,end:0},this.boundingBox=null,this.boundingSphere=null,this.index=null,this.maxInstancedCount=void 0,this.keepAlive=!1,this.id=Utils.timestamp()}draw(mesh,shader,isQuery=!1){Geometry.renderer.draw(this,mesh,shader,isQuery)}upload(mesh,shader){Geometry.renderer.upload(this,mesh,shader)}destroy(mesh){this.keepAlive||Geometry.renderer.destroy(this,mesh)}addAttribute(name,attribute){attribute.meshPerAttribute>=1&&(this.isInstanced=!0,this.maxInstancedCount=attribute.count),this.attributes[name]=attribute}setIndex(attribute){this.index=attribute.array||attribute}toNonIndexed(){let geometry2=new Geometry,indices=this.index,attributes=this.attributes;for(let name in attributes){let attribute=attributes[name],array=attribute.array,itemSize=attribute.itemSize,array2=new array.constructor(indices.length*itemSize),index=0,index2=0;for(let i=0,l=indices.length;i<l;i++){index=indices[i]*itemSize;for(let j=0;j<itemSize;j++)array2[index2++]=array[index++]}geometry2.addAttribute(name,new GeometryAttribute(array2,itemSize))}return geometry2}normalizeNormals(){let vector=this._V1||new Vector3;this._V1=vector;let x,y,z,normals=this.attributes.normal;for(let i=0,il=normals.count;i<il;i++)x=3*i+0,y=3*i+1,z=3*i+2,vector.x=normals.array[x],vector.y=normals.array[y],vector.z=normals.array[z],vector.normalize(),normals.array[x]=vector.x,normals.array[y]=vector.y,normals.array[z]=vector.z}computeFaceNormals(){let cb=new Vector3,ab=new Vector3;for(let f=0,fl=this.faces.length;f<fl;f++){let face=this.faces[f],vA=this.vertices[face.a],vB=this.vertices[face.b],vC=this.vertices[face.c];cb.subVectors(vC,vB),ab.subVectors(vA,vB),cb.cross(ab),cb.normalize(),face.normal.copy(cb)}}computeVertexNormals(){let index=this.index,attributes=this.attributes,groups=this.groups||[];if(attributes.position){let positions=attributes.position.array;if(void 0===attributes.normal)this.addAttribute("normal",new GeometryAttribute(new Float32Array(positions.length),3));else{let array=attributes.normal.array;for(let i=0,il=array.length;i<il;i++)array[i]=0}let vA,vB,vC,normals=attributes.normal.array,pA=new Vector3,pB=new Vector3,pC=new Vector3,cb=new Vector3,ab=new Vector3;if(index){let indices=index.array;0===groups.length&&this.addGroup(0,indices.length);for(let j=0,jl=groups.length;j<jl;++j){let group=groups[j],start=group.start;for(let i=start,il=start+group.count;i<il;i+=3)vA=3*indices[i+0],vB=3*indices[i+1],vC=3*indices[i+2],pA.fromArray(positions,vA),pB.fromArray(positions,vB),pC.fromArray(positions,vC),cb.subVectors(pC,pB),ab.subVectors(pA,pB),cb.cross(ab),normals[vA]+=cb.x,normals[vA+1]+=cb.y,normals[vA+2]+=cb.z,normals[vB]+=cb.x,normals[vB+1]+=cb.y,normals[vB+2]+=cb.z,normals[vC]+=cb.x,normals[vC+1]+=cb.y,normals[vC+2]+=cb.z}}else for(let i=0,il=positions.length;i<il;i+=9)pA.fromArray(positions,i),pB.fromArray(positions,i+3),pC.fromArray(positions,i+6),cb.subVectors(pC,pB),ab.subVectors(pA,pB),cb.cross(ab),normals[i]=cb.x,normals[i+1]=cb.y,normals[i+2]=cb.z,normals[i+3]=cb.x,normals[i+4]=cb.y,normals[i+5]=cb.z,normals[i+6]=cb.x,normals[i+7]=cb.y,normals[i+8]=cb.z;this.normalizeNormals(),attributes.normal.needsUpdate=!0}}computeBoundingBox(){this.boundingBox||(this.boundingBox=new Box3);let position=this.attributes.position;position?this.boundingBox.setFromBufferAttribute(position):this.boundingBox.makeEmpty()}computeBoundingSphere(){let box=new Box3,vector=new Vector3;this.boundingSphere||(this.boundingSphere=new Sphere);let position=this.attributes.position;if(position){let center=this.boundingSphere.center;box.setFromBufferAttribute(position),box.getCenter(center);let maxRadiusSq=0;for(let i=0,il=position.count;i<il;i++)vector.x=position.array[3*i+0],vector.y=position.array[3*i+1],vector.z=position.array[3*i+2],maxRadiusSq=Math.max(maxRadiusSq,center.distanceToSquared(vector));this.boundingSphere.radius=Math.sqrt(maxRadiusSq),isNaN(this.boundingSphere.radius)&&console.error("Bounding Sphere came up NaN, broken position buffer.",this)}}merge(geometry){let Float32ArrayConcat=(first,second)=>{let firstLength=first.length,result=new Float32Array(firstLength+second.length);return result.set(first),result.set(second,firstLength),result},attributes=this.attributes;if(this.index){let indices=geometry.index,offset=attributes.position.count;for(let i=0,il=indices.length;i<il;i++)indices[i]=offset+indices[i];this.index=((first,second)=>{let firstLength=first.length,result=new(Geometry.arrayNeedsUint32(second)?Uint32Array:Uint16Array)(firstLength+second.length);return result.set(first),result.set(second,firstLength),result})(this.index,indices)}for(let key in attributes)void 0!==geometry.attributes[key]&&(attributes[key].array=Float32ArrayConcat(attributes[key].array,geometry.attributes[key].array),attributes[key].count=attributes[key].array.length/attributes[key].itemSize);return this}clone(noCopy){return(new Geometry).copy(this,noCopy)}copy(source,noCopy){this.index=null,this.boundingBox=null,this.boundingSphere=null,this.index=source.index;let attributes=source.attributes;for(let name in attributes)this.addAttribute(name,attributes[name].clone(noCopy));let boundingBox=source.boundingBox;boundingBox&&boundingBox.clone&&(this.boundingBox=boundingBox.clone());let boundingSphere=source.boundingSphere;return boundingSphere&&boundingSphere.clone&&(this.boundingSphere=boundingSphere.clone()),this}center(){let offset=new Vector3;return this.computeBoundingBox(),this.boundingBox.getCenter(offset).negate(),this.applyMatrix((new Matrix4).makeTranslation(offset.x,offset.y,offset.z)),this}applyMatrix(matrix){let position=this.attributes.position;position&&(matrix.applyToBufferAttribute(position),position.needsUpdate=!0);let normal=this.attributes.normal;if(normal){(new Matrix3).getNormalMatrix(matrix).applyToBufferAttribute(normal),normal.needsUpdate=!0}return this.boundingBox&&this.computeBoundingBox(),this.boundingSphere&&this.computeBoundingSphere(),this}scale(x,y,z){this.applyMatrix((new Matrix4).makeScale(x,y,z))}setFromPoints(points){let position=[];for(let i=0,l=points.length;i<l;i++){let point=points[i];position.push(point.x,point.y,point.z||0)}return this.addAttribute("position",new GeometryAttribute(new Float32Array(position),3)),this}instanceFrom(geom){return geom.clone()}uploadBuffersAsync(){return Geometry.renderer.uploadBuffersAsync(this)}toJSON(){let props={};this.index&&(props.index=Array.from(this.index));for(let key in this.attributes)props[key]=Array.from(this.attributes[key].array);return JSON.stringify(props)}}class GeometryAttribute{constructor(_array,_itemSize,_meshPerAttribute,_dynamic=!1){this.array=_array,this.itemSize=_itemSize,this.count=void 0!==_array?_array.length/_itemSize:0,this.dynamic=_dynamic,this.updateRange={offset:0,count:-1},this.meshPerAttribute=_meshPerAttribute}setArray(array){let newCount=void 0!==array?array.length/this.itemSize:0;newCount!=this.count&&(this.needsNewBuffer=!0),this.array=array,this.count=newCount,this.needsUpdate=!0}clone(noCopy){return noCopy?this:new GeometryAttribute(new Float32Array(this.array),this.itemSize,this.meshPerAttribute)}getX(index){return this.array[index*this.itemSize]}setX(index,x){return this.array[index*this.itemSize]=x,this}getY(index){return this.array[index*this.itemSize+1]}setY(index,y){return this.array[index*this.itemSize+1]=y,this}getZ(index){return this.array[index*this.itemSize+2]}setZ(index,z){return this.array[index*this.itemSize+2]=z,this}getW(index){return this.array[index*this.itemSize+3]}setW(index,w){return this.array[index*this.itemSize+3]=w,this}setXY(index,x,y){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this}setXYZ(index,x,y,z){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this.array[index+2]=z,this}setXYZW(index,x,y,z,w){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this.array[index+2]=z,this.array[index+3]=w,this}}class InterleavedBuffer{constructor(array,stride){this.array=array,this.stride=stride,this.count=array?array.length/stride:0,this.isInterleaved=!0,this.needsUpdate=!1,this.dynamic=!1,this.updateRange={offset:0,count:-1}}}class InterleavedGeometryAttribute{constructor(interleavedBuffer,itemSize,offset){this.data=interleavedBuffer,this.itemSize=itemSize,this.offset=offset,this.isInterleaved=!0}}class Group extends Base3D{constructor(){super(),this.isGroup=!0,this._occlusionMesh=null}generateOcclusionMesh(){this._bbVertices=[];for(let i=0;i<8;i++)this._bbVertices.push(new Vector3);if(!this.occlusionCulled){this.occlusionCulled=!0;let occShader=new Shader("OcclusionMaterial",{bbMin:{value:new Vector3(0,0,0)},bbMax:{value:new Vector3(1,1,1)}});occShader.wireframe=!0;let _occlusionMesh=new Mesh(World.BOX,occShader);_occlusionMesh.occlusionCulled=!0,_occlusionMesh._occlusionGroup=this,_occlusionMesh.renderOrder=-1e3,_occlusionMesh.hideByOcclusion=!0,_occlusionMesh._occlusionMesh.renderOrder=1e3,this.add(_occlusionMesh),this._occlusionMesh=_occlusionMesh,this.bb=new Box3}}updateOcclusionBoundingBox(){this.bb.makeEmpty();const _this=this;_this.children.forEach((child=>{if(void 0===child._occlusionGroup){child.updateOcclusionMesh();let bb=child._geometry.boundingBox,m=bb.min,M=bb.max;_this._bbVertices[0].set(m.x,m.y,m.z),_this._bbVertices[1].set(m.x,m.y,M.z),_this._bbVertices[2].set(m.x,M.y,m.z),_this._bbVertices[3].set(M.x,m.y,m.z),_this._bbVertices[4].set(M.x,M.y,m.z),_this._bbVertices[5].set(M.x,m.y,M.z),_this._bbVertices[6].set(m.x,M.y,M.z),_this._bbVertices[7].set(M.x,M.y,M.z),_this._bbVertices.forEach((vertex=>{vertex.applyMatrix4(child.matrix),_this.bb.min.x=Math.min(_this.bb.min.x,vertex.x),_this.bb.min.y=Math.min(_this.bb.min.y,vertex.y),_this.bb.min.z=Math.min(_this.bb.min.z,vertex.z),_this.bb.max.x=Math.max(_this.bb.max.x,vertex.x),_this.bb.max.y=Math.max(_this.bb.max.y,vertex.y),_this.bb.max.z=Math.max(_this.bb.max.z,vertex.z)}))}})),this._occlusionMesh?.shader?.set("bbMin",this.bb.min),this._occlusionMesh?.shader?.set("bbMax",this.bb.max),this._occlusionMesh?._occlusionMesh?.shader?.set("bbMin",this.bb.min.add(new Vector3(-.01,-.01,-.01))),this._occlusionMesh?._occlusionMesh?.shader?.set("bbMax",this.bb.max.add(new Vector3(.01,.01,.01))),this._occlusionMesh.position.copy(this.bb.max.clone().add(this.bb.min).multiplyScalar(.5))}updateOcclusionVisibility(doHide){this.children.forEach((child=>{void 0===child._occlusionGroup&&(child.hideByOcclusion=doHide)}))}}class BaseLight extends Base3D{constructor(color=16777215,intensity=1,distance=9999){super(),this.color=new Color(color),this.data=new Vector4,this.data2=new Vector4,this.data3=new Vector4,this.properties=new Vector4(intensity,distance,0,0)}destroy(){this.shadow&&(Lighting.removeFromShadowGroup(this),this.shadow.destroy())}prepareRender(){this.shadow.camera.position.copy(this.position),this.shadow.camera.lookAt(this.shadow.target)}set castShadow(bool){(this.shadow||bool)&&(this.shadow||(this.shadow=new Shadow(this)),this.shadow.enabled=bool,this.silentShadow||(bool?Lighting.addToShadowGroup(this):Lighting.removeFromShadowGroup(this)))}set intensity(v){this.properties.x=v}get intensity(){return this.properties.x}set distance(v){this.properties.y=v}get distance(){return this.properties.y}set bounce(v){this.properties.z=v}get bounce(){return this.properties.z}}class Line extends Base3D{constructor(geometry,shader){super(),this.geometry=geometry,this.shader=shader,this.isLine=!0,this.id=Renderer.ID++}clone(){return new Line(this.geometry,this.shader).copy(this)}}class Mesh extends Base3D{constructor(geometry,shader,isQuery=!1){super(),shader||window.THREAD||(shader=new Shader("TestMaterial")),this._geometry=geometry,this._shader=shader&&shader.shader?shader.shader:shader,this.isMesh=!0;if(this.occlusionMesh=null,!isQuery&&!window.THREAD&&Renderer.useOcclusionQuery){let occShader=new Shader("OcclusionMaterial",{bbMin:{value:new Vector3},bbMax:{value:new Vector3}});occShader.side=Shader.DOUBLE_SIDE;let _occlusionMesh=new Mesh(World.BOX,occShader,!0);_occlusionMesh.occlusionCulled=!1,_occlusionMesh.doNotProject=!0,_occlusionMesh._queryMesh=this,_occlusionMesh.isOcclusionMesh=!0,this.add(_occlusionMesh),this._occlusionMesh=_occlusionMesh,this._occlusionDirty=!0}this.id=Utils.timestamp(),shader&&(this._shader.mesh=this)}clone(){return new Mesh(this._geometry,this.shader).copy(this)}set geometry(g){Geometry.renderer.resetMeshGeom(this),this._geometry=g}get geometry(){return this._geometry}set shader(shader){this._shader=shader&&shader.shader?shader.shader:shader}get shader(){return this._shader}isInsideOf(mesh){return this.box3||(this.box3=new Box3),this.box3.setFromObject(this),mesh.isMeshInside(this)}isMeshInside(mesh){return this.box3||(this.box3=new Box3),this.box3.setFromObject(this),mesh.box3.intersectsBox(this.box3)}updateOcclusionMesh(force){if(this.occlusionCulled&&!Renderer.useOcclusionQuery&&(this._occlusionDirty||force)){this._geometry.computeBoundingBox();let bb=this._geometry.boundingBox;this._occlusionMesh?.shader?.set("bbMin",bb.min.add(new Vector3(-.01,-.01,-.01))),this._occlusionMesh?.shader?.set("bbMax",bb.max.add(new Vector3(.01,.01,.01))),this._occlusionMesh.renderOrder=this.renderOrder+1e3,this._occlusionDirty=!1}}}class Points extends Base3D{constructor(geometry,shader){super(),this._geometry=geometry,this.shader=shader,this.isPoints=!0,this.id=Renderer.ID++,shader&&(this.shader.mesh=this)}clone(){return new Points(this._geometry,this.shader).copy(this)}set geometry(g){Geometry.renderer.resetMeshGeom(this),this._geometry=g}get geometry(){return this._geometry}}class Scene extends Base3D{constructor(){super(),this.autoUpdate=!0,this.toRender=[[],[]],this._displayNeedsUpdate=!0,this.isScene=!0,this.changes=[]}set displayNeedsUpdate(v){!0===v&&this.changes.forEach((cb=>cb())),this._displayNeedsUpdate=v}get displayNeedsUpdate(){return this._displayNeedsUpdate}bindSceneChange(cb){this.changes.push(cb)}}Class((function FBORendererWebGL(_gl){const WEBGL2=Renderer.type==Renderer.WEBGL2;let _maxSamples=WEBGL2&&_gl.getParameter(_gl.MAX_SAMPLES);const{getFormat:getFormat,getInternalFormat:getInternalFormat,getProperty:getProperty,getType:getType,getFloatParams:getFloatParams}=require("GLTypes");function prepareTexture(texture){texture._gl=_gl.createTexture(),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),texture.needsUpdate=!1}function texImageDB(rt,texture){if(texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),getType(texture),null);_gl.bindTexture(_gl.TEXTURE_2D,null)}function getRenderBufferInternalFormat(texture){return texture.type.includes("float")?getFloatParams(texture).internalformat:getInternalFormat(texture)}this.upload=function(rt){if(!rt._gl){if(rt.cube)return function uploadCube(rt){rt._gl=_gl.createFramebuffer(),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl);let texture=rt.texture;texture._gl=_gl.createTexture(),texture.cube=!0,texture.needsUpdate=!1,_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl);for(let i=0;i<6;i++)_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),_gl.UNSIGNED_BYTE,null);_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),rt._depthBuffer=_gl.createRenderbuffer(),_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,rt.width,rt.height),_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,rt._depthBuffer),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}(rt);if(rt.texture.isTexture3D)return function upload3DTexture(rt){rt.texture.upload();let colorAttachments=[];rt._gl=_gl.createFramebuffer(),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl);for(let i=0;i<rt.indices.length;i++){let key="COLOR_ATTACHMENT"+i;colorAttachments.push(_gl[key]),_gl.framebufferTextureLayer(_gl.FRAMEBUFFER,_gl[key],rt.texture._gl,0,rt.indices[i])}_gl.drawBuffers(colorAttachments),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)}(rt);if(rt._gl=_gl.createFramebuffer(),!rt.depth&&!rt.disableDepth)if(rt._depthBuffer=_gl.createRenderbuffer(),_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),rt.internalMultisample){let samples=Math.min(_maxSamples,rt._samplesAmount);_gl.renderbufferStorageMultisample(_gl.RENDERBUFFER,samples,rt.stencil?_gl.DEPTH24_STENCIL8:_gl.DEPTH_COMPONENT24,rt.width,rt.height)}else _gl.renderbufferStorage(_gl.RENDERBUFFER,rt.stencil?WEBGL2?_gl.DEPTH24_STENCIL8:_gl.DEPTH_STENCIL:WEBGL2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT16,rt.width,rt.height);if(RenderCount.add(`fbo_${Math.round(rt.width)}x${Math.round(rt.height)}`,rt),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.multi)if(WEBGL2){let colorAttachments=[];for(let i=0;i<rt.attachments.length;i++){let key="COLOR_ATTACHMENT"+i,texture=rt.attachments[i];colorAttachments.push(_gl[key]),prepareTexture(texture),texImageDB(rt,texture),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl[key],_gl.TEXTURE_2D,texture._gl,0),rt.multisample&&i>0&&(texture._blitFramebuffer=_gl.createFramebuffer(),_gl.bindFramebuffer(_gl.FRAMEBUFFER,texture._blitFramebuffer),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.TEXTURE_2D,texture._gl,0))}_gl.drawBuffers(colorAttachments)}else{let ext=Renderer.extensions.drawBuffers,colorAttachments=[];for(let i=0;i<rt.attachments.length;i++){let key="COLOR_ATTACHMENT"+i+"_WEBGL",texture=rt.attachments[i];colorAttachments.push(ext[key]),prepareTexture(texture),texImageDB(rt,texture),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,ext[key],_gl.TEXTURE_2D,texture._gl,0)}ext.drawBuffersWEBGL(colorAttachments)}else if(rt.internalMultisample){let samples=Math.min(_maxSamples,rt._samplesAmount);if(rt.parent.multi){let colorAttachments=[],attachments=rt.parent.attachments;for(let i=0;i<attachments.length;i++){let key="COLOR_ATTACHMENT"+i,texture=attachments[i];colorAttachments.push(_gl[key]),texture._colorBuffer=_gl.createRenderbuffer(),_gl.bindRenderbuffer(_gl.RENDERBUFFER,texture._colorBuffer),_gl.renderbufferStorageMultisample(_gl.RENDERBUFFER,samples,getRenderBufferInternalFormat(texture),rt.width,rt.height),_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl[key],_gl.RENDERBUFFER,texture._colorBuffer),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}_gl.drawBuffers(colorAttachments)}else rt._colorBuffer=_gl.createRenderbuffer(),_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._colorBuffer),_gl.renderbufferStorageMultisample(_gl.RENDERBUFFER,samples,getRenderBufferInternalFormat(rt.texture),rt.width,rt.height),_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.RENDERBUFFER,rt._colorBuffer)}else{if(prepareTexture(rt.texture),rt.texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(rt.texture),rt.width,rt.height,0,getFormat(rt.texture),getType(rt.texture),null);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.TEXTURE_2D,rt.texture._gl,0)}if(rt.depth){prepareTexture(rt.depth);let iformat=rt.stencil?WEBGL2?_gl.DEPTH24_STENCIL8:_gl.DEPTH_STENCIL:WEBGL2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT,type=rt.stencil?WEBGL2?_gl.UNSIGNED_INT_24_8:Renderer.extensions.depthTextures.UNSIGNED_INT_24_8_WEBGL:_gl.UNSIGNED_INT;_gl.texImage2D(_gl.TEXTURE_2D,0,iformat,rt.width,rt.height,0,rt.stencil?_gl.DEPTH_STENCIL:_gl.DEPTH_COMPONENT,type,null),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,rt.stencil?_gl.DEPTH_STENCIL_ATTACHMENT:_gl.DEPTH_ATTACHMENT,_gl.TEXTURE_2D,rt.depth._gl,0)}else rt.disableDepth||(rt.internalMultisample,_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,rt.stencil?_gl.DEPTH_STENCIL_ATTACHMENT:_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,rt._depthBuffer));_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}},this.bind=function(rt){rt._gl||this.upload(rt),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.cube&&_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.TEXTURE_CUBE_MAP_POSITIVE_X+rt.activeFace,rt.texture._gl,0),rt.scissor&&(_gl.enable(_gl.SCISSOR_TEST),_gl.scissor(rt.scissor.x,rt.scissor.y,rt.scissor.width,rt.scissor.height)),_gl.viewport(rt.viewport.x,rt.viewport.y,rt.width,rt.height),rt.customViewport&&_gl.viewport(rt.customViewport.x,rt.customViewport.y,rt.customViewport.z,rt.customViewport.w),Renderer.instance.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),rt.sharedRenderbuffer?rt.clearDepth?_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT):_gl.clear(_gl.COLOR_BUFFER_BIT):_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT|_gl.STENCIL_BUFFER_BIT))},this.unbind=function(rt){rt.scissor&&_gl.disable(_gl.SCISSOR_TEST),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},this.resize=function(rt){if(rt.texture._gl&&rt._gl){if(_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.multi)for(let i=0;i<rt.attachments.length;i++){let texture=rt.attachments[i];if(_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),getType(texture),null)}else if(rt.internalMultisample){let samples=Math.min(_maxSamples,rt._samplesAmount);if(rt.parent.multi){let attachments=rt.parent.attachments;for(let i=0;i<attachments.length;i++){let texture=attachments[i];_gl.bindRenderbuffer(_gl.RENDERBUFFER,texture._colorBuffer),_gl.renderbufferStorageMultisample(_gl.RENDERBUFFER,samples,getRenderBufferInternalFormat(texture),rt.width,rt.height),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}}else _gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._colorBuffer),_gl.renderbufferStorageMultisample(_gl.RENDERBUFFER,samples,getRenderBufferInternalFormat(rt.texture),rt.width,rt.height),_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.RENDERBUFFER,rt._colorBuffer)}else if(_gl.bindTexture(_gl.TEXTURE_2D,rt.texture._gl),rt.texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(rt.texture),rt.width,rt.height,0,getFormat(rt.texture),getType(rt.texture),null);if(rt.depth){_gl.bindTexture(_gl.TEXTURE_2D,rt.depth._gl);let iformat=rt.stencil?WEBGL2?_gl.DEPTH24_STENCIL8:_gl.DEPTH_STENCIL:WEBGL2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT,type=rt.stencil?WEBGL2?_gl.UNSIGNED_INT_24_8:Renderer.extensions.depthTextures.UNSIGNED_INT_24_8_WEBGL:_gl.UNSIGNED_INT;_gl.texImage2D(_gl.TEXTURE_2D,0,iformat,rt.width,rt.height,0,rt.stencil?_gl.DEPTH_STENCIL:_gl.DEPTH_COMPONENT,type,null),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,rt.stencil?_gl.DEPTH_STENCIL_ATTACHMENT:_gl.DEPTH_ATTACHMENT,_gl.TEXTURE_2D,rt.depth._gl,0)}else if(!rt.disableDepth)if(_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),rt.internalMultisample){let samples=Math.min(_maxSamples,rt._samplesAmount);_gl.renderbufferStorageMultisample(_gl.RENDERBUFFER,samples,rt.stencil?_gl.DEPTH24_STENCIL8:_gl.DEPTH_COMPONENT24,rt.width,rt.height)}else _gl.renderbufferStorage(_gl.RENDERBUFFER,rt.stencil?WEBGL2?_gl.DEPTH24_STENCIL8:_gl.DEPTH_STENCIL:WEBGL2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT16,rt.width,rt.height);_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}},this.destroy=function(rt){_gl.deleteFramebuffer(rt._gl),rt._depthBuffer&&_gl.deleteRenderbuffer(rt._depthBuffer),Texture.renderer.destroy(rt.texture),RenderCount.remove(`fbo_${Math.round(rt.width)}x${Math.round(rt.height)}`),rt.multi&&rt.attachments.forEach((t=>{t._colorBuffer&&_gl.deleteRenderbuffer(t._colorBuffer),t._blitFramebuffer&&_gl.deleteFramebuffer(t._blitFramebuffer),Texture.renderer.destroy(t)})),rt._gl=null}})),Class((function GeometryRendererWebGL(_gl){var _cache={},_isDebbugingShader=Utils.query("displayShaderError");const WEBGL2=Renderer.type==Renderer.WEBGL2,{getGLTypeForTypedArray:getGLTypeForTypedArray}=require("GLTypes");function updateBuffer(attrib){if(!attrib._gl)return;attrib.needsUpdate=!1,_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),RenderStats.update("BufferUpdates");let array=attrib.array,updateRange=attrib.updateRange;if(-1===updateRange.count)attrib.needsNewBuffer?(_gl.bufferData(_gl.ARRAY_BUFFER,attrib.array,_gl.DYNAMIC_DRAW),attrib.needsNewBuffer=!1):_gl.bufferSubData(_gl.ARRAY_BUFFER,0,array);else if(Array.isArray(updateRange)){for(let i=updateRange.length-1;i>-1;i--){let{offset:offset,count:count}=updateRange[i];_gl.bufferSubData(_gl.ARRAY_BUFFER,offset*array.BYTES_PER_ELEMENT,array.subarray(offset,offset+count))}updateRange.length=0}else _gl.bufferSubData(_gl.ARRAY_BUFFER,updateRange.offset*array.BYTES_PER_ELEMENT,array.subarray(updateRange.offset,updateRange.offset+updateRange.count));_gl.bindBuffer(_gl.ARRAY_BUFFER,null)}function renderingCount(count,mode,instanceCount=1){if(RenderStats.active)switch(mode){case _gl.TRIANGLES:RenderStats.update("Triangles",instanceCount*(count/3));break;case _gl.LINES:RenderStats.update("Lines",instanceCount*(count/2));break;case _gl.LINE_STRIP:RenderStats.update("LineStrip",instanceCount*(count-1));break;case _gl.LINE_LOOP:RenderStats.update("LineLoop",instanceCount*count);break;case _gl.POINTS:RenderStats.update("Points",instanceCount*count)}}this.draw=function(geom,mesh,shader,isQuery){geom._gl&&!geom.needsUpdate&&mesh._gl&&mesh._gl.geomInit||this.upload(geom,mesh,shader),RenderStats.active&&RenderStats.update("DrawCalls",1,shader.vsName+"|"+shader.fsName,mesh);for(let i=geom._attributeKeys.length-1;i>-1;i--){let key=geom._attributeKeys[i],attrib=geom._attributeValues[i];mesh._gl.program==shader._gl.program&&void 0!==mesh._gl[key]||(mesh._gl[key]=_gl.getAttribLocation(shader._gl.program,key)),-1!==mesh._gl[key]&&(attrib.isInterleaved&&attrib.data.needsUpdate?updateBuffer(attrib.data):(attrib.needsUpdate||attrib.dynamic)&&updateBuffer(attrib))}if(mesh._gl.program=shader._gl.program,geom.indexNeedsUpdate){if(geom._gl.indexType=geom.index instanceof Uint16Array?_gl.UNSIGNED_SHORT:_gl.UNSIGNED_INT,_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),geom.indexUpdateRange){let updateRange=geom.indexUpdateRange;_gl.bufferSubData(_gl.ELEMENT_ARRAY_BUFFER,updateRange.offset*geom.index.BYTES_PER_ELEMENT,geom.index.subarray(updateRange.offset,updateRange.offset+updateRange.count))}else _gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,geom.index,_gl.STATIC_DRAW);_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,null),geom.indexNeedsUpdate=!1}mesh._gl.vao.bind();let mode=mesh._gl.mode;mode||(mesh._gl.mode=mode=function getMode(mesh,shader){return mesh.isPoints?_gl.POINTS:mesh.isLine?_gl.LINE_STRIP:shader.wireframe?_gl.LINES:_gl.TRIANGLES}(mesh,shader));let drawStart=geom.drawRange.start||0,drawEnd=geom.drawRange.end||(geom.index?geom.index.length:geom.attributes.position.count);if(geom.index&&(drawStart*=geom._gl.indexType===_gl.UNSIGNED_SHORT?2:4),isQuery&&WEBGL2){let queryMesh=mesh._queryMesh;void 0!==queryMesh._gl&&(queryMesh._gl.queryInProgress&&_gl.getQueryParameter(queryMesh._gl.query,_gl.QUERY_RESULT_AVAILABLE)&&(queryMesh._gl.occluded=!_gl.getQueryParameter(queryMesh._gl.query,_gl.QUERY_RESULT),queryMesh._gl.queryInProgress=!1),queryMesh._gl.queryInProgress||(_gl.beginQuery(_gl.ANY_SAMPLES_PASSED_CONSERVATIVE,queryMesh._gl.query),_gl.colorMask(!1,!1,!1,!1),_gl.depthMask(!1),geom.index?(_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),_gl.drawElements(mode,drawEnd,geom._gl.indexType,drawStart)):_gl.drawArrays(mode,drawStart,drawEnd),_gl.colorMask(!0,!0,!0,!0),_gl.depthMask(!0),_gl.endQuery(_gl.ANY_SAMPLES_PASSED_CONSERVATIVE),queryMesh._gl.queryInProgress=!0))}else{if(geom.isInstanced){let maxInstancedCount=mesh.maxInstancedCount?Math.min(mesh.maxInstancedCount,geom.maxInstancedCount):geom.maxInstancedCount;shader.maxInstancedCount&&(maxInstancedCount=Math.min(maxInstancedCount||9999,shader.maxInstancedCount)),WEBGL2?geom.index?_gl.drawElementsInstanced(mode,drawEnd,geom._gl.indexType,drawStart,maxInstancedCount):_gl.drawArraysInstanced(mode,drawStart,drawEnd,maxInstancedCount):geom.index?Renderer.extensions.instancedArrays.drawElementsInstancedANGLE(mode,drawEnd,geom._gl.indexType,drawStart,maxInstancedCount):Renderer.extensions.instancedArrays.drawArraysInstancedANGLE(mode,drawStart,drawEnd,maxInstancedCount),renderingCount(geom.index?geom.index.length:drawEnd,mode,maxInstancedCount)}else mesh.hideByOcclusion||(geom.index?_gl.drawElements(mode,drawEnd,geom._gl.indexType,drawStart):_gl.drawArrays(mode,drawStart,drawEnd),renderingCount(geom.index?geom.index.length:drawEnd,mode,1));_isDebbugingShader&&_gl.getError()!=_gl.NO_ERROR&&console.log(mesh,shader),mesh._gl.vao.unbind(),WEBGL2&&RenderMonitor.active&&shader?.renderTimeQuery?.endTest?.()}},this.upload=function(geom,mesh,shader,hotload){if(!mesh)return;geom._gl||(geom._gl={id:Utils.timestamp()}),mesh._gl||(mesh._gl={}),mesh._gl.geomInit=!0,geom.uploaded=!0,!mesh.isOcclusionMesh&&WEBGL2&&(mesh._gl.query=_gl.createQuery(),mesh._gl.queryInProgress=!1,mesh._gl.occluded=!1);const KEY=`${geom._gl.id}_${shader._gl._id}`;let cached=_cache[KEY];if(cached&&!hotload)return cached.count++,mesh._gl.vao=cached.vao,void(mesh._gl.lookup=KEY);Utils.query("debugUpload")&&console.log("?debugUpload – upload geometry",geom),RenderCount.add("geometry"),mesh._gl.vao&&mesh._gl.vao.destroy(),mesh._gl.vao=new VAO(_gl),geom.distributeBufferData||RenderCount.add("geom_upload",geom);for(let i=geom._attributeKeys.length-1;i>-1;i--){let key=geom._attributeKeys[i],attrib=geom._attributeValues[i],location=mesh._gl.program===shader._gl.program&&mesh._gl[key]||_gl.getAttribLocation(shader._gl.program,key);if(mesh._gl[key]=location,attrib._gl)continue;attrib._gl={};let{array:array,dynamic:dynamic}=attrib;attrib.isInterleaved&&(attrib.data._gl||(attrib.data._gl=attrib._gl),attrib._gl=attrib.data._gl,array=attrib.data.array,dynamic=attrib.data.dynamic),attrib._gl.buffer||(attrib._gl.buffer=_gl.createBuffer(),attrib._gl.bufferUploaded=!geom.distributeBufferData,_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.bufferData(_gl.ARRAY_BUFFER,geom.distributeBufferData?array.length*array.BYTES_PER_ELEMENT:array,dynamic?_gl.DYNAMIC_DRAW:_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ARRAY_BUFFER,null)),attrib.needsUpdate=!1}geom.index&&(geom._gl.index||(geom._gl.index=_gl.createBuffer(),geom._gl.indexType=geom.index instanceof Uint16Array?_gl.UNSIGNED_SHORT:_gl.UNSIGNED_INT,_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,geom.index,_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,null))),mesh._gl.vao.bind();for(let i=geom._attributeKeys.length-1;i>-1;i--){let key=geom._attributeKeys[i],attrib=geom._attributeValues[i],location=mesh._gl[key];if(-1==location)continue;let stride=0,offset=0;if(attrib.isInterleaved){let bytes=attrib.data.array.BYTES_PER_ELEMENT;stride=attrib.data.stride*bytes,offset=attrib.offset*bytes}_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),attrib.array instanceof Float32Array?_gl.vertexAttribPointer(location,attrib.itemSize,_gl.FLOAT,!1,stride,offset):_gl.vertexAttribIPointer(location,attrib.itemSize,getGLTypeForTypedArray(attrib.array),!1,stride,offset),_gl.enableVertexAttribArray(location),geom.isInstanced&&(WEBGL2?_gl.vertexAttribDivisor(location,attrib.meshPerAttribute):Renderer.extensions.instancedArrays.vertexAttribDivisorANGLE(location,attrib.meshPerAttribute))}geom.index&&_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),mesh._gl.vao.unbind(),_cache[KEY]={count:1,vao:mesh._gl.vao}},this.destroy=function(geom,mesh){for(let i=geom._attributeKeys.length-1;i>-1;i--){geom._attributeKeys[i];let attrib=geom._attributeValues[i];attrib._gl&&(_gl.deleteBuffer(attrib._gl.buffer),attrib._gl=null)}if(geom._gl?.index&&_gl.deleteBuffer(geom._gl.index),RenderCount.remove("geometry"),mesh&&mesh._gl&&mesh._gl.vao){let cache=_cache[mesh._gl.lookup];cache?(cache.count--,0==cache.count&&(cache.vao.destroy(),delete _cache[mesh._gl.lookup])):mesh._gl.vao.destroy(),delete mesh._gl.vao}delete geom._gl},this.resetMeshGeom=function(mesh){mesh._gl&&(mesh._gl.geomInit=!1)},this.uploadBuffersAsync=async function(geom){if(geom._gl&&geom._gl.uploadedAsync)return;let upload=attrib=>{let array=attrib.array,buffer=attrib._gl.buffer,promise=Promise.create(),amt=4,match=!1;for(;!match;)amt--,array.length%amt==0&&(match=!0);let chunk=array.length/amt,i=0,worker=new Render.Worker((function uploadBuffersAsync(){let offset=i*chunk,subarray=array.subarray(offset,offset+chunk);if(!attrib._gl)return worker.stop(),promise.resolve();subarray.length&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,buffer),_gl.bufferSubData(_gl.ARRAY_BUFFER,offset*array.BYTES_PER_ELEMENT,subarray),_gl.bindBuffer(_gl.ARRAY_BUFFER,null)),++i==amt&&(promise.resolve(),worker.stop())}));return promise},uploaded=!1;for(let i=geom._attributeKeys.length-1;i>-1;i--){geom._attributeKeys[i];let attrib=geom._attributeValues[i];if(!attrib._gl){geom.distributeBufferData=!0;let{array:array,dynamic:dynamic}=attrib;attrib._gl={},attrib.isInterleaved&&(attrib.data._gl||(attrib.data._gl=attrib._gl),attrib._gl=attrib.data._gl,array=attrib.data.array,dynamic=attrib.data.dynamic),attrib._gl.buffer||(attrib._gl.buffer=_gl.createBuffer(),attrib._gl.bufferUploaded=!geom.distributeBufferData,attrib.array.length&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.bufferData(_gl.ARRAY_BUFFER,array.length*array.BYTES_PER_ELEMENT,dynamic?_gl.DYNAMIC_DRAW:_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ARRAY_BUFFER,null))),attrib.needsUpdate=!1,geom.needsUpdate=!0}attrib._gl.bufferUploaded||(attrib._gl.bufferUploaded=!0,uploaded=!0,await upload(attrib),attrib.needsUpdate=!1)}geom._gl.uploadedAsync=!0,uploaded&&RenderCount.add("geom_uploadAsync",geom)}})),Class((function ShaderRendererWebGL(_gl){const _this=this;var _pool={},_programID=0,_cached={},_uboCache={};const PROFILER=!!window.OptimizationProfiler,WEBGL2=Renderer.type==Renderer.WEBGL2,GLOBAL_UNIFORMS=["normalMatrix","modelMatrix","modelViewMatrix","projectionMatrix","viewMatrix","cameraPosition","cameraQuaternion","resolution","time","shadowMatrix","shadowLightPos","shadowSize"],DEPTH_FUNC_KEYS={[Shader.DEPTH_FUNC_NEVER]:"NEVER",[Shader.DEPTH_FUNC_LESS]:"LESS",[Shader.DEPTH_FUNC_EQUAL]:"EQUAL",[Shader.DEPTH_FUNC_LEQUAL]:"LEQUAL",[Shader.DEPTH_FUNC_GREATER]:"GREATER",[Shader.DEPTH_FUNC_NOTEQUAL]:"NOTEQUAL",[Shader.DEPTH_FUNC_GEQUAL]:"GEQUAL",[Shader.DEPTH_FUNC_ALWAYS]:"ALWAYS"};function toTypedArray(uni){uni.value;return uni._gl||(uni._gl={}),uni._gl.array&&uni._gl.array.length==uni.value.length?uni._gl.array.set(uni.value):uni._gl.array=new Float32Array(uni.value),uni._gl.array}function createShader(str,type,name="Shader"){let shader=_gl.createShader(type);return void 0!==window.SPECTOR&&(shader.__SPECTOR_Metadata={name:name}),_gl.shaderSource(shader,str),_gl.compileShader(shader),Hydra.LOCAL&&(_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)||(!function logPrettyShaderError(shader){const shaderSrc=_gl.getShaderSource(shader).split("\n").map(((line,index)=>`${index}: ${line}`)),shaderLog=_gl.getShaderInfoLog(shader),splitShader=shaderLog.split("\n"),dedupe={},lineNumbers=splitShader.map((line=>parseFloat(line.replace(/^ERROR\: 0\:([\d]+)\:.*$/,"$1")))).filter((n=>!(!n||dedupe[n])&&(dedupe[n]=!0,!0))),logArgs=[""];lineNumbers.forEach((number=>{shaderSrc[number-1]=`%c${shaderSrc[number-1]}%c`,logArgs.push("background: #FF0000; color:#FFFFFF; font-size: 10px","font-size: 10px")}));const fragmentSourceToLog=shaderSrc.join("\n");logArgs[0]=fragmentSourceToLog,console.error(shaderLog),console.groupCollapsed("click to view full shader code"),console.warn(...logArgs),console.groupEnd()}(shader),_gl.deleteShader(shader))),shader}function createProgram(shader){shader.vertexShader||Shader.runPreProcess(shader),_this.multiViewOverride&&_this.multiViewOverride(shader);let vsCode=shader.onBeforeCompile(shader.vertexShader,"vs"),fsCode=shader.onBeforeCompile(shader.fragmentShader,"fs");PROFILER&&OptimizationProfiler.active&&([vsCode,fsCode]=OptimizationProfiler.override(shader,vsCode,fsCode)),RenderCount.add("shader",shader);let vs=createShader(vsCode,_gl.VERTEX_SHADER,`${shader.vsName} - ${shader.UILPrefix}`),fs=createShader(fsCode,_gl.FRAGMENT_SHADER,`${shader.fsName} - ${shader.UILPrefix}`);Hydra.LOCAL&&window.GLSLLinter&&GLSLLinter.lint(shader,vsCode,fsCode);let program=_gl.createProgram();return _gl.attachShader(program,vs),_gl.attachShader(program,fs),_gl.linkProgram(program),Hydra.LOCAL&&(_gl.getProgramParameter(program,_gl.LINK_STATUS)||(console.warn(`Shader: ${shader.vsName} | ${shader.vsName}`),console.error(`Could not compile WebGL program. ${shader.vsName} ${shader.fsName} \n\n`+_gl.getProgramInfoLog(program)))),_gl.deleteShader(vs),_gl.deleteShader(fs),program}function setupShaders(shader){for(let i=shader._uniformKeys.length-1;i>-1;i--){let key=shader._uniformKeys[i],uniform=shader._uniformValues[i];if(void 0===shader._gl[key]&&uniform)if(uniform.ubo)if(WEBGL2){if(_uboCache[shader.UILPrefix]&&!shader.ubo&&(shader.ubo=_uboCache[shader.UILPrefix]),_uboCache[shader.UILPrefix]){shader._gl[key]="U";continue}shader.ubo||(shader.ubo=new UBO(1,_gl)),shader.ubo.push(uniform),shader._gl[key]="U"}else shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key);else WEBGL2&&uniform.lightUBO?(shader._gl[key]="U",shader.uboLight=!0):shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key)}shader.ubo&&!_uboCache[shader.UILPrefix]&&(_uboCache[shader.UILPrefix]=shader.ubo),shader._gl.setupGlobals||(shader._gl.setupGlobals=!0,GLOBAL_UNIFORMS.forEach((key=>{shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key)}))),shader.uboLight&&_gl.getUniformBlockIndex(shader._gl.program,"lights"),WEBGL2&&_gl.getUniformBlockIndex(shader._gl.program,"global")}function uniformTextureArray(uni,uLoc,shader){let array=shader._gl.texArray||[];array.length=0,shader._gl.texArray=array;for(let i=0;i<uni.value.length;i++){array.push(shader._gl.texIndex);let texture=uni.value[i];!1===texture.loaded&&(texture=Utils3D.getEmptyTexture()),(void 0===texture._gl||texture.needsReupload)&&Texture.renderer.upload(texture),_gl.activeTexture(_gl["TEXTURE"+shader._gl.texIndex++]),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl)}_gl.uniform1iv(uLoc,array)}this.upload=function(shader){if(PROFILER&&OptimizationProfiler.active&&OptimizationProfiler.setupShader(shader),!shader._gl){shader._gl={};let key=`${shader.vsName}_${shader.fsName}_${shader.customCompile}`,cached=_pool[key];cached?(shader._gl.program=cached.program,shader._gl._id=cached.id,shader.onBeforePrecompilePromise.resolve(),cached.count++,Hydra.LOCAL&&_pool[key].references.push(shader)):(shader._gl.program=createProgram(shader),shader._gl._id=_programID++,_pool[key]={count:1,program:shader._gl.program,id:shader._gl._id},Shader.registerPreProcess(shader),Hydra.LOCAL&&(_pool[key].references=[shader]))}setupShaders(shader),shader.ubo&&shader.ubo.upload(),Renderer.type==Renderer.WEBGL1&&FXLayer.exists||(shader.vertexShader=shader.fragmentShader="")},this.findCachedProgram=function(shader){let key=`${shader.vsName}_${shader.fsName}_${shader.customCompile}`,cached=_pool[key];return!!cached&&(shader._gl={},shader._gl.program=cached.program,shader._gl._id=cached.id,shader.onBeforePrecompilePromise.resolve(),_uboCache[shader.UILPrefix]&&(shader.ubo=shader.UILPrefix),cached.count++,Hydra.LOCAL&&_pool[key].references.push(shader),!0)},this.draw=function(shader){void 0===shader._gl&&this.upload(shader),WEBGL2&&RenderMonitor.active&&!shader.renderTimeQuery&&(shader.renderTimeQuery=RenderMonitor.createQuery(_gl,shader)),WEBGL2&&RenderMonitor.active&&shader.renderTimeQuery?.beginTest?.(),shader._gl.texIndex=0,shader._gl.program!=_cached.program&&(_gl.useProgram(shader._gl.program),_cached.program=shader._gl.program),shader.ubo&&shader.ubo.bind(shader._gl.program,"ubo"),shader.uboLight&&Lighting.bindUBO(shader._gl.program);for(let i=shader._uniformKeys.length-1;i>-1;i--){let key=shader._uniformKeys[i],uni=shader._uniformValues[i];if(!uni)continue;let uLoc=shader._gl[key];if(void 0===uLoc&&(setupShaders(shader),uLoc=shader._gl[key]),null!==uLoc&&-1!==uLoc&&"U"!==uLoc){if(null===uni.value&&(uni.value=Utils3D.getEmptyTexture()),Hydra.LOCAL&&void 0===uni.value)throw`Uniform ${key} value is undefined. | ${shader.vsName} ${shader.fsName}`;switch(uni.type||(uni.type="string"==typeof(uniform=uni).type?uniform.type:"boolean"==typeof uniform.value?"b":null===uniform.value||uniform.value instanceof Texture||uniform.value.texture||uniform.value.rt&&uniform.value.rt.texture?"t":uniform.value instanceof Vector2?"v2":uniform.value instanceof Vector3||uniform.value instanceof Vector3D?"v3":uniform.value instanceof Vector4?"v4":uniform.value instanceof Matrix4?"m4":uniform.value instanceof Matrix3?"m3":uniform.value instanceof Color?"c":uniform.value instanceof Quaternion?"q":Array.isArray(uniform.value)&&uniform.value[0]instanceof Texture?"tv":"f"),uni.type){case"f":_gl.uniform1f(uLoc,uni.value);break;case"i":_gl.uniform1i(uLoc,Math.floor(uni.value));break;case"b":_gl.uniform1i(uLoc,uni.value);break;case"v2":_gl.uniform2f(uLoc,uni.value.x,uni.value.y);break;case"v3":_gl.uniform3f(uLoc,uni.value.x,uni.value.y,uni.value.z);break;case"c":_gl.uniform3f(uLoc,uni.value.r,uni.value.g,uni.value.b);break;case"q":case"v4":_gl.uniform4f(uLoc,uni.value.x,uni.value.y,uni.value.z,uni.value.w);break;case"v3v":_gl.uniform3fv(uLoc,toTypedArray(uni));break;case"v4v":_gl.uniform4fv(uLoc,toTypedArray(uni));break;case"v2v":_gl.uniform2fv(uLoc,toTypedArray(uni));break;case"fv":_gl.uniform1fv(uLoc,toTypedArray(uni));break;case"m4":_gl.uniformMatrix4fv(uLoc,!1,uni.value.elements);break;case"m3":_gl.uniformMatrix3fv(uLoc,!1,uni.value.elements);break;case"tv":uniformTextureArray(uni,uLoc,shader);break;case"t":let texture=uni.value;texture.isTexture||(uni.value.rt&&(texture=uni.value.rt.overrideTexture||uni.value.rt.texture),uni.value.texture&&(texture=uni.value.texture)),!1===texture.loaded&&(texture=Utils3D.getEmptyTexture());let texIndex=shader._gl.texIndex++;uni.value.vrRT&&(shader._gl.vrRT=!0,uni.value._glTexIndex=texIndex),Texture.renderer.draw(texture,uLoc,key,texIndex)}}}var uniform;if(!shader.glCustomState){if(shader.polygonOffset){let key=shader.polygonOffsetFactor+"_"+shader.polygonOffsetUnits;_cached.polygonOffset!=key&&(_gl.enable(_gl.POLYGON_OFFSET_FILL),_gl.polygonOffset(shader.polygonOffsetFactor,shader.polygonOffsetUnits)),_cached.polygonOffset=key}else _cached.polygonOffset&&_gl.disable(_gl.POLYGON_OFFSET_FILL),_cached.polygonOffset=!1;if(shader.transparent||shader.opacity?(_cached.transparent||_gl.enable(_gl.BLEND),_cached.transparent=!0):(_cached.transparent&&_gl.disable(_gl.BLEND),_cached.transparent=!1),_cached.blending!=shader.blending){switch(shader.blending){case Shader.ADDITIVE_BLENDING:_gl.blendEquation(_gl.FUNC_ADD),_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE);break;case Shader.PREMULTIPLIED_ALPHA_BLENDING:_gl.blendEquation(_gl.FUNC_ADD),_gl.blendFunc(_gl.ONE,_gl.ONE_MINUS_SRC_ALPHA);break;case Shader.REVERSE_PREMULTIPLIED_ALPHA_BLENDING:_gl.blendEquation(_gl.FUNC_ADD),_gl.blendFunc(_gl.ONE_MINUS_DST_ALPHA,_gl.ONE);break;case Shader.ADDITIVE_COLOR_ALPHA:_gl.blendEquation(_gl.FUNC_ADD),_gl.blendFunc(_gl.ONE,_gl.ONE);break;case Shader.MAX:_gl.blendEquation(WEBGL2?_gl.MAX:Renderer.extensions.minMax.MAX_EXT),_gl.blendFunc(_gl.ONE,_gl.ONE);break;case Shader.MIN:_gl.blendEquation(WEBGL2?_gl.MIN:Renderer.extensions.minMax.MIN_EXT),_gl.blendFunc(_gl.ONE,_gl.ONE);break;default:_gl.blendEquationSeparate(_gl.FUNC_ADD,_gl.FUNC_ADD),_gl.blendFuncSeparate(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA,_gl.ONE,_gl.ONE_MINUS_SRC_ALPHA)}_cached.blending=shader.blending}shader.depthTest?(_cached.depthTest||_gl.enable(_gl.DEPTH_TEST),_cached.depthTest=!0):(_cached.depthTest&&_gl.disable(_gl.DEPTH_TEST),_cached.depthTest=!1);let depthFunc=_gl[DEPTH_FUNC_KEYS[shader.depthFunc||Shader.DEPTH_FUNC_LESS]];if(_cached.depthFunc!==depthFunc&&(_gl.depthFunc(depthFunc),_cached.depthFunc=depthFunc),shader.stencilTest)if(_cached.stencilTest||_gl.enable(_gl.STENCIL_TEST),_cached.stencilTest=!0,shader.stencilMask)_gl.stencilFunc(_gl.ALWAYS,1,255),_gl.stencilOp(_gl.KEEP,_gl.KEEP,_gl.REPLACE),_gl.stencilMask(255),_gl.colorMask(!1,!1,!1,!1),_gl.disable(_gl.DEPTH_TEST);else{_gl.colorMask(!0,!0,!0,!0),_gl.enable(_gl.DEPTH_TEST);let mode="inside";_gl.stencilFunc("inside"==mode?_gl.EQUAL:_gl.NOTEQUAL,1,255),_gl.stencilOp(_gl.KEEP,_gl.KEEP,_gl.KEEP)}else _cached.stencilTest&&_gl.disable(_gl.STENCIL_TEST),_cached.stencilTest=!1;switch(shader.side){case Shader.BACK_SIDE:_cached.side!=Shader.BACK_SIDE&&(_gl.enable(_gl.CULL_FACE),_gl.cullFace(_gl.FRONT),_cached.side=Shader.BACK_SIDE);break;case Shader.DOUBLE_SIDE:_cached.side!=Shader.DOUBLE_SIDE&&(_gl.disable(_gl.CULL_FACE),_cached.side=Shader.DOUBLE_SIDE);break;default:_cached.side!=Shader.FRONT_SIDE&&(_gl.enable(_gl.CULL_FACE),_gl.cullFace(_gl.BACK),_cached.side=Shader.FRONT_SIDE)}if(_cached.depthMask!=shader.depthWrite&&(_gl.depthMask(!!shader.depthWrite),_cached.depthMask=shader.depthWrite),shader.colorMask&&shader.colorMask.push)_gl.colorMask(shader.colorMask[0]||!1,shader.colorMask[1]||!1,shader.colorMask[2]||!1,shader.colorMask[3]||!1);else switch(shader.colorMask){case Shader.COLOR_MASK_NONE:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!0,!0,!0,!0),_cached.colorMask=shader.colorMask);break;case Shader.COLOR_MASK_RGB:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!1,!1,!1,!0),_cached.colorMask=shader.colorMask);break;case Shader.COLOR_MASK_RGBA:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!1,!1,!1,!1),_cached.colorMask=shader.colorMask)}}if(shader.customState)for(let i=0;i<shader.customState.length;i++){let obj=shader.customState[i];_gl[obj.fn].apply(_gl,obj.params)}},this.destroy=function(shader){delete shader._gl,shader.ubo&&shader.ubo.destroy()},this.appendUniform=function(shader,key,value,hint){let loc=shader._gl[key];if(void 0===loc&&(loc=loc=_gl.getUniformLocation(shader._gl.program,key)),null!==loc)if(value.isMatrix4)_gl.uniformMatrix4fv(loc,!1,value.elements);else if(value.isMatrix3)_gl.uniformMatrix3fv(loc,!1,value.elements);else if(value.isVector4)_gl.uniform4f(loc,value.x,value.y,value.z,value.w);else if(value.isQuaternion)_gl.uniform4f(loc,value.x,value.y,value.z,value.w);else if(value.isVector3)_gl.uniform3f(loc,value.x,value.y,value.z);else if(value.isVector2)_gl.uniform2f(loc,value.x,value.y);else if(value instanceof Float32Array)switch(hint){case"matrix":_gl.uniformMatrix4fv(loc,!1,value);break;case"float":_gl.uniform1fv(loc,value);break;case"vec3":_gl.uniform3fv(loc,value)}else if(Array.isArray(value)){let array=shader._gl.texArray||[];array.length=0,shader._gl.texArray=array;for(let i=0;i<value.length;i++)array.push(shader._gl.texIndex),_gl.activeTexture(_gl["TEXTURE"+shader._gl.texIndex++]),_gl.bindTexture(_gl.TEXTURE_2D,value[i]._gl);_gl.uniform1iv(loc,array)}else _gl.uniform1f(loc,value)},this.resetState=function(){_cached.depthMask||(_gl.depthMask(!0),_cached.depthMask=!0),_cached.depthTest||_gl.enable(_gl.DEPTH_TEST),_cached.depthTest=!0,_cached.depthFunc!==_gl.LESS&&_gl.depthFunc(_gl.LESS),_cached.depthFunc=_gl.LESS,_cached.colorMask!=Shader.COLOR_MASK_NONE&&(_gl.colorMask(!0,!0,!0,!0),_cached.colorMask=Shader.COLOR_MASK_NONE),_cached.program=null},this.clearState=function(){_cached={}},this.hotReload=function(file){file=file.split(".")[0].trim();for(let key in _pool)if(key.includes(file)&&!["|instance","|Line3D","|MergedLine"].find((part=>key.includes(part)))){let obj=_pool[key],rootShader=obj.references[0];for(let i=0;i<obj.references.length;i++){let shader=obj.references[i];0===i?(shader.restoreFS=shader.restoreVS=null,shader.resetProgram(),shader._gl={},shader._gl.program=createProgram(shader),shader._gl._id=_programID++,obj.program=shader._gl.program,obj.id=shader._gl._id):(shader.destroy(),shader.restoreFS=rootShader.restoreFS,shader.restoreVS=rootShader.restoreVS,shader.vertexShader=rootShader.vertexShader,shader.fragmentShader=rootShader.fragmentShader,shader._gl={},shader._gl.program=obj.program,shader._gl._id=obj.id),setupShaders(rootShader)}}},this.hotReloadClearProgram=function(id){for(let key in _pool)key.includes(id)&&delete _pool[key]}})),Class((function TextureRendererWebGL(_gl){const _this=this;var _state={};const FLOAT_DATA=new Float32Array([0,0,0,0]),UINT_DATA=new Uint32Array([0,0,0,0]),INT_DATA=new Int32Array([0,0,0,0]),DATA=new Uint8Array([0,0,0,0]),{getFormat:getFormat,getProperty:getProperty,getType:getType,getFloatParams:getFloatParams,getInternalFormat:getInternalFormat}=require("GLTypes");function setTextureParams(texture,textureType=_gl.TEXTURE_2D){let format=getFormat(texture),internalFormat=getInternalFormat(texture),type=getType(texture),data=DATA;switch(texture.type){case Texture.FLOAT:data=FLOAT_DATA;break;case Texture.UNSIGNED_INTEGER:data=UINT_DATA;break;case Texture.INTEGER:data=INT_DATA;break;case Texture.HALF_FLOAT:data=null}textureType!=_gl.TEXTURE_2D||texture.compressed||_gl.texImage2D(textureType,0,internalFormat,1,1,0,format,type,data),_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(textureType,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(textureType,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),texture.data||texture.format!=Texture.RGBAFormat?1==_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):!1===texture.premultiplyAlpha?(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),_state.premultiply=!0),texture.anisotropy>1&&_gl.texParameterf(textureType,Renderer.extensions.anisotropy.TEXTURE_MAX_ANISOTROPY_EXT,texture.anisotropy)}function updateDynamic(texture){if(texture.isDataTexture){if(!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1),!texture.glFormat){let{internalformat:internalformat,format:format,type:type}=getFloatParams(texture);texture.iformat=internalformat,texture.glFormat=format,texture.glType=type}_gl.texSubImage2D(_gl.TEXTURE_2D,0,0,0,texture.width,texture.height,texture.glFormat,texture.glType,texture.data)}else{_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0),texture.format==Texture.RGBAFormat?!1===texture.premultiplyAlpha?(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),_state.premultiply=!0):_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1),texture.glFormat||(texture.glFormat=getFormat(texture));try{_gl.texImage2D(_gl.TEXTURE_2D,0,texture.glFormat,texture.glFormat,getType(texture),texture.image)}catch(e){}}}this.draw=function(texture,loc,key,id){if((void 0===texture._gl||texture.needsReupload)&&this.upload(texture),_gl.activeTexture(_gl[`TEXTURE${id}`]),texture.cube)_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl);else if(texture.isTexture3D)_gl.bindTexture(_gl.TEXTURE_3D,texture._gl);else{let texType=texture.EXT_OES?_gl.TEXTURE_EXTERNAL_OES:_gl.TEXTURE_2D;_gl.bindTexture(texType,texture._gl)}_gl.uniform1i(loc,id),(texture.dynamic||texture.needsUpdate)&&updateDynamic(texture),texture.needsUpdate=!1},this.upload=function(texture){if(texture._gl&&!texture.needsReupload&&!texture.needsUpdate)return;let format=getFormat(texture);if(Utils.query("debugUpload")&&console.log("?debugUpload – upload texture",texture),texture.cube){if(texture.compressed){if(1!==texture.cube.length)throw"Compressed cube texture requires 1 file with 6 faces"}else if(6!==texture.cube.length)throw"Cube texture requires 6 images";return function uploadCube(texture){if(void 0===texture._gl){texture._gl=_gl.createTexture(),_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl);let needsFlipY=!0===texture.flipY;needsFlipY!==!!_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,needsFlipY),_state.flipY=needsFlipY),setTextureParams(texture,_gl.TEXTURE_CUBE_MAP)}let format=getFormat(texture);if(texture.compressed){let image=texture.cube[0];for(let i=0;i<image.compressedData.length;i++){let size=image.sizes[i],data=image.compressedData[i],faceLength=data.length/6;for(let j=0;j<6;j++)if(image.uncompressed){let view=new Uint8Array(data.buffer,j*faceLength,faceLength);_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+j,i,_gl.RGBA,size.width,size.height,0,_gl.RGBA,_gl.UNSIGNED_BYTE,view)}else{let view=new DataView(data.buffer,j*faceLength,faceLength);_gl.compressedTexImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+j,i,image.gliFormat,size.width||size,size.height||size,0,view)}}}else{for(let i=0;i<6;i++)_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,format,format,getType(texture),texture.cube[i]);_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP)}texture.needsUpdate=texture.needsReupload=!1,texture.onUpdate&&texture.onUpdate()}(texture)}if(texture.isTexture3D)return function uploadTexture3D(texture){if(void 0===texture._gl){let format=getFormat(texture),internalFormat=getInternalFormat(texture),type=getType(texture);texture._gl=_gl.createTexture(),_gl.bindTexture(_gl.TEXTURE_3D,texture._gl),_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_gl.texParameteri(_gl.TEXTURE_3D,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(_gl.TEXTURE_3D,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(_gl.TEXTURE_3D,_gl.TEXTURE_WRAP_R,getProperty(texture.wrapR)),_gl.texParameteri(_gl.TEXTURE_3D,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(_gl.TEXTURE_3D,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),_gl.texImage3D(_gl.TEXTURE_3D,0,internalFormat,texture.width,texture.height,texture.depth,0,format,type,texture.image),texture.needsUpdate=texture.needsReupload=!1,texture.onUpdate&&texture.onUpdate()}}(texture);let texType=texture.EXT_OES?_gl.TEXTURE_EXTERNAL_OES:_gl.TEXTURE_2D;if(void 0===texture._gl?(texture._gl=_gl.createTexture(),RenderCount.add("texture"),_gl.bindTexture(texType,texture._gl),setTextureParams(texture,texType)):_gl.bindTexture(texType,texture._gl),texture.isDataTexture||texture.type&&texture.type.includes("float")){!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_gl.pixelStorei(_gl.UNPACK_ALIGNMENT,1);let{internalformat:internalformat,format:format,type:type}=getFloatParams(texture);if("ie"===Device.system.browser)try{_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,texture.width,texture.height,0,format,type,texture.distributeTextureData?null:texture.data)}catch(e){console.log(e)}else _gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,texture.width,texture.height,0,format,type,texture.distributeTextureData?null:texture.data);texture.destroyDataAfterUpload&&(texture.data=null,delete texture.data,texture.onDataDestroyed?.())}else{let needsFlipY=!texture.compressed&&!1!==texture.flipY;if(needsFlipY!==!!_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,needsFlipY),_state.flipY=needsFlipY),texture.image&&texture.compressed){let data=texture.image.compressedData;for(let i=0;i<data.length;i++){let size=texture.image.sizes[i];texture.image.uncompressed?_gl.texImage2D(_gl.TEXTURE_2D,i,_gl.RGBA,size.width,size.height,0,_gl.RGBA,_gl.UNSIGNED_BYTE,data[i]):_gl.compressedTexImage2D(_gl.TEXTURE_2D,i,texture.image.gliFormat,size.width||size,size.height||size,0,data[i])}data.length=0}else if(texture.image&&!(texture.image instanceof HTMLVideoElement))try{_gl.texImage2D(_gl.TEXTURE_2D,0,format,format,getType(texture),texture.image)}catch(e){console.log("error loading texture",e,texture.image)}texture.distributeTextureData||RenderCount.add("tex_upload",texture)}(texture.image||texture.data)&&texture.generateMipmaps&&!texture.compressed&&_gl.generateMipmap(_gl.TEXTURE_2D),texture.needsUpdate=texture.needsReupload=!1,texture.onUpdate&&texture.onUpdate()},this.manualUpdateDynamic=function(texture){(void 0===texture._gl||texture.needsReupload)&&this.upload(texture),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),updateDynamic(texture)},this.uploadAsync=function(texture){let{format:format,type:type}=getFloatParams(texture);if(texture._uploadAsyncPromise)return texture._uploadAsyncPromise;texture._uploadAsyncPromise=Promise.create(),RenderCount.add("tex_uploadAsync",texture),texture._gl||(texture.distributeTextureData=!0,_this.upload(texture));let pixelsPerChunk=texture.height/4,dataPerChunk=texture.data.length/4,i=0,worker=new Render.Worker((function workerUploadAsync(){let pixelOffset=pixelsPerChunk*i,dataOffset=dataPerChunk*i,subarray=texture.data.subarray(dataOffset,dataOffset+dataPerChunk);!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),_gl.texSubImage2D(_gl.TEXTURE_2D,0,0,pixelOffset,texture.width,pixelsPerChunk,format,type,subarray),_gl.bindTexture(_gl.TEXTURE_2D,null),4==++i&&(worker.stop(),texture._uploadAsyncPromise.resolve())}));return texture._uploadAsyncPromise},this.destroy=function(texture){texture._gl&&(_gl.deleteTexture(texture._gl),RenderCount.remove("texture"),RenderCount.add("tex_destroy",texture)),texture.data&&(texture.data=null,delete texture.data),delete texture._gl}}));class RenderTarget{constructor(width,height,options={}){this.width=width,this.height=height,this.options=options,this.viewport=new Vector2(0,0),void 0===options.minFilter&&(options.minFilter=Texture.LINEAR),this.stencil="boolean"==typeof options.stencil&&options.stencil,options.sharedRenderbuffer&&(this.sharedRenderbuffer=!0,this.clearDepth="boolean"!=typeof options.clearDepth||options.clearDepth,this._depthBuffer=options.sharedRenderbuffer.rt._depthBuffer),this.texture=new Texture(null),this.texture.generateMipmaps=options.generateMipmaps,this.texture.rt=this,this.texture.width=width,this.texture.height=height,this.texture.minFilter=options.minFilter||Texture.LINEAR,this.texture.magFilter=options.magFilter||Texture.LINEAR,this.texture.wrapS=options.wrapS||Texture.CLAMP_TO_EDGE,this.texture.wrapT=options.wrapT||Texture.CLAMP_TO_EDGE,this.texture.format=options.format||Texture.RGBFormat,options.type&&(this.texture.type=options.type),options.multisample&&(Renderer.type?Renderer.type==Renderer.WEBGL2:Device.graphics.webgl.webgl2)&&(options.multisample=!1,this.multisample=!0,this._rtMultisample=new RenderTarget(width,height,options),this._rtMultisample.internalMultisample=!0,this._rtMultisample.parent=this,this._rtMultisample._samplesAmount=void 0===options.samplesAmount?100:options.samplesAmount),this.isRT=!0}setSize(width,height){this.width=width,this.height=height,this.texture.width=width,this.texture.height=height,this.viewport.set(0,0),RenderTarget.renderer.resize(this),!this.multisample||this._rtMultisample.width===width&&this._rtMultisample.height===height||(this._rtMultisample.destroy(),this._rtMultisample=new RenderTarget(width,height,this.options),this._rtMultisample.internalMultisample=!0,this._rtMultisample.parent=this,this._rtMultisample._samplesAmount=void 0===this.options.samplesAmount?100:this.options.samplesAmount)}clone(){return new RenderTarget(this.width,this.height,{...this.options}).copy(this)}copy(source){this.width=source.width,this.height=source.height;let options={...this.options};return this.options=options,this.viewport.copy(source.viewport),this.stencil=source.stencil,source.sharedRenderbuffer&&(this.sharedRenderbuffer=!0,this.clearDepth=source.clearDepth,this._depthBuffer=source._depthBuffer),this.texture=source.texture.clone(),source.multisample&&(options.multisample=!1,this.multisample=!0,this._rtMultisample=new RenderTarget(this.width,this.height,options),this._rtMultisample.internalMultisample=!0,this._rtMultisample.parent=this,this._rtMultisample._samplesAmount=source._rtMultisample._samplesAmount),this}createDepthTexture(){return this.depth=new Texture(null),this.depth.generateMipmaps=!1,this.depth.minFilter=Texture.NEAREST,this.depth.magFilter=Texture.NEAREST,this.depth.wrapS=Texture.CLAMP_TO_EDGE,this.depth.wrapT=Texture.CLAMP_TO_EDGE,this._gl&&RenderTarget.renderer.destroy(this),this.depth}destroy(){RenderTarget.renderer.destroy(this)}upload(){this._gl||RenderTarget.renderer.upload(this),this._rtMultisample&&this._rtMultisample.upload()}}class MultiRenderTarget extends RenderTarget{constructor(width,height,options={}){super(width,height,options),this.multi=!0,this.attachments=[this.texture]}}class CubeRenderTarget extends RenderTarget{constructor(width,height,options={}){super(width,height,options),this.activeFace=0,this.cube=!0}}Class((function Shader(_vertexShader,_fragmentShader,_params,_onBeforeBuild,_postfix){"object"==typeof _vertexShader&&(_fragmentShader=_vertexShader.uniforms,_vertexShader=_vertexShader.name);const _this=this;this.uniforms=Shader.createUniforms(this),this.side=Shader.FRONT_SIDE,this.blending=Shader.NORMAL_BLENDING,this.colorMask=Shader.COLOR_MASK_NONE,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=1,this.depthTest=!0,this.depthWrite=!0,this.ssReflections=_params?.ssReflections||!1,this.depthFunc=Shader.DEPTH_FUNC_LESS,this.stencilTest=!1,this.stencilMask=!1,this.wireframe=!1,this.transparent=!1,this.visible=!0,this.persists=!1,this.precision="high",this.customCompile=_params?.customCompile||"",this.onBeforePrecompilePromise=Promise.create(),"string"!=typeof _fragmentShader&&(_params=_fragmentShader,_fragmentShader=_vertexShader),_params=_params||{},_this.vsParam=_vertexShader,_this.fsParam=_fragmentShader,_this.params=_params,_this.onBeforeBuild=_onBeforeBuild,_this.vsName=_vertexShader,_this.fsName=(_fragmentShader||_vertexShader)+(_postfix||""),_params.vsName&&(_this.vsName=_params.vsName,delete _params.vsName),_params.precision&&(_this.precision=_params.precision),_params.receiveShadow&&(_this.receiveLight=!0,World.RENDERER.shadows&&(_this.precision="high"));let vs=_vertexShader,fs=_fragmentShader;_params.uilFrom&&(vs=_params.uilFrom,fs=_params.uilFrom,delete _params.uilFrom),_this.UILPrefix=_params.UILPrefix||`${vs}/${fs}/${_params.unique?_params.unique+"/":""}`,Shader.parseParams(_params,_this),Shader.renderer.findCachedProgram(_this)||Shader.hasAlreadyPreProcessed(_this)||Shader.runPreProcess(_this)}),(_=>{function getLightingCode(_this){if(!_this.receiveShadow&&Shader.shouldReceiveShadow(_this)&&(_this.receiveShadow=!0),!_this.receiveLight||_this.isShadow)return"";let numLights=Lighting.getLighting(_this).position.length/4;return 0==numLights?Lighting.getShadowUniforms(_this):[`#define NUM_LIGHTS ${numLights}`,"uniform lights {",`vec4 lightPos[${numLights}];`,`vec4 lightColor[${numLights}];`,`vec4 lightData[${numLights}];`,`vec4 lightData2[${numLights}];`,`vec4 lightData3[${numLights}];`,`vec4 lightProperties[${numLights}];`,"};"].join("\n")+Lighting.getShadowUniforms(_this)}function setupssReflections(code,type,_this){if("vs"==type){if(!code.includes("vec3 pos = position;"))throw`Shader ${_this.vsName} needs to have "vec3 pos = position;" in order for dynamic merging to work`;let vsDeferred="\n            vPosDeferred = modelViewMatrix * vec4(pos, 1.);\n            vNormalDeferred = normalMatrix * normal;\n            vST = uv;\n            ",main=code.split("vec3 pos = position;");main[1]="\n"+vsDeferred+main[1],code=main.join("vec3 pos = position;")}return code}Shader.FRONT_SIDE="shader_front_side",Shader.BACK_SIDE="shader_back_side",Shader.DOUBLE_SIDE="shader_double_side",Shader.DOUBLE_SIDE_TRANSPARENCY="shader_double_side_trasparency",Shader.ADDITIVE_BLENDING="shader_additive_blending",Shader.NORMAL_BLENDING="shader_normal_blending",Shader.PREMULTIPLIED_ALPHA_BLENDING="shader_premultiplied_alpha_blending",Shader.ADDITIVE_COLOR_ALPHA="shader_additive_color_alpha",Shader.REVERSE_PREMULTIPLIED_ALPHA_BLENDING="shader_reverse_premultiplied_alpha_blending",Shader.MAX="shader_max",Shader.MIN="shader_min",Shader.CUSTOM_DEPTH="shader_custom_depth",Shader.COLOR_MASK_RGB="shader_colormask_rgb",Shader.COLOR_MASK_RGBA="shader_colormask_rgba",Shader.COLOR_MASK_NONE="shader_colormask_none",Shader.DEPTH_FUNC_NEVER="shader_depth_func_never",Shader.DEPTH_FUNC_LESS="shader_depth_func_less",Shader.DEPTH_FUNC_EQUAL="shader_depth_func_equal",Shader.DEPTH_FUNC_LEQUAL="shader_depth_func_lequal",Shader.DEPTH_FUNC_GREATER="shader_depth_func_greater",Shader.DEPTH_FUNC_NOTEQUAL="shader_depth_func_notequal",Shader.DEPTH_FUNC_GEQUAL="shader_depth_func_gequal",Shader.DEPTH_FUNC_ALWAYS="shader_depth_func_always",Shader.parseParams=function(_params,_this){for(let key in _params)if("receiveShadow"==key)_this.receiveShadow=_params[key];else if("receiveLight"==key)_this.receiveLight=_params[key];else if(_params[key]&&void 0!==_params[key].value)window.UILStorage&&UILStorage.hasData()?(_this.uniforms[key]=UILStorage.parse(_this.UILPrefix+key,_params[key].value)||_params[key],_params[key].ubo&&(_this.uniforms[key].ubo=!0)):_this.uniforms[key]=_params[key];else{if("unique"==key)continue;_this[key]=_params[key]}},Shader.runPreProcess=function(shader){if(shader.vertexShader=Shader.process(Shaders.getShader(shader.vsParam+".vs"),"vs",shader,shader.onBeforeBuild),shader.fragmentShader=Shader.process(Shaders.getShader(shader.fsParam+".fs"),"fs",shader,shader.onBeforeBuild),shader.vertexShader.includes("//js")&&!window[shader.vsName]){let code=shader.vertexShader.split("\n"),adders=[];code.forEach((line=>{if(line.includes("//js")){let name=line.split(" ")[2].replace(";",""),value=line.split("//js ")[1].replace(";","");adders.push((obj=>{obj[name]={value:eval(value)}}))}else if(line.includes("sampler2D")){let name=line.split(" ")[2].replace(";","");if(name.includes("sampler"))return;adders.push((obj=>{obj[name]={value:null},line.includes("repeat")&&(obj[name].getTexture=Utils3D.getRepeatTexture)}))}})),window[shader.vsName]=function(_mesh,_shader){let uniforms={};adders.forEach((addTo=>addTo(uniforms))),_shader.addUniforms(uniforms)}}},Shader.process=function(code,type,_this,_onBeforeBuild){const WEBGL2=Renderer.type==Renderer.WEBGL2;if(!code)throw"No shader found! "+_this.vsName+" | "+_this.fsName;const externalOES=code.includes("samplerExternalOES")&&window.AURA&&"android"==Device.system.os,standardDeriv=!WEBGL2&&code.includes(["fwidth","dFdx","dFdy"]),drawBuffers=!WEBGL2&&code.includes(["gl_FragData","#drawbuffer"])&&window.World&&World.NUKE.useDrawBuffers;let levelOfDetail=!WEBGL2&&code.includes(["textureGrad","textureProjGrad","texture2DGrad","textureCubeGrad","texture2DProjGrad"]);levelOfDetail||WEBGL2||"fs"!==type||(levelOfDetail=code.includes(["textureLod","texture2DLod","textureCubeLod","texture2DProjLod"]));const layoutsDefined=code.includes("layout")||_this.ssReflections;let header;if(header="vs"==type?["#version 300 es",externalOES?"#extension GL_OES_EGL_image_external_essl3 : require":"",levelOfDetail?"#extension GL_EXT_shader_texture_lod : enable":"",`precision ${_this.precision}p float;`,`precision ${_this.precision}p int;`,WEBGL2?`precision ${_this.precision}p sampler3D;`:"",WEBGL2?`precision ${_this.precision}p usampler2D;`:"",WEBGL2?`precision ${_this.precision}p isampler2D;`:"","attribute vec2 uv;","attribute vec3 position;","attribute vec3 normal;","uniform mat3 normalMatrix;","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform global {","mat4 projectionMatrix;","mat4 viewMatrix;","vec3 cameraPosition;","vec4 cameraQuaternion;","vec2 resolution;","float time;","float timeScale;","};"].join("\n"):["#version 300 es",externalOES?"#extension GL_OES_EGL_image_external_essl3 : require":"",standardDeriv?"#extension GL_OES_standard_derivatives : enable":"",drawBuffers?"#extension GL_EXT_draw_buffers : require":"",levelOfDetail?"#extension GL_EXT_shader_texture_lod : enable":"",`precision ${_this.precision}p float;`,`precision ${_this.precision}p int;`,WEBGL2?`precision ${_this.precision}p sampler3D;`:"",WEBGL2?`precision ${_this.precision}p usampler2D;`:"",WEBGL2?`precision ${_this.precision}p isampler2D;`:"","uniform mat3 normalMatrix;","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform global {","mat4 projectionMatrix;","mat4 viewMatrix;","vec3 cameraPosition;","vec4 cameraQuaternion;","vec2 resolution;","float time;","float timeScale;","};",layoutsDefined?"":"out vec4 FragColor;"].join("\n"),header+="\n__ACTIVE_THEORY_LIGHTS__\n\n",window.AURA&&(header+="#define AURA\n"),_this.defines&&_this.defines.forEach((d=>header+=`#define ${d.toUpperCase()}\n`)),_onBeforeBuild&&(code=_onBeforeBuild(code,type)),_this.ssReflections){let GIVaryings=["uniform float ssReflectivity;","uniform float ssIORrefl;","uniform float ssRougness;","uniform float ssgiIntensity;","uniform sampler2D tReflectivity;","uniform sampler2D tRoughness;","varying vec4 vPosDeferred;","varying vec3 vNormalDeferred;","varying vec2 vST;"].join("\n");header+=GIVaryings}let split=code.split("\n");for(let i=split.length-1;i>-1;i--){let line=split[i];if(line.includes("uniform sampler2D")){let name=line.split("sampler2D ")[1].replace(";","").trim();_this.uniforms[name]||(_this.uniforms[name]={value:null})}}if(code=header+code,_this.ssReflections&&"fs"==type){let buffersDeferred="\n            float ssReflectionMap = texture(tReflectivity, vST).r;\n            float ssRougnessMap = texture(tRoughness, vST).r;\n            #drawbuffer PositionLayer gl_FragColor = vPosDeferred;\n            #drawbuffer NormalsLayer gl_FragColor = vec4(vNormalDeferred, 1.);\n            #drawbuffer ReflectivityLayer gl_FragColor = vec4(ssIORrefl, ssReflectivity * ssReflectionMap, ssRougness * ssRougnessMap, ssgiIntensity);\n            ",main=code.split("main() {");main[1]="\n"+buffersDeferred+main[1],code=main.join("main() {")}return code};const prototype=Shader.prototype;prototype.copyUniformsTo=function(shader,linked,ignore){for(let key in this.uniforms)void 0!==this.uniforms[key]&&(ignore&&ignore.includes?.(key)||(shader.uniforms[key]=linked?this.uniforms[key]:{type:this.uniforms[key].type,value:this.uniforms[key].value}))},prototype.replicateUniformsTo=function(shader){shader.uniforms=this.uniforms,shader._uniformKeys=this._uniformKeys,shader._uniformValues=this._uniformValues},prototype.addUniforms=function(uniforms){uniforms.UILPrefix&&(this.UILPrefix=uniforms.UILPrefix,delete uniforms.UILPrefix);for(let key in uniforms)this.hotReloading&&this.uniforms[key]||(this.uniforms[key]=uniforms[key])},prototype.draw=function(mesh,geom){this.receiveLight&&!this.__lighting&&Lighting.getLighting(this),Shader.renderer.draw(this,mesh,geom)},prototype.upload=function(mesh,geom){!this.receiveShadow&&Shader.shouldReceiveShadow(this)&&(this.receiveShadow=!0),Shader.renderer.upload(this,mesh,geom),this.receiveShadow&&!this.shadow&&Lighting.initShadowShader(this,mesh)},prototype.destroy=function(){this.persists||(Shader.renderer.destroy(this),this.shadow&&this.shadow.destroy()),this.receiveLight&&Lighting.destroyShader(this)},prototype.onBeforeCompile=function(code,type){const WEBGL2=Renderer.type==Renderer.WEBGL2;"}"!=(code=code.trim())[code.length-1]&&(code+="\n}");let p=this.mesh,scene=World.SCENE;for(;p;)p instanceof Scene&&(scene=p),p=p._parent;scene.nuke&&scene.nuke.onBeforeShaderCompile?scene.nuke.onBeforeShaderCompile(this.mesh):this.onBeforePrecompilePromise.resolve(),this.receiveShadow&&(this.receiveLight=!0);let varyings=[],uniforms=[];this.ssReflections&&(code=setupssReflections(code,type,this)),(code=code.split("\n")).forEach(((line,index)=>{"fs"==type&&line.includes("#drawbuffer")&&(line.includes("#drawbuffer Color")?code[index]=line.replace("#drawbuffer Color",""):code[index]=""),line.includes("varying")&&varyings.push(line.trim()),line.includes("uniform")&&uniforms.push(line.trim())})),code=code.join("\n");const process=function(array){let replace,counts=[];array.forEach((value=>{let count=0;array.forEach((v2=>{value==v2&&count++})),count>1&&(replace||(replace=[]),replace.includes(value)||(replace.push(value),counts.push(count)))})),replace&&replace.forEach(((value,i)=>{let count=counts[i];for(let j=0;j<count-1;j++){let index=code.lastIndexOf(value);code=code.substring(0,index)+code.substring(index+value.length)}}))};process(varyings),process(uniforms),"fs"==type&&(WEBGL2?code.includes("gl_FragColor")&&(code=code.replace(/gl_FragColor/g,"FragColor")):code.includes("#applyShadow")&&(code=code.replace("#applyShadow",""))),code=code.replace("__ACTIVE_THEORY_LIGHTS__",getLightingCode(this)),"fs"==type&&code.includes("SHADOW_MAPS")&&(code=require("GLSLOptimizer")(code.replaceAll("SHADOW_COUNT",Lighting.getShadowCount(this)))),this.preCompile&&(code=this.preCompile(code,type));let converter=require("ShaderCode");return code=WEBGL2?converter.convertWebGL2(code,type):converter.convertWebGL1(code,type)},prototype.set=function(key,value,ref){let _this=ref||this;return _this.uniforms[key]?(void 0!==value&&(TweenManager.clearTween(_this.uniforms[key]),_this.uniforms[key].value=value,_this.ubo&&(_this.ubo.needsUpdate=!0)),_this.uniforms[key].value):console.warn(`No key ${key} found on shader`,_this)},prototype.get=function(key,ref){let _this=ref||this;return _this.uniforms[key]&&_this.uniforms[key].value},prototype.tween=function(key,value,time,ease,delay,callback,update,scaledTime){return"number"==typeof value?tween(this.uniforms[key],{value:value},time,ease,delay,callback,update,null,scaledTime):tween(this.uniforms[key].value,value,time,ease,delay,callback,update,null,scaledTime)},prototype.clone=function(noShadows,postfix){const _this=this;noShadows&&(_this.params.receiveShadow=!1);let shader=new Shader(_this.vsParam,_this.fsParam,_this.params,null,postfix);for(let key in _this)key.includes(["vsName","fsName","uniforms","_uniform","_gl"])||"function"==typeof _this[key]||(shader[key]=_this[key]);for(let key in _this.uniforms)shader.uniforms[key]={type:_this.uniforms[key].type,value:_this.uniforms[key].value};return shader},prototype.resetProgram=function(){this.destroy(),this.vertexShader=this.restoreVS||Shader.process(Shaders.getShader(this.vsName+".vs"),"vs",this,this.onBeforeBuild),this.fragmentShader=this.restoreFS||Shader.process(Shaders.getShader(this.fsName+".fs"),"fs",this,this.onBeforeBuild)};var _shaderShadowMap={},_emptyShadowMap;Object.defineProperty(prototype,"receiveShadow",{set:function(v){_shaderShadowMap[this.vsName+"_"+this.fsName]=v,this._receiveShadow=v,v&&!this.uniforms.shadowMap&&(_emptyShadowMap||(_emptyShadowMap=[Utils3D.getEmptyTexture()]),this.uniforms.shadowMap={value:_emptyShadowMap})},get:function(){return this._receiveShadow}});let shaders={};Shader.hasAlreadyPreProcessed=function(shader){let key=shader.vsName+"_"+shader.vsName+"_"+shader.customCompile;return shaders[key]},Shader.registerPreProcess=function(shader){let key=shader.vsName+"_"+shader.vsName+"_"+shader.customCompile;shaders[key]=!0},Shader.shouldReceiveShadow=function(shader){return _shaderShadowMap[shader.vsName+"_"+shader.fsName]}})),Shader.createUniforms=function(shader){let uniforms={},handler={set(target,property,value){target[property]=value,shader._uniformKeys.length=0,shader._uniformValues.length=0;for(let key in uniforms)shader._uniformKeys.push(key),shader._uniformValues.push(uniforms[key]);return!0}};return shader._uniformValues=[],shader._uniformKeys=[],new Proxy(uniforms,handler)},Class((function ShaderVariants(_params={}){const _this=this;var _target,_destination,_map={};const LERP=_params.lerp||.07;function generate(key,shaderOrUniforms){let uniforms,prefix=shaderOrUniforms.UILPrefix?.split("/")[0]||_this.parent.uilInput?.prefix||Utils.getConstructorName(_this.parent);prefix+="_shaderVariants_"+key,uniforms=Array.isArray(shaderOrUniforms)||shaderOrUniforms.uniforms?shaderOrUniforms.uniforms:shaderOrUniforms;let newUniforms={};for(let key in uniforms){let uni=uniforms[key];"string"==typeof uni.value&&(uni.value=Number(uni.value)),uni.ignoreVariants||uni.ignoreUIL||(newUniforms[key]=uniforms[key])}let uilFolder=_this.parent.uilFolder;return uilFolder||(uilFolder=shaderOrUniforms.mesh?.__uilGroup),[newUniforms,prefix,uilFolder]}_this.parent.startRender((function loop(){_destination&&ShaderUIL.lerpShader(_destination,_target,LERP)})),_this.parent.createShaderOverride=function createShaderOverride(key,inUniforms,active){if(inUniforms.uniforms)throw"Using an entire shader for createShaderOverride is not what you want. Just pass in the uniforms that are meant to be overriden.";let[uniforms,prefix,uilFolder]=generate(key,inUniforms),shader=ShaderUIL.createOverride(prefix,uniforms,null,null,!active);ShaderUIL.add(shader,uilFolder).setLabel(`Shader: ${key}`),active&&_this.parent.startRender((_=>{ShaderUIL.lerpShader(shader,uniforms,1)}))},_this.parent.createShaderVariant=function createShaderVariant(key,shaderOrUniforms){let[uniforms,prefix,uilFolder]=generate(key,shaderOrUniforms),shader=ShaderUIL.createOverride(prefix,uniforms,null,null,!0);ShaderUIL.add(shader,uilFolder).setLabel(`Shader: ${key}`),_map[key]=shader,_target||(_target=shader),_destination||(_destination=ShaderUIL.createOverride("OverrideDestination"+Utils.uuid(),uniforms,null,null))},_this.parent.setShaderVariant=function setShaderVariant(key){if(!(_target=_map[key]))throw`No Shader variant ${key}`}}));class Texture{constructor(img){this.magFilter=Texture.LINEAR,this.minFilter=Texture.LINEAR_MIPMAP,this.format=Texture.RGBAFormat,this.wrapS=this.wrapT=Texture.CLAMP_TO_EDGE,this._image=img,this.needsUpdate=!0,this.generateMipmaps=!0,this.anisotropy=1,this.type=Texture.UNSIGNED_BYTE,this.isTexture=!0,img&&img.onCreateTexture&&img.onCreateTexture(this)}set image(img){this._image=img,img&&img.onCreateTexture&&img.onCreateTexture(this)}get image(){return this._image}upload(){this._gl||Texture.renderer.upload(this)}destroy(){Texture.renderer.destroy(this),this._image=null}clone(){let texture=new Texture(this.img);return texture.format=this.format,texture.type=this.type,texture.anisotropy=this.anisotropy,texture.wrapS=this.wrapS,texture.wrapT=this.wrapT,texture.generateMipmaps=this.generateMipmaps,texture.minFilter=this.minFilter,texture.magFilter=this.magFilter,texture}}class DataTexture extends Texture{constructor(data,width,height,format,type,filter=null){super(),format&&(this.format=format),this.width=width,this.height=height,this.data=data,this.minFilter=this.magFilter=filter||Texture.NEAREST,this.generateMipmaps=!1,this.type=type||Texture.FLOAT,this.isDataTexture=!0,this.destroyDataAfterUpload=!1}uploadAsync(){return Texture.renderer.uploadAsync(this)}}class Texture3D extends Texture{constructor(image,width,height,depth,format,type,filter=null){super(),this.format=format||Texture.RGBAFormat,this.width=width,this.height=height,this.depth=depth,this.image=image,this.minFilter=this.magFilter=filter||Texture.LINEAR,this.wrapS=this.wrapT=this.wrapR=Texture.CLAMP_TO_EDGE,this.generateMipmaps=!1,this.type=type||Texture.FLOAT,this.isTexture3D=!0}}Texture.NEAREST="texture_nearest",Texture.CLAMP_TO_EDGE="texture_clamp",Texture.REPEAT="texture_repeat",Texture.MIRROR_REPEAT="texture_mirror_repeat",Texture.LINEAR="texture_linear",Texture.LINEAR_MIPMAP="texture_linear_mip",Texture.LINEAR_MIPMAP_NEAREST="texture_linear_mip_nearest",Texture.NEAREST_MIPMAP="texture_nearest_mip",Texture.RFormat="texture_rFormat",Texture.RGFormat="texture_rgFormat",Texture.RGBFormat="texture_rgbFormat",Texture.RGBAFormat="texture_rgbaFormat",Texture.UNSIGNED_BYTE="texture_unsigned_byte",Texture.DEPTH="texture_depth",Texture.FLOAT="texture_float",Texture.HALF_FLOAT="texture_half_float",Texture.UNSIGNED_INTEGER="texture_unsigned_integer",Texture.INTEGER="texture_integer",Module((function GLSLOptimizer(){this.exports=function(code){return function unrollLoops(string){return string.replace(/#pragma unroll_loop[\s]+?for \(int i \= (\d+)\; i < (\d+)\; i\+\+\) \{([\s\S]+?)(?=\})\}/g,(function replace(match,start,end,snippet){let unroll="";for(let i=parseInt(start);i<parseInt(end);i++)unroll+=snippet.replace(/\[i\]/g,"["+i+"]");return unroll}))}(code)}})),Module((function GLTypes(){function getFormat(texture){let _gl=Renderer.context,integer=texture.type===Texture.UNSIGNED_INTEGER||texture.type===Texture.INTEGER;switch(texture.format){case Texture.RGBAFormat:return integer?_gl.RGBA_INTEGER:_gl.RGBA;case Texture.RGBFormat:return integer?_gl.RGB_INTEGER:_gl.RGB;case Texture.RGFormat:return integer?_gl.RG_INTEGER:_gl.RG;case Texture.RFormat:return integer?_gl.RED_INTEGER:_gl.RED}}function getInternalFormat(texture){let _gl=Renderer.context;if(Renderer.type!==Renderer.WEBGL2)return texture.format===Texture.RGBAFormat?_gl.RGBA:_gl.RGB;switch(texture.format){case Texture.RGBAFormat:switch(texture.type){case Texture.FLOAT:return _gl.RGBA32F;case Texture.HALF_FLOAT:return _gl.RGBA16F;case Texture.UNSIGNED_INTEGER:return _gl.RGBA32UI;case Texture.INTEGER:return _gl.RGBA32I;case Texture.UNSIGNED_BYTE:return _gl.RGBA8}break;case Texture.RGBFormat:switch(texture.type){case Texture.FLOAT:return _gl.RGB32F;case Texture.HALF_FLOAT:return _gl.RGB16F;case Texture.UNSIGNED_INTEGER:return _gl.RGB32UI;case Texture.INTEGER:return _gl.RGB32I;case Texture.UNSIGNED_BYTE:return _gl.RGB8}break;case Texture.RGFormat:switch(texture.type){case Texture.FLOAT:return _gl.RG32F;case Texture.HALF_FLOAT:return _gl.RG16F;case Texture.UNSIGNED_INTEGER:return _gl.RG32UI;case Texture.INTEGER:return _gl.RG32I;case Texture.UNSIGNED_BYTE:return _gl.RG8}break;case Texture.RFormat:switch(texture.type){case Texture.FLOAT:return _gl.R32F;case Texture.HALF_FLOAT:return _gl.R16F;case Texture.UNSIGNED_INTEGER:return _gl.R32UI;case Texture.INTEGER:return _gl.R32I;case Texture.UNSIGNED_BYTE:return _gl.R8}}}function getType(texture){let _gl=Renderer.context;switch(texture.type){case Texture.FLOAT:return _gl.FLOAT;case Texture.HALF_FLOAT:return Renderer.type==Renderer.WEBGL2?_gl.HALF_FLOAT:Renderer.extensions.halfFloat.HALF_FLOAT_OES;case Texture.UNSIGNED_INTEGER:return _gl.UNSIGNED_INT;case Texture.INTEGER:return _gl.INT;default:return _gl.UNSIGNED_BYTE}}this.exports={getFormat:getFormat,getInternalFormat:getInternalFormat,getProperty:function getProperty(property){let _gl=Renderer.context;switch(property){case Texture.NEAREST:return _gl.NEAREST;case Texture.LINEAR:return _gl.LINEAR;case Texture.LINEAR_MIPMAP:return _gl.LINEAR_MIPMAP_LINEAR;case Texture.NEAREST_MIPMAP:return _gl.NEAREST_MIPMAP_LINEAR;case Texture.LINEAR_MIPMAP_NEAREST:return _gl.LINEAR_MIPMAP_NEAREST;case Texture.CLAMP_TO_EDGE:return _gl.CLAMP_TO_EDGE;case Texture.REPEAT:return _gl.REPEAT;case Texture.MIRROR_REPEAT:return _gl.MIRRORED_REPEAT}},getType:getType,getFloatParams:function getFloatParams(texture){return{internalformat:getInternalFormat(texture),format:getFormat(texture),type:getType(texture)}},getGLTypeForTypedArray:function getGLTypeForTypedArray(typedArray){let _gl=Renderer.context;return typedArray instanceof Float32Array?_gl.FLOAT:typedArray instanceof Int32Array?_gl.INT:typedArray instanceof Uint32Array?_gl.UNSIGNED_INT:typedArray instanceof Int16Array?_gl.SHORT:typedArray instanceof Uint16Array?_gl.UNSIGNED_SHORT:typedArray instanceof Int8Array?_gl.BYTE:typedArray instanceof Uint8Array||typedArray instanceof Uint8ClampedArray?_gl.UNSIGNED_BYTE:_gl.FLOAT}}})),Class((function MatrixWasm(){const _this=this;let registry,wasmExports;window.FinalizationRegistry&&(registry=new FinalizationRegistry((heldValue=>{wasmExports.free_matrix(heldValue.ptr)})));let promise=Promise.create();(async function loadWasm(){try{const bytes=Uint8Array.from(atob("AGFzbQEAAAABHAZgAX8Bf2AAAX9gAX8AYAAAYAN/f38AYAJ/fwACHgEDZW52FmVtc2NyaXB0ZW5fcmVzaXplX2hlYXAAAAMLCgMBAgQFAQABAgAEBQFwAQEBBQYBAYACgAIGCAF/AUGAjAQLB7YBCwZtZW1vcnkCABFfX3dhc21fY2FsbF9jdG9ycwABD2FsbG9jYXRlX21hdHJpeAACC2ZyZWVfbWF0cml4AAMRbXVsdGlwbHlfbWF0cmljZXMABApnZXRJbnZlcnNlAAUZX19pbmRpcmVjdF9mdW5jdGlvbl90YWJsZQEAEF9fZXJybm9fbG9jYXRpb24ABglzdGFja1NhdmUACAxzdGFja1Jlc3RvcmUACQpzdGFja0FsbG9jAAoKlDYKAgAL3h4BC38jAEEQayIKJAACQEGICCgCACIFQQl2IgBBA3EEQAJAIABBf3NBAXFBCWoiA0EDdCIBQbAIaiIAIAFBuAhqKAIAIgEoAggiBkYEQEGICCAFQX4gA3dxNgIADAELIAYgADYCDCAAIAY2AggLIAFBCGohACABIANBA3QiA0EDcjYCBCABIANqIgEgASgCBEEBcjYCBAwBCwJAAkACQAJAAkACQAJAAkACQAJAAkBBkAgoAgAiCEHIAE8NACAABEACQCAAQQl0QYB4cWgiAUEDdCIAQbAIaiIDIABBuAhqKAIAIgAoAggiAkYEQEGICCAFQX4gAXdxIgU2AgAMAQsgAiADNgIMIAMgAjYCCAsgAEHLADYCBCAAQcgAaiICIAFBA3QiAUHIAGsiA0EBcjYCBCAAIAFqIAM2AgAgCARAIAhBeHFBsAhqIQZBnAgoAgAhAQJ/IAVBASAIQQN2dCIEcUUEQEGICCAEIAVyNgIAIAYMAQsgBigCCAshBCAGIAE2AgggBCABNgIMIAEgBjYCDCABIAQ2AggLIABBCGohAEGcCCACNgIAQZAIIAM2AgAMDAtBjAgoAgAiBkUNACAGaEECdEG4CmooAgAiAigCBEF4cUHIAGshASACIQMDQAJAIAMoAhAiAEUEQCADKAIUIgBFDQELIAAoAgRBeHFByABrIgMgASABIANLIgMbIQEgACACIAMbIQIgACEDDAELCyACKAIYIQcgAiACKAIMIgRHBEBBmAgoAgAaIAIoAggiACAENgIMIAQgADYCCAwLCyACQRRqIgMoAgAiAEUEQCACKAIQIgBFDQIgAkEQaiEDCwNAIAMhCSAAIgRBFGoiAygCACIADQAgBEEQaiEDIAQoAhAiAA0ACyAJQQA2AgAMCgtBkAgoAgAiAEHIAE8EQEGcCCgCACEBAkAgAEHIAGsiA0EQTwRAIAFByABqIgIgA0EBcjYCBCAAIAFqIAM2AgAgAUHLADYCBAwBCyABIABBA3I2AgQgACABaiIAIAAoAgRBAXI2AgRBACEDC0GQCCADNgIAQZwIIAI2AgAgAUEIaiEADAsLQZQIKAIAIgJByABLBEBBlAggAkHIAGsiATYCAEGgCEGgCCgCACIAQcgAaiIDNgIAIAMgAUEBcjYCBCAAQcsANgIEIABBCGohAAwLC0EAIQACf0HgCygCAARAQegLKAIADAELQewLQn83AgBB5AtCgKCAgICABDcCAEHgCyAKQQxqQXBxQdiq1aoFczYCAEH0C0EANgIAQcQLQQA2AgBBgCALIgFB9wBqIgVBACABayIJcSIEQcgATQ0KQcALKAIAIgEEQEG4CygCACIDIARqIgcgA00NCyABIAdJDQsLAkBBxAstAABBBHFFBEACQAJAAkACQEGgCCgCACIBBEBByAshAANAIAEgACgCACIDTwRAIAMgACgCBGogAUsNAwsgACgCCCIADQALC0EAEAciAkF/Rg0DIAQhBUHkCygCACIAQQFrIgEgAnEEQCAFIAJrIAEgAmpBACAAa3FqIQULIAVByABNDQNBwAsoAgAiAARAQbgLKAIAIgEgBWoiAyABTQ0EIAAgA0kNBAsgBRAHIgAgAkcNAQwFCyAFIAJrIAlxIgUQByICIAAoAgAgACgCBGpGDQEgAiEACyAAQX9GDQEgBUH4AE8EQCAAIQIMBAtB6AsoAgAiAUH3ACAFa2pBACABa3EiARAHQX9GDQEgASAFaiEFIAAhAgwDCyACQX9HDQILQcQLQcQLKAIAQQRyNgIACyAEEAchAkEAEAchACACQX9GDQQgAEF/Rg0EIAAgAk0NBCAAIAJrIgVB8ABNDQQLQbgLQbgLKAIAIAVqIgA2AgBBvAsoAgAgAEkEQEG8CyAANgIACwJAQaAIKAIAIgEEQEHICyEAA0AgAiAAKAIAIgMgACgCBCIEakYNAiAAKAIIIgANAAsMAwtBmAgoAgAiAEEAIAAgAk0bRQRAQZgIIAI2AgALQQAhAEHMCyAFNgIAQcgLIAI2AgBBqAhBfzYCAEGsCEHgCygCADYCAEHUC0EANgIAA0AgAEEDdCIBQbgIaiABQbAIaiIDNgIAIAFBvAhqIAM2AgAgAEEBaiIAQSBHDQALQZQIIAVBKGsiAEF4IAJrQQdxIgFrIgM2AgBBoAggASACaiIBNgIAIAEgA0EBcjYCBCAAIAJqQSg2AgRBpAhB8AsoAgA2AgAMAwsgASACTw0BIAEgA0kNASAAKAIMQQhxDQEgACAEIAVqNgIEQaAIIAFBeCABa0EHcSIAaiIDNgIAQZQIQZQIKAIAIAVqIgIgAGsiADYCACADIABBAXI2AgQgASACakEoNgIEQaQIQfALKAIANgIADAILQQAhBAwIC0GYCCgCACACSwRAQZgIIAI2AgALIAIgBWohA0HICyEAAkACQAJAA0AgAyAAKAIARwRAIAAoAggiAA0BDAILCyAALQAMQQhxRQ0BC0HICyEAA0AgASAAKAIAIgNPBEAgAyAAKAIEaiIDIAFLDQMLIAAoAgghAAwACwALIAAgAjYCACAAIAAoAgQgBWo2AgQgAkF4IAJrQQdxaiIJQcsANgIEIANBeCADa0EHcWoiBSAJQcgAaiIGayEAIAEgBUYEQEGgCCAGNgIAQZQIQZQIKAIAIABqIgA2AgAgBiAAQQFyNgIEDAgLQZwIKAIAIAVGBEBBnAggBjYCAEGQCEGQCCgCACAAaiIANgIAIAYgAEEBcjYCBCAAIAZqIAA2AgAMCAsgBSgCBCIBQQNxQQFHDQYgAUF4cSEIIAFB/wFNBEAgAUEDdiEEIAUoAgwiASAFKAIIIgNGBEBBiAhBiAgoAgBBfiAEd3E2AgAMBwsgAyABNgIMIAEgAzYCCAwGCyAFKAIYIQcgBSAFKAIMIgJHBEAgBSgCCCIBIAI2AgwgAiABNgIIDAULIAVBFGoiAygCACIBRQRAIAUoAhAiAUUNBCAFQRBqIQMLA0AgAyEEIAEiAkEUaiIDKAIAIgENACACQRBqIQMgAigCECIBDQALIARBADYCAAwEC0GUCCAFQShrIgBBeCACa0EHcSIEayIJNgIAQaAIIAIgBGoiBDYCACAEIAlBAXI2AgQgACACakEoNgIEQaQIQfALKAIANgIAIAEgA0EnIANrQQdxakEvayIAIAAgAUEQakkbIgRBGzYCBCAEQdALKQIANwIQIARByAspAgA3AghB0AsgBEEIajYCAEHMCyAFNgIAQcgLIAI2AgBB1AtBADYCACAEQRhqIQADQCAAQQc2AgQgAEEIaiECIABBBGohACACIANJDQALIAEgBEYNACAEIAQoAgRBfnE2AgQgASAEIAFrIgJBAXI2AgQgBCACNgIAIAJB/wFNBEAgAkF4cUGwCGohAAJ/QYgIKAIAIgNBASACQQN2dCICcUUEQEGICCACIANyNgIAIAAMAQsgACgCCAshAyAAIAE2AgggAyABNgIMIAEgADYCDCABIAM2AggMAQtBHyEAIAJB////B00EQCACQSYgAkEIdmciAGt2QQFxIABBAXRrQT5qIQALIAEgADYCHCABQgA3AhAgAEECdEG4CmohAwJAAkBBjAgoAgAiBEEBIAB0IgVxRQRAQYwIIAQgBXI2AgAgAyABNgIAIAEgAzYCGAwBCyACQRkgAEEBdmtBACAAQR9HG3QhACADKAIAIQQDQCAEIgMoAgRBeHEgAkYNAiAAQR12IQQgAEEBdCEAIAMgBEEEcWpBEGoiBSgCACIEDQALIAUgATYCACABIAM2AhgLIAEgATYCDCABIAE2AggMAQsgAygCCCIAIAE2AgwgAyABNgIIIAFBADYCGCABIAM2AgwgASAANgIIC0GUCCgCACIAQcgATQ0AQZQIIABByABrIgE2AgBBoAhBoAgoAgAiAEHIAGoiAzYCACADIAFBAXI2AgQgAEHLADYCBCAAQQhqIQAMBwtBhAhBMDYCAEEAIQAMBgtBACECCyAHRQ0AAkAgBSgCHCIDQQJ0QbgKaiIBKAIAIAVGBEAgASACNgIAIAINAUGMCEGMCCgCAEF+IAN3cTYCAAwCCyAHQRBBFCAHKAIQIAVGG2ogAjYCACACRQ0BCyACIAc2AhggBSgCECIBBEAgAiABNgIQIAEgAjYCGAsgBSgCFCIBRQ0AIAIgATYCFCABIAI2AhgLIAAgCGohACAFIAhqIgUoAgQhAQsgBSABQX5xNgIEIAYgAEEBcjYCBCAAIAZqIAA2AgAgAEH/AU0EQCAAQXhxQbAIaiEBAn9BiAgoAgAiA0EBIABBA3Z0IgBxRQRAQYgIIAAgA3I2AgAgAQwBCyABKAIICyEAIAEgBjYCCCAAIAY2AgwgBiABNgIMIAYgADYCCAwBC0EfIQEgAEH///8HTQRAIABBJiAAQQh2ZyIBa3ZBAXEgAUEBdGtBPmohAQsgBiABNgIcIAZCADcCECABQQJ0QbgKaiEDAkACQEGMCCgCACICQQEgAXQiBHFFBEBBjAggAiAEcjYCACADIAY2AgAgBiADNgIYDAELIABBGSABQQF2a0EAIAFBH0cbdCEBIAMoAgAhAgNAIAIiAygCBEF4cSAARg0CIAFBHXYhAiABQQF0IQEgAyACQQRxakEQaiIEKAIAIgINAAsgBCAGNgIAIAYgAzYCGAsgBiAGNgIMIAYgBjYCCAwBCyADKAIIIgAgBjYCDCADIAY2AgggBkEANgIYIAYgAzYCDCAGIAA2AggLIAlBCGohAAwBCwJAIAdFDQACQCACKAIcIgNBAnRBuApqIgAoAgAgAkYEQCAAIAQ2AgAgBA0BQYwIIAZBfiADd3E2AgAMAgsgB0EQQRQgBygCECACRhtqIAQ2AgAgBEUNAQsgBCAHNgIYIAIoAhAiAARAIAQgADYCECAAIAQ2AhgLIAIoAhQiAEUNACAEIAA2AhQgACAENgIYCwJAIAFBD00EQCACIAFByABqIgBBA3I2AgQgACACaiIAIAAoAgRBAXI2AgQMAQsgAkHLADYCBCACQcgAaiIDIAFBAXI2AgQgASADaiABNgIAIAgEQCAIQXhxQbAIaiEGQZwIKAIAIQACf0EBIAhBA3Z0IgQgBXFFBEBBiAggBCAFcjYCACAGDAELIAYoAggLIQQgBiAANgIIIAQgADYCDCAAIAY2AgwgACAENgIIC0GcCCADNgIAQZAIIAE2AgALIAJBCGohAAsgCkEQaiQAIAAL2QsBB38CQCAAIgNFDQAgA0EIayICIANBBGsoAgAiAUF4cSIDaiEFAkAgAUEBcQ0AIAFBA3FFDQEgAiACKAIAIgFrIgJBmAgoAgBJDQEgASADaiEDAkACQEGcCCgCACACRwRAIAFB/wFNBEAgAUEDdiEHIAIoAgwiASACKAIIIgBGBEBBiAhBiAgoAgBBfiAHd3E2AgAMBQsgACABNgIMIAEgADYCCAwECyACKAIYIQYgAiACKAIMIgRHBEAgAigCCCIBIAQ2AgwgBCABNgIIDAMLIAJBFGoiACgCACIBRQRAIAIoAhAiAUUNAiACQRBqIQALA0AgACEHIAEiBEEUaiIAKAIAIgENACAEQRBqIQAgBCgCECIBDQALIAdBADYCAAwCCyAFKAIEIgFBA3FBA0cNAkGQCCADNgIAIAUgAUF+cTYCBCACIANBAXI2AgQgBSADNgIADAMLQQAhBAsgBkUNAAJAIAIoAhwiAEECdEG4CmoiASgCACACRgRAIAEgBDYCACAEDQFBjAhBjAgoAgBBfiAAd3E2AgAMAgsgBkEQQRQgBigCECACRhtqIAQ2AgAgBEUNAQsgBCAGNgIYIAIoAhAiAQRAIAQgATYCECABIAQ2AhgLIAIoAhQiAUUNACAEIAE2AhQgASAENgIYCyACIAVPDQAgBSgCBCIBQQFxRQ0AAkACQAJAAkAgAUECcUUEQEGgCCgCACAFRgRAQaAIIAI2AgBBlAhBlAgoAgAgA2oiAzYCACACIANBAXI2AgQgAkGcCCgCAEcNBkGQCEEANgIAQZwIQQA2AgAMBgtBnAgoAgAgBUYEQEGcCCACNgIAQZAIQZAIKAIAIANqIgM2AgAgAiADQQFyNgIEIAIgA2ogAzYCAAwGCyABQXhxIANqIQMgAUH/AU0EQCABQQN2IQcgBSgCDCIBIAUoAggiAEYEQEGICEGICCgCAEF+IAd3cTYCAAwFCyAAIAE2AgwgASAANgIIDAQLIAUoAhghBiAFIAUoAgwiBEcEQEGYCCgCABogBSgCCCIBIAQ2AgwgBCABNgIIDAMLIAVBFGoiACgCACIBRQRAIAUoAhAiAUUNAiAFQRBqIQALA0AgACEHIAEiBEEUaiIAKAIAIgENACAEQRBqIQAgBCgCECIBDQALIAdBADYCAAwCCyAFIAFBfnE2AgQgAiADQQFyNgIEIAIgA2ogAzYCAAwDC0EAIQQLIAZFDQACQCAFKAIcIgBBAnRBuApqIgEoAgAgBUYEQCABIAQ2AgAgBA0BQYwIQYwIKAIAQX4gAHdxNgIADAILIAZBEEEUIAYoAhAgBUYbaiAENgIAIARFDQELIAQgBjYCGCAFKAIQIgEEQCAEIAE2AhAgASAENgIYCyAFKAIUIgFFDQAgBCABNgIUIAEgBDYCGAsgAiADQQFyNgIEIAIgA2ogAzYCACACQZwIKAIARw0AQZAIIAM2AgAMAQsgA0H/AU0EQCADQXhxQbAIaiEBAn9BiAgoAgAiAEEBIANBA3Z0IgNxRQRAQYgIIAAgA3I2AgAgAQwBCyABKAIICyEDIAEgAjYCCCADIAI2AgwgAiABNgIMIAIgAzYCCAwBC0EfIQEgA0H///8HTQRAIANBJiADQQh2ZyIBa3ZBAXEgAUEBdGtBPmohAQsgAiABNgIcIAJCADcCECABQQJ0QbgKaiEAAkACQAJAQYwIKAIAIgRBASABdCIFcUUEQEGMCCAEIAVyNgIAIAAgAjYCACACIAA2AhgMAQsgA0EZIAFBAXZrQQAgAUEfRxt0IQEgACgCACEEA0AgBCIAKAIEQXhxIANGDQIgAUEddiEEIAFBAXQhASAAIARBBHFqQRBqIgUoAgAiBA0ACyAFIAI2AgAgAiAANgIYCyACIAI2AgwgAiACNgIIDAELIAAoAggiAyACNgIMIAAgAjYCCCACQQA2AhggAiAANgIMIAIgAzYCCAtBqAhBqAgoAgBBAWsiAkF/IAIbNgIACwuIAgEEeyACIAH9CQIMIAD9AAIwIgP95gEgAf0JAgggAP0AAiAiBP3mASAB/QkCACAA/QACACIF/eYBIAD9AAIQIgYgAf0JAgT95gH95AH95AH95AH9CwIAIAIgAyAB/QkCHP3mASAEIAH9CQIY/eYBIAUgAf0JAhD95gEgBiAB/QkCFP3mAf3kAf3kAf3kAf0LAhAgAiADIAH9CQIs/eYBIAQgAf0JAij95gEgBSAB/QkCIP3mASAGIAH9CQIk/eYB/eQB/eQB/eQB/QsCICACIAMgAf0JAjz95gEgBCAB/QkCOP3mASAFIAH9CQIw/eYBIAYgAf0JAjT95gH95AH95AH95AH9CwIwC9YIAil9AXsgASoCDCICIAEqAhQiDSABKgIgIguUIhEgASoCOCIIlCABKgIQIgwgASoCNCISlCITIAEqAigiCZQgASoCJCIUIAEqAjAiDpQiGSABKgIYIgeUIAcgCyASlCIalJMgDSAOlCIbIAmUk5KSIAwgFJQiHCAIlJMiFZQgASoCCCIKIBwgASoCPCIDlCAbIAEqAiwiBJQgGiABKgIcIgWUIAUgGZSTkiATIASUkyARIAOUk5IiFpQgASoCACIPIA0gCZQiHyADlCAHIBKUIiAgBJQgFCAIlCIhIAWUIAUgCSASlCIilJOSIA0gCJQiIyAElJMgByAUlCIkIAOUk5IiF5QgASoCBCIQIAcgC5QiJSADlCAMIAiUIiYgBJQgCSAOlCInIAWUIAUgCyAIlCIolJMgByAOlCIpIASUk5KSIAwgCZQiKiADlJMiGJSSkpIiBkMAAAAAWwRAIABBgICA/AM2AiggAEGAgID8AzYCPCAA/QwAAAAAAAAAAAAAAAAAAIA//QsCCCAAQYCAgPwDNgIAIAD9DAAAAAAAAAAAAAAAAAAAAAD9CwIYIAAgK/0LAiwgAEMAAAAAOAIEDwsgACAVQwAAgD8gBpUiBpQ4AjAgACAWIAaUOAIgIAAgGCAGlDgCECAAIBcgBpQ4AgAgACAPIA2UIhUgCZQgECALlCIWIAeUIBwgCpQgCiARjJSSkiAPIBSUIhcgB5STIBAgDJQiGCAJlJOSIAaUOAI8IAAgGCAIlCAPIBKUIh0gB5QgGyAKlCAKIBOMlJIgECAOlCIeIAeUk5KSIBUgCJSTIAaUOAI4IAAgFyAIlCAeIAmUIBogCpQgCiAZjJSSkiAdIAmUkyAWIAiUk5IgBpQ4AjQgACAYIASUIBcgBZQgESAClCACIByMlJIgFiAFlJOSkiAVIASUkyAGlDgCLCAAIBUgA5QgHiAFlCATIAKUIAIgG4yUkpIgHSAFlJMgGCADlJOSIAaUOAIoIAAgFiADlCAdIASUIBkgApQgAiAajJSSIB4gBJSTkpIgFyADlJMgBpQ4AiQgACAPIAeUIhEgBJQgCiALlCILIAWUICogApQgAiAllJOSIA8gCZQiEyAFlJMgCiAMlCIMIASUk5IgBpQ4AhwgACAMIAOUIA8gCJQiDCAFlCApIAKUIAIgJpSTIAogDpQiDiAFlJOSkiARIAOUkyAGlDgCGCAAIBMgA5QgDiAElCAoIAKUIAIgJ5STkiAMIASUkyALIAOUk5IgBpQ4AhQgACAKIA2UIg0gBJQgECAJlCIJIAWUICQgApQgAiAflJMgCiAUlCILIAWUk5KSIBAgB5QiByAElJMgBpQ4AgwgACAHIAOUIAogEpQiByAFlCAjIAKUIAIgIJSTkiAQIAiUIgggBZSTIA0gA5STkiAGlDgCCCAAIAsgA5QgCCAElCAiIAKUIAIgIZSTIAcgBJSTkpIgCSADlJMgBpQ4AgQLBQBBhAgLTwECf0GACCgCACIBIABBB2pBeHEiAmohAAJAIAJBACAAIAFNGw0AIAA/AEEQdEsEQCAAEABFDQELQYAIIAA2AgAgAQ8LQYQIQTA2AgBBfwsEACMACwYAIAAkAAsQACMAIABrQXBxIgAkACAACwsJAQBBgQgLAgYB"),(c=>c.charCodeAt(0))),module=await WebAssembly.compile(bytes),memory=new WebAssembly.Memory({initial:5});const moduleImports={env:{memory:memory,emscripten_resize_heap:function emscripten_resize_heap(newSize){const currentPages=memory.buffer.byteLength/65536,requiredPages=Math.ceil(newSize/65536);if(!(requiredPages>currentPages))return!1;{const pagesToGrow=requiredPages-currentPages;try{return memory.grow(pagesToGrow),function onMemoryGrowth(newBuffer){console.log("Memory grew!"),currentBuffer=newBuffer}(memory.buffer),!0}catch(error){return console.error("Failed to resize heap:",error),!1}}}}},instance=await WebAssembly.instantiate(module,moduleImports);let currentBuffer=memory.buffer;return instance.exports}catch(e){}})().then((exports=>{promise.resolve(),exports&&(wasmExports=exports,_this.multiply=function(a,b,c){a.elements.ptr||_this.allocate(a),b.elements.ptr||_this.allocate(b),c.elements.ptr||_this.allocate(c),wasmExports.multiply_matrices(a.elements.ptr,b.elements.ptr,c.elements.ptr)},_this.getInverse=function(out,m){out.elements.ptr||_this.allocate(out),m.elements.ptr||_this.allocate(m),wasmExports.getInverse(out.elements.ptr,m.elements.ptr)})}));const _identity=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);_this.allocate=function(ref){if(ref.elements?.ptr)return;if(!wasmExports)return void(ref.elements||(ref.elements=_identity.slice()));const ptr=wasmExports.allocate_matrix(),elements=new Float32Array(wasmExports.memory.buffer,ptr,16);elements.set(ref.elements||_identity,0),elements.ptr=ptr,ref.elements=elements,registry?.register(ref,ref.elements)},_this.ready=function(){return promise}}),"static"),Module((function ShaderCode(){let textureExpression=/texture(2D|Cube)?(\w+)?\s*\(/g;function removeUBO(code,name){let uniforms=code.split(`uniform ${name} {`)[1];uniforms=uniforms.split("};")[0],uniforms=uniforms.split("\n"),uniforms.forEach((u=>{(u=u.trim()).length&&(code=code.replace(u,"uniform "+u))}));let split=code.split(`uniform ${name} {`);return split[1]=split[1].replace("};",""),code=(code=split.join("")).replace(`uniform ${name} {`,"")}this.exports={convertWebGL1:function convertWebGL1(code,type){return(code=(code=code.replace("#version 300 es","")).replace("out vec4 FragColor;","")).includes("samplerExternalOES")&&(code=code.replace("samplerExternalOES","sampler2D")),(code=code.replace(textureExpression,(function(match,samplerType,suffix="",offset,origCode){if(!samplerType){let name=origCode.substring(offset+match.length).split(",",1)[0]?.trim();name&&(samplerType=new RegExp(`sampler(\\w+)\\s+${name}`).exec(origCode)?.[1]),samplerType||(samplerType="2D")}if(suffix.endsWith("EXT")&&(suffix=suffix.slice(0,-3)),"vs"===type&&["Lod","ProjLod"].includes(suffix))return`texture${samplerType}${suffix}(`;if(["Lod","Grad","ProjLod","ProjGrad"].includes(suffix)){if(Renderer.extensions.lod)return`texture${samplerType}${suffix}EXT(`;suffix.endsWith("Lod")&&(suffix=suffix.slice(0,-3))}return`texture${samplerType}${suffix}(`}))).includes("uniform global {")&&(code=removeUBO(code,"global")),code.includes("uniform ubo {")&&(code=removeUBO(code,"ubo")),code.includes("uniform lights {")&&(code=removeUBO(code,"lights")),code},convertWebGL2:function convertWebGL2(code,type){return!(code=(code="vs"==type?(code=code.replace(/attribute/g,"in")).replace(/varying/g,"out"):code.replace(/varying/g,"in")).replace(textureExpression,(function(match,samplerType,suffix=""){return suffix.endsWith("EXT")&&(suffix=suffix.slice(0,-3)),`texture${suffix}(`}))).includes("samplerExternalOES")||"android"==Device.system.os&&window.AURA||(code=code.replace("samplerExternalOES","sampler2D")),Renderer.UBO?(code.includes("uniform global {")&&(code=code.replace("uniform global","layout(std140) uniform global")),code.includes("uniform ubo {")&&(code=code.replace("uniform ubo","layout(std140) uniform ubo")),Lighting.UBO?code.includes("uniform lights {")&&(code=code.replace("uniform lights","layout(std140) uniform lights")):code.includes("uniform lights {")&&(code=removeUBO(code,"lights"))):(code.includes("uniform global {")&&(code=removeUBO(code,"global")),code.includes("uniform ubo {")&&(code=removeUBO(code,"ubo")),code.includes("uniform lights {")&&(code=removeUBO(code,"lights"))),code}}}));class UBO{constructor(location,gl=Renderer.context){this.gl=gl,this.arrays=[];for(let i=0;i<30;i++)this.arrays.push([]);this.arrayIndex=0,this.objects=[],this.location=location,this.data=null,this.lastUpdate=0}_getSize(uniform){let obj=uniform.value;return Array.isArray(obj)?uniform.components?obj.length/uniform.components*16:16*obj.length:obj instanceof Vector2?8:obj instanceof Vector3||obj instanceof Vector4||obj instanceof Color?16:obj instanceof Matrix4?64:obj instanceof Matrix3?48:obj instanceof Quaternion?16:4}_getValues(uniform){let obj=uniform.value;return Array.isArray(obj)?obj:obj instanceof Vector2?this._array(obj.x,obj.y):obj instanceof Vector3?this._array(obj.x,obj.y,obj.z):obj instanceof Matrix4||obj instanceof Matrix3?obj.elements:obj instanceof Color?this._array(obj.r,obj.g,obj.b):obj instanceof Quaternion?this._array(obj.x,obj.y,obj.z,obj.w):this._array(obj)}_array(){this.arrayIndex++>=this.arrays.length-1&&(this.arrayIndex=0);let array=this.arrays[this.arrayIndex];return array.length=0,array.push.apply(array,arguments),array}clear(){for(let i=0;i<this.arrays.length;i++)this.arrays[i].length=0}calculate(){let len=this.objects.length,chunk=16,tsize=0,offset=0,size=0;for(let i=0;i<len;i++){let obj=this.objects[i];size=this._getSize(obj),tsize=chunk-size,tsize<0&&chunk<16?(offset+=chunk,i>0&&(this.objects[i-1].chunkLen+=chunk),chunk=16):tsize<0&&16==chunk||(0==tsize?chunk=16:chunk-=size),obj.offset=offset/4,obj.chunkLen=size/4,obj.dataLen=size/4,offset+=size}return offset%16!=0&&(this.objects[this.objects.length-1].chunkLen+=chunk/4,offset+=chunk),offset/4}compileData(){let i,array=this._array(),len=this.calculate();for(i=0;i<len;i++)array[i]=0;for(i=0;i<this.objects.length;i++){let obj=this.objects[i],values=this._getValues(obj);for(let j=0;j<values.length;j++)array[obj.offset+j]=values[j]}return array}upload(){if(this.data)return;let gl=Renderer.context,array=this.compileData();array.length&&(this.data=new Float32Array(array),this.buffer=gl.createBuffer(),gl.bindBuffer(gl.UNIFORM_BUFFER,this.buffer),gl.bufferData(gl.UNIFORM_BUFFER,this.data,gl.DYNAMIC_DRAW),gl.bindBuffer(gl.UNIFORM_BUFFER,null),gl.bindBufferBase(gl.UNIFORM_BUFFER,this.location,this.buffer))}bind(program,name){this.data||this.upload(),this.needsUpdate&&this.update();let location,gl=Renderer.context;location=program==this.lastProgram&&name==this.lastName&&void 0!==this.lastLocation?this.lastLocation:gl.getUniformBlockIndex(program,name),location>99999||-1==location||(gl.uniformBlockBinding(program,location,this.location),gl.bindBufferBase(gl.UNIFORM_BUFFER,this.location,this.buffer),this.lastProgram=program,this.lastName=name,this.lastLocation=location)}update(){if(this.data||this.upload(),!this.data)return;let gl=Renderer.context,array=this.compileData();array.length!=this.data.length&&(this.data=new Float32Array(array),this.upload()),this.data.set(array),gl.bindBuffer(gl.UNIFORM_BUFFER,this.buffer),gl.bufferSubData(gl.UNIFORM_BUFFER,0,this.data),gl.bindBuffer(gl.UNIFORM_BUFFER,null),this.needsUpdate=!1}unbind(){}push(){if(this.data)throw"Can't modify UBO after initial upload!";for(let i=0;i<arguments.length;i++)this.objects.push(arguments[i])}destroy(){this.gl.deleteBuffer(this.buffer)}}class VAO{constructor(gl){this.gl=gl,this.WEBGL2=Renderer.type==Renderer.WEBGL2,this.WEBGL2?this.vao=gl.createVertexArray():this.vao=Renderer.extensions.VAO.createVertexArrayOES()}bind(){const gl=this.gl;this.WEBGL2?gl.bindVertexArray(this.vao):Renderer.extensions.VAO.bindVertexArrayOES(this.vao)}unbind(){const gl=this.gl;this.WEBGL2?gl.bindVertexArray(null):Renderer.extensions.VAO.bindVertexArrayOES(null)}destroy(){const gl=this.gl;this.WEBGL2?gl.deleteVertexArray(this.vao):Renderer.extensions.VAO.deleteVertexArrayOES(this.vao),this.vao=null}}class BoxGeometry extends Geometry{constructor(width=1,height=1,depth=1,widthSegments=1,heightSegments=1,depthSegments=1){super(),widthSegments=Math.floor(widthSegments),heightSegments=Math.floor(heightSegments),depthSegments=Math.floor(depthSegments);let indices=[],vertices=[],normals=[],uvs=[],numberOfVertices=0;function buildPlane(u,v,w,udir,vdir,width,height,depth,gridX,gridY,materialIndex){let ix,iy,segmentWidth=width/gridX,segmentHeight=height/gridY,widthHalf=width/2,heightHalf=height/2,depthHalf=depth/2,gridX1=gridX+1,gridY1=gridY+1,vertexCounter=0,vector=new Vector3;for(iy=0;iy<gridY1;iy++){let y=iy*segmentHeight-heightHalf;for(ix=0;ix<gridX1;ix++){let x=ix*segmentWidth-widthHalf;vector[u]=x*udir,vector[v]=y*vdir,vector[w]=depthHalf,vertices.push(vector.x,vector.y,vector.z),vector[u]=0,vector[v]=0,vector[w]=depth>0?1:-1,normals.push(vector.x,vector.y,vector.z),uvs.push(ix/gridX),uvs.push(1-iy/gridY),vertexCounter+=1}}for(iy=0;iy<gridY;iy++)for(ix=0;ix<gridX;ix++){let a=numberOfVertices+ix+gridX1*iy,b=numberOfVertices+ix+gridX1*(iy+1),c=numberOfVertices+(ix+1)+gridX1*(iy+1),d=numberOfVertices+(ix+1)+gridX1*iy;indices.push(a,b,d),indices.push(b,c,d)}numberOfVertices+=vertexCounter}buildPlane("z","y","x",-1,-1,depth,height,width,depthSegments,heightSegments,0),buildPlane("z","y","x",1,-1,depth,height,-width,depthSegments,heightSegments,1),buildPlane("x","z","y",1,1,width,depth,height,widthSegments,depthSegments,2),buildPlane("x","z","y",1,-1,width,depth,-height,widthSegments,depthSegments,3),buildPlane("x","y","z",1,-1,width,height,depth,widthSegments,heightSegments,4),buildPlane("x","y","z",-1,-1,width,height,-depth,widthSegments,heightSegments,5),this.index=new(Geometry.arrayNeedsUint32(indices)?Uint32Array:Uint16Array)(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class CircleGeometry extends Geometry{constructor(radius=1,segments=8,thetaStart=0,thetaLength=2*Math.PI){super();var i,s,indices=[],vertices=[],normals=[],uvs=[],vertex=new Vector3,uv=new Vector2;for(vertices.push(0,0,0),normals.push(0,0,1),uvs.push(.5,.5),s=0,i=3;s<=segments;s++,i+=3){var segment=thetaStart+s/segments*thetaLength;vertex.x=radius*Math.cos(segment),vertex.y=radius*Math.sin(segment),vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,0,1),uv.x=(vertices[i]/radius+1)/2,uv.y=(vertices[i+1]/radius+1)/2,uvs.push(uv.x,uv.y)}for(i=1;i<=segments;i++)indices.push(i,i+1,0);this.index=new(Geometry.arrayNeedsUint32(indices)?Uint32Array:Uint16Array)(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class CylinderGeometry extends Geometry{constructor(radiusTop=1,radiusBottom=1,height=1,radialSegments=8,heightSegments=1,openEnded=!1,thetaStart=0,thetaLength=2*Math.PI,planarMapping=!1){super(),radialSegments=Math.floor(radialSegments),heightSegments=Math.floor(heightSegments);let indices=[],vertices=[],normals=[],uvs=[],index=0,indexArray=[],halfHeight=height/2;function generateCap(top){let x,centerIndexStart,centerIndexEnd,uv=new Vector2,vertex=new Vector3,radius=!0===top?radiusTop:radiusBottom,sign=!0===top?1:-1,signV=planarMapping?1:sign;for(centerIndexStart=index,x=1;x<=radialSegments;x++)vertices.push(0,halfHeight*sign,0),normals.push(0,sign,0),uvs.push(.5,.5),index++;for(centerIndexEnd=index,x=0;x<=radialSegments;x++){let theta=x/radialSegments*thetaLength+thetaStart,cosTheta=Math.cos(theta),sinTheta=Math.sin(theta);vertex.x=radius*sinTheta,vertex.y=halfHeight*sign,vertex.z=radius*cosTheta,vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,sign,0),uv.x=.5*cosTheta+.5,uv.y=.5*sinTheta*signV+.5,uvs.push(uv.x,uv.y),index++}for(x=0;x<radialSegments;x++){let c=centerIndexStart+x,i=centerIndexEnd+x;!0===top?indices.push(i,i+1,c):indices.push(i+1,i,c)}}!function generateTorso(){let x,y,uv=new Vector2,normal=new Vector3,vertex=new Vector3,slope=(radiusBottom-radiusTop)/height;for(y=0;y<=heightSegments;y++){let indexRow=[],v=y/heightSegments,radius=v*(radiusBottom-radiusTop)+radiusTop;for(x=0;x<=radialSegments;x++){let u=x/radialSegments,theta=u*thetaLength+thetaStart,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta);vertex.x=radius*sinTheta,vertex.y=-v*height+halfHeight,vertex.z=radius*cosTheta,vertices.push(vertex.x,vertex.y,vertex.z),normal.set(sinTheta,slope,cosTheta).normalize(),normals.push(normal.x,normal.y,normal.z),planarMapping?(uv.x=.5*cosTheta+.5,uv.y=.5*sinTheta+.5,uvs.push(uv.x,uv.y)):uvs.push(u,1-v),indexRow.push(index++)}indexArray.push(indexRow)}for(x=0;x<radialSegments;x++)for(y=0;y<heightSegments;y++){let a=indexArray[y][x],b=indexArray[y+1][x],c=indexArray[y+1][x+1],d=indexArray[y][x+1];indices.push(a,b,d),indices.push(b,c,d)}}(),!1===openEnded&&(radiusTop>0&&generateCap(!0),radiusBottom>0&&generateCap(!1)),this.index=new(Geometry.arrayNeedsUint32(indices)?Uint32Array:Uint16Array)(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class ConeGeometry extends CylinderGeometry{constructor(radius,height,radialSegments,heightSegments,openEnded,thetaStart,thetaLength){super(0,radius,height,radialSegments,heightSegments,openEnded,thetaStart,thetaLength)}}class PlaneGeometry extends Geometry{constructor(width=1,height=1,widthSegments=1,heightSegments=1){super();let ix,iy,width_half=width/2,height_half=height/2,gridX=Math.floor(widthSegments)||1,gridY=Math.floor(heightSegments)||1,gridX1=gridX+1,gridY1=gridY+1,segment_width=width/gridX,segment_height=height/gridY,indices=[],vertices=[],normals=[],uvs=[];for(iy=0;iy<gridY1;iy++){let y=iy*segment_height-height_half;for(ix=0;ix<gridX1;ix++){let x=ix*segment_width-width_half;vertices.push(x,-y,0),normals.push(0,0,1),uvs.push(ix/gridX),uvs.push(1-iy/gridY)}}for(iy=0;iy<gridY;iy++)for(ix=0;ix<gridX;ix++){let a=ix+gridX1*iy,b=ix+gridX1*(iy+1),c=ix+1+gridX1*(iy+1),d=ix+1+gridX1*iy;indices.push(a,b,d),indices.push(b,c,d)}this.index=new(Geometry.arrayNeedsUint32(indices)?Uint32Array:Uint16Array)(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class PolyhedronGeometry extends Geometry{constructor(vertices,indices=[],radius=1,detail=0){super();let vertexBuffer=[],uvBuffer=[];function subdivideFace(a,b,c,detail){var i,j,cols=Math.pow(2,detail),v=[];for(i=0;i<=cols;i++){v[i]=[];var aj=a.clone().lerp(c,i/cols),bj=b.clone().lerp(c,i/cols),rows=cols-i;for(j=0;j<=rows;j++)v[i][j]=0===j&&i===cols?aj:aj.clone().lerp(bj,j/rows)}for(i=0;i<cols;i++)for(j=0;j<2*(cols-i)-1;j++){var k=Math.floor(j/2);j%2==0?(pushVertex(v[i][k+1]),pushVertex(v[i+1][k]),pushVertex(v[i][k])):(pushVertex(v[i][k+1]),pushVertex(v[i+1][k+1]),pushVertex(v[i+1][k]))}}function pushVertex(vertex){vertexBuffer.push(vertex.x,vertex.y,vertex.z)}function getVertexByIndex(index,vertex){let stride=3*index;vertex.x=vertices[stride+0],vertex.y=vertices[stride+1],vertex.z=vertices[stride+2]}function correctUV(uv,stride,vector,azimuth){azimuth<0&&1===uv.x&&(uvBuffer[stride]=uv.x-1),0===vector.x&&0===vector.z&&(uvBuffer[stride]=azimuth/2/Math.PI+.5)}function azimuth(vector){return Math.atan2(vector.z,-vector.x)}!function subdivide(detail){let a=new Vector3,b=new Vector3,c=new Vector3;for(let i=0;i<indices.length;i+=3)getVertexByIndex(indices[i+0],a),getVertexByIndex(indices[i+1],b),getVertexByIndex(indices[i+2],c),subdivideFace(a,b,c,detail)}(detail),function appplyRadius(radius){for(var vertex=new Vector3,i=0;i<vertexBuffer.length;i+=3)vertex.x=vertexBuffer[i+0],vertex.y=vertexBuffer[i+1],vertex.z=vertexBuffer[i+2],vertex.normalize().multiplyScalar(radius),vertexBuffer[i+0]=vertex.x,vertexBuffer[i+1]=vertex.y,vertexBuffer[i+2]=vertex.z}(radius),function generateUVs(){let vertex=new Vector3;for(let i=0;i<vertexBuffer.length;i+=3){vertex.x=vertexBuffer[i+0],vertex.y=vertexBuffer[i+1],vertex.z=vertexBuffer[i+2];let u=azimuth(vertex)/2/Math.PI+.5,v=(vector=vertex,Math.atan2(-vector.y,Math.sqrt(vector.x*vector.x+vector.z*vector.z))/Math.PI+.5);uvBuffer.push(u,1-v)}var vector;(function correctUVs(){let a=new Vector3,b=new Vector3,c=new Vector3,centroid=new Vector3,uvA=new Vector2,uvB=new Vector2,uvC=new Vector2;for(let i=0,j=0;i<vertexBuffer.length;i+=9,j+=6){a.set(vertexBuffer[i+0],vertexBuffer[i+1],vertexBuffer[i+2]),b.set(vertexBuffer[i+3],vertexBuffer[i+4],vertexBuffer[i+5]),c.set(vertexBuffer[i+6],vertexBuffer[i+7],vertexBuffer[i+8]),uvA.set(uvBuffer[j+0],uvBuffer[j+1]),uvB.set(uvBuffer[j+2],uvBuffer[j+3]),uvC.set(uvBuffer[j+4],uvBuffer[j+5]),centroid.copy(a).add(b).add(c).divideScalar(3);let azi=azimuth(centroid);correctUV(uvA,j+0,a,azi),correctUV(uvB,j+2,b,azi),correctUV(uvC,j+4,c,azi)}})(),function correctSeam(){for(let i=0;i<uvBuffer.length;i+=6){let x0=uvBuffer[i+0],x1=uvBuffer[i+2],x2=uvBuffer[i+4],max=Math.max(x0,x1,x2),min=Math.min(x0,x1,x2);max>.9&&min<.1&&(x0<.2&&(uvBuffer[i+0]+=1),x1<.2&&(uvBuffer[i+2]+=1),x2<.2&&(uvBuffer[i+4]+=1))}}()}(),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertexBuffer),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(vertexBuffer.slice()),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvBuffer),2)),0===detail?this.computeVertexNormals():this.normalizeNormals()}}class IcosahedronGeometry extends PolyhedronGeometry{constructor(radius,detail){let t=(1+Math.sqrt(5))/2;super([-1,t,0,1,t,0,-1,-t,0,1,-t,0,0,-1,t,0,1,t,0,-1,-t,0,1,-t,t,0,-1,t,0,1,-t,0,-1,-t,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],radius,detail)}}class OctahedronGeometry extends PolyhedronGeometry{constructor(radius=1,detail=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],radius,detail),this.type="OctahedronGeometry",this.parameters={radius:radius,detail:detail}}}OctahedronGeometry.fromJSON=function(data){return new OctahedronGeometry(data.radius,data.detail)};class RingGeometry extends Geometry{constructor(innerRadius=.5,outerRadius=1,thetaSegments=8,phiSegments=1,thetaStart=0,thetaLength=2*Math.PI){super();var segment,j,i,indices=[],vertices=[],normals=[],uvs=[],radius=innerRadius,radiusStep=(outerRadius-innerRadius)/phiSegments,vertex=new Vector3,uv=new Vector2;for(j=0;j<=phiSegments;j++){for(i=0;i<=thetaSegments;i++)segment=thetaStart+i/thetaSegments*thetaLength,vertex.x=radius*Math.cos(segment),vertex.y=radius*Math.sin(segment),vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,0,1),uv.x=(vertex.x/outerRadius+1)/2,uv.y=(vertex.y/outerRadius+1)/2,uvs.push(uv.x,uv.y);radius+=radiusStep}for(j=0;j<phiSegments;j++){var thetaSegmentLevel=j*(thetaSegments+1);for(i=0;i<thetaSegments;i++){var a=segment=i+thetaSegmentLevel,b=segment+thetaSegments+1,c=segment+thetaSegments+2,d=segment+1;indices.push(a,b,d),indices.push(b,c,d)}}this.index=new(Geometry.arrayNeedsUint32(indices)?Uint32Array:Uint16Array)(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class SphereGeometry extends Geometry{constructor(radius=1,widthSegments=8,heightSegments=6,phiStart=0,phiLength=2*Math.PI,thetaStart=0,thetaLength=Math.PI){super(),widthSegments=Math.max(3,Math.floor(widthSegments)),heightSegments=Math.max(2,Math.floor(heightSegments));let ix,iy,thetaEnd=thetaStart+thetaLength,index=0,grid=[],vertex=new Vector3,normal=new Vector3,indices=[],vertices=[],normals=[],uvs=[];for(iy=0;iy<=heightSegments;iy++){let verticesRow=[],v=iy/heightSegments;for(ix=0;ix<=widthSegments;ix++){let u=ix/widthSegments;vertex.x=-radius*Math.cos(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertex.y=radius*Math.cos(thetaStart+v*thetaLength),vertex.z=radius*Math.sin(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertices.push(vertex.x,vertex.y,vertex.z),normal.set(vertex.x,vertex.y,vertex.z).normalize(),normals.push(normal.x,normal.y,normal.z),uvs.push(u,1-v),verticesRow.push(index++)}grid.push(verticesRow)}for(iy=0;iy<heightSegments;iy++)for(ix=0;ix<widthSegments;ix++){let a=grid[iy][ix+1],b=grid[iy][ix],c=grid[iy+1][ix],d=grid[iy+1][ix+1];(0!==iy||thetaStart>0)&&indices.push(a,b,d),(iy!==heightSegments-1||thetaEnd<Math.PI)&&indices.push(b,c,d)}this.index=new(Geometry.arrayNeedsUint32(indices)?Uint32Array:Uint16Array)(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class TorusKnotGeometry extends Geometry{constructor(radius=1,tube=.4,tubularSegments=64,radialSegments=8,p=2,q=3){super();let i,j,indices=[],vertices=[],normals=[],uvs=[],vertex=new Vector3,normal=new Vector3,P1=new Vector3,P2=new Vector3,B=new Vector3,T=new Vector3,N=new Vector3;for(i=0;i<=tubularSegments;++i){let u=i/tubularSegments*p*Math.PI*2;for(calculatePositionOnCurve(u,p,q,radius,P1),calculatePositionOnCurve(u+.01,p,q,radius,P2),T.subVectors(P2,P1),N.addVectors(P2,P1),B.crossVectors(T,N),N.crossVectors(B,T),B.normalize(),N.normalize(),j=0;j<=radialSegments;++j){let v=j/radialSegments*Math.PI*2,cx=-tube*Math.cos(v),cy=tube*Math.sin(v);vertex.x=P1.x+(cx*N.x+cy*B.x),vertex.y=P1.y+(cx*N.y+cy*B.y),vertex.z=P1.z+(cx*N.z+cy*B.z),vertices.push(vertex.x,vertex.y,vertex.z),normal.subVectors(vertex,P1).normalize(),normals.push(normal.x,normal.y,normal.z),uvs.push(i/tubularSegments),uvs.push(j/radialSegments)}}for(j=1;j<=tubularSegments;j++)for(i=1;i<=radialSegments;i++){let a=(radialSegments+1)*(j-1)+(i-1),b=(radialSegments+1)*j+(i-1),c=(radialSegments+1)*j+i,d=(radialSegments+1)*(j-1)+i;indices.push(a,b,d),indices.push(b,c,d)}function calculatePositionOnCurve(u,p,q,radius,position){let cu=Math.cos(u),su=Math.sin(u),quOverP=q/p*u,cs=Math.cos(quOverP);position.x=radius*(2+cs)*.5*cu,position.y=radius*(2+cs)*su*.5,position.z=radius*Math.sin(quOverP)*.5}this.index=new(Geometry.arrayNeedsUint32(indices)?Uint32Array:Uint16Array)(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}Class((function Interaction3D(_camera){Inherit(this,Component);const _this=this;let _hover,_click;var _lastOnUpdate,_maximumVRHitDistance,_v3=new Vector3,_plane=new Plane,_input={},_cacheHits=[],_enabled=!0;_this.ID=Utils.timestamp(),_camera=_camera||World.CAMERA;var _ray=_this.initClass(Raycaster,_camera),_meshes=[],_test=[],_event={};const PROHIBITED_ELEMENTS=["hit","prevent_interaction3d"];function checkIfProhibited(element){let el=element;for(;el;){if(el.classList)for(let i=0;i<PROHIBITED_ELEMENTS.length;i++)if(el.classList.contains(PROHIBITED_ELEMENTS[i]))return!0;el=el.parentNode}return!1}function parseMeshes(meshes){Array.isArray(meshes)||(meshes=[meshes]);let output=[];return meshes.forEach((function checkMesh(obj){if(obj.isOcclusionMesh)return;(obj.hitArea||obj.hitMesh)&&(obj=function initHitMesh(obj){obj.hitMesh||(obj.hitMesh=new Mesh(obj.hitArea));return obj.add(obj.hitMesh),obj=obj.hitMesh,obj.isHitMesh=!0,obj.shader.neverRender=!0,obj}(obj));"boolean"==typeof obj.isHitMesh?(obj.mouseEnabled=function(visible){visible?~_meshes.indexOf(obj)||_meshes.push(obj):_meshes.remove(obj)},output.push(obj)):output.push(obj);obj.children.length&&obj.children.forEach(checkMesh)})),output}function testObjects(){_test.length=0;for(let i=_meshes.length-1;i>-1;i--){let obj=_meshes[i];obj.determineVisible()&&_test.push(obj)}return _test}function start(e){if("2d"==_input.type){let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(element&&checkIfProhibited(element)||GLUI.HIT)return}if(!_enabled)return;let hit=move(e);"3d"==_input.type&&_this.events.fire(Interaction3D.EXTERNAL_PRESS),hit?(_click=hit.object,_click.time=Render.TIME):_click=null}function moveHand(e){if(!_enabled)return;_cacheHits.length=0;for(let i=0;i<_input.obj.length;i++){let obj=_input.obj[i];_v3.set(0,0,-1).applyQuaternion(obj.quaternion);let hit=_ray.checkFromValues(testObjects(),obj.position,_v3)[0];hit&&_cacheHits.push(hit)}_cacheHits.sort(((a,b)=>a.distance-b.distance));let hit=_cacheHits[0];if(hit&&hit.object==_lastOnUpdate||(_lastOnUpdate&&_lastOnUpdate.onMissUpdate&&_lastOnUpdate.onMissUpdate(),_lastOnUpdate=null),hit){let mesh=hit.object;if(mesh.onHitUpdate)return hit.usingFinger=!0,_lastOnUpdate=mesh,mesh.onHitUpdate(hit),!1;!mesh._debounceFingerClick||Render.TIME-mesh._debounceFingerClick>1e3?hit.distance<.01?(_click=mesh,triggerClick(mesh,hit),mesh._debounceFingerClick=Render.TIME):_hover||(_hover=mesh,triggerHover("over",mesh,hit)):_hover&&(triggerHover("out",_hover),_hover=null)}else _hover&&(triggerHover("out",_hover),_hover=null)}function move(e){if("2d"==_input.type){let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(element&&checkIfProhibited(element))return}if(!_enabled)return void Interaction3D.requestCursor("auto",_this);let hit;if("2d"==_input.type?hit=_ray.checkHit(testObjects(),_input.position,_input.rect||Stage)[0]:(_input.obj.hideBeam(),_v3.set(0,0,-1).applyQuaternion(_input.obj.group.getWorldQuaternion()),hit=_ray.checkFromValues(testObjects(),_input.obj.group.getWorldPosition(),_v3)[0]),hit&&hit.object==_lastOnUpdate||(_lastOnUpdate&&_lastOnUpdate.onMissUpdate&&_lastOnUpdate.onMissUpdate(),_lastOnUpdate=null),hit){_this.intersecting=!0;let mesh=hit.object;if("3d"==_input.type){let max=_maximumVRHitDistance||Interaction3D.maximumVRHitDistance;if("number"==typeof mesh.maximumVRHitDistance&&mesh.maximumVRHitDistance>0&&(max=mesh.maximumVRHitDistance),mesh.onHitUpdate&&hit.distance>max)return!1;_input.obj.showBeam(),_input.obj.setHitPosition&&_input.obj.setHitPosition(hit)}return mesh.onHitUpdate?(mesh.onHitUpdate(hit),_lastOnUpdate=mesh,!1):(_hover!==mesh?(_hover&&triggerHover("out",_hover,hit),_hover=mesh,triggerHover("over",_hover,hit),_hover.__clickCallback?Interaction3D.requestCursor("pointer",_this):Interaction3D.requestCursor("auto",_this)):function triggerMove(mesh,hit){_event.action="move",_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.MOVE,_event,!0),mesh["__moveCallback"+_this.ID]&&mesh["__moveCallback"+_this.ID](_event)}(_hover,hit),hit)}return _this.intersecting=!1,end(),_input.obj&&_input.obj.setHitPosition&&_input.obj.setHitPosition(!1),!1}function end(){_hover&&(triggerHover("out",_hover,null),_hover=null,Interaction3D.requestCursor(_this.cursor,_this))}function click(e){if("3d"==_input.type&&_this.events.fire(Interaction3D.EXTERNAL_RELEASE),!_this.enabled)return;if(!_click)return;let hit,element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(!element||!checkIfProhibited(element)){if("2d"==_input.type){if(GLUI.HIT)return;hit=_ray.checkHit(testObjects(),_input.position,_input.rect)[0]}else _v3.set(0,0,-1).applyQuaternion(_input.obj.group.getWorldQuaternion()),hit=_ray.checkFromValues(testObjects(),_input.obj.group.getWorldPosition(),_v3)[0];hit&&hit.object===_click&&triggerClick(_click,hit),_click=null}}function triggerHover(action,mesh,hit){_event.action=action,_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.HOVER,_event,!0),_hover.__hoverCallback&&_hover.__hoverCallback(_event)}function triggerClick(mesh,hit){_event.action="click",_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.CLICK,_event,!0),_click.__clickCallback&&_click.__clickCallback(_event)}function vrInputButton(e){"trigger"==e.label&&(e.pressed?start(e):click(e))}this.cursor="auto",_ray.testVisibility=!0,this.set("camera",(c=>{_ray.camera=c})),this.add=function(meshes,hover,click,move,seo){let seoRoot;Array.isArray(meshes)||(meshes=parseMeshes(meshes)),move&&"function"!=typeof move&&(seo=move,move=null),seo&&seo.root&&(seoRoot=seo.root,seo=seo.seo),meshes.forEach(((mesh,i)=>{if(seo)try{mesh._divFocus=_=>hover({action:"over",seo:!0,mesh:mesh}),mesh._divBlur=_=>hover({action:"out",seo:!0,mesh:mesh}),mesh._divSelect=_=>click({action:"click",seo:!0,mesh:mesh});let{url:url,label:label,...options}=Array.isArray(seo)?seo[i]:seo;GLSEO.objectNode(mesh,seoRoot),mesh.seo.aLink(url,label,options)}catch(e){Hydra.LOCAL&&console.warn("Could not add SEO to Interaction3D meshes",e)}mesh.hitDestroy=_=>_meshes.remove(mesh),hover&&(mesh.__hoverCallback=hover),click&&(mesh.__clickCallback=click),move&&(mesh["__moveCallback"+_this.ID]=move),_meshes.push(mesh)}))},this.remove=function(meshes){Array.isArray(meshes)||(meshes=parseMeshes(meshes)),meshes.forEach((mesh=>{mesh===_hover&&(_hover=null,Interaction3D.requestCursor(_this.cursor,_this)),mesh.seo&&mesh.seo.unlink();for(let i=_meshes.length-1;i>=0;i--)mesh===_meshes[i]&&_meshes.splice(i,1)}))},this.set("testVisibility",(v=>_ray.testVisibility=v)),this.set("input",(obj=>{_input&&_input.obj&&(_input.obj.isVrController&&_this.events.unsub(_input.obj,VRInput.BUTTON,vrInputButton),_input.obj.setHitPosition&&_input.obj.setHitPosition(!1),_input.obj.hideBeam&&_input.obj.hideBeam()),(_input={}).obj=obj,_input.position=obj.group?obj.group.position:obj,_input.quaternion=obj.group?obj.group.quaternion:null,_input.type="number"==typeof _input.position.z||Array.isArray(obj)?"3d":"2d",_input.rect=obj.rect,"3d"==_input.type?(new Vector3,new Vector3):(new Vector2,new Vector2),obj==Mouse?function addHandlers(){_this.events.sub(Mouse.input,Interaction.START,start),Device.mobile&&_this.events.sub(Mouse.input,Interaction.END,end),_this.events.sub(Mouse.input,Interaction.MOVE,move),_this.events.sub(Mouse.input,Interaction.CLICK,click)}():(!function removeHandlers(){_this.events.unsub(Mouse.input,Interaction.START,start),Device.mobile&&_this.events.unsub(Mouse.input,Interaction.END,end),_this.events.unsub(Mouse.input,Interaction.MOVE,move),_this.events.unsub(Mouse.input,Interaction.CLICK,click)}(),Array.isArray(obj)?(_this.startRender(moveHand),_this.stopRender(move)):(_this.events.sub(obj,VRInput.BUTTON,vrInputButton),_this.startRender(move),_this.stopRender(moveHand)))})),this.get("input",(_=>_input)),this.get("enabled",(_=>_enabled)),this.set("enabled",(v=>{(_enabled=v)||(_hover&&triggerHover("out",_hover,null),_hover=null,_input&&_input.obj&&(_input.obj.setHitPosition&&_input.obj.setHitPosition(!1),_input.obj.hideBeam&&_input.obj.hideBeam()))})),this.checkObjectHit=function(object,mouse,rect=Stage){return _ray.checkHit(object,mouse,rect)[0]},this.checkObjectFromValues=function(object,origin,direction){return _ray.checkFromValues(object,origin,direction)[0]},this.getObjectHitLocalCoords=function(v,object,mouse,rect=Stage){let hit=_this.checkObjectHit(object,mouse,rect);return hit?(v.copy(hit.point),hit.object.worldToLocal(v)):(_plane.normal.set(0,0,1).applyQuaternion(object.getWorldQuaternion()),_plane.constant=-object.getWorldPosition().dot(_plane.normal),_ray.ray.intersectPlane(_plane,v),object.worldToLocal(v))},this.get("maximumVRHitDistance",(()=>_maximumVRHitDistance)),this.set("maximumVRHitDistance",(value=>{value?"number"==typeof value&&value>0&&(_maximumVRHitDistance=value):_maximumVRHitDistance=void 0}))}),(()=>{Interaction3D.HOVER="interaction3d_hover",Interaction3D.CLICK="interaction3d_click",Interaction3D.MOVE="interaction3d_move",Interaction3D.EXTERNAL_PRESS="interaction3d_ext_press",Interaction3D.EXTERNAL_RELEASE="interaction3d_ext_release";var _cursorObj,_map=new Map,_input=Mouse,_maximumVRHitDistance=5;Interaction3D.find=function(camera){if(camera=camera.camera||camera,!_map.has(camera)){let interaction=new Interaction3D(camera);interaction.input=_input,_map.set(camera,interaction)}return _map.get(camera)},Interaction3D.useInput=function(obj){if(_input!=obj){for(let[camera,interaction]of _map)interaction.input=obj;_input=obj}},Interaction3D.requestCursor=function(cursor,obj){obj.forceCursor&&(cursor=obj.forceCursor),"pointer"==cursor&&(_cursorObj=obj,Stage.cursor(cursor)),"auto"==cursor&&_cursorObj==obj&&(Stage.cursor(cursor),_cursorObj=null)},Object.defineProperty(Interaction3D,"maximumVRHitDistance",{get:()=>_maximumVRHitDistance,set(value){value?"number"==typeof value&&value>0&&(_maximumVRHitDistance=value):_maximumVRHitDistance=5}})})),Class((function Lighting(){Inherit(this,Component);const _this=this;var _activeScene,_scenes={};function loop(){if(decomposeLights(_activeScene.lights),_this.UBO){let shader=_activeScene.shaders.start();shader&&(updateArrays(shader),_activeScene.ubo.created?_activeScene.ubo.update():createUBO(shader.uniforms))}else{let shader=_activeScene.shaders.start();for(;shader;)updateArrays(shader),shader=_activeScene.shaders.next()}}function createUBO(uniforms){uniforms.lightPos&&(_activeScene.ubo.created=!0,_activeScene.ubo.push(uniforms.lightPos),_activeScene.ubo.push(uniforms.lightColor),_activeScene.ubo.push(uniforms.lightData),_activeScene.ubo.push(uniforms.lightData2),_activeScene.ubo.push(uniforms.lightData3),_activeScene.ubo.push(uniforms.lightProperties),_activeScene.ubo.upload())}function decomposeLights(lights){for(let i=lights.length-1;i>-1;i--){let light=lights[i];light._decomposedTime&&Render.TIME-light._decomposedTime<8||(light._decomposedTime=Render.TIME,light._parent||light.updateMatrixWorld(),light._world||(light._world=new Vector3),light.lockToLocal?light._world.copy(light.position):light.getWorldPosition(light._world))}}function updateArrays(shader){let lighting=shader.__lighting;lighting.position.length=0,lighting.color.length=0,lighting.data.length=0,lighting.data2.length=0,lighting.data3.length=0,lighting.properties.length=0;for(let i=0;i<_activeScene.lights.length;i++){let light=_activeScene.lights[i];light._world||decomposeLights(_activeScene.lights),lighting.position.push(light._world.x,light._world.y,light._world.z,0),lighting.color.push(light.color.r,light.color.g,light.color.b,0),lighting.data.push(light.data.x,light.data.y,light.data.z,light.data.w),lighting.data2.push(light.data2.x,light.data2.y,light.data2.z,light.data2.w),lighting.data3.push(light.data3.x,light.data3.y,light.data3.z,light.data3.w),lighting.properties.push(light.properties.x,light.properties.y,light.properties.z,light.properties.w)}}function findParentScene(obj3d){if(!obj3d)return _activeScene;if(obj3d._lightingData)return obj3d._lightingData;let scene,p=obj3d._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent;return scene||(scene=_activeScene),scene}this.fallbackAreaToPoint=!1,this.scenes=_scenes,async function(){await Hydra.ready(),_this.createScene("default"),_this.useScene("default")}(),this.createScene=function(name,scene){if(_scenes[name])return this;let obj={lights:[],renderShadows:[],ubo:new(window.Metal?MetalUBO:UBO)(2),shaders:new LinkedList,name:name};return scene&&(scene._lightingData=obj),_scenes[name]=obj,this},this.useScene=function(name){if(!(_activeScene=_scenes[name]))throw`Scene ${name} not found`;return loop(),this},this.destroyScene=function(name){delete _scenes[name]},this.push=this.add=function(light){_this.UBO=Renderer.UBO&&!(window.AURA||RenderManager.type==RenderManager.WEBVR),window.Metal&&(_this.UBO=!0);let scene=findParentScene(light);scene.lights.push(light),light.isAreaLight&&(scene.hasAreaLight=!0),_this.startedLoop||(_this.startedLoop=!0,RenderManager.type==RenderManager.WEBVR?_this.startRender(loop,World.NUKE):Render.onDrawFrame(loop))},this.remove=function(light){_activeScene.lights.remove(light)},this.getLighting=function(shader,force){if(shader.__lighting&&!force)return shader.__lighting;let scene=findParentScene(shader.mesh);scene.shaders.push(shader),window.AreaLightUtil&&scene.hasAreaLight&&AreaLightUtil.append(shader);let lighting=shader.__lighting={position:[],color:[],data:[],data2:[],data3:[],properties:[]};if(!scene.lights.length)return shader.__lighting;let lightUBO=_this.UBO;return shader.uniforms.lightPos={type:"v4v",value:lighting.position,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightColor={type:"v4v",value:lighting.color,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData={type:"v4v",value:lighting.data,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData2={type:"v4v",value:lighting.data2,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData3={type:"v4v",value:lighting.data3,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightProperties={type:"v4v",value:lighting.properties,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},updateArrays(shader),_this.UBO&&!_activeScene.ubo.created&&createUBO(shader.uniforms),shader.__lighting},this.destroyShader=function(shader){findParentScene(shader.mesh);_activeScene.shaders.remove(shader)},this.sort=function(callback){_activeScene.lights.sort(callback)},this.addToShadowGroup=function(light){findParentScene(light).renderShadows.push(light)},this.removeFromShadowGroup=function(light){findParentScene(light);_activeScene.renderShadows.remove(light)},this.getShadowLights=function(){return _activeScene.renderShadows},this.getShadowCount=function(){return _activeScene.renderShadows.length},this.initShadowShader=function(object,mesh){let scene,shader=object.shader||object;if(shader.mesh){let p=shader.mesh._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent}if(scene||(scene=_activeScene),!World.RENDERER.shadows||0==scene.renderShadows.length)return"";shader._gl||shader.upload();let vsName=shader.vsName,fsName="ShadowDepth";shader.customShadowShader&&(fsName=shader.customShadowShader),shader.shadow=new Shader(vsName,fsName,{receiveLight:shader.receiveLight,UILPrefix:shader.UILPrefix,precision:"high",customCompile:vsName+" "+fsName}),shader.vertexShader&&(shader.shadow.vertexShader=shader.vertexShader),shader.restoreVS&&(shader.shadow.vertexShader=shader.restoreVS),shader.customCompile&&(shader.shadow.customCompile=shader.customCompile+"_shadow"),shader.defines&&(shader.shadow.defines=shader.defines,shader.shadow.resetProgram()),shader.shadow.lights=shader.lights,shader.shadow.isShadow=!0,shader.copyUniformsTo(shader.shadow,!0),shader.shadow.upload()},this.getShadowUniforms=function(shader){let scene;if(shader.mesh){let p=shader.mesh._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent}return scene||(scene=_activeScene),World.RENDERER.shadows&&0!=scene.renderShadows.length?[`\n#define SHADOW_MAPS ${scene.renderShadows.length}`,World.RENDERER.shadows==Renderer.SHADOWS_LOW?"#define SHADOWS_LOW":"",World.RENDERER.shadows==Renderer.SHADOWS_MED?"#define SHADOWS_MED":"",World.RENDERER.shadows==Renderer.SHADOWS_HIGH?"#define SHADOWS_HIGH":"",`uniform sampler2D shadowMap[${scene.renderShadows.length}];`,`uniform mat4 shadowMatrix[${scene.renderShadows.length}];`,`uniform vec3 shadowLightPos[${scene.renderShadows.length}];`,`uniform float shadowSize[${scene.renderShadows.length}];`].join("\n"):""},this.bindUBO=function(shader){_activeScene.ubo.created&&_activeScene.ubo.bind(shader,"lights")},this.fallbackAreaToPointTest=function(){return _this.fallbackAreaToPoint},this.get("activeScene",(_=>_activeScene)),this.renderShadowsAllowLight=function(object,light){if(!object._renderShadowsAllowLights){let allowed=new WeakMap;object._renderShadowsAllowLights=allowed;let prevOnBeforeRenderShadow=object.onBeforeRenderShadow;object.onBeforeRenderShadow=function(renderLight){let result=prevOnBeforeRenderShadow&&prevOnBeforeRenderShadow.apply(this,arguments);return!allowed.has(renderLight)||result}}object._renderShadowsAllowLights.set(light.light||light,!0)}}),"static");class Shadow{constructor(light){this.light=light,this.camera=new PerspectiveCamera(60,1,.1,50),this.target=new Vector3,this.rt=new RenderTarget(1024,1024),this.rt.createDepthTexture(),this.enabled=!0,this._size=1024,this._fov=60,this._far=50,this._near=.1,light.add(this.camera)}destroy(){this.rt.destroy()}set fov(value){this._fov=value,this.camera.fov=value,this.camera.updateProjectionMatrix(),-1==value&&(this.camera=new OrthographicCamera(-5,5,5,-5,.1,50))}get fov(){return this._fov}set area(value){this._area=value,this.camera.left=-value,this.camera.right=value,this.camera.top=value,this.camera.bottom=-value,this.camera.updateProjectionMatrix()}get area(){return this._area}set far(value){this._far=value,this.camera.far=value,this.camera.updateProjectionMatrix()}get far(){return this._far}set near(value){this._near=value,this.camera.near=value,this.camera.updateProjectionMatrix()}get near(){return this._near}set size(value){this._size=value,this.rt.setSize(value,value)}get size(){return this._size}}class Box2{constructor(min,max){this.min=void 0!==min?min:new Vector2(1/0,1/0),this.max=void 0!==max?max:new Vector2(-1/0,-1/0)}set(min,max){return this.min.copy(min),this.max.copy(max),this}setFromPoints(points){this.makeEmpty();for(let i=0,il=points.length;i<il;i++)this.expandByPoint(points[i]);return this}setFromCenterAndSize(center,size){let v1=this.V1||new Vector2;this.V1=v1;let halfSize=v1.copy(size).multiplyScalar(.5);return this.min.copy(center).sub(halfSize),this.max.copy(center).add(halfSize),this}clone(){return(new Box2).copy(this)}copy(box){return this.min.copy(box.min),this.max.copy(box.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(target){return this.isEmpty()?target.set(0,0):target.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(target){return this.isEmpty()?target.set(0,0):target.subVectors(this.max,this.min)}expandByPoint(point){return this.min.min(point),this.max.max(point),this}expandByVector(vector){return this.min.sub(vector),this.max.add(vector),this}expandByScalar(scalar){return this.min.addScalar(-scalar),this.max.addScalar(scalar),this}containsPoint(point){return!(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y)}containsBox(box){return this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y}getParameter(point,target){return target.set((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(box){return!(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y)}clampPoint(point,target){return target.copy(point).clamp(this.min,this.max)}distanceToPoint(point){let v1=this.V1||new Vector2;return this.V1=v1,v1.copy(point).clamp(this.min,this.max).sub(point).length()}intersect(box){return this.min.max(box.min),this.max.min(box.max),this}union(box){return this.min.min(box.min),this.max.max(box.max),this}translate(offset){return this.min.add(offset),this.max.add(offset),this}equals(box){return box.min.equals(this.min)&&box.max.equals(this.max)}}class Box3{constructor(min,max){this.min=void 0!==min?min:new Vector3(1/0,1/0,1/0),this.max=void 0!==max?max:new Vector3(-1/0,-1/0,-1/0)}set(min,max){return this.min.copy(min),this.max.copy(max),this}setFromArray(array){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=array.length;i<l;i+=3){let x=array[i],y=array[i+1],z=array[i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}setFromBufferAttribute(attribute){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=attribute.count;i<l;i++){let x=attribute.array[3*i+0],y=attribute.array[3*i+1],z=attribute.array[3*i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}setFromPoints(points){this.makeEmpty();for(let i=0,il=points.length;i<il;i++)this.expandByPoint(points[i]);return this}setFromCenterAndSize(center,size){let v1=this.V1||new Vector3;this.V1=v1;let halfSize=v1.copy(size).multiplyScalar(.5);return this.min.copy(center).sub(halfSize),this.max.copy(center).add(halfSize),this}setFromObject(object){return this.makeEmpty(),this.expandByObject(object)}clone(){return(new Box3).copy(this)}copy(box){return this.min.copy(box.min),this.max.copy(box.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(target){return this.isEmpty()?target.set(0,0,0):target.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(target){return this.isEmpty()?target.set(0,0,0):target.subVectors(this.max,this.min)}expandByPoint(point){return this.min.min(point),this.max.max(point),this}expandByVector(vector){return this.min.sub(vector),this.max.add(vector),this}expandByScalar(scalar){return this.min.addScalar(-scalar),this.max.addScalar(scalar),this}expandByObject(object,local,onlyvisible){let scope,i,l,v1=this.V1||new Vector3;return this.V1=v1,scope=this,object.updateMatrixWorld(!0),object.traverse((node=>{if(onlyvisible&&!node.visible)return;if(node.isGizmo)return;let geometry=node.geometry;if(!geometry)return;let attribute=geometry.attributes.position;if(void 0!==attribute)for(i=0,l=attribute.count;i<l;i++)v1.fromBufferAttribute(attribute,i).applyMatrix4(local?node.matrix:node.matrixWorld),scope.expandByPoint(v1)})),this}containsPoint(point){return!(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y||point.z<this.min.z||point.z>this.max.z)}containsBox(box){return this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y&&this.min.z<=box.min.z&&box.max.z<=this.max.z}getParameter(point,target){return target.set((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y),(point.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(box){return!(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y||box.max.z<this.min.z||box.min.z>this.max.z)}intersectsSphere(sphere){let closestPoint=this.V1||new Vector3;return this.V1=closestPoint,this.clampPoint(sphere.center,closestPoint),closestPoint.distanceToSquared(sphere.center)<=sphere.radius*sphere.radius}intersectsPlane(plane){let min,max;return plane.normal.x>0?(min=plane.normal.x*this.min.x,max=plane.normal.x*this.max.x):(min=plane.normal.x*this.max.x,max=plane.normal.x*this.min.x),plane.normal.y>0?(min+=plane.normal.y*this.min.y,max+=plane.normal.y*this.max.y):(min+=plane.normal.y*this.max.y,max+=plane.normal.y*this.min.y),plane.normal.z>0?(min+=plane.normal.z*this.min.z,max+=plane.normal.z*this.max.z):(min+=plane.normal.z*this.max.z,max+=plane.normal.z*this.min.z),min<=plane.constant&&max>=plane.constant}intersectsTriangle(triangle){let v0=this.V0||new Vector3;this.V0=v0;let v1=this.V1||new Vector3;this.V1=v1;let v2=this.V2||new Vector3;this.V2=v2;let f0=this.F0||new Vector3;this.F0=f0;let f1=this.F1||new Vector3;this.F1=f1;let f2=this.F2||new Vector3;this.F2=f2;let testAxis=this.V3||new Vector3;this.V3=testAxis;let center=this.V4||new Vector3;this.V4=center;let extents=this.V5||new Vector3;this.V5=extents;let triangleNormal=this.V6||new Vector3;function satForAxes(axes){let i,j;for(i=0,j=axes.length-3;i<=j;i+=3){testAxis.fromArray(axes,i);let r=extents.x*Math.abs(testAxis.x)+extents.y*Math.abs(testAxis.y)+extents.z*Math.abs(testAxis.z),p0=v0.dot(testAxis),p1=v1.dot(testAxis),p2=v2.dot(testAxis);if(Math.max(-Math.max(p0,p1,p2),Math.min(p0,p1,p2))>r)return!1}return!0}if(this.V6=triangleNormal,this.isEmpty())return!1;this.getCenter(center),extents.subVectors(this.max,center),v0.subVectors(triangle.a,center),v1.subVectors(triangle.b,center),v2.subVectors(triangle.c,center),f0.subVectors(v1,v0),f1.subVectors(v2,v1),f2.subVectors(v0,v2);let axes=[0,-f0.z,f0.y,0,-f1.z,f1.y,0,-f2.z,f2.y,f0.z,0,-f0.x,f1.z,0,-f1.x,f2.z,0,-f2.x,-f0.y,f0.x,0,-f1.y,f1.x,0,-f2.y,f2.x,0];return!!satForAxes(axes)&&(axes=[1,0,0,0,1,0,0,0,1],!!satForAxes(axes)&&(triangleNormal.crossVectors(f0,f1),axes=[triangleNormal.x,triangleNormal.y,triangleNormal.z],satForAxes(axes)))}clampPoint(point,target){return target.copy(point).clamp(this.min,this.max)}distanceToPoint(point){let v1=this.V1||new Vector3;return this.V1=v1,v1.copy(point).clamp(this.min,this.max).sub(point).length()}getBoundingSphere(target=new Sphere){let v1=this.V1||new Vector3;return this.V1=v1,this.getCenter(target.center),target.radius=.5*this.getSize(v1).length(),target}intersect(box){return this.min.max(box.min),this.max.min(box.max),this.isEmpty()&&this.makeEmpty(),this}union(box){return this.min.min(box.min),this.max.max(box.max),this}applyMatrix4(matrix){if(this.isEmpty())return this;let m=matrix.elements,xax=m[0]*this.min.x,xay=m[1]*this.min.x,xaz=m[2]*this.min.x,xbx=m[0]*this.max.x,xby=m[1]*this.max.x,xbz=m[2]*this.max.x,yax=m[4]*this.min.y,yay=m[5]*this.min.y,yaz=m[6]*this.min.y,ybx=m[4]*this.max.y,yby=m[5]*this.max.y,ybz=m[6]*this.max.y,zax=m[8]*this.min.z,zay=m[9]*this.min.z,zaz=m[10]*this.min.z,zbx=m[8]*this.max.z,zby=m[9]*this.max.z,zbz=m[10]*this.max.z;return this.min.x=Math.min(xax,xbx)+Math.min(yax,ybx)+Math.min(zax,zbx)+m[12],this.min.y=Math.min(xay,xby)+Math.min(yay,yby)+Math.min(zay,zby)+m[13],this.min.z=Math.min(xaz,xbz)+Math.min(yaz,ybz)+Math.min(zaz,zbz)+m[14],this.max.x=Math.max(xax,xbx)+Math.max(yax,ybx)+Math.max(zax,zbx)+m[12],this.max.y=Math.max(xay,xby)+Math.max(yay,yby)+Math.max(zay,zby)+m[13],this.max.z=Math.max(xaz,xbz)+Math.max(yaz,ybz)+Math.max(zaz,zbz)+m[14],this}translate(offset){return this.min.add(offset),this.max.add(offset),this}equals(box){return box.min.equals(this.min)&&box.max.equals(this.max)}setFromBufferAttribute(attribute){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=attribute.count;i<l;i++){let x=attribute.array[3*i+0],y=attribute.array[3*i+1],z=attribute.array[3*i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}}class Color{constructor(r,g,b){return null==r&&null==g&&null==b?this.setRGB(1,1,1):void 0===g&&void 0===b?this.set(r):void this.setRGB(r,g,b)}set(value){return value&&value instanceof Color?this.copy(value):"number"==typeof value?this.setHex(value):"string"==typeof value&&this.setStyle(value),this}setScalar(scalar){return this.r=scalar,this.g=scalar,this.b=scalar,this}setHex(hex){return hex=Math.floor(hex),this.r=(hex>>16&255)/255,this.g=(hex>>8&255)/255,this.b=(255&hex)/255,this}setStyle(string){return this.setHex(Number(string.replace("#","0x")))}setRGB(r,g,b){return this.r=r,this.g=g,this.b=b,this}setHSL(h,s,l){return h instanceof ColorHSL?h.getRGB(this):this.target?void this.target.setHSL(h,s,l).getRGB(this):this.target=new ColorHSL(h,s,l)}clone(){return new Color(this.r,this.g,this.b)}copy(color){return this.r=color.r,this.g=color.g,this.b=color.b,this}copyGammaToLinear(color,gammaFactor){return void 0===gammaFactor&&(gammaFactor=2),this.r=Math.pow(color.r,gammaFactor),this.g=Math.pow(color.g,gammaFactor),this.b=Math.pow(color.b,gammaFactor),this}copyLinearToGamma(color,gammaFactor){void 0===gammaFactor&&(gammaFactor=2);let safeInverse=gammaFactor>0?1/gammaFactor:1;return this.r=Math.pow(color.r,safeInverse),this.g=Math.pow(color.g,safeInverse),this.b=Math.pow(color.b,safeInverse),this}convertGammaToLinear(gammaFactor){return this.copyGammaToLinear(this,gammaFactor),this}convertLinearToGamma(gammaFactor){return this.copyLinearToGamma(this,gammaFactor),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return"#"+("000000"+this.getHex().toString(16)).slice(-6)}getHSL(){return this.target?this.target.setRGB(this.r,this.g,this.b):this.target=new ColorHSL(this)}tween(color,time,ease,delay){const _this=this;_this.tweenObj||(_this.tweenObj={v:0}),_this.tweenObj.v=0;let clone=this.clone();return TweenManager.tween(_this.tweenObj,{v:1},time,ease,delay).onUpdate((_=>{_this.copy(clone).lerp(color,_this.tweenObj.v)}))}offsetHSL(h,s,l){return this.target?this.target.setRGB(this.r,this.g,this.b):this.target=new ColorHSL(this),this.target.h+=h,this.target.s+=s,this.target.l+=l,this.target.getRGB(this)}add(color){return this.r+=color.r,this.g+=color.g,this.b+=color.b,this}addColors(color1,color2){return this.r=color1.r+color2.r,this.g=color1.g+color2.g,this.b=color1.b+color2.b,this}addScalar(s){return this.r+=s,this.g+=s,this.b+=s,this}sub(color){return this.r=Math.max(0,this.r-color.r),this.g=Math.max(0,this.g-color.g),this.b=Math.max(0,this.b-color.b),this}multiply(color){return this.r*=color.r,this.g*=color.g,this.b*=color.b,this}multiplyScalar(s){return this.r*=s,this.g*=s,this.b*=s,this}invert(){return this.r=1-this.r,this.g=1-this.g,this.b=1-this.b,this}lerp(color,alpha,hz){return this.r=Math.lerp(color.r,this.r,alpha,hz),this.g=Math.lerp(color.g,this.g,alpha,hz),this.b=Math.lerp(color.b,this.b,alpha,hz),this}equals(c){return c.r===this.r&&c.g===this.g&&c.b===this.b}fromArray(array,offset){return void 0===offset&&(offset=0),this.r=array[offset],this.g=array[offset+1],this.b=array[offset+2],this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.r,array[offset+1]=this.g,array[offset+2]=this.b,array}toRGBA(alpha=1){return`rgba(${Math.floor(255*this.r)}, ${Math.floor(255*this.g)}, ${Math.floor(255*this.b)}, ${alpha})`}}class ColorHSL{constructor(h,s,l){return void 0===h&&void 0===s&&void 0===l?this.setHSL(0,0,1):void 0===s&&void 0===l?this.set(h):void this.setHSL(h,s,l)}copy(colorHSL){return this.h=colorHSL.h,this.s=colorHSL.s,this.l=colorHSL.l,this}getRGB(target=new Color){function hue2rgb(p,q,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?p+6*(q-p)*t:t<.5?q:t<2/3?p+6*(q-p)*(2/3-t):p}let h=Math.euclideanModulo(this.h,1),s=Math.clamp(this.s,0,1),l=Math.clamp(this.l,0,1);if(0===s)target.r=target.g=target.b=l;else{let p=l<=.5?l*(1+s):l+s-l*s,q=2*l-p;target.r=hue2rgb(q,p,h+1/3),target.g=hue2rgb(q,p,h),target.b=hue2rgb(q,p,h-1/3)}return target}set(value){return value&&value instanceof ColorHSL?this.copy(value):value&&value instanceof Color?this.setRGB(value.r,value.g,value.b):"number"==typeof value?this.setHex(value):"string"==typeof value&&this.setStyle(value),this}setHex(hex){const r=((hex=Math.floor(hex))>>16&255)/255,g=(hex>>8&255)/255,b=(255&hex)/255;return this.setRGB(r,g,b)}setStyle(string){return this.setHex(Number(string.replace("#","0x")))}setRGB(r,g,b){let hue,saturation,max=Math.max(r,g,b),min=Math.min(r,g,b),lightness=(min+max)/2;if(min===max)hue=0,saturation=0;else{let delta=max-min;switch(saturation=lightness<=.5?delta/(max+min):delta/(2-max-min),max){case r:hue=(g-b)/delta+(g<b?6:0);break;case g:hue=(b-r)/delta+2;break;case b:hue=(r-g)/delta+4}hue/=6}return this.h=hue,this.s=saturation,this.l=lightness,this}setHSL(h,s,l){return this.h=h,this.s=s,this.l=l,this}}class ColorLAB{constructor(l,a,b){return void 0===l&&void 0===a&&void 0===b?this.setLAB(100,0,0):void 0===a&&void 0===b?this.set(l):void this.setLAB(l,a,b)}copy(colorLAB){return this.l=colorLAB.l,this.a=colorLAB.a,this.b=colorLAB.b,this}deltaECIE94(colorLAB){var deltaL=this.l-colorLAB.l,deltaA=this.a-colorLAB.a,deltaB=this.b-colorLAB.b,c1=Math.sqrt(this.a*this.a+this.b*this.b),deltaC=c1-Math.sqrt(colorLAB.a*colorLAB.a+colorLAB.b*colorLAB.b),deltaH=deltaA*deltaA+deltaB*deltaB-deltaC*deltaC,deltaLKlsl=deltaL/1,deltaCkcsc=deltaC/(1+.045*c1),deltaHkhsh=(deltaH=deltaH<0?0:Math.sqrt(deltaH))/(1+.015*c1),i=deltaLKlsl*deltaLKlsl+deltaCkcsc*deltaCkcsc+deltaHkhsh*deltaHkhsh;return i<0?0:Math.sqrt(i)}getRGB(target=new Color){let y=(this.l+16)/116,x=this.a/500+y,z=y-this.b/200;return x=.95047*(x*x*x>.008856?x*x*x:(x-16/116)/7.787),y=y*y*y>.008856?y*y*y:(y-16/116)/7.787,z=1.08883*(z*z*z>.008856?z*z*z:(z-16/116)/7.787),target.r=3.2406*x+-1.5372*y+-.4986*z,target.g=-.9689*x+1.8758*y+.0415*z,target.b=.0557*x+-.204*y+1.057*z,target.r=Math.clamp(target.r>.0031308?1.055*Math.pow(target.r,1/2.4)-.055:12.92*target.r),target.g=Math.clamp(target.g>.0031308?1.055*Math.pow(target.g,1/2.4)-.055:12.92*target.g),target.b=Math.clamp(target.b>.0031308?1.055*Math.pow(target.b,1/2.4)-.055:12.92*target.b),target}set(value){return value&&value instanceof ColorLAB?this.copy(value):value&&value instanceof Color?this.setRGB(value.r,value.g,value.b):"number"==typeof value?this.setHex(value):"string"==typeof value&&this.setStyle(value),this}setHex(hex){const r=((hex=Math.floor(hex))>>16&255)/255,g=(hex>>8&255)/255,b=(255&hex)/255;return this.setRGB(r,g,b)}setStyle(string){return this.setHex(Number(string.replace("#","0x")))}setRGB(r,g,b){let x,y,z;return x=(.4124*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)+.3576*(g=g>.04045?Math.pow((g+.055)/1.055,2.4):g/12.92)+.1805*(b=b>.04045?Math.pow((b+.055)/1.055,2.4):b/12.92))/.95047,y=.2126*r+.7152*g+.0722*b,z=(.0193*r+.1192*g+.9505*b)/1.08883,x=x>.008856?Math.pow(x,1/3):7.787*x+16/116,y=y>.008856?Math.pow(y,1/3):7.787*y+16/116,z=z>.008856?Math.pow(z,1/3):7.787*z+16/116,this.l=116*y-16,this.a=500*(x-y),this.b=200*(y-z),this}setLAB(l,a,b){return this.l=l,this.a=a,this.b=b,this}}class Cylindrical{constructor(radius=1,theta=0,y=0){this.radius=radius,this.theta=theta,this.y=y}set(radius,theta,y){return this.radius=radius,this.theta=theta,this.y=y,this}clone(){return(new this.constructor).copy(this)}copy(other){return this.radius=other.radius,this.theta=other.theta,this.y=other.y,this}setFromVector3(vec3){return this.radius=Math.sqrt(vec3.x*vec3.x+vec3.z*vec3.z),this.theta=Math.atan2(vec3.x,vec3.z),this.y=vec3.y,this}}class Euler{constructor(x,y,z,order){this._x=x||0,this._y=y||0,this._z=z||0,this._order=order||"XYZ",this.isEuler=!0}get x(){return this._x}set x(v){if(zUtils3D.LOCAL&&isNaN(v))return console.trace("Euler::NaN");let dirty=Math.abs(this._x-v)>Base3D.DIRTY_EPSILON;this._x=v,dirty&&this.onChangeCallback()}get y(){return this._y}set y(v){if(zUtils3D.LOCAL&&isNaN(v))return console.trace("Euler::NaN");let dirty=Math.abs(this._y-v)>Base3D.DIRTY_EPSILON;this._y=v,dirty&&this.onChangeCallback()}get z(){return this._z}set z(v){if(zUtils3D.LOCAL&&isNaN(v))return console.trace("Euler::NaN");let dirty=Math.abs(this._z-v)>Base3D.DIRTY_EPSILON;this._z=v,dirty&&this.onChangeCallback()}set order(value){this._order=value,this.onChangeCallback()}get order(){return this._order}set(x,y,z,order){return this._x=x,this._y=y,this._z=z,this._order=order||this._order,this.onChangeCallback(),this}clone(){return new Euler(this._x,this._y,this._z,this._order)}copy(euler){return this._x=euler.x,this._y=euler.y,this._z=euler.z,euler._order&&(this._order=euler._order),this.onChangeCallback(),this}setFromRotationMatrix(m,order,update){let clamp=Math.clamp,te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10];return"XYZ"===(order=order||this._order)?(this._y=Math.asin(clamp(m13,-1,1)),Math.abs(m13)<1-Base3D.DIRTY_EPSILON?(this._x=Math.atan2(-m23,m33),this._z=Math.atan2(-m12,m11)):(this._x=Math.atan2(m32,m22),this._z=0)):"YXZ"===order?(this._x=Math.asin(-clamp(m23,-1,1)),Math.abs(m23)<1-Base3D.DIRTY_EPSILON?(this._y=Math.atan2(m13,m33),this._z=Math.atan2(m21,m22)):(this._y=Math.atan2(-m31,m11),this._z=0)):"ZXY"===order?(this._x=Math.asin(clamp(m32,-1,1)),Math.abs(m32)<1-Base3D.DIRTY_EPSILON?(this._y=Math.atan2(-m31,m33),this._z=Math.atan2(-m12,m22)):(this._y=0,this._z=Math.atan2(m21,m11))):"ZYX"===order?(this._y=Math.asin(-clamp(m31,-1,1)),Math.abs(m31)<1-Base3D.DIRTY_EPSILON?(this._x=Math.atan2(m32,m33),this._z=Math.atan2(m21,m11)):(this._x=0,this._z=Math.atan2(-m12,m22))):"YZX"===order?(this._z=Math.asin(clamp(m21,-1,1)),Math.abs(m21)<1-Base3D.DIRTY_EPSILON?(this._x=Math.atan2(-m23,m22),this._y=Math.atan2(-m31,m11)):(this._x=0,this._y=Math.atan2(m13,m33))):"XZY"===order&&(this._z=Math.asin(-clamp(m12,-1,1)),Math.abs(m12)<1-Base3D.DIRTY_EPSILON?(this._x=Math.atan2(m32,m22),this._y=Math.atan2(m13,m11)):(this._x=Math.atan2(-m23,m33),this._y=0)),this._order=order,!1!==update&&this.onChangeCallback(),this}setFromQuaternion(q,order,update){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.makeRotationFromQuaternion(q),this.setFromRotationMatrix(matrix,order,update)}setFromVector3(v,order){return this.set(v.x,v.y,v.z,order||this._order)}reorder(newOrder){let q=this.Q1||new Quaternion;return this.Q1=q,q.setFromEuler(this),this.setFromQuaternion(q,newOrder)}lerp(euler,alpha){this._x+=(euler._x-this._x)*alpha,this._y+=(euler._y-this._y)*alpha,this._z+=(euler._z-this._z)*alpha,this.onChangeCallback()}equals(euler){return euler._x===this._x&&euler._y===this._y&&euler._z===this._z&&euler._order===this._order}fromArray(array){return this._x=array[0],this._y=array[1],this._z=array[2],void 0!==array[3]&&(this._order=array[3]),this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array[offset+3]=this._order,array}toVector3(optionalResult){return optionalResult?optionalResult.set(this._x,this._y,this._z):new Vector3(this._x,this._y,this._z)}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}Euler.DefaultOrder="XYZ",Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class Frustum{constructor(p0,p1,p2,p3,p4,p5){this.planes=[void 0!==p0?p0:new Plane,void 0!==p1?p1:new Plane,void 0!==p2?p2:new Plane,void 0!==p3?p3:new Plane,void 0!==p4?p4:new Plane,void 0!==p5?p5:new Plane]}set(p0,p1,p2,p3,p4,p5){let planes=this.planes;return planes[0].copy(p0),planes[1].copy(p1),planes[2].copy(p2),planes[3].copy(p3),planes[4].copy(p4),planes[5].copy(p5),this}clone(){return(new Frustum).copy(this)}copy(frustum){let planes=this.planes;for(let i=0;i<6;i++)planes[i].copy(frustum.planes[i]);return this}setFromMatrix(m){let planes=this.planes,me=m.elements,me0=me[0],me1=me[1],me2=me[2],me3=me[3],me4=me[4],me5=me[5],me6=me[6],me7=me[7],me8=me[8],me9=me[9],me10=me[10],me11=me[11],me12=me[12],me13=me[13],me14=me[14],me15=me[15];return planes[0].setComponents(me3-me0,me7-me4,me11-me8,me15-me12).normalize(),planes[1].setComponents(me3+me0,me7+me4,me11+me8,me15+me12).normalize(),planes[2].setComponents(me3+me1,me7+me5,me11+me9,me15+me13).normalize(),planes[3].setComponents(me3-me1,me7-me5,me11-me9,me15-me13).normalize(),planes[4].setComponents(me3-me2,me7-me6,me11-me10,me15-me14).normalize(),planes[5].setComponents(me3+me2,me7+me6,me11+me10,me15+me14).normalize(),this}setFromCamera(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse),this.setFromMatrix(matrix)}intersectsObject(object,setAsBoolean=!0){let sphere=this.S1||new Sphere;this.S1=sphere;let geometry=object.geometry;return!!geometry&&(null===geometry.boundingSphere&&geometry.computeBoundingSphere(),sphere.copy(geometry.boundingSphere).applyMatrix4(object.matrixWorld),this.intersectsSphere(sphere,setAsBoolean))}intersectsSphere(sphere,setAsBoolean=!0){let planes=this.planes,center=sphere.center,negRadius=-sphere.radius,insides=0;for(let i=0;i<6;i++){let distance=planes[i].distanceToPoint(center);if(distance<negRadius)return!setAsBoolean&&-1;!setAsBoolean&&distance>=0&&insides++}return!!setAsBoolean||(6===insides?1:0)}intersectsBox(box){let p1=this.V1||new Vector3,p2=this.V2||new Vector3;this.V1=p1,this.V2=p2;let planes=this.planes;for(let i=0;i<6;i++){let plane=planes[i];p1.x=plane.normal.x>0?box.min.x:box.max.x,p2.x=plane.normal.x>0?box.max.x:box.min.x,p1.y=plane.normal.y>0?box.min.y:box.max.y,p2.y=plane.normal.y>0?box.max.y:box.min.y,p1.z=plane.normal.z>0?box.min.z:box.max.z,p2.z=plane.normal.z>0?box.max.z:box.min.z;let d1=plane.distanceToPoint(p1),d2=plane.distanceToPoint(p2);if(d1<0&&d2<0)return!1}return!0}containsPoint(point){let planes=this.planes;for(let i=0;i<6;i++)if(planes[i].distanceToPoint(point)<0)return!1;return!0}}class Line3{constructor(start=new Vector3,end=new Vector3){this.start=start,this.end=end}set(start,end){return this.start.copy(start),this.end.copy(end),this}clone(){return(new this.constructor).copy(this)}copy(line){return this.start.copy(line.start),this.end.copy(line.end),this}getCenter(target=new Vector3){return target.addVectors(this.start,this.end).multiplyScalar(.5)}delta(target=new Vector3){return target.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,target=new Vector3){return this.delta(target).multiplyScalar(t).add(this.start)}closestPointToPointParameter(point,clampToLine){let startP=this.V1||new Vector3,startEnd=this.V2||new Vector3;this.V1=startP,this.V2=startEnd,startP.subVectors(point,this.start),startEnd.subVectors(this.end,this.start);let startEnd2=startEnd.dot(startEnd),t=startEnd.dot(startP)/startEnd2;return clampToLine&&(t=Math.clamp(t,0,1)),t}closestPointToPoint(point,clampToLine,target=new Vector3){let t=this.closestPointToPointParameter(point,clampToLine);return this.delta(target).multiplyScalar(t).add(this.start)}applyMatrix4(matrix){return this.start.applyMatrix4(matrix),this.end.applyMatrix4(matrix),this}equals(line){return line.start.equals(this.start)&&line.end.equals(this.end)}}class Matrix3{constructor(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}set(n11,n12,n13,n21,n22,n23,n31,n32,n33){let te=this.elements;return te[0]=n11,te[1]=n21,te[2]=n31,te[3]=n12,te[4]=n22,te[5]=n32,te[6]=n13,te[7]=n23,te[8]=n33,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}clone(){return(new Matrix3).fromArray(this.elements)}copy(m){let te=this.elements,me=m.elements;return te[0]=me[0],te[1]=me[1],te[2]=me[2],te[3]=me[3],te[4]=me[4],te[5]=me[5],te[6]=me[6],te[7]=me[7],te[8]=me[8],this}setFromMatrix4(m){let me=m.elements;return this.set(me[0],me[4],me[8],me[1],me[5],me[9],me[2],me[6],me[10]),this}multiply(m){return this.multiplyMatrices(this,m)}premultiply(m){return this.multiplyMatrices(m,this)}multiplyMatrices(a,b){let ae=a.elements,be=b.elements,te=this.elements,a11=ae[0],a12=ae[3],a13=ae[6],a21=ae[1],a22=ae[4],a23=ae[7],a31=ae[2],a32=ae[5],a33=ae[8],b11=be[0],b12=be[3],b13=be[6],b21=be[1],b22=be[4],b23=be[7],b31=be[2],b32=be[5],b33=be[8];return te[0]=a11*b11+a12*b21+a13*b31,te[3]=a11*b12+a12*b22+a13*b32,te[6]=a11*b13+a12*b23+a13*b33,te[1]=a21*b11+a22*b21+a23*b31,te[4]=a21*b12+a22*b22+a23*b32,te[7]=a21*b13+a22*b23+a23*b33,te[2]=a31*b11+a32*b21+a33*b31,te[5]=a31*b12+a32*b22+a33*b32,te[8]=a31*b13+a32*b23+a33*b33,this}multiplyScalar(s){let te=this.elements;return te[0]*=s,te[3]*=s,te[6]*=s,te[1]*=s,te[4]*=s,te[7]*=s,te[2]*=s,te[5]*=s,te[8]*=s,this}determinant(){let te=this.elements,a=te[0],b=te[1],c=te[2],d=te[3],e=te[4],f=te[5],g=te[6],h=te[7],i=te[8];return a*e*i-a*f*h-b*d*i+b*f*g+c*d*h-c*e*g}getInverse(matrix,throwOnDegenerate){let me=matrix.elements,te=this.elements,n11=me[0],n21=me[1],n31=me[2],n12=me[3],n22=me[4],n32=me[5],n13=me[6],n23=me[7],n33=me[8],t11=n33*n22-n32*n23,t12=n32*n13-n33*n12,t13=n23*n12-n22*n13,det=n11*t11+n21*t12+n31*t13;if(0===det){if(!0===throwOnDegenerate)throw new Error(".getInverse() can't invert matrix, determinant is 0");return this.identity()}let detInv=1/det;return te[0]=t11*detInv,te[1]=(n31*n23-n33*n21)*detInv,te[2]=(n32*n21-n31*n22)*detInv,te[3]=t12*detInv,te[4]=(n33*n11-n31*n13)*detInv,te[5]=(n31*n12-n32*n11)*detInv,te[6]=t13*detInv,te[7]=(n21*n13-n23*n11)*detInv,te[8]=(n22*n11-n21*n12)*detInv,this}transpose(){let tmp,m=this.elements;return tmp=m[1],m[1]=m[3],m[3]=tmp,tmp=m[2],m[2]=m[6],m[6]=tmp,tmp=m[5],m[5]=m[7],m[7]=tmp,this}getNormalMatrix(matrix4){return this.setFromMatrix4(matrix4).getInverse(this).transpose()}setUvTransform(tx,ty,sx,sy,rotation,cx,cy){let c=Math.cos(rotation),s=Math.sin(rotation);this.set(sx*c,sx*s,-sx*(c*cx+s*cy)+cx+tx,-sy*s,sy*c,-sy*(-s*cx+c*cy)+cy+ty,0,0,1)}scale(sx,sy){let te=this.elements;return te[0]*=sx,te[3]*=sx,te[6]*=sx,te[1]*=sy,te[4]*=sy,te[7]*=sy,this}rotate(theta){let c=Math.cos(theta),s=Math.sin(theta),te=this.elements,a11=te[0],a12=te[3],a13=te[6],a21=te[1],a22=te[4],a23=te[7];return te[0]=c*a11+s*a21,te[3]=c*a12+s*a22,te[6]=c*a13+s*a23,te[1]=-s*a11+c*a21,te[4]=-s*a12+c*a22,te[7]=-s*a13+c*a23,this}translate(tx,ty){let te=this.elements;return te[0]+=tx*te[2],te[3]+=tx*te[5],te[6]+=tx*te[8],te[1]+=ty*te[2],te[4]+=ty*te[5],te[7]+=ty*te[8],this}equals(matrix){let te=this.elements,me=matrix.elements;for(let i=0;i<9;i++)if(te[i]!==me[i])return!1;return!0}fromArray(array,offset){void 0===offset&&(offset=0);for(let i=0;i<9;i++)this.elements[i]=array[i+offset];return this}toArray(array,offset){void 0===array&&(array=[]),void 0===offset&&(offset=0);let te=this.elements;return array[offset]=te[0],array[offset+1]=te[1],array[offset+2]=te[2],array[offset+3]=te[3],array[offset+4]=te[4],array[offset+5]=te[5],array[offset+6]=te[6],array[offset+7]=te[7],array[offset+8]=te[8],array}applyToBufferAttribute(attribute){let v1=this.V1||new Vector3;this.V1=v1;for(let i=0,l=attribute.count;i<l;i++)v1.x=attribute.array[3*i+0],v1.y=attribute.array[3*i+1],v1.z=attribute.array[3*i+2],v1.applyMatrix3(this),attribute.array[3*i+0]=v1.x,attribute.array[3*i+1]=v1.y,attribute.array[3*i+2]=v1.z;return attribute}}class Matrix4{constructor(){Matrix4.allocate?Matrix4.allocate(this):this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}set(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){let te=this.elements;return te[0]=n11,te[4]=n12,te[8]=n13,te[12]=n14,te[1]=n21,te[5]=n22,te[9]=n23,te[13]=n24,te[2]=n31,te[6]=n32,te[10]=n33,te[14]=n34,te[3]=n41,te[7]=n42,te[11]=n43,te[15]=n44,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Matrix4).fromArray(this.elements)}copy(m){let te=this.elements,me=m.elements;return te[0]=me[0],te[1]=me[1],te[2]=me[2],te[3]=me[3],te[4]=me[4],te[5]=me[5],te[6]=me[6],te[7]=me[7],te[8]=me[8],te[9]=me[9],te[10]=me[10],te[11]=me[11],te[12]=me[12],te[13]=me[13],te[14]=me[14],te[15]=me[15],this}copyPosition(m){let te=this.elements,me=m.elements;return te[12]=me[12],te[13]=me[13],te[14]=me[14],this}extractBasis(xAxis,yAxis,zAxis){return xAxis.setFromMatrixColumn(this,0),yAxis.setFromMatrixColumn(this,1),zAxis.setFromMatrixColumn(this,2),this}makeBasis(xAxis,yAxis,zAxis){return this.set(xAxis.x,yAxis.x,zAxis.x,0,xAxis.y,yAxis.y,zAxis.y,0,xAxis.z,yAxis.z,zAxis.z,0,0,0,0,1),this}extractRotation(m){let v1=this.V1||new Vector3;this.V1=v1;let te=this.elements,me=m.elements,scaleX=1/v1.setFromMatrixColumn(m,0).length(),scaleY=1/v1.setFromMatrixColumn(m,1).length(),scaleZ=1/v1.setFromMatrixColumn(m,2).length();return te[0]=me[0]*scaleX,te[1]=me[1]*scaleX,te[2]=me[2]*scaleX,te[4]=me[4]*scaleY,te[5]=me[5]*scaleY,te[6]=me[6]*scaleY,te[8]=me[8]*scaleZ,te[9]=me[9]*scaleZ,te[10]=me[10]*scaleZ,this}makeRotationFromEuler(euler){let te=this.elements,x=euler.x,y=euler.y,z=euler.z,a=Math.cos(x),b=Math.sin(x),c=Math.cos(y),d=Math.sin(y),e=Math.cos(z),f=Math.sin(z);if("XYZ"===euler.order){let ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e,te[4]=-c*f,te[8]=d,te[1]=af+be*d,te[5]=ae-bf*d,te[9]=-b*c,te[2]=bf-ae*d,te[6]=be+af*d,te[10]=a*c}else if("YXZ"===euler.order){let ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce+df*b,te[4]=de*b-cf,te[8]=a*d,te[1]=a*f,te[5]=a*e,te[9]=-b,te[2]=cf*b-de,te[6]=df+ce*b,te[10]=a*c}else if("ZXY"===euler.order){let ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce-df*b,te[4]=-a*f,te[8]=de+cf*b,te[1]=cf+de*b,te[5]=a*e,te[9]=df-ce*b,te[2]=-a*d,te[6]=b,te[10]=a*c}else if("ZYX"===euler.order){let ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e,te[4]=be*d-af,te[8]=ae*d+bf,te[1]=c*f,te[5]=bf*d+ae,te[9]=af*d-be,te[2]=-d,te[6]=b*c,te[10]=a*c}else if("YZX"===euler.order){let ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e,te[4]=bd-ac*f,te[8]=bc*f+ad,te[1]=f,te[5]=a*e,te[9]=-b*e,te[2]=-d*e,te[6]=ad*f+bc,te[10]=ac-bd*f}else if("XZY"===euler.order){let ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e,te[4]=-f,te[8]=d*e,te[1]=ac*f+bd,te[5]=a*e,te[9]=ad*f-bc,te[2]=bc*f-ad,te[6]=b*e,te[10]=bd*f+ac}return te[3]=0,te[7]=0,te[11]=0,te[12]=0,te[13]=0,te[14]=0,te[15]=1,this}makeRotationFromQuaternion(q){let te=this.elements,x=q._x,y=q._y,z=q._z,w=q._w,x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;return te[0]=1-(yy+zz),te[4]=xy-wz,te[8]=xz+wy,te[1]=xy+wz,te[5]=1-(xx+zz),te[9]=yz-wx,te[2]=xz-wy,te[6]=yz+wx,te[10]=1-(xx+yy),te[3]=0,te[7]=0,te[11]=0,te[12]=0,te[13]=0,te[14]=0,te[15]=1,this}lookAt(eye,target,up){let x=this.V1||new Vector3,y=this.V2||new Vector3,z=this.V3||new Vector3;this.V1=x,this.V2=y,this.V3=z;let te=this.elements;return z.subVectors(eye,target),0===z.lengthSq()&&(z.z=1),z.normalize(),x.crossVectors(up,z),0===x.lengthSq()&&(1===Math.abs(up.z)?z.x+=1e-4:z.z+=1e-4,z.normalize(),x.crossVectors(up,z)),x.normalize(),y.crossVectors(z,x),te[0]=x.x,te[4]=y.x,te[8]=z.x,te[1]=x.y,te[5]=y.y,te[9]=z.y,te[2]=x.z,te[6]=y.z,te[10]=z.z,this}multiply(m){return this.multiplyMatrices(this,m)}premultiply(m){return this.multiplyMatrices(m,this)}multiplyMatrices(ae,be){if(MatrixWasm.multiply)return MatrixWasm.multiply(ae,be,this),this;let a=ae.elements,b=be.elements,out=this.elements,a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b0=b[0],b1=b[1],b2=b[2],b3=b[3];return out[0]=b0*a00+b1*a10+b2*a20+b3*a30,out[1]=b0*a01+b1*a11+b2*a21+b3*a31,out[2]=b0*a02+b1*a12+b2*a22+b3*a32,out[3]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[4],b1=b[5],b2=b[6],b3=b[7],out[4]=b0*a00+b1*a10+b2*a20+b3*a30,out[5]=b0*a01+b1*a11+b2*a21+b3*a31,out[6]=b0*a02+b1*a12+b2*a22+b3*a32,out[7]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[8],b1=b[9],b2=b[10],b3=b[11],out[8]=b0*a00+b1*a10+b2*a20+b3*a30,out[9]=b0*a01+b1*a11+b2*a21+b3*a31,out[10]=b0*a02+b1*a12+b2*a22+b3*a32,out[11]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[12],b1=b[13],b2=b[14],b3=b[15],out[12]=b0*a00+b1*a10+b2*a20+b3*a30,out[13]=b0*a01+b1*a11+b2*a21+b3*a31,out[14]=b0*a02+b1*a12+b2*a22+b3*a32,out[15]=b0*a03+b1*a13+b2*a23+b3*a33,this}multiplyScalar(s){let te=this.elements;return te[0]*=s,te[4]*=s,te[8]*=s,te[12]*=s,te[1]*=s,te[5]*=s,te[9]*=s,te[13]*=s,te[2]*=s,te[6]*=s,te[10]*=s,te[14]*=s,te[3]*=s,te[7]*=s,te[11]*=s,te[15]*=s,this}determinant(){let te=this.elements,n11=te[0],n12=te[4],n13=te[8],n14=te[12],n21=te[1],n22=te[5],n23=te[9],n24=te[13],n31=te[2],n32=te[6],n33=te[10],n34=te[14];return te[3]*(+n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34)+te[7]*(+n11*n23*n34-n11*n24*n33+n14*n21*n33-n13*n21*n34+n13*n24*n31-n14*n23*n31)+te[11]*(+n11*n24*n32-n11*n22*n34-n14*n21*n32+n12*n21*n34+n14*n22*n31-n12*n24*n31)+te[15]*(-n13*n22*n31-n11*n23*n32+n11*n22*n33+n13*n21*n32-n12*n21*n33+n12*n23*n31)}transpose(){let tmp,te=this.elements;return tmp=te[1],te[1]=te[4],te[4]=tmp,tmp=te[2],te[2]=te[8],te[8]=tmp,tmp=te[6],te[6]=te[9],te[9]=tmp,tmp=te[3],te[3]=te[12],te[12]=tmp,tmp=te[7],te[7]=te[13],te[13]=tmp,tmp=te[11],te[11]=te[14],te[14]=tmp,this}setPosition(v){let te=this.elements;return te[12]=v.x,te[13]=v.y,te[14]=v.z,this}getInverse(m,throwOnDegenerate){if(MatrixWasm.getInverse)return MatrixWasm.getInverse(this,m),this;let te=this.elements,me=m.elements,n11=me[0],n21=me[1],n31=me[2],n41=me[3],n12=me[4],n22=me[5],n32=me[6],n42=me[7],n13=me[8],n23=me[9],n33=me[10],n43=me[11],n14=me[12],n24=me[13],n34=me[14],n44=me[15],t11=n23*n34*n42-n24*n33*n42+n24*n32*n43-n22*n34*n43-n23*n32*n44+n22*n33*n44,t12=n14*n33*n42-n13*n34*n42-n14*n32*n43+n12*n34*n43+n13*n32*n44-n12*n33*n44,t13=n13*n24*n42-n14*n23*n42+n14*n22*n43-n12*n24*n43-n13*n22*n44+n12*n23*n44,t14=n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34,det=n11*t11+n21*t12+n31*t13+n41*t14;if(0===det)return te[0]=te[5]=te[10]=te[15]=1,te[1]=te[2]=te[3]=te[4]=te[6]=te[7]=te[8]=te[9]=te[11]=te[12]=te[13]=te[14]=0,this;let detInv=1/det;return te[0]=t11*detInv,te[1]=(n24*n33*n41-n23*n34*n41-n24*n31*n43+n21*n34*n43+n23*n31*n44-n21*n33*n44)*detInv,te[2]=(n22*n34*n41-n24*n32*n41+n24*n31*n42-n21*n34*n42-n22*n31*n44+n21*n32*n44)*detInv,te[3]=(n23*n32*n41-n22*n33*n41-n23*n31*n42+n21*n33*n42+n22*n31*n43-n21*n32*n43)*detInv,te[4]=t12*detInv,te[5]=(n13*n34*n41-n14*n33*n41+n14*n31*n43-n11*n34*n43-n13*n31*n44+n11*n33*n44)*detInv,te[6]=(n14*n32*n41-n12*n34*n41-n14*n31*n42+n11*n34*n42+n12*n31*n44-n11*n32*n44)*detInv,te[7]=(n12*n33*n41-n13*n32*n41+n13*n31*n42-n11*n33*n42-n12*n31*n43+n11*n32*n43)*detInv,te[8]=t13*detInv,te[9]=(n14*n23*n41-n13*n24*n41-n14*n21*n43+n11*n24*n43+n13*n21*n44-n11*n23*n44)*detInv,te[10]=(n12*n24*n41-n14*n22*n41+n14*n21*n42-n11*n24*n42-n12*n21*n44+n11*n22*n44)*detInv,te[11]=(n13*n22*n41-n12*n23*n41-n13*n21*n42+n11*n23*n42+n12*n21*n43-n11*n22*n43)*detInv,te[12]=t14*detInv,te[13]=(n13*n24*n31-n14*n23*n31+n14*n21*n33-n11*n24*n33-n13*n21*n34+n11*n23*n34)*detInv,te[14]=(n14*n22*n31-n12*n24*n31-n14*n21*n32+n11*n24*n32+n12*n21*n34-n11*n22*n34)*detInv,te[15]=(n12*n23*n31-n13*n22*n31+n13*n21*n32-n11*n23*n32-n12*n21*n33+n11*n22*n33)*detInv,this}invert(){const te=this.elements,n11=te[0],n21=te[1],n31=te[2],n41=te[3],n12=te[4],n22=te[5],n32=te[6],n42=te[7],n13=te[8],n23=te[9],n33=te[10],n43=te[11],n14=te[12],n24=te[13],n34=te[14],n44=te[15],t11=n23*n34*n42-n24*n33*n42+n24*n32*n43-n22*n34*n43-n23*n32*n44+n22*n33*n44,t12=n14*n33*n42-n13*n34*n42-n14*n32*n43+n12*n34*n43+n13*n32*n44-n12*n33*n44,t13=n13*n24*n42-n14*n23*n42+n14*n22*n43-n12*n24*n43-n13*n22*n44+n12*n23*n44,t14=n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34,det=n11*t11+n21*t12+n31*t13+n41*t14;if(0===det)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const detInv=1/det;return te[0]=t11*detInv,te[1]=(n24*n33*n41-n23*n34*n41-n24*n31*n43+n21*n34*n43+n23*n31*n44-n21*n33*n44)*detInv,te[2]=(n22*n34*n41-n24*n32*n41+n24*n31*n42-n21*n34*n42-n22*n31*n44+n21*n32*n44)*detInv,te[3]=(n23*n32*n41-n22*n33*n41-n23*n31*n42+n21*n33*n42+n22*n31*n43-n21*n32*n43)*detInv,te[4]=t12*detInv,te[5]=(n13*n34*n41-n14*n33*n41+n14*n31*n43-n11*n34*n43-n13*n31*n44+n11*n33*n44)*detInv,te[6]=(n14*n32*n41-n12*n34*n41-n14*n31*n42+n11*n34*n42+n12*n31*n44-n11*n32*n44)*detInv,te[7]=(n12*n33*n41-n13*n32*n41+n13*n31*n42-n11*n33*n42-n12*n31*n43+n11*n32*n43)*detInv,te[8]=t13*detInv,te[9]=(n14*n23*n41-n13*n24*n41-n14*n21*n43+n11*n24*n43+n13*n21*n44-n11*n23*n44)*detInv,te[10]=(n12*n24*n41-n14*n22*n41+n14*n21*n42-n11*n24*n42-n12*n21*n44+n11*n22*n44)*detInv,te[11]=(n13*n22*n41-n12*n23*n41-n13*n21*n42+n11*n23*n42+n12*n21*n43-n11*n22*n43)*detInv,te[12]=t14*detInv,te[13]=(n13*n24*n31-n14*n23*n31+n14*n21*n33-n11*n24*n33-n13*n21*n34+n11*n23*n34)*detInv,te[14]=(n14*n22*n31-n12*n24*n31-n14*n21*n32+n11*n24*n32+n12*n21*n34-n11*n22*n34)*detInv,te[15]=(n12*n23*n31-n13*n22*n31+n13*n21*n32-n11*n23*n32-n12*n21*n33+n11*n22*n33)*detInv,this}scale(v){let te=this.elements,x=v.x,y=v.y,z=v.z;return te[0]*=x,te[4]*=y,te[8]*=z,te[1]*=x,te[5]*=y,te[9]*=z,te[2]*=x,te[6]*=y,te[10]*=z,te[3]*=x,te[7]*=y,te[11]*=z,this}getMaxScaleOnAxis(){let te=this.elements,scaleXSq=te[0]*te[0]+te[1]*te[1]+te[2]*te[2],scaleYSq=te[4]*te[4]+te[5]*te[5]+te[6]*te[6],scaleZSq=te[8]*te[8]+te[9]*te[9]+te[10]*te[10];return Math.sqrt(Math.max(scaleXSq,scaleYSq,scaleZSq))}makeTranslation(x,y,z){return this.set(1,0,0,x,0,1,0,y,0,0,1,z,0,0,0,1),this}makeRotationX(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1),this}makeRotationY(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1),this}makeRotationZ(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(c,-s,0,0,s,c,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(axis,angle){let c=Math.cos(angle),s=Math.sin(angle),t=1-c,x=axis.x,y=axis.y,z=axis.z,tx=t*x,ty=t*y;return this.set(tx*x+c,tx*y-s*z,tx*z+s*y,0,tx*y+s*z,ty*y+c,ty*z-s*x,0,tx*z-s*y,ty*z+s*x,t*z*z+c,0,0,0,0,1),this}makeScale(x,y,z){return this.set(x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1),this}makeShear(x,y,z){return this.set(1,y,z,0,x,1,z,0,x,y,1,0,0,0,0,1),this}compose(position,quaternion,scale){return this.makeRotationFromQuaternion(quaternion),this.scale(scale),this.setPosition(position),this}decompose(position,quaternion,scale){let vector=this.V1||new Vector3;this.V1=vector;let matrix=this.M1||new Matrix4;this.M1=matrix;let te=this.elements,sx=vector.set(te[0],te[1],te[2]).length(),sy=vector.set(te[4],te[5],te[6]).length(),sz=vector.set(te[8],te[9],te[10]).length();this.determinant()<0&&(sx=-sx),position.x=te[12],position.y=te[13],position.z=te[14],matrix.copy(this);let invSX=1/sx,invSY=1/sy,invSZ=1/sz;return matrix.elements[0]*=invSX,matrix.elements[1]*=invSX,matrix.elements[2]*=invSX,matrix.elements[4]*=invSY,matrix.elements[5]*=invSY,matrix.elements[6]*=invSY,matrix.elements[8]*=invSZ,matrix.elements[9]*=invSZ,matrix.elements[10]*=invSZ,quaternion.setFromRotationMatrix(matrix),scale.x=sx,scale.y=sy,scale.z=sz,this}makePerspective(left,right,top,bottom,near,far){let te=this.elements,x=2*near/(right-left),y=2*near/(top-bottom),a=(right+left)/(right-left),b=(top+bottom)/(top-bottom),c=-(far+near)/(far-near),d=-2*far*near/(far-near);return te[0]=x,te[4]=0,te[8]=a,te[12]=0,te[1]=0,te[5]=y,te[9]=b,te[13]=0,te[2]=0,te[6]=0,te[10]=c,te[14]=d,te[3]=0,te[7]=0,te[11]=-1,te[15]=0,this}makeOrthographic(left,right,top,bottom,near,far){let te=this.elements,w=1/(right-left),h=1/(top-bottom),p=1/(far-near),x=(right+left)*w,y=(top+bottom)*h,z=(far+near)*p;return te[0]=2*w,te[4]=0,te[8]=0,te[12]=-x,te[1]=0,te[5]=2*h,te[9]=0,te[13]=-y,te[2]=0,te[6]=0,te[10]=-2*p,te[14]=-z,te[3]=0,te[7]=0,te[11]=0,te[15]=1,this}equals(matrix){let te=this.elements,me=matrix.elements;return te[0]==me[0]&&(te[1]==me[1]&&(te[2]==me[2]&&(te[3]==me[3]&&(te[4]==me[4]&&(te[5]==me[5]&&(te[6]==me[6]&&(te[7]==me[7]&&(te[8]==me[8]&&(te[9]==me[9]&&(te[10]==me[10]&&(te[11]==me[11]&&(te[12]==me[12]&&(te[13]==me[13]&&(te[14]==me[14]&&te[15]==me[15]))))))))))))))}fromArray(array,offset=0){let te=this.elements;return te[0]=array[0+offset],te[1]=array[1+offset],te[2]=array[2+offset],te[3]=array[3+offset],te[4]=array[4+offset],te[5]=array[5+offset],te[6]=array[6+offset],te[7]=array[7+offset],te[8]=array[8+offset],te[9]=array[9+offset],te[10]=array[10+offset],te[11]=array[11+offset],te[12]=array[12+offset],te[13]=array[13+offset],te[14]=array[14+offset],te[15]=array[15+offset],this}toArray(array,offset){void 0===array&&(array=[]),void 0===offset&&(offset=0);let te=this.elements;return array[offset]=te[0],array[offset+1]=te[1],array[offset+2]=te[2],array[offset+3]=te[3],array[offset+4]=te[4],array[offset+5]=te[5],array[offset+6]=te[6],array[offset+7]=te[7],array[offset+8]=te[8],array[offset+9]=te[9],array[offset+10]=te[10],array[offset+11]=te[11],array[offset+12]=te[12],array[offset+13]=te[13],array[offset+14]=te[14],array[offset+15]=te[15],array}applyToBufferAttribute(attribute){let v1=this.V1||new Vector3;this.V1=v1;for(let i=0,l=attribute.count;i<l;i++)v1.x=attribute.array[3*i+0],v1.y=attribute.array[3*i+1],v1.z=attribute.array[3*i+2],v1.applyMatrix4(this),attribute.array[3*i+0]=v1.x,attribute.array[3*i+1]=v1.y,attribute.array[3*i+2]=v1.z;return attribute}isIdentity(){let te=this.elements;return 1==te[0]&&(0==te[1]&&(0==te[2]&&(0==te[3]&&(0==te[4]&&(1==te[5]&&(0==te[6]&&(0==te[7]&&(0==te[8]&&(0==te[9]&&(1==te[10]&&(0==te[11]&&(0==te[12]&&(0==te[13]&&(0==te[14]&&1==te[15]))))))))))))))}}Matrix4.allocate=ref=>{MatrixWasm.allocate(ref)};class Plane{constructor(normal,constant){this.normal=void 0!==normal?normal:new Vector3(1,0,0),this.constant=void 0!==constant?constant:0}set(normal,constant){return this.normal.copy(normal),this.constant=constant,this}setComponents(x,y,z,w){return this.normal.set(x,y,z),this.constant=w,this}setFromNormalAndCoplanarPoint(normal,point){return this.normal.copy(normal),this.constant=-point.dot(this.normal),this}setFromCoplanarPoints(a,b,c){let v1=this.V1||new Vector3,v2=this.V2||new Vector3;this.V1=v1,this.V2=v2;var normal=v1.subVectors(c,b).cross(v2.subVectors(a,b)).normalize();return this.setFromNormalAndCoplanarPoint(normal,a),this}clone(){return(new Plane).copy(this)}copy(plane){return this.normal.copy(plane.normal),this.constant=plane.constant,this}normalize(){var inverseNormalLength=1/this.normal.length();return this.normal.multiplyScalar(inverseNormalLength),this.constant*=inverseNormalLength,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(point){return this.normal.dot(point)+this.constant}distanceToSphere(sphere){return this.distanceToPoint(sphere.center)-sphere.radius}projectPoint(point,target){return target.copy(this.normal).multiplyScalar(-this.distanceToPoint(point)).add(point)}intersectLine(line,target){let v1=this.V1||new Vector3;this.V1=v1;var direction=line.delta(v1),denominator=this.normal.dot(direction);if(0===denominator)return 0===this.distanceToPoint(line.start)?target.copy(line.start):void 0;var t=-(line.start.dot(this.normal)+this.constant)/denominator;return t<0||t>1?void 0:target.copy(direction).multiplyScalar(t).add(line.start)}intersectsLine(line){var startSign=this.distanceToPoint(line.start),endSign=this.distanceToPoint(line.end);return startSign<0&&endSign>0||endSign<0&&startSign>0}intersectsBox(box){return box.intersectsPlane(this)}intersectsSphere(sphere){return sphere.intersectsPlane(this)}coplanarPoint(target){return target.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(matrix,optionalNormalMatrix){let v1=this.V1||new Vector3;this.V1=v1;let m1=this.M1||new Matrix3;this.M1=m1;var normalMatrix=optionalNormalMatrix||m1.getNormalMatrix(matrix),referencePoint=this.coplanarPoint(v1).applyMatrix4(matrix),normal=this.normal.applyMatrix3(normalMatrix).normalize();return this.constant=-referencePoint.dot(normal),this}translate(offset){return this.constant-=offset.dot(this.normal),this}equals(plane){return plane.normal.equals(this.normal)&&plane.constant===this.constant}}class Quaternion{constructor(x,y,z,w){this._x=x||0,this._y=y||0,this._z=z||0,this._w=void 0!==w?w:1,this.isQuaternion=!0}get x(){return this._x}set x(v){if(zUtils3D.LOCAL&&isNaN(v))return console.trace("Quaternion::NaN");let dirty=Math.abs(this._x-v)>Base3D.DIRTY_EPSILON;this._x=v,dirty&&this.onChangeCallback()}get y(){return this._y}set y(v){if(zUtils3D.LOCAL&&isNaN(v))return console.trace("Quaternion::NaN");let dirty=Math.abs(this._y-v)>Base3D.DIRTY_EPSILON;this._y=v,dirty&&this.onChangeCallback()}get z(){return this._z}set z(v){if(zUtils3D.LOCAL&&isNaN(v))return console.trace("Quaternion::NaN");let dirty=Math.abs(this._z-v)>Base3D.DIRTY_EPSILON;this._z=v,dirty&&this.onChangeCallback()}get w(){return this._w}set w(v){if(zUtils3D.LOCAL&&isNaN(v))return console.trace("Quaternion::NaN");let dirty=Math.abs(this._w-v)>Base3D.DIRTY_EPSILON;this._w=v,dirty&&this.onChangeCallback()}clone(){return new Quaternion(this._x,this._y,this._z,this._w)}copy(quaternion){const abs=Math.abs;let dirty=abs(this._x-quaternion.x)>Base3D.DIRTY_EPSILON||abs(this._y-quaternion.y)>Base3D.DIRTY_EPSILON||abs(this._z-quaternion.z)>Base3D.DIRTY_EPSILON||abs(this._w-quaternion.w)>Base3D.DIRTY_EPSILON;return this._x=quaternion.x,this._y=quaternion.y,this._z=quaternion.z,this._w=quaternion.w,dirty&&this.onChangeCallback(),this}set(x,y,z,w){const abs=Math.abs;let dirty=abs(this._x-x)>Base3D.DIRTY_EPSILON||abs(this._y-y)>Base3D.DIRTY_EPSILON||abs(this._z-z)>Base3D.DIRTY_EPSILON||abs(this._w-w)>Base3D.DIRTY_EPSILON;this._x=x,this._y=y,this._z=z,this._w=w,dirty&&this.onChangeCallback()}setFromEuler(euler,update){let x=euler._x,y=euler._y,z=euler._z,order=euler.order,cos=Math.cos,sin=Math.sin,c1=cos(x/2),c2=cos(y/2),c3=cos(z/2),s1=sin(x/2),s2=sin(y/2),s3=sin(z/2);return"XYZ"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"YXZ"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3):"ZXY"===order?(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"ZYX"===order?(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3):"YZX"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"XZY"===order&&(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3),!1!==update&&this.onChangeCallback(),this}setFromAxisAngle(axis,angle){let halfAngle=angle/2,s=Math.sin(halfAngle);return this._x=axis.x*s,this._y=axis.y*s,this._z=axis.z*s,this._w=Math.cos(halfAngle),this.onChangeCallback(),this}setFromRotationMatrix(m){let s,te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10],trace=m11+m22+m33;return trace>0?(s=.5/Math.sqrt(trace+1),this._w=.25/s,this._x=(m32-m23)*s,this._y=(m13-m31)*s,this._z=(m21-m12)*s):m11>m22&&m11>m33?(s=2*Math.sqrt(1+m11-m22-m33),this._w=(m32-m23)/s,this._x=.25*s,this._y=(m12+m21)/s,this._z=(m13+m31)/s):m22>m33?(s=2*Math.sqrt(1+m22-m11-m33),this._w=(m13-m31)/s,this._x=(m12+m21)/s,this._y=.25*s,this._z=(m23+m32)/s):(s=2*Math.sqrt(1+m33-m11-m22),this._w=(m21-m12)/s,this._x=(m13+m31)/s,this._y=(m23+m32)/s,this._z=.25*s),this.onChangeCallback(),this}setFromUnitVectors(vFrom,vTo){let v1=this.V1||new Vector3;this.V1=v1;let r=vFrom.dot(vTo)+1;return r<1e-6?(r=0,Math.abs(vFrom.x)>Math.abs(vFrom.z)?v1.set(-vFrom.y,vFrom.x,0):v1.set(0,-vFrom.z,vFrom.y)):v1.crossVectors(vFrom,vTo),this._x=v1.x,this._y=v1.y,this._z=v1.z,this._w=r,this.normalize()}inverse(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this}dot(v){const w=void 0===v._w?1:v._w;return this._x*v._x+this._y*v._y+this._z*v._z+this._w*w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let l=this.length();return 0===l?(this._x=0,this._y=0,this._z=0,this._w=1):(l=1/l,this._x=this._x*l,this._y=this._y*l,this._z=this._z*l,this._w=this._w*l),this.onChangeCallback(),this}multiply(q){return this.multiplyQuaternions(this,q)}premultiply(q){return this.multiplyQuaternions(q,this)}multiplyQuaternions(a,b){let qax=a._x,qay=a._y,qaz=a._z,qaw=a._w,qbx=b._x,qby=b._y,qbz=b._z,qbw=b._w;return this._x=qax*qbw+qaw*qbx+qay*qbz-qaz*qby,this._y=qay*qbw+qaw*qby+qaz*qbx-qax*qbz,this._z=qaz*qbw+qaw*qbz+qax*qby-qay*qbx,this._w=qaw*qbw-qax*qbx-qay*qby-qaz*qbz,this.onChangeCallback(),this}slerp(qb,t,hz=!0){if(0===(t=hz?Math.framerateNormalizeLerpAlpha(t):Math.clamp(t)))return this;if(1===t)return this.copy(qb);let x=this._x,y=this._y,z=this._z,w=this._w,cosHalfTheta=w*qb._w+x*qb._x+y*qb._y+z*qb._z;if(cosHalfTheta<0?(this._w=-qb._w,this._x=-qb._x,this._y=-qb._y,this._z=-qb._z,cosHalfTheta=-cosHalfTheta):this.copy(qb),cosHalfTheta>=1)return this._w=w,this._x=x,this._y=y,this._z=z,this;let sinHalfTheta=Math.sqrt(1-cosHalfTheta*cosHalfTheta);if(Math.abs(sinHalfTheta)<.001)return this._w=.5*(w+this._w),this._x=.5*(x+this._x),this._y=.5*(y+this._y),this._z=.5*(z+this._z),this;let halfTheta=Math.atan2(sinHalfTheta,cosHalfTheta),ratioA=Math.sin((1-t)*halfTheta)/sinHalfTheta,ratioB=Math.sin(t*halfTheta)/sinHalfTheta;return this._w=w*ratioA+this._w*ratioB,this._x=x*ratioA+this._x*ratioB,this._y=y*ratioA+this._y*ratioB,this._z=z*ratioA+this._z*ratioB,this.onChangeCallback(),this}equals(quaternion){return quaternion._x===this._x&&quaternion._y===this._y&&quaternion._z===this._z&&quaternion._w===this._w}fromArray(array,offset){return void 0===offset&&(offset=0),this._x=array[offset],this._y=array[offset+1],this._z=array[offset+2],this._w=array[offset+3],this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array[offset+3]=this._w,array}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}class RayManager{constructor(origin,direction,near=0,far=1/0){this.ray=new Ray(origin,direction),this.near=near,this.far=far,this.params={Mesh:{},Points:{threshold:1}}}set(origin,direction){return this.ray.set(origin,direction),this}setFromCamera(coords,camera){camera.isPerspective?(this.ray.origin.setFromMatrixPosition(camera.matrixWorld),this.ray.direction.set(coords.x,coords.y,.5).unproject(camera).sub(this.ray.origin).normalize()):(this.ray.origin.set(coords.x,coords.y,(camera.near+camera.far)/(camera.near-camera.far)).unproject(camera),this.ray.direction.set(0,0,-1).transformDirection(camera.matrixWorld))}_ascSort(a,b){return a.distance-b.distance}_intersectObject(object,raycaster,intersects,recursive,forceAllVisible){if((!1!==object.visible||forceAllVisible)&&(object.raycast&&object.raycast(raycaster,intersects),!0===recursive)){let children=object.children;for(let i=0,l=children.length;i<l;i++)this._intersectObject(children[i],raycaster,intersects,!0)}}intersectObject(object,recursive,optionalTarget,forceAllVisible){let intersects=optionalTarget||[];return this._intersectObject(object,this,intersects,recursive,forceAllVisible),intersects.sort(this._ascSort),intersects}intersectObjects(objects,recursive,optionalTarget){let intersects=optionalTarget||[];for(let i=0,l=objects.length;i<l;i++)this._intersectObject(objects[i],this,intersects,recursive);return intersects.sort(this._ascSort),intersects}}class Ray{constructor(origin=new Vector3,direction=new Vector3){this.origin=origin,this.direction=direction}set(origin,direction){return this.origin.copy(origin),this.direction.copy(direction),this}clone(){return(new Ray).copy(this)}copy(ray){return this.origin.copy(ray.origin),this.direction.copy(ray.direction),this}at(t,target=new Vector3){return target.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(v){return this.direction.copy(v).sub(this.origin).normalize(),this}recast(t){let v1=this.V1||new Vector3;this.V1=v1,this.origin.copy(this.at(t,v1))}closestPointToPoint(point,target=new Vector3){target.subVectors(point,this.origin);let directionDistance=target.dot(this.direction);return directionDistance<0?target.copy(this.origin):target.copy(this.direction).multiplyScalar(directionDistance).add(this.origin)}distanceToPoint(point){return Math.sqrt(this.distanceSqToPoint(point))}distanceSqToPoint(point){let v1=this.V1||new Vector3;this.V1=v1;let directionDistance=v1.subVectors(point,this.origin).dot(this.direction);return directionDistance<0?this.origin.distanceToSquared(point):(v1.copy(this.direction).multiplyScalar(directionDistance).add(this.origin),v1.distanceToSquared(point))}distanceSqToSegment(v0,v1,optionalPointOnRay,optionalPointOnSegment){let segCenter=this.V1||new Vector3,segDir=this.V2||new Vector3,diff=this.V3||new Vector3;this.V1=segCenter,this.V2=segDir,this.V3=diff,segCenter.copy(v0).add(v1).multiplyScalar(.5),segDir.copy(v1).sub(v0).normalize(),diff.copy(this.origin).sub(segCenter);let s0,s1,sqrDist,extDet,segExtent=.5*v0.distanceTo(v1),a01=-this.direction.dot(segDir),b0=diff.dot(this.direction),b1=-diff.dot(segDir),c=diff.lengthSq(),det=Math.abs(1-a01*a01);if(det>0)if(s0=a01*b1-b0,s1=a01*b0-b1,extDet=segExtent*det,s0>=0)if(s1>=-extDet)if(s1<=extDet){let invDet=1/det;s0*=invDet,s1*=invDet,sqrDist=s0*(s0+a01*s1+2*b0)+s1*(a01*s0+s1+2*b1)+c}else s1=segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;else s1=-segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;else s1<=-extDet?(s0=Math.max(0,-(-a01*segExtent+b0)),s1=s0>0?-segExtent:Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=-s0*s0+s1*(s1+2*b1)+c):s1<=extDet?(s0=0,s1=Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=s1*(s1+2*b1)+c):(s0=Math.max(0,-(a01*segExtent+b0)),s1=s0>0?segExtent:Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=-s0*s0+s1*(s1+2*b1)+c);else s1=a01>0?-segExtent:segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;return optionalPointOnRay&&optionalPointOnRay.copy(this.direction).multiplyScalar(s0).add(this.origin),optionalPointOnSegment&&optionalPointOnSegment.copy(segDir).multiplyScalar(s1).add(segCenter),sqrDist}intersectSphere(sphere,target){let v1=this.V1||new Vector3;this.V1=v1,v1.subVectors(sphere.center,this.origin);let tca=v1.dot(this.direction),d2=v1.dot(v1)-tca*tca,radius2=sphere.radius*sphere.radius;if(d2>radius2)return null;let thc=Math.sqrt(radius2-d2),t0=tca-thc,t1=tca+thc;return t0<0&&t1<0?null:t0<0?this.at(t1,target):this.at(t0,target)}intersectsSphere(sphere){return this.distanceSqToPoint(sphere.center)<=sphere.radius*sphere.radius}distanceToPlane(plane){let denominator=plane.normal.dot(this.direction);if(0===denominator)return 0===plane.distanceToPoint(this.origin)?0:null;let t=-(this.origin.dot(plane.normal)+plane.constant)/denominator;return t>=0?t:null}intersectPlane(plane,target){let t=this.distanceToPlane(plane);return null===t?null:this.at(t,target)}intersectsPlane(plane){let distToPoint=plane.distanceToPoint(this.origin);return 0===distToPoint||plane.normal.dot(this.direction)*distToPoint<0}intersectBox(box,target){let tmin,tmax,tymin,tymax,tzmin,tzmax,invdirx=1/this.direction.x,invdiry=1/this.direction.y,invdirz=1/this.direction.z,origin=this.origin;return invdirx>=0?(tmin=(box.min.x-origin.x)*invdirx,tmax=(box.max.x-origin.x)*invdirx):(tmin=(box.max.x-origin.x)*invdirx,tmax=(box.min.x-origin.x)*invdirx),invdiry>=0?(tymin=(box.min.y-origin.y)*invdiry,tymax=(box.max.y-origin.y)*invdiry):(tymin=(box.max.y-origin.y)*invdiry,tymax=(box.min.y-origin.y)*invdiry),tmin>tymax||tymin>tmax?null:((tymin>tmin||tmin!=tmin)&&(tmin=tymin),(tymax<tmax||tmax!=tmax)&&(tmax=tymax),invdirz>=0?(tzmin=(box.min.z-origin.z)*invdirz,tzmax=(box.max.z-origin.z)*invdirz):(tzmin=(box.max.z-origin.z)*invdirz,tzmax=(box.min.z-origin.z)*invdirz),tmin>tzmax||tzmin>tmax?null:((tzmin>tmin||tmin!=tmin)&&(tmin=tzmin),(tzmax<tmax||tmax!=tmax)&&(tmax=tzmax),tmax<0?null:this.at(tmin>=0?tmin:tmax,target)))}intersectsBox(box){let v=this.V1||new Vector3;return this.V1=v,null!==this.intersectBox(box,v)}intersectsTriangle(a,b,c,backfaceCulling,target){let diff=this.V1||new Vector3,edge1=this.V2||new Vector3,edge2=this.V3||new Vector3,normal=this.V4||new Vector3;this.V1=diff,this.V2=edge1,this.V3=edge2,this.V4=normal,edge1.subVectors(b,a),edge2.subVectors(c,a),normal.crossVectors(edge1,edge2);let sign,DdN=this.direction.dot(normal);if(DdN>0){if(backfaceCulling)return null;sign=1}else{if(!(DdN<0))return null;sign=-1,DdN=-DdN}diff.subVectors(this.origin,a);let DdQxE2=sign*this.direction.dot(edge2.crossVectors(diff,edge2));if(DdQxE2<0)return null;let DdE1xQ=sign*this.direction.dot(edge1.cross(diff));if(DdE1xQ<0)return null;if(DdQxE2+DdE1xQ>DdN)return null;let QdN=-sign*diff.dot(normal);return QdN<0?null:this.at(QdN/DdN,target)}applyMatrix4(matrix4){return this.origin.applyMatrix4(matrix4),this.direction.transformDirection(matrix4),this}equals(ray){return ray.origin.equals(this.origin)&&ray.direction.equals(this.direction)}}class Sphere{constructor(center=new Vector3,radius=0){this.center=center,this.radius=radius}set(center,radius){return this.center.copy(center),this.radius=radius,this}setFromPoints(points,optionalCenter){let box=this.V1||new Box3;this.V1=box;let center=this.center;void 0!==optionalCenter?center.copy(optionalCenter):box.setFromPoints(points).getCenter(center);let maxRadiusSq=0;for(let i=0,il=points.length;i<il;i++)maxRadiusSq=Math.max(maxRadiusSq,center.distanceToSquared(points[i]));return this.radius=Math.sqrt(maxRadiusSq),this}clone(){return(new this.constructor).copy(this)}copy(sphere){return this.center.copy(sphere.center),this.radius=sphere.radius,this}empty(){return this.radius<=0}containsPoint(point){return point.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(point){return point.distanceTo(this.center)-this.radius}intersectsSphere(sphere){let radiusSum=this.radius+sphere.radius;return sphere.center.distanceToSquared(this.center)<=radiusSum*radiusSum}intersectsBox(box){return box.intersectsSphere(this)}intersectsPlane(plane){return Math.abs(plane.distanceToPoint(this.center))<=this.radius}clampPoint(point,target=new Vector3){let deltaLengthSq=this.center.distanceToSquared(point);return target.copy(point),deltaLengthSq>this.radius*this.radius&&(target.sub(this.center).normalize(),target.multiplyScalar(this.radius).add(this.center)),target}getBoundingBox(target=new Box3){return target.set(this.center,this.center),target.expandByScalar(this.radius),target}applyMatrix4(matrix){return this.center.applyMatrix4(matrix),this.radius=this.radius*matrix.getMaxScaleOnAxis(),this}translate(offset){return this.center.add(offset),this}equals(sphere){return sphere.center.equals(this.center)&&sphere.radius===this.radius}}class Spherical{constructor(radius=1,phi=0,theta=0){this.radius=radius,this.phi=phi,this.theta=theta}set(radius,phi,theta){return this.radius=radius,this.phi=phi,this.theta=theta,this}clone(){return(new Spherical).copy(this)}copy(other){return this.radius=other.radius,this.phi=other.phi,this.theta=other.theta,this}makeSafe(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this}setFromVector3(vec3){return this.radius=vec3.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(vec3.x,vec3.z),this.phi=Math.acos(Math.clamp(vec3.y/this.radius,-1,1))),this}}class Triangle{constructor(a=new Vector3,b=new Vector3,c=new Vector3){this.a=a,this.b=b,this.c=c}set(a,b,c){return this.a.copy(a),this.b.copy(b),this.c.copy(c),this}setFromPointsAndIndices(points,i0,i1,i2){return this.a.copy(points[i0]),this.b.copy(points[i1]),this.c.copy(points[i2]),this}clone(){return(new Triangle).copy(this)}copy(triangle){return this.a.copy(triangle.a),this.b.copy(triangle.b),this.c.copy(triangle.c),this}getArea(){let v0=this.V0||new Vector3,v1=this.V1||new Vector3;return this.V0=v0,this.V1=v1,v0.subVectors(this.c,this.b),v1.subVectors(this.a,this.b),.5*v0.cross(v1).length()}getMidpoint(target=new Vector3){return target.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(target){return Triangle.getNormal(this.a,this.b,this.c,target)}getPlane(target=new Vector3){return target.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(point,target){return Triangle.getBarycoord(point,this.a,this.b,this.c,target)}containsPoint(point){return Triangle.containsPoint(point,this.a,this.b,this.c)}intersectsBox(box){return box.intersectsTriangle(this)}equals(triangle){return triangle.a.equals(this.a)&&triangle.b.equals(this.b)&&triangle.c.equals(this.c)}}class Vector2{constructor(x=0,y=0){this.x=x,this.y=y}set(x,y){return this.x=x,this.y=y,this}get width(){return this.x}get height(){return this.y}setScalar(s){return this.x=this.y=s,this}clone(){return new Vector2(this.x,this.y)}copy(v){return this.x=v.x,this.y=v.y,this}add(v){return this.x+=v.x,this.y+=v.y,this}addScalar(s){return this.x+=s,this.y+=s,this}addVectors(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this}addScaledVector(v,s){return this.x+=v.x*s,this.y+=v.y*s,this}sub(v){return this.x-=v.x,this.y-=v.y,this}subScalar(s){return this.x-=s,this.y-=s,this}subVectors(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this}multiply(v){return this.x*=v.x,this.y*=v.y,this}multiplyScalar(scalar){return this.x*=scalar,this.y*=scalar,this}divide(v){return this.x/=v.x,this.y/=v.y,this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}applyMatrix3(m){let x=this.x,y=this.y,e=m.elements;return this.x=e[0]*x+e[3]*y+e[6],this.y=e[1]*x+e[4]*y+e[7],this}min(v){return this.x=Math.min(this.x,v.x),this.y=Math.min(this.y,v.y),this}max(v){return this.x=Math.max(this.x,v.x),this.y=Math.max(this.y,v.y),this}clamp(min,max){return this.x=Math.max(min.x,Math.min(max.x,this.x)),this.y=Math.max(min.y,Math.min(max.y,this.y)),this}clampScalar(minVal,maxVal){let min=new Vector2,max=new Vector2;return min.set(minVal,minVal),max.set(maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(v){return this.x*v.x+this.y*v.y}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){let angle=Math.atan2(this.y,this.x);return angle<0&&(angle+=2*Math.PI),angle}angleTo(a,b){return b||(b=this),Math.atan2(a.y-b.y,a.x-b.x)}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this.x-v.x,dy=this.y-v.y;return dx*dx+dy*dy}manhattanDistanceTo(v){return Math.abs(this.x-v.x)+Math.abs(this.y-v.y)}setLength(length){return this.normalize().multiplyScalar(length)}lerp(v,alpha,hz){return this.x=Math.lerp(v.x,this.x,alpha,hz),this.y=Math.lerp(v.y,this.y,alpha,hz),this}lerpVectors(v1,v2,alpha){return this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}equals(v){return v.x===this.x&&v.y===this.y}setAngleRadius(a,r){return this.x=Math.cos(a)*r,this.y=Math.sin(a)*r,this}addAngleRadius(a,r){return this.x+=Math.cos(a)*r,this.y+=Math.sin(a)*r,this}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=Number(array[offset]),this.y=Number(array[offset+1]),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array}rotateAround(center,angle){let c=Math.cos(angle),s=Math.sin(angle),x=this.x-center.x,y=this.y-center.y;return this.x=x*c-y*s+center.x,this.y=x*s+y*c+center.y,this}fromBufferAttribute(attribute,index){this.x=attribute.array[2*index+0],this.y=attribute.array[2*index+1]}}class Vector3{constructor(x,y,z){this.x=x||0,this.y=y||0,this.z=z||0}set(x,y,z){return this.x=x||0,this.y=y||0,this.z=z||0,this}setScalar(scalar){return this.x=scalar,this.y=scalar,this.z=scalar,this}clone(){return new Vector3(this.x,this.y,this.z)}copy(v){return this.x=v.x,this.y=v.y,this.z=v.z,this}add(v){return this.x+=v.x,this.y+=v.y,this.z+=v.z,this}addScalar(s){return this.x+=s,this.y+=s,this.z+=s,this}addVectors(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this}addScaledVector(v,s){return this.x+=v.x*s,this.y+=v.y*s,this.z+=v.z*s,this}sub(v){return this.x-=v.x,this.y-=v.y,this.z-=v.z,this}subScalar(s){return this.x-=s,this.y-=s,this.z-=s,this}subVectors(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this}multiply(v){return this.x*=v.x,this.y*=v.y,this.z*=v.z,this}multiplyScalar(scalar){return this.x*=scalar,this.y*=scalar,this.z*=scalar,this}multiplyVectors(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this}applyEuler(euler){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromEuler(euler))}applyAxisAngle(axis,angle){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromAxisAngle(axis,angle))}applyMatrix3(m){let x=this.x,y=this.y,z=this.z,e=m.elements;return this.x=e[0]*x+e[3]*y+e[6]*z,this.y=e[1]*x+e[4]*y+e[7]*z,this.z=e[2]*x+e[5]*y+e[8]*z,this}applyMatrix4(m){let x=this.x,y=this.y,z=this.z,e=m.elements,w=1/(e[3]*x+e[7]*y+e[11]*z+e[15]);return this.x=(e[0]*x+e[4]*y+e[8]*z+e[12])*w,this.y=(e[1]*x+e[5]*y+e[9]*z+e[13])*w,this.z=(e[2]*x+e[6]*y+e[10]*z+e[14])*w,this}applyQuaternion(q){let x=this.x,y=this.y,z=this.z,qx=q.x,qy=q.y,qz=q.z,qw=q.w;if(0==qx&&0==qy&&0==qz&&1==qw)return this;let ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this.z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this}project(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,matrix.getInverse(camera.matrixWorld)),this.applyMatrix4(matrix)}unproject(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.matrixWorld,matrix.getInverse(camera.projectionMatrix)),this.applyMatrix4(matrix)}transformDirection(m){let x=this.x,y=this.y,z=this.z,e=m.elements;return this.x=e[0]*x+e[4]*y+e[8]*z,this.y=e[1]*x+e[5]*y+e[9]*z,this.z=e[2]*x+e[6]*y+e[10]*z,this.normalize()}divide(v){return this.x/=v.x,this.y/=v.y,this.z/=v.z,this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}min(v){return this.x=Math.min(this.x,v.x),this.y=Math.min(this.y,v.y),this.z=Math.min(this.z,v.z),this}max(v){return this.x=Math.max(this.x,v.x),this.y=Math.max(this.y,v.y),this.z=Math.max(this.z,v.z),this}clamp(min,max){return this.x=Math.max(min.x,Math.min(max.x,this.x)),this.y=Math.max(min.y,Math.min(max.y,this.y)),this.z=Math.max(min.z,Math.min(max.z,this.z)),this}clampScalar(minVal,maxVal){let min=new Vector3,max=new Vector3;return min.set(minVal,minVal,minVal),max.set(maxVal,maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(v){return this.x*v.x+this.y*v.y+this.z*v.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(length){return this.normalize().multiplyScalar(length)}lerp(v,alpha,hz){return this.x=Math.lerp(v.x,this.x,alpha,hz),this.y=Math.lerp(v.y,this.y,alpha,hz),this.z=Math.lerp(v.z,this.z,alpha,hz),this}lerpVectors(v1,v2,alpha){return this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}cross(v){return this.crossVectors(this,v)}crossVectors(a,b){let ax=a.x,ay=a.y,az=a.z,bx=b.x,by=b.y,bz=b.z;return this.x=ay*bz-az*by,this.y=az*bx-ax*bz,this.z=ax*by-ay*bx,this}projectOnVector(vector){let scalar=vector.dot(this)/vector.lengthSq();return this.copy(vector).multiplyScalar(scalar)}projectOnPlane(planeNormal){let v1=this.V1||new Vector3;return this.V1=v1,v1.copy(this).projectOnVector(planeNormal),this.sub(v1)}reflect(normal){let v1=this.V1||new Vector3;return this.V1=v1,this.sub(v1.copy(normal).multiplyScalar(2*this.dot(normal)))}angleTo(v){let theta=this.dot(v)/Math.sqrt(this.lengthSq()*v.lengthSq());return Math.acos(Math.clamp(theta,-1,1))}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this.x-v.x,dy=this.y-v.y,dz=this.z-v.z;return dx*dx+dy*dy+dz*dz}manhattanDistanceTo(v){return Math.abs(this.x-v.x)+Math.abs(this.y-v.y)+Math.abs(this.z-v.z)}setFromCylindrical(c){return this.x=c.radius*Math.sin(c.theta),this.y=c.y,this.z=c.radius*Math.cos(c.theta),this}setFromMatrixPosition(m){let e=m.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(m){let sx=this.setFromMatrixColumn(m,0).length(),sy=this.setFromMatrixColumn(m,1).length(),sz=this.setFromMatrixColumn(m,2).length();return this.x=sx,this.y=sy,this.z=sz,this}setFromMatrixColumn(m,index){return this.fromArray(m.elements,4*index)}setAngleRadius(a,r,dir="xy"){return this[dir[0]]=Math.cos(a)*r,this[dir[1]]=Math.sin(a)*r,this}addAngleRadius(a,r,dir="xy"){return this[dir[0]]+=Math.cos(a)*r,this[dir[1]]+=Math.sin(a)*r,this}equals(v){return v.x===this.x&&v.y===this.y&&v.z===this.z}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=Number(array[offset]),this.y=Number(array[offset+1]),this.z=Number(array[offset+2]),this}setFromSpherical(s){this.setFromSphericalCoords(s.radius,s.phi,s.theta)}setFromSphericalCoords(radius,phi,theta){let sinPhiRadius=Math.sin(phi)*radius;return this.x=sinPhiRadius*Math.sin(theta),this.y=Math.cos(phi)*radius,this.z=sinPhiRadius*Math.cos(theta),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array[offset+2]=this.z,array}fromBufferAttribute(attribute,index){return this.x=attribute.array[3*index+0],this.y=attribute.array[3*index+1],this.z=attribute.array[3*index+2],this}}class Vector3D{constructor(x,y,z){this._x=x||0,this._y=y||0,this._z=z||0}get x(){return this._x}set x(v){if(zUtils3D.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");let dirty=Math.abs(this._x-v)>Base3D.DIRTY_EPSILON;this._x=v,dirty&&this.onChangeCallback()}get y(){return this._y}set y(v){if(zUtils3D.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");let dirty=Math.abs(this._y-v)>Base3D.DIRTY_EPSILON;this._y=v,dirty&&this.onChangeCallback()}get z(){return this._z}set z(v){if(zUtils3D.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");let dirty=Math.abs(this._z-v)>Base3D.DIRTY_EPSILON;this._z=v,dirty&&this.onChangeCallback()}onChangeCallback(){}set(x=0,y=0,z=0){const abs=Math.abs;let dirty=abs(this._x-x)>Base3D.DIRTY_EPSILON||abs(this._y-y)>Base3D.DIRTY_EPSILON||abs(this._z-z)>Base3D.DIRTY_EPSILON;return this._x=x,this._y=y,this._z=z,dirty&&this.onChangeCallback(),this}setScalar(scalar){const abs=Math.abs;let dirty=abs(this._x-scalar)>Base3D.DIRTY_EPSILON||abs(this._y-scalar)>Base3D.DIRTY_EPSILON||abs(this._z-scalar)>Base3D.DIRTY_EPSILON;return this._x=scalar,this._y=scalar,this._z=scalar,dirty&&this.onChangeCallback(),this}clone(){return new Vector3(this._x,this._y,this._z)}copy(v){const abs=Math.abs;let dirty=abs(this._x-v.x)>Base3D.DIRTY_EPSILON||abs(this._y-v.y)>Base3D.DIRTY_EPSILON||abs(this._z-v.z)>Base3D.DIRTY_EPSILON;return this._x=v.x,this._y=v.y,this._z=v.z,dirty&&this.onChangeCallback(),this}add(v){let nx=this._x+v.x,ny=this._y+v.y,nz=this._z+v.z;const abs=Math.abs;let dirty=abs(this._x-nx)>Base3D.DIRTY_EPSILON||abs(this._y-ny)>Base3D.DIRTY_EPSILON||abs(this._z-nz)>Base3D.DIRTY_EPSILON;return this._x=nx,this._y=ny,this._z=nz,dirty&&this.onChangeCallback(),this}addScalar(s){let nx=this._x+s,ny=this._y+s,nz=this._z+s;const abs=Math.abs;let dirty=abs(this._x-nx)>Base3D.DIRTY_EPSILON||abs(this._y-ny)>Base3D.DIRTY_EPSILON||abs(this._z-nz)>Base3D.DIRTY_EPSILON;return this._x=nx,this._y=ny,this._z=nz,dirty&&this.onChangeCallback(),this}addVectors(a,b){return this._x=a.x+b.x,this._y=a.y+b.y,this._z=a.z+b.z,this.onChangeCallback(),this}addScaledVector(v){return this._x+=v.x*s,this._y+=v.y*s,this._z+=v.z*s,this.onChangeCallback(),this}sub(v){let nx=this._x-v.x,ny=this._y-v.y,nz=this._z-v.z;const abs=Math.abs;let dirty=abs(this._x-nx)>Base3D.DIRTY_EPSILON||abs(this._y-ny)>Base3D.DIRTY_EPSILON||abs(this._z-nz)>Base3D.DIRTY_EPSILON;return this._x=nx,this._y=ny,this._z=nz,dirty&&this.onChangeCallback(),this}subScalar(s){let nx=this._x-s,ny=this._y-s,nz=this._z-s;const abs=Math.abs;let dirty=abs(this._x-nx)>Base3D.DIRTY_EPSILON||abs(this._y-ny)>Base3D.DIRTY_EPSILON||abs(this._z-nz)>Base3D.DIRTY_EPSILON;return this._x=nx,this._y=ny,this._z=nz,dirty&&this.onChangeCallback(),this}subVectors(a,b){return this._x=a.x-b.x,this._y=a.y-b.y,this._z=a.z-b.z,this.onChangeCallback(),this}multiply(v){let nx=this._x*v.x,ny=this._y*v.y,nz=this._z*v.z;const abs=Math.abs;let dirty=abs(this._x-nx)>Base3D.DIRTY_EPSILON||abs(this._y-ny)>Base3D.DIRTY_EPSILON||abs(this._z-nz)>Base3D.DIRTY_EPSILON;return this._x=nx,this._y=ny,this._z=nz,dirty&&this.onChangeCallback(),this}multiplyScalar(scalar){let nx=this._x*scalar,ny=this._y*scalar,nz=this._z*scalar;const abs=Math.abs;let dirty=abs(this._x-nx)>Base3D.DIRTY_EPSILON||abs(this._y-ny)>Base3D.DIRTY_EPSILON||abs(this._z-nz)>Base3D.DIRTY_EPSILON;return this._x=nx,this._y=ny,this._z=nz,dirty&&this.onChangeCallback(),this}multiplyVectors(a,b){return this._x=a.x*b.x,this._y=a.y*b.y,this._z=a.z*b.z,this.onChangeCallback(),this}applyEuler(euler){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromEuler(euler))}applyAxisAngle(axis,angle){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromAxisAngle(axis,angle))}applyMatrix3(m){let x=this._x,y=this._y,z=this._z,e=m.elements;return this._x=e[0]*x+e[3]*y+e[6]*z,this._y=e[1]*x+e[4]*y+e[7]*z,this._z=e[2]*x+e[5]*y+e[8]*z,this.onChangeCallback(),this}applyMatrix4(m){let x=this._x,y=this._y,z=this._z,e=m.elements,w=1/(e[3]*x+e[7]*y+e[11]*z+e[15]);return this._x=(e[0]*x+e[4]*y+e[8]*z+e[12])*w,this._y=(e[1]*x+e[5]*y+e[9]*z+e[13])*w,this._z=(e[2]*x+e[6]*y+e[10]*z+e[14])*w,this.onChangeCallback(),this}applyQuaternion(q){let x=this._x,y=this._y,z=this._z,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return this._x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this._y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this._z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this.onChangeCallback(),this}project(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,matrix.getInverse(camera.matrixWorld)),this.applyMatrix4(matrix)}unproject(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.matrixWorld,matrix.getInverse(camera.projectionMatrix)),this.applyMatrix4(matrix)}transformDirection(m){let x=this._x,y=this._y,z=this._z,e=m.elements;return this._x=e[0]*x+e[4]*y+e[8]*z,this._y=e[1]*x+e[5]*y+e[9]*z,this._z=e[2]*x+e[6]*y+e[10]*z,this.onChangeCallback(),this.normalize()}divide(v){return this._x/=v.x,this._y/=v.y,this._z/=v.z,this.onChangeCallback(),this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}min(v){return this._x=Math.min(this._x,v.x),this._y=Math.min(this._y,v.y),this._z=Math.min(this._z,v.z),this.onChangeCallback(),this}max(v){return this._x=Math.max(this._x,v.x),this._y=Math.max(this._y,v.y),this._z=Math.max(this._z,v.z),this}clamp(min,max){return this._x=Math.max(min.x,Math.min(max.x,this._x)),this._y=Math.max(min.y,Math.min(max.y,this._y)),this._z=Math.max(min.z,Math.min(max.z,this._z)),this}clampScalar(minVal,maxVal){let min=new Vector3,max=new Vector3;return min.set(minVal,minVal,minVal),max.set(maxVal,maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this._x=Math.floor(this._x),this._y=Math.floor(this._y),this._z=Math.floor(this._z),this.onChangeCallback(),this}ceil(){return this._x=Math.ceil(this._x),this._y=Math.ceil(this._y),this._z=Math.ceil(this._z),this.onChangeCallback(),this}round(){return this._x=Math.round(this._x),this._y=Math.round(this._y),this._z=Math.round(this._z),this.onChangeCallback(),this}roundToZero(){return this._x=this._x<0?Math.ceil(this._x):Math.floor(this._x),this._y=this._y<0?Math.ceil(this._y):Math.floor(this._y),this._z=this._z<0?Math.ceil(this._z):Math.floor(this._z),this.onChangeCallback(),this}negate(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this.onChangeCallback(),this}dot(v){return this._x*v.x+this._y*v.y+this._z*v.z}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}manhattanLength(){return Math.abs(this._x)+Math.abs(this._y)+Math.abs(this._z)}normalize(){return this.onChangeCallback(),this.divideScalar(this.length()||1)}setLength(length){return this.onChangeCallback(),this.normalize().multiplyScalar(length)}lerp(v,alpha,hz){return this._x=Math.lerp(v.x,this._x,alpha,hz),this._y=Math.lerp(v.y,this._y,alpha,hz),this._z=Math.lerp(v.z,this._z,alpha,hz),this.onChangeCallback(),this}lerpVectors(v1,v2,alpha){return this.onChangeCallback(),this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}cross(v){return this.crossVectors(this,v)}crossVectors(a,b){let ax=a.x,ay=a.y,az=a.z,bx=b.x,by=b.y,bz=b.z;return this._x=ay*bz-az*by,this._y=az*bx-ax*bz,this._z=ax*by-ay*bx,this.onChangeCallback(),this}projectOnVector(vector){let scalar=vector.dot(this)/vector.lengthSq();return this.copy(vector).multiplyScalar(scalar)}projectOnPlane(planeNormal){let v1=this.V1||new Vector3;return this.V1=v1,this.onChangeCallback(),v1.copy(this).projectOnVector(planeNormal),this.sub(v1)}reflect(normal){let v1=this.V1||new Vector3;return this.V1=v1,this.onChangeCallback(),this.sub(v1.copy(normal).multiplyScalar(2*this.dot(normal)))}angleTo(v){let theta=this.dot(v)/Math.sqrt(this.lengthSq()*v.lengthSq());return Math.acos(Math.clamp(theta,-1,1))}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this._x-v.x,dy=this._y-v.y,dz=this._z-v.z;return dx*dx+dy*dy+dz*dz}manhattanDistanceTo(v){return Math.abs(this._x-v.x)+Math.abs(this._y-v.y)+Math.abs(this._z-v.z)}setFromSpherical(s){let sinPhiRadius=Math.sin(s.phi)*s.radius;return this._x=sinPhiRadius*Math.sin(s.theta),this._y=Math.cos(s.phi)*s.radius,this._z=sinPhiRadius*Math.cos(s.theta),this.onChangeCallback(),this}setFromCylindrical(c){return this._x=c.radius*Math.sin(c.theta),this._y=c.y,this._z=c.radius*Math.cos(c.theta),this.onChangeCallback(),this}setFromMatrixPosition(m){let e=m.elements;return this._x=e[12],this._y=e[13],this._z=e[14],this.onChangeCallback(),this}setFromMatrixScale(m){let sx=this.setFromMatrixColumn(m,0).length(),sy=this.setFromMatrixColumn(m,1).length(),sz=this.setFromMatrixColumn(m,2).length();return this.onChangeCallback(),this._x=sx,this._y=sy,this._z=sz,this}setFromMatrixColumn(m,index){return this.onChangeCallback(),this.fromArray(m.elements,4*index)}equals(v){return v.x===this._x&&v.y===this._y&&v.z===this._z}fromArray(array,offset){return void 0===offset&&(offset=0),this._x=Number(array[offset]),this._y=Number(array[offset+1]),this._z=Number(array[offset+2]),this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=Number(this._x),array[offset+1]=Number(this._y),array[offset+2]=Number(this._z),array}fromBufferAttribute(attribute,index){this._x=attribute.array[3*index+0],this._y=attribute.array[3*index+1],this._z=attribute.array[3*index+2],this.onChangeCallback()}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}class Vector4{constructor(x=0,y=0,z=0,w=0){this.x=x,this.y=y,this.z=z,this.w=w}multiplyScalar(s){return this.x*=s,this.y*=s,this.z*=s,this.w*=s,this}set(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this}copy(v){return this.x=v.x,this.y=v.y,this.z=v.z,this.w=v.w,this}dot(v){return this.x*v.x+this.y*v.y+this.z*v.z+this.w*v.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}equals(v){return v.x===this.x&&v.y===this.y&&v.z===this.z&&v.w===this.w}lerp(v,alpha,hz){return this.x=Math.lerp(v.x,this.x,alpha,hz),this.y=Math.lerp(v.y,this.y,alpha,hz),this.z=Math.lerp(v.z,this.z,alpha,hz),this.w=Math.lerp(v.w,this.w,alpha,hz),this}applyMatrix4(m){let x=this.x,y=this.y,z=this.z,w=this.w,e=m.elements;return this.x=e[0]*x+e[4]*y+e[8]*z+e[12]*w,this.y=e[1]*x+e[5]*y+e[9]*z+e[13]*w,this.z=e[2]*x+e[6]*y+e[10]*z+e[14]*w,this.w=e[3]*x+e[7]*y+e[11]*z+e[15]*w,this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array[offset+2]=this.z,array[offset+3]=this.w,array}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=Number(array[offset]),this.y=Number(array[offset+1]),this.z=Number(array[offset+2]),this.w=Number(array[offset+3]),this}set width(v){this.z=v}set height(v){this.w=v}get width(){return this.z}get height(){return this.w}clone(){return new Vector4(this.x,this.y,this.z,this.w)}}class Face3{constructor(a,b,c,normal=new Vector3){this.a=a,this.b=b,this.c=c,this.normal=normal}}function NoGLPolyfill(){this.createQuery=this.activeTexture=this.attachShader=this.bindAttribLocation=this.bindBuffer=this.bindFramebuffer=this.bindRenderbuffer=this.bindTexture=this.blendColor=this.blendEquation=this.blendEquationSeparate=this.blendFunc=this.blendFuncSeparate=this.bufferData=this.bufferSubData=this.checkFramebufferStatus=this.clear=this.clearColor=this.clearDepthf=this.clearStencil=this.colorMask=this.compileShader=this.compressedTexImage2D=this.compressedTexSubImage2D=this.copyTexImage2D=this.copyTexSubImage2D=this.createProgram=this.createShader=this.cullFace=this.deleteBuffers=this.deleteFramebuffers=this.deleteProgram=this.deleteRenderbuffers=this.deleteShader=this.deleteTextures=this.depthFunc=this.depthMask=this.depthRangef=this.detachShader=this.disable=this.disableVertexAttribArray=this.drawArrays=this.drawElements=this.enable=this.enableVertexAttribArray=this.finish=this.flush=this.framebufferRenderbuffer=this.framebufferTexture2D=this.frontFace=this.generateMipmap=this.getActiveAttrib=this.getActiveUniform=this.getAttachedShaders=this.getAttribLocation=this.getBooleanv=this.getBufferParameteriv=this.getError=this.getFloatv=this.getFramebufferAttachmentParameteriv=this.getIntegerv=this.getProgramiv=this.getProgramInfoLog=this.getRenderbufferParameteriv=this.getShaderiv=this.getShaderInfoLog=this.getShaderPrecisionFormat=this.getShaderSource=this.getString=this.getTexParameterfv=this.getTexParameteriv=this.getUniformfv=this.getUniformiv=this.getUniformLocation=this.getVertexAttribfv=this.getVertexAttribiv=this.getVertexAttribPointerv=this.isBuffer=this.isEnabled=this.isFramebuffer=this.isProgram=this.isRenderbuffer=this.isShader=this.isTexture=this.lineWidth=this.linkProgram=this.pixelStorei=this.polygonOffset=this.readPixels=this.releaseShaderCompiler=this.renderbufferStorage=this.sampleCoverage=this.scissor=this.shaderBinary=this.shaderSource=this.stencilFunc=this.stencilFuncSeparate=this.stencilMask=this.stencilMaskSeparate=this.stencilOp=this.stencilOpSeparate=this.texParameterf=this.texParameterfv=this.texParameteri=this.texParameteriv=this.texSubImage2D=this.uniform1f=this.uniform1fv=this.uniform1i=this.uniform1iv=this.uniform2f=this.uniform2fv=this.uniform2i=this.uniform2iv=this.uniform3f=this.uniform3fv=this.uniform3i=this.uniform3iv=this.uniform4f=this.uniform4fv=this.uniform4i=this.uniform4iv=this.uniformMatrix2fv=this.uniformMatrix3fv=this.uniformMatrix4fv=this.useProgram=this.validateProgram=this.vertexAttrib1f=this.vertexAttrib1fv=this.vertexAttrib2f=this.vertexAttrib2fv=this.vertexAttrib3f=this.vertexAttrib3fv=this.vertexAttrib4f=this.vertexAttrib4fv=this.vertexAttribPointer=this.viewport=this.getParameter=this.getExtension=this.drawElementsInstanced=this.drawArraysInstanced=this.vertexAttribDivisor=this.getUniformBlockIndex=this.uniformBlockBinding=this.bindBufferBase=this.createVertexArray=this.bindVertexArray=this.deleteVertexArray=this.drawBuffers=this.blitFramebuffer=this.texImage2D=this.getContextAttributes=this.isContextLost=this.clearDepth=this.depthRange=this.createTexture=this.createBuffer=this.createFramebuffer=this.createRenderbuffer=this.deleteTexture=this.deleteBuffer=this.deleteFramebuffer=this.getBufferParameter=this.getRenderbufferParameter=this.getProgramParameter=this.getVertexAttribOffset=this.getFramebufferAttachmentParemeter=this.getUniform=this.getTexParameter=this.getShaderParameter=this.getSupportedExtensions=this.activeTexture=this.attachShader=_=>{},this.getShaderParameter=this.getProgramParameter=function(){return!0}}Class((function zUtils3D(){function createHelpers(){var diff,edge1,edge2,normal,v1,v0;Ray.prototype.intersectTriangle=(diff=new Vector3,edge1=new Vector3,edge2=new Vector3,normal=new Vector3,function intersectTriangle(a,b,c,backfaceCulling,target){edge1.subVectors(b,a),edge2.subVectors(c,a),normal.crossVectors(edge1,edge2);var sign,DdN=this.direction.dot(normal);if(DdN>0){if(backfaceCulling)return null;sign=1}else{if(!(DdN<0))return null;sign=-1,DdN=-DdN}diff.subVectors(this.origin,a);var DdQxE2=sign*this.direction.dot(edge2.crossVectors(diff,edge2));if(DdQxE2<0)return null;var DdE1xQ=sign*this.direction.dot(edge1.cross(diff));if(DdE1xQ<0)return null;if(DdQxE2+DdE1xQ>DdN)return null;var QdN=-sign*diff.dot(normal);return QdN<0?null:this.at(QdN/DdN,target)}),Mesh.prototype.raycast=function(){let inverseMatrix=new Matrix4,ray=new Ray,sphere=new Sphere,vA=new Vector3,vB=new Vector3,vC=new Vector3,uvA=(new Vector3,new Vector3,new Vector3,new Vector3,new Vector2),uvB=new Vector2,uvC=new Vector2,barycoord=new Vector3,intersectionPoint=new Vector3,intersectionPointWorld=new Vector3;function checkBufferGeometryIntersection(object,raycaster,ray,position,uv,a,b,c){if(vA.fromBufferAttribute(position,a),vB.fromBufferAttribute(position,b),vC.fromBufferAttribute(position,c),object.raycastLimit){let{radiusSq:radiusSq,position:position}=object.raycastLimit;if(vA.distanceToSquared(position)>radiusSq)return}let intersection=function checkIntersection(object,shader,raycaster,ray,pA,pB,pC,point){let intersect;if(intersect=shader.side===Shader.BACK_SIDE?ray.intersectTriangle(pC,pB,pA,!0,point):ray.intersectTriangle(pA,pB,pC,shader.side!==Shader.DOUBLE_SIDE,point),null===intersect)return null;intersectionPointWorld.copy(point),intersectionPointWorld.applyMatrix4(object.matrixWorld);let distance=raycaster.ray.origin.distanceTo(intersectionPointWorld);return distance<raycaster.near||distance>raycaster.far?null:{distance:distance,point:intersectionPointWorld.clone(),object:object}}(object,object.shader,raycaster,ray,vA,vB,vC,intersectionPoint);if(intersection){uv&&(uvA.fromBufferAttribute(uv,a),uvB.fromBufferAttribute(uv,b),uvC.fromBufferAttribute(uv,c),intersection.uv=function uvIntersection(point,p1,p2,p3,uv1,uv2,uv3){return Triangle.getBarycoord(point,p1,p2,p3,barycoord),uv1.multiplyScalar(barycoord.x),uv2.multiplyScalar(barycoord.y),uv3.multiplyScalar(barycoord.z),uv1.add(uv2).add(uv3),uv1.clone()}(intersectionPoint,vA,vB,vC,uvA,uvB,uvC));let face=new Face3(a,b,c);Triangle.getNormal(vA,vB,vC,face.normal),intersection.face=face}return intersection}return function raycast(raycaster,intersects){let intersection,a,b,c,geometry=this.geometry,shader=this.shader,matrixWorld=this.matrixWorld;if(void 0===shader)return;if(null===geometry.boundingSphere&&geometry.computeBoundingSphere(),0==this.scale.x)return;if(this.staticRaycast){if(this.raySphere||(this.raySphere=new Sphere,this.raySphere.copy(geometry.boundingSphere),this.raySphere.applyMatrix4(matrixWorld)),this.raycastNeedsUpdate&&(this.raySphere.copy(geometry.boundingSphere),this.raySphere.applyMatrix4(matrixWorld),this.raycastNeedsUpdate=!1),!1===raycaster.ray.intersectsSphere(this.raySphere))return}else if(sphere.copy(geometry.boundingSphere),sphere.applyMatrix4(matrixWorld),!1===raycaster.ray.intersectsSphere(sphere))return;if(inverseMatrix.getInverse(matrixWorld),ray.copy(raycaster.ray).applyMatrix4(inverseMatrix),null!==geometry.boundingBox&&!1===ray.intersectsBox(geometry.boundingBox))return;let i,l,index=geometry.index,position=geometry.attributes.position,uv=geometry.attributes.uv;if(null!==index)for(i=0,l=index.length;i<l;i+=3)a=index[i],b=index[i+1],c=index[i+2],intersection=checkBufferGeometryIntersection(this,raycaster,ray,position,uv,a,b,c),intersection&&(intersection.faceIndex=Math.floor(i/3),intersects.push(intersection));else if(void 0!==position)for(i=0,l=position.count;i<l;i+=3)a=i,b=i+1,c=i+2,intersection=checkBufferGeometryIntersection(this,raycaster,ray,position,uv,a,b,c),intersection&&(intersection.faceIndex=Math.floor(i/3),intersects.push(intersection))}}(),Triangle.prototype.closestPointToPoint=function(){let plane=new Plane,edgeList=[new Line3,new Line3,new Line3],projectedPoint=new Vector3,closestPoint=new Vector3;return function closestPointToPoint(point,target=new Vector3){let minDistance=1/0;if(plane.setFromCoplanarPoints(this.a,this.b,this.c),plane.projectPoint(point,projectedPoint),!0===this.containsPoint(projectedPoint))target.copy(projectedPoint);else{edgeList[0].set(this.a,this.b),edgeList[1].set(this.b,this.c),edgeList[2].set(this.c,this.a);for(let i=0;i<edgeList.length;i++){edgeList[i].closestPointToPoint(projectedPoint,!0,closestPoint);let distance=projectedPoint.distanceToSquared(closestPoint);distance<minDistance&&(minDistance=distance,target.copy(closestPoint))}}return target}}(),Points.prototype.raycast=function(){let inverseMatrix=new Matrix4,ray=new Ray,sphere=new Sphere;return function raycast(raycaster,intersects){let object=this,geometry=this.geometry,matrixWorld=this.matrixWorld,threshold=raycaster.params.Points.threshold;if(null===geometry.boundingSphere&&geometry.computeBoundingSphere(),sphere.copy(geometry.boundingSphere),sphere.applyMatrix4(matrixWorld),sphere.radius+=threshold,!1===raycaster.ray.intersectsSphere(sphere))return;inverseMatrix.getInverse(matrixWorld),ray.copy(raycaster.ray).applyMatrix4(inverseMatrix);let localThreshold=threshold/((this.scale.x+this.scale.y+this.scale.z)/3),localThresholdSq=localThreshold*localThreshold,position=new Vector3,intersectPoint=new Vector3;function testPoint(point,index){let rayPointDistanceSq=ray.distanceSqToPoint(point);if(rayPointDistanceSq<localThresholdSq){ray.closestPointToPoint(point,intersectPoint),intersectPoint.applyMatrix4(matrixWorld);let distance=raycaster.ray.origin.distanceTo(intersectPoint);if(distance<raycaster.near||distance>raycaster.far)return;intersects.push({distance:distance,distanceToRay:Math.sqrt(rayPointDistanceSq),point:intersectPoint.clone(),index:index,face:null,object:object})}}let index=geometry.index,positions=geometry.attributes.position.array;if(null!==index){let indices=index.array;for(let i=0,il=indices.length;i<il;i++){let a=indices[i];position.fromArray(positions,3*a),testPoint(position,a)}}else for(let i=0,l=positions.length/3;i<l;i++)position.fromArray(positions,3*i),testPoint(position,i)}}(),Object.assign(Triangle,{getNormal:(v0=new Vector3,function getNormal(a,b,c,target=new Vector3){target.subVectors(c,b),v0.subVectors(a,b),target.cross(v0);var targetLengthSq=target.lengthSq();return targetLengthSq>0?target.multiplyScalar(1/Math.sqrt(targetLengthSq)):target.set(0,0,0)}),getBarycoord:function(){var v0=new Vector3,v1=new Vector3,v2=new Vector3;return function getBarycoord(point,a,b,c,target=new Vector3){v0.subVectors(c,a),v1.subVectors(b,a),v2.subVectors(point,a);var dot00=v0.dot(v0),dot01=v0.dot(v1),dot02=v0.dot(v2),dot11=v1.dot(v1),dot12=v1.dot(v2),denom=dot00*dot11-dot01*dot01;if(0===denom)return target.set(-2,-1,-1);var invDenom=1/denom,u=(dot11*dot02-dot01*dot12)*invDenom,v=(dot00*dot12-dot01*dot02)*invDenom;return target.set(1-u-v,v,u)}}(),getUV:function(){let _v3=new Vector3;return function getUV(point,p1,p2,p3,uv1,uv2,uv3,target){return this.getBarycoord(point,p1,p2,p3,_v3),target.set(0,0),target.addScaledVector(uv1,_v3.x),target.addScaledVector(uv2,_v3.y),target.addScaledVector(uv3,_v3.z),target}}(),containsPoint:(v1=new Vector3,function containsPoint(point,a,b,c){return Triangle.getBarycoord(point,a,b,c,v1),v1.x>=0&&v1.y>=0&&v1.x+v1.y<=1})})}Math.euclideanModulo=function(n,m){return(n%m+m)%m},Math.isPowerOf2=function(w,h){let test=value=>0==(value&value-1);return test(w)&&test(h)},Math.floorPowerOf2=function(value){return Math.pow(2,Math.floor(Math.log(value)/Math.LN2))},Math.ceilPowerOf2=function(value){return Math.pow(2,Math.ceil(Math.log(value)/Math.LN2))},this.LOCAL=window.Hydra&&Hydra.LOCAL,Geometry.createAttributes=function(geom){let attributes={},handler={set(target,property,value){target[property]=value,geom._attributeKeys.length=0,geom._attributeValues.length=0;for(let key in attributes)geom._attributeKeys.push(key),geom._attributeValues.push(attributes[key]);return!0}};return geom._attributeKeys=[],geom._attributeValues=[],new Proxy(attributes,handler)},Geometry.TYPED_ARRAYS={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array},Geometry.arrayNeedsUint32=function(array){for(let i=array.length-1;i>=0;--i)if(array[i]>65535)return!0;return!1},Geometry.TYPES={SphereGeometry:SphereGeometry,IcosahedronGeometry:IcosahedronGeometry,BoxGeometry:BoxGeometry,PlaneGeometry:PlaneGeometry,CylinderGeometry:CylinderGeometry},Matrix4.prototype.isMatrix4=!0,Matrix3.prototype.isMatrix3=!0,Vector3.prototype.isVector3=!0,Vector3D.prototype.isVector3=!0,Vector2.prototype.isVector2=!0,CameraBase3D.prototype.isCamera=!0,PerspectiveCamera.prototype.isPerspective=!0,Scene.FRONT_TO_BACK="sort_front_to_back",Scene.FRONT_TO_BACK_BOUNDING="sort_front_to_back_bounding",window.THREAD&&(Shader={FRONT_SIDE:"shader_front_side",BACK_SIDE:"shader_back_side",DOUBLE_SIDE:"shader_double_side"}),window.MatrixWasm?MatrixWasm.ready().then(createHelpers):createHelpers()}),"static"),Class((function FXLayer(_parentNuke,_type,_preventDrawBuffers=!1){Inherit(this,Component);var _nuke,_rt,_this=this,_scene=new Scene,_objects=[],_textureIndex=-1,_visible=!0,_id=Utils.timestamp(),_name=Utils.getConstructorName(_this),_useDrawBuffers=!_preventDrawBuffers;this.resolution=1,this.enabled=!0,this.renderShadows=!0;const CLEAR_COLOR=[0,0,0,1];function resizeHandler(){_rt.setSize&&_rt.setSize(_nuke.stage.width*_this.resolution*_nuke.dpr,_nuke.stage.height*_this.resolution*_nuke.dpr)}if(FXLayer.exists=!0,this.set("visible",(v=>_this.scene.visible=_visible=v)),this.get("visible",(_=>_visible)),this.onInvisible=function(){_this.scene.visible=!1},this.onVisible=function(){_this.scene.visible=!0},this.create=function(nuke=World.NUKE,type,rt){if(!nuke)return;let format,manualRender,mipmaps;_useDrawBuffers=nuke.useDrawBuffers,type&&"object"==typeof type&&("boolean"==typeof type.useDrawBuffers&&(_useDrawBuffers=type.useDrawBuffers),format=type.format,manualRender=type.manualRender,mipmaps=type.mipmaps,rt||(rt=type.rt),type=type.type),_this.rtType=type||Texture.UNSIGNED_BYTE,_this.rtFormat=format||Texture.RGBFormat,_this.rtMipmaps=mipmaps,(_this=this).scene=_scene,_nuke=_this.initClass(Nuke,nuke.stage,{renderer:nuke.renderer,camera:nuke.camera,scene:_scene,dpr:nuke.dpr,useDrawBuffers:!1}),_parentNuke=_this.parent.nuke||nuke,_nuke.parentNuke=_parentNuke,_this.nuke=_nuke,function initRT(rt){if(_useDrawBuffers){let texture=new Texture;texture.minFilter=Texture.LINEAR,texture.magFilter=Texture.LINEAR,texture.format=Texture.RGBAFormat,_this.rtType&&(texture.type=_this.rtType),_this.rtFormat&&(texture.format=_this.rtFormat),_this.rtMipmaps?(texture.generateMipmaps=!0,texture.minFilter=texture.magFilter=Texture.LINEAR_MIPMAP):texture.generateMipmaps=!1,texture.type==Texture.FLOAT&&(texture.format=Texture.RGBAFormat),texture.wrapS=texture.wrapT=Texture.CLAMP_TO_EDGE,texture.fxLayer=_this,_this.textureIndex=_textureIndex=_parentNuke.attachDrawBuffer(texture),_rt={texture:texture}}else _this.rtType&&_this.rtType==Texture.FLOAT&&"ios"==Device.system.os&&(_this.rtType=Texture.HALF_FLOAT),_rt=rt||Utils3D.createRT(Math.round(_nuke.stage.width*_this.resolution*_nuke.dpr),Math.round(_nuke.stage.height*_this.resolution*_nuke.dpr),_this.rtType,_this.rtFormat),_this.rtMipmaps?(_rt.texture.minFilter=_rt.texture.magFilter=Texture.LINEAR_MIPMAP,_rt.texture.generateMipmaps=!0):_rt.texture.generateMipmaps=!1;_this.rt=_rt,_this.nuke.setSize(_rt.width,_rt.height)}(rt),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),manualRender||FXScene.manualRender||_this.startRender((_=>_this.draw()),nuke)},this.addObject=this.add=function(object){if(_nuke){if(!_useDrawBuffers){let clone=object.clone();for(object["clone_"+_id]=clone,_scene.add(clone),_objects.push(object),object.shader&&function editShader(mesh){let modifyShader=(shader,name)=>{let fs=shader._fragmentShader;if(!fs)return;let marker="#drawbuffer "+name;if(fs.includes(marker)){let split=fs.split(marker+" ");fs=split.join("")}for(;fs.includes("#drawbuffer");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)fs[i].includes("#drawbuffer")&&(fs[i]="");fs=fs.join("\n")}shader.fragmentShader=fs},applyShadow=(shader,bool)=>{let fs=shader.fragmentShader;if(fs){for(;fs.includes("#applyShadow");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)bool?fs[i].includes("#applyShadow")&&(fs[i]=fs[i].replace("#applyShadow","")):fs[i].includes("#applyShadow")&&(fs[i]="");fs=fs.join("\n")}shader.fragmentShader=fs}};mesh.shader._fragmentShader||(mesh.shader._fragmentShader=mesh.shader.fragmentShader),modifyShader(mesh.shader,"Color");let shader=mesh.shader.clone(!_this.renderShadows,`-${_this.name||_name}`);modifyShader(shader,_this.name||_name),applyShadow(shader,_this.renderShadows),applyShadow(mesh.shader,!0),mesh.shader.copyUniformsTo(shader,!0),mesh.shader=shader}(clone);clone.children.length;)clone.remove(clone.children[0]);return clone}object.shader&&object.shader.fragmentShader&&(!function editDBShader(mesh){const WEBGL2=Renderer.type==Renderer.WEBGL2;let modifyMarker=(fs,name,index)=>{if(WEBGL2){if(fs.includes("layout(location=0) out vec4 reflectionsData"))return fs;if(!fs.includes(`layout(location=${index})`)){let mainAt=(fs=fs.replace("out vec4 FragColor;","")).indexOf("void main()"),before=fs.slice(0,mainAt),after=fs.slice(mainAt);fs=before+`layout(location=${index}) out vec4 ${name};\n`+after}}let marker="#drawbuffer "+name;if(fs.includes(marker)){let split=fs.split(marker+" "),finalOut=WEBGL2?name:`gl_FragData[${index}]`;for(let i=1;i<split.length;++i)split[i]=split[i].replace("gl_FragColor",finalOut);fs=split.join("")}for(;fs.includes("#applyShadow");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)fs[i].includes("#applyShadow")&&(fs[i]=fs[i].replace("#applyShadow",""));fs=fs.join("\n")}return fs},shader=mesh.shader,fs=shader.fragmentShader,name=_this.name||_name;WEBGL2&&fs.includes("location=0")||(fs=modifyMarker(fs,"Color",0)),fs=modifyMarker(fs,name,_textureIndex),shader.fragmentShader=fs}(object),object.shader._attachmentData={format:_this.rtFormat,type:_this.rtType,attachments:_parentNuke.attachments})}},this.removeObject=function(object){_nuke&&(_scene.remove(object["clone_"+_id]),_objects.remove(object),delete object["clone_"+_id])},this.render=this.draw=function(stage,camera){if(!_nuke||!_this.enabled||_useDrawBuffers)return;if(!_parentNuke.enabled||!_objects.length)return;const oldClear=Renderer.CLEAR;Renderer.CLEAR=CLEAR_COLOR,stage&&(_nuke.stage=stage,_this.setSize(stage.width,stage.height)),_nuke.camera=camera||_nuke.parentNuke.camera,_this.renderShadows||(_nuke.renderer.overridePreventShadows=!0);for(let i=_objects.length-1;i>-1;i--){let obj=_objects[i],clone=obj["clone_"+_id];_this.forceVisible?clone.visible=!0:clone.visible=obj.determineVisible(),clone.visible&&(obj.updateMatrixWorld(),obj.ignoreMatrix||Utils3D.decompose(obj,clone))}_nuke.rtt=_rt,_nuke.render(),RenderStats.update("FXLayer"),_nuke.renderer.overridePreventShadows=!1,Renderer.CLEAR=oldClear},this.addPass=function(pass){_nuke&&_nuke.add(pass)},this.removePass=function(pass){_nuke&&_nuke.remove(pass)},this.setSize=function(width,height){_nuke&&(_rt.width==width&&_rt.height==height||(_this.events.unsub(Events.RESIZE,resizeHandler),_rt&&_rt.setSize(width*_this.resolution*_nuke.dpr,height*_this.resolution*_nuke.dpr),_nuke.setSize(width*_this.resolution*_nuke.dpr,height*_this.resolution*_nuke.dpr)))},this.setDPR=function(dpr){_nuke&&(_nuke.dpr=dpr,resizeHandler())},this.setResolution=function(res){_this.resolution=res,resizeHandler()},this.getObjects=function(){return _objects},this.useRT=function(rt){_rt=_this.rt=rt},this.getName=function(){return _this.name||_name},_parentNuke instanceof Nuke&&this.create(_parentNuke,_type),_parentNuke.isAppState){let config=_parentNuke;this.create(_this.parent.nuke||config.nuke,config),this.name=config.name}})),Namespace("FX"),Class((function FXScene(_parentNuke,_type,...rest){Inherit(this,Component);var _nuke,_rt,_rtPool,_showManualRenderWarning,_this=this,_scene=new Scene,_id=Utils.timestamp(),_objects=[],_renderTime=Render.TIME,_visible=!0;function resizeHandler(){_rt.setSize&&_rt.setSize(_nuke.stage.width*_this.resolution*_nuke.dpr,_nuke.stage.height*_this.resolution*_nuke.dpr),_this.nuke.setSize(_rt.width,_rt.height),_this.width=_rt.width,_this.height=_rt.height}this.resolution=1,this.autoVisible=!0,this.enabled=!0,this.scene=_scene,this.renderShadows=!0,this.set("visible",(v=>{_this.scene&&(_this.scene.visible=_visible=v,_this.onFXSceneVisibility?.(v))})),this.get("visible",(_=>_visible)),this.onInvisible=this.fxInvisible=function(){this.scene.visible&&(this.scene.visible=!1,_this.flag("needsOnVisible",!0)),_rtPool&&_rtPool.putRT(_this.rt)},this._bindOnDestroy((function(){_rtPool&&_rtPool.putRT(_this.rt)})),this.onVisible=this.fxVisible=function(){_this.flag("needsOnVisible")&&(this.scene.visible=!0,_this.flag("needsOnVisible",!1)),_rtPool&&(_this.useRT(_rtPool.getRT()),resizeHandler())},this.create=function(nuke=World.NUKE,rt,options){_this.nuke||(rt instanceof RTPool&&(rt=(_rtPool=rt).nullRT),nuke instanceof RTPool?(options=rt,rt=(_rtPool=nuke).nullRT,nuke=World.NUKE):rt&&"object"==typeof rt?rt.isRT||(options=rt,rt=void 0):!nuke||nuke instanceof Nuke||(options=nuke,nuke=World.NUKE),options||(options={}),_this.rtFormat=options.format||Texture.RGBFormat,_this.rtType=options.type||Texture.UNSIGNED_BYTE,(options.vr||options.vrMode)&&(_this.vrRT=RenderManager.type==RenderManager.VR),options.parentNuke&&(nuke=options.parentNuke),(_this=this).scene=_scene,_this.nuke=_nuke=_this.initClass(Nuke,nuke.stage,{renderer:nuke.renderer,camera:nuke.camera,scene:_scene,dpr:nuke.dpr,format:options.format,vrRT:_this.vrRT,multisample:options.multisample,samplesAmount:options.samplesAmount}),_scene.nuke=_nuke,function initRT(rt,options={}){options.type==Texture.FLOAT&&(options.format=Texture.RGBAFormat,"ios"==Device.system.os&&(options.type=Texture.HALF_FLOAT,options.minFilter=Texture.NEAREST,options.magFilter=Texture.NEAREST));const RT=_this.nuke.useDrawBuffers&&options.multiRenderTarget?MultiRenderTarget:RenderTarget;_this.width=_nuke.stage.width*_this.resolution*_nuke.dpr,_this.height=_nuke.stage.height*_this.resolution*_nuke.dpr;let magFilter=Texture.LINEAR,minFilter=options.mipmaps?Texture.LINEAR_MIPMAP:Texture.LINEAR;_rt=rt||new RT(_this.width,_this.height,Object.assign({minFilter:minFilter,magFilter:magFilter,generateMipmaps:options.mipmaps||!1},options)),_nuke.rtt=_this.rt=_rt,_rt.fxscene=_this,_this.vrRT&&(_rt.vrRT=!0)}(rt,options),rt?_this.flag("recycle_rt",!0):function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),FXScene.onCreate&&FXScene.onCreate(_this),options.manualRender||_this.manualRender||FXScene.manualRender||(Hydra.LOCAL&&(_showManualRenderWarning=!0),_this.vrRT?_this.startRender((({view:view})=>{0!==view||_this.manualRender||_this.draw()}),RenderManager.EYE_RENDER):_this.startRender((_=>{_this.manualRender||_this.draw()}),nuke)))},this.onDestroy=this.fxDestroy=function(){_this.scene.deleted=!0,_this.flag("recycle_rt")?_rtPool&&_rt&&_rtPool.putRT(_rt):_rt&&_rt.destroy&&_rt.destroy()},this.setSize=function(width,height,exact){_nuke&&(exact||(width=width*_this.resolution*_nuke.dpr,height=height*_this.resolution*_nuke.dpr),_rt.width==width&&_rt.height==height||(_this.events.unsub(Events.RESIZE,resizeHandler),_this.width=width,_this.height=height,_rt&&_rt.setSize(_this.width,_this.height),_nuke.setSize(_this.width,_this.height)))},this.add=this.addObject=function(object){if(!object.shader)return;if(!object)return console.error("FXScene addObject undefined!");let clone=object.clone();for(object["clone_"+_id]=clone,_scene.add(clone),_objects.push(object),object.shader._attachmentData={format:_this.rtFormat,type:_this.rtType,attachments:1};clone.children.length;)clone.remove(clone.children[0]);return clone},this.removeObject=function(object){_scene.remove(object["clone_"+_id]),_objects.remove(object),delete object["clone_"+_id]},this.setScissor=function(x,y,w,h,invert){if(null===x)return void(this.scissor=this.rt.scissor=null);let width=_rt.width,height=_rt.height;this.scissor||(this.scissor=new Vector4),this.scissor.x=x*width,this.scissor.y=invert?y*height:height-h*height-y*height,this.scissor.width=w*width,this.scissor.height=h*height,this.rt.scissor=this.scissor},this.render=this.draw=function(stage,camera){if(_this.preventRender)return;if(_this.isVrWorldMode)return void(_this.onBeforeRender&&_this.onBeforeRender());if(!_this.manualRender&&Render.TIME-_renderTime<1e3/Render.REFRESH_RATE/2)return void(_showManualRenderWarning&&(console.warn(`FXScene ${Utils.getConstructorName(_this)} rendering early (${Math.round(Render.TIME-_renderTime,3)}ms elapsed, expected ~${Math.round(1e3/Render.REFRESH_RATE,3)}ms. Set manualRender option if using own render loop.`),_showManualRenderWarning=!1));if(_renderTime=Render.TIME,_this.isVrSceneMode){let rt=World.NUKE.enabled&&World.NUKE.passes.length?World.NUKE.rttBuffer:void 0,autoClear=_nuke.renderer.autoClear;return _nuke.renderer.autoClear=!1,_nuke.renderer.clearDepth(rt),_this.onBeforeRender&&_this.onBeforeRender(),_nuke.renderer.render(_scene,_nuke.camera,rt),void(_nuke.renderer.autoClear=autoClear)}stage&&(_this.events.unsub(Events.RESIZE,resizeHandler),_this.nuke.stage=stage,_this.setSize(stage.width,stage.height)),camera&&(_this.nuke.camera=camera);let clearColor=null,alpha=1;_this.clearColor&&(clearColor=_nuke.renderer.getClearColor().getHex(),_nuke.renderer.setClearColor(_this.clearColor)),_this.clearAlpha>-1&&(alpha=_nuke.renderer.getClearAlpha(),_nuke.renderer.setClearAlpha(_this.clearAlpha)),_this.renderShadows||(_nuke.renderer.overridePreventShadows=!0);for(let i=_objects.length-1;i>-1;i--){let obj=_objects[i],clone=obj["clone_"+_id];_this.forceVisible||obj.cloneVisible?clone.visible="boolean"!=typeof clone.isVisible||clone.isVisible:clone.visible=obj.determineVisible(),clone.visible&&(obj.updateMatrixWorld(!1===obj.visible||void 0),obj.ignoreMatrix||(Utils3D.decompose(obj,clone),clone.overrideScale&&clone.scale.setScalar(clone.overrideScale)))}_this.preventRTDraw||(RenderStats.update("FXScene",1,_this),_this.onBeforeRender&&_this.onBeforeRender(),_nuke.rtt=_rt,_nuke.render()),_nuke.renderer.overridePreventShadows=!1,_this.clearColor&&_nuke.renderer.setClearColor(clearColor),_this.clearAlpha>-1&&_nuke.renderer.setClearAlpha(_this.clearAlpha),RenderManager.fire(_this)},this.setDPR=function(dpr){return _nuke?(_nuke.dpr=dpr,resizeHandler(),_this):_this},this.addPass=function(pass){_nuke&&_nuke.add(pass)},this.removePass=function(pass){_nuke&&_nuke.remove(pass)},this.setResolution=function(res){return _this.resolution=res,_rt.vrRT&&(_rt.vrRT=res),resizeHandler(),this},this.useRT=function(rt){_rt=_this.rt=rt,_this.vrRT&&(rt.vrRT=!0)},this.upload=function(){_rt&&_rt.upload()},this.useCamera=function(camera){_this.nuke&&(_this.nuke.camera=camera.camera||camera)},this.useScene=function(scene){_this.nuke.scene=scene},this.vrWorldMode=function(){_this.isVrWorldMode=!0,_this.group=new Group;for(let i=0;i<this.scene.children.length;i++)this.group.add(this.scene.children[i]);_scene=_this.scene=_this.group,World.SCENE.add(_this.group)},this.vrSceneMode=function(){_this.isVrSceneMode=!0,World.NUKE.autoClear=!1,RenderManager.renderer.autoClear=!1},this.createDepthTexture=function(useRTTBuffer){return _this.depthTexture||(_this.nuke.passes.length||useRTTBuffer?(_this.nuke.rttBuffer.createDepthTexture(),_this.depthTexture=_this.nuke.rttBuffer.depth):(_this.rt.createDepthTexture(),_this.depthTexture=_this.rt.depth)),_this.depthTexture},_parentNuke instanceof Nuke&&this.create(_parentNuke,_type,...rest)})),Class((function FXSceneCompositor(_shader,_options={}){Inherit(this,Object3D);const _this=this;var _basicShader;function decorateShader(shader){shader.addUniforms({tFrom:{value:null},tTo:{value:null},uTransition:{value:0}})}function loop(){_this.mesh.shader=_shader.uniforms.uTransition.value>0?_shader:_basicShader,_shader.uniforms.uTransition.value>=1&&(_this.mesh.shader=_basicShader,_basicShader.set("tMap",_shader.get("tTo")),_shader.set("uTransition",0))}!function initOptions(){(null===_options||_options instanceof Texture||_options.texture||_options.rt&&_options.rt.texture)&&(_options={startTexture:_options})}(),decorateShader(_shader),function initMesh(){let uniforms={tMap:{value:_options.startTexture||null}};_options.basicShader?(_basicShader=_options.basicShader).addUniforms(uniforms):_basicShader=_this.initClass(Shader,"ScreenQuad",uniforms),_this.mesh=new Mesh(World.QUAD,_basicShader),_this.mesh.frustumCulled=!1,_this.add(_this.mesh)}(),_this.startRender(loop),this.useShader=function(shader){_shader=shader,decorateShader(shader)},this.useBasicShader=function(shader){_basicShader.copyUniformsTo(shader,!0),_basicShader=shader},this.swap=function(showTransition){showTransition?_this.mesh.shader=_shader:(_basicShader.set("tMap",_shader.get("tTo")),_this.mesh.shader=_basicShader,_shader.set("tFrom",_basicShader.get("tMap")))},this.set("manual",(v=>{v?_this.stopRender(loop):_this.startRender(loop)})),this.transition=async function(texture,time,ease,delay){_this.parent.lock&&_this.parent.lock();let from=_shader.get("tFrom");_shader.set("tTo",texture),texture.visible=!0,from?await _shader.tween("uTransition",1,time,ease,delay).promise():_shader.set("uTransition",1),from&&(from.visible=!1),_shader.set("tFrom",texture),_this.parent.unlock&&_this.parent.unlock()}})),Class((function FXStencil(){Inherit(this,Component);const _this=this;var _nuke;function render(){_nuke||(_nuke=function findNuke(){let p=_this.mesh._parent;for(;p;){if(p instanceof Scene)return p.nuke;p=p._parent}}());let autoClear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,_this.enabled&&(_this.onBeforeMaskRendered&&_this.onBeforeMaskRendered(),World.RENDERER.setupStencilMask(),World.RENDERER.render(_this.mask,_nuke.camera,"stencil"),_this.onAfterMaskRendered&&_this.onAfterMaskRendered(),World.RENDERER.setupStencilDraw(_this.mode)),World.RENDERER.render(_this.scene,_nuke.camera,"stencil"),World.RENDERER.autoClear=autoClear,World.RENDERER.clearStencil()}this.mesh=new Mesh(World.PLANE,Utils3D.getTestShader()),this.scene=new Scene,this.mask=new Scene,this.mode="inside",this.enabled=!0,_this.mesh.shader.neverRender=!0,_this.mesh.shader.transparent=!0,_this.mesh.renderOrder=99999,_this.mesh.onBeforeRender=render,this.onDestroy=function(){_this.group._parent.remove(_this.mesh)}})),Class((function FragCompositor(){Inherit(this,Component);const _this=this;this._initCompositor=function(obj){_this.shader=_this.initClass(Shader,obj.shader,_this.parent[obj.uniforms.slice(1)]),_this.basicShader=_this.initClass(Shader,obj.basicShader||"ScreenQuad",_this.parent[obj.uniforms.slice(1)]),_this.compositor=_this.initClass(FXSceneCompositor,_this.shader,{basicShader:_this.basicShader}),RenderManager.type==RenderManager.NORMAL&&(obj.scene||World.SCENE).add(_this.compositor.mesh)}})),Class((function BlitPass(_forceNuke){Inherit(this,NukePass);this.uniforms={},this.init("BlitPass"),_forceNuke||(this.blitFramebuffer=!0)})),Class((function Nuke(_stage,_params){Inherit(this,Component);var _width,_height,_nukeMesh,_this=this,_finalTexture={texture:Utils3D.getEmptyTexture()};_params.renderer||console.error("Nuke :: Must define renderer"),_this.stage=_stage,_this.renderer=_params.renderer,_this.camera=_params.camera,_this.scene=_params.scene,_this.rtt=_params.rtt,_this.enabled=0!=_params.enabled,_this.passes=_params.passes||[],_this.format=_params.format||Texture.RGBFormat,_this.useDrawBuffers=!Utils.query("noDrawBuffers")&&!Nuke.NO_DRAWBUFFERS&&(void 0!==_params.useDrawBuffers?_params.useDrawBuffers:!(Renderer.type!=Renderer.WEBGL2&&!window.Metal));var _rttPing,_rttPong,_rttBuffer,_dpr=_params.dpr||1,_drawBuffers=[],_enabledPasses=[],_multisample=_params.multisample||!1,_samplesAmount=_params.samplesAmount||4;function resizeHandler(){var width=_this.stage.width*_dpr,height=_this.stage.height*_dpr;_rttPing.setSize(width,height),_rttPong.setSize(width,height),_rttBuffer.setSize(width,height),Nuke.renameRT(_width,_height,width,height,!1,1,_this.format,!1,_samplesAmount),Nuke.renameRT(_width,_height,width,height,!1,2,_this.format,!1,_samplesAmount),Nuke.renameRT(_width,_height,width,height,_this.useDrawBuffers,-1,_this.format,_multisample,_samplesAmount),_width=width,_height=height}_this.scene.nuke=_this,function initDefaultPass(){if(Nuke.defaultPass)return;let upload=(Nuke.defaultPass=new BlitPass).upload;Nuke.defaultPass.upload=function(){upload.apply(this,arguments),Nuke.defaultPass.uploaded=!0}}(),function initNuke(){let width=_this.stage.width*_dpr,height=_this.stage.height*_dpr;_rttPing=Nuke.getRT(width,height,!1,1,_this.format,!1,_samplesAmount),_rttPong=Nuke.getRT(width,height,!1,2,_this.format,!1,_samplesAmount),_rttBuffer=Nuke.getRT(width,height,_this.useDrawBuffers,-1,_this.format,_multisample,_samplesAmount),(_nukeMesh=new Mesh(World.QUAD,null)).frustumCulled=!1,_nukeMesh.noMatrices=!0,_nukeMesh.transient=!0,_width=width,_height=height,_params.vrRT&&(_this.vrRT=!0,_rttBuffer.vrRT=!0)}(),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),_this.forceResize=resizeHandler,_this.onBeforeShaderCompile=function(obj){if(!obj)return;let shader=obj.shader;if(!(shader&&shader.fragmentShader&&_this.useDrawBuffers&&_drawBuffers.length))return;if(shader.fragmentShader.includes("layout(location"))return;const WEBGL2=Renderer.type==Renderer.WEBGL2;let matched=!1;if(_drawBuffers.forEach(((t,i)=>{let name=t.fxLayer.getName(),keyExpr=WEBGL2?new RegExp(`\\b${name}\\s*=`):new RegExp(`\\bgl_FragData\\[${i+1}\\]\\s*=`),defaultOutput=t.fxLayer.defaultOutputColor||"vec4(0.0)";if("Color"===defaultOutput&&(defaultOutput="tmpFragColor"),!keyExpr.test(shader.fragmentShader)&&_this.useDrawBuffers){let fs=shader.fragmentShader;if(!fs.includes(`#drawbuffer ${name} gl_FragColor`)){let idx=fs.lastIndexOf("}");fs=fs.slice(0,idx)+`#drawbuffer ${name} gl_FragColor = ${defaultOutput};\n`+fs.slice(idx),shader.fragmentShader=fs}t.fxLayer.add(obj),matched=!0}})),!(WEBGL2?/\bColor\s*=/:/\bgl_FragData\[0\]\s*=/).test(shader.fragmentShader)){let fs=shader.fragmentShader;if(!fs.includes("layout(location=0) out vec4 reflectionsData")){WEBGL2||(fs="#extension GL_EXT_draw_buffers : require\n"+fs),fs=fs.split("void main() {"),fs=fs[0]+"void main() {\nvec4 tmpFragColor;\n"+fs[1],fs=fs.replace(/gl_FragColor/g,"tmpFragColor");let idx=fs.lastIndexOf("}");fs=matched?WEBGL2?fs.slice(0,idx)+"Color = tmpFragColor;\n"+fs.slice(idx):fs.slice(0,idx)+"gl_FragData[0] = tmpFragColor;\n"+fs.slice(idx):fs.slice(0,idx)+"#drawbuffer Color gl_FragColor = tmpFragColor;\n"+fs.slice(idx)}shader.fragmentShader=fs}shader.onBeforePrecompilePromise.resolve()},_this.add=function(pass,index){"number"!=typeof index?_this.passes.push(pass):_this.passes.splice(index,0,pass)},_this.remove=function(pass){"number"==typeof pass?_this.passes.splice(pass):_this.passes.remove(pass)},_this.render=function(directCallback){if(_this.paused)return;RenderStats.update("Nuke"),RenderManager.fire(_this),_this.events.fire(Nuke.RENDER,_this,!0),_this.onBeforeRender&&_this.onBeforeRender();let count=_this.passes.length;_enabledPasses.length=0;for(let i=0;i<count;i++){let pass=_this.passes[i];pass.disabled||_enabledPasses.push(pass)}if(_this.enabled&&0===_enabledPasses.length&&!_this.rtt&&(_dpr!==Device.pixelRatio||_multisample)&&Nuke.defaultPass&&_enabledPasses.push(Nuke.defaultPass),!_this.enabled||!_enabledPasses.length){let autoClear=_this.renderer.autoClear;return 0==_this.autoClear&&(_this.renderer.autoClear=!1),_this.renderer.render(_this.scene,_this.camera,_this.rtt,null,directCallback),_this.onBeforeProcess&&_this.onBeforeProcess(),_this.events.fire(Nuke.BEFORE_PASSES,_this,!0),_this.events.fire(Nuke.BEFORE_POST_RENDER,_this,!0),_this.postRender&&_this.postRender(),_this.events.fire(Nuke.POST_RENDER,_this,!0),void(0==_this.autoClear&&(_this.renderer.autoClear=autoClear,_this.renderer.clearColor()))}RenderStats.update("NukePass",_enabledPasses.length),_this.hasRendered=!0,_this.onBeforeProcess&&_this.onBeforeProcess();let autoClear=_this.renderer.autoClear;0==_this.autoClear&&(_this.renderer.autoClear=!1),_this.parent.scissor&&(_rttBuffer.scissor=_this.parent.scissor),_this.preventNewRender||_this.renderer.render(_this.scene,_this.camera,_rttBuffer),0==_this.autoClear&&(_this.renderer.autoClear=autoClear),_this.onBeforePasses&&_this.onBeforePasses(_rttBuffer);let pingPong=!0,skipMultisample=_this.rtt&&_this.rtt.multisample;skipMultisample&&(_this.rtt.multisample=!1),count=_enabledPasses.length,_this.events.fire(Nuke.BEFORE_PASSES,_this,!0);for(var i=0;i<count;i++){let shader=_enabledPasses[i].pass,inTexture=0===i?_rttBuffer.texture:pingPong?_rttPing.texture:_rttPong.texture,outTexture=pingPong?_rttPong:_rttPing;i===count-1&&(outTexture=_this.rtt),_nukeMesh.shader=shader,_nukeMesh.shader.depthTest=!1,_nukeMesh.shader.depthWrite=!1,_nukeMesh.shader.uniforms.tDiffuse.value=inTexture,_this.parent.scissor&&(outTexture.scissor=_this.parent.scissor),_this.renderer.renderSingle(_nukeMesh,_this.camera||World.CAMERA,outTexture,i===count-1?directCallback:null),_enabledPasses[i]?.onRenderCallBack?.(),pingPong=!pingPong,outTexture&&(_finalTexture.texture=outTexture.texture)}skipMultisample&&(_this.rtt.multisample=!0),_this.events.fire(Nuke.BEFORE_POST_RENDER,_this,!0),_this.postRender&&_this.postRender(),_this.events.fire(Nuke.POST_RENDER,_this,!0),0==_this.autoClear&&_this.renderer.clearColor(_rttBuffer)},_this.setSize=function(width,height){width==_width&&height==_height||(_width=width,_height=height,resizeHandler(),_this.events.unsub(Events.RESIZE,resizeHandler))},_this.attachDrawBuffer=function(texture){if(_this.hasRendered&&console.warn("Attempt to attach draw buffer after first render! Create FXLayer instance before first render."),_drawBuffers.push(texture),_rttBuffer&&_rttBuffer.attachments){_rttBuffer.attachments=[_this.rtt&&_this.rtt.attachments?_this.rtt.attachments[0]:_rttBuffer.attachments[0]];for(let i=0;i<_drawBuffers.length;i++)_rttBuffer.attachments.push(_drawBuffers[i]),_this.rtt&&_this.rtt.attachments&&_this.rtt.attachments.push(_drawBuffers[i])}return _drawBuffers.length},_this.upload=function(){_this.passes.length&&_this.enabled&&(_rttPing.upload(),_rttPong.upload(),_rttBuffer.upload()),_rttBuffer.depth&&_rttBuffer.depth.upload(),_this.rtt&&_this.rtt.upload()},_this.set("dpr",(function(v){_dpr=v,resizeHandler()})),_this.get("dpr",(function(){return _dpr})),_this.get("output",(function(){return _nukeMesh.shader&&_nukeMesh.shader.uniforms?_nukeMesh.shader.uniforms.tDiffuse.value:null})),_this.get("finalTexture",(_=>_finalTexture)),_this.get("rttBuffer",(function(){return _rttBuffer})),this.set("rttBuffer",(function(v){_rttBuffer=v})),_this.get("prevFrameRT",(function(){return _rttBuffer&&_rttBuffer.texture?_rttBuffer.texture:null})),_this.get("nukeScene",(function(){return _nukeScene})),_this.get("ping",(function(){return _rttPing})),_this.get("pong",(function(){return _rttPong})),_this.get("attachments",(function(){return _rttBuffer.attachments?_rttBuffer.attachments.length:0})),_this.disable=function(){_this.enabled=!1,_this.passes.forEach((pass=>{pass.enabled=!1}))},this.onDestroy=function(){_rttBuffer.destroy()},this.clearMemory=function(){_rttBuffer.destroy(),_rttPing.destroy(),_rttPong.destroy()}}),(function(){Nuke.RENDER="nuke_render",Nuke.BEFORE_PASSES="nuke_before_passes",Nuke.BEFORE_POST_RENDER="nuke_before_post_render",Nuke.POST_RENDER="nuke_post_render";var _rts={};Nuke.getRT=function(width,height,multi,index,format,multisample,samplesAmount){let rt,exists=_rts[`${width}_${height}_${multi}_${index}_${format}_${multisample}_${samplesAmount}`];return exists||(rt=multi?Utils3D.createMultiRT(width,height,void 0,format,multisample,samplesAmount):Utils3D.createRT(width,height,void 0,format,multisample,samplesAmount),Nuke.recyclePingPong&&!multi&&(_rts[`${width}_${height}_${multi}_${index}_${format}_${multisample}_${samplesAmount}`]=rt),rt)},Nuke.renameRT=function(prevWidth,prevHeight,width,height,multi,index,format,multisample,samplesAmount){_rts[`${width}_${height}_${multi}_${index}_${format}_${multisample}_${samplesAmount}`]=_rts[`${prevWidth}_${prevHeight}_${multi}_${index}_${format}_${multisample}_${samplesAmount}`]}})),Class((function NukePass(_fs,_uniforms,_pass){Inherit(this,Component);var _this=this;if("object"==typeof _fs){let shader=_fs.shader;_uniforms=_fs.uniforms,_fs=shader}this.UILPrefix="string"==typeof _fs?_fs:Utils.getConstructorName(_fs),this.init=function(fs,vs){if(_this.pass)return;_this=this;fs||this.constructor.toString().match(/function ([^\(]+)/)[1],Array.isArray(fs)&&fs.join("");if(_this.uniforms=_uniforms||_this.uniforms||{},_this.uniforms.tDiffuse={type:"t",value:null,ignoreUIL:!0},_this.uniforms.unique&&(_this.UILPrefix+="_"+_this.uniforms.unique+"_"),window.UILStorage)for(let key in _this.uniforms)"unique"!==key&&(_this.uniforms[key]=UILStorage.parse(_this.UILPrefix+key,_this.uniforms[key].value)||_this.uniforms[key]);_this.pass=_this.initClass(Shader,vs||"NukePass",fs,Utils.mergeObject(_this.uniforms,{precision:"high"}),((code,type)=>"fs"==type?function prefix(code){if(!code)throw`No shader ${_fs} found`;let pre="";return code.includes("uniform sampler2D tDiffuse")||(pre+="uniform sampler2D tDiffuse;\n",pre+="varying vec2 vUv;\n"),pre+code}(code):code)),_this.uniforms=_this.pass.uniforms},this.set=function(key,value){TweenManager.clearTween(_this.uniforms[key]),_this.uniforms[key].value=value},this.get=function(key){return void 0===_this.uniforms[key]?null:_this.uniforms[key].value},this.tween=function(key,value,time,ease,delay,callback,update){return tween(_this.uniforms[key],{value:value},time,ease,delay,callback,update)},this.clone=function(){return _this.pass||_this.init(_fs),new NukePass(null,null,_this.pass.clone())},this.upload=function(){_this.pass.upload()},this.addUniforms=function(obj){for(let key in obj)_this.uniforms[key]=obj[key]},"string"==typeof _fs?_this.init(_fs):_pass&&(_this.pass=_pass,_this.uniforms=_pass.uniforms)})),Class((function Raycaster(_camera){Inherit(this,Component);const _this=this;let _mouse=new Vector3,_raycaster=new RayManager;function ascSort(a,b){return a.distance-b.distance}function intersectObject(object,raycaster,intersects,recursive){let obj=object;for(;obj&&_this.testVisibility;){if(!1===obj.visible&&!obj.forceRayVisible&&!1!==obj.testVisibility)return;obj=obj.parent}if(object.raycast&&(object.raycast(raycaster,intersects),!0===recursive)){let children=object.children;for(let i=0,l=children.length;i<l;i++)intersectObject(children[i],raycaster,intersects,!0)}}function intersect(objects){Array.isArray(objects)||(objects=[objects]);let intersects=[];return objects.forEach((object=>{intersectObject(object,_raycaster,intersects,!1)})),intersects.sort(ascSort),intersects}this.testVisibility=!0,this.set("camera",(function(camera){_camera=camera})),this.set("pointsThreshold",(function(value){_raycaster.params.Points.threshold=value})),this.get("ray",(()=>_raycaster.ray)),this.checkHit=function(objects,mouse,rect=Stage){return mouse=mouse||Mouse,_mouse.x=mouse.x/rect.width*2-1,_mouse.y=-mouse.y/rect.height*2+1,_raycaster.setFromCamera(_mouse,_camera),intersect(objects)},this.checkFromValues=function(objects,origin,direction){return _raycaster.set(origin,direction,0,Number.POSITIVE_INFINITY),intersect(objects)}}),(_=>{var _ray,_map=new WeakMap;Raycaster.checkHit=function(objects,mouse){return _ray||(_ray=new Raycaster(World.CAMERA)),_ray.checkHit(objects,mouse)},Raycaster.checkFromValues=function(objects,origin,direction){return _ray||(_ray=new Raycaster(World.CAMERA)),_ray.checkFromValues(objects,origin,direction)},Raycaster.find=function(camera){if(!_map.has(camera)){let ray=new Raycaster(camera);_map.set(camera,ray)}return _map.get(camera)}})),Class((function ScreenProjection(_camera){Inherit(this,Component);var _v3=new Vector3,_v32=new Vector3,_value=new Vector3;_camera=_camera.camera||_camera,this.set("camera",(function(v){_camera=v.camera||v})),this.get("camera",(_=>_camera)),this.unproject=function(mouse,rect=Stage,distance=1){"number"==typeof rect&&(distance=rect,rect=Stage),_v3.set(mouse.x/rect.width*2-1,-mouse.y/rect.height*2+1,.5),_v3.unproject(_camera);let pos=_camera.getWorldPosition();return _v3.sub(pos).normalize().multiplyScalar(distance),_value.copy(pos).add(_v3),_value},this.project=function(pos,screen){return screen=screen||Stage,pos instanceof Base3D?(pos.updateMatrixWorld(),_v32.set(0,0,0).setFromMatrixPosition(pos.matrixWorld)):_v32.copy(pos),_v32.project(_camera),_v32.x=(_v32.x+1)/2*screen.width,_v32.y=-(_v32.y-1)/2*screen.height,_v32}}),(_=>{var _screen,_map=new WeakMap;ScreenProjection.unproject=function(mouse,distance){return _screen||(_screen=new ScreenProjection(World.CAMERA)),_screen.unproject(mouse,distance)},ScreenProjection.project=function(pos,screen){return _screen||(_screen=new ScreenProjection(World.CAMERA)),_screen.project(pos,screen)},ScreenProjection.find=function(camera){if(!_map.has(camera)){let projection=new ScreenProjection(camera);_map.set(camera,projection)}return _map.get(camera)}})),Class((function Object3D(){Inherit(this,Component);var _this=this,_visible=!0;this.__element=!0,this.group=new Group,this.group.classRef=this,this.add=function(child){this.group.add(child.group||child)},this.remove=function(child){child&&this.group.remove(child.group||child)},this.onDestroy=function(){this.group.deleted=!0,this.group.classRef=null,this.group&&this.group._parent&&this.group._parent.remove(this.group)},this.set("visible",(v=>_this.group.visible=_visible=v)),this.get("visible",(_=>_visible))})),Class((function OrbitTargetHelper(){Inherit(this,Object3D);const _this=this;var _velocity=new function VelocityTracker(_vector){var Vector="number"==typeof _vector.z?Vector3:Vector2,_velocity=new Vector,_last=new Vector;this.value=_velocity,this.update=function loop(time,delta){_velocity.subVectors(_vector,_last).divideScalar((delta||Render.DELTA)/(1e3/60)),_last.copy(_vector)}}(_this.group.position);function set(){_this.flag("needsReset",!1),Playground.instance().orbitControls.target.copy(_this.group.position),_this.events.unsub(Mouse.input,Interaction.END,set)}!async function(){Global.PLAYGROUND&&(await defer(),Playground.instance().orbitControls.target.copy(_this.group.position),_this.startRender((_=>{_velocity.update(),_velocity.value.length()>0&&(_this.flag("needsReset",!0),_this.events.sub(Mouse.input,Interaction.END,set))})))}()})),Class((function Utils3D(){const _this=this;var _emptyTexture,_q,_v3,_v3b,_v3c,_m4,_v4,_supportsKtx1,_textures={},_restorable={},_dominantColors={};function getTexture(key,params,loadTexture){if(!Device.graphics.webgl&&!window.AURA){let texture=params.isTexture3D?new Texture3D:new Texture;return texture.promise=Promise.resolve(),texture.dimensions=params.isTexture3D?{width:0,height:0,depth:0}:{width:0,height:0},texture}let restorable=_restorable[key];if(restorable&&(restorable=restorable.deref(),delete _restorable[key]),restorable)restorable.restore();else if(_textures[key])_textures[key].exists++;else{let texture=params.isTexture3D?new Texture3D:new Texture;params.isCubeLUT&&(texture.isCubeLUT=!0),texture.exists=1,texture.loaded=!1,texture.promise=Promise.create(),texture._destroy=texture.destroy,texture.destroy=function(force){!force&&(texture.forcePersist||--texture.exists>0)||(texture.exists||texture._image||texture._gl||_textures[key])&&(delete _textures[key],delete _dominantColors[key],RenderCount.remove(`tex_${texture?.dimensions?.width}_${texture?.dimensions?.height}`),RenderCount.remove("tex_"+(texture.compressed?"compressed":"uncompressed")),_restorable[key]=new WeakRef(this),this._destroy())},_textures[key]=texture,!1===params.premultiplyAlpha&&(texture.premultiplyAlpha=!1),_this.onTextureCreated&&_this.onTextureCreated(texture);let doLoadTexture=async()=>{try{await loadTexture(texture),texture.loaded=!0,texture.needsReupload=!0,RenderCount.add(`tex_${texture.dimensions.width}_${texture.dimensions.height}`),RenderCount.add("tex_"+(texture.compressed?"compressed":"uncompressed")),texture.onload&&(texture.onload(),texture.onload=null),texture.promise.resolve()}catch(e){texture.promise.reject(e)}};doLoadTexture(texture),texture.restore=function(){delete _restorable[key],texture.exists++,_textures[key]||(texture.promise=Promise.create(),texture.loaded=texture.needsReupload=!1,_textures[key]=texture,texture.dominantColors&&!_dominantColors[key]&&(_dominantColors[key]=texture.dominantColors),doLoadTexture(texture))}}return _textures[key]}function loadTextureSource(texture,path,params){let promise=Promise.create();return ImageDecoder.decode(path,params).then((imgBmp=>{imgBmp.crossOrigin="anonymous",texture.dimensions={width:imgBmp.width,height:imgBmp.height},texture.loaded=!0,texture.needsReupload=!0,texture.compressed&&!imgBmp.compressedData&&(texture.compressed=!1),World.RENDERER.type===Renderer.WEBGL2||Math.isPowerOf2(imgBmp.width,imgBmp.height)||(texture.minFilter=Texture.LINEAR,texture.generateMipmaps=!1),promise.resolve(imgBmp)})).catch((e=>{promise.reject(e)})),promise}function parseTexturePath(path){if(path.includes("://")){let guard=path.split("://");guard[1]=guard[1].replace(/\/\//g,"/"),path=guard.join("://")}else path=path.replace(/\/\//g,"/");let compressed,compressedIdentifier,cacheBust;if(({compressed:compressed,compressedIdentifier:compressedIdentifier,path:path}=parseCompressed(path)),window.URLSearchParams){if(path.includes("?")){let[withoutQuery,query]=path.split("?"),params=new URLSearchParams(query);for(const[key,value]of params.entries()){let check=key;key.includes("-compressedKtx")&&(check=key.substring(0,key.indexOf("-compressedKtx"))),Number.isInteger(Number(check))&&Number(check)>0&&""===value&&(params.delete(key),check!==key&&compressed&&(withoutQuery+=compressedIdentifier),cacheBust=!0)}cacheBust&&(path=withoutQuery,query=params.toString(),query&&(path+="?"+query))}}else path.includes("?")&&(cacheBust=!0,path=path.split("?")[0]);Hydra.LOCAL||(cacheBust=!1);let imgPath=path;return cacheBust&&(imgPath+=(imgPath.includes("?")?"&":"?")+Date.now()),compressed&&!imgPath.includes("compressed")&&(imgPath+=compressedIdentifier),{plainPath:path,imgPath:imgPath,compressed:compressed}}function parseCompressed(path){let compressedIdentifier=/-compressedKtx2?/.exec(path)?.[0],compressed=!1;compressedIdentifier&&(Utils.query("noKtx")||(compressedIdentifier.endsWith("2")?"undefined"!=typeof Ktx2Transcoder&&(compressed="ktx2"):compressed="ktx1"),path=path.replace(compressedIdentifier,""));let requiresKtx=!1;return/\.ktx2(?:\?|#|$)/.test(path)&&(compressed="ktx2",compressedIdentifier="",requiresKtx=!0),{compressed:compressed,compressedIdentifier:compressedIdentifier,path:path,requiresKtx:requiresKtx}}function splitCubemapPath(url){let path=url.replace(/-compressedKtx2?/,"").split(/[#?]/)[0],match=/(\d+)(?!.*\d+)/.exec(path);if(!match)throw new Error("Cubemap texture path must include a numeric pattern");let prefix=url.substring(0,match.index),pattern=match[1];return{prefix:prefix,pattern:pattern,suffix:url.substring(match.index+pattern.length),start:+pattern}}function getCubemapFacePaths(pathinfo){let padChar,{prefix:prefix,pattern:pattern,suffix:suffix,start:start}=pathinfo;return pattern.length>String(start).length&&(padChar=pattern.charAt(0)),Array.from(Array(6).keys(),(i=>{let n=String(start+i);return padChar&&(n=n.padStart(pattern.length,padChar)),`${prefix}${n}${suffix}`}))}async function doFindDominantColors(texOrImageOrPath,numColors){let image;if(texOrImageOrPath.isTexture)if(texOrImageOrPath.image){if(texOrImageOrPath.image.compressedData&&0===texOrImageOrPath.image.compressedData.length){let{path:path,...params}=texOrImageOrPath.decodeParams;params.hintUsingPixelData=!0,image=await ImageDecoder.decode(path,params)}}else image=texOrImageOrPath.src;return image=image||texOrImageOrPath.image||texOrImageOrPath,"string"==typeof image&&(image=await Assets.decodeImage(image)),ImageDecoder.parseColors(image,numColors)}window.Vec2=window.Vector2,window.Vec3=window.Vector3,this.localDebug=window.Hydra&&Hydra.LOCAL,async function(){await Hydra.ready();let threads=Thread.shared(!0);for(let i=0;i<threads.array.length;i++)_this.loadEngineOnThread(threads.array[i])}(),this.decompose=function(local,world){local.decomposeCache||(local.decomposeCache={position:new Vector3,quaternion:new Quaternion,scale:new Vector3}),local.decomposeDirty&&(local.matrixWorld.decompose(local.decomposeCache.position,local.decomposeCache.quaternion,local.decomposeCache.scale),local.decomposeDirty=!1),world.position.copy(local.decomposeCache.position),world.quaternion.copy(local.decomposeCache.quaternion),world.scale.copy(local.decomposeCache.scale)},this.createDebug=function(size=1,color){return new Mesh(new IcosahedronGeometry(size,1),_this.getTestShader(color))},this.getTestShader=function(color){return color?new Shader("ColorMaterial",{color:{value:color instanceof Color?color:new Color(color)},alpha:{value:1}}):new Shader("TestMaterial")},this.createMultiRT=function(width,height,type,format,multisample=!1,samplesAmount=4){let rt=new MultiRenderTarget(width,height,{minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:format||Texture.RGBFormat,type:type,multisample:multisample,samplesAmount:samplesAmount});return rt.texture.generateMipmaps=!1,rt},this.createRT=function(width,height,type,format,multisample=!1,samplesAmount=4){let rt=new RenderTarget(width,height,{minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:format||Texture.RGBFormat,type:type,multisample:multisample,samplesAmount:samplesAmount});return rt.texture.generateMipmaps=!1,rt},this.getFloatType=function(){return"android"==Device.system.os?Texture.FLOAT:Texture.HALF_FLOAT},this.findNuke=function(obj){if(!obj)return;let p=obj.parent;for(;p;){if(p.nuke)return p.nuke;p=p.parent}for(p=obj.parent;p;){if(p.nuke)return p.nuke;p=p.group?p.group._parent:p.parent||p._parent}for(p=obj._parent;p;){if(p.nuke)return p.nuke;p=p._parent}return World.NUKE},this.getTexture=function(path,params={}){let{imgPath:imgPath,plainPath:plainPath,compressed:compressed}=parseTexturePath(path),texture=getTexture(plainPath,params,(async texture=>{texture.compressed=compressed,texture.format=plainPath.match(/\.jpe?g/)?Texture.RGBFormat:Texture.RGBAFormat,texture.src=plainPath,texture.decodeParams={path:imgPath,...params};let imgBmp=await loadTextureSource(texture,imgPath,params);texture.image=imgBmp,imgBmp.sizes&&1===imgBmp.sizes.length&&(texture.minFilter=Texture.LINEAR),texture.onUpdate=function(){!params.preserveData&&imgBmp.close&&(imgBmp.close(),texture.image=null),texture.onUpdate=null}}));return texture.promise.then((_=>{params.findDominantColors&&"number"===(params.findDominantColors,!1)&&(params.findDominantColors=4),params.findDominantColors&&_this.findDominantColors(texture,params.findDominantColors)}),(()=>{})),texture},this.getCubeLUT=function(path,params){let{imgPath:imgPath,plainPath:plainPath}=parseTexturePath(path);return params={...params,isTexture3D:!0,isCubeLUT:!0},getTexture(plainPath,params,(async texture=>{let{imgBmp:imgBmp,cubesize:cubesize}=await function loadCubeLUTSource(path,params){let promise=Promise.create(),{compressed:compressed,compressedIdentifier:compressedIdentifier,newpath:newpath,requiresKtx:requiresKtx}=parseCompressed(path);return compressed?ImageDecoder.decode(path,params).then((result=>{promise.resolve({imgBmp:result.compressedData[0],cubesize:result.width})})).catch((e=>{promise.reject(e)})):ImageDecoder.decodeCubeLUT(path,params).then((result=>{promise.resolve({imgBmp:result.imgBmp,cubesize:result.cubesize})})),promise}(imgPath,params);texture.format=Texture.RGBAFormat,texture.image=imgBmp,texture.src=plainPath,texture.minFilter=texture.magFilter=Texture.LINEAR,texture.type=Texture.UNSIGNED_BYTE,texture.width=texture.height=texture.depth=cubesize,texture.dimensions={width:cubesize,height:cubesize,depth:cubesize},texture.generateMipmaps=!1,texture.onUpdate=function(){!params.preserveData&&imgBmp.close&&(imgBmp.close(),texture.image=null),texture.onUpdate=null}}))},this.getCubeTexture=function(paths,params={}){let parsed=(paths=function getCubePaths(url){if(Array.isArray(url))return url;let{compressed:compressed,compressedIdentifier:compressedIdentifier,path:path,requiresKtx:requiresKtx}=parseCompressed(url);if(requiresKtx)return[path];"ktx1"===compressed&&(void 0===_supportsKtx1&&(_supportsKtx1=!!(Renderer.extensions.s3tc||Renderer.extensions.etc1||Renderer.extensions.pvrtc||Renderer.extensions.astc)),_supportsKtx1||(compressed=!1));!compressed&&compressedIdentifier&&(url=url.replace(compressedIdentifier,""));let info=splitCubemapPath(url);if(compressed)return[`${info.prefix}${info.suffix}`];return getCubemapFacePaths(info)}(paths)).map(parseTexturePath);return getTexture(`cube:${parsed.map((({plainPath:plainPath})=>plainPath)).join("|")}`,params,(async texture=>{texture.cube=await Promise.all(parsed.map((({imgPath:imgPath,compressed:compressed})=>(texture.compressed=compressed,texture.format=imgPath.match(/\.jpe?g/)?Texture.RGBFormat:Texture.RGBAFormat,loadTextureSource(texture,imgPath,params))))),texture.compressed||1!==texture.cube.length||(texture.cube=[...Array(6).keys()].map((_=>texture.cube[0]))),texture.compressed&&1===texture.cube[0].sizes.length&&(texture.minFilter=Texture.LINEAR),texture.onUpdate=function(){params.preserveData||texture.cube.forEach(((imgBmp,i)=>{imgBmp.close&&(imgBmp.close(),texture.cube[i]=null)})),texture.onUpdate=null}}))},this.splitCubemapPath=splitCubemapPath,this.getCubemapFacePaths=getCubemapFacePaths,this.getLookupTexture=function(path){let texture=_this.getTexture(path);return texture.minFilter=texture.magFilter=Texture.NEAREST,texture.generateMipmaps=!1,texture},this.clearTextureCache=function(path,force){if(path){let key=parseTexturePath(path).plainPath,cached=_textures[key];cached?(cached.destroy(force),delete _textures[key],delete _restorable[key]):_restorable[key]&&delete _restorable[key],delete _dominantColors[key]}else{for(let key in _textures)_textures[key].destroy(force);_textures={},_dominantColors={}}},this.makeDataTexturePowerOf2=function(texture,itemSize){let[maxDimension,minDimension]=[texture.width,texture.height].sort();maxDimension=Math.ceilPowerOf2(maxDimension);const totalLength=maxDimension*maxDimension*itemSize,remainder=[];let j;for(let i=0;i<totalLength-texture.data.length;i++)j=i%texture.data.length,remainder.push(texture.data[j]);const totalData=new Float32Array(totalLength);totalData.set(texture.data),totalData.set(remainder,texture.data.length),texture.data=totalData,texture.width=texture.height=maxDimension,texture.powerOfTwoScale=minDimension/maxDimension},this.loadCurve=function(obj){"string"==typeof obj&&((obj=Assets.JSON[obj]).curves=obj.curves[0]);let data=obj.curves,points=[];for(let j=0;j<data.length;j+=3)points.push(new Vector3(data[j+0],data[j+1],data[j+2]));if("undefined"==typeof CatmullRomCurve)throw"loadCurve requires curve3d module";return new CatmullRomCurve(points)},this.getEmptyTexture=function(){return _emptyTexture||(_emptyTexture=new Texture),_emptyTexture},this.getRepeatTexture=function(src,scale){let texture=_this.getTexture(src,scale);return texture.promise.then((_=>{Math.isPowerOf2(texture.dimensions.width,texture.dimensions.height)||console.warn(`getRepeatTexture :: ${src} not power of two!`)})),texture.wrapS=texture.wrapT=Texture.REPEAT,texture},this.findTexturesByPath=function(path){let array=[];for(let key in _textures)key.includes(path)&&array.push(_textures[key]);return array},this.getHeightFromCamera=function(camera,dist){camera=camera.camera||camera,dist||(dist=camera.position.length());let fov=camera.fov;return 2*dist*Math.tan(.5*Math.radians(fov))},this.getWidthFromCamera=function(camera,dist){camera=camera.camera||camera;return _this.getHeightFromCamera(camera,dist)*camera.aspect},this.getPositionFromCameraSize=function(camera,size){camera=camera.camera||camera;let fov=Math.radians(camera.fov);return Math.abs(size/Math.sin(fov/2))},this.loadEngineOnThread=function(thread){["Base3D","CameraBase3D","Mesh","OrthographicCamera","PerspectiveCamera","Geometry","GeometryAttribute","Points","Scene","BoxGeometry","CylinderGeometry","PlaneGeometry","PolyhedronGeometry","IcosahedronGeometry","SphereGeometry","Box2","Box3","Face3","Color","ColorLAB","ColorHSL","Cylindrical","Euler","Frustum","Line3","Matrix3","Matrix4","Plane","Quaternion","Ray","Sphere","Spherical","Triangle","Vector2","Vector3","Vector4","RayManager","Vector3D","Group"].forEach((name=>{thread.importES6Class(name)})),thread.importCode(`Class(${zUtils3D.constructor.toString()}, 'static')`)},this.billboard=function(mesh,camera=World.CAMERA){_q||(_q=new Quaternion),_q.copy(camera.quaternion),mesh.customRotation&&mesh.quaternion.multiply(mesh.customRotation),mesh._parent&&_q.premultiply(mesh._parent.getWorldQuaternion().inverse()),mesh.quaternion.copy(_q)},this.billboardYAxis=function(mesh,camera=World.CAMERA){_q||(_q=new Quaternion),_q.copy(camera.quaternion);let angle=Math.atan2(_q.y,_q.w)+Math.PI;angle=-angle,_q.set(0,Math.sin(angle),0,Math.cos(angle)),mesh.customRotation&&mesh.quaternion.multiply(mesh.customRotation),mesh._parent&&_q.premultiply(mesh._parent.getWorldQuaternion().inverse()),mesh.quaternion.copy(_q)},this.positionInFrontOfCamera=function(object,distance,alpha=1,camera=World.CAMERA){_v3||(_v3=new Vector3),_v3b||(_v3b=new Vector3),_m4||(_m4=new Matrix4),_q||(_q=new Quaternion);let cameraPosition=_v3b,cameraQuaternion=_q;camera.updateMatrixWorld(),camera.matrixWorld.decompose(cameraPosition,cameraQuaternion,_v3),_v3.set(0,0,-distance).applyQuaternion(cameraQuaternion).add(cameraPosition),_m4.lookAt(cameraPosition,_v3,object.up),_q.setFromRotationMatrix(_m4),object.position.lerp(_v3,alpha),object.quaternion.slerp(_q,alpha)},this.getSignedQuaternionAngleToPlane=function(quaternion,direction,planeNormal,axis){_v3c||(_v3c=new Vector3);let vector=_v3c.copy(direction).applyQuaternion(quaternion);return _this.getSignedAngleToPlane(vector,planeNormal,axis)},this.getSignedAngleToPlane=function(vector,planeNormal,axis){_v3||(_v3=new Vector3),_v3b||(_v3b=new Vector3);let projected=_v3.copy(vector).projectOnPlane(planeNormal).normalize();if(0===projected.length())return Math.PI/2;axis?vector=_v3b.copy(vector).projectOnPlane(axis).normalize():axis=_v3b.crossVectors(projected,planeNormal);let dot=vector.dot(projected),det=axis.dot(projected.cross(vector));return Math.atan2(det,dot)},this.getQuad=function(){let geom=new Geometry,position=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),uv=new Float32Array([0,0,2,0,0,2]);return geom.addAttribute("position",new GeometryAttribute(position,3)),geom.addAttribute("uv",new GeometryAttribute(uv,2)),geom},this.findParentCamera=function(group){let parent=group.parent;for(;parent;){if(parent.nuke)return parent.nuke.camera;parent=parent.parent}return World.CAMERA},this.cameraIntrinsicsToObject=function(camera,object){object.fov=camera.fov,object.aspect=camera.aspect,object.near=camera.near,object.far=camera.far,object.p||(object.p=[],object.q=[],object.projectionMatrix=[]),camera.getWorldPosition().toArray(object.p),camera.getWorldQuaternion().toArray(object.q),camera.projectionMatrix.toArray(object.projectionMatrix),object.width=Stage.width,object.height=Stage.height},this.createFXLayer=function(name,nuke=World.NUKE,options){let layer=new FXLayer(nuke,options);return layer.name=name,layer},this.ensureAttributes=function(mesh){const vs=Shaders.getShader(mesh.shader.vsName+".vs"),attrib_regex=/attribute (\w+) (\w+);/g,attribs=mesh.geometry.attributes,firstCount=attribs[Object.keys(attribs)[0]].count;let attrib;for(;null!==(attrib=attrib_regex.exec(vs));){const name=attrib[2];if(name&&!attribs[name]){const size=parseInt(attrib[1][attrib[1].length-1])||1;mesh.geometry.addAttribute(name,new GeometryAttribute(new Float32Array(size*firstCount),size)),mesh.geometry.needsUpdate=!0}}},this.findDominantColors=function(texOrImageOrPath,numColors=4){let path;if(path="string"==typeof texOrImageOrPath?texOrImageOrPath:texOrImageOrPath.src||texOrImageOrPath.path||texOrImageOrPath.image?.src||texOrImageOrPath.image?.path,!path)throw new Error("Couldn’t find image asset path");let{plainPath:plainPath}=parseTexturePath(path),colors=_dominantColors[plainPath];if(colors)if(colors.promise){if(colors.numColors>=numColors)return colors.promise}else if(colors.length>=numColors)return colors;return colors={promise:doFindDominantColors(texOrImageOrPath,numColors),numColors:numColors},_dominantColors[plainPath]=colors,(async()=>{try{let result=await colors.promise;_dominantColors[plainPath]===colors&&(_dominantColors[plainPath]=result,texOrImageOrPath.isTexture&&(texOrImageOrPath.dominantColors=result),_textures[plainPath]&&(_textures[plainPath].dominantColors=result))}catch(e){_dominantColors[plainPath]===colors&&delete _dominantColors[plainPath]}})(),colors.promise},this.renderToTexture3D=function(texture,shader){if(void 0===texture._renderTargets){let depth=texture.depth/4;texture._renderTargets=[];let offset=0;for(let i=0;i<depth;i++){offset=4*i;let renderTarget=new RenderTarget(texture.width,texture.height);renderTarget.texture=texture,renderTarget.indices=[offset,offset+1,offset+2,offset+3],texture._renderTargets.push(renderTarget)}let mesh=new Mesh(World.QUAD,shader);texture._meshFor3D=mesh}try{_v4||(_v4=new Vector4),texture._renderTargets.forEach((rt=>{shader.set("indices",_v4.set(...rt.indices)),World.RENDERER.renderSingle(texture._meshFor3D,World.CAMERA,rt)}))}catch(e){console.warn("the 3d texture can not be updated correctly, the shader requires the indices uniform to be declared")}},this.cloneTransform=function(object,target=new Base3D){if(!target||!target.position||!target.position.copy)throw new Error("Target of cloneTransform must be a Base3D.");let group=object.group||object;return target.position.copy(group.position),target.scale.copy(group.scale),target.quaternion.copy(group.quaternion),target},this.cloneUniforms=function(object,target={}){let shader=object.shader||object,uniforms=shader.uniforms||shader;if(uniforms&&!uniforms.group){let origin={};for(let key in uniforms){let value=uniforms[key].value,ignoreUIL=uniforms[key].ignoreUIL||null===value;!ignoreUIL&&value.clone&&(value=value.clone()),origin[key]={type:uniforms[key].type,value:value,ignoreUIL:ignoreUIL}}return Object.assign(target.shader||target,origin)}}}),"static"),window.WebGLRenderingContext&&function(){"use strict";var e={};function r(r,t){var i;e[r]=!0,void 0!==t&&(i=t,window.console&&window.console.error&&window.console.error(i))}var t=function e(r){var t=r.gl;this.ext=r,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(r.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var a=new e.VertexAttrib(t);this.attribs[i]=a}this.maxAttrib=0};(t.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var i=function(r){var t,i,a=this;this.gl=r,i=(t=r).getError,t.getError=function(){do{(r=i.apply(t))!=t.NO_ERROR&&(e[r]=!0)}while(r!=t.NO_ERROR);for(var r in e)if(e[r])return delete e[r],parseInt(r);return t.NO_ERROR};var n=this.original={getParameter:r.getParameter,enableVertexAttribArray:r.enableVertexAttribArray,disableVertexAttribArray:r.disableVertexAttribArray,bindBuffer:r.bindBuffer,getVertexAttrib:r.getVertexAttrib,vertexAttribPointer:r.vertexAttribPointer};r.getParameter=function(e){return e==a.VERTEX_ARRAY_BINDING_OES?a.currentVertexArrayObject==a.defaultVertexArrayObject?null:a.currentVertexArrayObject:n.getParameter.apply(this,arguments)},r.enableVertexAttribArray=function(e){var r=a.currentVertexArrayObject;return r.maxAttrib=Math.max(r.maxAttrib,e),r.attribs[e].enabled=!0,n.enableVertexAttribArray.apply(this,arguments)},r.disableVertexAttribArray=function(e){var r=a.currentVertexArrayObject;return r.maxAttrib=Math.max(r.maxAttrib,e),r.attribs[e].enabled=!1,n.disableVertexAttribArray.apply(this,arguments)},r.bindBuffer=function(e,t){switch(e){case r.ARRAY_BUFFER:a.currentArrayBuffer=t;break;case r.ELEMENT_ARRAY_BUFFER:a.currentVertexArrayObject.elementArrayBuffer=t}return n.bindBuffer.apply(this,arguments)},r.getVertexAttrib=function(e,t){var i=a.currentVertexArrayObject.attribs[e];switch(t){case r.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return i.buffer;case r.VERTEX_ATTRIB_ARRAY_ENABLED:return i.enabled;case r.VERTEX_ATTRIB_ARRAY_SIZE:return i.size;case r.VERTEX_ATTRIB_ARRAY_STRIDE:return i.stride;case r.VERTEX_ATTRIB_ARRAY_TYPE:return i.type;case r.VERTEX_ATTRIB_ARRAY_NORMALIZED:return i.normalized;default:return n.getVertexAttrib.apply(this,arguments)}},r.vertexAttribPointer=function(e,r,t,i,s,A){var o=a.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,e);var c=o.attribs[e];return c.buffer=a.currentArrayBuffer,c.size=r,c.type=t,c.normalized=i,c.stride=s,c.offset=A,c.recache(),n.vertexAttribPointer.apply(this,arguments)},r.instrumentExtension&&r.instrumentExtension(this,"OES_vertex_array_object"),r.canvas.addEventListener("webglcontextrestored",(function(){window.console&&window.console.log&&window.console.log("OESVertexArrayObject emulation library context restored"),a.reset_()}),!0),this.reset_()};i.prototype.VERTEX_ARRAY_BINDING_OES=34229,i.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var r=this.gl;this.maxVertexAttribs=r.getParameter(r.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new t(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},i.prototype.createVertexArrayOES=function(){var e=new t(this);return this.vertexArrayObjects.push(e),e},i.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},i.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof t&&e.hasBeenBound&&e.ext==this)},i.prototype.bindVertexArrayOES=function(e){var t=this.gl;if(!e||e.isAlive){var i=this.original,a=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var n=this.currentVertexArrayObject;if(a!=n){a&&n.elementArrayBuffer==a.elementArrayBuffer||i.bindBuffer.call(t,t.ELEMENT_ARRAY_BUFFER,n.elementArrayBuffer);for(var s=this.currentArrayBuffer,A=Math.max(a?a.maxAttrib:0,n.maxAttrib),o=0;o<=A;o++){var c=n.attribs[o],b=a?a.attribs[o]:null;if(a&&c.enabled==b.enabled||(c.enabled?i.enableVertexAttribArray.call(t,o):i.disableVertexAttribArray.call(t,o)),c.enabled){var u=!1;a&&c.buffer==b.buffer||(s!=c.buffer&&(i.bindBuffer.call(t,t.ARRAY_BUFFER,c.buffer),s=c.buffer),u=!0),(u||c.cached!=b.cached)&&i.vertexAttribPointer.call(t,o,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!=s&&i.bindBuffer.call(t,t.ARRAY_BUFFER,this.currentArrayBuffer)}}else r(t.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},function(){var e=WebGLRenderingContext.prototype.getSupportedExtensions;WebGLRenderingContext.prototype.getSupportedExtensions=function(){var r=e.call(this)||[];return r.indexOf("OES_vertex_array_object")<0&&r.push("OES_vertex_array_object"),r};var r=WebGLRenderingContext.prototype.getExtension;WebGLRenderingContext.prototype.getExtension=function(e){return r.call(this,e)||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new i(this)),this.__OESVertexArrayObject))}}()}(),Class((function DracoThread(){let decoderConfig,decoderPending;function onError(opts){opts.message.preloading&&console.warn(opts.er);let plane=new PlaneGeometry(1,1).toNonIndexed(),buff=[],data={};for(let key in plane.attributes)data[key]=plane.attributes[key].array,buff.push(data[key].buffer);computeBounding(data),opts?.resolve(data,opts.id,buff)}function decodeGeometry(draco,decoder,decoderBuffer,taskConfig){const attributeIDs=taskConfig.attributeIDs,attributeTypes=taskConfig.attributeTypes;let dracoGeometry,decodingStatus;const geometryType=decoder.GetEncodedGeometryType(decoderBuffer);if(geometryType===draco.TRIANGULAR_MESH)dracoGeometry=new draco.Mesh,decodingStatus=decoder.DecodeBufferToMesh(decoderBuffer,dracoGeometry);else{if(geometryType!==draco.POINT_CLOUD)throw new Error("DRACOLoader: Unexpected geometry type.");dracoGeometry=new draco.PointCloud,decodingStatus=decoder.DecodeBufferToPointCloud(decoderBuffer,dracoGeometry)}if(!decodingStatus.ok()||0===dracoGeometry.ptr)throw new Error("DRACOLoader: Decoding failed: "+decodingStatus.error_msg());const geometry={index:null,attributes:[]};for(const attributeName in attributeIDs){const attributeType=attributeTypes[attributeName];let attribute,attributeID;if(taskConfig.useUniqueIDs)attributeID=attributeIDs[attributeName],attribute=decoder.GetAttributeByUniqueId(dracoGeometry,attributeID);else{if(attributeID=decoder.GetAttributeId(dracoGeometry,draco[attributeIDs[attributeName]]),-1===attributeID)continue;attribute=decoder.GetAttribute(dracoGeometry,attributeID)}geometry.attributes.push(decodeAttribute(draco,decoder,dracoGeometry,attributeName,attributeType,attribute))}return geometryType===draco.TRIANGULAR_MESH&&(geometry.index=decodeIndex(draco,decoder,dracoGeometry)),draco.destroy(dracoGeometry),geometry}function decodeIndex(draco,decoder,dracoGeometry){const numIndices=3*dracoGeometry.num_faces(),byteLength=4*numIndices,ptr=draco._malloc(byteLength);decoder.GetTrianglesUInt32Array(dracoGeometry,byteLength,ptr);const index=new Uint32Array(draco.HEAPF32.buffer,ptr,numIndices).slice();return draco._free(ptr),{array:index,itemSize:1}}function decodeAttribute(draco,decoder,dracoGeometry,attributeName,attributeType,attribute){const numComponents=attribute.num_components(),numValues=dracoGeometry.num_points()*numComponents,byteLength=numValues*attributeType.BYTES_PER_ELEMENT,dataType=getDracoDataType(draco,attributeType),ptr=draco._malloc(byteLength);decoder.GetAttributeDataArrayForAllPoints(dracoGeometry,attribute,dataType,byteLength,ptr);const array=new attributeType(draco.HEAPF32.buffer,ptr,numValues).slice();return draco._free(ptr),{name:attributeName,array:array,itemSize:numComponents}}function getDracoDataType(draco,attributeType){switch(attributeType){case Float32Array:return draco.DT_FLOAT32;case Int8Array:return draco.DT_INT8;case Int16Array:return draco.DT_INT16;case Int32Array:return draco.DT_INT32;case Uint8Array:return draco.DT_UINT8;case Uint16Array:return draco.DT_UINT16;case Uint32Array:return draco.DT_UINT32}}this.loadDraco=function(e,id){const message=e;switch(message.type){case"init":decoderConfig=message.decoderConfig,decoderPending=new Promise((function(pendingResolve){decoderConfig.onModuleLoaded=function(draco){pendingResolve({draco:draco}),resolve({},id)},DracoDecoderModule(decoderConfig)}));break;case"decode_buffer_gltf":((dracoBuffer,dataAttrib)=>{const buffer=dracoBuffer,attributeIDs={},attributeTypes={},TYPE_ARRAY={5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array,"image/jpeg":Uint8Array,"image/png":Uint8Array};dataAttrib.forEach((att=>{const name=att.name;attributeIDs[name]=att.id,attributeTypes[name]=TYPE_ARRAY[att.type]}));const taskConfig={attributeIDs:attributeIDs,attributeTypes:attributeTypes,useUniqueIDs:!0};decoderPending.then((module=>{const draco=module.draco,decoder=new draco.Decoder,decoderBuffer=new draco.DecoderBuffer;decoderBuffer.Init(new Int8Array(buffer),buffer.byteLength);try{const geometry=decodeGeometry(draco,decoder,decoderBuffer,taskConfig),buffers=geometry.attributes.map((attr=>attr.array.buffer));geometry.index&&buffers.push(geometry.index.array.buffer);const response={};geometry.index&&(response.index=geometry.index.array),geometry.attributes.forEach((att=>{response[att.name]=att.array,response[`${att.name}ItemSize`]=att.itemSize})),response.position&&computeBounding(response),resolve(response,id,buffers)}catch(error){onError({message:message,er:`Parsing error on Draco file ${message.path}.`,resolve:resolve,id:id})}finally{draco.destroy(decoderBuffer),draco.destroy(decoder)}}))})(message.buffer,message.dataAttrib);break;case"decode":fetch(message.path).then((res=>{if(!res.ok)throw new Error;return res.arrayBuffer()})).then((dracoBuffer=>{const decoder=new TextDecoder,jsonSize=parseInt(decoder.decode(dracoBuffer.slice(0,10))),jsonData=JSON.parse(decoder.decode(dracoBuffer.slice(10,10+jsonSize))),buffer=dracoBuffer.slice(10+jsonSize),TYPED_ARRAYS=Object.values(Geometry.TYPED_ARRAYS),attributeIDs={},attributeTypes={};jsonData.attributes.forEach(((att,i)=>{const name=att[0];attributeIDs[name]=i,attributeTypes[name]=TYPED_ARRAYS[att[1]]}));const taskConfig={attributeIDs:attributeIDs,attributeTypes:attributeTypes,useUniqueIDs:!0},isMesh=0===jsonData.type;decoderPending.then((module=>{const draco=module.draco,decoder=new draco.Decoder,decoderBuffer=new draco.DecoderBuffer;decoderBuffer.Init(new Int8Array(buffer),buffer.byteLength);try{const geometry=decodeGeometry(draco,decoder,decoderBuffer,taskConfig),buffers=geometry.attributes.map((attr=>attr.array.buffer));isMesh&&geometry.index&&buffers.push(geometry.index.array.buffer);const response={_type:"BufferGeometry",userData:jsonData.userData||{}};response.userData.dracoType=jsonData.type,isMesh&&geometry.index&&(response.index=geometry.index.array),geometry.attributes.forEach((att=>{response[att.name]=att.array,response[`${att.name}ItemSize`]=att.itemSize})),isMesh&&response.position&&computeBounding(response),resolve(response,id,buffers)}catch(error){onError({message:message,er:`Parsing error on Draco file ${message.path}.`,resolve:resolve,id:id})}finally{draco.destroy(decoderBuffer),draco.destroy(decoder)}}))})).catch((()=>{onError({message:message,er:`Network error: Draco file (${message.path}) could not be loaded.`,resolve:resolve,id:id})}))}},this.decodeGeometry=decodeGeometry,this.decodeIndex=decodeIndex,this.decodeAttribute=decodeAttribute,this.getDracoDataType=getDracoDataType,this.onError=onError}),"static"),Class((function GLTFLoader(){Inherit(this,Component);const _this=this,TYPE_ARRAY={5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array,"image/jpeg":Uint8Array,"image/png":Uint8Array},TYPE_SIZE={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ATTRIBUTES={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"};let _sceneLayout,_path,_id;new Matrix4;_this.textures=null;let _dracoLoaded=null;_this.parse=async function(path,sceneLayout){let name=(path=Assets.getPath(path)).split("/");name=name[name.length-1],console.log(name),name=name.split(".")[0],_id=name,_path=path,sceneLayout&&(_sceneLayout=_this.initClass(SceneLayout,name));let json,binary,nodes=null;if(String(path).indexOf(".glb")>0){let data=await _this.loadBinary(_path);json=data.json,binary=data.binary}String(path).indexOf(".gltf")>0&&(json=await fetch(path).then((res=>res.json())),binary=await Promise.all(json.buffers.map((buffer=>{const uri=this.resolveURI(buffer.uri);return fetch(uri).then((res=>res.arrayBuffer()))}))),binary=binary[0]);const desc=json,buffers=binary;let dracoRequired=!1;desc.extensionsRequired&&desc.extensionsRequired.forEach((extension=>{"KHR_draco_mesh_compression"===extension&&(dracoRequired=!0)})),dracoRequired&&(!function loadDracoLib(){_dracoLoaded=Promise.create();const useJS="object"!=typeof WebAssembly,libFolder="~assets/js/lib/_draco/",libs=useJS?[`${libFolder}draco_decoder.js`]:[`${libFolder}draco_wasm_wrapper.js`,`${libFolder}draco_decoder.wasm`];Promise.all(libs.map(((url,i)=>fetch(Assets.getPath(url)).then((res=>{if(!res.ok)throw new Error;return 0===i?res.text():res.arrayBuffer()}))))).then((async loadedLibs=>{Thread.upload(["function loadDraco() {","/* draco decoder */",loadedLibs[0],"","/* worker */","","let decoderConfig, decoderPending;","",DracoThread.onError.toString(),DracoThread.decodeGeometry.toString(),DracoThread.decodeIndex.toString(),DracoThread.decodeAttribute.toString(),DracoThread.getDracoDataType.toString(),"","return "+DracoThread.loadDraco.toString(),"};"].join("\n"));const pool=Thread.shared(!0).array,decoderConfig=useJS?{}:{wasmBinary:loadedLibs[1]};pool.forEach((t=>t.importCode("self.loadDraco = loadDraco();"))),await Promise.all(pool.map((t=>t.loadDraco({type:"init",decoderConfig:decoderConfig})))),_dracoLoaded.resolve()})).catch((()=>{console.warn("Draco libs could not be loaded. Fallback to .json"),_dracoLoaded.reject()}))}(),await _dracoLoaded);const bufferViews=_this.parseBufferViews(desc,buffers),images=await _this.parseImages(desc,bufferViews),textures=await _this.parseTextures(desc,images);await Promise.all(textures).then((values=>{_this.textures=values}));const materials=await _this.parseMaterials(desc,textures);return meshes=await _this.parseMeshes(desc,bufferViews,materials),nodes=await _this.parseNodes(desc,meshes),nodes},this.loadBinary=async function(path){let json,binary,result=Promise.create();return fetch(path).then((res=>{if(!res.ok)throw new Error;return res.arrayBuffer()})).then((async gltfBuffer=>{const BINARY_EXTENSION_CHUNK_TYPES_JSON=1313821514,BINARY_EXTENSION_CHUNK_TYPES_BIN=5130562,headerView=new DataView(gltfBuffer,0,12),decoder=new TextDecoder;let header_magic=decoder.decode(gltfBuffer.slice(0,4)),header_version=headerView.getUint32(4,!0),header_length=headerView.getUint32(8,!0);if("glTF"!==header_magic)throw new Error("GLTFLoader: Unsupported glTF-Binary header.");if(header_version<2)throw new Error("GLTFLoader: Legacy binary file detected.");const chunkContentsLength=header_length-12,chunkView=new DataView(gltfBuffer,12);let chunkIndex=0,_content=null;for(;chunkIndex<chunkContentsLength;){const chunkLength=chunkView.getUint32(chunkIndex,!0);chunkIndex+=4;const chunkType=chunkView.getUint32(chunkIndex,!0);if(chunkIndex+=4,chunkType===BINARY_EXTENSION_CHUNK_TYPES_JSON){const contentArray=new Uint8Array(gltfBuffer,12+chunkIndex,chunkLength);_content=decoder.decode(contentArray)}else if(chunkType===BINARY_EXTENSION_CHUNK_TYPES_BIN){const byteOffset=12+chunkIndex;binary=gltfBuffer.slice(byteOffset,byteOffset+chunkLength)}chunkIndex+=chunkLength}if(null===_content)throw new Error("GLTFLoader: JSON content not found.");json=JSON.parse(_content),console.log(json),void 0===json.asset||json.asset.version[0]<2?onError&&onError(new Error("GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")):result.resolve()})),await result,{json:json,binary:binary}},this.parseBufferViews=function(desc,buffers){if(!desc.bufferViews)return null;const bufferViews=desc.bufferViews.map((o=>Object.assign({},o)));return desc.accessors.forEach((({bufferView:i,componentType:componentType})=>{i<bufferViews.length&&(bufferViews[i].componentType=componentType)})),bufferViews.forEach((({byteOffset:byteOffset=0,byteLength:byteLength,componentType:componentType},i)=>{bufferViews[i].data=buffers.slice(byteOffset,byteOffset+byteLength)})),bufferViews},this.parseMeshes=function(desc,bufferViews,materials){return desc.meshes?desc.meshes.map((({name:name,primitives:primitives},index1)=>{let shader=Utils3D.getTestShader();return shader.side=Shader.DOUBLE_SIDE,primitives=this.parsePrimitives(primitives,desc,bufferViews,materials).map((async({geometry:geometry,materialDefinition:materialDefinition},index2)=>{let setupShader=el=>{if(!materialDefinition)return;let shader=el.shader;materialDefinition.baseColorTexture&&materialDefinition.baseColorTexture.texture.then((res=>{shader.get("tMap")&&shader.set("tMap",res),shader.get("tBaseColor")&&shader.set("tBaseColor",res)})),materialDefinition.normalTexture&&materialDefinition.normalTexture.texture.then((res=>{shader.get("tNormal")&&shader.set("tNormal",res)})),materialDefinition.metallicRoughnessTexture&&materialDefinition.metallicRoughnessTexture.texture.then((res=>{shader.get("tMRO")&&shader.set("tMRO",res)}))};if(await geometry.ready,_sceneLayout){let naming=`${_id}_mesh_${index1}_${index2}`;name&&(naming=naming.concat(`_${name}`)),naming=naming.replace(/ /g,"_");let mesh=void 0!==_sceneLayout.exists(naming)?await _sceneLayout.getLayer(naming):null;if(mesh)mesh.geometry=geometry;else{let id=await _sceneLayout._createLayer(`${_id}_meshes`,!0);mesh=await _sceneLayout.getLayer(String(id)),mesh.geometry=geometry,_sceneLayout._rename(id,String(id),naming)}return setupShader(mesh),mesh}{let mesh=new Mesh(geometry,shader);return setupShader(mesh),mesh}})),primitives})):null},this.parsePrimitives=function(primitives,desc,bufferViews,materials){return primitives.map((({attributes:attributes,indices:indices,material:materialIndex,extensions:extensions})=>{let materialDefinition=null;void 0!==materialIndex&&(materialDefinition=materials[materialIndex]);let geometry=new Geometry;if(geometry.ready=Promise.create(),extensions&&extensions.KHR_draco_mesh_compression){const attribs=extensions.KHR_draco_mesh_compression.attributes;let dataAttrib=[];for(let attribute in attributes){let index=attributes[attribute],id=attribs[attribute],{componentType:componentType}=desc.accessors[index];dataAttrib.push({name:attribute,id:id,type:componentType})}const{data:data}=bufferViews[extensions.KHR_draco_mesh_compression.bufferView];Thread.shared().loadDraco({type:"decode_buffer_gltf",buffer:data,dataAttrib:dataAttrib}).then((res=>{for(let att in res){if(res[att].length>0&&"index"!==att){let attributeName=ATTRIBUTES[att],info=new GeometryAttribute(res[att],res[`${att}ItemSize`]);geometry.addAttribute(attributeName,info)}"index"===att&&(geometry.index=res[att])}geometry.ready.resolve()}))}else{for(let attr in attributes){let buffer=this.parseAccessor(attributes[attr],desc,bufferViews),data=new GeometryAttribute(buffer.data,buffer.size);geometry.addAttribute(ATTRIBUTES[attr],data)}if(void 0!==indices){let buffer=this.parseAccessor(indices,desc,bufferViews);geometry.index=buffer.data}geometry.ready.resolve()}return{geometry:geometry,materialDefinition:materialDefinition}}))},this.parseAccessor=function(index,desc,bufferViews,_bufferViewIndex=null){let{bufferView:bufferViewIndex,byteOffset:byteOffset=0,componentType:componentType,normalized:normalized=!1,count:count,type:type,min:min,max:max}=desc.accessors[index];null!==_bufferViewIndex&&(bufferViewIndex=_bufferViewIndex);const{data:data,buffer:buffer,byteStride:byteStride=0}=bufferViews[bufferViewIndex],size=TYPE_SIZE[type];return{data:new(0,TYPE_ARRAY[componentType])(data,byteOffset),size:size,type:componentType,normalized:normalized,buffer:buffer,stride:byteStride,offset:byteOffset,count:count,min:min,max:max}},this.parseNodes=async function(desc,meshes){if(!desc.nodes)return null;let nodes=desc.nodes.map((async({matrix:matrix,mesh:meshIndex,rotation:rotation,scale:scale,translation:translation,name:name},index)=>{let node=new Group;if(_sceneLayout){let naming=`${_id}_hierarchy_${index}`;name&&(naming=naming.concat(`_${name}`)),naming=naming.replace(/ /g,"_");let exists=_sceneLayout.exists(naming);if(node=exists?await _sceneLayout.getLayer(naming):null,!node){let ref=await _sceneLayout._createLayer(`${_id}_hierarchy`,!0);node=await _sceneLayout.getLayer(String(ref)),_sceneLayout._rename(ref,String(ref),naming)}node.geometry=new PlaneGeometry(0,0,1,1),node._parent=null}if(name&&(node.name=name),matrix){let m=(new Matrix4).set(...matrix);m=m.transpose(),node.matrix.copy(m),node.matrix.decompose(node.position,node.quaternion,node.scale)}else(rotation||scale||translation)&&(rotation&&node.quaternion.set(...rotation),scale&&node.scale.set(...scale),translation&&node.position.set(...translation),node.updateMatrix());return void 0!==meshIndex&&meshes[meshIndex].forEach((async mesh=>{mesh.then((res=>{node.add(res)}))})),node}));return await Promise.all(nodes).then((values=>{nodes=values})),desc.nodes.forEach((({children:children=[]},i)=>{children.forEach((childIndex=>{nodes[i].add(nodes[childIndex])}))})),nodes.filter((node=>{if(null==node._parent)return node}))},this.parseTextures=function(desc,images){return desc.textures?desc.textures.map((textureInfo=>_this.createTexture(desc,images,textureInfo))):null},this.createTexture=async function(desc,images,{sampler:samplerIndex,source:sourceIndex,name:name,extensions:extensions,extras:extras}){if(void 0===sourceIndex&&extensions)return void console.warn("extensions required to load texture");const image=images[sourceIndex];if(image.texture)return image.texture;const sampler=void 0!==samplerIndex?desc.samplers[samplerIndex]:null;let options={};sampler&&["magFilter","minFilter","wrapS","wrapT"].forEach((prop=>{sampler[prop]&&(options[prop]=sampler[prop])})),await image.ready;const texture=new Texture(image);return texture.name=name,texture.flipY=!1,texture.wrapS=texture.wrapT=Texture.REPEAT,image.texture=texture,texture},this.parseImages=async function(desc,bufferViews){return desc.images?await Promise.all(desc.images.map((async({uri:uri,bufferView:bufferViewIndex,mimeType:mimeType,name:name})=>{if("image/ktx2"===mimeType)return console.warn("image type is ktx2, update the loader to support this type"),null;const image=new Image;if(image.name=name,uri)image.src=this.resolveURI(uri);else if(void 0!==bufferViewIndex){const{data:data}=bufferViews[bufferViewIndex],blob=new Blob([data],{type:mimeType});image.src=URL.createObjectURL(blob)}return image.ready=new Promise((res=>{image.onload=()=>res()})),image}))):null},this.resolveURI=function(uri){let dir=_path.split("/");return dir.pop(),dir=dir.join("/"),"string"!=typeof uri||""===uri?"":(/^https?:\/\//i.test(dir)&&/^\//.test(uri)&&(dir=dir.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(uri)||/^data:.*,.*$/i.test(uri)||/^blob:.*$/i.test(uri)?uri:dir+"/"+uri)},this.parseMaterials=function(desc,textures){return desc.materials?desc.materials.map((({name:name,extensions:extensions,extras:extras,pbrMetallicRoughness:pbrMetallicRoughness={},normalTexture:normalTexture,occlusionTexture:occlusionTexture,emissiveTexture:emissiveTexture,emissiveFactor:emissiveFactor=[0,0,0],alphaMode:alphaMode="OPAQUE",alphaCutoff:alphaCutoff=.5,doubleSided:doubleSided=!1})=>{const{baseColorFactor:baseColorFactor=[1,1,1,1],baseColorTexture:baseColorTexture,metallicFactor:metallicFactor=1,roughnessFactor:roughnessFactor=1,metallicRoughnessTexture:metallicRoughnessTexture}=pbrMetallicRoughness;return baseColorTexture&&(baseColorTexture.texture=textures[baseColorTexture.index]),normalTexture&&(normalTexture.texture=textures[normalTexture.index]),metallicRoughnessTexture&&(metallicRoughnessTexture.texture=textures[metallicRoughnessTexture.index]),occlusionTexture&&(occlusionTexture.texture=textures[occlusionTexture.index]),emissiveTexture&&(emissiveTexture.texture=textures[emissiveTexture.index]),{name:name,extensions:extensions,extras:extras,baseColorFactor:baseColorFactor,baseColorTexture:baseColorTexture,metallicFactor:metallicFactor,roughnessFactor:roughnessFactor,metallicRoughnessTexture:metallicRoughnessTexture,normalTexture:normalTexture,occlusionTexture:occlusionTexture,emissiveTexture:emissiveTexture,emissiveFactor:emissiveFactor,alphaMode:alphaMode,alphaCutoff:alphaCutoff,doubleSided:doubleSided}})):null}})),Class((function GeomThread(){Inherit(this,Component);const _this=this;var _cache={},_cacheWait={},_receive={},_dracoLoaded=null;function computeBounding(data){let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(data.position,3)),data.index&&geom.setIndex(data.index),geom.computeBoundingBox(),geom.computeBoundingSphere(),data.boundingBox=geom.boundingBox,data.boundingSphere=geom.boundingSphere}function loadGeometry(e,id){get(e.path).then((data=>{let buffers=[];if(data.data&&data.metadata?.type){let bufferList={_type:data.metadata.type},jsonData=data.data;jsonData.index&&(bufferList.index=new Geometry.TYPED_ARRAYS[jsonData.index.type](jsonData.index.array),buffers.push(bufferList.index.buffer));for(let key in jsonData.attributes){let attrib=jsonData.attributes[key];bufferList[key]=new Geometry.TYPED_ARRAYS[attrib.type](attrib.array),bufferList[`${key}ItemSize`]=attrib.itemSize,buffers.push(bufferList[key].buffer)}bufferList.position&&computeBounding(bufferList),data.userData&&(bufferList.userData=data.userData),resolve(bufferList,id,buffers)}else{for(let key in data)if("bones"!=key)if(Array.isArray(data[key])){const ArrayType="index"==key?Geometry.arrayNeedsUint32(data[key])?Uint32Array:Uint16Array:Float32Array;data[key]=new ArrayType(data[key]),buffers.push(data[key].buffer)}else data[key].length>0&&buffers.push(data[key].buffer);computeBounding(data),e.custom&&self[e.custom](data),resolve(data,id,buffers)}})).catch((er=>{e.preloading||console.error(er);let plane=new PlaneGeometry(1,1).toNonIndexed(),buffers=[],data={};for(let key in plane.attributes)data[key]=plane.attributes[key].array,buffers.push(data[key].buffer);computeBounding(data),resolve(data,id,buffers)}))}function geom_useFn(e){Global.FNS||(Global.FNS=[]),Global.FNS.push(e.name)}function loadDracoLib(){_dracoLoaded=Promise.create();const useJS="object"!=typeof WebAssembly,libFolder="~assets/js/lib/_draco/",libs=useJS?[`${libFolder}draco_decoder.js`]:[`${libFolder}draco_wasm_wrapper.js`,`${libFolder}draco_decoder.wasm`];Promise.all(libs.map(((url,i)=>fetch(Assets.getPath(url)).then((res=>{if(!res.ok)throw new Error;return 0===i?res.text():res.arrayBuffer()}))))).then((async loadedLibs=>{Thread.upload(["function loadDraco() {","/* draco decoder */",loadedLibs[0],"","/* worker */","","let decoderConfig, decoderPending;","",DracoThread.onError.toString(),DracoThread.decodeGeometry.toString(),DracoThread.decodeIndex.toString(),DracoThread.decodeAttribute.toString(),DracoThread.getDracoDataType.toString(),"","return "+DracoThread.loadDraco.toString(),"};"].join("\n"));const pool=Thread.shared(!0).array,decoderConfig=useJS?{}:{wasmBinary:loadedLibs[1]};pool.forEach((t=>t.importCode("self.loadDraco = loadDraco();"))),await Promise.all(pool.map((t=>t.loadDraco({type:"init",decoderConfig:decoderConfig})))),_dracoLoaded.resolve()})).catch((()=>{console.warn("Draco libs could not be loaded. Fallback to .json"),_dracoLoaded.reject()}))}function parseGeometry(data,path,custom){let geometry;if(custom&&_receive[custom])geometry=_receive[custom](data);else{let geom=new Geometry;if(data._type){for(key in data)if("_type"!==key&&!key.endsWith("ItemSize"))switch(key){case"userData":geom.userData=data.userData;break;case"boundingBox":geom.boundingBox=new Box3((new Vector3).set(data.boundingBox.min.x,data.boundingBox.min.y,data.boundingBox.min.z),(new Vector3).set(data.boundingBox.max.x,data.boundingBox.max.y,data.boundingBox.max.z));break;case"boundingSphere":geom.boundingSphere=new Sphere((new Vector3).set(data.boundingSphere.center.x,data.boundingSphere.center.y,data.boundingSphere.center.z),data.boundingSphere.radius);break;case"index":geom.setIndex(data.index);break;default:data[`${key}ItemSize`]&&geom.addAttribute(key,new GeometryAttribute(data[key],data[`${key}ItemSize`]))}}else geom.addAttribute("position",new GeometryAttribute(data.position,3)),geom.addAttribute("normal",new GeometryAttribute(data.normal||data.position.length,3)),geom.addAttribute("uv",new GeometryAttribute(data.uv||data.position.length/3*2,2)),data.uv2&&geom.addAttribute("uv2",new GeometryAttribute(data.uv2,2)),data.vdata&&geom.addAttribute("vdata",new GeometryAttribute(data.vdata,3)),data.index&&geom.setIndex(data.index),data.skinIndex&&geom.addAttribute("skinIndex",new GeometryAttribute(data.skinIndex,4)),data.skinWeight&&geom.addAttribute("skinWeight",new GeometryAttribute(data.skinWeight,4)),(data.rig||data.bones)&&(geom.bones=(data.rig?data.rig.bones:data.bones).slice(0)),geom.boundingBox=new Box3((new Vector3).set(data.boundingBox.min.x,data.boundingBox.min.y,data.boundingBox.min.z),(new Vector3).set(data.boundingBox.max.x,data.boundingBox.max.y,data.boundingBox.max.z)),geom.boundingSphere=new Sphere((new Vector3).set(data.boundingSphere.center.x,data.boundingSphere.center.y,data.boundingSphere.center.z),data.boundingSphere.radius);geometry=geom,geom._src=path}if(!geometry.attributes.position)throw`GeomThread :: Malformed geometry is missing position data. ${path}`;_this.caching&&(_cache[path]=geometry),_cacheWait[path]?.resolve(geometry)}this.caching=!0,async function(){await Hydra.ready(),Thread.upload(loadGeometry,geom_useFn,computeBounding)}(),this.loadGeometry=function(path,custom,preloading){if(!Device.graphics.gpu)return Promise.resolve(new PlaneGeometry(1,1));if(_cache[path])return Promise.resolve(_cache[path]);let cacheBust=!1;path.includes("?")&&(path=path.split("?")[0],cacheBust="?"+Utils.timestamp());let isBinary=path.endsWith(".bin");if(path.includes("http")||(Hydra.LOCAL||(cacheBust=!1),path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),cacheBust&&(path+=cacheBust)),path=Thread.absolutePath(Assets.getPath(path)),_this.caching){if(_cacheWait[path])return _cacheWait[path];_cacheWait[path]=Promise.create()}return isBinary?(_dracoLoaded||loadDracoLib(),_dracoLoaded.then((()=>{Thread.shared().loadDraco({type:"decode",path:path,custom:custom,preloading:preloading}).then((data=>parseGeometry(data,path,custom)))})).catch((()=>{path=path.replace(".bin",".json"),Thread.shared().loadGeometry({path:path,custom:custom,preloading:preloading}).then((data=>parseGeometry(data,path,custom)))}))):Thread.shared().loadGeometry({path:path,custom:custom,preloading:preloading}).then((data=>parseGeometry(data,path,custom))),_cacheWait[path]},this.removeFromCache=function(path){path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),path=Thread.absolutePath(Assets.getPath(path)),delete _cache[path],delete _cacheWait[path]},this.loadDracoLib=function(){return _dracoLoaded||loadDracoLib(),_dracoLoaded},this.loadSkinnedGeometry=function(path,custom,preloading){return this.loadGeometry(path,custom,preloading)},this.customFunction=function(fn,receive){let name=Thread.upload(fn);name=name[0],t.geom_useFn({name:name}),_receive[name]=receive}}),"static"),Class((function InstanceMesh(_mesh,_shader,_group,_input){Inherit(this,Component);const _this=this;var _config,_frustumCulled=!1,_blankShader,_instanceGroup;function initHotReload(){_mesh.cacheGeom=_mesh.geometry.clone(),_this.events.sub(SceneLayout.HOTLOAD_GEOMETRY,(({file:file})=>{_mesh.geometry?._src?.includes(file)&&GeomThread.loadGeometry(file).then((_=>{createInstanceMesh(_config.getFilePath("json"))})),file.includes(_config.getFilePath("json"))&&createInstanceMesh(_config.getFilePath("json"))}))}async function createInstanceMesh(file){if(!file)return;let isBinary=file.includes(".bin"),data;file.includes("assets/geometry")||(file=`assets/geometry/${file}`),isBinary||file.includes(".json")||(file+=".json"),_mesh.cacheGeom&&(file+="?"+Utils.timestamp()),_mesh.instanceMesh&&(_mesh.instanceMesh.visible=!1),isBinary?(await GeomThread.loadDracoLib(),data=await Thread.shared().loadDraco({type:"decode",path:Thread.absolutePath(Assets.getPath(file))})):data=await Thread.shared().parseInstanceMesh({url:Thread.absolutePath(Assets.getPath(file))});let isStatic=!_config.get("dynamic");if(_this.batch=_this.initClass(MeshBatch,{visibilityCheck:!isStatic}),_mesh._parent.add(_this.batch.group),_this.batch.static=isStatic,_this.batch.frustumCulled=_frustumCulled,_this.batch.onMeshCreated=mesh=>{let geom=mesh.geometry;for(let key in data){if(["_type","userData","offset","orientation","scale"].includes(key))continue;let itemSize=data[`${key}ItemSize`];"number"==typeof itemSize&&geom.addAttribute(key,new GeometryAttribute(data[key],itemSize,1,_this.batch.useDynamic))}let instances=[];for(let i=0;i<count;i++)instances.push(i);geom.addAttribute("instance",new GeometryAttribute(new Float32Array(instances),1,1)),_mesh.instanceMesh=mesh,mesh.position.copy(_mesh.position),mesh.quaternion.copy(_mesh.quaternion),mesh.scale.copy(_mesh.scale),mesh.geometry.maxInstancedCount=_this.maxInstancedCount*_this.instanceMultiplier,_mesh.instanceMeshReady.resolve()},!data.offsetItemSize)return;let count=data.offset.length/data.offsetItemSize;for(let i=0;i<count;++i){let m=new Mesh(_mesh.cacheGeom||_mesh.geometry,_mesh.shader);m.position.fromArray(data.offset,i*data.offsetItemSize),data.orientation&&m.quaternion.fromArray(data.orientation,i*data.orientationItemSize),data.scale&&m.scale.fromArray(data.scale,i*data.scaleItemSize),m.renderOrder=_mesh.renderOrder,m.castShadow=_mesh.castShadow,m.frustumCulled=!1,m.renderOrder=_mesh.renderOrder,m.castShadow=_mesh.castShadow,m.receiveLight=_mesh.receiveLight,m.shader.neverRender=!1,_this.batch.add(m),m.shader.neverRender=!1,m.shader=_blankShader,_instanceGroup.add(m)}let test=_config.get("test");test&&(_this.instanceMultiplier=eval(test)),void 0===_this.maxInstancedCount&&(_this.maxInstancedCount=count),isStatic&&(await _this.batch.staticReady(),_instanceGroup.matrixAutoUpdate=!1)}function addHandlers(){_this.events.sub(MeshUIL.UPDATE,handleMeshUpdate),Hydra.LOCAL&&UIL.global&&(_this.events.sub(UILGraphNode.TOGGLE_VISIBILITY,handleToggleVisibility),_this.events.sub(InputUIL.UPDATE,handleUILUpdate))}function handleMeshUpdate({key:key,prefix:prefix,val:val}){if(_mesh.instanceMesh&&(prefix=prefix.substring(5))===_mesh.prefix)switch(key){case"position":_mesh.instanceMesh.position.fromArray(val);break;case"rotation":_mesh.instanceMesh.rotation.fromArray(val);break;case"scale":_mesh.instanceMesh.scale.fromArray(val)}}function handleToggleVisibility({id:id,visible:visible}){_this.batch&&id===_mesh.uilGroup.id&&(_this.batch.group.visible=visible)}function handleUILUpdate(e){_this.batch&&e.group===_input&&"visible"===e.key&&(_this.batch.group.visible=_input.get("visible"))}this.instanceMultiplier=1,(_config=InputUIL.create("im_"+_input.prefix,_group)).addFile("json",{relative:"assets/geometry"}),_config.add("test"),_config.addToggle("dynamic",!1),_config.setLabel("Instance"),!1!==_input.get("visible")&&(_this._config=_config,(_blankShader=Utils3D.getTestShader()).visible=!1,(_instanceGroup=new Group).doNotProject=!0,_mesh._parent.add(_instanceGroup),_mesh._parent.remove(_mesh),_mesh.visible=!1,_mesh.instanceMeshReady=Promise.create(),_mesh.instanceMeshBeforeReady=Promise.create(),createInstanceMesh(_config.getFilePath("json")),_config.onUpdate=_=>{createInstanceMesh(_config.getFilePath("json"))},addHandlers(),Hydra.LOCAL&&initHotReload()),this.applyToShader=function(shader){_this.batch.applyToShader(shader)},this.get("frustumCulled",(()=>_this.batch?_this.batch.frustumCulled:_frustumCulled)),this.set("frustumCulled",(async b=>{_this.batch&&(_this.batch.frustumCulled=b),_frustumCulled=b}))}),(_=>{Thread.upload((function parseInstanceMesh({url:url},id){get(url).then((data=>{let bufferList={},buffers=[];if(data.data&&data.metadata?.type){bufferList._type=data.metadata.type;let jsonData=data.data;for(let key in jsonData.attributes){let attrib=jsonData.attributes[key];bufferList[key]=new Geometry.TYPED_ARRAYS[attrib.type](attrib.array),bufferList[`${key}ItemSize`]=attrib.itemSize,buffers.push(bufferList[key].buffer)}}else{bufferList._type="BufferGeometry";for(let key in data){let attrib=data[key];bufferList[key]=new Float32Array(attrib.buffer),bufferList[`${key}ItemSize`]=attrib.components,buffers.push(bufferList[key].buffer)}}resolve(bufferList,id,buffers)}))}))})),Class((function MeshBatch(_input,_config){Inherit(this,Object3D);const _this=this;var _geom,_shader,_mesh,_firstRender,_shaderKey,_availableIndices,_packedData,_packedTexture,_maxIndices,_static=!1,_renderOrder=0,_objects=[],_offset=[],_quaternion=[],_scale=[],_attributes={},_uniformToAttrib=[],_uniformNoAttrib=[],_frustumCulled=!0,_v1=new Vector3,_v2=new Vector3,_q=new Quaternion,_list=new LinkedList;async function initFromSceneLayout(){let wildcard=_input.get("wildcard");if(!wildcard||!wildcard.length)return;let groupName=wildcard.split("|")[0],group=await _this.parent.getLayer(groupName);await _this.wait(group.children,"length");let children=[...group.children];children.sort(((a,b)=>a.renderOrder-b.renderOrder)),children.forEach((mesh=>_this.add(mesh))),wildcard.includes("static")&&(_this.static=!0),_this.group.renderOrder=children[0].renderOrder,group.add(_this.group)}function updateShader(shader,castShadow){let prefetchCode=Shaders.getShader(shader.vsName+".vs");shader.customCompile=`${shader.vsName}|${shader.fsName}|instance`,shader.castShadow=castShadow,shader.resetProgram();let cached=MeshBatch.shaders[`${shader.vsName}|${shader.fsName}`];if(cached)return shader.fragmentShader=shader.restoreFS=cached.fragment,void(shader.vertexShader=shader.restoreVS=cached.vertex);let vsSplit=shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__");if(!vsSplit[1].includes("vec3 pos = position;")&&!vsSplit[1].includes("pos = pos;")&&!shader.vertexShader.includes("vec3 transformPosition"))throw`Shader ${shader.vsName} needs to have "vec3 pos = position;" in order for batching to work`;let definitions=[];vsSplit[1].split("\n").forEach((line=>{if(line.includes("uniform")){if(line.includes("sampler2D"))return;let data=line.split(" "),uni=data[2].replace(";","");(function uniformToAttrib(key){key=key.trim();for(let i=0;i<_uniformToAttrib.length;i++){let val=_uniformToAttrib[i];if(key.includes(val)||val.includes(key))return!_uniformNoAttrib.includes(key)}return!1})(uni)&&(definitions.push(`${uni} = a_${data[2]}`),vsSplit[1]=vsSplit[1].replace(line,`attribute ${data[1]} a_${data[2]}\nvarying ${data[1]} ${data[2]}`),fsSplit[1]=fsSplit[1].replace(line,`varying ${data[1]} ${data[2]}`))}})),vsSplit[1]=vsSplit[1].replace(/vec3 pos = position;/g,"vec3 pos = transformPosition(position, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/pos = pos;/g,"pos = transformPosition(pos, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/vNormal = normalMatrix \* normal;/g,"vNormal = normalMatrix * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vWorldNormal = transpose(inverse(mat3(modelMatrix))) \* normal;/g,"vWorldNormal = transpose(inverse(mat3(modelMatrix))) * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vec3 transformedNormal = normal;/g,"vec3 transformedNormal = transformNormal(normal, orientation);");let main=vsSplit[1].split("main() {");main[1]="\n"+definitions.join("\n")+main[1],vsSplit[1]=main.join("main() {"),vsSplit[0]+="#define INSTANCED 1\n",fsSplit[0]+="#define INSTANCED 1\n",prefetchCode&&prefetchCode.includes("attribute vec3 offset")||(vsSplit[0]+="\n",vsSplit[0]+="attribute float instance;\n",vsSplit[0]+="attribute vec3 offset;\n",vsSplit[0]+="attribute vec3 scale;\n",vsSplit[0]+="attribute vec4 orientation;\n"),shader.vertexShader.includes("vec3 transformPosition")||(vsSplit[0]+=Shaders.getShader("instance.vs")+"\n"),_packedData&&(vsSplit[0]+="\n            attribute float batchIndex;\n            uniform vec3 uPackedInfo;\n            uniform sampler2D tPackedTexture;\n            vec2 getPackedUV(float index, float offset) {\n                float pixel = (index*uPackedInfo.x) + offset;\n            \n                float size = uPackedInfo.y;\n                float p0 = pixel / size;\n                float y = floor(p0);\n                float x = p0 - y;\n            \n                vec2 uv = vec2(0.0);\n                uv.x = x;\n                uv.y = y / size;\n                return uv;\n            }\n            \n            vec4 getPackedData(float offset) {\n                return texture2D(tPackedTexture, getPackedUV(batchIndex, offset));\n            }\n            "),vsSplit=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),fsSplit=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=shader.restoreVS=vsSplit,shader.fragmentShader=shader.restoreFS=fsSplit,_shaderKey=`${shader.vsName}|${shader.fsName}`,MeshBatch.shaders[_shaderKey]={fragment:shader.fragmentShader,vertex:shader.vertexShader}}function modifyGeometry(dir){if(!_geom||!_geom.attributes||!_geom.attributes.offset)return;let count=_geom.attributes.offset.count+dir;_offset=new Float32Array(3*count),_scale=new Float32Array(3*count),_quaternion=new Float32Array(4*count),_geom.attributes.offset.setArray(new Float32Array(3*count)),_geom.attributes.scale.setArray(new Float32Array(3*count)),_geom.attributes.orientation.setArray(new Float32Array(4*count));for(let key in _attributes){let components=_geom.attributes[key].itemSize;_attributes[key]=new Float32Array(count*components),_geom.attributes[key].setArray(new Float32Array(count*components))}_geom.maxInstancedCount=_objects.length,loop()}function dirty(a,b){for(let i=a.length-1;i>-1;i--)if(a[i]!=b[i])return!0;return!1}function prepareMesh(mesh,i){let pos=_v1,scale=_v2,quaternion=_q;if(_config.worldCoords)try{if(_config.parent>0)switch(_config.parent){case 1:pos.copy(mesh._parent.position),scale.copy(mesh._parent.scale),quaternion.copy(mesh._parent.quaternion);break;case 2:pos.copy(mesh._parent._parent.position),scale.copy(mesh._parent._parent.scale),quaternion.copy(mesh._parent._parent.quaternion)}else _config.addParentPosition?(pos.copy(mesh.position).add(mesh._parent.position),2==_config.addParentPosition&&pos.add(mesh._parent._parent.position),scale.copy(mesh.scale),quaternion.copy(mesh.quaternion)):(pos.copy(mesh.getWorldPosition()),scale.copy(mesh.getWorldScale()),quaternion.copy(mesh.getWorldQuaternion()));_config.bypassVisibilityCheck||mesh.determineVisible()||(scale.x=scale.y=scale.z=0)}catch(e){pos.copy(mesh.position),scale.copy(mesh.scale),quaternion.copy(mesh.quaternion)}else pos.copy(mesh.position),scale.copy(mesh.scale),quaternion.copy(mesh.quaternion),_config.visibilityCheck&&!mesh.determineVisible()&&scale.setScalar(0);mesh.batchOffsetPos&&pos.add(mesh.batchOffsetPos);let i3=3*i,i4=4*i;if(_offset[i3+0]=pos.x,_offset[i3+1]=pos.y,_offset[i3+2]=pos.z,_scale[i3+0]=scale.x,_scale[i3+1]=scale.y,_scale[i3+2]=scale.z,_quaternion[i4+0]=quaternion.x,_quaternion[i4+1]=quaternion.y,_quaternion[i4+2]=quaternion.z,_quaternion[i4+3]=quaternion.w,mesh.attributes)for(let key in mesh.attributes){let attr=mesh.attributes[key],value=void 0===attr.value?attr:attr.value;value instanceof Color?(_attributes[key][3*i+0]=value.r,_attributes[key][3*i+1]=value.g,_attributes[key][3*i+2]=value.b):value instanceof Vector3?(_attributes[key][3*i+0]=value.x,_attributes[key][3*i+1]=value.y,_attributes[key][3*i+2]=value.z):value instanceof Vector4||value instanceof Quaternion?(_attributes[key][4*i+0]=value.x,_attributes[key][4*i+1]=value.y,_attributes[key][4*i+2]=value.z,_attributes[key][4*i+3]=value.w):value instanceof Vector2?(_attributes[key][2*i+0]=value.x,_attributes[key][2*i+1]=value.y):_attributes[key][i]=value}if(_packedTexture){let batchIndex=mesh.batchIndex,stride=4*_packedTexture.keys;for(let key in _packedData){let offset=4*_packedData[key],value=mesh.packedData[key].value,index=batchIndex*stride+offset,r=g=b=a=1;value instanceof Color?(r=value.r,g=value.g,b=value.b):value instanceof Vector3?(r=value.x,g=value.y,b=value.z):value instanceof Vector4||value instanceof Quaternion?(r=value.x,g=value.y,b=value.z,a=value.w):value instanceof Vector2?(r=value.x,g=value.y):r=value,_packedTexture.data[index+0]=r,_packedTexture.data[index+1]=g,_packedTexture.data[index+2]=b,_packedTexture.data[index+3]=a}_packedTexture.needsUpdate=!0}}function updateBuffers(){if(_mesh){dirty(_quaternion,_geom.attributes.orientation.array)&&(_geom.attributes.orientation.array.set(_quaternion),_geom.attributes.orientation.needsUpdate=!0),dirty(_offset,_geom.attributes.offset.array)&&(_geom.attributes.offset.array.set(_offset),_geom.attributes.offset.needsUpdate=!0),dirty(_scale,_geom.attributes.scale.array)&&(_geom.attributes.scale.array.set(_scale),_geom.attributes.scale.needsUpdate=!0);for(let key in _attributes)dirty(_attributes[key],_geom.attributes[key].array)&&(_geom.attributes[key].array.set(_attributes[key]),_geom.attributes[key].needsUpdate=!0)}else!function initMesh(){if(_geom.addAttribute("offset",new GeometryAttribute(new Float32Array(_offset),3,1,_this.useDynamic)),_geom.addAttribute("scale",new GeometryAttribute(new Float32Array(_scale),3,1,_this.useDynamic)),_geom.addAttribute("orientation",new GeometryAttribute(new Float32Array(_quaternion),4,1,_this.useDynamic)),_frustumCulled){let box=new Box3;_objects.forEach((mesh=>box.expandByObject(mesh,!0))),_geom.boundingBox=box,_geom.boundingSphere=box.getBoundingSphere()}_mesh=_this.usePoints?new Points(_geom,_shader):new Mesh(_geom,_shader),(_shader.castShadow||_this.castShadow)&&defer((_=>_mesh.castShadow=!0)),_mesh.asyncPromise=_this.group.asyncPromise,_this.group.asyncPromise.resolve(),_this.mesh=_mesh,_this.shader=_mesh.shader,_this.mesh.isMeshBatch=!0,_this.group.add(_mesh),_mesh.frustumCulled=_frustumCulled,_renderOrder&&(_mesh.renderOrder=_renderOrder),_offset=new Float32Array(_offset),_quaternion=new Float32Array(_quaternion),_scale=new Float32Array(_scale);for(let key in _attributes){_attributes[key]=new Float32Array(_attributes[key]);let components=1,attr=_objects[0].attributes[key],value=attr.value||attr;value instanceof Vector3?components=3:value instanceof Vector4||value instanceof Quaternion?components=4:value instanceof Color?components=3:value instanceof Vector2&&(components=2),_geom.addAttribute(key,new GeometryAttribute(new Float32Array(_attributes[key]),components,1,_this.useDynamic))}_this.onMeshCreated&&_this.onMeshCreated(_mesh)}()}async function initializeStatic(){let wasVisible=_this.group.determineVisible();if(await(_=>{let promise=Promise.create(),mesh=_list.start(),i=0,worker=new Render.Worker((_=>{mesh.updateMatrixWorld(!0),prepareMesh(mesh,i),i++,mesh=_list.next(),mesh||(worker.stop(),promise.resolve())}),1);return promise})(),updateBuffers(),wasVisible){if(_frustumCulled){let box=new Box3;_objects.forEach((mesh=>box.expandByObject(mesh,!0))),_geom.boundingBox=box,_geom.boundingSphere=box.getBoundingSphere()}_this.flag("isStaticReady",!0)}else await _this.wait((()=>_this.group.determineVisible())),_static&&initializeStatic()}function loop(){_static&&_this.stopRender(loop,RenderManager.AFTER_LOOPS);let first=!_firstRender;_firstRender=!0;let i=0,mesh=_list.start();for(;mesh;)(!1!==mesh.batchNeedsUpdate||first)&&(first&&mesh.updateMatrixWorld(!0),prepareMesh(mesh,i)),mesh=_list.next(),i++;updateBuffers()}function firstLoop(){_static||_this.startRender(loop,RenderManager.AFTER_LOOPS),loop()}_this.usePoints=!1,_this.useDynamic=!1,function(){if(_input instanceof InputUILConfig||(_config=_input,_input=null),_config=_config||{},_input&&_this.parent.ready(!0).then(initFromSceneLayout),_this.group.asyncPromise=Promise.create(),Hydra.LOCAL){let warning=setTimeout((()=>{console.log("Problem loading instance",_this?.parent?._config?.getFilePath?.("json"))}),5e3);_this.group.asyncPromise.then((()=>{clearTimeout(warning)}))}Hydra.LOCAL&&function initHotReload(){_this.events.sub(ShaderUIL.SHADER_UPDATE,(({shader:shader})=>{if(_shader&&_shader.vsName&&shader.includes(_shader.vsName)){let newShader=new Shader(_shader.vsName,_shader.fsName);delete MeshBatch.shaders[`${_shader.vsName}|${_shader.fsName}`],updateShader(newShader),Shader.renderer.hotReloadClearProgram(_shader.vsName),newShader.upload(_mesh,_geom),_shader._gl&&(_shader._gl=newShader._gl),_shader._gpu&&(_shader._gpu=newShader._gpu),_shader._metal&&(_shader._metal=newShader._metal)}}))}()}(),this.add=function(mesh){_objects.push(mesh),_list.push(mesh),mesh.uploadIgnore=!0,mesh.batch=_this,_availableIndices&&!mesh.batchIndex&&(mesh.batchIndex=_availableIndices.shift(),mesh.attributes||(mesh.attributes={}),mesh.attributes.batchIndex={value:mesh.batchIndex});let shader=mesh.shader;for(let key in shader.uniforms){let uniform=shader.uniforms[key];if(uniform.value instanceof Color||uniform.value instanceof Vector2||uniform.value instanceof Vector3||uniform.value instanceof Vector4||uniform.value instanceof Quaternion||"number"==typeof uniform.value)if(uniform.batchUnique||_config.batchUnique)_uniformToAttrib.push(key),mesh.attributes||(mesh.attributes={}),mesh.attributes["a_"+key]=uniform;else if(_uniformNoAttrib.includes(key)||_uniformNoAttrib.push(key),void 0!==uniform.packedIndex){if(_packedData||(_packedData={}),!_availableIndices)throw"Can't use packedData without first setting .maxIndices";_packedData[key]||(_packedData[key]=uniform.packedIndex),mesh.packedData||(mesh.packedData={}),mesh.packedData[key]=uniform}}_geom||function initGeometry(mesh){if(_geom=(new Geometry).instanceFrom(mesh.geometry),_this.geom=_geom,!_shader){if((_shader=mesh.shader.clone()).debug=!0,_this.usePoints||mesh.shader.replicateUniformsTo(_shader),_packedData){let total=Object.keys(_packedData).length,pixels=Math.sqrt(_maxIndices*total),size=Math.pow(2,Math.ceil(Math.log(pixels)/Math.log(2)));(_packedTexture=new DataTexture(new Float32Array(size*size*4),size,size,Texture.RGBAFormat,Texture.FLOAT)).keys=total,_shader.addUniforms({tPackedTexture:{value:_packedTexture},uPackedInfo:{value:new Vector3(total,size,_maxIndices)}})}updateShader(_shader,mesh.castShadow)}if(mesh.attributes)for(let key in mesh.attributes)_attributes[key]=[];_static&&defer(initializeStatic)}(mesh),_mesh&&(modifyGeometry(1),_static&&console.error("Don't add more meshes to a static MeshBatch")),mesh.shader.neverRender=!0,_static||RenderManager.scheduleOne(firstLoop,RenderManager.AFTER_LOOPS)},this.remove=function(mesh){_objects.includes(mesh)&&(_objects.remove(mesh),_list.remove(mesh),mesh.batchIndex>-1&&!mesh.persistBatchIndex&&(_availableIndices.push(mesh.batchIndex),_availableIndices.sort(((a,b)=>a-b))),modifyGeometry(-1))},this.onDestroy=function(){_this.mesh&&_this.mesh.destroy&&_this.mesh.destroy(),delete MeshBatch.shaders[_shaderKey]},this.loadFromFile=async function(shader,geomFile,instanceFile){geomFile.includes("assets/geometry")||(geomFile="assets/geometry/"+geomFile),geomFile.includes(".json")||(geomFile+=".json"),instanceFile.includes("assets/geometry")||(instanceFile="assets/geometry/"+instanceFile),instanceFile.includes(".json")||(instanceFile+=".json");let[geom,data]=await Promise.all([GeomThread.loadGeometry(Assets.getPath(geomFile)),get(Assets.getPath(instanceFile))]),array=[],count=data.offset.buffer.length/3;for(let i=0;i<count;i++){let mesh=new Mesh(geom,shader);mesh.position.fromArray(data.offset.buffer,3*i),mesh.scale.fromArray(data.scale.buffer,3*i),mesh.quaternion.fromArray(data.orientation.buffer,4*i),array.push(mesh),_this.add(mesh)}return await _this.ready(),array},this.ready=function(){return _this.wait("mesh")},this.staticReady=function(){if(_static)return _this.wait("isStaticReady")},this.getMeshByIndex=function(index){return _objects[index]},this.getMeshCount=function(){return _objects.length},this.get("static",(()=>_static)),this.set("static",(b=>{!!b!==_static&&(_static=!!b,_objects.length&&(_static&&console.warn("For better initialization performance, set meshBatch.static before adding any meshes"),_this.stopRender(loop,RenderManager.AFTER_LOOPS),RenderManager.scheduleOne(firstLoop,RenderManager.AFTER_LOOPS)))})),this.set("maxIndices",(value=>{if(_maxIndices=value,!(_availableIndices=_config.availableIndices||[]).length)for(let i=0;i<value;i++)_availableIndices[i]=i})),this.get("attributes",(_=>_attributes)),this.get("maxIndices",(_=>_maxIndices)),this.set("renderOrder",(v=>{_renderOrder=v,_mesh&&(_mesh.renderOrder=v)})),this.get("renderOrder",(_=>_renderOrder)),this.set("frustumCulled",(b=>{_frustumCulled=b,_mesh&&(_mesh.frustumCulled=b)})),this.applyToShader=function(shader,castShadow=shader.mesh?.castShadow??!1){updateShader(shader,castShadow)},this.upload=async function(){await _this.ready(),_mesh.upload()}}),(_=>{MeshBatch.shaders={}})),Class((function MeshMerge(_input,_dynamic){Inherit(this,Object3D);const _this=this;var _mesh,_geom,_texture,_shaderKey,_meshes=[],_pending=[],_index=0;function initDynamic(){let array=new Float32Array(1024);(_texture=new DataTexture(array,16,16,Texture.RGBAFormat,Texture.FLOAT)).dynamic=!0,_texture.promise=Promise.resolve(),function updateShader(shader){shader.customCompile=`${shader.vsName}|${shader.fsName}|dynamicMerge`,shader.addUniforms({tDynamicMerge:{value:_texture}});let cached=MeshMerge.shaders[`${shader.vsName}|${shader.fsName}`];if(cached)return shader.fragmentShader=cached.fragment,shader.resetProgram();shader.resetProgram();let vsSplit=shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__");if(!vsSplit[1].includes("vec3 pos = position;"))throw`Shader ${shader.vsName} needs to have "vec3 pos = position;" in order for dynamic merging to work`;vsSplit[0]+="attribute float mIndex;\n",vsSplit[0]+="uniform sampler2D tDynamicMerge;\n",vsSplit[0]+="vec3 offset;\n",vsSplit[0]+="vec3 scale;\n",vsSplit[0]+="vec4 orientation;\n",shader.vertexShader.includes("vec3 transformPosition")||(vsSplit[0]+=Shaders.getShader("instance.vs")+"\n");vsSplit[0]+="\n        vec2 getDMUV(float index, float offset) {\n            float pixel = (index*3.0) + offset;\n        \n            float size = 16.0;\n            float p0 = pixel / size;\n            float y = floor(p0);\n            float x = p0 - y;\n        \n            vec2 uv = vec2(0.0);\n            uv.x = x;\n            uv.y = y / size;\n            return uv;\n        }\n        \n",vsSplit[1]=vsSplit[1].replace(/vec3 pos = position;/g,"vec3 pos = transformPosition(position, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/vNormal = normalMatrix \* normal;/g,"vNormal = normalMatrix * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vec3 transformedNormal = normal;/g,"vec3 transformedNormal = transformNormal(normal, orientation);");let oso="\n        offset = texture2D(tDynamicMerge, getDMUV(mIndex, 0.0)).xyz;\n        scale = texture2D(tDynamicMerge, getDMUV(mIndex, 1.0)).xyz;\n        orientation = texture2D(tDynamicMerge, getDMUV(mIndex, 2.0));\n        ",main=vsSplit[1].split("main() {");main[1]="\n"+oso+main[1],vsSplit[1]=main.join("main() {"),vsSplit=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=vsSplit,_shaderKey=`${shader.vsName}|${shader.fsName}`,MeshMerge.shaders[_shaderKey]={vertex:shader.vertexShader}}(_mesh.shader);let loop=_=>{for(let i=_meshes.length-1;i>-1;i--){let mesh=_meshes[i],index=mesh.mergeIndex;array[12*index+0]=mesh.position.x,array[12*index+1]=mesh.position.y,array[12*index+2]=mesh.position.z,array[12*index+3]=1,array[12*index+4]=mesh.scale.x,array[12*index+5]=mesh.scale.y,array[12*index+6]=mesh.scale.z,array[12*index+7]=1,array[12*index+8]=mesh.quaternion.x,array[12*index+9]=mesh.quaternion.y,array[12*index+10]=mesh.quaternion.z,array[12*index+11]=mesh.quaternion.w}};defer(loop),_this.startRender(loop)}function completeMerge(){_mesh.geometry=_geom,_mesh.asyncPromise.resolve(),_this.onMeshCreated&&_this.onMeshCreated(_mesh),_this.mesh=_mesh}async function initFromSceneLayout(){let wildcard=_input.get("wildcard");if(!wildcard||!wildcard.length)return;let[groupName,dynamic]=wildcard.split("|");await _this.parent.loadedAllLayers();let group=await _this.parent.getLayer(groupName);_dynamic="dynamic"==dynamic;let children=[...group.children];children.sort(((a,b)=>a.renderOrder-b.renderOrder)),children.forEach((mesh=>_this.add(mesh))),group.add(_this.group),MeshMerge.cache[_input.prefix]||(MeshMerge.cache[_input.prefix]=Promise.create())}!function(){if("object"==typeof _input){if(!1===_input.get("visible"))return;_this.parent.ready().then(initFromSceneLayout)}else"boolean"==typeof _input&&(_dynamic=_input)}(),this.onDestroy=function(){_mesh.destroy(),delete MeshBatch.shaders[_shaderKey]},this.ready=function(){return _this.wait("mesh")},this.add=function(mesh){if(mesh.uploadIgnore=!0,!mesh.visible)return;if(mesh.merge=_this,mesh.updateMatrixWorld(!0),_mesh||async function initMesh(mesh){if((_mesh=new Mesh(World.QUAD,mesh.shader)).asyncPromise=Promise.create(),_this.group.add(_mesh),_input?.get&&(_mesh.castShadow=_input.get("castShadow"),_mesh.shader.receiveShadow=_input.get("receiveShadow")),_dynamic&&initDynamic(),_input?.prefix){let cached=MeshMerge.cache[_input.prefix];if(cached)return _geom=await cached,void completeMerge()}await defer();let data=await Promise.all(_pending),buffers=[];data.forEach((obj=>{for(let key in obj)obj[key].buffer&&buffers.push(obj[key].buffer)}));let merged=await Thread.shared().meshMergeComplete({data:data},buffers);_geom=new Geometry;for(let key in merged)"components"!==key&&_geom.addAttribute(key,new GeometryAttribute(merged[key],merged.components[key]));merged.indexBuffer&&(_geom.index=merged.indexBuffer),_input?.prefix&&MeshMerge.cache[_input.prefix].resolve(_geom),completeMerge()}(mesh),_input?.prefix){if(MeshMerge.cache[_input.prefix])return mesh.visible=!1,_meshes.push(mesh),void(mesh.mergeIndex=_index++)}let geom=mesh.geometry;if(mesh.attributes)for(let key in mesh.attributes){let attr=mesh.attributes[key];attr instanceof Vector4&&(attr.isVector4=!0),attr instanceof Vector3&&(attr.isVector3=!0),attr instanceof Vector2&&(attr.isVector2=!0),attr instanceof Color&&(attr.isColor=!0)}let data={},components={},buffers=[];for(let key in geom.attributes)data[key]=new Float32Array(geom.attributes[key].array),buffers.push(data[key].buffer),components[key]=geom.attributes[key].itemSize;geom.index&&(data.indexBuffer=new Uint32Array(geom.index),buffers.push(data.indexBuffer.buffer)),data.attributes=mesh.attributes,data.components=components,data.matrix="world"==_input?mesh.matrixWorld.elements:mesh.matrix.elements,_dynamic&&(data.matrix=null),data.dynamic=_dynamic,data.index=mesh.mergeIndex=_index++,mesh.visible=!1,_meshes.push(mesh),_pending.push(Thread.shared().meshMergeTransform(data,buffers))},this.onDestroy=function(){_input?.prefix&&delete MeshMerge.cache[_input.prefix]}}),(_=>{Thread.upload((function meshMergeTransform(e,id){let geom=new Geometry;for(let key in e)!key.includes(["components","matrix"])&&e[key]instanceof Float32Array&&geom.addAttribute(key,new GeometryAttribute(e[key],e.components[key]));if(e.indexBuffer&&(geom.index=e.indexBuffer),e.attributes)for(let key in e.attributes){let components=1,attr=e.attributes[key];attr.isVector4?components=4:attr.isVector3||attr.isColor?components=3:attr.isVector2&&(components=2);let buffer=new Float32Array(geom.attributes.position.count*components),step=buffer.length/components;for(let i=0;i<step;i++)4==components?(buffer[4*i+0]=attr.x,buffer[4*i+1]=attr.y,buffer[4*i+2]=attr.z,buffer[4*i+3]=attr.w):3==components?(buffer[3*i+0]=attr.x||attr.r||0,buffer[3*i+1]=attr.y||attr.g||0,buffer[3*i+2]=attr.z||attr.b||0):2==components?(buffer[2*i+0]=attr.x,buffer[2*i+1]=attr.y):buffer[i]=attr;geom.addAttribute(key,new GeometryAttribute(buffer,components))}e.matrix&&geom.applyMatrix((new Matrix4).fromArray(e.matrix));let indexBuffer=new Float32Array(geom.attributes.position.count);for(let i=0;i<indexBuffer.length;i++)indexBuffer[i]=e.index;geom.addAttribute("mIndex",new GeometryAttribute(indexBuffer,1));let data={},buffers=[],components={};for(let key in geom.attributes)data[key]=geom.attributes[key].array,components[key]=geom.attributes[key].itemSize,buffers.push(data[key].buffer);geom.index&&(data.indexBuffer=geom.index,buffers.push(data.indexBuffer.buffer)),data.components=components,resolve(data,id,buffers)})),Thread.upload((function meshMergeComplete({data:data},id){let _geom;data.forEach((data=>{let geom=new Geometry;for(let key in data)"components"!=key&&("indexBuffer"==key?geom.index=data[key]:geom.addAttribute(key,new GeometryAttribute(data[key],data.components[key])));_geom?_geom.merge(geom):_geom=geom}));let result={},components={},buffers=[];for(let key in _geom.attributes)result[key]=_geom.attributes[key].array,components[key]=_geom.attributes[key].itemSize,buffers.push(result[key].buffer);_geom.index&&(result.indexBuffer=_geom.index,buffers.push(result.indexBuffer.buffer)),result.components=components,resolve(result,id,buffers)})),MeshMerge.shaders={},MeshMerge.cache={}})),Class((function OptimizationProfiler(){Inherit(this,Component);const _this=this;var _shaders,_count,_gradientStops,_color;function getGradientColor(alpha,ease="Sine"){!function initGradientColors(){_gradientStops||(_gradientStops=[new Color("#28c913"),new Color("#ffde0a"),new Color("#ff0000")]),_color||(_color=new Color)}();let lastIndex=_gradientStops.length-1,index=Math.clamp(alpha)*lastIndex;if(index>=lastIndex)return _color.copy(_gradientStops[lastIndex]);let stop0=Math.floor(index);return alpha=TweenManager.Interpolation[ease].InOut(Math.fract(index)),_color.copy(_gradientStops[stop0]).lerp(_gradientStops[stop0+1],alpha,!1)}function getGradientHexString(alpha,ease){return getGradientColor(alpha,ease).getHexString()}this.active=Utils.query("optimizationProfiler")||location.hash?.includes("optimizationProfiler"),_this.active&&(_shaders=[],_count=Number(String(Utils.query("optimizationProfiler"))||location.hash.split("optimizationProfiler=")[1]?.split("&")[0]),isNaN(_count)&&(_count=null)),this.setupShader=function(shader){shader.addUniforms({texDimensions:{value:0},texelsPerMeter:{value:_count}});const parse=_=>{for(let key in shader.uniforms){let value=shader.uniforms?.[key]?.value;value instanceof Texture&&(value.data||(value.dimensions?shader.uniforms.texDimensions.value=Math.max(shader.uniforms.texDimensions.value,Math.max(value.dimensions.width,value.dimensions.height)):value.promise?.then(parse)))}};_shaders.push(shader),parse()},this.override=function(shader,vsCode,fsCode){let vs=vsCode,fs=fsCode,enabled=!!_count,mesh=shader?.mesh;if(enabled=enabled&&mesh instanceof Mesh,enabled=enabled&&mesh.geometry!==World.QUAD,enabled=enabled&&fsCode.includes("vUv"),enabled)try{!function(){vs=vs.slice(0,-(vs.length-vs.lastIndexOf("}"))),vs+=`vDensityPos = ${vs.includes("vec3 pos ")?"pos":"position"};\n`,vs+="}";let split=vs.split("void main");split[0]+="\n        out vec3 vDensityPos;\n        ",vs=split.join("void main")}(),function(){fs=fs.slice(0,-(fs.length-fs.lastIndexOf("}"))),fs+="FragColor = vec4(getDensityColor(), 1.0);\n",fs+="}";let split=fs.split("void main");split[0]+="\n        #define TEXEL_DENSITY_EPSILON 10e-10\n        uniform float texDimensions;\n        uniform float texelsPerMeter;\n        in vec3 vDensityPos;\n \nfloat MipLevel(vec2 uv)\n{\n  vec2 dx = dFdx(uv);\n  vec2 dy = dFdy(uv);\n  float d = max( dot(dx, dx), dot(dy, dy) );\n \n  float maxRange = pow(2., (10.0 - 1.) * 2.);\n  d = clamp(d, 1., maxRange);\n \n  float mipLevel = 0.5 * log2(d);\n  return floor(mipLevel);\n}\n\nvec3 getDensityColor() {\n    vec2 uv = vUv.xy;\n    \n    float texWidth = texDimensions;\n    float texHeight = texDimensions;\n\n    vec2 ddxUV  = dFdx(uv * texWidth  / texelsPerMeter);\n    vec2 ddyUV  = dFdy(uv * texHeight / texelsPerMeter);\n    vec3 ddxPos = dFdx(vDensityPos);\n    vec3 ddyPos = dFdy(vDensityPos);\n\t\n\t// NOTE(jserrano): check LOD ?\n\t//float mipLevel = MipLevel(uv * texDimensions);\n    //float mipSize  = pow(2., mipLevel);\n    \n    //ddxUV /= mipSize;\n    //ddyUV /= mipSize;\n\n    float uvArea   = length( cross(vec3(ddxUV,0), vec3(ddyUV,0)) );\n    float faceArea = length( cross(ddxPos, ddyPos) );\n\tfloat density  = uvArea / max(10e-10, faceArea);\n    \n    const float lowRatioLimit  = 0.8;\n    const float midRatio       = 1.0;\n    const float highRatioLimit = 1.2;\n    \n    vec3 finalColor = vec3(0);\n    \n\tif (density > lowRatioLimit && density < highRatioLimit)\n\t{\n        vec3 lowDensityColor  = vec3( 1., 1., 1. );\n        vec3 midDensityColor  = vec3( 0., 1., 0. );\n        vec3 highDensityColor = vec3( 0., 0., 0. );\n        \n        vec3 lowColorStep = mix( lowDensityColor, midDensityColor, smoothstep(lowRatioLimit, midRatio, density) );\n        finalColor = mix( lowColorStep, highDensityColor, smoothstep(midRatio, highRatioLimit, density) );\n\t}\n    else if (density > highRatioLimit)\n    {\n        vec3 lowDensityColor  = vec3( 1., 1., 0. );\n        vec3 highDensityColor = vec3( 1., 0., 0. );\n        \n        float ratio = smoothstep(highRatioLimit, 2., density);\n        finalColor = mix( lowDensityColor, highDensityColor, ratio );\n    }\n    else\n    {\n        vec3 lowDensityColor  = vec3( 0., 0., 1. );\n        vec3 highDensityColor = vec3( 0., 1., 1. );\n        \n        float ratio = smoothstep(0., lowRatioLimit, density);\n        finalColor = mix( lowDensityColor, highDensityColor, ratio );\n    }\n\n    return finalColor;\n}\n        ",fs=split.join("void main")}()}catch(e){vs=vsCode,fs=fsCode}return[vs,fs]},this.logTextures=function(){if(!this.active)return void console.log("Add optimizationProfiler in the URL!");let map=new Map;_shaders?.forEach((shader=>{if(!shader._gl)return;let sceneLayout,uilName=shader.mesh?.uilName;if(uilName){let parent=shader.mesh._parent;for(;parent;){if(parent.classRef?.name){sceneLayout=parent.classRef;break}parent=parent._parent}}for(let key in shader.uniforms){let value=shader.uniforms?.[key]?.value;if(value instanceof Texture&&!value.data&&value.dimensions){if(!map.has(value)){let size=Math.max(value.dimensions.width,value.dimensions.height);map.set(value,{sceneLayouts:{},shaders:{},size:size})}let info=map.get(value);sceneLayout&&(info.sceneLayouts[sceneLayout.name]||(info.sceneLayouts[sceneLayout.name]={}),info.sceneLayouts[sceneLayout.name][uilName]=!0),info.shaders[shader.fsName]||(info.shaders[shader.fsName]={}),info.shaders[shader.fsName][key]=!0}}}));let textures=Array.from(map.keys());textures.sort(((a,b)=>map.get(b).size-map.get(a).size)),textures.forEach((texture=>{let info=map.get(texture),sceneLayouts=Object.keys(info.sceneLayouts),shaders=Object.keys(info.shaders),name=texture.src;if(!name&&sceneLayouts.length&&(name=Object.keys(info.sceneLayouts[sceneLayouts[0]])[0]),!name){let uniforms=Object.keys(info.shaders[shaders[0]]);name=`${shaders[0]}/${uniforms[0]}`}console.group(name);let compressed,bgColor=getGradientHexString(Math.range(info.size,512,1024,0,.5),"Cubic");compressed="ktx2"===texture.compressed?"✅ (ktx2)":texture.compressed?"⚠️ (ktx1)":"❌",console.log(`%c ${info.size}`,`background-color: ${bgColor}; color: #000000;`,`Compressed: ${compressed}`);for(let sceneLayout in info.sceneLayouts)console.log(`${sceneLayout}: ${Object.keys(info.sceneLayouts[sceneLayout]).join(", ")}`);for(let shader in info.shaders)console.log(`${shader}: ${Object.keys(info.shaders[shader]).join(", ")}`);console.groupEnd(name)}))},this.logVertices=function(sort=!1){if(!_shaders||!_shaders.length)return;let total=0,shaders=_shaders.filter((shader=>shader._gl&&Boolean(shader?.mesh?.geometry)&&!(shader?.mesh instanceof Points))).map((shader=>({shader:shader,count:shader.mesh.geometry.isInstanced?shader.mesh.geometry.attributes.position.count*shader.mesh.geometry.maxInstancedCount:shader.mesh.geometry.attributes.position.count})));sort&&(shaders=shaders.sort(((a,b)=>b.count-a.count))),shaders.forEach((({shader:shader,count:count})=>{total+=count,console.group(shader.mesh.uilName||shader.fsName),shader.mesh.uilName||console.log(shader.mesh),console.log(`%c ${shader.mesh.geometry.isInstanced?"Instanced":""} Vertices ${count}`,`background-color: ${function bgColor(count){return getGradientHexString(Math.range(count,15e3,3e4,0,.5))}(count)}; color: #000000;`),console.groupEnd()})),console.log("%c TOTAL VERTICES "+total,"background-color: #ff00ff; color: #000000;")}}),"static"),Class((function RTPool(_type,_size=3,_format,_multisample=!1,_samplesAmount=4){Inherit(this,Component);const _this=this;var _pool,_indexed={};this.nullRT=Utils3D.createRT(2,2),this.nullRT.setSize=()=>{};var _array=[],_resizeDisabled=!1;function createRT(){let rt=Utils3D.createRT(Stage.width*World.DPR,Stage.height*World.DPR,_type,_format,_multisample,_samplesAmount);return rt.index=_pool.length(),rt}function addListeners(){_resizeDisabled||_this.events.sub(Events.RESIZE,resizeHandler)}function resizeHandler(){_array.forEach((rt=>{rt.setSize(Stage.width*World.DPR,Stage.height*World.DPR)}))}!function initPool(){_pool=new ObjectPool;for(let i=0;i<_size;i++){let rt=createRT();_pool.put(rt),_array.push(rt)}}(),defer(addListeners),this.get("array",(_=>_array)),this.getRT=function(index){return index?(_indexed[index]||(_indexed[index]=createRT()),_indexed[index]):_pool.get()||createRT()},this.putRT=function(rt){rt.scissor&&delete rt.scissor,rt!==_this.nullRT&&_pool.put(rt)},this.setSize=function(width,height){_this.disableResize(),_array.forEach((rt=>{rt.setSize(width,height)}))},this.onDestroy=function(){let p=_pool.get();for(;p;)p.dispose(),p=_pool.get()},this.clone=function(type=_type,size=_size,format=_format,multisample=_multisample,samplesAmount=_samplesAmount){return new RTPool(type,size,format,multisample,samplesAmount)},this.disableResize=function(){_resizeDisabled=!0,_this.events.unsub(Events.RESIZE,resizeHandler)}}),"singleton"),Class((function PerformanceAnalyzer(){Inherit(this,Component);const _this=this;var _lowFrame=0;function startRender(){_this.startRender(loop)}function loop(){let targetDelta=1e3/Render.REFRESH_RATE,realDelta=Render.DELTA;Math.abs(targetDelta-realDelta)>2&&++_lowFrame>2*Render.REFRESH_RATE&&(_this.stopRender(loop),function reportLowFPS(){Dev.postPerfLog({message:"Unable to meet target framerate"})}())}Hydra.LOCAL&&function init(){_this.delayedCall(startRender,1e4)}()}),"static"),Class((function RenderCount(){const _this=this;var $container,LOG,_map={},_display={};this.map=_map,async function(){await Hydra.ready(),_this.active=Utils.query("uil")||Utils.query("renderCount"),LOG=_this.active&&Utils.query("log"),Utils.query("renderCount")&&async function initUIL(){await Hydra.ready(),($container=Stage.create("RenderCount")).css({width:175,height:"auto",paddingBottom:5,bottom:0,maxHeight:400,overflowY:"scroll",position:"absolute"}).bg("#111").setZ(9999999)}()}(),this.add=function(name,detail,amt=1){if(_this.active){if(void 0===_map[name]&&(_map[name]=0,$container)){let $wrapper=$container.create("wrapper");$wrapper.css({position:"relative",width:"100%",height:20}),$wrapper.label=$wrapper.create("label"),$wrapper.label.fontStyle("Arial",12,"#fff").text(name).css({left:10,position:"absolute"}),$wrapper.value=$wrapper.create("value"),$wrapper.value.fontStyle("Arial",12,"#fff").text(0).css({right:10,position:"absolute"}),_display[name]=$wrapper}LOG&&(console.groupCollapsed(name),detail&&console.log(detail),console.trace(),console.groupEnd()),_map[name]+=amt,_display[name]?.value?.text?.(_map[name]||"0")}},this.remove=function(name,amt=1){_this.active&&_map[name]&&(_map[name]-=amt,_display[name]?.value?.text?.(_map[name]||"0"))}}),"static"),Class((function RenderMonitor(){Inherit(this,Component);const _this=this;let $container,$frameDuration,$buttonContainer,$queryStats,$activeToggle,$logButton,_paused=!1,$queries=[],_frameDuration=0,_queries=[],_results={},_ticker=0,_prevResults={},_capturingResult=!1;const FRAME_INTERVAL=Render.REFRESH_RATE||60;function getToggleLabel(){return _paused?"resume":"pause"}function getQueryName(q){return q?.obj?.mesh?.uilName?q?.obj?.fsName+" - "+q?.obj?.mesh?.uilName||"fs name missing":q?.obj?.fsName||"fs name missing"}function createQueryResult(q){const queryEl=$queryStats.create("query-result");queryEl.css({position:"relative",width:"100%",display:"flex",justifyContent:"space-between",alignItems:"ceter"});let name=getQueryName(q);"BlitPass"===name&&(name="BlitPass (MSAA?)"),q.obj.__renderstatsname=name,queryEl.name=queryEl.create("shader-name").text(name),queryEl.name.css({position:"relative",color:"#ffffff",fontSize:"14px",opacity:.85}),queryEl.duration=queryEl.create("render-duration"),queryEl.duration.text(`${Math.round(q?.duration/q?.resultCount,2).toFixed(2)} ms`),queryEl.duration.css({position:"relative",color:"#ffffff",fontSize:"14px",fontVariant:"tabular-nums"}),queryEl.duration=q?.duration,queryEl.queryRef=q?.obj,queryEl.interact((e=>{queryEl.name.css({opacity:"over"===e.action?1:.85})}),(_=>logResult(name,q))),_capturingResult&&logResult(name,q),$queries.push(queryEl)}function captureResults(){if(_paused)for(let key in _prevResults){const q=_prevResults[key];logResult(getQueryName(q),q)}_capturingResult=!0}function logResult(name,q){console.group(name),console.log(q.obj.mesh||q.obj),console.log(`render duration: ${Math.round(q?.duration/q?.resultCount,2)}`),console.groupEnd()}function updateResults(query){const key=""+(query.id+" "+query.queryObject.fsName);_results.hasOwnProperty(key)?(_results[key].duration+=query.timeElapsed,_results[key].resultCount++):_results[key]={obj:query.queryObject,duration:query.timeElapsed,resultCount:1},query.queryObject.renderTimeQuery=null,query.destroy()}function updateStats(){_this.active&&(_paused||(_ticker%FRAME_INTERVAL==0&&function displayResults(){$queries.forEach(($q=>$q.destroy())),$queries.length=0;for(let key in _results)_results[key].duration;const resultsAsArray=Object.entries(_results);resultsAsArray.sort(((a,b)=>b[1].duration-a[1].duration)),_results=Object.fromEntries(resultsAsArray);for(let key in _results)_frameDuration+=_results[key].duration/_results[key].resultCount,createQueryResult(_results[key]);$frameDuration?.duration.text(`${Math.round(_frameDuration,2).toFixed(2)} ms`),_frameDuration=0,_capturingResult=!1,_prevResults=Object.assign({},_results),_results={},_queries=[]}(),_ticker++))}!async function(){await Hydra.ready(),_this.active=Utils.query("renderMonitor")||Utils.query("rendermonitor"),_this.active&&function initUIL(){$container=Stage.create("RenderMonitor");const w=Device.mobile?375:500;$container.css({position:"fixed",width:`${w}px`,height:"auto",maxHeight:"300px",minHeight:"min-content",padding:15,bottom:0,left:0,whiteSpace:"no-wrap",fontFamily:"Arial"}).bg("#111").setZ(99999),$buttonContainer=$container.create("render-monitor-button-container"),$buttonContainer.css({position:"relative",width:"min-content",display:"flex",justifyContent:"space-between",alignItems:"center"}),$activeToggle=$buttonContainer.create("render-monitor-active-toggle","button"),$activeToggle.text(getToggleLabel()),$activeToggle.css({position:"relative",marginBottom:"15px",marginRight:"5px",cursor:"pointer"}),$activeToggle.div.onclick=()=>{_paused=!_paused,$activeToggle.text(getToggleLabel())},$logButton=$buttonContainer.create("render-monitor-log","button"),$logButton.text("capture results"),$logButton.css({position:"relative",width:"max-content",marginBottom:"15px",whiteSpace:"no-wrap",cursor:"pointer"}),$logButton.div.onclick=()=>{captureResults()},$frameDuration=$container.create("frame-duration"),$frameDuration.css({position:"relative",width:"100%",display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"}),$frameDuration.label=$frameDuration.create("frame-duration-label").text("Total frame"),$frameDuration.label.css({position:"relative",color:"#ffffff",fontSize:"14px",paddingRight:"14px"}),$frameDuration.duration=$frameDuration.create("frame-duration-label").text(_frameDuration),$frameDuration.duration.css({position:"relative",color:"#ffffff",fontSize:"14px"}),$queryStats=$container.create("query-stats"),$queryStats.css({position:"relative",maxHeight:"200px",overflowY:"scroll",paddingBottom:"20px"})}(),_this.active&&(Render.endFrame=updateStats)}(),this.get("results",(_=>_results)),this.get("queries",(_=>_queries)),this.get("frameDuration",(_=>_frameDuration)),this.captureResults=captureResults,this.createQuery=function createQuery(gl,obj){return new RenderTimeQuery(gl,obj,updateResults)},this.updateResults=updateResults}),"static"),Class((function RenderStats(){const _this=this;var _trace,_filter,$container,_map={},_display={};function flush(){for(let key in _map)_this.stats[key]=_map[key],_display[key]&&_display[key].value.text(_map[key]||"0"),_map[key]=0;_trace=null}_this.stats={},async function(){await Hydra.ready(),_this.active=Utils.query("renderStats"),Utils.query("renderStats")&&async function initUIL(){if(await Hydra.ready(),($container=Stage.create("RenderStats")).css({position:"fixed",width:150,height:"auto",paddingTop:5}).bg("#111").setZ(99999),Utils.query("uil")){const left=RenderCount.active?150:0;$container.css({bottom:0,left:left})}}(),Render.drawFrame=flush;let frames=0,prevTime=0,fps=Render.REFRESH_RATE;Render.start((_=>{frames+=1,Render.TIME>=prevTime+1e3&&(fps=1e3*frames/(Render.TIME-prevTime),fps=Math.round(fps,fps>=1?0:2),prevTime=Render.TIME,frames=0),_this.update("FPS",fps)}))}(),this.update=function(name,amt=1,detail,detail2){if(Hydra.LOCAL){if(_trace==name){if(_filter&&detail){if(!("string"==typeof detail?detail:Utils.getConstructorName(detail)).toLowerCase().includes(_filter.toLowerCase()))return}console.groupCollapsed(name),detail&&console.log("string"==typeof detail?detail:Utils.getConstructorName(detail)),detail2&&console.log(detail2),console.trace(),console.groupEnd()}if(void 0===_map[name]&&(_map[name]=0,$container)){let $wrapper=$container.create("wrapper");$wrapper.css({position:"relative",width:"100%",height:20}),$wrapper.label=$wrapper.create("label"),$wrapper.label.fontStyle("Arial",12,"#fff").text(name).css({left:10,position:"absolute"}),$wrapper.value=$wrapper.create("value"),$wrapper.value.fontStyle("Arial",12,"#fff").text(0).css({right:10,position:"absolute"}),_display[name]=$wrapper}_map[name]+=amt}},this.trace=function(name,filter=null){_trace=name,_filter=filter},this.log=function(){for(let key in _this.stats)console.log(key,_this.stats[key]);console.log("----")}}),"static"),Class((function RenderTimeQuery(_gl,shader,resultavailableCB=(()=>{})){Inherit(this,Component);const _this=this;_this.durationQuery=null,_this.testInProgress=!1,_this.resultsAvailable=!1,_this.queryEnded=!0,_this.timeElapsed=0,_this.prevTimeElapsed=0,_this.inactive=!1,_this.inactivityAttempts=100;const ext=Renderer.extensions.disjointTimerQuery;function endDurationQuery(){_this.queryEnded||(_this.queryEnded=!0,_gl.endQuery(ext.TIME_ELAPSED_EXT))}function checkQueryResults(){let available=_gl.getQueryParameter(_this.durationQuery,_gl.QUERY_RESULT_AVAILABLE),disjoint=_gl.getParameter(ext.GPU_DISJOINT_EXT);if(_this.prevTimeElapsed=_this.timeElapsed,available&&!disjoint){let elapsedTime=_gl.getQueryParameter(_this.durationQuery,_gl.QUERY_RESULT);shader.renderDuration=_this.timeElapsed=function timeInMS(res){return Math.round(res/1e6,2)}(elapsedTime),_this.resultsAvailable=!0}(available||disjoint)&&(deleteQueries(),resultavailableCB(_this))}function deleteQueries(){_gl.deleteQuery(_this.durationQuery),_this.durationQuery=null}!async function(){await Hydra.ready(),ext?(_this.queryObject=shader,_this.id=shader.mesh?.id||shader.parent?.__id,shader.renderTimeQuery=_this):console.error("extension not available")}(),this.beginTest=function beginTest(){if(spector){const v=Object.values(RenderMonitor.results).find((i=>i.obj===shader)),name=v?.obj?.__renderstatsname;spector.log(`RenderMonitor:START = ${name}`)}_this.queryObject&&(_this.testInProgress||(_this.testInProgress=!0,_this.queryEnded=!1,_this.resultsAvailable=!1,_this.resultsReady=Promise.create(),_gl.getParameter(ext.GPU_DISJOINT_EXT),function initDrawDurationQuery(){_this.durationQuery||(_this.durationQuery=_gl.createQuery(),_gl.beginQuery(ext.TIME_ELAPSED_EXT,_this.durationQuery))}()))},this.endTest=function endTest(force=!1){if(spector){const v=Object.values(RenderMonitor.results).find((i=>i.obj===shader)),name=v?.obj?.__renderstatsname,duration=v?.duration/v?.resultCount;spector.log(`RenderMonitor:END = ${name}; duration = ${duration}ms`)}if(force)return _this.testInProgress=!1,endDurationQuery(),deleteQueries(),void _gl.getParameter(ext.GPU_DISJOINT_EXT);_this.durationQuery&&_this.testInProgress&&(endDurationQuery(),checkQueryResults())},this.deleteQueries=deleteQueries})),Class((function RenderTimer(){const _this=this;var $container,_display={},_times={};!async function(){await Hydra.ready(),_this.active=Utils.query("renderTimer"),_this.active&&async function initUIL(){($container=Stage.create("RenderTimer")).css({position:"absolute",width:150,height:"auto",paddingBottom:5,bottom:0,right:0}).bg("#111").setZ(9999999)}()}(),this.start=function(name){_times[name]=performance.now()},this.stop=function(name){if(!_display[name]&&$container){let $wrapper=$container.create("wrapper");$wrapper.css({position:"relative",width:"100%",height:20}),$wrapper.label=$wrapper.create("label"),$wrapper.label.fontStyle("Arial",12,"#fff").text(name).css({left:10}),$wrapper.value=$wrapper.create("value"),$wrapper.value.fontStyle("Arial",12,"#fff").text(0).css({right:10}),_display[name]=$wrapper}_display[name]&&_display[name].value.text((performance.now()-_times[name]).toFixed(3)||"0")}}),"static"),Class((function FBR(_shader){_shader.addUniforms({tMatcap:{value:null},tMRO:{value:null,getTexture:Utils3D.getRepeatTexture},tNormal:{value:null,getTexture:Utils3D.getRepeatTexture},uNormalStrength:{value:1},uLight:{value:new Vector4(1,1,1,1)},uColor:{value:new Color}})}),(_=>{window.fbr=FBR})),Class((function Fluid(_simSize=128,_dyeSize=512,_rect=Stage){Inherit(this,Component);const _this=this;var _fbos={},_scenes={},_tmpVec=new Vector2,_lastSplat=Render.TIME;if("object"==typeof _simSize&&_simSize.isAppState){let params=_simSize;_simSize=params.simSize||129,_dyeSize=params.dyeSize||512,_rect=params.rect||Stage}const DYE_WIDTH=_dyeSize,DYE_HEIGHT=_dyeSize,SIM_WIDTH=_simSize,SIM_HEIGHT=_simSize,config={DENSITY_DISSIPATION:.97,VELOCITY_DISSIPATION:.98,PRESSURE_DISSIPATION:.8,PRESSURE_ITERATIONS:20,CURL:30,DEBUG_MOUSE:!0,SPLAT_RADIUS:.25};function updateParamsHz(param){return 0==(param=Math.clamp(param))?0:Math.exp(Math.log(param)*Render.HZ_MULTIPLIER)}function loop(){_scenes.curl.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.curl.render(_fbos.curl.fbo),_scenes.vorticity.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.vorticity.uniforms.uCurl.value=_fbos.curl.fbo,_scenes.vorticity.uniforms.curl.value=config.CURL,_scenes.vorticity.render(_fbos.velocity.write),_fbos.velocity.swap(),_scenes.divergence.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.divergence.render(_fbos.divergence.fbo),_scenes.clear.uniforms.uTexture.value=_fbos.pressure.read,_scenes.clear.uniforms.value.value=updateParamsHz(config.PRESSURE_DISSIPATION),_scenes.clear.render(_fbos.pressure.write),_fbos.pressure.swap(),_scenes.pressure.uniforms.uDivergence.value=_fbos.divergence.fbo;for(let i=0;i<config.PRESSURE_ITERATIONS;i++)_scenes.pressure.uniforms.uPressure.value=_fbos.pressure.read,_scenes.pressure.render(_fbos.pressure.write),_fbos.pressure.swap();_scenes.gradientSubtract.uniforms.uPressure.value=_fbos.pressure.read,_scenes.gradientSubtract.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.gradientSubtract.render(_fbos.velocity.write),_fbos.velocity.swap(),_scenes.advection.uniforms.texelSize.value.set(1/SIM_WIDTH,1/SIM_HEIGHT),_scenes.advection.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.advection.uniforms.uSource.value=_fbos.velocity.read,_scenes.advection.uniforms.dissipation.value=updateParamsHz(config.VELOCITY_DISSIPATION),_scenes.advection.render(_fbos.velocity.write),_fbos.velocity.swap(),_scenes.advection.uniforms.texelSize.value.set(1/DYE_WIDTH,1/DYE_HEIGHT),_scenes.advection.uniforms.uVelocity.value=_fbos.velocity.read,_scenes.advection.uniforms.uSource.value=_fbos.density.read,_scenes.advection.uniforms.dissipation.value=updateParamsHz(config.DENSITY_DISSIPATION),_scenes.advection.render(_fbos.density.write),_fbos.density.swap(),_scenes.display.uniforms.uTexture.value=_fbos.density.read,_scenes.display.uniforms.texelSize.value.set(1/_rect.width,1/_rect.height),_scenes.display.render(_this.rt)}this.rt=Utils3D.createRT(_rect.width,_rect.height),this.fbos=_fbos,this.additiveBlending=!0,_this.rt.disableDepth=!0,function initFBOs(){_fbos.density=_this.initClass(FluidFBO,DYE_WIDTH,DYE_HEIGHT,Texture.LINEAR),_fbos.velocity=_this.initClass(FluidFBO,SIM_WIDTH,SIM_HEIGHT,Texture.LINEAR),_fbos.divergence=_this.initClass(FluidFBO,SIM_WIDTH,SIM_HEIGHT,Texture.NEAREST),_fbos.curl=_this.initClass(FluidFBO,SIM_WIDTH,SIM_HEIGHT,Texture.NEAREST),_fbos.pressure=_this.initClass(FluidFBO,SIM_WIDTH,SIM_HEIGHT,Texture.NEAREST)}(),function initScenes(){_scenes.curl=_this.initClass(FluidScene,"fluidBase","curlShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uVelocity:{value:null},depthWrite:!1}),_scenes.vorticity=_this.initClass(FluidScene,"fluidBase","vorticityShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uVelocity:{value:null},uCurl:{value:null},curl:{value:config.CURL},dt:{value:1/Render.REFRESH_RATE}}),_scenes.divergence=_this.initClass(FluidScene,"fluidBase","divergenceShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uVelocity:{value:null}}),_scenes.clear=_this.initClass(FluidScene,"fluidBase","clearShader",{uTexture:{value:null},value:{value:config.PRESSURE_DISSIPATION}}),_scenes.pressure=_this.initClass(FluidScene,"fluidBase","pressureShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uPressure:{value:null},uDivergence:{value:null}}),_scenes.gradientSubtract=_this.initClass(FluidScene,"fluidBase","gradientSubtractShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uPressure:{value:null},uVelocity:{value:null}}),_scenes.advection=_this.initClass(FluidScene,"fluidBase","advectionShader",{texelSize:{value:new Vector2(1/SIM_WIDTH,1/SIM_HEIGHT)},uVelocity:{value:null},uSource:{value:null},dt:{value:1/Render.REFRESH_RATE},dissipation:{value:config.VELOCITY_DISSIPATION}}),_scenes.display=_this.initClass(FluidScene,"fluidBase","displayShader",{texelSize:{value:new Vector2(1/_rect.width,1/_rect.height)},uTexture:{value:null}}),_scenes.splat=_this.initClass(FluidScene,"fluidBase","splatShader",{uTarget:{value:null},aspectRatio:{value:_rect.width/_rect.height},point:{value:new Vector2},prevPoint:{value:new Vector2},color:{value:new Vector3},bgColor:{value:new Color("#000000")},radius:{value:config.SPLAT_RADIUS/100},canRender:{value:0},uAdd:{value:1}})}(),_this.startRender(loop),this.updateConfig=function(key,value){config[key]=value},this.drawInput=function(x,y,dx,dy,color,radius=config.SPLAT_RADIUS,independent){_scenes.splat.uniforms.uTarget.value=_fbos.velocity.read,_scenes.splat.uniforms.radius.value=radius/200,_scenes.splat.uniforms.aspectRatio.value=_rect.width/_rect.height,_tmpVec.set(x/_rect.width,1-y/_rect.height);let now=Render.TIME,delta=now-_lastSplat;_lastSplat=now,delta>50||independent?_scenes.splat.uniforms.prevPoint.value.copy(_tmpVec):_scenes.splat.uniforms.prevPoint.value.copy(_scenes.splat.uniforms.point.value),_scenes.splat.uniforms.point.value.copy(_tmpVec),_scenes.splat.uniforms.color.value.set(dx,-dy,1),_scenes.splat.uniforms.uAdd.value=1,_scenes.splat.render(_fbos.velocity.write),_fbos.velocity.swap(),_scenes.splat.uniforms.uTarget.value=_fbos.density.read,_scenes.splat.uniforms.color.value.set(color.r,color.g,color.b),_scenes.splat.uniforms.uAdd.value=_this.additiveBlending?1:0,_scenes.splat.render(_fbos.density.write,!0),_fbos.density.swap(),_scenes.splat.uniforms.canRender.value=1}})),Class((function FluidFBO(_width,_height,_filter){Inherit(this,Component);const _this=this,type=Device.mobile||Renderer.type!=Renderer.WEBGL1?Texture.HALF_FLOAT:Texture.FLOAT;var _fbo1=new RenderTarget(_width,_height,{minFilter:_filter,magFilter:_filter,format:Texture.RGBAFormat,type:type}),_fbo2=new RenderTarget(_width,_height,{minFilter:_filter,magFilter:_filter,format:Texture.RGBAFormat,type:type});this.fbo=_fbo1,this.uniform={value:_fbo1},_fbo1.disableDepth=!0,_fbo2.disableDepth=!0,_fbo1.generateMipmaps=!1,_fbo2.generateMipmaps=!1,this.swap=function(){let temp=_fbo1;_fbo1=_fbo2,_fbo2=temp,_this.uniform.value=_fbo1},this.get("read",(_=>_fbo1)),this.get("write",(_=>_fbo2))})),Class((function FluidLayer(_input,_group){Inherit(this,Object3D);var _fluid,_config,_this=this;!function initConfig(){_this.uilInput=_input,_this.uilGroup=_group,(_config=InputUIL.create(_input.prefix+"fluid",_group)).setLabel("Fluid Config"),_config.add("dyeSize",512),_config.add("simSize",128),_config.add("velocity",.98),_config.add("density",.97),_config.add("pressure",.8),_config.add("iterations",5),_config.add("curl",30),_config.add("defaultRadius",25),_config.addToggle("debugMouse",!1)}(),function initFluid(){let rect=Stage,wildcard=_input.get("wildcard");if(wildcard&&wildcard.includes("x")){let split=wildcard.split("x");rect={width:Number(split[0]),height:Number(split[1])}}_fluid=_this.initClass(Fluid,_config.getNumber("simSize"),_config.getNumber("dyeSize"),rect),_this.rt=_fluid.rt,_this.fbos=_fluid.fbos,_config.onUpdate=key=>{switch(key){case"velocity":_fluid.updateConfig("VELOCITY_DISSIPATION",_config.getNumber(key));break;case"density":_fluid.updateConfig("DENSITY_DISSIPATION",_config.getNumber(key));break;case"pressure":_fluid.updateConfig("PRESSURE_DISSIPATION",_config.getNumber(key));break;case"iterations":_fluid.updateConfig("PRESSURE_ITERATIONS",_config.getNumber(key));break;case"curl":_fluid.updateConfig("CURL",_config.getNumber(key));break;case"defaultRadius":_fluid.updateConfig("SPLAT_RADIUS",_config.getNumber(key));break;case"debugMouse":_fluid.updateConfig("DEBUG_MOUSE",_config.get(key))}},["velocity","density","pressure","iterations","curl","defaultRadius","debugMouse"].forEach(_config.onUpdate)}(),this.initMesh=function initMesh(){let shader=_this.initClass(Shader,"ScreenQuad",{tMap:{value:_fluid.rt}}),mesh=new Mesh(World.QUAD,shader);_this.add(mesh),_this.mesh=mesh},this.drawInput=_fluid.drawInput,this.set("additiveBlending",(v=>_fluid.additiveBlending=v)),this.applyTo=function(shader){shader.uniforms.tFluid=_this.fbos.velocity.uniform,shader.uniforms.tFluidMask={value:_this}}})),Class((function FluidScene(_vs,_fs,_uniforms){Inherit(this,Component);const _this=this;var _scene=new Scene;!function(){_uniforms.depthWrite=!1;let shader=_this.initClass(Shader,_vs,_fs,_uniforms),mesh=new Mesh(World.QUAD,shader);shader.depthWrite=!1,mesh.noMatrices=!0,_scene.add(mesh),_this.uniforms=shader.uniforms}(),this.render=function(rt){World.RENDERER.autoClear=!1,World.RENDERER.renderSingle(_scene.children[0],World.CAMERA,rt),World.RENDERER.autoClear=!0}})),Class((function FXAA(){Inherit(this,NukePass);this.uniforms={tMask:{value:null}},this.init("FXAA","FXAA"),this.setMask=function(texture){this.uniforms.tMask.value=texture}})),Class((function FXScroll(_params={}){Inherit(this,Object3D);const _this=this;var $element,_transitionShader,_renderManager,_views=[];function loop(){_renderManager.render();for(let i=_views.length-1;i>-1;i--){let view=_views[i];if(null!=view.scrollNormal&&view.__scrollCamera){let camera=view.__scrollCamera,y=view.__scrollY;camera.group.position.y=y*view.scrollNormal}}let scroll=_renderManager.controller.overallScroll;scroll>0&&(_this.progress=scroll)}function findRouter(){let p=_this.parent;for(;p;){if(p.getState)return p;p=p.parent}}function navigate(view){let route=view.__scrollRoute;if(route)findRouter()?.navigate(route);else{let privateRoute=view.__privateRoute;privateRoute&&(findRouter()?.replaceState(""),AppState.set("Router/state",privateRoute))}}async function initRoute(){if(_this.flag("initializing"))return;if(_this.flag("initializing",!0,2e3),_views.length||await _this.wait((_=>!!_views.length)),await defer(),_this._invisible)return;let router=findRouter();if(router.virtualRoutes=!0,!router)return;let state=router.getState();AppState.set("Router/state",state),state&&state.includes("/")&&(state=state.split("/")[0]),async function sortAndInitialize(state){let foundFirst=!1,sortedViews=[..._views];_params.initializeSort&&(sortedViews.forEach((view=>{view.__scrollRoute==state&&(view.__initIndex=0,foundFirst=view)})),foundFirst||(sortedViews[0].__initIndex=0,foundFirst=sortedViews[0]),sortedViews.forEach((view=>{if(null==view.__initIndex){let myIndex=_views.indexOf(view),firstIndex=sortedViews.indexOf(foundFirst);view.__initIndex=Math.abs(myIndex-firstIndex)}})),sortedViews.sort(((a,b)=>a.__initIndex-b.__initIndex))),sortedViews.forEach((async(ref,i)=>{ref.nuke&&await Initializer3D.uploadNuke(ref.nuke);const group=ref.layout||ref.scene||ref.group||ref.element?.group;group&&(await Initializer3D.detectUploadAll(group,0==i),i==sortedViews.length-1&&AppState.set("FXScroll/initialized",!0),0==i&&AppState.set("FXScroll/firstScene"))}))}(state);for(let i=0;i<_views.length;i++){let view=_views[i];if(view.__scrollRoute==state)return void(_renderManager.controller.scroll=view.start+20)}navigate(_views[0])}function resizeHandler(){_transitionShader.set("uRatio",Stage.width/Stage.height)}function handleViewChange({view:view}){_this.flag("initializing")||navigate(view)}this.views=_views,this.progress=0,function initHTML(){($element=Stage.create("FXScroll")).css({position:"fixed",top:0,left:0,width:"100%",height:"100%",zIndex:2}),$element._scrollParent=!0,_this.element=$element}(),function initLogic(){_transitionShader=_this.initClass(Shader,"FXScrollTransition",{tMap1:{value:null},tMap2:{value:null},uRatio:{value:Stage.width/Stage.height},uTransition:{value:0},uVelocity:{value:0},uAngle:{value:_params.angle||0}}),_renderManager=_this.initClass(ScrollRenderManager,_this,_transitionShader,{container:$element,keyboard:void 0===_params.keyboard||"boolean"!=typeof _params.keyboard||_params.keyboard,smoothScroll:!0,pingPong:_params.pingPong||!1}),_this.events.sub(_renderManager.controller,ScrollController.VIEW_CHANGE,handleViewChange)}(),_this.startRender(loop),_this.onResize(resizeHandler),this.onVisible=function(){initRoute()},this.scrollTo=function(scroll,time){if(time>0){let v={value:_renderManager.controller.scroll};tween(v,{value:scroll.start?scroll.start+20:scroll},time,"linear").onUpdate((_=>{_renderManager.controller.scroll=v.value}))}else _renderManager.controller.scroll=scroll.start?scroll.start+20:scroll},this.parent.lockScroll=function(){_renderManager.controller.lock()},this.parent.unlockScroll=function(){_renderManager.controller.unlock()},this.parent._initFXScroll=async function(list){for(let i=0;i<list.length;i++){let obj=list[i];for(let key in obj){let value=obj[key];"$"==value.charAt?.(0)&&(await _this.wait(_this.parent,value.slice(1)),obj[key]=_this.parent[value.slice(1)])}let view=obj.view;view.__scrollElement=$("scrollElement");let vh=obj.vh;_params.pageScalar&&(vh*=_params.pageScalar),view.__scrollElement.size("100%",105*Number(Math.max(1,vh))+"vh").css({position:"absolute"}),obj.cameraLayer&&view.layout?.getLayer(obj.cameraLayer).then((camera=>{view.__scrollCamera=camera})),obj.route&&(view.__scrollRoute=obj.route),obj.privateRoute&&(view.__privateRoute=obj.privateRoute),obj.cameraMove&&(view.__scrollY=Number(obj.cameraMove)),_views.push(view),$element.add(view.__scrollElement),view.attachElementToScroll=el=>view.__scrollCamera.add(el)}_renderManager.show(_this),initRoute()}})),Class((function FXScrollUI(){let fxScrollRoot,p=this.parent;for(;p;)p.scene instanceof Scene&&(fxScrollRoot=p),p=p.parent;fxScrollRoot.scrollContainer=this.element,this.element.visible=!1})),Class((function ScrollController(_object,_params){Inherit(this,Component);const _this=this;var _virtualScroll,_views;this.position=0,this.last=0,this.delta=0,this.direction=0,this.index1=0,this.index2=0,this.progress=0;var _index=0,_bottomScrolled=!1,_timer=null,_virtualValue=0,_totalHeight=0,_lerpSpeed=Device.mobile?1:.1;function debounceResize(){Utils.debounce(resize,250)}function removeHandlers(){_this.events.unsub(Events.RESIZE,debounceResize),_this.stopRender(loop),_this.events.unsub(Keyboard.DOWN,keydown)}function keydown(e){if(_views)switch(e.code){case"Tab":!function handleTabNav(){if(_params.virtualScroll&&!_this.smoothScroll)return;defer((()=>{}))}();break;case"ArrowUp":moveScroll(-.25*Stage.height);break;case"ArrowDown":moveScroll(.25*Stage.height);break;case"Space":moveScroll(.4*Stage.height)}}function moveScroll(s){(_params.keyboard||_params.virtualScroll)&&(_params.virtualScroll?_virtualValue+=Math._round(s):_this.object.div.scrollTop+=Math._round(s))}async function resize(){if(_views&&!_this._invisible){if(_totalHeight=0,_virtualScroll)_views.forEach((view=>{view.start=_totalHeight;let height=view.height;view.end=view.start+view.height,_totalHeight+=height}));else{await defer(),_views.forEach((async view=>{let layout=view.__scrollElement;layout.ready&&await layout.ready(),layout.css({top:_totalHeight}),view.start=_totalHeight,layout.start=_totalHeight;let height=layout.div.getBoundingClientRect().height;view.height=height,layout.height=height,_totalHeight+=height,view.end=view.start+view.height,layout.parallax&&layout.willChange("transform")}));__body}update()}}function loop(){_this.flag("active")&&(_virtualScroll?(_virtualValue+=.7*_virtualScroll.delta.y,_params.infinite||(_virtualValue=Math.clamp(_virtualValue,0,_totalHeight)),_this.position=Math.lerp(_virtualValue,_this.position,_lerpSpeed)):_this.smoothScroll?_this.position=Math.floor(Math.lerp(_this.object.div.scrollTop,_this.position,_lerpSpeed)):_this.position=_this.object.div.scrollTop,_this.delta=_this.position-_this.last,_this.last=_this.position,_this.direction=Math.sign(_this.delta),_this.overallScroll=Math.range((_this.position+Stage.height)/_totalHeight,.03,1,0,1,!0),update())}!function initParams(){_params||(_params={}),_this.object=_object,_this.object.overflowScroll({y:!0}),_this.smoothScroll=!1!==_params.smoothScroll}(),function style(){_params.virtualScroll||(_this.smoothScroll?_this.object.css({position:"fixed",top:0,left:0,width:"100%",height:"100%",overflowY:"scroll"}):_this.object.css({width:"100%"}))}(),_params.virtualScroll&&(_virtualScroll=Scroll.createUnlimited());let _sec=new Array(3);function update(){if(!_views)return;if(_params.infinite)return function updateInfinite(){let offset=_views[1].start;if(!offset)return;let height=_totalHeight,prevActiveView=_views[_this.index1];prevActiveView&&(prevActiveView.active=!1),_sec[0]=Math.floor(Math.mod(_this.position,height)/offset),_sec[2]=Math.floor(Math.mod(_this.position+Stage.height,height)/offset),_this.index1=_sec[0],_this.index2=_sec[2];let extraPadding=Stage.height/offset;if(1===extraPadding&&(extraPadding=0),_this.progress=Math.range(Math.fract(_this.position/offset),extraPadding,1,0,1,!0),_views[_this.index1].active=!0,parallax(_views[_this.index1]),parallax(_views[_this.index2]),_index!==_this.index1){_index=_this.index1;let event={};event.index=_index,event.direction=_this.direction,event.view=_views[_index],_this.events.fire(ScrollController.VIEW_CHANGE,event)}}();_this.smoothScroll;let prevActiveView=_views[_this.index1];prevActiveView&&(prevActiveView.active=!1);let height=0;for(let i=0,l=_views.length;i<l;i++){let view=_views[i];if(height+=view.height,view.scrollNormal=-1,view.scrollProgress=0,view.scrollContainer&&(view.scrollContainer.visible=!1),_this.position<height){_this.index1=i,_this.index2=i+1,_this.index2>l-1&&(_this.index2=l-1);break}}let current=Math.max(_this.position+Stage.height-_views[_this.index2].start,0);if(_this.progress=current/Stage.height,_views[_this.index1].active=!0,parallax(_views[_this.index1]),parallax(_views[_this.index2]),_index!==_this.index1){_index=_this.index1;let event={};event.index=_index,event.direction=_this.direction,event.view=_views[_index],_this.events.fire(ScrollController.VIEW_CHANGE,event)}Math.abs(_totalHeight-Stage.height-_this.position)<.2*Stage.height?_bottomScrolled||(_bottomScrolled=!0,_timer=_this.delayedCall((()=>{let event={};event.index=_this.index2,event.direction=1,event.view=_views[_this.index2],_this.events.fire(ScrollController.BOTTOM,event)}),850)):(_timer&&(clearTimeout(_timer),_timer=null),_bottomScrolled&&(_bottomScrolled=!1))}function parallax(view){let current=0,progress=0;if(_params.infinite){let pos=_this.position+Stage.height-view.start;current=Math.fract(pos/_totalHeight)*_totalHeight,progress=Math.clamp(current/(view.height+Stage.height),0,1)}else current=_this.position+Stage.height-view.start,progress=Math.clamp(current/(view.height+Stage.height),0,1);isNaN(progress)&&(progress=0),view.scrollProgress=progress,view.scrollNormal=Math.range(progress,0,1,1,-1),view.scrollDirection=_this.direction,view.scrollTransition=_this.progress;let layout=view.ui||view,currentScroll=_this.scroll;if(layout.scrollContainer&&progress>0){let target=view.start-currentScroll;if(null!=layout.scrollContainer.stickyY)if(null!=layout.scrollContainer.releaseY){let percent=layout.scrollContainer.releaseY*Stage.height/view.height;if(view.scrollProgress>percent){let pixels=(view.scrollProgress-percent)*view.height;target=layout.scrollContainer.stickyY*Stage.height-pixels}else target=Math.max(layout.scrollContainer.stickyY*Stage.height,target)}else target=Math.max(layout.scrollContainer.stickyY*Stage.height,target);layout.scrollContainer.y=Math.lerp(target,layout.scrollContainer.y,_lerpSpeed),layout.scrollContainer.fxScrollSetup?layout.scrollContainer.show():(layout.scrollContainer.fxScrollSetup=!0,layout.scrollContainer.y=target),layout.scrollContainer.transform&&layout.scrollContainer.transform()}}this.get("totalHeight",(()=>_totalHeight)),this.get("scroll",(_=>_params.virtualScroll?_virtualValue:_this.object.div.scrollTop)),this.set("scroll",(s=>{_params.virtualScroll?_virtualValue=Math._round(s):_this.object.div.scrollTop=Math._round(s)})),this.show=function(page){_this.smoothScroll&&_params.virtualScroll,page,_views=page.views,_this.scroll=0,_this.position=0,_virtualValue=0,resize(),function addHandlers(){_this.events.sub(Events.RESIZE,debounceResize),_this.startRender(loop),_this.events.sub(Keyboard.DOWN,keydown)}(),_this.flag("active",!0)},this.hide=function(page){removeHandlers(),_this.flag("active",!1)},this.lock=function(){_params.virtualScroll||_this.object.css({overflow:"hidden"})},this.unlock=function(){_params.virtualScroll||_this.object.css({overflowY:"scroll"})},this.onDestroy=function(){removeHandlers()}}),(_=>{ScrollController.VIEW_CHANGE="smooth_view_change",ScrollController.BOTTOM="smooth_bottom",ScrollController.TOP="smooth_top"})),Class((function ScrollRenderManager(object,transitionShader,params){Inherit(this,Component);const _this=this;var _mesh,_controller,_views,_index1=0,_index2=0,_renderCount=0;function onScrollControllerViewChange(e){_this.events.fire(_this.VIEW_CHANGE,e)}function onScrollControllerBottom(e){_this.events.fire(_this.BOTTOM,e)}function onScrollControllerTop(e){_this.events.fire(_this.TOP,e)}this.VIEW_CHANGE="ScrollControllerRenderManager_view_change",this.BOTTOM="ScrollControllerRenderManager_bottom",this.TOP="ScrollControllerRenderManager_top",this.initialize=function(object,transitionShader,params={}){_this.initClass(Shader,"ScreenQuad",{tMap:{value:null}}),_this.transitionShader=transitionShader,(_mesh=new Mesh(World.QUAD,_this.transitionShader)).frustumCulled=!1,object.add(_mesh),_controller=_this.initClass(ScrollController,params.container,params),_this.events.sub(_controller,ScrollController.VIEW_CHANGE,onScrollControllerViewChange),_this.events.sub(_controller,ScrollController.BOTTOM,onScrollControllerBottom),_this.events.sub(_controller,ScrollController.TOP,onScrollControllerTop),_this.controller=_controller,_this.pingPong=!1!==params.pingPong},this.render=function(){_views&&(_index1!==_controller.index1||_index2!==_controller.index2?(_views[_index1].rt&&(_views[_index1].visible=!1),_views[_index2].rt&&(_views[_index2].visible=!1),_index1=_controller.index1,_index2=_controller.index2,_views[_index1].rt&&(_views[_index1].visible=!0),_views[_index2].rt&&_controller.progress>0&&(_views[_index2].visible=!0)):_views[_index1].visible&&_views[_index2].visible||(_views[_index1].rt&&(_views[_index1].visible=!0),_views[_index2].rt&&_controller.progress>0&&(_views[_index2].visible=!0)),_this.transitionShader.set("tMap1",_views[_index1].rt?_views[_index1]:null),_this.transitionShader.set("tMap2",_views[_index2].rt?_views[_index2]:null),_this.transitionShader.set("uTransition",_controller.progress),null!=_controller.progress&&(_views[_index1].setScissor(0,0,1,1.3*Math.range(_controller.progress,0,1,1,0)),_views[_index2].setScissor(0,0,1,1.3*Math.range(_controller.progress,0,1,0,1),!0)),_this.pingPong?((0===(_renderCount=Math.abs(_renderCount-1))||_controller.progress<.01)&&_views[_index1].rt&&_views[_index1].draw(),1===_renderCount&&_views[_index2].rt&&_controller.progress>0&&_views[_index2].draw()):(_views[_index1].rt&&_views[_index1].draw(),_index1!==_index2&&_controller.progress>0&&_views[_index2].rt&&_views[_index2].draw()))},this.show=function(page){_controller.show(page),(_views=page.views).forEach((v=>{v.manualRender=!0,v.scrollContainer&&v.scrollContainer.hide(),v.visible=!1}))},this.hide=function(page){_controller.hide(page)},object&&this.initialize(object,transitionShader,params)})),Class((function GameCenter(){Inherit(this,Component);let _socket,_coords,_this=this,_id=Utils.timestamp();function getCoords(){if(!_this.useCoordinates)return _coords=[0,0],Promise.resolve();let promise=Promise.create();return navigator.geolocation.getCurrentPosition((data=>{_coords=[data.coords.latitude,data.coords.longitude],_this.events.fire(_this.LOCATED),promise.resolve()}),(error=>{_this.events.fire(_this.LOCATION_ERROR)})),promise}function connected(){_this.events.fire(_this.CONNECTED),_this.events.sub(_socket,"server_data",handleServerData),_this.flag("connected",!0)}function handleServerData(e){_this.events.fire(_this.SERVER_DATA,e)}this.userData={},this.useCoordinates=!1,this.ports=1,this.maxServerConnections=900,this.CONNECTED="gamecenter_connect",this.DISCONNECTED="gamecenter_disconnected",this.LOCATION_ERROR="gamecenter_location_error",this.LOCATED="gamecenter_located",this.DATA="gamecenter_data",this.START_GAME="gamecenter_start_game",this.END_GAME="gamecenter_end_game",this.LOST_CONNECTION="gamecenter_lost_connection",this.SERVER_DATA="gamecenter_server_data",this.BROADCAST="gamecenter_server_data",this.BLOCKED_ERROR="gamecenter_blocked_error",this.connect=async function(server){let port="number"==typeof this.ports?":"+(7e3+Math.random(0,this.ports-1)):"",connectTime=0;await(async _=>{let promise=Promise.create();if(_socket&&_socket.close(),!(Date.now()-connectTime<100))return connectTime=Date.now(),_this.server=server,_socket=new SocketConnection(server+port),_this.socket=_socket,_this.events.sub(_socket,SocketConnection.OPEN,(_=>{promise.resolve(),connected()})),_this.events.sub(_socket,SocketConnection.BLOCKED,(_=>{_this.events.fire(_this.BLOCKED_ERROR),AppState.set(_this.BLOCKED_ERROR,!0),_this.BLOCKED=!0})),_this.events.sub(_socket,SocketConnection.CLOSE,(_=>{_this.BLOCKED||(_this.flag("connected",!1),_this.events.fire(_this.LOST_CONNECTION,{reconnected:_=>_this.wait("connected")}))})),_this.events.sub(_socket,SocketConnection.ERROR,(_=>{_this.BLOCKED||(_this.flag("connected",!1),_this.events.fire(_this.LOST_CONNECTION,{reconnected:_=>_this.wait("connected")}))})),_this.events.sub(_socket,"broadcast",(e=>{_this.events.fire(_this.BROADCAST,e)})),promise})(),_this.flag("initialized",!0)},this.locateUser=function(){getCoords()},this.findRoom=async function(type="any",config){await _this.wait("initialized");let promise=Promise.create(),find=function(){_this.roundTrip("findAny",{coords:_coords,type:type,forceNewRoom:config.forceNewRoom},(async data=>{let room=new GameCenterRoom(data.id,_socket);type.includes("community")&&room.communityRoom();try{await room.join(config),promise.resolve(room)}catch(e){promise.reject()}}))};return _coords?find():getCoords().then(find),promise},this.joinRoom=async function(id,config,watcher){await _this.wait("initialized");try{let room=new GameCenterRoom(id,_socket);return id.includes("community")&&room.communityRoom(),await room.join(config,watcher),room}catch(e){throw"Couldn't join!"}},this.watchRoom=async function(id,watcher){await _this.wait("initialized");try{let room=new GameCenterRoom(id,_socket);return id.includes("community")&&room.communityRoom(),await room.watch(watcher),room}catch(e){throw"Couldn't join!"}},this.findNearby=async function(type="any"){await _this.wait("initialized");let promise=Promise.create();if(!this.useCoordinates)throw"findNearby requires user coords";let find=function(){_this.roundTrip("findNearby",{coords:_coords,type:type},(data=>{promise.resolve(data)}))};return _coords?find():getCoords().then(find),promise},this.roundTrip=function(evt,data,callback){let receive=e=>{_this.events.unsub(_socket,`${evt}_response`,receive),callback&&callback(e)};_this.events.sub(_socket,`${evt}_response`,receive),_socket.send(evt,data)},this.sendData=function(data={}){_socket&&(data.id=_id,_socket.send("server_data",data))},this.broadcast=function(data={}){_socket.send("broadcast",data)},this.locateServer=function(roomId){let promise=Promise.create();return _this.roundTrip("locate_server",{roomId:roomId},promise.resolve),promise},this.getRoomCount=async function(roomId){let promise=Promise.create();return _this.roundTrip("roomCount",{roomId:roomId},promise.resolve),promise},this.get("coords",(v=>{_coords=v})),this.get("coords",(_=>_coords))}),"static"),Class((function GameCenterPlayer(_id,_socket,_data,_initiator,_community){Inherit(this,Component);var _this=this,_evt={target:_this,id:_id},_results=[],_messages={},_lastMessage=Render.TIME;function sendPing(){if(_results.length>=3)return;let message={_ping:!0};message.id=Utils.timestamp(),message.outTime=Date.now(),message.to=_id,message.from=GameCenter.GCID,_messages[message.id]=message,_this.emit(message)}function handlePing(data){if(_messages[data.id]){let difference=Date.now()-data.inTime;_results.unshift(difference),_this.offset=difference,_results.length<3?sendPing():function calculate(){_this.flag("ready",!0),_this.events.fire(Events.READY),_results.length>3&&(_results=_results.slice(0,3)),_results.sort(((a,b)=>a-b)),_this.offset=_results[1]}()}else data.inTime=Date.now(),_this.emit(data)}function onMessage(data){if(!data.to||data.to==GameCenter.GCID){if(_this.ping=Render.TIME-_lastMessage,_lastMessage=Render.TIME,data._ping)return handlePing(data);_evt.player=_this,_evt.data=data,_this.events.fire(GameCenter.DATA,_evt)}}function ready(e){_this.connection.isNull||_this.parent.flag("watcher")||(e.socket&&_this.events.fire(GameCenterPlayer.FALLBACK_SOCKET),_this.delayedCall((()=>{sendPing()}),10))}this.connection=_this.initClass(_community?GameCenterNull:GameCenterRTC,_id,_socket,_initiator,_this),this.id=_id,this.data=_data,this.offset=0,this.ping=0,function addListeners(){_this.connection.isNull||(_this.events.sub(_this.connection,Events.READY,ready),_this.events.bubble(_this.connection,Events.ERROR),_this.connection.onMessage=onMessage)}(),this.onMessage=onMessage,this.emit=function(data){_this.connection.emit(data.length?data:JSON.stringify(data))},this.disconnect=function(){_this.connection.close(),_this.events.fire(GameCenter.DISCONNECTED)},this.connected=function(){return _this.wait("ready")},this.sever=function(){_this.videos?.forEach((v=>v.destroy()))}}),(_=>{GameCenterPlayer.UPDATE_DATA="gcp_update_data",GameCenterPlayer.FALLBACK_SOCKET="gcp_fallback_socket"})),Class((function GameCenterUser(_socket,_community){Inherit(this,Component);this.connection=new(_community?GameCenterSocket:GameCenterNull)(_socket),this.me=!0,this.data=GameCenter.userData,this.id=GameCenter.GCID,this.disconnect=function(){}})),Class((function GameCenterConnection(){Inherit(this,Component);this.establish=function(){},this.emit=function(){},this.wsData=function(){}})),Class((function GameCenterNull(){const prototype=GameCenterNull.prototype;void 0===prototype.establish&&(prototype.isNull=!0,prototype.establish=function(){},prototype.emit=function(){},prototype.wsData=function(){},prototype.close=function(){})})),Class((function GameCenterRTC(_id,_socket,_initiator,_parent){Inherit(this,Component);var _peer,_data,_fallbackSocket,_timeout,_this=this;function fallbackToSocket(){clearTimeout(_timeout),_socket.send("ws_data",{from:GameCenter.GCID,fallbackToSocket:!0}),_fallbackSocket=!0,_this.events.fire(Events.READY,{socket:!0})}function sendNegotiation(type,sdp){let data={to:_id,type:type,sdp:sdp};_socket.send("establish_rtc",data)}function dataMessage(e){_this.onMessage&&_this.onMessage(JSON.parse(e.data))}function dataOpen(e){_this.events.fire(Events.READY)}function dataClose(e){clearTimeout(_timeout),_this.events.fire(Events.ERROR,{gcID:_id})}function dataError(e){_this.events.fire(Events.ERROR,{gcID:_id})}!function initPeerConnection(){_peer=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),_timeout=_this.delayedCall(fallbackToSocket,7e3),_peer.onicecandidate=e=>{_peer&&e&&e.candidate&&sendNegotiation("candidate",e.candidate)},(_data=_peer.createDataChannel("gamecenter",{ordered:!1,negotiated:!0,id:7})).onmessage=dataMessage,_data.onopen=dataOpen,_data.onclose=dataClose,_data.onerror=dataError,_peer.ondatachannel=e=>{e.channel.onmessage=dataMessage,e.channel.onclose=dataClose,e.channel.onerror=dataError},_peer.onconnectionstatechange=e=>{switch(_peer.iceConnectionState){case"connected":_this.flag("connected",!0),clearTimeout(_timeout);break;case"disconnected":_this.flag("connected",!1)}},_peer.oniceconnectionstatechange=e=>{"failed"==_peer.iceConnectionState&&fallbackToSocket()}}(),_initiator&&async function initConnection(){let sdp=await _peer.createOffer();_peer.setLocalDescription(sdp),sendNegotiation("offer",sdp)}(),this.establish=function(data){if(_peer)switch(data.type){case"candidate":!function processIce(iceCandidate){if(!_this.flag("connected"))try{_peer.addIceCandidate(new RTCIceCandidate(iceCandidate))}catch(e){_this.events.fire(Events.ERROR,{gcID:_id})}}(data.sdp);break;case"offer":!async function processOffer(offer){if(!_this.flag("connected"))try{await _peer.setRemoteDescription(new RTCSessionDescription(offer));let sdp=await _peer.createAnswer();_peer.setLocalDescription(sdp).catch((e=>_this.events.fire(Events.ERROR,{gcID:_id}))),sendNegotiation("answer",sdp)}catch(e){}}(data.sdp);break;case"answer":!async function processAnswer(answer){if(!_this.flag("connected")){try{await _peer.setRemoteDescription(new RTCSessionDescription(answer))}catch(e){_this.events.fire(Events.ERROR,{gcID:_id})}return!0}}(data.sdp)}},this.emit=function(data){if("string"!=typeof data&&(data=JSON.stringify(data)),_fallbackSocket)_socket.sendBinary(data);else{if(_data&&"open"!=_data.readyState)return;try{_data&&_data.send(data)}catch(e){}}},this.wsData=function(data){if(data.fallbackToSocket)return _fallbackSocket=!0,void _this.events.fire(Events.READY);_this.onMessage&&_this.onMessage(data)},this.close=function(){_peer&&(_peer.close(),_peer.onconnectionstatechange=null,_peer.ondatachannel=null,_peer.oniceconnectionstatechange=null,_peer.onicecandidate=null,_peer=null,clearTimeout(_timeout))}})),Class((function GameCenterSocket(_socket){Inherit(this,Component);this.emit=function(data={}){_socket.sendBinary(data)}})),Class((function GameCenterRoom(_id,_socket){Inherit(this,Component);const _this=this;var _aliveTimer,_fallbackSocket,_roomConfig;this.id=_id,this.host=!1,this.players=[];var _waiting={},_pending=[],_playerMap=new Map,_players=_this.players;function handlePlayers(players){let player;players.forEach(((obj,i)=>{obj.id==GameCenter.GCID?player=new GameCenterUser(_socket,_this.isCommunity):(player=_playerMap.get(obj.id),player||(player=createPlayer(obj.id,obj.data),_playerMap.set(obj.id,player))),_players[i]=player}))}function createPlayer(id,data,init){data.data&&(data=data.data);let player=_this.initClass(GameCenterPlayer,id,_socket,data,init,_this.isCommunity);return _this.events.sub(player,GameCenter.DATA,playerData),_this.events.sub(player,Events.ERROR,playerDisconnect),_this.events.sub(player,GameCenterPlayer.FALLBACK_SOCKET,fallbackSocket),_this.events.sub(player,Events.READY,(async()=>{await defer(),_this.events.fire(GameCenterRoom.PLAYER_READY,{player:player})})),_waiting[id]&&_waiting[id].resolve(player),player}function fallbackSocket(){_fallbackSocket=!0}function alive(){_socket.send("alive"),Render.blurTime>0&&Date.now()-Render.blurTime>(_roomConfig.timeoutDisconnect||6e6)&&(forceDisconnect(),_this.leave&&_this.leave())}function requestInitialState(){if(_this.events)try{_socket.send("request_state")}catch(e){setTimeout(requestInitialState,50)}}function addListeners(){_this.events.sub(_socket,"player_disconnect",playerDisconnect),_this.events.sub(_socket,"become_host",becomeHost),_this.events.sub(_socket,"open_connection",openConnection),_this.events.sub(_socket,"establish_rtc",establishRTC),_this.events.sub(_socket,"ws_data",websocketData),_this.events.sub(_socket,"promote_watcher",promoteWatcher),_this.events.sub(_socket,"rebroadcast_players",rebroadcastPlayers),_this.events.sub(_socket,"start_game",startGame),_this.events.sub(_socket,"end_game",endGame),_this.events.sub(_socket,"force_disconnect",forceDisconnect),_this.events.sub(_socket,"update_user_data",updateUserData),_this.events.sub(_socket,"pin",handlePin),_this.events.sub(_socket,"unpin",handleUnpin),_this.events.sub(GameCenter.LOST_CONNECTION,closeRoom),_this.events.sub(_socket,SocketConnection.BINARY,communityData)}function updateUserData({data:data}){_players.forEach((player=>{player.id==data.gcID&&(player.data=data.data,player.data.data&&(player.data=player.data.data),player.events.fire(GameCenterPlayer.UPDATE_DATA,{player:player,data:player.data}))}))}function forceDisconnect(e){_this.events.fire(GameCenterRoom.ERROR)}function closeRoom(){_this.destroy()}function startGame(e){_this.events.fire(GameCenter.START_GAME,e),_this.playing=!0}function endGame(e){_this.events.fire(GameCenter.END_GAME,e),_this.playing=!1}function establishRTC(e){let found=!1;if(_players.forEach((player=>{player.id==e.from&&(found=!0,player.connection.establish(e))})),!found){let player=createPlayer(e.from,e.data);_players.push(player),_playerMap.set(e.gcID,player),player.connection.establish(e)}}function playerDisconnect(e){_playerMap.delete(e.gcID),_players.forEach((player=>{player.id==e.gcID&&(player.disconnect(),_players.remove(player),_this.events.fire(GameCenterRoom.PLAYER_DISCONNECT,{player:player}),player.destroy())}))}function becomeHost(e){_this.host=!0,_this.events.fire(GameCenterRoom.BECOME_HOST)}function rebroadcastPlayers({data:data}){data.forEach((obj=>{obj.id!=GameCenter.GCID&&(obj.gcID=obj.id,openConnection(obj))}))}function openConnection(e){if(_playerMap.has(e.gcID))return;let player=createPlayer(e.gcID,e.data,!0);_playerMap.set(e.gcID,player),_players.push(player),_this.events.fire(GameCenterRoom.PLAYER_JOIN,{player:player})}function playerData(e){_this.events.fire(GameCenter.DATA,e)}function websocketData(e){let player=_playerMap.get(e.from);player&&player.connection.wsData(e)}function promoteWatcher(){_this.flag("canPromote")&&(_this.join(),_this.events.fire(GameCenterRoom.PROMOTED))}function communityData({data:data}){_pending.length=0;for(let i=data.length-1;i>-1;i--){let obj=data[i],player=_playerMap.get(obj.from);player&&!_pending.includes(obj.from)&&(player.onMessage(obj),_pending.push(obj.from))}}function handlePin(e){let player;_players.forEach((p=>{p.id==e.message.playerId&&(player=p)})),_this.events.fire(GameCenterRoom.PIN,{message:e.message,player:player})}function handleUnpin(e){let player;_players.forEach((p=>{p.id==e.message.playerId&&(player=p)})),_this.events.fire(GameCenterRoom.UNPIN,{message:e.message,player:player})}this.onDestroy=function(){this.leave&&this.leave()},this.updateUserData=function(data=GameCenter.userData){GameCenter.userData=data,GameCenter.GCID&&_socket.send("update_user_data",{gcID:GameCenter.GCID,data:data})},this.create=function(type,data={}){_this.host=!0,GameCenter.roundTrip("create",{id:_id,coords:GameCenter.coords,type:type,MAX_IN_ROOM:data.maxInRoom,TIMEOUT_DISCONNECT:data.timeoutDisconnect},_this.join)},this.join=function(data={}){if(_this.flag("joined"))return Promise.resolve();_this.flag("joined",!0),_this.flag("watching",!1);let promise=Promise.create();return(_roomConfig=data).timeoutDisconnect>0&&(_roomConfig.timeoutDisconnect=Math.max(_roomConfig.timeoutDisconnect,5e3)),GameCenter.roundTrip("join",{id:_id,user:GameCenter.userData,MAX_IN_ROOM:data.maxInRoom,TIMEOUT_DISCONNECT:data.timeoutDisconnect,type:data.type},(e=>{if(!e.success)return promise.reject();e.host&&(_this.host=!0),GameCenter.GCID=e.myID,handlePlayers(e.players),addListeners(),_aliveTimer=setInterval(alive,4e3),promise.resolve(),setTimeout(requestInitialState,500)})),promise},this.watch=function(canPromote){let promise=Promise.create();return _this.flag("canPromote",canPromote),_this.flag("watching",!0),GameCenter.roundTrip("watch",{id:_id,user:GameCenter.userData},(e=>{if(!e.success)return promise.reject();GameCenter.GCID=e.myID,handlePlayers(e.players),addListeners(),promise.resolve()})),promise},this.leave=function(){_this.leave=null,clearTimeout(_aliveTimer),_this.flag("joined",!1),_players.forEach((player=>player.disconnect())),GameCenter.roundTrip("leave",{id:_id,user:GameCenter.userData}),_this.destroy()},this.broadcast=function(data){if(_players.length&&!_this.flag("watching")){data.from=GameCenter.GCID,_fallbackSocket||_this.isCommunity||(data=JSON.stringify(data));for(let i=0;i<_players.length;i++)_players[i].connection.emit(data)}},this.start=function(data){_this.host&&_socket.send("start_game",data)},this.end=function(data){_this.host&&_socket.send("end_game",data)},this.pin=function(data,timeInSeconds=5){data.playerId=GameCenter.GCID,_socket.send("pin",{message:data,time:timeInSeconds,userData:GameCenter.userData,playerId:GameCenter.GCID})},this.unpin=function(data){data.playerId=GameCenter.GCID,_socket.send("unpin",{playerId:GameCenter.GCID,message:data})},this.communityRoom=function(){_this.isCommunity=!0},this.waitForPlayer=function(id){return _playerMap.has(id)?_playerMap.get(id):(_waiting[id]=Promise.create(),_waiting[id])},this.get("me",(_=>{for(let i=0;i<_players.length;i++){let player=_players[i];if(player.me)return player}})),this.get("watcher",(_=>_this.flag("watching")))}),(()=>{GameCenterRoom.PLAYER_DISCONNECT="gc_room_player_dc",GameCenterRoom.BECOME_HOST="gc_become_host",GameCenterRoom.PLAYER_JOIN="gc_player_join",GameCenterRoom.PLAYER_READY="gc_player_ready",GameCenterRoom.PROMOTED="gc_player_promoted",GameCenterRoom.ERROR="gc_room_error",GameCenterRoom.PIN="gc_room_pin",GameCenterRoom.UNPIN="gc_room_unpin"})),Module((function GenerateTube(){this.exports=function generate(numSides=8,subdivisions=50,openEnded=!1){let geom=new CylinderGeometry(1,1,1,numSides,subdivisions,openEnded);geom.applyMatrix((new Matrix4).makeRotationZ(Math.PI/2)),require("BufferToVertices").toVertices(geom);let tmpVec=new Vector2,xPositions=[],angles=[],uvs=[],vertices=geom.vertices,faceVertexUvs=geom.faceVertexUvs[0],indices=[];geom.faces.forEach(((face,i)=>{let{a:a,b:b,c:c}=face,verts=[vertices[a],vertices[b],vertices[c]],faceUvs=faceVertexUvs[i];verts.forEach(((v,j)=>{tmpVec.set(v.y,v.z).normalize();let angle=Math.atan2(tmpVec.y,tmpVec.x);angles.push(angle),xPositions.push(v.x),uvs.push(faceUvs[j].toArray()),indices.push(Math.abs(Math.round(Math.range(v.x,-.5,.5,0,subdivisions-1))))}))}));let posArray=new Float32Array(xPositions),angleArray=new Float32Array(angles),uvArray=new Float32Array(2*uvs.length);for(let i=0;i<posArray.length;i++){let[u,v]=uvs[i];uvArray[2*i+0]=u,uvArray[2*i+1]=v}let geometry=new Geometry;return geometry.addAttribute("position",new GeometryAttribute(new Float32Array(3*posArray.length),3)),geometry.addAttribute("angle",new GeometryAttribute(angleArray,1)),geometry.addAttribute("cIndex",new GeometryAttribute(new Float32Array(indices),1)),geometry.addAttribute("tuv",new GeometryAttribute(uvArray,2)),geometry.indexLookup=indices,geom.destroy(),geometry}})),Class((function GLA11y(){Inherit(this,Element);const _this=this;var $this,_groups=[],_links=[];function isVisible(group){if(group.__glseoParent){const seoHidden=!!group.__glseoParent.seoHidden,hidden=!!group.__glseoParent.hidden;return!seoHidden&&!hidden}return group.seo.enabled&&group.determineVisible()}function isDeleted(group){return group.__glseoParent?group.__glseoParent.deleted:group.deleted}function loop(){for(let i=_groups.length-1;i>-1;i--){let group=_groups[i];if(isDeleted(group))return $this.removeChild(group.seo),_groups.splice(i,1);isVisible(group)?(group.seo&&group.seo.hidden&&(group.seo.hidden=!1,$this.add(group.seo)),seo=group.seo,Array.prototype.slice.call(seo.div.children).forEach((div=>{let seo=div.hydraObject,group=seo&&seo.group;if(!seo||!group)return;let hidden=!group.determineVisible();hidden!==seo.hidden&&(hidden?seo.hide():seo.show(),seo.hidden=hidden)}))):group.seo&&!group.seo.hidden&&(group.seo.hidden=!0,$this.removeChild(group.seo,!0))}var seo;for(let i=_links.length-1;i>-1;i--){let group=_links[i];if(isDeleted(group))return $this.removeChild(group.seo),_groups.splice(i,1);isVisible(group)?group.seoHidden&&(group.seoHidden=!1,group.seoDOM.forEach((obj=>obj.show()))):group.seoHidden||(group.seoHidden=!0,group.seoDOM.forEach((obj=>obj.hide())))}}function aLink($object,url,label,options={}){let seo=$("link","a");return seo.group=$object.group||$object,seo.attr("href","#"===url?url:Hydra.absolutePath(url)),seo.text(label),seo.accessible(),seo.div.onfocus=_=>$object._divFocus(),seo.div.onblur=_=>$object._divBlur(),seo.div.onclick=e=>{e.preventDefault(),$object._divSelect()},options.role&&(seo.attr("role",options.role),seo.div.onkeydown=e=>{switch(e.key){case" ":case"Spacebar":e.preventDefault(),e.stopPropagation(),$object._divSelect()}}),seo}function findSeoParent($object,$suggestedParent){let parent=$suggestedParent||($object._3d?$object.anchor&&$object.anchor._parent?$object.anchor:$object.group:$object)._parent;if($object.parentSeo){let parentSeo=$object.parentSeo;parent=parentSeo.group&&parentSeo.group.seo?parentSeo.group:parentSeo}for(;parent&&!parent.seo;)if(parent.parentSeo)parent=parent.parentSeo.group||parent.parentSeo;else{if(parent.stageLayoutCapture?.parent?.$gluiObject)return findSeoParent(parent.stageLayoutCapture.parent.$gluiObject);parent=parent._parent}if(parent?.seo)return parent}function getInsertBeforeNode($object,parent,sortOrder){let before=null;if(!isNaN(sortOrder)){sortOrder=+sortOrder,$object.seo.sortOrder=sortOrder;let divs=parent.seo.children();for(let i=0;i<divs.length;++i){let div=divs[i];if(div.hydraObject.sortOrder>sortOrder){before=div;break}}}return before}function addSortOrderProperty($object,parent,initialSortOrder=$object.seo.sortOrder){let sortOrder=initialSortOrder;Object.defineProperty($object.seo,"sortOrder",{get:()=>sortOrder,set(nextSortOrder){if(nextSortOrder===sortOrder)return;sortOrder=nextSortOrder;let before=getInsertBeforeNode($object,parent,sortOrder);parent.seo.div.insertBefore($object.seo.div,before)}})}!async function(){window.GLSEO=_this,await Hydra.ready(),function initHTML(){($this=_this.element).setZ(-1),Stage.add($this)}(),HydraCSS.style(".GLA11y *",{position:"relative"})}(),this.registerPage=function(group,name){let topLevel=group;!(group=group instanceof GLUIObject?group:group.group||group.scene||group).determineVisible&&group.group&&(group.determineVisible=group.group.determineVisible.bind(group.group)),Global.PLAYGROUND||World.ELEMENT.mouseEnabled(!1),topLevel.seo=group.seo=$(name),group.seo.hidden=!0,group.seo.enabled=!0;let remove=group.seo.remove.bind(group.seo);group.seo.remove=_=>{_groups.remove(group),remove()},_groups.push(group),_this.startRender(loop,10)},this.setPageH1=function(group,title){let $h1=group.seo.h1;$h1||($h1=group.seo.create("title","h1"),group.seo.h1=$h1,defer((()=>{let el=$h1.div;el.parentNode.insertBefore(el,el.parentNode.firstChild)}))),$h1.text(title)},this.registerPersist=function(group,name){let topLevel=group;group=group instanceof GLUIObject?group:group.group||group.scene||group,Global.PLAYGROUND||World.ELEMENT.mouseEnabled(!1),topLevel.seo=group.seo=$this.create(name)},this.link=function($dom,group){$dom instanceof HydraObject&&((group=group.group||group.scene||group).seoDOM||(group.seoDOM=[]),group.seoDOM.push($dom),_links.push(group)),$dom instanceof GLUIObject&&($dom.seo=group.seo)},this.textNode=function($text,text,sortOrder){let parent=findSeoParent($text);if(parent)if($text.seo){if($text.seo.text(text),$text.seo.accessible(),!isNaN(sortOrder)&&$text.seo.sortOrder!==+sortOrder){let before=getInsertBeforeNode($text,parent,sortOrder);$text.seo.div.parentNode.insertBefore($text.seo.div,before)}}else{$text.seo=$("text"),$text.seo.group=$text.group,$text.seo.text(text),$text.seo.accessible();let before=getInsertBeforeNode($text,parent,sortOrder);parent.seo.add($text.seo,before?.hydraObject),addSortOrderProperty($text,parent),$text.seo.aLink=function(url,options){let index=Array.prototype.slice.call(parent.seo.div.children).indexOf($text.seo.div),sortOrder=$text.seo.sortOrder;$text.seo.remove(),$text.seo=aLink($text,url,text,options),parent.seo.div.insertBefore($text.seo.div,parent.seo.div.children[index]),addSortOrderProperty($text,parent,sortOrder)},$text.seo.unlink=function(){parent.seo.div.removeChild($text.seo.div),$text.seo.group=null,$text.seo=null}}},this.bindToPage=function(parent,child,name){child.__glseoParent=parent,_this.registerPage(child,name)},this.objectNode=function($object,$parent){let parent=findSeoParent($object,$parent);parent&&($object.seo||($object.seo={},$object.seo.group=$object.group||$object,$object.seo.aLink=function(url,label,options){$object.seo=aLink($object,url,label,options),parent.seo.div.insertBefore($object.seo.div,getInsertBeforeNode($object,parent,options?.sortOrder)),addSortOrderProperty($object,parent),$object.seo.unlink=function(){parent.seo.div.removeChild($object.seo.div),$object.seo.group=null,$object.seo=null}}))}}),"static"),Class((function GLScreenProjection(_camera=World.CAMERA,_target=new Vector2){Inherit(this,Object3D);var _this=this,_projection=new ScreenProjection(_camera),_m0=new Matrix4,_m1=new Matrix4;function loop(){_this.pos.set(_target.x,_target.y),_this.pos3D.copy(_projection.unproject(_this.pos)),_this.group.updateMatrixWorld(!0),_m0.copy(_camera.projectionMatrix),_m1.getInverse(_camera.matrixWorld),_this.matrix.multiplyMatrices(_m0,_m1),_this.uniforms.normalMatrix.value.copy(_camera.matrixWorld),_this.uniforms.modelMatrix.value.copy(_this.group.matrixWorld)}this.resolution=new Vector2,this.pos=new Vector2,this.pos3D=new Vector3,this.matrix=new Matrix4,this.uniforms={projMatrix:{type:"m4",value:this.matrix},pos:{type:"v2",value:this.pos},pos3D:{type:"v3",value:this.pos3D},normalMatrix:{type:"m4",value:new Matrix4},modelMatrix:{type:"m4",value:new Matrix4}},this.set("camera",(v=>{_camera=v,_projection.camera=_camera})),this.set("target",(v=>{_target=v})),this.update=loop,this.start=function(){_this.startRender(loop)},this.stop=function(){_this.stopRender(loop)}})),Class((function GLText({font:font,italic:italic=!1,bold:bold=!1,text:text,width:width=1/0,align:align="left",size:size=1,direction:direction="ltr",letterSpacing:letterSpacing=0,lineHeight:lineHeight=1,wordSpacing:wordSpacing=0,wordBreak:wordBreak=!1,langBreak:langBreak=!1,paragraphSpacing:paragraphSpacing=1,indent:indent=0,color:color=new Color("#000000"),alpha:alpha=1,shader:shader="DefaultText",customCompile:customCompile=!1}){const _this=this;var _override,_promise=Promise.create();const config=GLText.FONT_CONFIG[font];function overrideParams(){if(GLText.overrideParams){_override={letterSpacing:letterSpacing,size:size,wordSpacing:wordSpacing,lineHeight:lineHeight};let obj=GLText.overrideParams({letterSpacing:letterSpacing,size:size,wordSpacing:wordSpacing,lineHeight:lineHeight});letterSpacing=obj.letterSpacing,size=obj.size,wordSpacing=obj.wordSpacing,lineHeight=obj.lineHeight}}function resetOverride(){_override&&(letterSpacing=_override.letterSpacing,size=_override.size,wordSpacing=_override.wordSpacing,lineHeight=_override.lineHeight)}!function init(){overrideParams(),_this.charLength=text.length,_this.text=new GLTextGeometry({font:font,italic:italic,bold:bold,text:text,width:width,align:align,direction:direction,wordSpacing:wordSpacing,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,size:size,lineHeight:lineHeight,wordBreak:wordBreak,langBreak:langBreak,config:config,indent:indent}),_this.string=text,resetOverride(),_this.text.loaded.then((({buffers:buffers,texture:texture,textureBold:textureBold,textureItalic:textureItalic,height:height,numLines:numLines})=>{_this.texture=texture,bold&&(_this.textureBold=textureBold),italic&&(_this.textureItalic=textureItalic),_this.shader=new Shader(shader,{tMap:{value:_this.texture,ignoreUIL:!0},tMapBold:{value:_this.textureBold||Utils3D.getEmptyTexture(),ignoreUIL:!0},tMapItalic:{value:_this.textureItalic||Utils3D.getEmptyTexture(),ignoreUIL:!0},uColor:{value:color,ignoreUIL:!0},uAlpha:{value:alpha,ignoreUIL:!0},transparent:!0,customCompile:Utils.uuid()}),_this.onCreateShader&&_this.onCreateShader(_this.shader),function createGeometry(buffers){_this.geometry=new Geometry,_this.geometry.addAttribute("position",new GeometryAttribute(buffers.position,3)),_this.geometry.addAttribute("uv",new GeometryAttribute(buffers.uv,2)),_this.geometry.addAttribute("local",new GeometryAttribute(buffers.local,2)),_this.geometry.addAttribute("animation",new GeometryAttribute(buffers.animation,3)),_this.geometry.addAttribute("weight",new GeometryAttribute(buffers.weight,1)),_this.geometry.setIndex(new GeometryAttribute(buffers.index,1)),_this.geometry.boundingBox=buffers.boundingBox,_this.geometry.boundingSphere=buffers.boundingSphere,_this.geometry.letterCount=buffers.letterCount+1,_this.geometry.wordCount=buffers.wordCount+1,_this.geometry.lineCount=buffers.lineCount+1}(buffers),_this.mesh=new Mesh(_this.geometry,_this.shader),_this.height=height,_promise.resolve()}))}(),void 0===font&&console.log(font,text),this.destroy=function(){_this.mesh&&_this.mesh.destroy&&_this.mesh.destroy()},this.ready=this.loaded=function(){return _promise},this.centerY=function(){_this.mesh.position.y=.5*_this.height,_this.needsCenterY=!0},this.bottomY=function(){_this.mesh.position.y=_this.height,_this.needsBottomY=!0},this.resize=function(options){return this.setText(text,options)},this.tweenColor=function(c,time=300,ease="easeOutCubic"){c&&color.tween(c,time,ease)},this.setColor=function(c){c&&color.set(c)},this.setText=function(txt,options){if((text!=txt||!function match(options){return!options||options.font==font&&options.italic==italic&&options.bold==bold&&options.width==width&&options.align==align&&options.direction==direction&&!(options.wordSpacing>0&&options.wordSpacing!=wordSpacing)&&options.letterSpacing==letterSpacing&&options.paragraphSpacing==paragraphSpacing&&options.size==size&&options.indent==indent&&options.lineHeight==lineHeight&&!(!0===options.wordBreak&&!options.wordBreak||0==options.wordBreak&&options.wordBreak)}(options))&&(text=txt))return function setVars(options){font=options.font||font,bold=options.bold||bold,italic=options.italic||italic,width=options.width||width,align=options.align||align,wordSpacing=options.wordSpacing||wordSpacing,letterSpacing=options.letterSpacing||letterSpacing,paragraphSpacing=options.paragraphSpacing||paragraphSpacing,size=options.size||size,lineHeight=options.lineHeight||lineHeight,wordBreak=options.wordBreak||wordBreak,langBreak=options.langBreak||langBreak,direction=options.direction||direction,indent=options.indent||indent}(options||{}),overrideParams(),_this.string=text,_this.charLength=text.length,_this.text=new GLTextGeometry({font:font,italic:italic,bold:bold,text:text,width:width,align:align,direction:direction,wordSpacing:wordSpacing,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,size:size,lineHeight:lineHeight,wordBreak:wordBreak,langBreak:langBreak,config:config,indent:indent}),resetOverride(),_promise=Promise.create(),_this.text.loaded.then((({buffers:buffers,height:height})=>{!function updateGeometry(buffers){_this.geometry.attributes.position.setArray(buffers.position),_this.geometry.attributes.uv.setArray(buffers.uv),_this.geometry.attributes.animation.setArray(buffers.animation),_this.geometry.attributes.weight.setArray(buffers.weight),_this.geometry.index=buffers.index,_this.geometry.indexNeedsUpdate=!0,_this.geometry.boundingBox=buffers.boundingBox,_this.geometry.boundingSphere=buffers.boundingSphere,_this.geometry.letterCount=buffers.letterCount+1,_this.geometry.wordCount=buffers.wordCount+1,_this.geometry.lineCount=buffers.lineCount+1}(buffers),_this.height=height,_this.needsCenterY&&_this.centerY(),_this.needsBottomY&&_this.bottomY(),_promise.resolve()})),_promise},this.getData=function(){return{font:font,italic:italic,bold:bold,text:text,width:width,align:align,direction:direction,wordSpacing:wordSpacing,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,size:size,lineHeight:lineHeight,wordBreak:wordBreak,langBreak:langBreak,color:color,indent:indent}}}),(_=>{GLText.FONT_CONFIG={}})),Class((function GLTextGeometry({font:font,italic:italic,bold:bold,text:text,width:width=1/0,align:align="left",size:size=1,direction:direction="ltr",letterSpacing:letterSpacing=0,paragraphSpacing:paragraphSpacing=1,indent:indent=0,lineHeight:lineHeight=1.4,wordSpacing:wordSpacing=0,wordBreak:wordBreak=!1,langBreak:langBreak=!1,config:config={}}){let json,texture,glyphs,bJson,bTexture,bGlyphs,iJson,iTexture,iGlyphs,_this=this;_this.loaded=Promise.create(),_this.fontLoaded=Promise.create(),async function init(){await async function loadFont(){[json,texture,glyphs]=await GLTextGeometry.loadFont(font),bold&&([bJson,bTexture,bGlyphs]=await GLTextGeometry.loadFont(bold));italic&&([iJson,iTexture,iGlyphs]=await GLTextGeometry.loadFont(italic));_this.fontLoaded.resolve()}(),async function createGeometry(){let buffers=await GLTextThread.generate({font:font,bold:bold,italic:italic,text:text,width:width,align:align,size:size,direction:direction,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,indent:indent,lineHeight:lineHeight,wordSpacing:wordSpacing,wordBreak:wordBreak,langBreak:langBreak,json:json,glyphs:glyphs,bJson:bJson,bGlyphs:bGlyphs,iJson:iJson,iGlyphs:iGlyphs,config:config});_this.buffers=buffers,_this.texture=texture,_this.textureBold=bTexture,_this.textureItalic=iTexture,_this.numLines=buffers.lineLength,_this.height=_this.numLines*size*lineHeight,_this.onLayout&&_this.onLayout(buffers,texture,_this.height,_this.numLines),_this.loaded.resolve({buffers:buffers,texture:texture,textureBold:bTexture,textureItalic:iTexture,height:_this.height,numLines:_this.numLines})}()}()}),(_=>{async function loadJSON(font){return await get(function getPathTo(font,ext){let fontName=GLTextGeometry.fontMapping[font]||font,suffix=ext?`.${ext}`:"";return Assets.getPath(`${getFontPath(font)}${fontName}${suffix}`)}(font,"json"))}async function loadTexture(font){let base=`${getFontPath(font)}${font}`,path=[`${base}.ktx2`,Assets.supportsWebP()&&`${base}.webp`].filter(Boolean).find((candidate=>(window.ASSETS?.SW||[]).includes(candidate)))||`${base}.png`,texture=await Utils3D.getTexture(path);return texture.generateMipmaps=!1,texture.minFilter=Texture.LINEAR,texture}function getFontPath(font){return GLTextGeometry.fontMapping[font]&&GLTextGeometry.fontPath?GLTextGeometry.fontPath:"assets/fonts/"}let _promises={};GLTextGeometry.fontMapping={},GLTextGeometry.chars={},GLTextGeometry.loadFont=function(font){if(!_promises[font]){let promise=Promise.create();_promises[font]=promise,async function(){let[json,texture]=await Promise.all([loadJSON(font),loadTexture(font)]),glyphs={};json.chars.forEach((d=>glyphs[d.char]=d)),promise.resolve([json,texture,glyphs]),GLTextGeometry.chars[font]=json.chars}()}return _promises[font]}})),Class((function GLTextThread(){function loadTextGeometry({font:font,bold:bold,italic:italic,text:text,width:width,align:align,size:size,direction:direction,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,lineHeight:lineHeight,wordSpacing:wordSpacing,wordBreak:wordBreak,langBreak:langBreak,json:json,glyphs:glyphs,bJson:bJson,bGlyphs:bGlyphs,iJson:iJson,iGlyphs:iGlyphs,indent:indent,config:config},pid){const newline=/\n/,whitespace=/[^\S ]/,langbreak=!!langBreak&&new RegExp(langBreak),dir="rtl"===direction?-1:1;config||(config={}),config.boldBaseOffset=config.boldBaseOffset?config.boldBaseOffset:0,config.italicBaseOffset=config.italicBaseOffset?config.italicBaseOffset:0;let buffers,scale=size/json.common.base,weights=[],weight={0:glyphs,1:bGlyphs,2:iGlyphs};function getKernPairOffset(id1,id2){for(let i=0;i<json.kernings.length;i++){let k=json.kernings[i];if(!(k.first<id1)&&!(k.second<id2))return k.first>id1||k.first===id1&&k.second>id2?0:k.amount}return 0}!function setWeights(){let i=0,w=0;for(;i<text.length;){let code=text.substring(i,i+3).toLowerCase(),endcode=text.substring(i,i+4).toLowerCase();"<b>"!==code&&"<i>"!==code||(w="<b>"===code?1:2,text=text.substring(0,i)+text.substring(i+3)),"</b>"!==endcode&&"</i>"!==endcode||(w=0,text=text.substring(0,i)+text.substring(i+4)),weights.push(w),i++}}(),function createGeometry(){let numChars=text.replace(/[ \n]/g,"").length;buffers={position:new Float32Array(4*numChars*3),uv:new Float32Array(4*numChars*2),local:new Float32Array(4*numChars*2),animation:new Float32Array(3*numChars*4),index:new Uint16Array(6*numChars),weight:new Float32Array(4*numChars)};for(let i=0;i<numChars;i++)buffers.index.set([4*i,4*i+2,4*i+1,4*i+1,4*i+2,4*i+3],6*i);!function layout(){const lines=[];let cursor=0,wordCursor=0,wordWidth=0,line=newLine();function newLine(br=!1){const line={width:0,glyphs:[]};return lines.last()&&(lines.last().br=br),lines.push(line),wordCursor=cursor,wordWidth=0,line}for(;cursor<text.length;){let prev=text[cursor-1],char=text[cursor];if(!line.glyphs.length&&whitespace.test(char)&&!(prev&&newline.test(char)&&newline.test(prev))){cursor++,wordCursor=cursor,wordWidth=0;continue}if(newline.test(char)){cursor++,line=newLine(!0);continue}!cursor&&indent&&(line.width+=indent);let style=weight[weights[cursor]]||weight[0],glyph=style[char];if(glyph||(console.warn(`font ${font} missing character '${char}'`),char=Object.keys(style)[0],glyph=style[char]),glyph.weight=weights[cursor],line.glyphs.length){const prevGlyph=line.glyphs[line.glyphs.length-1][0];let kern=getKernPairOffset(glyph.id,prevGlyph.id)*scale;line.width+=kern,wordWidth+=kern*dir}let gl={...glyph};gl.weight=weights[cursor],line.glyphs.push([gl,line.width]);let advance=0;if(whitespace.test(char)?(gl.whitespace=!0,wordCursor=cursor,wordWidth=0,advance+=wordSpacing*size):advance+=letterSpacing*size,advance+=glyph.xadvance*scale,line.width+=advance,wordWidth+=advance,line.width>width){if((wordBreak||char&&langBreak&&!langbreak.test(char))&&line.glyphs.length>1){line.width-=advance,line.glyphs.pop(),line=newLine();continue}if(!wordBreak&&wordWidth!==line.width){let numGlyphs=cursor-wordCursor+1;line.glyphs.splice(-numGlyphs,numGlyphs),cursor=wordCursor,line.width-=wordWidth,line=newLine();continue}}cursor++}line.glyphs.length||lines.pop();if("justify"===align){let max=-1/0;lines.forEach((l=>{l.whitespaces=0,max<l.width&&(max=l.width),l.glyphs.forEach((g=>{g[0].whitespace&&l.whitespaces++}))})),lines.forEach((l=>{let totalToAdd=max-l.width,addToWhitespace=0===l.whitespaces?0:totalToAdd/l.whitespaces;l.width=max;let additionalOffset=0;l.glyphs.forEach((g=>{g[1]+=additionalOffset,g[0].whitespace&&(additionalOffset+=addToWhitespace)}))}))}!function populateBuffers(lines){const texW=json.common.scaleW,texH=json.common.scaleH;let geom,y=(config.baseOffset?config.baseOffset:.07)*size,j=0,glyphIndex=0,wordIndex=-1,lineId=-1;for(let lineIndex=0;lineIndex<lines.length;lineIndex++){let line=lines[lineIndex];wordIndex++,lineId++;for(let i=0;i<line.glyphs.length;i++){const glyph=line.glyphs[i][0];let x=line.glyphs[i][1];if(-1===dir&&(x=line.width-x),"center"===align||"justify"===align?x-=.5*line.width:"right"===align&&(x-=line.width*dir),whitespace.test(glyph.char)){wordIndex++;continue}1===glyph.weight&&(y+=config.boldBaseOffset*scale),2===glyph.weight&&(y+=config.italicBaseOffset*scale),x+=glyph.xoffset*scale*dir,y-=glyph.yoffset*scale,buffers.weight.set([glyph.weight,glyph.weight,glyph.weight,glyph.weight],4*glyphIndex);let w=glyph.width*scale,h=glyph.height*scale;-1===dir?buffers.position.set([x-w,y-h,0,x-w,y,0,x,y-h,0,x,y,0],4*j*3):buffers.position.set([x,y-h,0,x,y,0,x+w,y-h,0,x+w,y,0],4*j*3),buffers.animation.set([glyphIndex,wordIndex,lineId,glyphIndex,wordIndex,lineId,glyphIndex,wordIndex,lineId,glyphIndex,wordIndex,lineId],3*glyphIndex*4),glyphIndex++;let u=glyph.x/texW,uw=glyph.width/texW,v=1-glyph.y/texH,vh=glyph.height/texH;buffers.uv.set([u,v-vh,u,v,u+uw,v-vh,u+uw,v],4*j*2),buffers.local.set([0,1,0,0,1,1,1,0],4*j*2),1===glyph.weight&&(y-=config.boldBaseOffset*scale),2===glyph.weight&&(y-=config.italicBaseOffset*scale),y+=glyph.yoffset*scale,j++}y-=size*lineHeight*(line.br?paragraphSpacing:1)}window.zUtils3D&&(geom=new Geometry,geom.addAttribute("position",new GeometryAttribute(buffers.position,3)),geom.computeBoundingBox(),geom.computeBoundingSphere());let backing=[];for(let key in buffers)backing.push(buffers[key].buffer);buffers.lineLength=lines.length,geom&&(buffers.boundingBox=geom.boundingBox,buffers.boundingSphere=geom.boundingSphere);buffers.letterCount=glyphIndex,buffers.lineCount=lineId,buffers.wordCount=wordIndex,resolve(buffers,pid,backing)}(lines)}()}()}Thread.upload(loadTextGeometry),this.generate=async function(obj){return Thread.shared().loadTextGeometry(obj)}}),"static"),Class((function GLUI(){Inherit(this,Component);const _this=this,hasMetal=!!window.Metal,hasAuraAR=!!window.AURA_AR;function loop(){hasMetal||(hasAuraAR&&AURA_AR.active&&(World.NUKE.postRender=null,AURA_AR.postRender=loop),_this.Scene&&_this.Scene.render(),_this.Stage&&_this.Stage.render())}window.$gl=window.glObject=function(width,height,map,customCompile){return new GLUIObject(width,height,map,customCompile)},window.$glText=window.glText=function(text,fontName,fontSize,options,customCompile){return new GLUIText(text,fontName,fontSize,options,customCompile)},this.init=async function(is2D,is3D){_this.initialized||(void 0===is2D&&(is2D=!0,is3D=!0),await AssetLoader.waitForLib("zUtils3D"),is2D&&(_this.Stage=new GLUIStage),is3D&&(_this.Scene=new GLUIStage3D,_this.Scene.interaction.input=Mouse),_this.wait(World,"NUKE",(_=>{_this.initialized=!0,_this.Scene&&(World.NUKE.onBeforeRender=_this.Scene.mark),World.NUKE.postRender=loop})))},this.clear=function(){_this.Stage.clear(),_this.Scene.clear()},this.ready=function(){return _this.wait(_this,"initialized")},this.renderDirect=function(render){_this.Scene&&_this.Scene.renderDirect(render),_this.Stage&&_this.Stage.renderDirect(render)}}),"static"),Class((function GLUIElement(){Inherit(this,Component);this.element=$gl(),this.create=function(w,h,t){return this.element.create(w,h,t)}})),Class((function GLUIUtils(){const _this=this;_this.setRetinaMode=function($obj,retinaMode,parent){if(RenderManager.type===RenderManager.WEBVR&&(retinaMode=!1),parent||(parent=$obj.anchor&&$obj.anchor._parent||$obj.group._parent))if(retinaMode){let gluiToRTScene,p=parent;for(;p;)p.glSceneEnabled&&(gluiToRTScene=p),p=p.parent;gluiToRTScene?gluiToRTScene.glScene.add($obj):GLUI.Scene.add($obj),parent.add($obj.anchor),$obj.anchor.retinaAnchorFor=$obj,$obj.group.asyncPromise&&!$obj.anchor.asyncPromise&&($obj.anchor.asyncPromise=$obj.group.asyncPromise),$obj.anchor.position.equals($obj.group.position)&&$obj.anchor.scale.equals($obj.group.scale)&&$obj.anchor.quaternion.equals($obj.group.quaternion)||($obj.isDirty=!0,$obj.mesh&&$obj.mesh.onBeforeRender&&$obj.mesh.onBeforeRender())}else _this.isRetinaMode($obj)&&(parent.remove($obj.anchor),GLUI.Scene.remove($obj),$obj.anchor._parent=null,$obj.group.visible=parent.determineVisible(),"boolean"==typeof $obj.isDirty&&$obj.mesh&&$obj.mesh.onBeforeRender?($obj.isDirty=!0,$obj.mesh.onBeforeRender()):($obj.group.position.setScalar(0),$obj.group.quaternion.set(0,0,0,1),$obj.group.scale.setScalar(1)),$obj.deferred=!1,$obj.parent=null),parent.add($obj.group)},_this.isRetinaMode=function($obj){return RenderManager.type!==RenderManager.WEBVR&&$obj.anchor&&$obj.anchor._parent&&$obj.parent===GLUI.Scene}}),"static"),Class((function GLUIBatch(globalUniforms={},_useWorldCoords,cacheSuffix=""){Inherit(this,Component);const _this=this;var _timer,_geometry,_shader,_objects=[];function loop(){if(!_geometry)return;let parent=_this.group._parent;for(;parent;){if(parent.isRenderingCheck&&!parent.isRenderingCheck())return;parent=parent._parent}let len=_objects.length;for(let i=0;i<len;i++){let obj=_objects[i];if(obj._buffers){obj.mesh.onBeforeRender(),_useWorldCoords&&(obj.group.updateMatrixWorld(),obj.mesh.getWorldPosition(obj.worldPosition),obj.worldRotation.setFromQuaternion(obj.mesh.getWorldQuaternion()),obj.mesh.getWorldScale(obj.worldScale));for(let j=obj._buffers.length-1;j>-1;j--){let buffer=obj._buffers[j],dirty=!1;if(dirty=!buffer.value.equals(buffer.lookup),buffer.value.copy(buffer.lookup),dirty){let attribute=_geometry.attributes[buffer.key],array=attribute.array;switch(buffer.key){case"scale":_useWorldCoords?(array[2*i+0]=obj.worldScale.x,array[2*i+1]=obj.worldScale.y):(array[2*i+0]=obj.group.scale.x*obj.mesh.scale.x,array[2*i+1]=obj.group.scale.y*obj.mesh.scale.y);break;case"rotation":array[i]=buffer.lookup.z;break;default:_useWorldCoords?(array[3*i+0]=obj.worldPosition.x,array[3*i+1]=obj.worldPosition.y):(array[3*i+0]=obj.group.position.x,array[3*i+1]=obj.group.position.y),array[3*i+2]=obj.mesh.renderOrder}attribute.needsUpdate=!0}}for(let j=obj._uniforms.length-1;j>-1;j--){let uniform=obj._uniforms[j],dirty=!1;if("f"==uniform.type?(dirty=obj.mesh.shader.uniforms[uniform.key].value!=uniform.value,uniform.value=obj.mesh.shader.uniforms[uniform.key].value):(dirty=!obj.mesh.shader.uniforms[uniform.key].value.equals(uniform.value),uniform.value.copy(obj.mesh.shader.uniforms[uniform.key].value)),dirty){let attribute=_geometry.attributes["a_"+uniform.key],array=attribute.array;"f"==uniform.type?array[i]=uniform.value:uniform.value.toArray(array,i*uniform.components),attribute.needsUpdate=!0}}}}}function getTypeFromSize(size){switch(size){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4"}}function createMesh(){let shader=_objects[0].mesh.shader;_geometry=(new Geometry).instanceFrom(_objects[0].mesh.geometry.clone());let map={},arrays={};_objects.forEach(((obj,i)=>{obj.mesh.onBeforeRender();let buffers=[],uniforms=[];for(let key in shader.uniforms){let uniform=shader.uniforms[key];uniform&&(uniform.value instanceof Color&&uniforms.push({key:key,type:"c",components:3}),uniform.value instanceof Vector4&&uniforms.push({key:key,type:"v4",components:4}),uniform.value instanceof Vector3&&uniforms.push({key:key,type:"v3",components:3}),uniform.value instanceof Vector2&&uniforms.push({key:key,type:"v",components:2}),"number"==typeof uniform.value&&uniforms.push({key:key,type:"f",components:1}))}_useWorldCoords&&(obj.worldScale=new Vector3,obj.worldRotation=new Euler,obj.worldPosition=new Vector3),buffers.push({key:"scale",lookup:_useWorldCoords?obj.worldScale:obj.group.scale,components:2}),buffers.push({key:"rotation",lookup:_useWorldCoords?obj.worldRotation:obj.group.rotation,components:1}),buffers.push({key:"offset",lookup:_useWorldCoords?obj.worldPosition:obj.group.position,components:3}),uniforms.forEach((uniform=>{arrays["a_"+uniform.key]||(arrays["a_"+uniform.key]=[]),map["a_"+uniform.key]||(map["a_"+uniform.key]=uniform);let value=shader.uniforms[uniform.key].value;"object"==typeof value?(uniform.value=value.clone(),uniform.value.toArray(arrays["a_"+uniform.key],i*uniform.components)):(uniform.value=shader.uniforms[uniform.key].value,arrays["a_"+uniform.key].push(uniform.value))})),buffers.forEach((buffer=>{switch(arrays[buffer.key]||(arrays[buffer.key]=[]),map[buffer.key]||(map[buffer.key]=buffer),buffer.value=buffer.lookup.clone(),buffer.key){case"scale":arrays[buffer.key].push(obj.group.scale.x*obj.mesh.scale.x,obj.group.scale.y*obj.mesh.scale.y);break;case"rotation":arrays[buffer.key].push(buffer.lookup.z);break;default:arrays[buffer.key].push(buffer.lookup.x,buffer.lookup.y,obj.mesh.renderOrder)}})),obj._buffers=buffers,obj._uniforms=uniforms,obj.shader.neverRender=!0}));let attributes=[],defines=[];for(let key in map)key.includes("a_")&&(attributes.push(`% ${getTypeFromSize(map[key].components)} ${key};`),defines.push(`${key.replace("a_","v_")} = ${key};`));attributes=attributes.join("\n"),defines=defines.join("\n");for(let key in arrays)_geometry.addAttribute(key,new GeometryAttribute(new Float32Array(arrays[key]),map[key].components,1));let cacheKey=shader.fsName+cacheSuffix;if(GLUIBatch.cache[cacheKey])_shader=GLUIBatch.cache[cacheKey];else{(_shader=_this.initClass(Shader,"GLUIBatch",shader.fsName,Object.assign({},{transparent:!0,depthWrite:!1,depthTest:!1,customCompile:Utils.uuid()},globalUniforms))).vertexShader||_shader.resetProgram();let vsSplit=_shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=_shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__"),definitions=[];fsSplit[1].split("\n").forEach((line=>{if(line.includes("uniform")){if(line.includes("sampler2D"))return;let data=line.split(" ");definitions.push(`${data[2].replace(";","")} = a_${data[2]}`),vsSplit[1]=`\nattribute ${data[1]} a_${data[2]}\nvarying ${data[1]} ${data[2]}`+vsSplit[1],vsSplit[1]=vsSplit[1].replace(line,""),fsSplit[1]=fsSplit[1].replace(line,`varying ${data[1]} ${data[2]}`)}})),vsSplit[1]=vsSplit[1].replace("//vdefines","\n"+definitions.join("\n")),_shader.vertexShader=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),_shader.fragmentShader=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),GLUIBatch.cache[cacheKey]=_shader}shader.replicateUniformsTo(_shader),_this.mesh=new Mesh(_geometry,_shader),_this.mesh.frustumCulled=!1,_this.group.add(_this.mesh)}this.group=new Group,"boolean"==typeof globalUniforms&&(_useWorldCoords=globalUniforms,globalUniforms={}),GLUIBatch.cache||(GLUIBatch.cache={}),_this.startRender(loop),this.add=function(obj){if(clearTimeout(_timer),_timer=_this.delayedCall(createMesh,50),_useWorldCoords){let getAlpha=obj.getAlpha;getAlpha&&(obj.getAlpha=()=>(_this.parent?_this.parent.getAlpha():1)*getAlpha.call(obj))}else _this.parent?.add?.(obj);_objects.push(obj)},this.setZ=async function(z){await _this.wait("mesh"),_this.mesh.renderOrder=z},this.onDestroy=function(){_this.mesh&&_this.mesh.destroy()}})),Class((function GLUIBatchText(globalUniforms={},_useWorldCoords,_shaderName){Inherit(this,Component);const _this=this;var _geometry,_shader,_timer,_forceUpdate,_promises=[],_toSplice=[],_objects=[],_offset=0;function loop(){if(!_geometry)return;let updated=!1;for(let key in _geometry.attributes){let attrib=_geometry.attributes[key];attrib.updateRange.length&&(attrib.updateRange.length=0)}let len=_objects.length;for(let i=0;i<len;i++){let obj=_objects[i];obj.mesh.onBeforeRender(),_useWorldCoords&&(obj.group.updateMatrixWorld(),obj.mesh.getWorldPosition(obj.worldPosition),obj.worldRotation.setFromQuaternion(obj.mesh.getWorldQuaternion()),obj.mesh.getWorldScale(obj.worldScale));let offset=obj._offset,count=obj._count,end=offset+count;obj._buffers.forEach((buffer=>{let dirty=!1;if(dirty=!buffer.value.equals(buffer.lookup),buffer.value.copy(buffer.lookup),dirty){let array=_geometry.attributes[buffer.key].array;for(let j=offset;j<end;j++)switch(buffer.components){case 4:array[4*j+0]=buffer.lookup.x,array[4*j+1]=buffer.lookup.y,array[4*j+2]=buffer.lookup.z,array[4*j+3]=buffer.lookup.w;break;case 3:array[3*j+0]=buffer.lookup.x,array[3*j+1]=buffer.lookup.y,array[3*j+2]=buffer.lookup.z;break;case 2:array[2*j+0]=buffer.lookup.x,array[2*j+1]=buffer.lookup.y;break;case 1:array[j]=buffer.lookup.z}updated=!0,buffer.updateRange.offset=offset*buffer.components,buffer.updateRange.count=count*buffer.components,_geometry.attributes[buffer.key].updateRange.push(buffer.updateRange),_geometry.attributes[buffer.key].needsUpdate=!0}})),obj._uniforms.forEach((uniform=>{let dirty=!1;if("f"==uniform.type?(dirty=obj.mesh.shader.uniforms[uniform.key].value!=uniform.value,uniform.value=obj.mesh.shader.uniforms[uniform.key].value):(dirty=!obj.mesh.shader.uniforms[uniform.key].value.equals(uniform.value),uniform.value.copy(obj.mesh.shader.uniforms[uniform.key].value)),dirty||_forceUpdate){let array=_geometry.attributes["a_"+uniform.key].array;for(let j=offset;j<end;j++)"f"==uniform.type?array[j]=obj.mesh.shader.uniforms[uniform.key].value:obj.mesh.shader.uniforms[uniform.key].value.toArray(array,j*uniform.components);updated=!0,uniform.updateRange.offset=offset*uniform.components,uniform.updateRange.count=count*uniform.components,_geometry.attributes["a_"+uniform.key].updateRange.push(uniform.updateRange),_geometry.attributes["a_"+uniform.key].needsUpdate=!0}}))}if(updated)for(let key in _geometry.attributes){let bottom,attrib=_geometry.attributes[key];if(!attrib.updateRange.length)continue;let toSplice=_toSplice;toSplice.length=0;for(let i=0;i<attrib.updateRange.length;i++){let current=attrib.updateRange[i],prev=attrib.updateRange[i-1];prev?prev.offset+prev.count==current.offset?(bottom.count+=current.count,toSplice.push(i)):bottom=current:bottom=current}for(let i=toSplice.length-1;i>-1;i--)attrib.updateRange.splice(toSplice[i],1)}_forceUpdate=!1}async function createMesh(){if(_this.flag("mesh"))return;_this.flag("mesh",!0),await Promise.all(_promises),await _this.wait(100);let mesh=new Mesh(_geometry,_shader);_this.mesh=mesh,mesh.frustumCulled=!1,_this.group.add(mesh)}this.group=new Group,this.enable3D=()=>{},"boolean"==typeof globalUniforms&&(_useWorldCoords=globalUniforms,globalUniforms={}),_this.flag("canLoad",!0),_this.startRender(loop),_this.add=async function(obj){if(await _this.flag("canLoad"),_this.destroy){if(_this.flag("canLoad",!1),await obj.loaded(),obj.mesh.shader.neverRender=!0,_promises.push(obj.loaded()),function addAttributes(obj,mesh){let{geometry:geometry,shader:shader}=mesh,count=geometry.attributes.uv.count;mesh.onBeforeRender();let buffers=[],uniforms=[];for(let key in shader.uniforms){let uniform=shader.uniforms[key];uniform.value instanceof Color&&uniforms.push({key:key,type:"c",components:3}),uniform.value instanceof Vector3&&uniforms.push({key:key,type:"v3",components:3}),uniform.value instanceof Vector4&&uniforms.push({key:key,type:"v4",components:4}),uniform.value instanceof Vector2&&uniforms.push({key:key,type:"v",components:2}),"number"==typeof uniform.value&&uniforms.push({key:key,type:"f",components:1})}_useWorldCoords&&(obj.worldScale=new Vector3,obj.worldRotation=new Euler,obj.worldPosition=new Vector3),buffers.push({key:"offset",lookup:_useWorldCoords?obj.worldPosition:obj.group.position,components:3}),buffers.push({key:"scale",lookup:_useWorldCoords?obj.worldScale:obj.group.scale,components:2}),buffers.push({key:"rotation",lookup:_useWorldCoords?obj.worldRotation:obj.group.rotation,components:1}),uniforms.forEach((uniform=>{uniform.updateRange={},uniform.value=shader.uniforms[uniform.key].value,"object"==typeof uniform.value&&(uniform.value=uniform.value.clone()),uniform.buffer=new Float32Array(count*uniform.components)})),buffers.forEach((buffer=>{buffer.updateRange={},buffer.value=buffer.lookup.clone(),buffer.buffer=new Float32Array(count*buffer.components)}));for(let i=0;i<count;i++)buffers.forEach((buffer=>{switch(buffer.components){case 4:buffer.buffer[4*i+0]=buffer.lookup.x,buffer.buffer[4*i+1]=buffer.lookup.y,buffer.buffer[4*i+2]=buffer.lookup.z,buffer.buffer[4*i+3]=buffer.lookup.w;break;case 3:buffer.buffer[3*i+0]=buffer.lookup.x,buffer.buffer[3*i+1]=buffer.lookup.y,buffer.buffer[3*i+2]=buffer.lookup.z;break;case 2:buffer.buffer[2*i+0]=buffer.lookup.x,buffer.buffer[2*i+1]=buffer.lookup.y;break;case 1:buffer.buffer[i]=buffer.lookup.z}})),uniforms.forEach((uniform=>{"f"==uniform.type?uniform.buffer[i]=shader.uniforms[uniform.key].value:shader.uniforms[uniform.key].value.toArray(uniform.buffer,i*uniform.components)}));buffers.forEach((buffer=>{geometry.addAttribute(buffer.key,new GeometryAttribute(buffer.buffer,buffer.components))})),uniforms.forEach((uniform=>{geometry.addAttribute("a_"+uniform.key,new GeometryAttribute(uniform.buffer,uniform.components))})),obj._offset=_offset,obj._count=count,obj._uniforms=uniforms,obj._buffers=buffers,_objects.push(obj),_offset+=count}(obj,obj.mesh),_useWorldCoords){let getAlpha=obj.getAlpha;getAlpha&&(obj.getAlpha=()=>(_this.parent?_this.parent.getAlpha():1)*getAlpha.call(obj))}else _this.parent.add(obj);_geometry?_geometry.merge(obj.mesh.geometry):function initGeometry(mesh){(_shader=_this.initClass(Shader,_shaderName||"GLUIBatchText",_shaderName||mesh.shader.fsName,Object.assign({},{transparent:!0,depthWrite:!1,customCompile:`${mesh.shader.vsName}|${mesh.shader.fsName}|instance`},globalUniforms))).vertexShader||_shader.resetProgram();let vsSplit=_shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=_shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__"),definitions=[],definitionSplit=[];fsSplit[1].split("\n").forEach((line=>{if(line.includes("uniform")){if(line.includes("sampler2D"))return;let data=line.split(" ");definitions.push(`${data[2].replace(";","")} = a_${data[2]}`),vsSplit[1]=`\nattribute ${data[1]} a_${data[2]}\nvarying ${data[1]} ${data[2]}`+vsSplit[1],vsSplit[1]=vsSplit[1].replace(line,""),fsSplit[1]=fsSplit[1].replace(line,`varying ${data[1]} ${data[2]}`)}})),definitions.forEach((def=>definitionSplit.push(def.split(" =")[0].trim())));let baseVS=Shaders.getShader(mesh.shader.vsName+".vs");if(baseVS.includes("//start batch main")){let main=baseVS.split("//start batch main")[1].split("//end batch main")[0];vsSplit[1]=vsSplit[1].replace("//custommain",main);let beforeMain=baseVS.split("void main() {")[0];beforeMain=beforeMain.replace("uniform sampler2D tMap;",""),beforeMain=beforeMain.replace("varying vec2 vUv;",""),beforeMain.split("\n").forEach((line=>{definitionSplit.forEach((def=>{line.includes(def)&&line.includes(["uniform","varying"])&&(beforeMain=beforeMain.replace(line,""))}))})),vsSplit[0]+=beforeMain}vsSplit[1]=vsSplit[1].replace("//vdefines","\n"+definitions.join("\n")),_shader.vertexShader=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),_shader.fragmentShader=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),mesh.shader.copyUniformsTo(_shader),_geometry=mesh.geometry.clone();for(let key in _geometry.attributes)_geometry.attributes[key].updateRange=[]}(obj.mesh),_this.flag("canLoad",!0),clearTimeout(_timer),_timer=_this.delayedCall(createMesh,50),obj.isDirty=!0}},_this.forceUpdate=function(){_forceUpdate=!0},_this.onDestroy=function(){_this.mesh&&_this.mesh.destroy()}})),Class((function GLUIStageInteraction2D(_camera,_scene,_stage,_custom){Inherit(this,Component);const _this=this;var _ray,_over,_click,_customTest,_disabled,_blocked,_test=[],_objects=this.objects=[],_hold=new Vector2,_lastTestedPoint=(new Vector2,new Vector2),_plane=new Plane;function cacheTopScene(obj){let p=obj;for(;p;)p instanceof Scene&&(obj.interactionScene=p),p=p._parent}function testObjects(){let objects=GLUI.Stage.interaction.objects;_test.length=0;for(let i=objects.length-1;i>-1;i--){let obj=objects[i];obj.interactionScene||cacheTopScene(obj),(obj.forceGLUIInteraction||obj.determineVisible()&&_scene==obj.interactionScene)&&_test.push(obj)}return _test}function externalStart(){_this._invisible||start(_lastTestedPoint)}function externalRelease(){_this._invisible||end(_lastTestedPoint)}function move(e){if(GLUI.PREVENT_INTERACTION||_this._invisible||_disabled||_blocked)return;_ray||((_ray=new Raycaster(_camera)).testVisibility=!1);let objects=testObjects();if(!objects.length)return void(_over&&(_over._onOver({action:"out",object:_over}),_over=null,Stage.cursor("auto")));let hit=_ray.checkHit(objects,e,_stage);try{if(hit[0]){_customTest||(GLUI.HIT=!0);let obj=hit[0].object.glui;_over||((_over=obj)._onOver({action:"over",object:obj}),Stage.cursor("pointer")),_over!=obj&&(_over._onOver({action:"out",object:_over}),(_over=obj)._onOver({action:"over",object:obj}),Stage.cursor("pointer"))}else _customTest||(GLUI.HIT=!1),_over&&(_over._onOver({action:"out",object:_over}),_over=null,Stage.cursor("auto"))}catch(e){console.warn(e)}}function start(e){let handlingEvent=!(e instanceof Vector2),checkDefault=GLUI.PREVENT_DEFAULT_INTERACTION&&handlingEvent,checkPrevention=GLUI.PREVENT_INTERACTION||_this._invisible||_disabled||_blocked;checkDefault||checkPrevention||(_custom&&handlingEvent||!Device.mobile&&RenderManager.type!=RenderManager.WEBVR||move(e),_over&&!_click&&(_click=_over,_hold.copy(e),_hold.time=Date.now()))}function end(e){if(!(GLUI.PREVENT_INTERACTION||_this._invisible||_disabled||_blocked)){if(_customTest&&Device.mobile&&_click&&null==_over&&(_over=_click),GLUI.HIT=!1,_click){if(Date.now()-_hold.time>750)return _click=null;if(_click==_over)try{_blocked=!0,_this.delayedCall((_=>{_blocked=!1}),_this.preventDoubleClickTime),_click._onClick({action:"click",object:_click}),(Device.mobile||_custom)&&_over&&(_over._onOver({action:"out",object:_over}),_over=null,Stage.cursor("auto"))}catch(e){console.warn(e)}}_click=null}}function findCapture(object){let capture=object.__slc;return void 0===capture&&window.UI3D?object.__slc=UI3D.findStageLayoutCapture(object)||null:capture}this.preventDoubleClickTime=300,function addListeners(){_custom||_this.events.sub(Mouse.input,Interaction.MOVE,move),_this.events.sub(Mouse.input,Interaction.START,start),_this.events.sub(Mouse.input,Interaction.END,end),_this.events.sub(Interaction3D.EXTERNAL_PRESS,externalStart),_this.events.sub(Interaction3D.EXTERNAL_RELEASE,externalRelease)}(),_this.startRender((_=>{})),this.add=function(obj){obj&&_objects.push(obj.mesh||obj)},this.remove=function(obj){obj&&_objects.remove(obj.mesh||obj)},this.testWith=function(point,id){point.customTest=!0,_lastTestedPoint.copy(point),_lastTestedPoint.customTest=!0,_customTest=!0,move(point),Device.mobile&&RenderManager.type!=RenderManager.WEBVR&&_over&&start(point)},this.testWithFinger=function(point,distance,minDistance){_ray||((_ray=new Raycaster(_camera)).testVisibility=!1),_customTest=!0;let objects=testObjects();if(objects.length)if(distance<.02){let hit=_ray.checkHit(objects,point,_stage);try{if(hit[0]){let obj=hit[0].object.glui;(!obj._preventClickTime||Render.TIME-obj._preventClickTime>_this.preventDoubleClickTime)&&(obj._requiresClear||(_over=obj,obj._onOver({action:"over",object:obj}),obj._onClick({action:"click",object:obj}),obj._preventClickTime=Render.TIME,obj._requiresClear=!0))}else _over&&(_over._requiresClear=!1,_over._onOver({action:"out",object:_over}),_over=null)}catch(e){console.warn(e)}}else _over&&(_over._requiresClear=!1,_over._onOver({action:"out",object:_over}),_over=null)},this.checkObjectHit=function(object,mouse){let capture=findCapture(object);return capture?capture.checkObjectHit(object.mesh||object,mouse):(_ray||((_ray=new Raycaster(_camera)).testVisibility=!1),_ray.checkHit(object.mesh||object,mouse,_stage)[0])},this.checkObjectFromValues=function(object,origin,direction){let capture=findCapture(object);return capture?capture.checkObjectFromValues(object.mesh||object,origin,direction):(_ray||((_ray=new Raycaster(_camera)).testVisibility=!1),_ray.checkFromValues(object.mesh||object,origin,direction)[0])},this.getObjectHitLocalCoords=function(v,object,mouse){let capture=findCapture(object);if(capture)return capture.getObjectHitLocalCoords(v,object,mouse);let hit=_this.checkObjectHit(object,mouse);if(hit)return v.copy(hit.point),hit.object.worldToLocal(v);{let mesh=object.mesh||object;return _plane.normal.set(0,0,1).applyQuaternion(mesh.getWorldQuaternion()),_plane.constant=-mesh.getWorldPosition().dot(_plane.normal),_ray.ray.intersectPlane(_plane,v),mesh.worldToLocal(v)}},this.set("_disabled",(v=>{(_disabled=v)&&(_click=null,_over&&(_over._onOver({action:"out",object:_over}),_over=null,Stage.cursor("auto")))})),this.onInvisible=()=>{_click=null,_over&&(_over._onOver({action:"out",object:_over}),_over=null,Stage.cursor("auto"))}})),Class((function GLUIStageInteraction3D(){Inherit(this,Component);function onHover(e){e.mesh.glui._onOver({action:e.action,object:e.mesh.glui})}function onClick(e){e.mesh.glui._onClick({action:e.action,object:e.mesh.glui})}this.add=function(obj,camera=World.CAMERA){Interaction3D.find(camera).add(obj.mesh||obj,onHover,onClick)},this.remove=function(obj,camera=World.CAMERA){Interaction3D.find(camera).remove(obj.mesh||obj)},this.checkObjectHit=function(object,mouse,camera=World.CAMERA){return Interaction3D.find(camera).checkObjectHit(object.mesh,mouse)},this.checkObjectFromValues=function(object,origin,direction,camera=World.CAMERA){return Interaction3D.find(camera).checkObjectFromValues(object.mesh,origin,direction)},this.getObjectHitLocalCoords=function(v,object,mouse,camera=World.CAMERA){return Interaction3D.find(camera).getObjectHitLocalCoords(v,object.mesh,mouse)}})),Class((function GLUICornerPin($obj){Inherit(this,Component);const _this=this;var _geom,_vertices,_last;function loop(){_vertices[0]=_this.tl.x,_vertices[1]=-_this.tl.y,_vertices[3]=_vertices[9]=_this.bl.x,_vertices[4]=_vertices[10]=-_this.bl.y,_vertices[6]=_vertices[15]=_this.tr.x,_vertices[7]=_vertices[16]=-_this.tr.y,_vertices[12]=_this.br.x,_vertices[13]=-_this.br.y,function dirty(){let a=_vertices,b=_last;for(let i=a.length-1;i>-1;i--)if(a[i]!=b[i])return!0;return!1}()&&(_geom.attributes.position.needsUpdate=!0),_last.set(_vertices)}this.tl=new Vector2(0,0),this.tr=new Vector2($obj.width,0),this.bl=new Vector2(0,$obj.height),this.br=new Vector2($obj.width,$obj.height),function initGeometry(){_geom=$obj.mesh.geometry.toNonIndexed(),$obj.useGeometry(_geom),$obj.mesh.scale.set(1,1,1),_vertices=_geom.attributes.position.array,_last=new Float32Array(_vertices)}(),_this.startRender(loop),this.update=function(){this.tl.set(0,0),this.tr.set($obj.width,0),this.bl.set(0,$obj.height),this.br.set($obj.width,$obj.height)},this.tween=function(type,val,time,ease,delay){return val=val instanceof Vector2?val:new Vector2(val.x,val.y),tween(_this[type],val,time,ease,delay)}}));class GLUIObject{constructor(width,height,map,customCompile){let shader=this.textureShader=new Shader("GLUIObject",{tMap:{value:null},uAlpha:{type:"f",value:1},transparent:!0,depthTest:!1,customCompile:customCompile});shader.persists=!0,map||(shader.visible=!1),this.usingMap=null!=map&&"empty"!=map&&""!=map,this.tMap=shader.uniforms.tMap,this.group=new Group,this.alpha=1,this._x=0,this._y=0,this._z=0,this._scaleX=1,this._scaleY=1,this._scale=1,this._rotation=0,this.multiTween=!0,this.children=[],this.dimensions=new Vector3(width,height,1),this._shader=shader,this.mesh=new Mesh(GLUIObject.getGeometry("2d"),shader),this.mesh.glui=this,this.group.add(this.mesh),shader.mesh=this.mesh,window.GLSEO&&GLSEO.objectNode(this),this.bg("string"==typeof map?map.includes(["#","0x"])?map:"empty"===map||""===map?null:Utils3D.getTexture(map,{premultiplyAlpha:!1}):map);const _this=this;this.mesh.onBeforeRender=_=>{if(!_this.mesh.determineVisible()&&_this.firstRender)return;let alpha=_this.getAlpha();if(_this.mesh.shader.uniforms.uAlpha&&(_this.mesh.shader.uniforms.uAlpha.value=alpha),_this.usingMap)if(alpha<.001){if(_this.mesh.neverRender=!0,_this.mesh.shader.visible=!1,!_this.isDirty&&_this.firstRender)return}else _this.mesh.neverRender=!1,_this.mesh.shader.visible=!0;if(!_this.isDirty&&_this.firstRender)return;RenderStats.active&&RenderStats.update("GLUIObject",1,_this.mesh.shader.vsName+"|"+_this.mesh.shader.fsName,_this.mesh),_this.group.position.x=_this._x,_this.group.position.y=_this._3d?_this._y:-_this._y,_this.group.position.z=_this._z,1!=_this.scale&&(_this.group.position.x+=(_this.dimensions.x-_this.dimensions.x*_this.scale)/2,_this.group.position.y-=(_this.dimensions.y-_this.dimensions.y*_this.scale)/2);_this.mesh.shader;if(_this.calcMask){let v=_this.isMasked;v.copy(v.origin),_this.group.localToWorld(v),v.z=v.width,v.w=v.height}map?_this.corners||(_this.mesh.scale.set(1,1,1).multiply(_this.dimensions),_this.group.scale.x=_this._scaleX*_this._scale,_this.group.scale.y=_this._scaleY*_this._scale):_this.group.scale.set(_this._scaleX*_this._scale,_this._scaleY*_this._scale,1),_this._3d?_this.anchor&&_this.anchor._parent?(_this.anchor.position.copy(_this.group.position),_this.anchor.scale.copy(_this.group.scale),_this.anchor.quaternion.setFromEuler(_this._rotation),_this.anchor.isDirty=!0):(_this.group.quaternion.setFromEuler(_this._rotation),_this.group.matrixDirty=!0):_this.group.rotation.z=Math.radians(_this._rotation),_this.firstRender||(_this.group.updateMatrixWorld(!0),_this.firstRender=!0,_this.onMountedHook&&_this.onMountedHook()),_this.isDirty=!1},_this.isDirty=!0}get width(){return this.dimensions.x}set width(w){let dirty=Math.abs(this.dimensions.x-w)>Base3D.DIRTY_EPSILON;this.dimensions.x=w,dirty&&(this.isDirty=!0,this.__internalDirty&&this.__internalDirty())}get height(){return this.dimensions.y}set height(h){let dirty=Math.abs(this.dimensions.y-h)>Base3D.DIRTY_EPSILON;this.dimensions.y=h,dirty&&(this.isDirty=!0,this.__internalDirty&&this.__internalDirty())}get x(){return this._x}set x(v){let dirty=Math.abs(this._x-v)>Base3D.DIRTY_EPSILON;this._x=v,dirty&&(this.isDirty=!0,this.__internalDirty&&this.__internalDirty())}get y(){return this._y}set y(v){let dirty=Math.abs(this._y-v)>Base3D.DIRTY_EPSILON;this._y=v,dirty&&(this.isDirty=!0,this.__internalDirty&&this.__internalDirty())}get z(){return this._z}set z(v){let dirty=Math.abs(this._z-v)>Base3D.DIRTY_EPSILON;this._z=v,dirty&&(this.isDirty=!0,this.__internalDirty&&this.__internalDirty())}get scale(){return this._scale}set scale(v){let dirty=Math.abs(this._scale-v)>Base3D.DIRTY_EPSILON;this._scale=v,dirty&&(this.isDirty=!0,this.__internalDirty&&this.__internalDirty())}get scaleX(){return this._scaleX}set scaleX(v){let dirty=Math.abs(this._scaleX-v)>Base3D.DIRTY_EPSILON;this._scaleX=v,dirty&&(this.isDirty=!0,this.__internalDirty&&this.__internalDirty())}get scaleY(){return this._scaleY}set scaleY(v){let dirty=Math.abs(this._scaleY-v)>Base3D.DIRTY_EPSILON;this._scaleY=v,dirty&&(this.isDirty=!0,this.__internalDirty&&this.__internalDirty())}get rotation(){return this._rotation}set rotation(v){let dirty=Math.abs(this._rotation-v)>Base3D.DIRTY_EPSILON;this._rotation=v,dirty&&(this.isDirty=!0,this.__internalDirty&&this.__internalDirty())}style(props){for(let prop in props)void 0!==this[prop]&&(this[prop]=props[prop]);return this}size(w,h){return this.width=w,this.height=h,this.corners&&this.corners.update(),this}add($obj){return $obj?.parent?.children?.remove($obj),$obj.parent=this,this.group.add($obj.group),this.children.push($obj),this.isMasked&&$obj.mask(this.isMasked,this.maskShader),this._3d&&!$obj._3d&&$obj.enable3D(),this.deferred&&($obj.deferRender(!0),$obj.anchor&&this.anchor&&this.anchor.add($obj.anchor)),this}interact(over,click,camera=World.CAMERA,url,label,options){"string"==typeof camera&&(options=label,label=url,url=camera,camera=World.CAMERA);const bubble=(e,fn)=>{e.stopPropagation=function(){e._stopProp=!0};let parent=this._parent;for(;parent;){if(e._stopProp)return;parent[fn]?.(e),parent=parent.parent}};if(this._onOver=e=>{bubble(e,"_onChildHover"),over(e)},this._onClick=e=>{bubble(e,"_onChildClick"),click(e)},this._interactCamera=camera,over?this.interaction.add(this,camera):this.interaction.remove(this,camera),"string"==typeof url&&"string"==typeof label){const _this=this;defer((_=>{!_this.seo&&window.GLSEO&&GLSEO.objectNode(_this),_this.seo&&_this.seo.aLink&&_this.seo.aLink(url,label,options)}))}return this}clearInteract(){return this._onOver&&(this.interaction.remove(this,this._interactCamera),this._onClick=GLUIObject.noop,this._onOver=GLUIObject.noop),this.seo&&this.seo.unlink(),this}remove(param){param&&console.warn("GLUIObject.remove removes ITSELF from its parent. use removeChild instead"),this.children.slice().forEach((child=>{child.remove?child.remove():child.destroy&&child.destroy()})),this.clearInteract(),this.parent&&(this.parent.children?this.parent.children?.remove(this):GLUI.Stage.remove(this)),this.mesh._parent?this.group._parent?.remove(this.group):this._3d?GLUI.Scene.remove(this):GLUI.Stage.remove(this);let textureShader=this.textureShader;for(let key in textureShader.uniforms){let uniform=textureShader.uniforms[key];uniform&&uniform.value&&uniform.value.destroy&&uniform.value.destroy()}}create(width,height,map,customCompile){let $obj=$gl(width,height,map,customCompile);return this.add($obj),this._3d&&$obj.enable3D(),$obj}removeChild(obj){return this.group.remove(obj.group),this}tween(obj,time,ease,delay){return tween(this,obj,time,ease,delay)}enable3D(style2d){this._3d=!0,this.mesh.geometry=GLUIObject.getGeometry(style2d?"2d":"3d"),this.mesh.shader.depthTest=!0,this._rotation=new Euler,this.anchor||(this.anchor=new Group),this.anchor.onMatrixDirty=_=>{_this.isDirty=!0};const _this=this;return _this._rotation.onChange((_=>{_this.isDirty=!0})),this}loaded(){return!0}setZ(z){return this.mesh.renderOrder=z,this}bg(path){if(void 0!==path)return"string"==typeof path?path.length<=10&&(path.startsWith("0x")||path.startsWith("#"))?(this.colorShader||(this.colorShader=new Shader("GLUIColor",{transparent:!0,uAlpha:{type:"f",value:1},uColor:{value:new Color(path)}})),this.colorShader.set("uColor",new Color(path)),this._shader.uniforms.uColor||this.useShader(this.colorShader)):(this.textureShader.uniforms.tMap.value=Utils3D.getTexture(path,{premultiplyAlpha:!1}),this._shader.uniforms.tMap||this.useShader(this.textureShader)):(this._shader.uniforms.tMap||this.useShader(this.textureShader),this._shader.uniforms.tMap.value=path),this}show(){return this.group.matrixDirty=!0,this.mesh.matrixDirty=!0,this.group.visible=!0,this.anchor&&(this.anchor.visible=!0),this}hide(){return this.group.visible=!1,this.anchor&&(this.anchor.visible=!1),this}useShader(shader){return shader&&(shader!=this.textureShader&&shader!=this.colorShader&&(shader.uniforms.tMap=this.mesh.shader.uniforms.tMap,shader.uniforms.uAlpha=this.mesh.shader.uniforms.uAlpha),this._3d||(shader.depthTest=!1),shader.transparent=!0),this._shader=shader,this.mesh.shader=shader||this._shader,shader.mesh=this.mesh,this}depthTest(bool){this.mesh.shader.depthTest=bool}childInteract(hover,click){this._onChildHover=hover,this._onChildClick=click}useGeometry(geom){return this.mesh.geometry=geom,this}updateMap(src){this._shader.uniforms.tMap.value="string"==typeof src?Utils3D.getTexture(src):src}async mask(obj,shader){await defer();let dimensions={},p=this._parent;for(;p;)p.stageLayoutCapture&&(dimensions.width=p.stageLayoutCapture.width,dimensions.height=p.stageLayoutCapture.height),p=p._parent;dimensions.width||(dimensions.width=Stage.width,dimensions.height=Stage.height),obj.group.updateMatrixWorld(!0),obj.mesh.onBeforeRender();let box=(new Box3).setFromObject(obj.mesh),minX=box.min.x/dimensions.width,minY=box.max.y/dimensions.height,maxX=box.max.x/dimensions.width,maxY=-box.min.y/dimensions.height;this.shader&&(this.useShader(shader),this.shader.addUniforms({uMaskValues:{value:new Vector4(minX,minY,maxX,maxY)}})),obj.hide(),this.group.traverse((o=>{o.glui&&o.glui!=this&&o.glui.mask(obj,shader)}))}deferRender(parent){this.deferred=!0,parent||(this.anchor=new Group,GLUI.Scene.addDeferred(this))}clearTween(){return this._mathTweens&&this._mathTweens.forEach((t=>{t.tween.stop()})),this}createCorners(){this.corners=new GLUICornerPin(this)}getAlpha(){if(this._gluiParent){let alpha=this._gluiParent.getAlpha();return this.alpha=alpha,alpha}let alpha=this.alpha,$parent=this.parent;for(;$parent;)alpha*=$parent.alpha,$parent=$parent.parent;return alpha}get shader(){return this._shader}_divFocus(){this._onOver&&this._onOver({action:"over",object:this}),this.onDivFocus&&this.onDivFocus()}_divBlur(){this._onOver&&this._onOver({action:"out",object:this}),this.onDivBlur&&this.onDivBlur()}_divSelect(){this._onClick&&this._onClick({action:"click",object:this}),this.onDivSelect&&this.onDivSelect()}get _parent(){return this.parent}get interaction(){return(this._3d?GLUI.Scene:GLUI.Stage).interaction}forceUpdate(){this.firstRender=!1,this.mesh.onBeforeRender()}}!function(){var _geom2d,_geom3d;GLUIObject.getGeometry=function(type){return"2d"==type?(_geom2d||(_geom2d=new PlaneGeometry(1,1)).applyMatrix((new Matrix4).makeTranslation(.5,-.5,0)),_geom2d):(_geom3d||(_geom3d=World.PLANE),_geom3d)},GLUIObject.clear=function(){_geom2d=_geom3d=null},GLUIObject.noop=_=>{}}();class GLUIText{constructor(text,fontName,fontSize,options={},customCompile){options.font=fontName||options.font,options.text=text,options.seoText=options.seoText??text,options.width=options.width,options.align=options.align||"left",options.size=fontSize||options.size,options.lineHeight=options.lineHeight,options.letterSpacing=options.letterSpacing,options.wordSpacing=options.wordSpacing,options.wordBreak=options.wordBreak,options.langBreak=options.langBreak,options.indent=options.indent,options.color=new Color(options.color),options.customCompile=customCompile,this.text=new GLText(options),this.group=new Group,this.group.asyncPromise=this.text.text.fontLoaded,this.alpha=1,this._x=0,this._y=0,this._z=0,this._scaleX=1,this._scaleY=1,this._scale=1,this._rotation=0,this.multiTween=!0;const _this=this;text&&defer((_=>{!_this.seo&&options.seoText&&_this.seoText(options.seoText,this._seoSortOrder??options.seoSortOrder)})),this.text.ready().then((_=>{let mesh=_this.text.mesh;mesh.glui=_this,mesh.shader.visible=!1,_this.mesh=mesh,_this.group.add(mesh),_this._3d&&!_this._style2d&&_this.text.centerY(),_this._3d||(_this.text.mesh.shader.depthTest=!1),mesh.shader.mesh=mesh,mesh.onBeforeRender=_=>{if(!mesh.determineVisible()&&_this.firstRender)return;let alpha=_this.getAlpha();if(mesh.shader.uniforms.uAlpha&&(mesh.shader.uniforms.uAlpha.value=alpha),alpha<.001){if(mesh.shader.visible=!1,mesh.neverRender=!0,!_this.isDirty&&_this.firstRender)return}else mesh.neverRender=!1,mesh.shader.visible=!0;!_this.isDirty&&_this.firstRender||(RenderStats.active&&RenderStats.update("GLUIText",1,mesh.shader.vsName+"|"+mesh.shader.fsName,mesh),_this.group.position.x=_this._x,_this.group.position.y=_this._3d?_this._y:-_this._y,_this.group.position.z=_this._z,_this.group.scale.set(_this._scaleX*_this._scale,_this._scaleY*_this._scale,1),_this._3d?_this.anchor&&_this.anchor._parent?(_this.anchor.position.copy(_this.group.position),_this.anchor.scale.copy(_this.group.scale),_this.anchor.quaternion.setFromEuler(_this._rotation)):_this.group.quaternion.setFromEuler(_this._rotation):_this.group.rotation.z=Math.radians(_this._rotation),_this.firstRender||(_this.group.updateMatrixWorld(!0),_this.firstRender=!0,mesh.shader.visible=!0),_this.onInternalUpdate&&_this.onInternalUpdate(),_this.isDirty=!1)}}))}get x(){return this._x}set x(v){Math.abs(this._x-v)>Base3D.DIRTY_EPSILON&&(this.isDirty=!0),this._x=v}get y(){return this._y}set y(v){Math.abs(this._y-v)>Base3D.DIRTY_EPSILON&&(this.isDirty=!0),this._y=v}get z(){return this._z}set z(v){Math.abs(this._z-v)>Base3D.DIRTY_EPSILON&&(this.isDirty=!0),this._z=v}get scale(){return this._scale}set scale(v){Math.abs(this._scale-v)>Base3D.DIRTY_EPSILON&&(this.isDirty=!0),this._scale=v}get scaleX(){return this._scaleX}set scaleX(v){Math.abs(this._scaleX-v)>Base3D.DIRTY_EPSILON&&(this.isDirty=!0),this._scaleX=v}get scaleY(){return this._scaleY}set scaleY(v){Math.abs(this._scaleY-v)>Base3D.DIRTY_EPSILON&&(this.isDirty=!0),this._scaleY=v}get rotation(){return this._rotation}set rotation(v){Math.abs(this._rotation-v)>Base3D.DIRTY_EPSILON&&(this.isDirty=!0),this._rotation=v}get dimensions(){return this._dimensions||(this._dimensions={}),this.text&&this.text.geometry&&!this._dimensions.max&&(this._dimensions=this.text.geometry.boundingBox,this._dimensions.width=Math.abs(this._dimensions.min.x-this._dimensions.max.x),this._dimensions.height=Math.abs(this._dimensions.min.y-this._dimensions.max.y)),this._dimensions}interact(over,click,camera=World.CAMERA,seoLink,options){"string"==typeof camera&&(options=seoLink,seoLink=camera,camera=World.CAMERA),this._onOver=over,this._onClick=click,this._interactCamera=camera;let stage=this._3d?GLUI.Scene:GLUI.Stage;const _this=this;return _this.text.ready().then((_=>{if(over){if(_this.text.geometry.boundingBox||_this.text.geometry.computeBoundingBox(),!_this.hitArea){let bb=_this.text.geometry.boundingBox,shader=Utils3D.getTestShader();if(shader.visible=!1,_this.hitArea=new Mesh(World.PLANE,shader),_this.hitArea.glui=_this,_this.hitArea.scale.set(Math.abs(bb.min.x)+Math.abs(bb.max.x),Math.abs(bb.min.y)+Math.abs(bb.max.y),1),_this._3d&&!_this._style2d||(_this.hitArea.position.x=(bb.max.x-bb.min.x)/2),_this.hitArea.position.y=(bb.min.y-bb.max.y)/2,_this._3d)switch(_this.text.getData().align){case"center":_this.hitArea.position.x=0;break;case"right":_this.hitArea.position.x=(bb.min.x-bb.max.x)/2}else switch(_this.text.getData().align){case"center":_this.hitArea.position.x=0;break;case"right":_this.hitArea.position.x=-(bb.max.x-bb.min.x)/2}_this.text.mesh.add(_this.hitArea)}stage.interaction.add(_this.hitArea,camera)}else stage.interaction.remove(_this.hitArea,camera)})),defer((_=>{seoLink&&_this.seo&&_this.seo.aLink&&_this.seo.aLink(seoLink,options)})),this}clearInteract(){if(this._onOver){(this._3d?GLUI.Scene:GLUI.Stage).interaction.remove(this.hitArea,this._interactCamera),this._onClick=GLUIObject.noop,this._onOver=GLUIObject.noop}return this}remove(param){param&&console.warn("GLUIObject.remove removes ITSELF from its parent. use removeChild instead");let stage=this._3d?GLUI.Scene:GLUI.Stage;this.mesh&&this.mesh.parent?this.group.parent.remove(this.group):stage.remove(this),this.hitArea&&stage.interaction.remove(this.hitArea,this._interactCamera),this.text&&this.text.destroy&&this.text.destroy(),Utils.nullObject(this.mesh),Utils.nullObject(this)}tween(obj,time,ease,delay){return tween(this,obj,time,ease,delay)}enable3D(style2d){this._3d=!0,this._style2d=style2d,this._rotation=new Euler;const _this=this;return _this._rotation.onChange((_=>{_this.isDirty=!0})),_this.text.ready().then((_=>{_this.text.mesh.shader.depthTest=!0})),this.anchor||(this.anchor=new Group),this.anchor.onMatrixDirty=_=>{_this.isDirty=!0},_this.isDirty=!0,this}depthTest(bool){const _this=this;return _this.text.ready().then((_=>{_this.text.mesh.shader.depthTest=bool})),this}setZ(z){const _this=this;return _this.text.ready().then((_=>{_this.text.mesh.renderOrder=z})),this}height(){return this.mesh?this.text.height:0}async setText(text,options){if(text&&(text=text.toString(),!1!==options?.seoText)){let seoText=options?.seoText;seoText=seoText&&"boolean"!=typeof seoText?seoText.toString():text,this.seoText(seoText,options?.seoSortOrder)}return await this.text.ready(),await this.text.setText(text,options),this._dimensions=null,this}seoText(text,sortOrder=this._seoSortOrder){window.GLSEO&&(GLSEO.textNode(this,text,sortOrder),delete this._seoSortOrder)}get seoSortOrder(){return this.seo?this.seo.sortOrder:this._seoSortOrder}set seoSortOrder(sortOrder){this.seo?GLSEO.textNode(this,this.seo.text(),sortOrder):this._seoSortOrder=sortOrder}getTextString(){return this.text.string}setColor(color){const _this=this;return _this.text.ready().then((_=>_this.text.setColor(color))),this}tweenColor(color,time,ease,delay){const _this=this;return _this.text.ready().then((_=>_this.text.tweenColor(color,time,ease,delay))),this}async resize(options){await this.text.ready(),await this.text.resize(options),this._dimensions=null}show(){return this.text.ready().then((_=>{this.text.mesh.visible=!0,this.text.mesh.updateMatrixWorld(!0)})),this}async mask(obj,shader){await defer();let dimensions={},p=this._parent;for(;p;)p.stageLayoutCapture&&(dimensions.width=p.stageLayoutCapture.width,dimensions.height=p.stageLayoutCapture.height),p=p._parent;dimensions.width||(dimensions.width=Stage.width,dimensions.height=Stage.height),obj.group.updateMatrixWorld(!0),obj.mesh.onBeforeRender();let box=(new Box3).setFromObject(obj.mesh),minX=box.min.x/dimensions.width,minY=box.max.y/dimensions.height,maxX=box.max.x/dimensions.width,maxY=-box.min.y/dimensions.height;this.shader&&(this.useShader(shader),this.shader.addUniforms({uMaskValues:{value:new Vector4(minX,minY,maxX,maxY)}})),obj.hide(),this.group.traverse((o=>{o.glui&&o.glui!=this&&o.glui.mask(obj,shader)}))}hide(){const _this=this;return _this.text.ready().then((_=>_this.text.mesh.visible=!1)),this}loaded(){return this.text.ready()}length(){return this.text.charLength}deferRender(parent){this.deferred=!0,parent||(this.anchor||(this.anchor=new Group),GLUI.Scene.addDeferred(this))}getAlpha(){if(this._gluiParent){let alpha=this._gluiParent.getAlpha();return this.alpha=alpha,alpha}let alpha=this.alpha,$parent=this.parent;for(;$parent;)alpha*=$parent.alpha,$parent=$parent.parent;return alpha}size(){}upload(){const _this=this;return _this.text.ready().then((_=>_this.text.mesh.upload())),this}_divFocus(){this._onOver&&this._onOver({action:"over",object:this}),this.onDivFocus&&this.onDivFocus()}_divBlur(){this._onOver&&this._onOver({action:"out",object:this}),this.onDivBlur&&this.onDivBlur()}_divSelect(){this._onClick&&this._onClick({action:"click",object:this}),this.onDivBlurSelect&&this.onDivSelect()}get _parent(){return this.parent}async useShader(shader){await this.text.ready(),shader.uniforms.tMap=this.text.shader.uniforms.tMap,shader.uniforms.uAlpha=this.text.shader.uniforms.uAlpha,shader.uniforms.uColor=this.text.shader.uniforms.uColor,shader.transparent=!0,(!this._3d||this._3d||this.parent)&&(shader.depthTest=!1),this.text.mesh.shader=shader||this.text.shader,this.text.shader=shader,this.text.mesh.shader.mesh=this.text.mesh}}Class((function GLUIStage(){Inherit(this,Component);const _this=this;var _scene=new Scene,_camera=new OrthographicCamera(1,1,1,1,.1,1);function resizeHandler(){_camera.left=Stage.width/-2,_camera.right=Stage.width/2,_camera.top=Stage.height/2,_camera.bottom=Stage.height/-2,_camera.near=.01,_camera.far=1e3,_camera.updateProjectionMatrix(),_camera.position.x=Stage.width/2,_camera.position.y=-Stage.height/2}this.interaction=new GLUIStageInteraction2D(_camera,_scene,Stage),this.alpha=1,this.scene=_scene,_scene.disableAutoSort=!0,_camera.position.z=1,function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),resizeHandler(),this.add=function($obj){$obj.parent=_this,_scene.add($obj.group||$obj.mesh)},this.remove=function($obj){$obj.parent=null,_scene.remove($obj.group)},this.clear=function(){_scene.traverse((obj=>{obj.geometry&&obj.shader&&obj.destroy()})),_scene.children.length=_scene.childrenLength=0},this.renderToRT=function(scene,rt){let clearAlpha;rt&&rt.fxscene&&rt.fxscene.clearAlpha>-1&&(clearAlpha=World.RENDERER.getClearAlpha(),World.RENDERER.setClearAlpha(0));let autoClear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.render(scene,_camera,rt),World.RENDERER.autoClear=autoClear,clearAlpha&&World.RENDERER.setClearAlpha(clearAlpha)},this.get("camera",(()=>_camera)),this.resize=resizeHandler,this.render=function loop(){if(!_scene.children.length)return;let clear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.render(_scene,_camera,null,!0),World.RENDERER.autoClear=clear},this.renderDirect=callback=>{_scene.children.length&&(_scene.traverse((obj=>{obj.shader&&(obj.shader.depthTest=!1)})),callback(_scene,_camera))}})),Class((function GLUIStage3D(){Inherit(this,Object3D);const _this=this;var _camera,_externalRenders=[],_scene=new Scene,_list=new LinkedList;this.alpha=1,this.interaction=new GLUIStageInteraction3D,this.add=function(obj,parent){obj.parent=_this,obj._gluiParent=parent,obj.anchor&&(obj.anchor._gluiParent=parent),obj._3d||obj.enable3D(),obj.deferRender()},this.clear=function(){_scene.traverse((obj=>{obj.geometry&&obj.shader&&obj.destroy()})),_scene.children.length=_scene.childrenLength=0},this.addDeferred=function(obj){_list.push(obj),_scene.add(obj.group||obj.mesh)},this.remove=function(obj){_scene.remove(obj.group||obj.mesh),_list.remove(obj)},this.disableAutoSort=function(){_scene.disableAutoSort=!0},this.renderToRT=function(scene,camera){camera=camera.camera||camera,scene.traverse((mesh=>{let obj=mesh.glui||mesh;obj&&obj.anchor&&obj.anchor.determineVisible()&&Utils3D.decompose(obj.anchor,obj.group||obj)})),scene._textRenderCamera=camera,_externalRenders.push(scene)},this.renderToRT2=function(scene,rt,camera){let clearAlpha;rt.fxscene&&rt.fxscene.clearAlpha>-1&&(clearAlpha=World.RENDERER.getClearAlpha(),World.RENDERER.setClearAlpha(0));let autoClear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.render(scene,camera,rt),World.RENDERER.autoClear=autoClear,clearAlpha&&World.RENDERER.setClearAlpha(clearAlpha)},this.render=function loop(){if(!window.Metal){if(_list.length){let obj=_list.start();for(;obj;)obj._marked&&(obj._marked=!1,Utils3D.decompose(obj.anchor,obj.group)),obj=_list.next();let clear=World.RENDERER.autoClear;Renderer.context.clear(Renderer.context.DEPTH_BUFFER_BIT),World.RENDERER.autoClear=!1,World.RENDERER.render(_scene,_camera||World.CAMERA),World.RENDERER.autoClear=clear}if(_externalRenders.length)for(;_externalRenders.length;){let scene=_externalRenders.shift(),camera=scene._textRenderCamera,clear=World.RENDERER.autoClear;Renderer.context.clear(Renderer.context.DEPTH_BUFFER_BIT),World.RENDERER.autoClear=!1,World.RENDERER.render(scene,camera),World.RENDERER.autoClear=clear}}},this.mark=function mark(){let obj=_list.start();for(;obj;)obj.anchor._parent&&(obj.group.visible=obj.anchor.determineVisible()),obj.mesh&&obj.mesh.determineVisible()&&obj.anchor._parent&&(obj._marked=!0),obj=_list.next()},this.renderDirect=function(callback){if(_list.length){let obj=_list.start();for(;obj;)obj._marked&&(obj._marked=!1,Utils3D.decompose(obj.anchor,obj.group)),obj=_list.next();_scene.traverse((obj=>{obj.shader&&(obj.shader.depthTest=!1)})),callback(_scene,_camera||World.CAMERA)}},this.set("camera",(c=>{_camera=c.camera||c}))})),Class((function GLUITexture(_layout,_w,_h,_rtPool,_strict){Inherit(this,Component);const _this=this;var _rt,_camera,_hitCamera,_interaction,_ray,_needsRender,_rendered,_hitEvt,_usingFingers,$glObj,_needsRenderCount=0,_needsRenderTimerCount=0,_scene=new Scene,_mouse=new Vector2,_stage=new Vector2,_v3=new Vector3,_enabled=!0,_width=_w,_height=_h,_cacheHits=[];function loop(){_enabled&&(_this.manualRender&&!_needsRender&&0==_needsRenderCount||render())}function render(){let clearAlpha=World.RENDERER.getClearAlpha(),autoClear=World.RENDERER.autoClear;_this.disableClear&&(World.RENDERER.autoClear=!1);let clearColor=World.RENDERER.getClearColor().getHex();clearColor>0?World.RENDERER.setClearColor(0,0):World.RENDERER.setClearAlpha(0),World.RENDERER.render(_scene,_camera,_rt),clearColor>0?World.RENDERER.setClearColor(clearColor,clearAlpha):World.RENDERER.setClearAlpha(clearAlpha),_this.disableClear&&(World.RENDERER.autoClear=autoClear),_needsRenderCount>0&&(_needsRenderCount-=1),_rendered=!0}function noop(){}function hitUpdate(hit){let x=hit.uv.x*_width,y=(1-hit.uv.y)*_height;_usingFingers=hit.usingFinger,_this.isHitting=!0,_mouse.set(x,y),_enabled&&_interaction&&(hit.usingFinger?_interaction.testWithFinger(_mouse,hit.distance):_interaction.testWith(_mouse))}function missUpdate(){_this.isHitting=!1,_mouse.set(9999,9999),_interaction&&(_usingFingers?_interaction.testWithFinger(_mouse,9999):_interaction.testWith(_mouse))}function raycastMove(e){_ray||(_ray=_this.initClass(Raycaster,_hitCamera));let hit,input=Interaction3D.find(_hitCamera).input;if(Array.isArray(input.obj)){_cacheHits.length=0;for(let i=0;i<input.obj.length;i++){let obj=input.obj[i];_v3.set(0,0,-1).applyQuaternion(obj.quaternion);let hit=_ray.checkFromValues($glObj.mesh,obj.position,_v3)[0];hit&&_cacheHits.push(hit)}_cacheHits.sort(((a,b)=>a.distance-b.distance)),hit=_cacheHits[0]}else"2d"==input.type?hit=_ray.checkHit($glObj.mesh,input.position,input.rect||Stage)[0]:(_v3.set(0,0,-1).applyQuaternion(input.quaternion),hit=_ray.checkFromValues($glObj.mesh,input.position,_v3)[0]);_hitEvt||(_hitEvt={normal:new Vector2,tilt:new Vector2,pos:new Vector2}),hit?(_hitEvt.normal.set(hit.uv.x,1-hit.uv.y),_hitEvt.tilt.set(Math.range(_hitEvt.normal.x,0,1,-1,1),Math.range(_hitEvt.normal.y,0,1,-1,1)),_hitEvt.pos.set(_hitEvt.normal.x*_width,_hitEvt.normal.y*_height),_hitEvt.hit=hit,_this.onDragMove&&_this.onDragMove(_hitEvt)):_this.onDragMove&&_this.onDragMove(null)}function flipNeedsRender(){if(!(--_needsRenderTimerCount>0))return _needsRender&&!_rendered?scheduleFlipNeedsRender():void(_needsRender=!1)}function scheduleFlipNeedsRender(time=1){_needsRenderTimerCount+=1,Timer.create(flipNeedsRender,time)}function doCheckObjectHit(object,callback){if(_this._invisible)return;let hit=callback(Interaction3D.find(_hitCamera));if(hit){let x=hit.uv.x*_width,y=(1-hit.uv.y)*_height;return _interaction.checkObjectHit(object,{x:x,y:y})}}this.disableClear=!1,function(){"number"==typeof _layout&&(_strict=_rtPool,_rtPool=_h,_h=_w,_w=_layout,_layout={element:$gl()}),_width=_w,_height=_h,"boolean"==typeof _rtPool&&(_strict=_rtPool,_rtPool=null);let dpr=_strict?1:RenderManager.DPR;_rtPool?_this.rt=_rtPool.nullRT:(_rt=Utils3D.createRT(_width*dpr,_height*dpr,null,Texture.RGBAFormat),_this.rt=_rt),_this.root=_layout.element,_this.root.stageLayoutCapture=_this,_scene.add(_layout.element.group),(_camera=new OrthographicCamera).setViewport(_width,_height),_camera.position.z=1,_camera.position.x=_width/2,_camera.position.y=-_height/2,_scene.disableAutoSort=!0,_stage.set(_width,_height),function findHitCamera(){let p=_this.parent;for(;p;){if(_hitCamera=p.nuke?.camera,_hitCamera)return;p=p.parent}_hitCamera=World.CAMERA}(),_interaction=_this.initClass(GLUIStageInteraction2D,_camera,_scene,_stage,!0),_this.startRender(loop,RenderManager.AFTER_LOOPS)}(),this.onVisible=function(){_rtPool&&(_rt=_this.rt=_rtPool.getRT())},this.onInvisible=function(){_rtPool&&_rtPool.putRT(_rt)},this.setSize=function(width,height){_width=width,_height=height,_camera.setViewport(_width,_height),_camera.position.z=1,_camera.position.x=_width/2,_camera.position.y=-_height/2,_stage.set(width,height)},this.render=function(){render()},this.get("object3d",(()=>$glObj)),this.set("object3d",(gl=>{gl.mesh||(gl={mesh:gl}),($glObj=gl).mesh.onHitUpdate=hitUpdate,$glObj.mesh.onMissUpdate=missUpdate,_hitCamera&&Interaction3D.find(_hitCamera).add($glObj.mesh,noop,noop)})),this.get("camera",(()=>_camera)),this.set("hitCamera",(camera=>{camera!=_hitCamera&&($glObj&&Interaction3D.find(_hitCamera).remove($glObj.mesh),_hitCamera=camera,$glObj&&Interaction3D.find(_hitCamera).add($glObj.mesh,noop,noop),_ray&&(_ray.camera=_hitCamera))})),this.set("enabled",(v=>{_interaction._disabled=!v,_enabled=v})),this.get("enabled",(_=>_enabled)),this.set("mouseEnabled",(v=>{v?(_interaction._disabled=!1,$glObj.mesh.onHitUpdate=hitUpdate,$glObj.mesh.onMissUpdate=missUpdate,_hitCamera&&Interaction3D.find(_hitCamera).add($glObj.mesh,noop,noop)):(_interaction._disabled=!0,$glObj&&(_hitCamera&&Interaction3D.find(_hitCamera).remove($glObj.mesh),delete $glObj.mesh.onHitUpdate,delete $glObj.mesh.onMissUpdate))})),this.set("layout",(layout=>{_layout&&_scene.remove(_layout.element.group),_scene.add(layout.element.group),_layout=layout})),this.get("layout",(_=>_layout)),this.get("scene",(_=>_scene)),this.get("width",(_=>_width)),this.get("height",(_=>_height)),this.onVisible=function(){_rtPool&&(_rt=_this.rt=_rtPool.getRT()),_this.needsRenderCount=10},this.onInvisible=function(){_rtPool&&_this.rt!=_rtPool.nullRT&&(_rtPool.putRT(_this.rt),_rt=_this.rt=_rtPool.nullRT)},this.onDestroy=function(){_rtPool?_this.onInvisible():_this.rt.destroy(),$glObj&&(Interaction3D.find(_hitCamera).remove($glObj.mesh),delete $glObj.mesh.onHitUpdate,delete $glObj.mesh.onMissUpdate)},this.bindMove=function(){_this.startRender(raycastMove)},this.unbindMove=function(){_this.stopRender(raycastMove)},this.get("needsRender",(()=>_needsRender)),this.set("needsRender",(value=>{_needsRender=!0,_rendered=!1,scheduleFlipNeedsRender("number"==typeof value?value:1e3)})),this.get("needsRenderCount",(()=>_needsRenderCount)),this.set("needsRenderCount",(value=>{_needsRenderCount=Math.max(_needsRenderCount,value)})),_this.checkObjectHit=function(object,mouse){return doCheckObjectHit(object,(interaction=>interaction.checkObjectHit($glObj.mesh,mouse)))},_this.checkObjectFromValues=function(object,origin,direction){return doCheckObjectHit(object,(interaction=>interaction.checkObjectFromValues($glObj.mesh,origin,direction)))},_this.getObjectHitLocalCoords=function(v,object,mouse){return Interaction3D.find(_hitCamera).getObjectHitLocalCoords(v,$glObj.mesh,mouse),mouse={x:(.5+v.x)*_width,y:(.5-v.y)*_height},_interaction.getObjectHitLocalCoords(v,object.mesh,mouse)}}),(_=>{GLUITexture.createRTPool=function(width,height,strict){let pool=RTPool.instance().clone({format:Texture.RGBAFormat}),dpr=strict?1:RenderManager.DPR;return pool.setSize(width*dpr,height*dpr),pool}})),Class((function GLUITextureDragHelper(_capture,$obj){Inherit(this,Component);const _this=this;function dragMove(e){_this.flag("persist")||(e||_capture.unbindMove(),e&&_this.flag("handMode")&&e.hit.distance>_this.distanceThreshold&&_capture.unbindMove()),!_this.onDragMove||_this.flag("persist")&&!e||_this.onDragMove(e)}function vrButton(e){_this.flag("persist")||"trigger"==e.label&&(e.pressed?_this.flag("hover")&&_capture.bindMove():_capture.unbindMove())}function mouseDown(e){_this.flag("persist")||(_this.flag("mouse_down",!0),_this.flag("hover")&&_capture.bindMove())}function mouseUp(e){_this.flag("persist")||(_this.flag("mouse_down",!1),_capture.unbindMove())}function hover(e){_this.flag("persist")||(_this.flag("hover","over"==e.action),window.VRInput&&(VRInput.isSetupFakeHands||VRInput.isSetupHands)&&(_this.flag("handMode",!0),_capture.bindMove()))}this.distanceThreshold=.2,$obj&&$obj.interact(hover,(_=>{})),function addListeners(){_this.events.sub(Mouse.input,Interaction.START,mouseDown),_this.events.sub(Mouse.input,Interaction.END,mouseUp),window.VRInput&&VRInput.ready().then((_=>{VRInput.controllers.forEach((c=>{_this.events.sub(VRInput.BUTTON,vrButton)}))}))}(),_capture.onDragMove=dragMove,this.persistMove=function(){_capture.bindMove(),_this.flag("persist",!0)}})),Module((function FirefoxGPUFixer(){this.exports=function(){GPU.detect("radeon r9 200")&&("mac"==Device.system.os||Device.pixelRatio>1)&&(Device.graphics.webgl.gpu="radeon pro 455")}})),Class((function GPU(){Inherit(this,Component);var _this=this,_split={};Hydra.ready((async()=>{for(var key in _this.detect=function(match){if(Device.graphics.gpu)return Device.graphics.gpu.detect(match)},_this.detectAll=function(){if(Device.graphics.gpu){for(var match=!0,i=0;i<arguments.length;i++)Device.graphics.gpu.detect(arguments[i])||(match=!1);return match}},_this.matchGPU=function(str,min,max=99999){let num=function splitGPU(string){if(_split[string])return _split[string];if(!_this.detect(string))return-1;try{var num=Number(_this.gpu.split(string)[1].split(" ")[0].replace(/[^a-zA-Z0-9]/g,"").trim());return _split[string]=num,num}catch(e){return-1}}(str);return num>=min&&num<max},_this.gpu=Device.graphics.gpu?Device.graphics.gpu.identifier:"","apple gpu"==_this.gpu&&(Device.mobile?await require("iOSGPUTest")():require("MacOSPerformanceTest")()),"firefox"===Device.system.browser&&require("FirefoxGPUFixer")(),_this.BLOCKLIST=require("GPUBlocklist").match(),_this.T0=!(Device.mobile||!_this.BLOCKLIST&&!_this.detect("radeon(tm) r5")&&!_this.detect("radeon r9 200")&&!_this.detect("hd graphics family")&&!_this.detect("intel(r) uhd graphics direct")&&!_this.matchGPU("hd graphics ",1e3,5001)&&!(_this.matchGPU("hd graphics ",0,618)&&Device.pixelRatio>1)&&!(_this.detect(["hd graphics","iris"])&&Math.max(Stage.width,Stage.height)>1800)&&!_this.detect(["intel iris opengl engine"])&&!_this.matchGPU("iris(tm) graphics ",1e3)),_this.T1=!(_this.BLOCKLIST||Device.mobile||_this.T0||!_this.matchGPU("iris(tm) graphics ",540,1e3)&&!_this.matchGPU("hd graphics ",514,1e3)&&!_this.matchGPU("intel(r) uhd graphics ",600,1e3)&&_this.detect(["nvidia","amd","radeon","geforce"])&&!_this.detect(["vega 8"])),_this.T2=!_this.BLOCKLIST&&!Device.mobile&&!(!_this.detect(["nvidia","amd","radeon","geforce"])||_this.T1||_this.T0),_this.T3=!(_this.BLOCKLIST||Device.mobile||!_this.detect(["titan","amd radeon pro","quadro"])&&!_this.matchGPU("gtx ",940)&&!_this.matchGPU("radeon (tm) rx ",400)&&!_this.detect("amd radeon(tm) graphics direct3d11 vs_5_0")&&!_this.matchGPU("radeon rx ",400)&&!_this.matchGPU("radeon pro ",420)),_this.T4=!(_this.BLOCKLIST||Device.mobile||!_this.detect(["titan","quadro","radeon vii","apple m"])&&!_this.matchGPU("gtx ",1060)&&!_this.matchGPU("rtx")&&!_this.matchGPU("radeon rx ",500)&&!_this.matchGPU("vega ",50)&&!_this.detect(["radeon pro 5300m","radeon pro 5500m","radeon pro 5600m","amd radeon unknown prototype"])),_this.T5=!(_this.BLOCKLIST||Device.mobile||!_this.detect(["titan","radeon vii"])&&!_this.matchGPU("gtx ",1080)&&!_this.matchGPU("rtx ",2060)&&!_this.matchGPU("radeon rx ",5500)&&(!_this.detect("apple m")||!_this.detect("max"))),_this.MT0=!!Device.mobile&&(!!_this.BLOCKLIST||!("ios"!=Device.system.os||!_this.detect("a7"))||!("android"!=Device.system.os||!_this.detect("sgx"))||(_this.detect("adreno")?_this.matchGPU("adreno (tm) ",0,415):_this.detect("mali")?_this.matchGPU("mali-t",0,628):!("ios"!=Device.system.os||!_this.detect(["a8","a9"]))||!!_this.detect("mali-g")||!!_this.matchGPU("adreno (tm) ",420))),_this.MT1=function(){if(!Device.mobile)return!1;if(_this.BLOCKLIST)return!1;if("ios"==Device.system.os&&_this.detect("a10"))return!0;if("android"==Device.system.os&&!_this.MT0)return!0;if(_this.detect("nvidia tegra")&&Device.detect("pixel c"))return!0;if(_this.detect("mali-g"))return _this.matchGPU("mali-g",73);if(_this.detect("adreno")){if(_this.matchGPU("adreno (tm) ",600,616))return!0;if(_this.matchGPU("adreno (tm) ",530,600))return!0}return!1}(),_this.MT2=!!Device.mobile&&!_this.BLOCKLIST&&(!("ios"!=Device.system.os||!_this.detect(["a11","a12"]))||(_this.detect("adreno")?_this.matchGPU("adreno (tm) ",630):_this.detect("mali-g")?_this.matchGPU("mali-g",74):!(!navigator.platform.toLowerCase().includes(["mac","windows"])||"chrome"!=Device.system.browser))),_this.MT3=!!Device.mobile&&!_this.BLOCKLIST&&(!("ios"!=Device.system.os||!_this.detect(["a12","a13","a14","a15","a16","a17","a18"]))||(_this.detect("adreno")?_this.matchGPU("adreno (tm) ",640):_this.detect("mali-g")?_this.matchGPU("mali-g",76):!(!navigator.platform.toLowerCase().includes(["mac","windows"])||"chrome"!=Device.system.browser))),_this.MT4=!!Device.mobile&&!_this.BLOCKLIST&&(!("ios"!=Device.system.os||!_this.detect(["a14","a15","a16","a17","a18","a19","a20","apple m"]))||(_this.detect("adreno")?_this.matchGPU("adreno (tm) ",650):_this.detect("mali-g")?_this.detect("mali-g710")||_this.matchGPU("mali-g",78):!(!navigator.platform.toLowerCase().includes(["mac","windows"])||"chrome"!=Device.system.browser))),_this.MT5=!!Device.mobile&&!_this.BLOCKLIST&&(!("ios"!=Device.system.os||!_this.detect(["a16","a17","a18","a19","a20","a21","a22","a23","a24","a25","apple m"]))||(_this.detect("adreno")?_this.matchGPU("adreno (tm) ",740):!(!navigator.platform.toLowerCase().includes(["mac","windows"])||"chrome"!=Device.system.browser))),_this.lt=function(num){return _this.TIER>-1&&_this.TIER<=num},_this.gt=function(num){return _this.TIER>-1&&_this.TIER>=num},_this.eq=function(num){return _this.TIER>-1&&_this.TIER==num},_this.mobileEq=function(num){return _this.M_TIER>-1&&_this.M_TIER==num},_this.mobileLT=function(num){return _this.M_TIER>-1&&_this.M_TIER<=num},_this.mobileGT=function(num){return _this.M_TIER>-1&&_this.M_TIER>=num},_this)"T"==key.charAt(0)&&!0===_this[key]&&(_this.TIER=Number(key.charAt(1))),"MT"==key.slice(0,2)&&!0===_this[key]&&(_this.M_TIER=Number(key.charAt(2)));!1!==Utils.query("gpu")&&(Device.mobile||Utils.query("gpu").toString().includes("m")?(_this.TIER=-1,_this.M_TIER=Number(Utils.query("gpu").slice(1))):_this.TIER=Number(Utils.query("gpu"))),"ios"==Device.system.os&&Render.REFRESH_RATE<40&&(_this.M_TIER-=1),_this.OVERSIZED=!Device.mobile&&_this.TIER<=0&&Math.max(window.innerWidth,window.innerHeight)>1400||!Device.mobile&&_this.TIER<=1&&Device.pixelRatio<2&&Math.max(window.innerWidth,window.innerHeight)>1600,"ie"==Device.system.browser&&(_this.OVERSIZED=!0),_this.initialized=!0})),this.ready=function(){return this.wait("initialized")}}),"static"),Module((function MacOSPerformanceTest(){function test(){let results=[];function getPrime(){return function largest_prime_factor(n){return factors(n).filter(primep).pop()}(1e12)}function factors(n){var i,out=[],sqrt_n=Math.sqrt(n);for(i=2;i<=sqrt_n;i++)n%i==0&&out.push(i);return out}function primep(n){return 0===factors(n).length}for(let i=0;i<3;i++){let time=performance.now();getPrime(),results.push(10*(performance.now()-time))}return results.sort(((a,b)=>a-b)),results[0]}this.exports=function(){let result=test();screen.width<=1440&&screen.height<=900?Device.graphics.webgl.gpu=result>540?"intel iris opengl engine":"safari tier 1":Device.graphics.webgl.gpu=result>475?result>540?"intel iris opengl engine":"safari tier 1":result<375?"amd radeon pro 455 opengl engine":"nvidia geforce 750m opengl engine"}})),Module((function iOSGPUTest(){function getRenderer(complete){
/*! VERSION = 1.657942 */
var decisionTree={Version:"1.657942",PublishDate:"2023-10-05T13:31:50.4807708Z",Data:[{x:"Unknown",m:function(n){return function family(){var segments=/iPhone|iPad|Macintosh/.exec(navigator.userAgent);if(segments&&segments.length>0)return segments[0];return""}()},n:[108,3,2,1]},{x:"Apple A9X GPU|Apple A10X GPU|Apple A9 GPU|Apple A10 GPU|Apple A11 GPU|Apple A12X GPU|Apple A12 GPU|Apple A8 GPU|Apple A8X GPU|Apple A13 GPU|Apple A14 GPU|Apple M1 GPU|Apple A12Z GPU|Apple A15 GPU|Apple A7 GPU|Apple A16 GPU|Apple M2 GPU|Apple A17 Pro GPU",m:function(n){return height()},n:[109,63,60,61,62,47,45,46,33,36,32,34,35,23,18,19,11,6,7,5],v:["Macintosh"]},{x:"Apple A7 GPU|Apple A8 GPU|Apple A9 GPU|Apple A10 GPU|Apple A11 GPU|Apple A12 GPU|Apple A13 GPU|Apple A14 GPU|Apple A15 GPU|Apple A16 GPU|Apple A17 Pro GPU",m:function(n){return height()},n:[60,61,62,44,45,46,30,31,23,17,12,6,7],v:["iPhone"]},{x:"Apple A7 GPU|Apple A8 GPU|Apple A9X GPU|Apple A10X GPU|Apple A9 GPU|Apple A12X GPU|Apple A10 GPU|Apple A12 GPU|Apple A8X GPU|Apple M1 GPU|Apple A14 GPU|Apple A12Z GPU|Apple A15 GPU|Apple A13 GPU|Apple M2 GPU",m:function(n){return height()},n:[109,110,63,47,33,32,18,4],v:["iPad"]},{x:"Apple A7 GPU|Apple A8 GPU|Apple A9X GPU|Apple A10X GPU|Apple A9 GPU|Apple A12X GPU|Apple A10 GPU|Apple A12 GPU|Apple A8X GPU|Apple M1 GPU|Apple A12Z GPU|Apple M2 GPU",m:function(n){return mediacolorgamut()},n:[16,13],v:[2048]},{x:"Apple A9X GPU|Apple A10X GPU|Apple A9 GPU|Apple A12X GPU|Apple A10 GPU|Apple A12 GPU|Apple A8 GPU|Apple A8X GPU|Apple M1 GPU|Apple A12Z GPU|Apple A7 GPU|Apple M2 GPU",m:function(n){return mediacolorgamut()},n:[16,14],v:[2048]},{x:"Apple A11 GPU|Apple A12 GPU|Apple A13 GPU|Apple A14 GPU|Apple A15 GPU|Apple A16 GPU|Apple A17 Pro GPU",m:function(n){return hash3d()},n:[114,73,74,72,75,21,26,20,8],v:[2436]},{x:"Apple A11 GPU|Apple A12 GPU|Apple A14 GPU|Apple A13 GPU|Apple A15 GPU|Apple A16 GPU|Apple A17 Pro GPU",m:function(n){return hash3d()},n:[121,120,115,50,27,28,21,9],v:[2079]},{x:"Apple A16 GPU|Apple A17 Pro GPU|Apple A14 GPU|Apple A15 GPU|Apple A12 GPU|Apple A13 GPU",m:function(n){return hash()},n:[43,15],v:[3711606621]},{x:"Apple A17 Pro GPU|Apple A16 GPU|Apple A15 GPU|Apple A14 GPU|Apple A13 GPU|Apple A12 GPU",m:function(n){return hash()},n:[103,10],v:[3711606621]},{x:"Apple A17 Pro GPU|Apple A16 GPU|Apple A15 GPU|Apple A14 GPU",v:[235283973]},{x:"Apple A9 GPU|Apple A10 GPU|Apple A11 GPU|Apple A13 GPU|Apple A15 GPU|Apple A7 GPU|Apple A8 GPU",m:function(n){return mediacolorgamut()},n:[38,25],v:[1136]},{x:"Apple A7 GPU|Apple A9 GPU|Apple A10 GPU|Apple A11 GPU|Apple A8 GPU|Apple A13 GPU|Apple A15 GPU",m:function(n){return mediacolorgamut()},n:[37,38],v:[1136]},{x:"Apple A7 GPU|Apple A8 GPU|Apple A9X GPU|Apple A9 GPU|Apple A10 GPU|Apple A8X GPU",m:function(n){return hash()},n:[149,148,89,90,91,92,55,56,58,54,57],v:["srgb"]},{x:"Apple A9X GPU|Apple A9 GPU|Apple A10 GPU|Apple A8 GPU|Apple A8X GPU|Apple A7 GPU",m:function(n){return hash()},n:[149,153,97,98,92,55,56,58,54],v:["srgb"]},{x:"Apple A16 GPU|Apple A17 Pro GPU|Apple A14 GPU|Apple A15 GPU",v:[235283973]},{x:"Apple A10X GPU|Apple A9X GPU|Apple A12X GPU|Apple A12 GPU|Apple M1 GPU|Apple A12Z GPU|Apple M2 GPU",m:function(n){return hash3d()},n:[150,126,127,94,93,95,79],v:["p3"]},{x:"Apple A8 GPU|Apple A9 GPU|Apple A10 GPU|Apple A11 GPU|Apple A13 GPU|Apple A15 GPU",m:function(n){return mediacolorgamut()},n:[68,39],v:[1334]},{x:"Apple A9X GPU|Apple A10X GPU|Apple A12X GPU|Apple M1 GPU|Apple A12Z GPU|Apple M2 GPU",m:function(n){return mediacolorgamut()},n:[111,24],v:[2732]},{x:"Apple A9 GPU|Apple A10 GPU|Apple A11 GPU|Apple A13 GPU|Apple A15 GPU|Apple A8 GPU",m:function(n){return mediacolorgamut()},n:[70,39],v:[1334]},{x:"Apple A14 GPU|Apple A16 GPU|Apple A15 GPU|Apple A13 GPU",m:function(n){return hash()},n:[157,100,42],v:[3403189785]},{x:"Apple A14 GPU|Apple A15 GPU",m:function(n){return hash()},n:[22],v:[2364051618]},{x:"Apple A15 GPU|Apple A14 GPU",v:[2775654583]},{x:"Apple A14 GPU|Apple A15 GPU",m:function(n){return hash3d()},n:[74,51,40,21,29],v:[2532]},{x:"Apple A10X GPU|Apple A12X GPU|Apple M1 GPU|Apple A12Z GPU|Apple M2 GPU",m:function(n){return hash3d()},n:[152,151,150,126,127,41],v:["p3"]},{x:"Apple A9 GPU|Apple A10 GPU|Apple A7 GPU|Apple A8 GPU",m:function(n){return hash3d()},n:[155,156,99],v:["srgb"]},{x:"Apple A14 GPU|Apple A16 GPU|Apple A15 GPU",v:[46273595]},{x:"Apple A14 GPU|Apple A15 GPU|Apple A16 GPU|Apple A13 GPU",m:function(n){return hash()},n:[157,101,102],v:[3403189785]},{x:"Apple A15 GPU|Apple A16 GPU|Apple A14 GPU",v:[46273595]},{x:"Apple A15 GPU|Apple A14 GPU",v:[3711606621]},{x:"Apple A8 GPU|Apple A10 GPU|Apple A11 GPU|Apple A9 GPU",m:function(n){return mediacolorgamut()},n:[64,65],v:[2001]},{x:"Apple A8 GPU|Apple A9 GPU|Apple A10 GPU|Apple A11 GPU",m:function(n){return mediacolorgamut()},n:[66,67],v:[2208]},{x:"Apple A12X GPU|Apple M1 GPU|Apple A12Z GPU|Apple M2 GPU",m:function(n){return hash3d()},n:[126,127,79,78],v:[2388]},{x:"Apple A14 GPU|Apple M1 GPU",m:function(n){return mediacolorgamut()},n:[112,48],v:[2360]},{x:"Apple A9 GPU|Apple A10 GPU|Apple A11 GPU|Apple A8 GPU",m:function(n){return mediacolorgamut()},n:[69,67],v:[2208]},{x:"Apple A10 GPU|Apple A11 GPU|Apple A9 GPU|Apple A8 GPU",m:function(n){return mediacolorgamut()},n:[71,65],v:[2001]},{x:"Apple A14 GPU|Apple A15 GPU|Apple M2 GPU",m:function(n){return function ratio(){return window.devicePixelRatio}()},n:[113,49],v:[2778]},{x:"Apple A7 GPU|Apple A9 GPU|Apple A8 GPU",m:function(n){return hash()},n:[130,131,82,83,84],v:["srgb"]},{x:"Apple A10 GPU|Apple A11 GPU|Apple A13 GPU|Apple A15 GPU",m:function(n){return hash3d()},n:[132,133,118,134,85,86],v:["p3"]},{x:"Apple A10 GPU|Apple A11 GPU|Apple A13 GPU|Apple A15 GPU",m:function(n){return hash()},n:[144,145,147,146,87,88],v:["p3"]},{x:"Apple A14 GPU|Apple A15 GPU",m:function(n){return hash()},n:[100,104],v:[3403189785]},{x:"Apple M1 GPU|Apple A10X GPU|Apple A12Z GPU|Apple M2 GPU",m:function(n){return hash()},n:[174,107,159,106],v:[3403189785]},{x:"Apple A14 GPU|Apple A16 GPU|Apple A15 GPU",v:[2775654583]},{x:"Apple A12 GPU|Apple A13 GPU",v:[3565683531]},{x:"Apple A14 GPU|Apple A15 GPU",m:function(n){return hash3d()},n:[74,122,77,52,29],v:[2778]},{x:"Apple A16 GPU|Apple A17 Pro GPU",m:function(n){return hash3d()},n:[123],v:[2796]},{x:"Apple A16 GPU|Apple A17 Pro GPU",m:function(n){return hash3d()},n:[123,53],v:[2556]},{x:"Apple A10 GPU|Apple A12 GPU|Apple A13 GPU",m:function(n){return hash()},n:[128,129,80,81],v:[2160]},{x:"Apple A14 GPU|Apple M1 GPU",m:function(n){return hash3d()},n:[74,96,59],v:["p3"]},{x:"Apple A14 GPU|Apple A15 GPU",m:function(n){return hash3d()},n:[74,122,77,52,29],v:[3]},{x:"Apple A14 GPU",v:[105985484,679860869]},{x:"Apple A15 GPU",v:[46273595,679860869]},{x:"Apple A14 GPU|Apple A15 GPU",m:function(n){return hash()},n:[22],v:[3403189785]},{x:"Apple A17 Pro GPU|Apple A16 GPU",v:[3711606621]},{x:"Apple A7 GPU",v:[1915583345]},{x:"Apple A9X GPU|Apple A9 GPU|Apple A10 GPU",v:[3129316290,3249312110]},{x:"Apple A9 GPU|Apple A9X GPU|Apple A10 GPU",m:function(n){return hash3d()},n:[168,105],v:[2114570256]},{x:"Apple A7 GPU",v:[857422828]},{x:"Apple A9X GPU|Apple A9 GPU|Apple A10 GPU",m:function(n){return hash3d()},n:[171],v:[63583436]},{x:"Apple A14 GPU|Apple M1 GPU",m:function(n){return hash()},n:[175,107],v:[3403189785]},{x:"Apple A12 GPU|Apple A13 GPU",m:function(n){return hash3d()},n:[116,115,76],v:[2688]},{x:"Apple A12 GPU|Apple A13 GPU",m:function(n){return hash3d()},n:[118,117,76],v:[1624]},{x:"Apple A12 GPU|Apple A13 GPU",m:function(n){return hash3d()},n:[118,119,76],v:[1792]},{x:"Apple A10X GPU|Apple A12 GPU",m:function(n){return hash()},n:[125,124],v:[2224]},{x:"Apple A8 GPU|Apple A9 GPU",m:function(n){return hash()},n:[135,136],v:["srgb"]},{x:"Apple A10 GPU|Apple A11 GPU",m:function(n){return hash()},n:[137,138],v:["p3"]},{x:"Apple A8 GPU|Apple A9 GPU",m:function(n){return hash()},n:[139,140],v:["srgb"]},{x:"Apple A10 GPU|Apple A11 GPU",m:function(n){return hash()},n:[137,141],v:["p3"]},{x:"Apple A8 GPU|Apple A9 GPU",m:function(n){return hash()},n:[142,143],v:["srgb"]},{x:"Apple A9 GPU|Apple A8 GPU",m:function(n){return hash()},n:[154,140],v:["srgb"]},{x:"Apple A9 GPU|Apple A8 GPU",m:function(n){return hash()},n:[154,143],v:["srgb"]},{x:"Apple A9 GPU|Apple A8 GPU",m:function(n){return hash()},n:[154,136],v:["srgb"]},{x:"Apple A12 GPU",v:[958581112,4085158452]},{x:"Apple A13 GPU",v:[1278953537,3335845976,4193218782]},{x:"Apple A14 GPU",v:[105985484]},{x:"Apple A12 GPU",v:[2301174800]},{x:"Apple A13 GPU|Apple A12 GPU",v:[3711606621]},{x:"Apple A14 GPU|Apple A15 GPU",m:function(n){return hash()},n:[104],v:[2364051618]},{x:"Apple A12X GPU|Apple A12Z GPU",v:[4085158452]},{x:"Apple M1 GPU|Apple M2 GPU",m:function(n){return hash()},n:[158,159],v:[3403189785]},{x:"Apple A12 GPU|Apple A13 GPU",m:function(n){return hash3d()},n:[160,75],v:[2206992415]},{x:"Apple A13 GPU|Apple A12 GPU",m:function(n){return hash3d()},n:[160,75],v:[2866949877]},{x:"Apple A9 GPU",v:[46663968,3129316290]},{x:"Apple A9 GPU",v:[2114570256]},{x:"Apple A9 GPU",v:[63583436]},{x:"Apple A13 GPU|Apple A15 GPU",m:function(n){return hash()},n:[161,162],v:[3403189785]},{x:"Apple A13 GPU|Apple A15 GPU",m:function(n){return hash()},n:[163,164],v:[3711606621]},{x:"Apple A11 GPU|Apple A13 GPU",m:function(n){return hash3d()},n:[165,166],v:[1349146759]},{x:"Apple A13 GPU|Apple A11 GPU",m:function(n){return hash3d()},n:[167,160],v:[2206992415]},{x:"Apple A8 GPU|Apple A8X GPU",v:[1361285941,3816812018,4125234388]},{x:"Apple A8 GPU|Apple A8X GPU",m:function(n){return hash3d()},n:[169,170],v:[4005673483]},{x:"Apple A8 GPU|Apple A8X GPU",m:function(n){return hash3d()},n:[169],v:[1350183384]},{x:"Apple A8 GPU|Apple A8X GPU",m:function(n){return hash3d()},n:[173,172],v:[2870741841]},{x:"Apple A10X GPU|Apple A9X GPU",v:[583354101,3458129248]},{x:"Apple A12X GPU|Apple A12 GPU",v:[4085158452]},{x:"Apple A10X GPU|Apple A9X GPU",v:[3928876783]},{x:"Apple M1 GPU",v:[2364051618]},{x:"Apple A8 GPU|Apple A8X GPU",m:function(n){return hash3d()},n:[176,170],v:[4005673483]},{x:"Apple A8 GPU|Apple A8X GPU",v:[1361285941]},{x:"Apple A9 GPU",v:[583354101,3403189785,3458129248,3928876783]},{x:"Apple A14 GPU",v:[1349146759,1444462398]},{x:"Apple A14 GPU",v:[1444462398]},{x:"Apple A15 GPU|Apple A16 GPU",v:[2775654583]},{x:"Apple A13 GPU|Apple A12 GPU",v:[3565683531]},{x:"Apple A15 GPU",v:[2775654583]},{x:"Apple A9X GPU|Apple A10 GPU",v:[3458129248]},{x:"Apple M1 GPU|Apple A12Z GPU",v:[1349146759]},{x:"Apple M1 GPU",v:[1444462398]},{x:"Apple A10 GPU",v:["iPod Touch"]},{x:"Apple A15 GPU",v:[2266]},{x:"Apple M2 GPU",v:[2778]},{x:"Apple A9X GPU",v:["srgb"]},{x:"Apple A14 GPU",v:["srgb"]},{x:"Apple M2 GPU",v:[2]},{x:"Apple A11 GPU",v:[367695777,411650080,1220644697]},{x:"Apple A12 GPU",v:[958581112,2301174800,4085158452]},{x:"Apple A13 GPU",v:[352823931,1278953537,3335845976,4193218782]},{x:"Apple A12 GPU",v:[0,958581112,2301174800,3403189785,4085158452]},{x:"Apple A13 GPU",v:[352823931,3335845976,4193218782]},{x:"Apple A12 GPU",v:[958581112,2301174800,3403189785,4085158452]},{x:"Apple A11 GPU",v:[367695777,411650080]},{x:"Apple A13 GPU",v:[352823931,1278953537,3335845976]},{x:"Apple A15 GPU",v:[1407135659]},{x:"Apple A16 GPU",v:[46273595,3403189785]},{x:"Apple A10X GPU",v:[63583436,2114570256,3129316290,3249312110]},{x:"Apple A12 GPU",v:[1349146759,2917249763]},{x:"Apple M1 GPU",v:[105985484,2364051618]},{x:"Apple M2 GPU",v:[46273595]},{x:"Apple A10 GPU",v:[2114570256]},{x:"Apple A12 GPU",v:[1349146759]},{x:"Apple A7 GPU",v:[857422828,1915583345]},{x:"Apple A8 GPU",v:[839732043,3816812018,4125234388]},{x:"Apple A10 GPU",v:[583354101,3458129248,3928876783]},{x:"Apple A11 GPU",v:[367695777,411650080,1220644697,1804407534]},{x:"Apple A15 GPU",v:[2364051618]},{x:"Apple A8 GPU",v:[1411440593,1924197914,4125234388]},{x:"Apple A9 GPU",v:[2114570256,3129316290]},{x:"Apple A10 GPU",v:[63583436,2114570256,3129316290]},{x:"Apple A11 GPU",v:[1349146759,2206992415,2917249763,2946940121]},{x:"Apple A8 GPU",v:[1411440593,1913250432,3074367344,4125234388]},{x:"Apple A9 GPU",v:[46663968,2114570256,3129316290]},{x:"Apple A11 GPU",v:[2206992415,2917249763,2946940121,3237505312]},{x:"Apple A8 GPU",v:[3128296539,3816812018,4125234388]},{x:"Apple A9 GPU",v:[46663968,63583436,2114570256,3129316290]},{x:"Apple A10 GPU",v:[46663968,63583436,2114570256,3129316290]},{x:"Apple A11 GPU",v:[2917249763,2946940121,3237505312]},{x:"Apple A15 GPU",v:[235283973,1444462398,2775654583]},{x:"Apple A13 GPU",v:[2866949877,3565683531]},{x:"Apple A8 GPU",v:[2656686317,3710391565]},{x:"Apple A10 GPU",v:[46663968]},{x:"Apple A12Z GPU",v:[958581112,2301174800,2487400911]},{x:"Apple A12X GPU",v:[4085158452]},{x:"Apple A10X GPU",v:[583354101,3458129248,3928876783]},{x:"Apple A8X GPU",v:[1350183384,3816812018,4125234388]},{x:"Apple A8 GPU",v:[4125234388]},{x:"Apple A7 GPU",v:[1966062736]},{x:"Apple A8 GPU",v:[2998196247]},{x:"Apple A13 GPU",v:[2866949877]},{x:"Apple M1 GPU",v:[1349146759,1444462398]},{x:"Apple M2 GPU",v:[2775654583]},{x:"Apple A13 GPU",v:[3335845976]},{x:"Apple A13 GPU",v:[1349146759]},{x:"Apple A15 GPU",v:[1444462398]},{x:"Apple A13 GPU",v:[3565683531]},{x:"Apple A15 GPU",v:[235283973]},{x:"Apple A11 GPU",v:[411650080,1220644697]},{x:"Apple A13 GPU",v:[352823931,3403189785,4193218782]},{x:"Apple A11 GPU",v:[367695777]},{x:"Apple A10 GPU",v:[3403189785]},{x:"Apple A8X GPU",v:[1783160115]},{x:"Apple A8 GPU",v:[3928382683]},{x:"Apple A10 GPU",v:[1058363647,2015944978]},{x:"Apple A8 GPU",v:[3312905059,3928382683]},{x:"Apple A8X GPU",v:[1480368425,1783160115,3403189785]},{x:"Apple A10X GPU",v:[2114570256]},{x:"Apple A14 GPU",v:[1349146759]},{x:"Apple A8X GPU",v:[1783160115,3403189785]}]};function hash3d(){var gl,program,canvas,mat4={create:function(){for(var result=new Array(16),i=0;i<16;i++)result[i]=i%5==0?1:0;return result},perspective:function(out,fovy,aspect,near,far){var nf,f=1/Math.tan(fovy/2);return out[0]=f/aspect,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=f,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[11]=-1,out[12]=0,out[13]=0,out[15]=0,null!=far&&far!==1/0?(nf=1/(near-far),out[10]=(far+near)*nf,out[14]=2*far*near*nf):(out[10]=-1,out[14]=-2*near),out},lookAt:function(out,eye,center,up){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];return Math.abs(eyex-centerx)<1e-6&&Math.abs(eyey-centery)<1e-6&&Math.abs(eyez-centerz)<1e-6?mat4.identity(out):(z0=eyex-centerx,z1=eyey-centery,z2=eyez-centerz,x0=upy*(z2*=len=1/Math.hypot(z0,z1,z2))-upz*(z1*=len),x1=upz*(z0*=len)-upx*z2,x2=upx*z1-upy*z0,(len=Math.hypot(x0,x1,x2))?(x0*=len=1/len,x1*=len,x2*=len):(x0=0,x1=0,x2=0),y0=z1*x2-z2*x1,y1=z2*x0-z0*x2,y2=z0*x1-z1*x0,(len=Math.hypot(y0,y1,y2))?(y0*=len=1/len,y1*=len,y2*=len):(y0=0,y1=0,y2=0),out[0]=x0,out[1]=y0,out[2]=z0,out[3]=0,out[4]=x1,out[5]=y1,out[6]=z1,out[7]=0,out[8]=x2,out[9]=y2,out[10]=z2,out[11]=0,out[12]=-(x0*eyex+x1*eyey+x2*eyez),out[13]=-(y0*eyex+y1*eyey+y2*eyez),out[14]=-(z0*eyex+z1*eyey+z2*eyez),out[15]=1,out)},multiply:function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b0=b[0],b1=b[1],b2=b[2],b3=b[3];return out[0]=b0*a00+b1*a10+b2*a20+b3*a30,out[1]=b0*a01+b1*a11+b2*a21+b3*a31,out[2]=b0*a02+b1*a12+b2*a22+b3*a32,out[3]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[4],b1=b[5],b2=b[6],b3=b[7],out[4]=b0*a00+b1*a10+b2*a20+b3*a30,out[5]=b0*a01+b1*a11+b2*a21+b3*a31,out[6]=b0*a02+b1*a12+b2*a22+b3*a32,out[7]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[8],b1=b[9],b2=b[10],b3=b[11],out[8]=b0*a00+b1*a10+b2*a20+b3*a30,out[9]=b0*a01+b1*a11+b2*a21+b3*a31,out[10]=b0*a02+b1*a12+b2*a22+b3*a32,out[11]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[12],b1=b[13],b2=b[14],b3=b[15],out[12]=b0*a00+b1*a10+b2*a20+b3*a30,out[13]=b0*a01+b1*a11+b2*a21+b3*a31,out[14]=b0*a02+b1*a12+b2*a22+b3*a32,out[15]=b0*a03+b1*a13+b2*a23+b3*a33,out},identity:function(out){return out[0]=1,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=1,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[10]=1,out[11]=0,out[12]=0,out[13]=0,out[14]=0,out[15]=1,out}};var imageHash=0;if(null!=(canvas=document.createElement("canvas"))){var imageData=function generate(){if(gl=function getRenderingContext(){canvas.width=67,canvas.height=67;var gl=canvas.getContext("webgl")||canvas.getContext("experimental-webgl");return gl&&(gl.viewport(0,0,67,67),gl.clearColor(0,0,0,1),gl.clear(gl.COLOR_BUFFER_BIT)),gl}()){var vertexShader=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(vertexShader,"attribute vec3 c,d; uniform vec4 e; uniform vec3 f,g;uniform mat4 h,i;varying vec3 j;void main(){vec3 a=normalize(d);vec4 b=h*vec4(c,1.);vec3 k=normalize(vec3(e-b));j=g*f*max(dot(k,a),0.),gl_Position=i*vec4(c,1.);}"),gl.compileShader(vertexShader);var fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(fragmentShader,"#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec3 j;void main(){gl_FragColor = vec4(j, 1.0);}"),gl.compileShader(fragmentShader),program=gl.createProgram(),gl.attachShader(program,vertexShader),gl.attachShader(program,fragmentShader),gl.linkProgram(program),gl.detachShader(program,vertexShader),gl.detachShader(program,fragmentShader),gl.deleteShader(vertexShader),gl.deleteShader(fragmentShader),gl.useProgram(program);var n=function initVertexBuffers(gl){var latNumber,longNumber,vertexPositionData=[],normalData=[],textureCoordData=[],indexData=[];for(latNumber=0;latNumber<=50;++latNumber){var theta=latNumber*Math.PI/50,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta);for(longNumber=0;longNumber<=50;++longNumber){var phi=2*longNumber*Math.PI/50,sinPhi=Math.sin(phi),x=Math.cos(phi)*sinTheta,y=cosTheta,z=sinPhi*sinTheta,u=1-longNumber/50,v=1-latNumber/50;vertexPositionData.push(2*x),vertexPositionData.push(2*y),vertexPositionData.push(2*z),normalData.push(x),normalData.push(y),normalData.push(z),textureCoordData.push(u),textureCoordData.push(v)}}for(latNumber=0;latNumber<50;++latNumber)for(longNumber=0;longNumber<50;++longNumber){var first=51*latNumber+longNumber,second=first+50+1;indexData.push(first),indexData.push(second),indexData.push(first+1),indexData.push(second),indexData.push(second+1),indexData.push(first+1)}vertexPositionData=new Float32Array(vertexPositionData),normalData=new Float32Array(normalData),textureCoordData=new Float32Array(textureCoordData),indexData=new Uint16Array(indexData);var vertexPositionBuffer=gl.createBuffer(),vertexNormalBuffer=gl.createBuffer(),indexBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vertexPositionBuffer),gl.bufferData(gl.ARRAY_BUFFER,vertexPositionData,gl.STATIC_DRAW);var VertexPosition=gl.getAttribLocation(program,"c");gl.vertexAttribPointer(VertexPosition,3,gl.FLOAT,!1,0,0),gl.enableVertexAttribArray(VertexPosition),gl.bindBuffer(gl.ARRAY_BUFFER,vertexNormalBuffer),gl.bufferData(gl.ARRAY_BUFFER,normalData,gl.STATIC_DRAW);var VertexNormal=gl.getAttribLocation(program,"d");return gl.vertexAttribPointer(VertexNormal,3,gl.FLOAT,!1,0,0),gl.enableVertexAttribArray(VertexNormal),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,indexBuffer),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,indexData,gl.STATIC_DRAW),indexData.length}(gl);gl.clearColor(0,0,0,1),gl.enable(gl.DEPTH_TEST);var projection=mat4.create();mat4.perspective(projection,Math.PI/6,1,.1,100);var modelView=mat4.create();mat4.lookAt(modelView,[0,0,10],[0,0,0],[0,1,0]);var mvpMatrix=mat4.create();mat4.multiply(mvpMatrix,projection,modelView);var ModelViewMatrix=gl.getUniformLocation(program,"h");gl.uniformMatrix4fv(ModelViewMatrix,!1,modelView);var MVP=gl.getUniformLocation(program,"i");gl.uniformMatrix4fv(MVP,!1,mvpMatrix);var LightPosition=gl.getUniformLocation(program,"e");gl.uniform4fv(LightPosition,[10,10,10,1]);var Kd=gl.getUniformLocation(program,"f");gl.uniform3fv(Kd,[.9,.5,.3]);var Ld=gl.getUniformLocation(program,"g");return gl.uniform3fv(Ld,[1,1,1]),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.drawElements(gl.TRIANGLES,n,gl.UNSIGNED_SHORT,0),function cleanup(){gl.useProgram(null),program&&gl.deleteProgram(program)}(),canvas.toDataURL()}}();imageData&&(imageHash=fnvHash(imageData))}return imageHash}function fnvHash(str){for(var h=2166136261,i=0;i<str.length;++i)h^=str.charCodeAt(i),h+=(h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);return h>>>0}function hash(){var imageHash=0,canvas=document.createElement("canvas");if(null!=canvas){var imageData=function drawImage(canvas){canvas.width=67,canvas.height=67;var ctx=canvas.getContext("2d",{alpha:!0});if(null!=ctx)return ctx.imageSmoothingQuality="low",ctx.imageSmoothingEnabled=!0,ctx.globalCompositeOperation="source-over",ctx.globalAlpha=1,ctx.miterLimit=1/0,ctx.filter="none",ctx.lineCap="butt",ctx.lineDashOffset=0,ctx.lineJoin="miter",ctx.font="10pt Arial",ctx.lineWidth=2,void 0!==ctx.setLineDash&&ctx.setLineDash([10,20]),ctx.shadowColor="black",ctx.shadowOffsetX=-3,ctx.shadowOffsetY=-5,ctx.translate(canvas.width/2,canvas.height/2),ctx.rotate(.8901179),ctx.fillStyle="green",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("*51Degrees*",0,0),ctx.beginPath(),ctx.shadowColor="yellow",ctx.shadowBlur=1,ctx.shadowOffsetX=1,ctx.shadowOffsetY=1,ctx.strokeStyle="red",ctx.fillStyle="rgba(0, 0, 255, 0.6)",void 0===ctx.ellipse?ctx.arc(0,0,25,0,2*Math.PI):ctx.ellipse(0,0,25,15,Math.PI/4,0,2*Math.PI),ctx.fill(),ctx.stroke(),canvas.toDataURL()}(canvas);imageData&&(imageHash=fnvHash(imageData))}return imageHash}function height(){return window.screen.height*window.devicePixelRatio}function mediacolorgamut(){return function getMediaSingleValue(name,possibleValues){for(var i=0;i<possibleValues.length;i++)if(query="("+name+": "+possibleValues[i]+")",window.matchMedia(query).matches)return possibleValues[i];var query;return"n/a"}("color-gamut",["p3","srgb"])}function evaluateNode(node,iterations){if(node.m){var result=node.m(node);result||""===result?result.then||function resolveNode(node,value,iterations){for(var i=0;i<node.n.length;i++){var child=decisionTree.Data[node.n[i]];if(child.r)for(var c=0;c<child.r.length;c++){var range=child.r[c];if((null===range.a||value>=range.a)&&(null===range.b||value<=range.b))return void evaluateNode(child,0)}else if(child.v&&-1!=child.v.indexOf(value))return void evaluateNode(child,0)}node.n.length>0&&iterations<3?setTimeout((function(){evaluateNode(node,iterations+1)}),10):complete(node.x)}(node,result,iterations):node.x&&complete(node.x)}else complete(node.x),complete("done")}evaluateNode(decisionTree.Data[0],0)}function test(){let results=[];function getPrime(){return function largest_prime_factor(n){return factors(n).filter(primep).pop()}(1e11)}function factors(n){var i,out=[],sqrt_n=Math.sqrt(n);for(i=2;i<=sqrt_n;i++)n%i==0&&out.push(i);return out}function primep(n){return 0===factors(n).length}for(let i=0;i<3;i++){let time=performance.now();getPrime(),results.push(10*(performance.now()-time))}return results.sort(((a,b)=>a-b)),results[0]}function fallbackTest(){let res=Math.min(screen.width,screen.height)+"x"+Math.max(screen.width,screen.height),time=test();switch(res){case"320x480":Device.graphics.webgl.gpu="legacy";break;case"320x568":Device.graphics.webgl.gpu=time<=400?"apple a8":time<=500?"apple a7":"legacy";break;case"375x812":case"414x896":Device.graphics.webgl.gpu=time<=150?"apple a13":time<=180?"apple a12":"apple a11";break;case"414x736":case"375x667":Device.graphics.webgl.gpu=time<=220?"apple a11":time<=250?"apple a10":time<=360?"apple a9":time<=400?"apple a8":time<=600?"apple a7":"legacy";break;default:case"768x1024":Device.graphics.webgl.gpu=time<=140?"apple a14":time<=160?"apple a13":time<=180?"apple a12":time<=220?"apple a11":time<=250?"apple a10":time<=360?"apple a9":time<=400?"apple a8":time<=600?"apple a7":"legacy";break;case"834x1112":Device.graphics.webgl.gpu=time<=160?"apple a13":time<=180?"apple a12":time<=220?"apple a11":"apple a10";break;case"834x1194":time<=140?Device.graphics.webgl.gpu="apple m1 gpu":time<=160?Device.graphics.webgl.gpu="apple a13":time<=180&&(Device.graphics.webgl.gpu="apple a12");break;case"810x1080":time<=160?Device.graphics.webgl.gpu="apple a13":time<=220?Device.graphics.webgl.gpu="apple a11":time<=250&&(Device.graphics.webgl.gpu="apple a10");break;case"820x1180":Device.graphics.webgl.gpu="apple a14";break;case"428x926":case"390x844":Device.graphics.webgl.gpu="apple a15";break;case"1024x1366":Device.graphics.webgl.gpu=time<=140?"apple m1 gpu":time<=160?"apple a13":time<=180?"apple a12":time<=220?"apple a11":time<=250?"apple a10":"apple a9"}}this.exports=function(){let _value,_timer,promise=Promise.create();const cb=value=>{if(clearTimeout(_timer),"done"==value){if(!_value)return fallbackTest(),promise.resolve();if(_value.includes("|"))try{let split=_value.split("|");if(1==split.length&&split[0].includes("Apple M"))Device.graphics.webgl.gpu="apple m1 gpu";else{let output=split.filter((v=>!v.includes("Apple M"))).map((v=>Number(v.replace("Apple","").replace("X","").replace("Z","").split("A")[1].split(" ")[0])));if(output.sort(((a,b)=>a-b)),output[output.length-1]-output[0]>=2?fallbackTest():Device.graphics.webgl.gpu=split[0].toLowerCase(),"apple a14 gpu"==Device.graphics.webgl.gpu){let res=Math.min(screen.width,screen.height)+"x"+Math.max(screen.width,screen.height);"428x926"!=res&&"390x844"!=res||(Device.graphics.webgl.gpu="apple a15 gpu")}}}catch(e){fallbackTest()}else Device.graphics.webgl.gpu=_value.toLowerCase();promise.resolve()}else _value=value,_timer=setTimeout((_=>cb("done")),20)};return getRenderer(cb),promise}})),Module((function GPUBlocklist(){this.exports={match:function(){return!Device.graphics.gpu||Device.graphics.gpu.detect(["radeon hd 6970m","radeon hd 6770m","radeon hd 6490m","radeon hd 6630m","radeon hd 6750m","radeon hd 5750","radeon hd 5670","radeon hd 4850","radeon hd 4870","radeon hd 4670","geforce 9400m","geforce 320m","geforce 330m","geforce gt 130","geforce gt 120","geforce gtx 285","geforce 8600","geforce 9600m","geforce 9400m","geforce 8800 gs","geforce 8800 gt","quadro fx 5","quadro fx 4","radeon hd 2600","radeon hd 2400","radeon hd 2600","mali-4","mali-3","mali-2","swiftshader","basic render driver","generic renderer","sgx543","legacy","sgx 543"])}}})),Class((function HierarchyAnimation(_data,createObjects,_isLayout){Inherit(this,Object3D);const _this=this;var _objects,_lastElapsed=-1;this.elapsed=0,this.weight=1,this.scale=1,this.duration=0,this.loop=!1;const prevPos=new Vector3,prevRot=new Quaternion,prevScl=new Vector3,nextPos=new Vector3,nextRot=new Quaternion,nextScl=new Vector3,DEFAULT_QUAT=new Quaternion(0,0,0,1),DEFAULT_POS=new Vector3(0,0,0),DEFAULT_SCALE=new Vector3(1,1,1);function loop(){_this.update()}!async function(){if("function"!=typeof createObjects)throw"HierarchyAnimation :: Second parameter requires callback function to create objects";if("string"==typeof _data&&(_data=await get(Assets.getPath(`assets/geometry/${_data}.json`))),_objects=await createObjects(_data.hierarchy),!Array.isArray(_objects))throw"HierarchyAnimation :: Object creation function requires an array to be returned";!function nestObjects(){try{if(_data.hierarchy.length!=_objects.length)throw"HierarchyAnimation :: Number of objects in hierarchy does not match number of objects created.";_data.hierarchy.forEach(((d,i)=>{if(d.parent>-1){"null"!=_data.hierarchy[Number(d.parent)].name&&_objects[d.parent].add(_objects[i])}else"null"!=d.name&&_this.add(_objects[i])}))}catch(e){throw console.error("HierarchyAnimation :: Could not successfully nest objects -- check your names!"),e}}(),_this.duration=_data.frames.length,_this.fps=_data.fps}(),this.update=function(totalWeight=1,isSet){if(!_objects)return;const weight=isSet?1:_this.weight/totalWeight,elapsed=Math.clamp(_this.elapsed,0,.99)*_this.duration;if(Math.abs(elapsed-_lastElapsed)<.001)return;_lastElapsed=elapsed;const floorFrame=Math.floor(elapsed),blend=elapsed-floorFrame,prevKey=_data.frames[floorFrame],nextKey=_data.frames[_this.loop?(floorFrame+1)%_this.duration:floorFrame+1];prevKey&&nextKey&&_objects.forEach(((object,i)=>{prevPos.fromArray(prevKey.position,3*i).multiplyScalar(_this.scale),prevRot.fromArray(prevKey.quaternion,4*i),prevScl.fromArray(prevKey.scale,3*i),nextPos.fromArray(nextKey.position,3*i).multiplyScalar(_this.scale),nextRot.fromArray(nextKey.quaternion,4*i),nextScl.fromArray(nextKey.scale,3*i),prevPos.lerp(nextPos,blend,!1),prevRot.slerp(nextRot,blend,!1),prevScl.lerp(nextScl,blend,!1),_isLayout?(prevPos.equals(DEFAULT_POS)||object.position.lerp(prevPos,weight,!1),prevRot.equals(DEFAULT_QUAT)||object.quaternion.slerp(prevRot,weight,!1),prevScl.equals(DEFAULT_SCALE)||object.scale.lerp(prevScl,weight,!1)):(object.position.lerp(prevPos,weight,!1),object.quaternion.slerp(prevRot,weight,!1),object.scale.lerp(prevScl,weight,!1))}))},this.start=function(){_this.startRender(loop)},this.stop=function(){_this.stopRender(loop)},this.ready=function(){return _this.wait(_this,"duration")},this.set("data",(data=>{_data=data,_this.duration=_data.frames.length,_this.fps=_data.fps,_this.elapsed=0}))})),Class((function HierarchyLayout(_data,createObjects){Inherit(this,Component);const _this=this;var _animation;!async function(){_animation=new HierarchyAnimation(_data,createObjects,!0),_this.group=_animation.group,_animation.loop=!0,await _animation.ready(),_animation.update()}(),this.ready=function(){return _animation.ready()},this.set("scale",(s=>_animation.scale=s))})),Class((function LayerAnimation(_mesh,_shader,_group,_input){Inherit(this,Component);const _this=this;var _config,_active,_hierarchy,_map={};!async function(){_mesh.animation=_this,function initConfig(){(_config=InputUIL.create(_input.prefix+"anim",_group)).setLabel("Animation Files"),_config.add("path"),_config.addTextarea("jsonFiles")}(),await async function initFiles(){let path=`assets/geometry/${_config.get("path")}/`,files=_config.get("jsonFiles").split("\n"),load=files.map((f=>path+f+".json")).map((path=>get(path))),data=await Promise.all(load);for(let i=0;i<files.length;i++)_map[files[i]]=data[i];_active=files[0]}(),async function initHierarchy(){_hierarchy=_this.initClass(HierarchyAnimation,_map[_active],(data=>{let array=[];for(let i=0;i<data.length;i++){data[i].name==_input.get("name")?array.push(_mesh):array.push(new Group)}return array})),await _hierarchy.ready(),_hierarchy.update(),_this.flag("initialized",!0)}()}(),this.play=async function(name,time,ease,delay){if(await _this.wait("initialized"),!_map[name])throw"No animation file found for "+name;ease||(ease="linear"),time||(time=_map[name].frames.length/_map[name].fps*1e3),_hierarchy.data=_map[name],_active=name,_hierarchy.start(),await tween(_hierarchy,{elapsed:1},time,ease,delay).promise(),_hierarchy.stop()}})),Class((function HydraBloom(_nuke,{nMips:nMips=6,enabled:enabled=!0,useMask:useMask=!1,useHdr:useHdr=!0,useRTPool:useRTPool=!1}={},_unique){Inherit(this,Component);const _this=this;"string"==typeof options?(_unique=_params,_nuke=World.NUKE):"string"==typeof _nuke?(_unique=_nuke,_nuke=World.NUKE):!_nuke||_nuke instanceof Nuke?(_nuke=_nuke||World.NUKE,_unique=_unique||""):_nuke=World.NUKE;let _DPR=.5*_nuke.dpr;const PASS_COUNT=nMips,FORMAT=!1!==useHdr?Texture.HALF_FLOAT:Texture.RGBAFormat;let _blitProgram,_lumaProgram,_downSampleProgram,_upSampleProgram,_inputTexture,_brightnessTexture,textureParams={minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:FORMAT,generateMipmaps:!1};_this.blitResolution=new Vector2(Math.round(_nuke.stage.width*_DPR),Math.round(_nuke.stage.height*_DPR));let _downSamplePasses=[],_upSamplePasses=[];_this.enabled=enabled||!0;let _inputUIL=null;function createRT(width,height,opts){return new RenderTarget(width,height,opts)}function loop(){if(!_this.enabled||!1===_this.visible)return;let inputTarget=_inputTexture||_nuke.rttBuffer.texture;_lumaProgram.shader.uniforms.luminosityThreshold.value>.001&&!useMask?(_lumaProgram.shader.set("tDiffuse",inputTarget),World.RENDERER.renderSingle(_lumaProgram,World.CAMERA,_downSamplePasses[0].buffer),inputTarget=_brightnessTexture.texture):(_blitProgram.shader.set("tMap",inputTarget),World.RENDERER.renderSingle(_blitProgram,World.CAMERA,_downSamplePasses[0].buffer));for(let i=0;i<PASS_COUNT-1;i++)_downSampleProgram.shader.set("uResolution",_downSamplePasses[i].resolution),_downSampleProgram.shader.set("tMap",_downSamplePasses[i].buffer.texture),World.RENDERER.renderSingle(_downSampleProgram,World.CAMERA,_downSamplePasses[i+1].buffer);const count=PASS_COUNT-2;for(let i=count;i>=0;i--)_upSampleProgram.shader.set("uResolution",_upSamplePasses[i+1].resolution),_upSampleProgram.shader.set("tMap",i===count?_downSamplePasses[i+1].buffer.texture:_upSamplePasses[i+1].buffer.texture),_upSampleProgram.shader.set("tNext",_downSamplePasses[i].buffer.texture),World.RENDERER.renderSingle(_upSampleProgram,World.CAMERA,_upSamplePasses[i].buffer)}function handleResize(){_this.blitResolution=new Vector2(Math.round(_nuke.stage.width*_DPR),Math.round(_nuke.stage.height*_DPR));let resX=_this.blitResolution.x,resY=_this.blitResolution.y;for(let i=0;i<PASS_COUNT;i++)_downSamplePasses[i].buffer.setSize(resX,resY),_upSamplePasses[i].buffer.setSize(resX,resY),resX=Math.round(.5*resX),resY=Math.round(.5*resY)}!function initPasses(){_brightnessTexture=createRT(_nuke.stage.width,_nuke.stage.height,textureParams);let resX=_this.blitResolution.x,resY=_this.blitResolution.y;for(let i=0;i<PASS_COUNT;i++)_downSamplePasses.push({buffer:createRT(resX,resY,textureParams),resolution:new Vector2(resX,resY)}),_upSamplePasses.push({buffer:createRT(resX,resY,textureParams),resolution:new Vector2(resX,resY)}),resX=Math.round(.5*resX),resY=Math.round(.5*resY)}(),function initPrograms(){const geo=World.QUAD,blitShader=_this.initClass(Shader,"Blit",{tMap:{value:null},depthTest:!1,depthWrite:!1});if(_blitProgram=new Mesh(geo,blitShader),!useMask){const luminosityShader=_this.initClass(Shader,"BloomLuminosityPass",{tDiffuse:{value:null,ignoreUIL:!0},luminosityThreshold:{value:0},smoothWidth:{value:.01,ignoreUIL:!0},defaultColor:{value:new Color(0),ignoreUIL:!0},defaultOpacity:{value:0,ignoreUIL:!0},unique:_unique});ShaderUIL.add(luminosityShader).setLabel("Hydra Bloom Luminosity Params"),_lumaProgram=new Mesh(geo,luminosityShader)}const downSampleShader=_this.initClass(Shader,"DownSample",{tMap:{value:null},uResolution:{value:new Vector2(2,2)},uSeed:{value:0},uRadius:{value:1},depthTest:!1,depthWrite:!1,unique:_unique});_downSampleProgram=new Mesh(geo,downSampleShader);const upSampleShader=_this.initClass(Shader,"UpSample",{tMap:{value:null},tNext:{value:null},uResolution:{value:new Vector2(2,2)},uSeed:{value:0},uRadius:{value:1},uIntensity:{value:1},uTint:{value:new Color},depthTest:!1,depthWrite:!1,unique:_unique});_upSampleProgram=new Mesh(geo,upSampleShader)}(),function initPass(){_this.pass=_this.initClass(NukePass,"HydraBloomPass",{tHydraBloom:{value:_upSamplePasses[0].buffer.texture}})}(),function initInputUIL(){_inputUIL=InputUIL.create(`HydraBloom${_unique||""}`),_inputUIL.setLabel(`Hydra Bloom ${_unique||""}`),_inputUIL.addNumber("Bloom_Radius",1,.1),_inputUIL.addNumber("Bloom_Intensity",1,.1),_inputUIL.addColor("Bloom_Tint",new Color),_inputUIL.onUpdate=(key,value)=>{_upSampleProgram.shader.set("uRadius",_inputUIL.getNumber("Bloom_Radius")),_upSampleProgram.shader.set("uIntensity",_inputUIL.getNumber("Bloom_Intensity")),_upSampleProgram.shader.set("uTint",new Color(_inputUIL.get("Bloom_Tint"))),console.log(value)}}(),function addHandlers(){_this.onResize(handleResize)}(),_this.startRender(loop),this.set("texture",(texture=>{_inputTexture=texture})),this.get("output",(_=>_upSamplePasses[0].buffer.texture)),this.onInvisible=function(){},this.onVisible=function(){},_this.onDestroy=function(){_downSamplePasses.forEach((pass=>pass.buffer.destroy())),_upSamplePasses.forEach((pass=>pass.buffer.destroy())),_downSamplePasses=[],_upSamplePasses=[]}})),Namespace("FX"),FX.Class((function HydraLensStreak(_nuke,{nMips:nMips=8,dpr:dpr=1,enabled:enabled=!0,manualRender:manualRender=!1}={},_unique){Inherit(this,Component);const _this=this;if("object"==typeof _nuke&&_nuke.isAppState){let options=_nuke;_unique=_nuke.unique,_nuke=_nuke.nuke||_this.parent.nuke,nMips=options.nMips||8,dpr=options.dpr||1,enabled=void 0===options.enabled||options.enabled,manualRender=void 0!==options.manualRender&&options.manualRender}let _blitMesh,_downsampleShader,_upsampleShader;"string"==typeof options?(_unique=_params,_nuke=World.NUKE):"string"==typeof _nuke?(_unique=_nuke,_nuke=World.NUKE):!_nuke||_nuke instanceof Nuke?(_nuke=_nuke||World.NUKE,_unique=_unique||""):_nuke=World.NUKE,this.uniforms={tLightStreak:{value:null,ignoreUIL:!0},unique:_unique};let _prefiltered,_prefilterShader,_lastUpsampleFBO,_compositeFBO,_compositeShader,_uil,_inputTexture,_upSamplePasses=[],_downSamplePasses=[];function render(){if(!_this.enabled||!1===_this.visible)return;let inputTarget=_inputTexture||_nuke.rttBuffer.texture;_inputTexture||(_blitMesh.shader=_prefilterShader,_blitMesh.shader.set("tMap",inputTarget),World.RENDERER.renderSingle(_blitMesh,World.CAMERA,_prefiltered)),_blitMesh.shader=_downsampleShader,_blitMesh.shader.set("tMap",_inputTexture||_prefiltered.texture),_blitMesh.shader.set("uResolution",_downSamplePasses[0].resolution),World.RENDERER.renderSingle(_blitMesh,World.CAMERA,_downSamplePasses[0].fbo);for(let i=1;i<nMips;i++)_blitMesh.shader.set("tMap",_downSamplePasses[i-1].fbo.texture),_blitMesh.shader.set("uResolution",_downSamplePasses[i-1].resolution),World.RENDERER.renderSingle(_blitMesh,World.CAMERA,_downSamplePasses[i].fbo),_lastUpsampleFBO=_downSamplePasses[i].fbo;_blitMesh.shader=_upsampleShader,_blitMesh.shader.set("tHigh",_downSamplePasses[_downSamplePasses.length-1].fbo.texture),_blitMesh.shader.set("tScene",_lastUpsampleFBO.texture),_blitMesh.shader.set("uResolution",_upSamplePasses[0].resolution),World.RENDERER.renderSingle(_blitMesh,World.CAMERA,_upSamplePasses[0].fbo);for(let i=1;i<nMips-2;i++)_blitMesh.shader.set("tHigh",_downSamplePasses[i-1].fbo.texture),_blitMesh.shader.set("tScene",_lastUpsampleFBO.texture),_blitMesh.shader.set("uResolution",_upSamplePasses[i].resolution),World.RENDERER.renderSingle(_blitMesh,World.CAMERA,_upSamplePasses[i].fbo),_lastUpsampleFBO=_upSamplePasses[i].fbo;_blitMesh.shader=_compositeShader,World.RENDERER.renderSingle(_blitMesh,World.CAMERA,_compositeFBO),_this.uniforms.tLightStreak.value=_compositeFBO}function handleResize(){const resolution=new Vector2;resolution.set(_nuke.stage.width*dpr,_nuke.stage.height*dpr/2);for(let i=0;i<nMips;i++)_downSamplePasses[i].fbo.setSize(resolution.x,resolution.y),resolution.x/=2;for(let i=0;i<nMips-2;i++){const width=_downSamplePasses[i].fbo.width,height=_downSamplePasses[i].fbo.height;_upSamplePasses[i].fbo.setSize(width,height)}}_this.enabled=void 0===enabled||enabled,function initPrograms(){_prefilterShader=_this.initClass(Shader,"LensFlarePrefilter",{tMap:{value:null,ignoreUIL:!0},uThreshold:{value:.6},uRotate:{value:0},uResolution:{value:new Vector2},unique:_unique}),_downsampleShader=_this.initClass(Shader,"LensFlareDown",{tMap:{value:null,ignoreUIL:!0},uResolution:{value:new Vector2},uStretch:{value:1},unique:_unique}),_upsampleShader=_this.initClass(Shader,"LensFlareUp",{tHigh:{value:null,ignoreUIL:!0},tScene:{value:null,ignoreUIL:!0},uStretch:{value:1},uResolution:{value:new Vector2},uSoftenEdge:{value:1},unique:_unique})}(),function initPasses(){const options={minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,wrapS:Texture.CLAMP_TO_EDGE,wrapT:Texture.CLAMP_TO_EDGE,format:Texture.RGBAFormat,generateMipmaps:!0};_lastUpsampleFBO=_prefiltered;const resolution=new Vector2;resolution.set(_nuke.stage.width*dpr,_nuke.stage.height*dpr),_prefiltered=new RenderTarget(resolution.x,resolution.y,options),_prefiltered.id="prefiltered";for(let i=0;i<nMips;i++){const downSampleFBO=new RenderTarget(resolution.x,resolution.y,options);downSampleFBO.id="downSampleFBO"+i,_downSamplePasses.push({fbo:downSampleFBO,resolution:new Vector2(resolution.x,resolution.y)}),Utils.query("debugFBO")&&FBOHelper.instance().attach(_downSamplePasses[i].fbo,{name:"downSampleFBO"+i}),resolution.x>=32&&(resolution.x/=2,resolution.y/=2)}for(let i=0;i<nMips-2;i++){const width=_downSamplePasses[i].fbo.width,height=_downSamplePasses[i].fbo.height,upsampleFBO=new RenderTarget(width,height,options);upsampleFBO.id="upsampleFBO"+i,_upSamplePasses.push({fbo:upsampleFBO,resolution:new Vector2(width,height)}),Utils.query("debugFBO")&&FBOHelper.instance().attach(_upSamplePasses[i].fbo,{name:"upsampleFBO"+i})}_blitMesh=new Mesh(World.QUAD,_downsampleShader)}(),function initCompositePass(){_compositeFBO=new RenderTarget(_nuke.stage.width*dpr,_nuke.stage.height*dpr,{minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,wrapS:Texture.CLAMP_TO_EDGE,wrapT:Texture.CLAMP_TO_EDGE,format:Texture.RGBAFormat,generateMipmaps:!1}),_compositeShader=_this.initClass(Shader,"CompositeStreak",{tHigh:{value:_upSamplePasses[_upSamplePasses.length-1].fbo.texture,ignoreUIL:!0},tDown:{value:_downSamplePasses[_downSamplePasses.length-2].fbo.texture,ignoreUIL:!0},tPrefiltered:{value:_downSamplePasses[_downSamplePasses.length/2].fbo.texture,ignoreUIL:!0},uStreakColor:{value:new Color(1,1,1)},uStreakIntensity:{value:6},uGlowIntensity:{value:1},uFlareIntensity:{value:0},uAspectCorrection:{value:1},uHaloChroma:{value:.0025},uHaloScale:{value:.8},uHaloRotateSrc:{value:0},uHaloSoftness:{value:1},uHaloColor:{value:new Color(1,1,1)},uHaloRing:{value:new Vector4(1.1,.5,.48,.05)},uHaloConstant:{value:.04},uDebugHalo:{value:!1},uColor:{value:new Color},uRotateStreak:{value:0},unique:_unique})}(),function initInputUIL(){function update(){_compositeShader.set("uStreakColor",new Color(_uil.get("uStreakColor"))),_compositeShader.set("uStreakIntensity",_uil.getNumber("uStreakIntensity")),_compositeShader.set("uGlowIntensity",_uil.getNumber("uGlowIntensity")),_compositeShader.set("uFlareIntensity",_uil.getNumber("uFlareIntensity")),_compositeShader.set("uAspectCorrection",_uil.getNumber("uAspectCorrection")),_compositeShader.set("uHaloChroma",_uil.getNumber("uHaloChroma")),_compositeShader.set("uHaloScale",_uil.getNumber("uHaloScale")),_compositeShader.set("uHaloSoftness",_uil.getNumber("uHaloSoftness")),_compositeShader.set("uHaloColor",new Color(_uil.get("uHaloColor"))),_compositeShader.set("uHaloRotateSrc",_uil.getNumber("uHaloRotateSrc")),_compositeShader.set("uHaloConstant",_uil.getNumber("uHaloConstant")),_compositeShader.set("uDebugHalo",_uil.get("uDebugHalo"));const haloRing=_uil.get("uHaloRing");haloRing&&(_compositeShader.set("uHaloRing",new Vector4(haloRing[0],haloRing[1],haloRing[2],haloRing[3])),_compositeShader.set("uRotateStreak",_uil.getNumber("uRotateStreak")),_prefilterShader.set("uThreshold",_uil.getNumber("uThreshold")),_prefilterShader.set("uRotate",_uil.getNumber("uRotateStreak")),_upsampleShader.set("uSoftenEdge",_uil.getNumber("uSoftenEdge")),_downsampleShader.set("uStretch",_uil.getNumber("uStretch")))}_uil=InputUIL.create(`HydraLensStreak${_unique||""}`),_uil.setLabel(`Hydra Lens streak ${_unique||""}`),_uil.addColor("uStreakColor",new Color(1,1,1)),_uil.addNumber("uThreshold",0),_uil.addNumber("uStreakIntensity",2),_uil.addNumber("uGlowIntensity",0),_uil.addNumber("uRotateStreak",0),_uil.addNumber("uFlareIntensity",1),_uil.addNumber("uAspectCorrection",0),_uil.addNumber("uHaloChroma",.0025),_uil.addNumber("uHaloScale",.8),_uil.addNumber("uHaloSoftness",1),_uil.addColor("uHaloColor",new Color(1,1,1)),_uil.addVector("uHaloRing",[1.1,.5,.48,.05]),_uil.addNumber("uHaloRotateSrc",0),_uil.addNumber("uStretch",1),_uil.addNumber("uHaloConstant",.04),_uil.addNumber("uSoftenEdge",1),_uil.addToggle("uDebugHalo"),update(),_uil.onUpdate=(key,value)=>{update()}}(),function addEventHandlers(){_this.onResize(handleResize)}(),!manualRender&&_this.startRender(render,RenderManager.AFTER_LOOPS),this.set("texture",(texture=>{_inputTexture=texture})),this.get("output",(_=>_compositeFBO.texture)),_this.onDestroy=function(){_downSamplePasses.forEach((pass=>pass.buffer.destroy())),_upSamplePasses.forEach((pass=>pass.buffer.destroy())),_downSamplePasses=[],_upSamplePasses=[]}})),Class((function Initializer3D(){Inherit(this,Component);const _this=this;let _loader,_working,_promises=[],_queue=[];async function resolve(){await Promise.all(_promises),clearTimeout(_this.fire),_this.fire=_this.delayedCall((_=>{_this.events.fire(_this.READY),_this.resolved=!0,Utils3D.onTextureCreated=null,_loader&&_loader.trigger(50)}),100)}async function workQueue(){clearTimeout(_this.warningTimer),_working=!0;let promise=_queue.shift();if(!promise)return _working=!1;promise.resolve(workQueue),Hydra.LOCAL&&(_this.warningTimer=_this.delayedCall((_=>{console.warn("Long running queue has taken more than 5 seconds.")}),5e3))}function incCompleted(){_loader&&_loader.trigger(1)}this.READY="initializer_ready",this.bundle=function(){return new function PromiseBundler(){const promises=[],ready=Promise.create();let timer;function run(){clearTimeout(timer),timer=_this.delayedCall((_=>{Promise.all(promises).then((_=>ready.resolve()))}),100)}this.capture=function(promise){promises.push(promise),run()},this.ready=function(){return run(),ready}}},this.promise=this.capture=function(promise){return _loader&&_loader.add(1),promise.then(incCompleted),_promises.push(promise),clearTimeout(_this.timer),_this.timer=_this.delayedCall(resolve,100),promise},this.ready=this.loaded=function(){return _this.wait(_this,"resolved")},this.createWorld=async function(){await Promise.all([AssetLoader.waitForLib("zUtils3D"),Shaders.ready(),GPU.ready(),UILStorage.ready()]),await MatrixWasm.ready(),World.instance()},this.linkSceneLayout=function(loader){_this.captureTextures(),SceneLayout.initializer=_this.capture,_loader=loader},this.queue=function(immediate){if(immediate)return Promise.resolve((_=>{}));let promise=Promise.create();return _queue.push(promise),_working||workQueue(),promise},this.captureTextures=function(){Utils3D.onTextureCreated=texture=>{_this.promise(texture.promise)}},this.uploadAll=async function(group){if(!group)throw"Undefined passed to uploadAll";let sceneLayout;if(group instanceof SceneLayout||window.StageLayout&&group instanceof StageLayout){if(sceneLayout=group,sceneLayout.uploaded)return;sceneLayout.uploaded=!0,await sceneLayout.loadedAllLayers(),group=group.group}let promises=[],layouts=[],textures=[];if(sceneLayout){sceneLayout.textures=textures;for(let key in sceneLayout.layers){let layer=sceneLayout.layers[key];layer.uploadSync&&layer.uploadSync()}}group?.traverse?.((obj=>{if(obj.sceneLayout&&obj!=group&&layouts.push(obj.sceneLayout),obj.stageLayout&&obj!=group&&layouts.push(obj.stageLayout),!obj.uploadIgnore&&0!=obj.visible){if(obj.shader)for(let key in obj.shader.uniforms){let uniform=obj.shader.uniforms[key];uniform&&uniform.value&&uniform.value.promise&&(textures.push(uniform.value),promises.push(uniform.value.promise.then(uniform.value.upload.bind(uniform.value)).catch((e=>{}))))}obj?.glui&&obj?.glui?.mesh?.upload?.(),obj.shader&&obj.shader.shadow&&obj.shader.shadow.upload(),obj.classRef&&obj.classRef.upload&&obj.classRef.upload(),obj.asyncPromise?promises.push(obj.asyncPromise.then(obj.upload.bind(obj))):obj.upload&&obj.upload()}})),group.children&&group.children.forEach((child=>{child.upload?.()})),await Promise.catchAll(promises),textures.forEach((t=>t.upload()));for(let i=0;i<layouts.length;i++)await _this.uploadAll(layouts[i]);sceneLayout&&sceneLayout._completeInitialization&&sceneLayout._completeInitialization(!0),sceneLayout&&delete sceneLayout.textures},this.uploadAllDistributed=this.uploadAllAsync=async function(group,releaseQueue){if(!group)throw"Undefined passed to uploadAllDistributed";let sceneLayout;if(releaseQueue||"boolean"==typeof releaseQueue||(releaseQueue=await _this.queue()),group instanceof SceneLayout||window.StageLayout&&group instanceof StageLayout){if(sceneLayout=group,sceneLayout.uploaded)return"function"==typeof releaseQueue?releaseQueue():void 0;sceneLayout.uploaded=!0,await sceneLayout.loadedAllLayers(),group=group.group}let uploads=[],_async=[],promises=[],layouts=[],textures=[];if(sceneLayout){sceneLayout.textures=textures;for(let key in sceneLayout.layers){let layer=sceneLayout.layers[key];layer.upload&&!layer.uploadIgnore&&layer.upload()}}if(sceneLayout.parent){for(let key in sceneLayout.parent.classes){let clss=sceneLayout.parent.classes[key];clss.upload&&uploads.push(clss.upload.bind(clss))}sceneLayout.parent.nuke&&_this.uploadNukeAsync(sceneLayout.parent.nuke)}group.traverse((obj=>{if(obj.sceneLayout&&obj!=group&&layouts.push(obj.sceneLayout),obj.stageLayout&&obj!=group&&layouts.push(obj.stageLayout),!obj.uploadIgnore&&0!=obj.visible){if(obj.shader)for(let key in obj.shader.uniforms){let uniform=obj.shader.uniforms[key];uniform&&uniform.value&&uniform.value.promise&&(textures.push(uniform.value),promises.push(uniform.value.promise.then((_=>uploads.push(uniform.value.upload.bind(uniform.value)))).catch((e=>{}))))}if(obj.asyncPromise)promises.push(obj.asyncPromise.then((_=>{obj.geometry&&(obj.geometry.distributeBufferData=!0),uploads.push(obj.upload.bind(obj)),obj.geometry&&_async.push(obj.geometry.uploadBuffersAsync.bind(obj.geometry))})));else if(obj.upload){if(obj.geometry){if(obj.geometry.uploaded)return;obj.geometry.distributeBufferData=!0}uploads.push(obj.upload.bind(obj)),obj.geometry&&_async.push(obj.geometry.uploadBuffersAsync.bind(obj.geometry))}obj.shader&&obj.shader.shadow&&uploads.push(obj.shader.shadow.upload.bind(obj.shader.shadow)),obj.classRef&&obj.classRef.upload&&uploads.push(obj.classRef.upload.bind(obj.classRef))}}));let canFinish=!1,promise=Promise.create(),worker=new Render.Worker((_=>{let upload=uploads.shift();upload?upload():canFinish?((async _=>{for(let i=0;i<_async.length;i++)await _async[i]();for(let i=0;i<layouts.length;i++)await _this.uploadAllAsync(layouts[i],!!releaseQueue);"function"==typeof releaseQueue&&releaseQueue(),promise.resolve()})(),worker.stop()):worker.pause()}),1);return Promise.catchAll(promises).then((_=>{worker.resume(),canFinish=!0})),sceneLayout&&sceneLayout._completeInitialization&&sceneLayout._completeInitialization(!1),sceneLayout&&promise.then((_=>{delete sceneLayout.textures})),promise},this.detectUploadAll=function(group,sync,releaseQueue){return sync?_this.uploadAll(group):_this.uploadAllDistributed(group,releaseQueue)},this.detectUploadNuke=function(nuke,sync){return sync?_this.uploadNukeAsync(nuke):_this.uploadNuke(nuke)},this.uploadNuke=async function(nuke){if(nuke&&nuke.enabled){for(let i=0;i<nuke.passes.length;i++){let pass=nuke.passes[i],uniforms=pass.uniforms;for(let key in uniforms)uniforms[key].value&&uniforms[key].value.promise&&await uniforms[key].value.promise,uniforms[key].value&&uniforms[key].value.upload&&uniforms[key].value.upload();pass.upload()}Nuke.defaultPass.uploaded||Nuke.defaultPass.upload(),nuke.render()}},this.uploadNukeAsync=async function(nuke){let queue=await _this.queue(),calls=[];for(let i=0;i<nuke.passes.length;i++){let pass=nuke.passes[i],uniforms=pass.uniforms;for(let key in uniforms)uniforms[key].value&&uniforms[key].value.promise&&await uniforms[key].value.promise,uniforms[key].value&&uniforms[key].value.upload&&calls.push(uniforms[key].value.upload.bind(uniforms[key].value));calls.push(pass.upload.bind(pass))}Nuke.defaultPass.uploaded||calls.push(Nuke.defaultPass.upload.bind(Nuke.defaultPass)),calls.push(nuke.render.bind(nuke));let promise=Promise.create(),worker=new Render.Worker((function uploadBuffersAsync(){let cb=calls.shift();cb?cb():(promise.resolve(),worker.stop())}));await promise,queue()},this.destroyAll=function(scene){scene.traverse((obj=>{if(obj.geometry&&obj.shader){for(let key in obj.shader.uniforms){let uniform=obj.shader.uniforms[key];uniform&&uniform.value instanceof Texture&&uniform.value.destroy()}obj.destroy()}}))},this.set("loader",(loader=>{_loader=loader}))}),"static"),Class((function InteractAI(){Inherit(this,Model);this.SPEECH_RECOGNITION="interactai_speech_recognition",this.GPT_RESPONSE="interactai_gpt_response"}),"static"),InteractAI.Class((function Assistant(_props){Inherit(this,Component);const _this=this,BACKEND_URL="https://backend-dot-activetheory-v6.uc.r.appspot.com/api/assistant";var _thread_id="",_slug="",_project="";async function getThread(){await async function createThread(){let response=await post(`${BACKEND_URL}/createThread`),{id:id}=await response;_thread_id=id}()}async function sendMessage(message){await _this.wait((_=>!AppState.get("InteractAIAssistant/isThinking"))),AppState.set("InteractAIAssistant/isThinking",!0),_project&&(message=`I'm looking at ${_project}. `+message),await async function createMessage(content){_thread_id||await getThread();let response=await post(`${BACKEND_URL}/createMessage`,{threadId:_thread_id,content:content},{headers:{"Content-Type":"application/json"}}),{message:message}=await response;return message}(message),await async function createRun(){_thread_id||await getThread();let response=await post(`${BACKEND_URL}/createRun`,{threadId:_thread_id},{headers:{"Content-Type":"application/json"}}),{slug:slug}=await response;_slug=slug}();let text=await async function listMessage(){_thread_id||await getThread();let response=await post(`${BACKEND_URL}/listMessage`,{threadId:_thread_id},{headers:{"Content-Type":"application/json"}}),{text:text}=await response;return text}();return AppState.set("InteractAIAssistant/isThinking",!1),_slug&&(AppState.set("CMSData/slug",{slug:_slug,message:text},!0),_slug=""),text}AppState.set("InteractAIAssistant/isThinking",!1),async function(){!function addListeners(){AppState.bind("Work/project",(data=>{_project=data?data.perma:""}))}()}(),this.once=sendMessage,Dev.expose("sendMessage",sendMessage)})),InteractAI.Class((function GPT(_props){Inherit(this,Component);const _this=this;var _messages=[];async function get(){AppState.set("InteractAIGPT/thinking",!0);let req=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:"Bearer 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","Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:_messages,max_tokens:100})}),json=await req.json();_messages.push(json.choices[json.choices.length-1].message);_props.waitFor&&!_this.flag("first")?(_this.flag("first",!0),_this.bindState(AppState,_props.waitFor,(_=>{_this.events.fire(InteractAI.GPT_RESPONSE,{content:json.choices[json.choices.length-1].message.content}),AppState.set("InteractAIGPT/response",json.choices[json.choices.length-1].message.content)}))):(_this.events.fire(InteractAI.GPT_RESPONSE,{content:json.choices[json.choices.length-1].message.content}),AppState.set("InteractAIGPT/response",json.choices[json.choices.length-1].message.content))}function handleRecognition(transcript){_this.input(transcript)}!async function(){AppState.bind("SpeechRecognition/ready",(_=>{_messages.push({role:"system",content:_props.prompt}),get(),function addListeners(){_this.bindState(AppState,"InteractAIRecognition/transcript",handleRecognition)}()}))}(),this.input=function(content){_messages.push({role:"user",content:content}),get()},this.once=async function(message){let messages=[{role:"system",content:message}],req=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:"Bearer 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","Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:messages,max_tokens:500})}),json=await req.json();return json.choices[json.choices.length-1].message.content}})),InteractAI.Class((function Speech(_props){Inherit(this,Component);const _this=this;async function handleIncomingResponse(content){await _this.wait("touched"),async function speak(text){let voice=_props.voice||"XB0fDUnXU5powFXDhCwa",req=await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice}?optimize_streaming_latency=${_props.latency}`,{method:"POST",headers:{"Content-Type":"application/json","xi-api-key":"e684c739eea93b860b27c75fc88f0a28"},body:JSON.stringify({text:text,model_id:"eleven_monolingual_v1",voice_settings:{stability:0,similarity_boost:1,style:.2,use_speaker_boost:!0}})}),blob=await req.blob(),audioURL=URL.createObjectURL(blob),audio=new Audio(audioURL);AppState.set("InteractAISpeech/playing",!0),AppState.set("InteractAIGPT/thinking",!1),audio.play(),audio.addEventListener("ended",(_=>{AppState.set("InteractAISpeech/playing",!1)}))}(content)}function start(){_this.touched=!0,_this.events.unsub(Mouse.input,Interaction.START,start)}!function addListeners(){_this.bindState(AppState,"InteractAIGPT/response",handleIncomingResponse),_this.events.sub(Mouse.input,Interaction.START,start)}()})),InteractAI.Class((function SpeechRecognition(){Inherit(this,Component);const _this=this;var _recognition,_refresh;function initSR(){_recognition&&_recognition.stop();const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;(_recognition=new SpeechRecognition).onstart=onStart,_recognition.onresult=handleResult,_recognition.onerror=handleError,_recognition.continuous=!0,_recognition.start(),clearTimeout(_refresh),_refresh=_this.delayedCall(initSR,5e3)}async function handleAudioPlaying(playing){1==playing&&_this.flag("ignore",!0),0==playing&&_this.delayedCall((_=>{_this.flag("ignore",!1)}),1e3)}function onStart(){}function handleResult(e){if(clearTimeout(_refresh),_refresh=_this.delayedCall(initSR,5e3),AppState.get("InteractAIGPT/thinking"))return;if(AppState.get("InteractAISpeech/playing"))return;let transcript=e.results[e.results.length-1][0].transcript;AppState.set("InteractAIRecognition/transcript",transcript)}async function handleError(e){}!function(){if(_this.bindState(AppState,"InteractAISpeech/playing",handleAudioPlaying),!("SpeechRecognition"in window)&&!("webkitSpeechRecognition"in window))return async function initVosk(){const sampleRate=16e3,mediaStream=await navigator.mediaDevices.getUserMedia({video:!1,audio:{echoCancellation:!0,noiseSuppression:!0,channelCount:1,sampleRate:sampleRate}});await AssetLoader.loadAssets(["https://cdn.jsdelivr.net/npm/vosk-browser@0.0.5/dist/vosk.js"]);const channel=new MessageChannel,model=await Vosk.createModel("https://storage.googleapis.com/active-theory.appspot.com/ai/vosk-model-small-en-us-0.15.tar.gz");model.registerPort(channel.port1);const recognizer=new model.KaldiRecognizer(sampleRate);recognizer.setWords(!0),recognizer.on("result",(message=>{if(AppState.get("InteractAIGPT/thinking"))return;if(AppState.get("InteractAISpeech/playing"))return;const result=message.result;result.text.length&&AppState.set("InteractAIRecognition/transcript",result.text)})),recognizer.on("partialresult",(message=>{message.result.partial}));const audioContext=new AudioContext;await audioContext.audioWorklet.addModule("https://storage.googleapis.com/active-theory.appspot.com/ai/recognizer-processor.js");const recognizerProcessor=new AudioWorkletNode(audioContext,"recognizer-processor",{channelCount:1,numberOfInputs:1,numberOfOutputs:1});recognizerProcessor.port.postMessage({action:"init",recognizerId:recognizer.id},[channel.port2]),recognizerProcessor.connect(audioContext.destination);audioContext.createMediaStreamSource(mediaStream).connect(recognizerProcessor),AppState.set("SpeechRecognition/ready",!0)}();initSR(),AppState.set("SpeechRecognition/ready",!0)}(),this.onDestroy=function(){_recognition.stop()}})),Class((function AreaLightUtil(){Inherit(this,Component);var _init,_loaded=Promise.create(),_textures=[];this.append=async function(shader){Lighting.fallbackAreaToPoint||(_init||async function load(){_init=!0;let data=await fetch(Assets.getPath("assets/images/_lighting/arealights.json")),json=await data.json();_textures[0]=new DataTexture(new Float32Array(json.LTC1),64,64,Texture.RGBAFormat,Texture.FLOAT),_textures[1]=new DataTexture(new Float32Array(json.LTC2),64,64,Texture.RGBAFormat,Texture.FLOAT),_loaded.resolve()}(),shader.uniforms.tLTC1={type:"t",value:null,ignoreUIL:!0},shader.uniforms.tLTC2={type:"t",value:null,ignoreUIL:!0},await _loaded,shader.set("tLTC1",_textures[0]),shader.set("tLTC2",_textures[1]))}}),"static"),Class((function Light(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_folder,_debug,prefix=`L_${_input.prefix}`,_light=this.light=new BaseLight;function loop(){_light.position.copy(_this.group.position),_light.rotation.copy(_this.group.rotation)}function initNumber(key){let initValue=UILStorage.get(`${prefix}${key}`)||_light[key];if(_folder){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onChange((e=>{_light[key]=e,_this.events.fire(Light.UPDATE,{prefix:prefix,key:key,val:e,group:_this})})),number.onFinishChange((e=>UILStorage.set(`${prefix}${key}`,e))),_folder.add(number)}_light[key]=initValue}function update(e){e.prefix==prefix&&e.group!=_this&&(e.color?_light[e.key].set(e.val):_light[e.key]=e.val)}!function(){!async function initConfig(){(_config=InputUIL.create(prefix+"_config",_group)).setLabel("Config"),_config.addSelect("type",[{label:"Null",value:"-1"},{label:"Directional",value:"0"},{label:"Point",value:"1"},{label:"Spot",value:"2"},{label:"Area",value:"3"}]),await defer();let setup=_=>{_light.properties.w=_config.getNumber("type")+1,_group&&Utils.query("debugLight")&&(_debug&&_debug.destroy(),_debug=_this.initClass(LightDebug,_config.getNumber("type"),_light,_folder))};setup(),function initSpecificUIL(type){switch(type){case 0:break;case 2:_light.radius=1,_light.feather=0,_light.rotation.set(0,Math.radians(90),0),initNumber("radius"),initNumber("feather"),_light.data.set(_light.rotation.z,_light.rotation.y,_light.rotation.x,_light.radius),_light.data2.x=_light.feather,_group&&_this.startRender((_=>{_light.data2.x=_light.feather,_light.data.set(_light.rotation.z,_light.rotation.y,_light.rotation.x,_light.radius)}));break;case 3:_light._overridePos=new Vector3,_light.width=1,_light.height=1,_light.roughness=.5,_light.isAreaLight=!0,initNumber("width"),initNumber("height"),initNumber("roughness");let pos=new Vector3,matrix4=new Matrix4,matrix42=new Matrix4,halfWidth=new Vector3,halfHeight=new Vector3,camera=World.CAMERA,p=_this.group._parent;for(;p;)p instanceof Scene&&p.nuke&&(camera=p.nuke.camera),p=p._parent;let updateProperties=_=>{_light.updateMatrixWorld(!0),pos.setFromMatrixPosition(_light.matrixWorld),pos.applyMatrix4(camera.matrixWorldInverse),_light.data.x=pos.x,_light.data.y=pos.y,_light.data.z=pos.z,_light.data.w=_light.roughness,matrix42.identity(),matrix4.copy(_light.matrixWorld),matrix4.premultiply(camera.matrixWorldInverse),matrix42.extractRotation(matrix4),halfWidth.set(.5*_light.width,0,0),halfHeight.set(0,.5*_light.height,0),halfWidth.applyMatrix4(matrix42),halfHeight.applyMatrix4(matrix42),_light.data2.x=halfWidth.x,_light.data2.y=halfWidth.y,_light.data2.z=halfWidth.z,_light.data3.x=halfHeight.x,_light.data3.y=halfHeight.y,_light.data3.z=halfHeight.z};RenderManager.type==RenderManager.WEBVR?_this.startRender((e=>{camera=e.camera,updateProperties()}),RenderManager.EYE_RENDER):_this.startRender(updateProperties)}}(_config.getNumber("type")),_config.onUpdate=setup}(),_group&&(_folder=function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:"Params",closed:!0});return _group.add(folder),folder}(),function addListeners(){_this.events.sub(Light.UPDATE,update)}()),initNumber("intensity"),initNumber("distance"),initNumber("bounce"),function initColor(key){let initValue=UILStorage.get(`${prefix}${key}`);if(_folder){let color=new UILControlColor(`${prefix}${key}`,{label:key,value:initValue});color.onChange((e=>{_light[key].set(e),_this.events.fire(Light.UPDATE,{prefix:prefix,key:key,val:e,color:!0,group:_this})})),color.onFinishChange((e=>UILStorage.set(`${prefix}${key}`,e))),_folder.add(color)}initValue&&_light[key].set(initValue)}("color");let p=_this.parent.group._parent;for(;p;)p instanceof Scene&&p._lightingData&&(_light._lightingData=p._lightingData),p=p._parent;Lighting.add(_light),_this.startRender(loop)}(),this.onDestroy=function(){_light.destroy()},this.setColor=function(color){_light.color.copy(color)}}),(_=>{Light.UPDATE="light_update"})),Class((function LightDebug(_type,_light,_folder){Inherit(this,Object3D);const _this=this;function createLight(){let geom=World.SPHERE,shader=Utils3D.getTestShader(_light.color);shader.set("color",_light.color),shader.depthTest=!1,shader.transparent=!0;let mesh=new Mesh(geom,shader);mesh.scale.setScalar(.5),_this.add(mesh)}!function(){switch(_type){case-1:case 1:case 0:!function initPoint(){createLight();let geom=new IcosahedronGeometry(1,1),shader=Utils3D.getTestShader(_light.color);shader.set("color",_light.color),shader.wireframe=!0,shader.transparent=!0,shader.set("alpha",.2);let mesh=new Mesh(geom,shader);mesh.scale.setScalar(_light.distance),_this.add(mesh),_this.startRender((_=>mesh.scale.setScalar(_light.distance)))}();break;case 2:!function initSpot(){createLight()}();break;case 3:!function initArea(){let geom=World.PLANE,shader=Utils3D.getTestShader(_light.color);shader.set("color",_light.color),shader.transparent=!0,shader.side=Shader.DOUBLE_SIDE;let mesh=new Mesh(geom,shader);_this.add(mesh),_this.startRender((_=>mesh.scale.set(_light.width,_light.height,1)))}()}}(),this.onDestroy=function(){_this.parent.group.remove(_this.group)}})),Class((function LitMaterial(_mesh,_shader,_group,_input){_shader.receiveLight=!0,_shader.receiveShadow=!0,_shader.addUniforms({tMap:{value:Utils3D.getTexture("assets/images/_scenelayout/black.jpg")}})})),Class((function ShadowLight(_input,_group){Inherit(this,Object3D);const _this=this;var _light,_timer;!async function(){(_light=new BaseLight).prefix=_input.prefix,_this.add(_light),_light.silentShadow=ShadowLight.LOCKED,_this.light=_light;let scene,p=_this.parent.group._parent;for(;p;)p instanceof Scene&&p._lightingData&&(_light._lightingData=p._lightingData),p=p._parent;_light.castShadow=!0,ShadowUIL.add(_light,_group).setLabel("Shadows"),ShadowLight.LOCKED||(_this.startRender((_=>{})),_this.flag("waitStarted",Render.TIME),await _this.wait((()=>(scene=function findScene(){let p=_this.group._parent;for(;p;){if(p instanceof Scene)return p;p=p._parent}}(),!scene&&!_this.flag("warned")&&Render.TIME-_this.flag("waitStarted")>2e3&&(console.warn("ShadowLight has no parent scene after 2000ms"),_this.flag("warned",!0)),scene&&_this.flag("warned")&&console.log(`False alarm, ShadowLight got parent scene after ${Render.TIME-_this.flag("waitStarted")}ms`),scene))),scene.hasShadowLight=!0,scene.bindSceneChange((_=>{_light.static&&(_light.shadow.frozen=!1,clearTimeout(_timer),_timer=_this.delayedCall((_=>_light.shadow.frozen=!0),250))})))}(),this.onVisible=async function(){await defer(),_light.static&&(_light.shadow.frozen=!1,clearTimeout(_timer),_timer=_this.delayedCall((_=>_light.shadow.frozen=!0),250))},this.onDestroy=function(){_light.destroy()}})),Class((function LightVolume(_input,_group){Inherit(this,Object3D);const _this=this;var _data;!function initInput(){(_data=InputUIL.create(`Light_${_input.prefix}`,_group)).setLabel("Light Config"),_data.add("layers",5),_data.addToggle("sphere")}(),function initGeometry(){let sphere=_data.get("sphere"),layers=_data.getNumber("layers"),geom=sphere?LightVolume.getSphereGeometry(layers):LightVolume.getGeometry(layers),billboard=_input.get("billboard"),shader=_this.initClass(Shader,"LightVolume",{unique:_input.prefix,tMap:{value:Utils3D.getTexture("assets/images/_lightvolume/light.jpg")},tMask:{value:Utils3D.getRepeatTexture("assets/images/_lightvolume/light-mask.jpg")},uScale:{value:1},uSeparation:{value:.1},uAlpha:{value:1},uMaskScale:{value:1},uRotateSpeed:{value:1},uRotateTexture:{value:0},uNoiseScale:{value:0},uNoiseSpeed:{value:0},uNoiseRange:{value:0},uOffset:{value:0},uScrollX:{value:1},uScrollY:{value:1},uHueShift:{value:0},uDPR:{value:World.DPR},uNoiseMin:{value:1},uColor:{value:new Color},transparent:!0,depthWrite:!1,blending:Shader.ADDITIVE_BLENDING,side:_input.get("side")});ShaderUIL.add(shader,_group).setLabel("Shader");let mesh=new Mesh(geom,shader);mesh.frustumCulled=!1,_this.add(mesh),_this.shader=shader,_this.mesh=mesh;let renderOrder=_input.getNumber("renderOrder");"number"!=typeof renderOrder||isNaN(renderOrder)||(mesh.renderOrder=_this.parent.baseRenderOrder+renderOrder),!1===_input.get("depthTest")&&(shader.depthTest=!1),billboard&&JSON.parse(billboard)&&_this.startRender((_=>Utils3D.billboard(mesh)))}(),this.set("dpr",(v=>{_this.shader.set("uDPR",v)})),this.set("noise",(v=>{_this.shader.set("uNoiseMin",v)})),this.set("needsUpdate",(v=>{_this.shader.ubo&&(_this.shader.ubo.needsUpdate=!0)}))}),(_=>{var _quad,_sphere,_geom={};LightVolume.getGeometry=function(layers){if(_quad||(_quad=new PlaneGeometry(1,1).toNonIndexed()),!_geom[layers]){let geom=new Geometry;for(let key in _quad.attributes)geom.addAttribute(key,_quad.attributes[key]);let offset=new Float32Array(3*layers),attribs=new Float32Array(4*layers);for(let i=0;i<layers;i++)offset[3*i+2]=i,attribs[4*i+0]=Math.random(0,1,5),attribs[4*i+1]=Math.random(0,1,5),attribs[4*i+2]=Math.random(0,1,5),attribs[4*i+3]=Math.random(0,1,5);geom.addAttribute("offset",new GeometryAttribute(offset,3,1)),geom.addAttribute("attribs",new GeometryAttribute(attribs,4,1)),_geom[layers]=geom}return _geom[layers]},LightVolume.getSphereGeometry=function(layers){if(_sphere||(_sphere=new SphereGeometry(1,32,32).toNonIndexed()),!_geom[`sphere_${layers}`]){let geom=new Geometry;for(let key in _sphere.attributes)geom.addAttribute(key,_sphere.attributes[key]);let offset=new Float32Array(3*layers),attribs=new Float32Array(4*layers);for(let i=0;i<layers;i++)offset[3*i+2]=i,attribs[4*i+0]=Math.random(0,1,5),attribs[4*i+1]=Math.random(0,1,5),attribs[4*i+2]=Math.random(0,1,5),attribs[4*i+3]=Math.random(0,1,5);geom.addAttribute("offset",new GeometryAttribute(offset,3,1)),geom.addAttribute("attribs",new GeometryAttribute(attribs,4,1)),_geom[`sphere_${layers}`]=geom}return _geom[`sphere_${layers}`]}})),Class((function Webcam(_width,_height,_audio){Inherit(this,Component);var _this=this;let _stream,_imageData,_cameras={},_config={},_back=!1,_attempts=0;if("object"==typeof _width&&_width.isAppState){let config=_width;_width=config.width,_height=config.height,_audio=config.audio}function establishWebcam(){if(_attempts>=2||!navigator.mediaDevices)return error();(function lookupDevices(){let promise=Promise.create();return navigator.mediaDevices.enumerateDevices().then((devices=>{devices.forEach((device=>{device.label.includes("front")&&(_cameras.front={deviceId:{exact:device.deviceId}}),device.label.includes("back")&&(_cameras.back={deviceId:{exact:device.deviceId}},_back=!0)})),_cameras.front||(_cameras.front={facingMode:"user"}),_cameras.back||(_cameras.back={facingMode:"environment"},_back=!1),promise.resolve()})),promise})().then((()=>{_stream&&_config.back&&_stream.getTracks()[0].stop(),Device.mobile.phone&&(_cameras&&_cameras.back&&(_cameras.back.frameRate={ideal:60}),_cameras&&_cameras.front&&(_cameras.front.frameRate={ideal:60})),_width&&(_cameras.front.width={ideal:_width}),_height&&(_cameras.front.height={ideal:_height}),navigator.mediaDevices.getUserMedia({video:_config.back?_cameras.back:_cameras.front||!0,audio:_audio}).then(success).catch(error)})),_attempts+=1}function success(stream){_this.denied=!1,_stream=stream;let settings=_stream.getTracks()[0].getSettings();_width=settings.width,_height=settings.height,_config.back&&!_back?establishWebcam():(_this.div.width=_width,_this.div.height=_height,_this.div.srcObject=stream,_this.events.fire(Events.READY,null,!0))}function error(){_this.denied=!0,_this.events.fire(Events.ERROR,null,!0)}function update(){_this.events.fire(Events.UPDATE),_this.div.requestVideoFrameCallback?.(update),_imageData=null}_this.facing="back",function createVideo(){_this.div=document.createElement("video"),_this.div.width=_width||320,_this.div.height=_height||180,_this.div.autoplay=!0,_this.div.playsinline=!0,_this.div.setAttribute("playsinline",!0),_this.div.style.zIndex=-1,_this.div.style.position="absolute",Stage.add(_this.div),_this.element=$(_this.div)}(),function initNavigator(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia}(),this.createStream=function(config={}){_attempts=0,_config=config,Device.mobile||(delete _config.back,delete _config.front),establishWebcam(),_this.div.requestVideoFrameCallback?_this.div.requestVideoFrameCallback(update):_this.startRender(update,24)},this.flip=function(){if(!_back)return;let direction;"front"===_this.facing?(_this.facing="back",direction=_cameras.back):(_this.facing="front",direction=_cameras.front),_stream.getTracks()[0].stop(),navigator.getUserMedia({video:direction||!0,audio:_audio},success,error)},this.get("width",(function(){return _width})),this.get("height",(function(){return _height})),this.size=function(w,h){_this.div.width=_width=w,_this.div.height=_height=h,_this.element.size(w,h)},this.getPixels=function(width=_width,height=_height){return _this.canvas||(_this.canvas=document.createElement("canvas"),_this.canvas.width=width,_this.canvas.height=height,_this.canvas.context=_this.canvas.getContext("2d",{willReadFrequently:!0})),_imageData||_this.canvas.context.drawImage(_this.div,0,0,width,height),_imageData=!0,_this.canvas.context.getImageData(0,0,width,height)},this.getCanvas=function(){return _this.canvas||(_this.canvas=document.createElement("canvas"),_this.canvas.width=_width,_this.canvas.height=_height,_this.canvas.context=_this.canvas.getContext("2d")),_this.canvas.context.drawImage(_this.div,0,0,_width,_height),_this.canvas},this.ready=function(){return _this.wait((_=>_this.div.readyState>0))},this.end=function(){_this.active=!1,_this.div.pause(),_stream&&(_stream.getTracks()[0].enabled=!1)},this.restart=function(){_this.div.play(),_stream&&(_stream.getTracks()[0].enabled=!0),_this.active=!0},this.deviceCount=async function(kind){if(!navigator.mediaDevices)return 0;let devices=await navigator.mediaDevices.enumerateDevices(),count=0;return devices.forEach((d=>{d.kind.includes(kind)&&count++})),count},this.get("frameRate",(()=>{if(_stream)return _stream.getTracks()[0].getSettings().frameRate})),this.get("aspectRatio",(()=>{if(_stream)return _stream.getTracks()[0].getSettings().aspectRatio}))})),Namespace("FX"),FX.Class((function Mirror(_mesh,_params={}){Inherit(this,FXScene);const _this=this;var _renderer,_renderer2;if(_mesh.isAppState){let props=_mesh;_mesh=props.mesh,_params=props}var _renderTarget,_frustum=new Frustum;function loop({stage:stage,camera:camera,view:view,eye:eye}){if(!_this.visible||!_this.enabled||!_mesh)return;let renderer="right"===eye?_renderer2:_renderer;if(stage?(renderer.camera=camera,_this.nuke.camera=camera,_this.nuke.stage=stage):(_params.nuke&&_params.nuke.camera!=_this.nuke.camera&&(_this.nuke.camera=_params.nuke.camera),_this.nuke.camera!=_renderer.camera&&(_renderer.camera=_this.nuke.camera)),_this.frustumCulled&&(_frustum.setFromCamera(_this.nuke.camera),!_frustum.intersectsObject(_mesh)))return;_this.draw(),_mesh.matrixWorld.decompose(renderer.position,renderer.quaternion,renderer.scale);let clearColor=null;_this.clearColor&&(clearColor=World.RENDERER.getClearColor().getHex(),World.RENDERER.setClearColor(_this.clearColor)),World.RENDERER.overridePreventShadows=!0,_renderTarget.customViewport=renderer.customViewport,renderer.autoClear=!view,renderer.render(_this.scene),World.RENDERER.overridePreventShadows=!1,_this.clearColor&&World.RENDERER.setClearColor(clearColor),_this.postRender&&_this.postRender()}function decorateShader(shader){shader.uniforms.tMirrorReflection={value:_renderer.renderTarget.texture,ignoreUIL:!0},shader.uniforms.uMirrorMatrix={value:_renderer.textureMatrix,ignoreUIL:!0},shader.uniforms.uIsMirror=FX.Mirror.isMirrorUniform,_this.usingVR&&RenderManager.schedule((({object:object,eye:eye})=>{object.shader===shader&&Shader.renderer.appendUniform(object.shader,"uMirrorMatrix","left"===eye?_renderer.textureMatrix:_renderer2.textureMatrix)}),RenderManager.BEFORE_OBJECT_EYE_RENDER)}this.visible=!0,this.enabled="boolean"!=typeof _params.enabled||_params.enabled,this.frustumCulled=!0,this.manualRender=!0,_mesh&&_mesh.isGroup&&_mesh.traverse((obj=>{obj.shader&&"TestMaterial"!==obj.shader.fsName&&(_mesh=obj)})),_mesh&&!_params.shader&&(_params.shader=_mesh.shader),_params.nuke=_params.nuke||function findNuke(){let p=_this.parent;for(;p;){if(p.nuke)return p.nuke;p=p.parent}for(p=_this.parent;p;){if(p.nuke)return p.nuke;p=p.group?p.group._parent:p.parent||p._parent}return World.NUKE}(),_this.create(_params.nuke),_this.preventRTDraw=!0,_this.usingVR=RenderManager.type===RenderManager.VR,function initMirror(){let width=_params.width||512,height=_params.height||512;_params.size&&(width=height=_params.size),_this.usingVR&&(width*=2);let filter=_params.mipmaps?Texture.LINEAR_MIPMAP:Texture.LINEAR;_renderTarget=new RenderTarget(width,height,{minFilter:filter,magFilter:filter,format:_params.format||Texture.RGBFormat,generateMipmaps:_params.mipmaps||!1}),_renderer=new MirrorRenderer(_params.nuke.camera,{renderTarget:_renderTarget,clipBias:_params.clipBias||.01,sx:_this.usingVR?.25:.5}),_this.usingVR&&(_renderer2=new MirrorRenderer(_params.nuke.camera,{renderTarget:_renderTarget,clipBias:_params.clipBias||.01,sx:.25,tx:.5}),_renderer.customViewport=new Vector4(0,0,width/2,height),_renderer2.customViewport=new Vector4(width/2,0,width/2,height)),_params.normal&&(_renderer.normalDir=_params.normal,_this.usingVR&&(_renderer2.normalDir=_params.normal))}(),decorateShader(_params.shader),this.onDestroy=function(){_renderer.destroy(),_renderer2&&_renderer2.destroy()},this.applyTo=decorateShader,this.start=function(nuke=_params.nuke){_this.startRender(loop,_this.usingVR?RenderManager.EYE_RENDER:nuke)},this.stop=function(nuke=_params.nuke){_this.stopRender(loop,_this.usingVR?RenderManager.EYE_RENDER:nuke)},this.decorate=decorateShader,this.useMesh=function(mesh){_mesh=mesh,_params.shader||(_params.shader=_mesh.shader),decorateShader(_params.shader)},this.useCamera=function(camera){camera=camera.camera||camera,_renderer.camera=camera,_this.nuke.camera=camera,_renderer2&&(_renderer2.camera=camera)},this.add=async function(obj){return _params.nuke.attachments>1?(await obj.shader.onBeforePrecompilePromise,_this.addObject(obj)):_this.addObject(obj)},this.render=loop,this.set("clipBias",(v=>_renderer.clipBias=v))}),(()=>{FX.Mirror.isMirrorUniform={value:0,type:"f",ignoreUIL:!0}}));class MirrorRenderer extends Base3D{constructor(camera,options={}){super(),this._camera=camera,this.autoClear=options.autoClear??!0,this.width=options.width||512,this.height=options.height||512,this.clipBias=options.clipBias||0,this.sx=options.sx||.5,this.tx=options.tx||0,this.renderer=World.RENDERER,this.mirrorPlane=new Plane,this.normalDir=new Vector3(0,0,1),this.normal=new Vector3(0,0,1),this.mirrorWorldPosition=new Vector3,this.cameraWorldPosition=new Vector3,this.rotationMatrix=new Matrix4,this.lookAtPosition=new Vector3(0,0,-1),this.clipPlane=new Vector4,this.textureMatrix=new Matrix4,this.mirrorCamera=this._camera.clone();let filter=options.mipmaps?Texture.LINEAR_MIPMAP:Texture.LINEAR;this.renderTarget=options.renderTarget||new RenderTarget(this.width,this.height,{minFilter:filter,magFilter:filter,format:options.format||Texture.RGBFormat,generateMipmaps:options.mipmaps||!1}),this.viewVec=new Vector3,this.targetVec=new Vector3,this.q=new Quaternion,this.updateTextureMatrix()}updateTextureMatrix(){this.updateMatrixWorld(),this._camera.updateMatrixWorld(),this.mirrorWorldPosition.setFromMatrixPosition(this.matrixWorld),this.cameraWorldPosition.setFromMatrixPosition(this._camera.matrixWorld),this.rotationMatrix.extractRotation(this.matrixWorld),this.normal.copy(this.normalDir),this.normal.applyMatrix4(this.rotationMatrix),this.viewVec.copy(this.mirrorWorldPosition).sub(this.cameraWorldPosition),this.viewVec.reflect(this.normal).negate(),this.viewVec.add(this.mirrorWorldPosition),this.rotationMatrix.extractRotation(this._camera.matrixWorld),this.lookAtPosition.set(0,0,-1),this.lookAtPosition.applyMatrix4(this.rotationMatrix),this.lookAtPosition.add(this.cameraWorldPosition),this.targetVec.copy(this.mirrorWorldPosition).sub(this.lookAtPosition),this.targetVec.reflect(this.normal).negate(),this.targetVec.add(this.mirrorWorldPosition),this.up.set(0,-1,0),this.up.applyMatrix4(this.rotationMatrix),this.up.reflect(this.normal).negate(),this.mirrorCamera.position.copy(this.viewVec),this.mirrorCamera.up=this.up,this.mirrorCamera.lookAt(this.targetVec),this.mirrorCamera.updateMatrixWorld(),this.mirrorCamera.projectionMatrix.copy(this._camera.projectionMatrix),this.textureMatrix.set(this.sx,0,0,this.sx+this.tx,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.mirrorCamera.projectionMatrix),this.textureMatrix.multiply(this.mirrorCamera.matrixWorldInverse),this.mirrorPlane.setFromNormalAndCoplanarPoint(this.normal,this.mirrorWorldPosition),this.mirrorPlane.applyMatrix4(this.mirrorCamera.matrixWorldInverse),this.clipPlane.set(this.mirrorPlane.normal.x,this.mirrorPlane.normal.y,this.mirrorPlane.normal.z,this.mirrorPlane.constant);let projectionMatrix=this.mirrorCamera.projectionMatrix,q=this.q;q.x=(Math.sign(this.clipPlane.x)+projectionMatrix.elements[8])/projectionMatrix.elements[0],q.y=(Math.sign(this.clipPlane.y)+projectionMatrix.elements[9])/projectionMatrix.elements[5],q.z=-1,q.w=(1+projectionMatrix.elements[10])/projectionMatrix.elements[14];let c=this.clipPlane.multiplyScalar(2/this.clipPlane.dot(q));projectionMatrix.elements[2]=c.x,projectionMatrix.elements[6]=c.y,projectionMatrix.elements[10]=c.z+1-this.clipBias,projectionMatrix.elements[14]=c.w}render(scene){this.updateTextureMatrix(),FX.Mirror.isMirrorUniform.value=1;let autoClear=this.renderer.autoClear;this.renderer.autoClear=this.autoClear,this.renderer.render(scene,this.mirrorCamera,this.renderTarget),this.renderer.autoClear=autoClear,FX.Mirror.isMirrorUniform.value=0}destroy(){this.renderTarget.destroy()}set camera(c){this._camera=c,this.mirrorCamera=c.clone()}get camera(){return this._camera}}Class((function MouseFluid(_params={active:!0}){Inherit(this,Object3D);const _this=this;var _config,_fluid,_custom;this.scale=1;var _scale=1,_last=new Vector2,_mouse=new Vector2,_white=new Color("#ffffff");function loop(){_scale+=(_this.scale-_scale)*Math.framerateNormalizeLerpAlpha(.05),_custom||_mouse.copy(Mouse);let len=_mouse.distanceTo(_last),size=_this.scaleBasedOnVelocity?Math.range(len,0,5,0,60,!0):25;size*=.6;let delta=Math.range(len,0,15,0,10,!0);len>.01&&_fluid.drawInput(_mouse.x,_mouse.y,(_mouse.x-_last.x)*delta,(_mouse.y-_last.y)*delta,_white,size*_scale),_last.copy(_mouse)}this.scaleBasedOnVelocity=!0,async function(){let layout=_this.initClass(SceneLayout,"mousefluid");_fluid=await layout.getLayer("fluid"),function initConfig(){(_config=InputUIL.create(_fluid.uilInput.prefix+"mousefluid",_fluid.uilGroup)).setLabel("MouseFluid Config"),_config.add("scale",1),_config.onUpdate=key=>{if("scale"===key)_this.scale=_config.getNumber("scale")},_config.onUpdate()}(),_this.isPlayground()&&_fluid.initMesh(),_this.fluid=_fluid,_params.active?_this.startRender(loop,RenderManager.AFTER_LOOPS):_fluid.visible=!1}(),this.applyTo=async function(shader){await _this.wait("fluid"),shader.uniforms.tFluid=_fluid.fbos.velocity.uniform,shader.uniforms.tFluidMask={value:_fluid}},this.useCustomMouse=function(){_custom=!0},this.getFluid=async function(){return await _this.wait("fluid"),_this.fluid},this.get("mouse",(_=>_mouse))}),"singleton"),Class((function Multiplayer(){Inherit(this,Component);const _this=this;let _room,_focusPromise,_leavingPromise,_joiningPromise;async function leave(){await _joiningPromise,_leavingPromise=Promise.create();let fallback=_this.delayedCall((_=>{_this.leaving=!1,_leavingPromise.resolve()}),5e3);_this.leaving=!0,PhysicalSync.useRoom(null),_room&&_room.leave&&(_room=_room.leave()),PlayerModel.useRoom(null),window.GameCenterMedia&&await GameCenterMedia.useRoom(null),_this.leaving=!1,_leavingPromise.resolve(),clearTimeout(fallback)}function onVisibility(e){"focus"==e.type?_focusPromise&&_focusPromise.resolve():_focusPromise=null}function handlePin(e){_this.events.fire(_this.PIN,e)}function handleUnpin(e){_this.events.fire(_this.UNPIN,e)}function gameCenterBlocked(){_this.events.fire(_this.UNREACHABLE)}this.ROOM="multiplayer_room",this.PIN="multiplayer_pin",this.UNPIN="multiplayer_unpin",this.UNREACHABLE="multiplayer_unreachable",function addListeners(){_this.events.sub(Events.VISIBILITY,onVisibility)}(),this.connect=function(server){GameCenter.connect(server),_this.events.sub(GameCenter.BLOCKED_ERROR,gameCenterBlocked)},this.establish=async function(obj){_room&&leave(),await _leavingPromise,await _this.wait(50),_joiningPromise=Promise.create();try{if(obj.roomId){let fn=obj.watcher?GameCenter.watchRoom:GameCenter.joinRoom;_room=await fn(`${obj.community?"community_":""}${obj.roomKey+"/"+obj.roomId}`,obj)}else _room=await GameCenter.findRoom(`${obj.community?"community_":""}${obj.roomKey}`,obj)}catch(e){if(!obj.roomId||!obj.community)throw e;try{_room=await GameCenter.watchRoom("community_"+(obj.roomKey+"/"+obj.roomId),!0)}catch(e){throw e}}return PhysicalSync.useRoom(_room),PlayerModel.useRoom(_room),window.GameCenterMedia&&await GameCenterMedia.useRoom(_room),Dev.expose("room",_room),_this.events.sub(_room,GameCenterRoom.PIN,handlePin),_this.events.sub(_room,GameCenterRoom.UNPIN,handleUnpin),_this.events.fire(_this.ROOM,{room:_room}),_joiningPromise.resolve(),_room},this.leave=function(room){_room==room&&leave()},this.pin=function(data,timeInSeconds){_room&&_room.pin(data,timeInSeconds)},this.unpin=function(data){_room&&_room.unpin(data)},this.waitForFocus=function(){return _focusPromise||(_focusPromise=Promise.create()),_focusPromise},this.get("room",(_=>_room))}),"static"),Class((function MultiplayerConfig(_params){_params.server&&Multiplayer.connect(_params.server),this.parent.configure({roomKey:_params.roomKey,roomId:_params.roomId,playerClass:window[_params.playerClass],maxInRoom:_params.maxInRoom||50,playerData:_params.data})})),Class((function MultiplayerEnvironment(){const _this=this;var _config,_room,_active,_synced,_players={},_playersState=new StateArray([]);function onConnection(e){let player=_this.initClass(Player,_config.playerClass,e.id,e.player,_config.playerData);_this.onConnection&&_this.onConnection(player),_players[e.id]=player,getStatePlayerById(e.id)||_playersState.push({id:e.id,player:player})}function getStatePlayerById(id){let returnedPlayer=null;return _playersState.forEach((state=>{state.get("id")===id&&(returnedPlayer=state)})),returnedPlayer}async function onDisconnection(e){let statePlayer=getStatePlayerById(e.id);statePlayer&&_playersState.remove(statePlayer),delete _players[e.id]}async function onError(){await Multiplayer.waitForFocus(),_active&&(_room=await Multiplayer.establish(_config),_this.events.sub(_room,GameCenterRoom.ERROR,onError))}function onPromoted(){_this.player.enable()}async function onLostConnection(e){await e.reconnected(),_active&&_this.onVisible()}async function createConnection(){if(!_config)return _this.delayedCall((_=>_this.onVisible?.()),100);if(_this.events.sub(PhysicalSync.CONNECTION,onConnection),_this.events.sub(PhysicalSync.DISCONNECTION,onDisconnection),_this.events.sub(GameCenter.LOST_CONNECTION,onLostConnection),_active=!0,_config.maxInRoom>0)try{if(!(_room=await Multiplayer.establish(_config))||!_room.events)return;_this.events.sub(_room,GameCenterRoom.ERROR,onError),_this.events.sub(_room,GameCenterRoom.PROMOTED,onPromoted)}catch(e){_this.delayedCall((_=>_this.onVisible()),100)}if(!_this.player||null==_this.player.enable){if(!Multiplayer.room)return;_this.player=_this.initClass(Player,_config.playerClass,null,Multiplayer.room.me,_config.playerData)}_room.watcher&&_this.player&&_this.player.disable()}!function(){if(!_this.events)throw"MultiplayerEnvironment must be inherited alongside Object3D, FXScene, or Component";_this.startRender((_=>{}))}(),this.configure=async function(obj){if(obj){if(_config&&_config.roomKey==obj.roomKey&&_config.roomId==obj.roomId)return;if(!obj.roomKey)throw"configure must define roomKey";if(!obj.playerClass)throw"configure must define playerClass";if(void 0===obj.maxInRoom)throw"configure must define maxInRoom";!0!==obj.p2p&&(obj.community=!0),_config=obj}return _config.maxInRoom>0&&(_active?((_room=await Multiplayer.establish(_config)).watcher&&_this.player&&_this.player.disable(),_this.events.sub(_room,GameCenterRoom.ERROR,onError),_this.events.sub(_room,GameCenterRoom.PROMOTED,onPromoted)):!1===_this._invisible&&(_this.onVisible(),_this.delayedCall((_=>{!1!==_this._invisible||Multiplayer.room||_this.onVisible()}),1e3))),_room},this.onVisible=async function(){_this.fxVisible&&_this.fxVisible(),Utils.debounce(createConnection,100)},this.clearMultiplayer=function(){_this.player&&(_this.player.visible=!1),this.onInvisible(),_config=null},this.onInvisible=this.onDestroy=function(){_this.flag("setVisible",!1),_this.fxInvisible&&_this.fxInvisible(),_config&&(_this.events.unsub(PhysicalSync.CONNECTION,onConnection),_this.events.unsub(PhysicalSync.DISCONNECTION,onDisconnection),_this.events.unsub(GameCenter.LOST_CONNECTION,onLostConnection),Multiplayer.leave(_room),_room=_active=!1,_this.player&&_this.player.onDisconnect?.())},this.onConnection=this.onDisconnection=function(){},this.synchronizedObjects=function(key){return _synced||(_synced=_this.initClass(SynchronizedObjects,key)),_synced},this.getPlayers=function(includeSelf=!1){return includeSelf?{..._players,me:_this.player}:_players},this.hasPlayer=function(){return _this.wait("player")},this.playersState=_playersState})),Class((function Player(PlayerClass,_id,_player,_playerData={}){Inherit(this,Object3D),Inherit(this,PhysicalLink,_id);const _this=this;var _view,_playerId=_player.id;function updateState(data){for(let key in data)_this.state.set(key,data[key])}this.gcPlayer=_player,this.state=AppState.createLocal(),this.data=_player.data,_player.data&&_player.data.data&&(this.data=_player.data.data),function(){let playerData={};for(let key in _playerData)playerData[key]=_playerData[key];if(playerData.local=!_id,_this.view=_view=_this.initClass(PlayerClass,playerData),!_view.setUserData)throw"Player :: View must inherit PlayerView";_this.bindLink(_this.group,"player"),_id?function initRemote(){let data=_player.data;data.data&&(data=data.data);updateState(data),_view.setUserData(data,_player),_this.events.sub(_player,GameCenterPlayer.UPDATE_DATA,(({data:data})=>{data.data&&(data=data.data),_view.setUserData(data,_player),updateState(data)}))}():async function initLocal(){_view.setUserData(PlayerModel.data),updateState(PlayerModel.data),_this.events.sub(PlayerModel,PlayerModel.UPDATE,(_=>{_view.setUserData(PlayerModel.data),updateState(PlayerModel.data)}))}(),_this.events.fire(Player.JOIN,{player:_this})}(),this.onDisconnect=async function(){_this.parent.onDisconnection&&_this.parent.onDisconnection(_this),await _view.onDisconnect(),_this.parent&&(_this.events.fire(Player.LEAVE,{id:_playerId,player:_this,playerData:_this.data}),tween(_this.group.scale,{x:0,y:0,z:0},300,"easeOutCubic").onComplete((_=>{_this.parent&&_this.parent.group&&_this.parent.group.remove(_this.group),_this.destroy&&_this.destroy()})))},this.disable=function(){_this.group.visible=!1},this.enable=function(){_this.group.visible=!0}}),(_=>{Player.JOIN="player_join",Player.LEAVE="player_leave"})),Class((function PlayerModel(){Inherit(this,Model);const _this=this;var _room;this.UPDATE="player_model_update",this.state=AppState.createLocal(),this.state._set=this.state.set,this.state.set=this.set,function(){_this.data=Storage.get("playerModel")||{},GameCenter.userData=_this.data;for(let key in _this.data)_this.state._set(key,_this.data[key]);_this.dataReady=!0}(),this.set=function(key,value){_this.data[key]=value,Storage.set("playerModel",_this.data),_room&&_room.updateUserData(_this.data),_this.events.fire(_this.UPDATE),_this.state._set(key,value)},this.get=function(key){return _this.data[key]},this.useRoom=function(room){_room=room}}),"static"),Class((function PlayerView(){Inherit(this,Object3D);this.state=this.parent.state,this.bindLink=this.parent.bindLink,this.bindEvent=this.parent.bindEvent,this.bindGlobal=this.parent.bindGlobal,this.bindGlobalEvent=this.parent.bindGlobalEvent,this.fireEvent=this.parent.fireEvent,this.setPlayerData=PlayerModel.set,this.setUserData=function(){},this.onDisconnect=function(){}})),Class((function QRCode(_params={size:512}){Inherit(this,Component);const _this=this;var _context;!async function(){if(_this.canvas=document.createElement("canvas"),_this.canvas.width=_this.canvas.height=_params.size,_context=_this.canvas.getContext("2d"),_this.glui=$gl(_params.size,_params.size,_this.canvas),"localhost"==location.hostname)throw"Can't generate a QR code using localhost. Use your local IP address instead so other devices on your network can access it.";let url=location.href;url+=url.includes("?")?"&":"?",url+="mlt="+btoa(JSON.stringify({test:1}));let qrCode=await QRGen.create(url,_params.size);_context.drawImage(qrCode,0,0)}()})),Class((function QRGen(){Inherit(this,Component);const _this=this;this.create=async function(url,size,config={}){_this.flag("loadLib")||function loadLib(){_this.flag("loadLib",!0),AssetLoader.loadAssets(["assets/js/lib/qrious.js"])}(),await AssetLoader.waitForLib("QRious");let canvas=document.createElement("canvas");canvas.width=canvas.height=size;new QRious(Utils.mergeObject(config,{element:canvas,value:url,size:size}));return canvas}}),"static"),Class((function SynchronizedObjects(_key=""){Inherit(this,Component);const _this=this;var _data=[],_active=[],_objects={},_v3=new Vector3,_q=new Quaternion,_name=_key+Utils.getConstructorName(_this.parent);function loop(){let stage=_this.parent.player.stage||Stage;_data.length=0;for(let i=_active.length-1;i>-1;i--){let obj=_active[i];obj.position?(obj.position.toArray(obj.syncObj.p),obj.quaternion.toArray(obj.syncObj.q)):(obj.syncObj.p[0]=obj.x/stage.width,obj.syncObj.p[1]=obj.y/stage.height),_data.push(obj.syncObj)}let players=_this.parent.getPlayers();for(let key in players){let player=players[key];if(player.me)continue;let data=player.group.extraData;data&&data.forEach((d=>{let obj=_objects[d.key];if(obj){if(obj.syncObj)for(let key in d)"p"!=key&&"q"!=key&&"key"!=key&&(obj.syncObj[key]=d[key]);2==d.p.length?(obj.x=Math.lerp(d.p[0]*stage.width,obj.x,_this.lerp),obj.y=Math.lerp(d.p[1]*stage.height,obj.y,_this.lerp)):(_v3.fromArray(d.p),_q.fromArray(d.q),obj.position.lerp(_v3,_this.lerp),obj.quaternion.slerp(_q,_this.lerp))}}))}}function syncStart({key:key}){let object=_objects[key];object&&!object.isActive&&(object.isActive=!0,object.onActivate&&object.onActivate())}function syncEnd({key:key,syncObj:syncObj}){let object=_objects[key];object&&object.isActive&&(object.isActive=!1,object.onDeactivate&&object.onDeactivate(syncObj))}this.lerp=.3,async function(){await _this.parent.wait("player"),_this.parent.player.bindGlobalEvent(_name+"sync_start",syncStart),_this.parent.player.bindGlobalEvent(_name+"sync_end",syncEnd),_this.parent.player.group.extraData=_data,_this.startRender(loop)}(),this.add=function(obj,key){obj.syncObj={p:[],q:[],key:key},_objects[key]=obj,obj.startSync=_=>{obj.syncedKey=key,_active.push(obj),_this.parent.player.fireEvent(_name+"sync_start",{key:key})},obj.endSync=_=>{_active.remove(obj),_this.parent.player.fireEvent(_name+"sync_end",{key:key,syncObj:obj.syncObj})}},this.removeByKey=function(key){void 0!==_objects[key]&&(_active.remove(_objects[key]),delete _objects[key])}})),Class((function ParticleDistributor(){Inherit(this,Component);const _this=this;function init(){_this.flag("initGenerate")||(_this.flag("initGenerate",!0),Thread.upload(distributeParticles),Thread.upload(generatePointCloud),Thread.upload(generatePointGrid))}function distributeParticles(e,id){let{position:position,count:count,normal:normal,uv:uv,skinIndex:skinIndex,skinWeight:skinWeight,offset:offset,scale:scale,orientation:orientation}=e,vertices=position.length/3,v3=new Vector3,v32=new Vector3,v33=new Vector3,q=new Quaternion,outputPosition=new Float32Array(3*count),outputNormal=normal?new Float32Array(3*count):null,outputUV=uv?new Float32Array(3*count):null,outputSkinIndex=skinIndex?new Float32Array(4*count):null,outputSkinWeight=skinWeight?new Float32Array(4*count):null;for(let i=0;i<count;i++){let j=3*Math.random(0,vertices/3);v3.set(Math.random(0,100),Math.random(0,100),Math.random(0,100));let m=1/(v3.x+v3.y+v3.z);if(v3.set(v3.x*m,v3.y*m,v3.z*m),outputPosition[3*i+0]=position[3*j+0]*v3.x+position[3*j+3]*v3.y+position[3*j+6]*v3.z,outputPosition[3*i+1]=position[3*j+1]*v3.x+position[3*j+4]*v3.y+position[3*j+7]*v3.z,outputPosition[3*i+2]=position[3*j+2]*v3.x+position[3*j+5]*v3.y+position[3*j+8]*v3.z,offset){let randomInstance=Math.random(0,offset.length/3-1);v32.fromArray(outputPosition,3*i),v33.fromArray(scale,3*randomInstance),v32.multiplyScalar(v33),q.fromArray(orientation,4*randomInstance),v32.applyQuaternion(q),v33.fromArray(offset,3*randomInstance),v32.add(v33),v32.toArray(outputPosition,3*i)}if(outputNormal&&(outputNormal[3*i+0]=normal[3*j+0]*v3.x+normal[3*j+3]*v3.y+normal[3*j+6]*v3.z,outputNormal[3*i+1]=normal[3*j+1]*v3.x+normal[3*j+4]*v3.y+normal[3*j+7]*v3.z,outputNormal[3*i+2]=normal[3*j+2]*v3.x+normal[3*j+5]*v3.y+normal[3*j+8]*v3.z),outputUV&&(outputUV[3*i+0]=uv[2*j+0]*v3.x+uv[2*j+2]*v3.y+uv[2*j+4]*v3.z,outputUV[3*i+1]=uv[2*j+1]*v3.x+uv[2*j+3]*v3.y+uv[2*j+5]*v3.z),outputSkinIndex){let skinCluster1={};skinCluster1[skinIndex[4*j+0]]=skinWeight[4*j+0],skinCluster1[skinIndex[4*j+1]]=skinWeight[4*j+1],skinCluster1[skinIndex[4*j+2]]=skinWeight[4*j+2],skinCluster1[skinIndex[4*j+3]]=skinWeight[4*j+3];let skinCluster2={};skinCluster2[skinIndex[4*j+4]]=skinWeight[4*j+4],skinCluster2[skinIndex[4*j+5]]=skinWeight[4*j+5],skinCluster2[skinIndex[4*j+6]]=skinWeight[4*j+6],skinCluster2[skinIndex[4*j+7]]=skinWeight[4*j+7];let skinCluster3={};skinCluster3[skinIndex[4*j+8]]=skinWeight[4*j+8],skinCluster3[skinIndex[4*j+9]]=skinWeight[4*j+9],skinCluster3[skinIndex[4*j+10]]=skinWeight[4*j+10],skinCluster3[skinIndex[4*j+11]]=skinWeight[4*j+11];let indices=[];for(let k=0;k<12;k++){let index=skinIndex[4*j+k];-1===indices.indexOf(index)&&indices.push(index)}let clusters=[];for(let k=0;k<indices.length;k++){let index=indices[k];clusters.push([index,(skinCluster1[index]||0)*v3.x+(skinCluster2[index]||0)*v3.y+(skinCluster3[index]||0)*v3.z])}clusters.sort((function(a,b){return b[1]-a[1]}));for(let l=clusters.length-1;l<4;l++)clusters.push([0,0]);let sum=clusters[0][1]+clusters[1][1]+clusters[2][1]+clusters[3][1];outputSkinIndex[4*i+0]=clusters[0][0],outputSkinIndex[4*i+1]=clusters[1][0],outputSkinIndex[4*i+2]=clusters[2][0],outputSkinIndex[4*i+3]=clusters[3][0],outputSkinWeight[4*i+0]=clusters[0][1]*(1/sum),outputSkinWeight[4*i+1]=clusters[1][1]*(1/sum),outputSkinWeight[4*i+2]=clusters[2][1]*(1/sum),outputSkinWeight[4*i+3]=clusters[3][1]*(1/sum)}}let output={},buffer=[];output.position=outputPosition,buffer.push(outputPosition.buffer),outputNormal&&(output.normal=outputNormal,buffer.push(outputNormal.buffer)),outputUV&&(output.uv=outputUV,buffer.push(outputUV.buffer)),outputSkinIndex&&(output.skinIndex=outputSkinIndex,output.skinWeight=outputSkinWeight,buffer.push(outputSkinIndex.buffer),buffer.push(outputSkinWeight.buffer)),resolve(output,id,buffer)}function generatePointCloud({path:path,textureSize:textureSize},id){!async function(){try{let data=await get(path),totalParticles=textureSize*textureSize,positions=new Float32Array(3*totalParticles),colors=new Float32Array(3*totalParticles);for(let i=0;i<totalParticles;i++)positions[3*i+0]=data.data.attributes.positions.array[3*i+0],positions[3*i+1]=data.data.attributes.positions.array[3*i+1],positions[3*i+2]=data.data.attributes.positions.array[3*i+2],colors[3*i+0]=data.data.attributes.colors.array[3*i+0],colors[3*i+1]=data.data.attributes.colors.array[3*i+1],colors[3*i+2]=data.data.attributes.colors.array[3*i+2];data.positions=positions,data.colors=colors,resolve(data,id,[data.positions.buffer,data.colors.buffer])}catch(e){throw console.log(e),`Could not load Point Cloud for ${path}`}}()}function generatePointGrid({path:path,particleCount:particleCount},id){let split=path.split("generateGrid-")[1].split("-"),dir=split[0],scale=Number(split[1]),textureSize=(Number(split[2]),Number(split[split.length-1].split(".")[0])),totalParticles=particleCount,positions=new Float32Array(3*totalParticles),colors=new Float32Array(3*totalParticles);for(let i=0;i<totalParticles;i++){let p0=i/textureSize,y=Math.floor(p0),x=p0-y;y/=textureSize,x=Math.range(x,0,1,-scale/2,scale/2),y=Math.range(y,0,1,-scale/2,scale/2),"xz"==dir?(positions[3*i+0]=x,positions[3*i+1]=0,positions[3*i+2]=y):(positions[3*i+0]=x,positions[3*i+1]=y,positions[3*i+2]=0),colors[3*i+0]=1,colors[3*i+1]=1,colors[3*i+2]=1}resolve({colors:colors,positions:positions},id,[colors.buffer,positions.buffer])}this.generate=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array);return(await Thread.shared().distributeParticles({position:position,count:count},[position.buffer])).position},this.generateInstanced=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array),offset=new Float32Array(geom.attributes.offset.array),scale=new Float32Array(geom.attributes.scale.array),orientation=new Float32Array(geom.attributes.orientation.array);return(await Thread.shared().distributeParticles({position:position,offset:offset,scale:scale,orientation:orientation,count:count},[position.buffer,offset.buffer,scale.buffer,orientation.buffer])).position},this.generateAll=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array),normal=new Float32Array(geom.attributes.normal.array),uv=new Float32Array(geom.attributes.uv.array);return await Thread.shared().distributeParticles({position:position,normal:normal,uv:uv,count:count},[position.buffer,normal.buffer,uv.buffer])},this.generateSkinned=async function(geom,count){init();let position=new Float32Array(geom.attributes.position.array),normal=new Float32Array(geom.attributes.normal.array),uv=new Float32Array(geom.attributes.uv.array),skinIndex=new Float32Array(geom.attributes.skinIndex.array),skinWeight=new Float32Array(geom.attributes.skinWeight.array);return await Thread.shared().distributeParticles({position:position,normal:normal,uv:uv,skinIndex:skinIndex,skinWeight:skinWeight,count:count},[position.buffer,normal.buffer,uv.buffer,skinIndex.buffer,skinWeight.buffer])},this.generatePointCloud=async function(path,textureSize){path.includes("assets/geometry")||(path="assets/geometry/"+path),path.includes(".json")||path.includes(".bin")||(path+=".bin");let data,isBinary=path.includes(".bin");if(path=Assets.getPath(path),init(),isBinary)await GeomThread.loadDracoLib(),data=await Thread.shared().loadDraco({type:"decode",path:Thread.absolutePath(path)});else{let fn=path.includes("generateGrid")?Thread.shared().generatePointGrid:Thread.shared().generatePointCloud;data=await fn({path:Thread.absolutePath(path),textureSize:textureSize})}return{positions:new AntimatterAttribute(data.positions,3),colors:new AntimatterAttribute(data.colors,3)}}}),"static"),Class((function PBRShader(_vertexShader,_fragmentShader,_params){const _this=this;function defineSetter(prop){Object.defineProperty(_this,prop,{set:function(v){_this.shader[prop]=v},get:function(){return _this.shader[prop]}})}"object"==typeof _vertexShader&&(_params=_vertexShader,_vertexShader=_fragmentShader="PBR"),"string"!=typeof _fragmentShader&&(_params=_fragmentShader,_fragmentShader=_vertexShader),_vertexShader||(_vertexShader=_fragmentShader="PBR"),function initShader(){let lookup=Utils3D.getLookupTexture("~assets/images/pbr/lut.png");lookup.forcePersist=!0,_this.shader=new Shader(_vertexShader,_fragmentShader,Utils.mergeObject(_params||{},{tBaseColor:{value:null,getTexture:Utils3D.getRepeatTexture},tMRO:{value:null,getTexture:Utils3D.getRepeatTexture},tNormal:{value:null,getTexture:Utils3D.getRepeatTexture},tEnvDiffuse:{value:null,premultiplyAlpha:!1},tEnvSpecular:{value:null,premultiplyAlpha:!1},uEnvOffset:{value:new Vector2(0,0)},tLightmap:{value:null,premultiplyAlpha:!1},tLUT:{value:lookup,ignoreUIL:!0},uTint:{value:new Color("#FFFFFF")},uTiling:{value:new Vector2(1,1)},uOffset:{value:new Vector2(0,0)},uMRON:{value:new Vector4(1,1,1,1)},uEnv:{value:new Vector3(1,1,0)},uUseLightmap:{value:0},uHDR:{value:0,ignoreUIL:!0},uUseTonemapping:{value:1,ignoreUIL:!0},uUseLinearOutput:{value:0},uLightmapIntensity:{value:1},receiveLight:!0})),_this.shader.parent=_this,_this.lights=_this.shader.lights,_this.uniforms=_this.shader.uniforms,["side","blending","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","receiveShadow","vertexShader","fragmentShader","depthTest","depthWrite","wireframe","transparent","visible","persists","material","customShadowShader"].forEach(defineSetter)}()}),(_=>{const prototype=PBRShader.prototype;PBRShader.webgl1=function(){return World.RENDERER.type==Renderer.WEBGL1},prototype.set=function(key,value){return void 0!==value&&(this.shader.uniforms[key].value=value),this.shader.uniforms[key].value},prototype.get=function(key){return this.shader.uniforms[key].value},prototype.tween=function(key,value,time,ease,delay,callback,update){return tween(this.shader.uniforms[key],{value:value},time,ease,delay,callback,update)},prototype.setPBR=prototype.setOverride=function(key,value,ref=this){switch(ref.parent instanceof PBRShader&&(ref=ref.parent),ref.set(key,value),key){case"tEnvDiffuse":case"tEnvSpecular":case"tLUT":value.generateMipmaps=!1,value.minFilter=Texture.LINEAR}let src=value.src;src&&src.toLowerCase().includes("rgbm")&&(ref.shader.set("uHDR",1),ref.shader.set("uEnv",new Vector3(1,1,0)))},prototype.destroy=function(){this.shader.destroy()},prototype.copyUniformsTo=function(shader,linked,ignore){for(let key in this.uniforms)void 0!==this.uniforms[key]&&(ignore&&ignore.includes?.(key)||(shader.uniforms[key]=linked?this.uniforms[key]:{type:this.uniforms[key].type,value:this.uniforms[key].value}))},prototype.replicateUniformsTo=function(shader){shader.uniforms=this.uniforms,shader._uniformKeys=this._uniformKeys,shader._uniformValues=this._uniformValues},prototype.addUniforms=function(uniforms){uniforms.UILPrefix&&(this.UILPrefix=uniforms.UILPrefix,delete uniforms.UILPrefix);for(let key in uniforms)this.hotReloading&&this.uniforms[key]||(this.uniforms[key]=uniforms[key])}})),Class((function Performance(){Inherit(this,Component);const _this=this;var _overrides=Storage.get("performance_override")||{};const PLATFORM_ALLOWED_KEYS=["desktopVRAvailable","enableWorldNukeMSAA","msaaSamples","forceWebGL1","blurFX"],IGNORED_FUNCTIONS=(()=>{let obj={__afterInitClass:[]};return Inherit(obj,Component),"function"==typeof XComponent&&Inherit(obj,XComponent),obj.__afterInitClass.forEach((cb=>cb())),Object.values(obj).filter((val=>"function"==typeof val)).map((fn=>fn.toString()))})();function save(obj,key,value){_overrides[key]={obj:Utils.getConstructorName(obj),value:value},Storage.set("performance_override",_overrides)}function convert(tier){if(GPU.BLOCKLIST)return"F";switch(tier){case 5:return"A++";case 4:return"A+";case 3:return"A";case 2:return"B";case 1:return"C";case 0:return"D"}}!async function(){if(Utils.query("performance")&&Utils.query("edit")||Utils.query("custom")){await Hydra.ready();for(let key in _overrides){let obj,value,override=_overrides[key];override?.obj?({obj:obj,value:value}=override):(obj="Tests",value=override),window[obj]&&(window[obj][key]=_=>value)}}}(),this.displayResults=async function(){let editing=Utils.query("edit");await GPU.ready(),$(document.documentElement).bg("#000"),__body.bg("#000"),Stage.bg("#000"),Stage.hide();let $results=__body.create("PerformanceResults");__body.css({overflowY:"scroll",background:"#000"}),$results.fontStyle("Arial",16,"#fff").css({marginLeft:50,marginRight:50,"user-select":"auto"}),Mobile.allowNativeScroll(),HydraCSS.style(".PerformanceResults *",{position:"relative","user-select":"auto"});Tests.constructor.toString();let tests="",keys=[],addTest=(obj,key)=>{let result,val=obj[key];if("function"==typeof val&&!IGNORED_FUNCTIONS.includes(val.toString())){try{result=obj[key]()}catch(e){return}tests+=`<p><b>${key}:</b> `,tests+=editing?"number"==typeof result?`<input class="${key}" value="${result.toString()}" /></p>`:"boolean"==typeof result?`<input class="${key}" type="checkbox" ${result?"checked":""}/></p>`:`<input class="${key}" value="${result}" type="text"></p>`:result+"</p>",keys.push({obj:obj,key:key})}};for(let key in Tests)addTest(Tests,key);if(window.Platform)for(let key in Platform)(key.startsWith("use")||key.startsWith("using")||PLATFORM_ALLOWED_KEYS.includes(key))&&addTest(Platform,key);let compressionExtensions=["compressed_texture","texture_compression"],enabledExtensions=Device.graphics.webgl?.extensions||[],otherExtensions=enabledExtensions.filter((ext=>!compressionExtensions.find((n=>ext.includes(n))))).join(", "),dedupe={};compressionExtensions=enabledExtensions.map((ext=>compressionExtensions.map((name=>{let index=ext.indexOf(name);if(!(index<0))return index+=name.length,"_"===ext.charAt(index)&&(index+=1),ext.substring(index)})).find(Boolean))).filter((ext=>!(!ext||dedupe[ext])&&(dedupe[ext]=!0))).join(", ");let html=`<h1>Performance Results</h1>\n                    <button id="copy">Copy to clipboard</button>\n                    <p><b>Time:</b> ${new Date}</p>\n                    <p><b>GPU:</b> ${Device.graphics.webgl?Device.graphics.webgl.gpu:"WEBGL UNAVAILABLE"}</p>\n                    <p><b>WebGL Version:</b> ${Device.graphics.webgl?Device.graphics.webgl.version:"WEBGL UNAVAILABLE"}</p>\n                    <p><b>GPU Tier:</b> ${Device.mobile?convert(GPU.M_TIER):convert(GPU.TIER)} [${Device.mobile?GPU.M_TIER:GPU.TIER}]</p>\n                    <p><b>Mobile:</b> ${Device.mobile?Object.keys(Device.mobile).filter((key=>Device.mobile[key])):"false"} </p>\n                    <p><b>User Agent:</b> ${Device.agent}</p>\n                    <p><b>OS:</b> ${Device.system.os}</p>${-1!==Device.system.version?`\n                    <p><b>OS Version:</b> ${Device.system.version}`:""}\n                    <p><b>DPR:</b> ${Device.pixelRatio}</p>\n                    <p><b>Screen Size:</b> ${screen.width} x ${screen.height}</p>\n                    <p><b>Stage Size:</b> ${Stage.width} x ${Stage.height}</p>\n                    <p><b>Browser:</b> ${Device.system.browser}</p>\n                    <p><b>Browser Version:</b> ${Device.system.browserVersion}</p>\n                    <p><b>Compressed textures:</b> ${compressionExtensions}</p>\n                    <p><b>WebGL extensions:</b> ${otherExtensions}</p>\n                    <p><b>Media Devices w/ Permissions Granted:</b>${await(navigator?.mediaDevices?.enumerateDevices?.().then((devices=>devices?.filter?.((device=>""!==device.label))?.map((device=>` ${device.label}`)))))}</p>\n                    \n                    <h2>Project-Specific Tests</h2>\n                    ${editing?'<button class="resetBtn">Reset All</button>':""}\n                    ${tests}\n        `;$results.html(html);let copy=$(document.getElementById("copy"));if(copy.bind("click",(_=>{let text=`${$results.div.innerText.split("\n").slice(2).join("\n").trim()}`;Utils.copyToClipboard(text),copy.text("Results copied!"),clearTimeout(_this.copyTimer),_this.copyTimer=_this.delayedCall((_=>{copy.text("Copy to clipboard")}),3e3)})),editing){await defer(),document.querySelector(".resetBtn").onclick=_=>{Storage.set("performance_override",null),location.reload()};for(let{obj:obj,key:key}of keys){let div=document.querySelector(`.${key}`);div&&(div.onchange=_=>{let value=div.value;value=isNaN(value)?div.checked:Number(value),save(obj,key,value)})}}}}),"static"),Class((function PhysicalLink(_id){const _this=this;var _events={},_globalEvents={},_globalLinks=[];this.initLink=function(id){_id=id,PhysicalSync.createInstanceLink(_this,id)},this.bindLink=function(obj,id){if(obj instanceof GLUIObject){let gluiObject=obj;obj=new Group,_this.startRender((_=>{let stage=_this.stage||Stage;_id?(gluiObject.x=obj.position.x*stage.width,gluiObject.y=obj.position.y*stage.height):(obj.position.x=gluiObject.x/stage.width,obj.position.y=gluiObject.y/stage.height)}))}_id?PhysicalSync.createRemoteLink(obj,_id,id):PhysicalSync.createLocalLink(obj,id)},this.bindEvent=function(name,callback){_events[name]=callback,PhysicalSync.createRemoteEvent(name,_id,callback)},this.bindGlobal=function(obj,id){PhysicalSync.createGlobalLink(obj,id),_globalLinks.push(id)},this.bindGlobalEvent=function(name,callback){PhysicalSync.createGlobalEvent(name,callback),_globalEvents[name]=callback},this.fireEvent=function(name,data={}){PhysicalSync.fireLocalEvent(name,data),_events[name]&&_events[name](data),_globalEvents[name]&&_globalEvents[name](data)},this.destroyLink=function(){PhysicalSync.deleteInstanceLink(_id),_globalLinks.forEach((id=>PhysicalSync.deleteGlobalLink(id)));for(let key in _globalEvents)PhysicalSync.deleteGlobalEvent(key)},defer((_=>{_this&&_this._bindOnDestroy&&_this._bindOnDestroy((_=>{_this.destroyLink()}))})),_id&&_this.initLink(_id)})),Class((function PhysicalSync(){Inherit(this,Component);const _this=this;var _room,_playerQueue,_visibilityTimer,_matrix=new Matrix4,_instances={},_instanceBackup={},_objects={},_global={},_globalEvents={},_eventMap={},_events=[],_transmit={},_globalTransmit={},_handledEvents={},_receivedGlobals=[],_evt={pS:"d",events:[]},_transmitTime=Render.TIME;this.CONNECTION="physical_sync_connection",this.DISCONNECTION="physical_sync_disconnection",this.ROOM_TIMEOUT="physical_sync_room_timeout",this.baseLerp=.15,this.transmitFPS=30,this.compensateLag=!0,this.throttle=!1;const ZERO_POS=new Vector3(0,0,0),ZERO_QUAT=new Quaternion(0,0,0,1);function startSync(){_room.host&&_room.broadcast({pS:"perform_sync",pos:World.CAMERA.position.toArray(),quaternion:World.CAMERA.quaternion.toArray()})}function optimize(obj){for(let i=0;i<3;i++)obj.p[i]=Number(obj.p[i].toFixed(3));if(obj.q)for(let i=0;i<4;i++)obj.q[i]=Number(obj.q[i].toFixed(3))}function shouldHandle(event){return!_handledEvents[event.id]&&(_handledEvents[event.id]=!0,_this.delayedCall((_=>{delete _handledEvents[event.id]}),1e3),!0)}function isZero(obj){return obj.position.equals(ZERO_POS)&&obj.quaternion.equals(ZERO_QUAT)}function transmit(){if(!(_this.throttle&&!_this.flag("blurred")&&Render.TIME-_transmitTime<1e3)&&_objects.local&&_room){_transmitTime=Render.TIME;for(let key in _objects.local){let obj=_objects.local[key];obj.preventSync||!obj.eD&&isZero(obj)?_transmit[key]&&delete _transmit[key]:(_transmit[key]||(_transmit[key]={p:[]},obj.noPSQuaternion||(_transmit[key].q=[])),obj.position.toArray(_transmit[key].p),obj.noPSQuaternion||obj.quaternion.toArray(_transmit[key].q),optimize(_transmit[key]),obj.eD&&(_transmit[key].eD=obj.eD))}for(let key in _global){let obj=_global[key];obj.broadcastSync||obj.forceBroadcastSync?(_globalTransmit[key]||(_globalTransmit[key]={p:[],q:[],f:obj.forceBroadcastSync}),obj.position.toArray(_globalTransmit[key].p),obj.quaternion.toArray(_globalTransmit[key].q),optimize(_globalTransmit[key])):_globalTransmit[key]&&delete _globalTransmit[key]}_evt.events.length=0;for(let i=0;i<_events.length;i++){let event=_events[i];Render.TIME-event.time<250?_evt.events.push(event.evt):_events.splice(i,1)}_evt.objects=_transmit,_evt.global=_globalTransmit,_room&&_room.broadcast&&(_evt.events.length||Object.keys(_evt.global).length||Object.keys(_evt.objects).length)&&_room.broadcast(_evt)}}function loop(){for(let player in _objects){if("local"==player)continue;let playerObj=_objects[player];for(let key in playerObj){let obj=playerObj[key],lerp=_this.baseLerp*obj.lerpMult;obj.positionTarget&&!obj.preventSync&&(obj.position.lerp(obj.positionTarget,lerp),obj.quaternion.slerp(obj.quaternionTarget,lerp))}}if(_receivedGlobals.length){for(let i=0;i<_receivedGlobals.length;i++){let key=_receivedGlobals[i],obj=_global[key];if(obj.positionTarget&&!obj.preventSync){let lerp=obj.forced?1:_this.baseLerp*obj.lerpMult;obj.position.lerp(obj.positionTarget,lerp),obj.quaternion.slerp(obj.quaternionTarget,lerp)}}_receivedGlobals.length=0}if(_playerQueue.length){for(let i=0;i<10;i++){let obj=_playerQueue.shift();obj&&_this.events.fire(_this.CONNECTION,obj)}}}function handleEvent({evtData:evtData,evtName:evtName,from:from}){let callbacks=_eventMap[from];if(callbacks){let callback=callbacks[evtName];callback&&callback(evtData)}let callback=_globalEvents[evtName];callback&&callback(evtData)}function playerJoin(e){if(_room.isCommunity?_playerQueue.push({id:e.player.id,userData:e.player.data,player:e.player}):_this.events.fire(_this.CONNECTION,{id:e.player.id,userData:e.player.data,player:e.player}),_room.host&&!_room.isCommunity){for(let key in _global)_global[key].forceBroadcastSync=e.player.id;_this.delayedCall((_=>{for(let key in _global)_global[key].forceBroadcastSync=!1}),500)}}function playerDisconnect(e){let obj=_instances[e.player.id]||_instanceBackup[e.player.id];obj&&(_this.events.fire(_this.DISCONNECTION,{id:e.player.id,userData:e.player.data}),obj.onDisconnect?obj.onDisconnect():obj.destroy&&obj.destroy()),delete _instances[e.player.id],delete _instanceBackup[e.player.id],delete _eventMap[e.player.id];for(let i=0;i<_playerQueue.length;i++)_playerQueue[i].player==e.player&&_playerQueue.splice(i,1)}function roomError(){_this.events.fire(_this.ROOM_TIMEOUT),_room&&_room.players&&_room.players.forEach((player=>{playerDisconnect({player:player})}))}function data({data:data,player:player}){if(data.pS)switch(data.pS){case"start_sync":startSync();break;case"perform_sync":!function performSync({pos:pos,quaternion:quaternion}){let remotePos=(new Vector3).fromArray(pos),cameraQuat=World.CAMERA.quaternion,cameraPos=World.CAMERA.position,localQuaternion=World.SCENE.quaternion,localScene=World.SCENE.position,orientedRemotePos=((new Quaternion).fromArray(quaternion),(new Vector3).copy(remotePos).applyQuaternion(cameraQuat)),localOrigin=(new Vector3).copy(cameraPos),remoteOrigin=(new Vector3).copy(orientedRemotePos).multiplyScalar(-1);localScene.copy(localOrigin).add(remoteOrigin),localQuaternion.copy(cameraQuat)}(data);break;case"d":!function transmitData({objects:objects,from:from,global:global,events:events},player){let lerpMultiplier=_this.compensateLag?Math.range(player.ping,50,200,1,.25,!0):1;for(let key in global){let obj=_global[key];obj&&(obj.lerpMult=lerpMultiplier,obj.positionTarget||(obj.positionTarget=new Vector3,obj.quaternionTarget=new Quaternion),global[key].p&&(_receivedGlobals.push(key),global[key].f==GameCenter.GCID&&(obj.physics&&(void 0===obj.physics.stashKinematic&&(obj.physics.stashKinematic=obj.physics.kinematic,obj.physics.kinematic=!0),clearTimeout(obj.physics.timer),obj.physics.timer=_this.delayedCall((_=>{obj.physics.kinematic=obj.physics.stashKinematic}),100)),obj.forced=!0),obj.positionTarget.fromArray(global[key].p),global[key].q&&obj.quaternionTarget.fromArray(global[key].q)))}if(_objects[from])for(let key in objects){let obj=_objects[from][key];obj&&(obj.lerpMult=lerpMultiplier,obj.positionTarget||(obj.positionTarget=new Vector3,obj.quaternionTarget=new Quaternion),objects[key].p&&(obj.positionTarget.fromArray(objects[key].p),objects[key].q&&obj.quaternionTarget.fromArray(objects[key].q)),objects[key].eD&&(obj.eD=objects[key].eD))}if(events)for(let i=events.length-1;i>-1;i--){let event=events[i];shouldHandle(event)&&(event.from=from,handleEvent(event))}}(data,player);break;case"event":handleEvent(data)}}function handleVisibility(e){"blur"==e.type?(_this.flag("blurred",!0),_visibilityTimer=setInterval(transmit,250)):(_this.flag("blurred",!1),clearInterval(_visibilityTimer))}_this.events.sub(GameCenter.LOST_CONNECTION,(_=>_this.useRoom(null))),_this.events.sub(Events.VISIBILITY,handleVisibility),this.connect=async function(server){GameCenter.ports=this.ports||1,GameCenter.userData=this.userData||{},GameCenter.connect(server);try{_room=await GameCenter.findRoom(),_this.events.sub(_room,GameCenterRoom.PLAYER_JOIN,playerJoin),_this.events.sub(_room,GameCenterRoom.PLAYER_DISCONNECT,playerDisconnect),_this.events.sub(_room,GameCenter.DATA,data)}catch(e){console.error(e)}_room.players.forEach((player=>{player.me||_this.events.fire(_this.CONNECTION,{id:player.id,userData:player.data,player:player})}))},this.useRoom=function(room){if(null==room&&_room&&_room.players&&_room.players.forEach((player=>{player.me||playerDisconnect({player:player})})),_room=room,_playerQueue=[],_this.startRender(loop),_room){try{_this.events.sub(_room,GameCenterRoom.PLAYER_JOIN,playerJoin),_this.events.sub(_room,GameCenterRoom.PLAYER_DISCONNECT,playerDisconnect),_this.events.sub(_room,GameCenterRoom.ERROR,roomError),_this.events.sub(_room,GameCenter.DATA,data)}catch(e){console.error(e)}_room.players.forEach((player=>{player.me||(_room.isCommunity?_playerQueue.push({id:player.id,userData:player.data,player:player}):_this.events.fire(_this.CONNECTION,{id:player.id,userData:player.data,player:player}))}))}},this.sync=function(){_room.host?startSync():_room.broadcast({pS:"start_sync"})},this.createInstanceLink=function(obj,id){_instances[id]=obj,_instanceBackup[id]=obj},this.deleteInstanceLink=function(id){id&&(delete _instances[id],delete _objects[id],delete _eventMap[id])},this.createLocalLink=function(obj,id){_objects.local||(_objects.local={}),_objects.local[id]=obj,_this.startRender(transmit,_this.transmitFPS)},this.deleteLocalLink=function(id){delete _objects.local[id]},this.createRemoteEvent=function(name,id,callback){_eventMap[id]||(_eventMap[id]={}),_eventMap[id][name]=callback},this.createGlobalEvent=function(id,callback){_globalEvents[id]=callback},this.deleteGlobalEvent=function(id){delete _globalEvents[id]},this.fireLocalEvent=function(name,data={}){_events.push({evt:{evtData:data,evtName:name,id:Utils.uuid()},time:Render.TIME})},this.createGlobalLink=function(obj,id){_global[id]=obj},this.deleteGlobalLink=function(id){delete _global[id]},this.createRemoteLink=function(obj,playerId,id){_objects[playerId]||(_objects[playerId]={}),_objects[playerId][id]=obj,_this.startRender(loop)},this.alignLocally=function(yOffset=0){World.SCENE.quaternion.copy(World.CAMERA.quaternion),World.SCENE.rotation.z=0,World.SCENE.rotation.x=0,World.SCENE.position.copy(World.CAMERA.position),World.SCENE.position.y+=yOffset,World.SCENE.updateMatrixWorld(!0),_matrix.getInverse(World.SCENE.matrix),_this.flag("aligned",!0)},this.realignObject=function(obj){_this.flag("aligned")&&obj.applyMatrix(_matrix)}}),"static"),Class((function Proton(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_size,_antimatter,_behaviorInput,_batches;const prefix=this.prefix=`P_${_input.prefix}`;async function initConfig(){(_config=_this.uilConfig=InputUIL.create(prefix+"_config",_group)).setLabel("Config"),_config.addButton("load-values",{label:"Values",actions:[{title:"Load",callback:loadValues},{title:"Save",callback:saveValues}]}).addButton("save",{label:"Configuration",actions:[{title:"Load",callback:loadConfig},{title:"Save",callback:saveConfig}]}).addButton("load-shader",{label:"Shader",actions:[{title:"Load",callback:()=>loadShader()}]}).addButton("load-behavior",{label:"Behavior",actions:[{title:"Load",callback:()=>loadBehavior()}]});_config.addSelect("type",[{label:"Permanent",value:"permanent"},{label:"Lifecycle",value:"lifecycle"}]),window.ProtonCulling&&_config.addToggle("FrustumCulling",!1),_config.addToggle("staticParticles",!1),_this.preventUpdate=_config.get("staticParticles"),_config.addFile("initialPositions",{relative:"assets/geometry"}),window.ProtonPhysics&&_config.addToggle("enablePhysics",!1),_config.add("particleCount",1e3),window.ProtonVolumeShadows&&_config.addToggle("volumeShadows",!1);let output=[{label:"Particles",value:"particles"},{label:"Custom",value:"custom"}];window.ProtonTubes&&output.push({label:"Tubes",value:"tubes"}),window.ProtonMarchingCubes&&output.push({label:"IsoSurface",value:"isosurface"}),_config.addSelect("output",output),_config.add("shader"),_config.get("shader")&&_config.addTextarea("uniforms"),_config.add("class");_config.get("type");try{if(!1===_input.get("visible"))throw"Layer set to invisible";if(_this.particleCount=_size=getSize(),0==_size||isNaN(_size))throw"Size is falsy or 0";initAntimatter()}catch(e){Hydra.LOCAL&&console.warn("Proton skipped",e),_this.disabled=!0}}function loadValues(){const name=prompt("Name of values to be loaded");if(null===name)return;let data=UILStorage.get(`proton_values_${name}`);data||alert(`No values ${name} found`),data=JSON.parse(data);let apply=(shader,obj)=>{for(let key in obj)UILStorage.set(shader.UILPrefix+key,obj[key])};apply(_this.behavior,data.behavior),apply(_this.shader,data.shader),_this.customClass&&_this.customClass.saveValues&&apply(_this.customClass.saveValues(),data.custom),alert("Values imported. Save and refresh.")}function saveValues(){const name=prompt("Name of values to be saved");if(null===name)return;let store=(shader,to)=>{for(let key in shader.uniforms){if(shader.uniforms[key].ignoreUIL)continue;let uilValue=UILStorage.get(shader.UILPrefix+key);void 0!==uilValue&&(to[key]=uilValue)}},output={behavior:{},shader:{}};store(_this.behavior,output.behavior),store(_this.shader,output.shader),_this.customClass&&_this.customClass.saveValues&&(output.custom={},store(_this.customClass.saveValues(),output.custom)),UILStorage.setWrite(`proton_values_${name}`,JSON.stringify(output))}function loadConfig(){const name=prompt("Name of configuration to be loaded");if(null===name)return;let toLoad=UILStorage.get(`proton_config_${name}`);loadBehavior(toLoad),loadShader(toLoad),alert("Loaded. Save and refresh")}function saveConfig(){let name=prompt("Name of configuration to be saved");null!==name&&UILStorage.setWrite(`proton_config_${name}`,prefix)}function loadShader(toLoad){let shouldNotify=!toLoad;if(!toLoad){const name=prompt("Name of shader to be loaded");if(null===name)return;toLoad=UILStorage.get(`proton_config_${name}`)}let copyConfig=InputUIL.create(toLoad+"_config",null);_config.copyFrom(copyConfig,["shader","uniforms"]),(_config.get("uniforms")||"").split("\n").forEach((line=>{if(!line.includes(":"))return;let name=(line=line.replace(/ /g,"")).split(":")[0],shaderName=copyConfig.get("shader"),store=`${shaderName}/${shaderName}/${prefix}/`,lookup=`${shaderName}/${shaderName}/${toLoad}/`,val=UILStorage.get(lookup+name);val?UILStorage.set(store+name,val):(val=UILStorage.get(lookup+"_tx_"+name),val&&UILStorage.set(store+"_tx_"+name,val))})),shouldNotify&&alert("Loaded. Save and refresh")}function loadBehavior(toLoad){let shouldNotify=!toLoad;if(!toLoad){const name=prompt("Name of behavior to be loaded");if(null===name)return;toLoad=UILStorage.get(`proton_config_${name}`)}let copyConfig=InputUIL.create(toLoad+"_config",null);_config.copyFrom(copyConfig,["type","particleCount","output","class"]);let copyBehavior=InputUIL.create(toLoad+"_behavior",null);InputUIL.create(prefix+"_behavior",null).copyFrom(copyBehavior,["uniforms","data","codeCount"]);let data=copyBehavior.get("data")||[],buniformString=copyBehavior.get("uniforms")+"\n";ListUIL.create(prefix+"_code",null).internalAddItems(data.length),data.forEach((postfix=>{let toCode=InputUIL.create(prefix+postfix,null),fromCode=InputUIL.create(toLoad+postfix,null);toCode.copyFrom(fromCode,["name","code","uniforms","preset"]),buniformString+=fromCode.get("uniforms")+"\n"})),buniformString.split("\n").forEach((line=>{if(!line.includes(":"))return;let name=(line=line.replace(/ /g,"")).split(":")[0],lookup="am_ProtonAntimatter_"+toLoad,store="am_ProtonAntimatter_"+prefix,val=UILStorage.get(lookup+name);val&&UILStorage.set(store+name,val)}));let className=copyConfig.get("class");className&&(_this.customClass=_this.parent.initClass(window[className],_this,_group,_input),_this.customClass.loadConfig&&_this.customClass.loadConfig(toLoad,prefix)),shouldNotify&&alert("Loaded. Save and refresh")}function getSize(){if(_this.parent.data&&_this.parent.data.particleCount)return"string"==typeof _this.parent.data.particleCount?eval(_this.parent.data.particleCount):_this.parent.data.particleCount;let size=_config.getNumber("particleCount");if(isNaN(size)||0===size)try{size=eval(_config.get("particleCount"))}catch(e){throw"Proton particleCount is not a number or valid test function"}if(isNaN(size))throw"Proton particleCount is falsy!";return _this.particleCount=size,size}async function initCustomClass(){_this.shader.addUniforms({DPR:{value:World.DPR,ignoreUIL:!0}});let className=_config.get("class");className&&(_this.customClass=_this.parent.initClass(window[className],_this,_group,_input))}function parseUniforms(text,predefined){if(!text)return{};let split=text.split("\n"),output={};return split.forEach((line=>{if(!(line=line.replace(/ /g,"")).length||!line.includes(":"))return;let split=line.split(":"),name=split[0],val=split[1];if(val.includes("[")){let array=JSON.parse(val);switch(array.length){case 2:output[name]={value:(new Vector2).fromArray(array)};break;case 3:output[name]={value:(new Vector3).fromArray(array)};break;case 4:output[name]={value:(new Vector4).fromArray(array)};break;default:throw`Unknown uniform type ${line}`}}else"C"==val.charAt(0)?predefined[name]=val.slice(1):"T"===val?output[name]={value:null}:"T3D"===val?output[name]={value:null,isTexture3D:!0}:"OEST"===val?output[name]={value:null,oes:!0}:val.includes(["0x","#"])?output[name]={value:new Color(val)}:output[name]={value:Number(val)}})),output}function getUniformGLSLType(obj){return"number"==typeof obj.value?"float":obj.oes?"samplerExternalOES":null===obj.value?obj.isTexture3D?"sampler3D":"sampler2D":obj.value instanceof Texture?obj.value.isTexture3D?"sampler3D":"sampler2D":obj.value instanceof Vector2?"vec2":obj.value instanceof Vector3||obj.value instanceof Vector3D?"vec3":obj.value instanceof Vector4?"vec4":obj.value instanceof Color?"vec3":void 0}async function initBehavior(behavior){let glsl=[],predefinedUniforms={HZ:"float"},input;_behaviorInput?input=_behaviorInput:(input=InputUIL.create(prefix+"_behavior",_group),input.setLabel("Behavior Uniforms"),input.addTextarea("uniforms"),input.add("data","hidden"),input.add("codeCount","hidden"),_behaviorInput=input);let map={},list=[],count=input.getNumber("codeCount")||0,data=input.get("data")||[],panel=ListUIL.create(prefix+"_code",_group);panel.setLabel("Behavior Code"),panel.onAdd(((name,input,index)=>{list[index]||addCode(),input.group.add(list[index].group),list[index].mapId=name,map[name]=list[index],input.setLabel(map[name].get("name")||"Code")})),panel.onRemove((name=>{let postfix=map[name].postfix;list.remove(map[name]),data.remove(postfix),input.setValue("data",JSON.stringify(data))})),panel.onSort((array=>{let arr=[];array.forEach((name=>{arr.push(map[name].postfix)})),data=arr,input.setValue("data",JSON.stringify(data))}));let uniforms=parseUniforms(input.get("uniforms")),createCode=postfix=>{let input=InputUIL.create(prefix+postfix,_group,!0);if(input.prefix=prefix+postfix,input.postfix=postfix,input.setLabel("Editor"),input.add("name","hidden"),Proton.ignorePresets&&Proton.ignorePresets.includes(input.get("name")))return;ProtonPresets.bind(input),input.customPresetCallback&&input.customPresetCallback(_this);let code=input.get("code")||"";if(!input.disabled&&code.length){for(uniforms=Utils.mergeObject(uniforms,parseUniforms(input.get("uniforms"),predefinedUniforms));code.includes("#test ");)try{let test=code.split("#test ")[1],name=test.split("\n")[0],glsl=code.split("#test "+name+"\n")[1].split("#endtest")[0];eval(name)||(code=code.replace(glsl,"")),code=code.replace("#test "+name+"\n",""),code=code.replace("#endtest","")}catch(e){throw"Error parsing test :: "+e}glsl.push(code)}list.push(input)};data.forEach(createCode);let addCode=_=>{count++,data.push(`code_${count}`),input.setValue("data",JSON.stringify(data)),input.setValue("codeCount",count),createCode(`code_${count}`)};behavior instanceof AntimatterPass&&(behavior.addInput("tOrigin",_antimatter.vertices),behavior.addInput("tAttribs",_antimatter.attribs),behavior.addUniforms(uniforms));let filledRequire=[],insertUniform=(code,line)=>code.split("//uniforms").join(line+"\n//uniforms"),insertCode=(code,line)=>code.split("//code").join(line+"\n//code"),insertRequire=(code,line)=>{let name=line.split("require(")[1].split(")")[0];return filledRequire.includes(name)?code:(filledRequire.push(name),code.split("//require").join(Shaders.getShader(name)+"\n//require"))},insertGLSL=(code,line)=>{if(line.includes("#require")){let split=line.split("\n");for(let l of split)code=l.includes("#require")?insertRequire(code,l):insertCode(code,l);return code}return insertCode(code,line)};behavior.onCreateShader=code=>{for(let name in uniforms)code=insertUniform(code,`uniform ${getUniformGLSLType(uniforms[name])} ${name};`);for(let name in predefinedUniforms)code=insertUniform(code,`uniform ${predefinedUniforms[name]} ${name};`);for(let str of glsl)code=insertGLSL(code,str);return _this.tubes&&(code=_this.tubes.overrideShader(code)),Renderer.type==Renderer.WEBGL2&&(code=code.replace(/gl_FragColor/g,"FragColor")),code.includes("samplerExternalOES")&&window.AURA&&"android"==Device.system.os&&(code="#version 300 es\n#extension GL_OES_EGL_image_external_essl3 : require\n"+code.replace("#version 300 es","")),code},behavior.uniforms.uMaxCount={value:_this.particleCount,ignoreUIL:!0},ShaderUIL.add(behavior,_group).setLabel("Behavior Shader"),behavior.uniforms.HZ={value:1},_config.get("FrustumCulling")&&_batches.setupPositionTexture(behavior.output.texture),_this.startRender((_=>{behavior.uniforms.HZ.value=Render.HZ_MULTIPLIER}),10),ProtonPresets.onCodeEdit=rebuildShader}async function rebuildShader(){let lifecycle="lifecycle"==_config.get("type"),behavior=_this.initClass(AntimatterPass,"ProtonAntimatter"+(lifecycle?"Lifecycle":""),{unique:prefix,customCompile:prefix+Utils.uuid()});await initBehavior(behavior),behavior.initialize(64),behavior.upload(),_this.behavior.shader._gl&&(_this.behavior.shader._gl=behavior.shader._gl),_this.behavior.shader._metal&&(_this.behavior.shader._metal=behavior.shader._metal),_this.behavior.shader._gpu&&(_this.behavior.shader._gpu=behavior.shader._gpu)}function completeShader(shader){let transparent=_input.get("transparent"),depthWrite=_input.get("depthWrite"),depthTest=_input.get("depthTest"),blending=_input.get("blending"),castShadow=_input.get("castShadow"),receiveShadow=_input.get("receiveShadow");"boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&(shader.depthTest=depthTest),"boolean"==typeof transparent&&(shader.transparent=transparent),"boolean"==typeof castShadow&&(_this.mesh.castShadow=castShadow),"boolean"==typeof receiveShadow&&(shader.receiveShadow=receiveShadow),blending&&(shader.blending=blending),shader.uniforms.tRandom={value:_antimatter.attribs}}function update(){_this.preventUpdate||_antimatter.update()}async function initInitialPositions(){let file=_config.getFilePath("initialPositions");if(!file)return;let isBinary=file.includes(".bin");file.includes("assets/geometry")||(file=`assets/geometry/${file}`),isBinary||file.includes(".json")||(file+=".json");let url=Thread.absolutePath(Assets.getPath(file)),pointData={};if(isBinary){await GeomThread.loadDracoLib();let data=await Thread.shared().loadDraco({type:"decode",path:url});data._type?(pointData.positions=data.offset,pointData.random=data.random):(pointData.positions=data.offset.buffer,pointData.random=data.random.buffer)}else{pointData=await Thread.shared().parseInstancePositions({url:url})}return pointData.positions&&(_this.particleCount=_size=pointData.positions.length/3),pointData}async function initAntimatter(){let lifecycle="lifecycle"==_config.get("type");_config.get("enablePhysics")?(_config.addVector("width",[0,128]),_config.addVector("height",[0,128]),_config.addVector("depth",[0,128])):(_config.addVector("width",[-1,1]),_config.addVector("height",[-1,1]),_config.addVector("depth",[-1,1]));let dimensions={w:_config.get("width")||[-1,1],h:_config.get("height")||[-1,1],d:_config.get("depth")||[-1,1],pot:"tubes"===_config.get("output")||!0===_config.get("volumeShadows")||"isosurface"===_config.get("output")},pointData=null;if(_config.get("FrustumCulling")){let file=_config.getFilePath("initialPositions");if(file=Assets.getPath(file),!file)return;_batches=_this.initClass(ProtonCulling,_input,_group,file),await _batches.ready,pointData={},pointData.positions=new Float32Array(_batches.pointData),_this.particleCount=_size=_batches.pointData.length/3}else pointData=await initInitialPositions();_antimatter=_this.initClass(Antimatter,_size,dimensions,World.RENDERER,pointData),Proton.forceCloneVertices.includes(_config.get("class"))&&(_antimatter.cloneVertices=!0),_this.antimatter=_antimatter,await _antimatter.ready();let output=_config.get("output");"tubes"==output&&(_this.tubes=_this.initClass(ProtonTubes,_this)),"isosurface"==output&&(_this.surface=_this.initClass(ProtonMarchingCubes,_this));let overrideShader,wildcard=_input.get("wildcard");if(wildcard&&wildcard.includes(".behavior")){let layer=await _this.parent.getLayer(wildcard.split(".")[0]);await _this.wait(layer,"behavior"),_this.behavior=layer.behavior}else{let behavior=_this.initClass(AntimatterPass,"ProtonAntimatter"+(lifecycle?"Lifecycle":""),{unique:prefix,customCompile:prefix});_this.behavior=behavior,initBehavior(behavior)}let shaderName=_config.get("shader");if(shaderName)if(shaderName.includes(".shader")){let layer=await _this.parent.getLayer(shaderName.split(".")[0]);await _this.wait(layer,"shader"),overrideShader=layer.shader}else{let uniforms=parseUniforms(_config.get("uniforms"));uniforms.unique=prefix+(_this.onGenerateUniqueShader?_this.onGenerateUniqueShader():""),_antimatter.useShader(shaderName,uniforms)}_antimatter.addPass(_this.behavior),_this.mesh=_antimatter.getMesh(),_this.onCreateMesh&&_this.onCreateMesh(_this.mesh),output&&"particles"!=output||_this.delayedCall((_=>{_config.get("FrustumCulling")||_this.add(_antimatter.mesh)}),480),Utils.query("uilOnly")||_this.startRender(update,RenderManager.AFTER_LOOPS),shaderName&&!shaderName.includes(".shader")&&(ShaderUIL.add(_antimatter.shader,_group).setLabel("Shader"),completeShader(_antimatter.shader)),overrideShader&&_antimatter.overrideShader(overrideShader),_this.shader=_antimatter.shader,_this.initialized=!0,lifecycle&&(_this.spawn=_this.initClass(AntimatterSpawn,_this,_group,_input)),initCustomClass(),_config.get("volumeShadows")&&_this.initClass(ProtonVolumeShadows,_this,_group,_input),_config.get("enablePhysics")&&_this.initClass(ProtonPhysics,_this,_group,_input)}async function upload(sync=!0){if(_this.disabled)return;await _this.ready();let output=_config.get("output"),uploadFuncName=sync?"uploadSync":"upload";await _antimatter[uploadFuncName](!output||"particles"===output),_this.spawn&&await _this.spawn.upload(),_this.tubes&&await _this.tubes[uploadFuncName]()}this.uilInput=_input,this.uilGroup=_group,this.prefix=prefix,this.preventUpdate=!1,initConfig(),this.parseUniforms=parseUniforms,this.ready=function(){return this.wait(this,"initialized")},this.applyToInstancedGeometry=function(geometry){geometry.addAttribute("lookup",new GeometryAttribute(_antimatter.getLookupArray(),3,1)),geometry.addAttribute("random",new GeometryAttribute(_antimatter.getRandomArray(),4,1)),geometry.maxInstancedCount=_size},this.applyToShader=function(shader){shader.addUniforms({tPos:_antimatter.getOutput(),tPrevPos:_antimatter.getPrevOutput()})},this.upload=function(){let visible,count=0;return async function(){0===count&&(visible=_this.group.visible,_this.group.visible=!1,count+=1),await upload(!1),count-=1,0===count&&(_this.group.visible=visible)}}(),this.uploadSync=async function(){await upload(!0)},this.stopUpdating=function(){_this.stopRender(update,RenderManager.AFTER_LOOPS)},this.update=update,this.set("renderOrder",(async v=>{await _this.ready(),await _antimatter.ready(),_antimatter.mesh.renderOrder=v})),this.get("renderOrder",(v=>_antimatter.mesh.renderOrder))}),(_=>{Proton.forceCloneVertices=[],Proton.ignore=function(name){Proton.ignorePresets||(Proton.ignorePresets=[]),Proton.ignorePresets.push(name)},Thread.upload((function parseInstancePositions({url:url},id){get(url).then((data=>{let result={},buffers=[];if(data?.positions)result.positions=new Float32Array(data.positions),buffers.push(result.positions.buffer);else if(data){let bufferName="buffer",attributes=data;data.data&&data.metadata?.type&&(bufferName="array",attributes=data.data.attributes),result.positions=new Float32Array(attributes.offset[bufferName]),buffers.push(result.positions.buffer)}if(data?.random)result.random=new Float32Array(data.random),buffers.push(result.random.buffer);else if(data){let bufferName="buffer",attributes=data;data.data&&data.metadata?.type&&(bufferName="array",attributes=data.data.attributes),attributes.random&&(result.random=new Float32Array(attributes.random[bufferName]),buffers.push(result.random.buffer))}resolve(result,id,buffers)}))}))})),Class((function ProtonPresets(){const _this=this,LIST=[{label:"Custom Code",value:"custom"},{label:"Curl Noise",value:"curl"},{label:"Sine Move",value:"sine"},{label:"Plane Shape",value:"planeshape"},{label:"3D Shape",value:"3dshape"},{label:"Point Cloud",value:"pointcloud"},{label:"Force",value:"force"},{label:"Follow",value:"follow"},{label:"Mouse Fluid",value:"fluid"}],CALLBACKS={custom:function customCode(input){input.setValue("name","Custom Code"),input.setLabel("Custom Code")},curl:function curlNoise(input){input.setValue("name","Curl Noise"),input.setLabel("Curl Noise");input.setValue("uniforms","\n        uCurlNoiseScale: 1\n        uCurlTimeScale: 0\n        uCurlNoiseSpeed: 0\n        "),setPresetCodeIfRequired(input,"#require(curl.glsl)\n\nvec3 curl = curlNoise(pos * uCurlNoiseScale*0.1 + (time * uCurlTimeScale * 0.1));\npos += curl * uCurlNoiseSpeed * 0.01 * HZ;","uCurlNoise")},sine:function sineMove(input){input.setValue("name","Sine Move"),input.setLabel("Sine Move");input.setValue("uniforms","\n        uSinSpeed: 1\n        uSinMovement: 0\n        "),setPresetCodeIfRequired(input,"pos = origin;\npos.x += sin(time*uSinSpeed + radians(360.0 * random.x)) * 0.03 * random.z * uSinMovement * HZ;\npos.y += sin(time*uSinSpeed + radians(360.0 * random.y)) * 0.03 * random.w * uSinMovement * HZ;\npos.z += sin(time*uSinSpeed + radians(360.0 * random.w)) * 0.03 * random.x * uSinMovement * HZ;","uSinSpeed")},planeshape:function planeShape(input){input.setValue("name","Plane Shape"),input.setLabel("Plane Shape");input.setValue("uniforms","\n        uTakePlaneShape: 1\n        uPlaneScale: 1\n        tPlaneTexture: Csampler2D\n        "),setPresetCodeIfRequired(input,"vec2 planeLookup = texture2D(tPlaneTexture, uv).xy;\nvec3 plane;\nplane.x = uPlaneScale * 0.5 * range(planeLookup.x, 0.0, 1.0, -1.0, 1.0);\nplane.y = uPlaneScale * 0.5 * -range(planeLookup.y, 0.0, 1.0, -1.0, 1.0);\nif (uTakePlaneShape > 0.5) pos = plane;","uPlaneScale"),input.customPresetCallback=proton=>{proton.behavior.addUniforms({tPlaneTexture:{value:null}})}},"3dshape":function shape3D(input){input.setValue("name","3D Shape"),input.setLabel("3D Shape"),input.add("geometry");let geometry=input.get("geometry");input.setValue("uniforms","\n        tShape3D: Csampler2D\n        "),setPresetCodeIfRequired(input,"vec3 shape3d = texture2D(tShape3D, uv).xyz;","tShape3D"),input.customPresetCallback=proton=>{let create=async g=>{let geom=await GeomThread.loadGeometry(g),distribution=await ParticleDistributor.generate(geom,proton.antimatter.particleCount),attribute=new AntimatterAttribute(distribution,3);proton.behavior.addInput("tShape3D",attribute)};geometry&&create(geometry),proton.set3DShape=create}},pointcloud:function pointCloud(input){input.setValue("name","Point Cloud"),input.setLabel("Point Cloud"),input.add("file");let file=input.get("file");input.setValue("uniforms","\n        tPointCloud: Csampler2D\n        "),setPresetCodeIfRequired(input,"vec3 pointShape = texture2D(tPointCloud, uv).xyz;","tPointCloud"),input.customPresetCallback=proton=>{let create=async filePath=>{let data;"string"==typeof filePath?(filePath+="-"+proton.antimatter.powerOf2,_this.cachePointCloud=_this.cachePointCloud||{},_this.cachePointCloud[filePath]||(_this.cachePointCloud[filePath]=ParticleDistributor.generatePointCloud(filePath,proton.antimatter.textureSize)),data=await _this.cachePointCloud[filePath]):data=filePath,proton.behavior.shader.uniforms.tPointCloud&&(proton.behavior.shader.uniforms.tPointCloud.value.destroy(),proton.shader.uniforms.tPointColor.value.destroy()),proton.behavior.addInput("tPointCloud",data.positions),proton.shader.addUniforms({tPointColor:{value:data.colors}})};file||(file=proton.parent.data?proton.parent.data.pointCloudFile:void 0),file&&create(file),proton.setPointCloud=create}},force:function force(input){input.setValue("name","Force"),input.setLabel("Force");input.setValue("uniforms","\n        uForceDir: [0, 1, 0]\n        uForceScale: 1\n        "),setPresetCodeIfRequired(input,"vec3 force = normalize(uForceDir) * uForceScale * 0.1;\npos += force * HZ;","uForceDir")},follow:function follow(input){input.setValue("name","Follow"),input.setLabel("Follow");input.setValue("uniforms","\n        uFollowPos: [0, 0, 0]\n        uFollowRadius: 2\n        uFollowLerp: 0.7\n        "),setPresetCodeIfRequired(input,"float speed = range(random.x, 0.0, 1.0, 0.5, 1.5);\nvec3 followPos = uFollowPos;\nfollowPos.x += range(random.y, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\nfollowPos.y += range(random.z, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\nfollowPos.z += range(random.w, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\npos += (followPos - pos) * (uFollowLerp*0.1*speed*HZ);","followPos")},fluid:function fluid(input){input.setValue("name","Mouse Fluid"),input.setLabel("Mouse Fluid");input.setValue("uniforms","\n        uProjMatrix: Cmat4\n        uProjNormalMatrix: Cmat4\n        uModelMatrix: Cmat4\n        tFluidMask: Csampler2D\n        tFluid: Csampler2D\n        uMouseStrength: 1\n        "),setPresetCodeIfRequired(input,"#require(glscreenprojection.glsl)\n\nvec3 mpos = vec3(uModelMatrix * vec4(pos, 1.0));\nvec2 screenUV = getProjection(mpos, uProjMatrix);\nvec3 flow = vec3(texture2D(tFluid, screenUV).xy, 0.0);\napplyNormal(flow, uProjNormalMatrix);\npos += flow * 0.0001 * HZ * uMouseStrength * texture2D(tFluidMask, screenUV).r;","glscreenprojection");let findCamera=proton=>{let camera=World.CAMERA,p=proton.group._parent;for(;p;)p instanceof Scene&&p.nuke&&(camera=p.nuke.camera),p=p._parent;return camera};input.customPresetCallback=async proton=>{if(!("MouseFluid"in window))return void alert("'mousefluid' module not found. To use Mouse Fluid preset, import module, load the MouseFluid class, and add a layer named 'fluid' with customCLass FluidLayer.");let camera=findCamera(proton),projection=proton.initClass(GLScreenProjection,camera);projection.start(),proton.projection=projection,Render.start((function camLoop(){if(!proton.group)return void Render.stop(camLoop);let newCamera=findCamera(proton);newCamera!=camera&&(camera=newCamera,projection.camera=camera)}),10),proton.wait("behavior").then((_=>{proton.behavior.addUniforms({uProjMatrix:projection.uniforms.projMatrix,uModelMatrix:projection.uniforms.modelMatrix,uProjNormalMatrix:projection.uniforms.normalMatrix}),MouseFluid.instance().applyTo(proton.behavior)}))}}};function setPresetCodeIfRequired(input,presetCode,keyShaderComponentString){const editorCode=input.get("code");editorCode&&editorCode.includes(keyShaderComponentString)||input.setValue("code",presetCode)}this.register=function(name,callback){let key=name.replace(/ /g,"").toLowerCase();LIST.push({label:name,value:key}),CALLBACKS[key]=callback},this.bind=function(input){input.add("code","hidden");input.add("uniforms","hidden"),input.addSelect("preset",LIST);let callback=CALLBACKS[input.get("preset")];callback&&callback(input),input.addButton("btn",{actions:[{title:"Edit Code",callback:_=>{let editor=new UILExternalEditor(input.get("name")||"Code",300);editor.setCode(input.get("code"),"c"),editor.onSave=value=>{input.setValue("code",value),_this.onCodeEdit?.()},UIL.add(editor)}}],hideLabel:!0})}}),"static"),Class((function ProtonTubes(_proton){Inherit(this,Object3D);const _this=this;var _config,_segments,_textureSize,_count,_shader,_geom;this.padding=1e3,async function(){!function initConfig(){(_config=InputUIL.create("tubes_"+_proton.prefix,_proton.uilGroup)).setLabel("Tubes"),_config.add("segments",5),_config.add("sides",4),_config.add("lerp",.2),_config.add("resetDelta",10),_config.onUpdate=key=>{"lerp"==key&&_proton.behavior.setUniform("uLerp",_config.getNumber("lerp")),"resetDelta"==key&&_proton.behavior.setUniform("uResetDelta",_config.getNumber("resetDelta"))}}(),await async function initBuffers(){let segments=_this.parent.parent.data&&_this.parent.parent.data.tubeSegments?_this.parent.parent.data.tubeSegments:_config.getNumber("segments");_this.padding=2*_segments;let indexBuffer=await _proton.antimatter.createFloatArrayAsync(4,!0),count=indexBuffer.length/4;for(let i=0;i<count;i++)indexBuffer[4*i+0]=i%segments,indexBuffer[4*i+1]=Math.floor(i/segments),indexBuffer[4*i+2]=i%segments==0?1:0,indexBuffer[4*i+3]=1;_textureSize=_proton.antimatter.textureSize,_segments=segments,_count=count/segments;let indices=_this.initClass(AntimatterAttribute,indexBuffer,4);_proton.behavior.addInput("tIndices",indices),_proton.behavior.addUniforms({uLerp:{value:_config.getNumber("lerp"),ignoreUIL:!0},uResetDelta:{value:_config.getNumber("resetDelta"),ignoreUIL:!0},textureSize:{value:_textureSize,ignoreUIL:!0},lineSegments:{value:segments,ignoreUIL:!0}})}(),await _this.wait(_proton.spawn,"lifeOutput"),function initGeometry(){let shape=require("GenerateTube")(_config.getNumber("sides"),_segments-1,!1),geom=new Geometry;geom.addAttribute("cNumber",new GeometryAttribute(new Float32Array(_count),1,1));for(let key in shape.attributes)geom.addAttribute(key,shape.attributes[key]);for(let i=0;i<_count;i++)geom.attributes.cNumber.array[i]=i;_geom=geom}(),function initShader(){let shaderName=_proton.uilConfig.get("shader")||"",modifyShader=!0;const attr={noAttributes:!0,unique:shaderName,thickness:{type:"f",value:1},textureSize:{type:"f",value:_textureSize,ignoreUIL:!0},lineSegments:{type:"f",value:_segments,ignoreUIL:!0},radialSegments:{type:"f",value:_config.getNumber("sides"),ignoreUIL:!0},taper:{type:"f",value:0},tLife:{type:"t",value:_proton.spawn.lifeOutput,ignoreUIL:!0},tRandom:{type:"t",value:_proton.antimatter.random,ignoreUIL:!0}};shaderName.includes("ProtonCustom")?(_shader=_this.initClass(Shader,shaderName,attr),modifyShader=!1):_shader=_this.initClass(shaderName&&shaderName.includes("PBR")?PBRShader:Shader,"ProtonTube",shaderName||"ProtonTube",attr);if(_this.wait(_proton.shader.uniforms,"tLifeData").then((_=>{_shader.addUniforms({tLifeData:_proton.shader.uniforms.tLifeData,tRandom:_proton.shader.uniforms.tRandom})})),_shader.addUniforms(_proton.parseUniforms(_proton.uilConfig.get("uniforms"))),shaderName&&modifyShader){let vs=Shaders.getShader(shaderName+".vs");if(vs&&_shader.vertexShader){if(vs=vs.split("void main() {"),vs[0].includes("extrudeTube")){let extrude=vs[0].split("void extrudeTube() {")[1].split("}")[0];vs[0]=vs[0].replace("void extrudeTube() {"+extrude+"}",""),_shader.vertexShader=_shader.vertexShader.replace("//neutrinovs",extrude)}let params=vs[0].split("\n"),main=vs[1].slice(0,vs[1].lastIndexOf("}")),paramOutput=[];for(let line of params)_shader.vertexShader.includes(line)&&"}"!=line.trim()||paramOutput.push(line);_shader.vertexShader=_shader.vertexShader.replace("//neutrinoparams",paramOutput.join("\n")),_shader.vertexShader=_shader.vertexShader.replace("//neutrinovspost",main)}window[shaderName]&&_this.initClass(window[shaderName],_shader,_shader)}ShaderUIL.add(_shader,_proton.uilGroup).setLabel("Tube Shader"),_proton.applyToShader(_shader),_this.shader=_shader,function completeShader(shader){let transparent=_proton.uilInput.get("transparent"),depthWrite=_proton.uilInput.get("depthWrite"),depthTest=_proton.uilInput.get("depthTest"),blending=_proton.uilInput.get("blending"),castShadow=_proton.uilInput.get("castShadow"),receiveShadow=_proton.uilInput.get("receiveShadow");"boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite);"boolean"==typeof depthTest&&(shader.depthTest=depthTest);"boolean"==typeof transparent&&(shader.transparent=transparent);"boolean"==typeof castShadow&&defer((_=>_this.mesh.castShadow=castShadow));"boolean"==typeof receiveShadow&&(shader.receiveShadow=receiveShadow);blending&&(shader.blending=blending)}(_shader)}(),function initMesh(){let mesh=new Mesh(_geom,_shader);mesh.frustumCulled=!1,_this.add(mesh),_this.mesh=mesh,mesh.visible=!1}(),_this.canEmit=!0}(),this.overrideShader=function(code){let uniforms=Shaders.getShader("ProtonTubesUniforms.fs"),main=Shaders.getShader("ProtonTubesMain.fs"),movement=(code=code.replace("//uniforms",uniforms)).split("//abovespawn")[1].split("//code")[0];return main=main.replace("//main",movement),main=main.split("main() {")[1].slice(0,-1),code=code.replace(movement,main)},this.release=function(pos,count=1,radius=0,velocity,color){if(!_this.canEmit)return;let positions=[],velocities=velocity?[]:null,colors=color?[]:null;_proton.spawn.index>_proton.spawn.total-_this.padding&&(_proton.spawn.index=-1);for(let i=0;i<count;i++){let x=pos.x+Math.random(-1,1,4)*radius,y=pos.y+Math.random(-1,1,4)*radius,z=pos.z+Math.random(-1,1,4)*radius;for(let j=0;j<_segments;j++)positions.push(x,y,z),velocities&&velocities.push(velocity.x,velocity.y,velocity.z),colors&&colors.push(color.r,color.g,color.b)}_proton.spawn.emit(positions,velocities,colors)},this.useColor=async function(){await this.ready(),await _proton.spawn.useColor(),_proton.spawn.applyToShader(_shader)},this.ready=async function(){return await _proton.spawn.ready(),_this.wait("canEmit")},this.upload=async function(){await _this.wait("mesh"),await _this.mesh.geometry.uploadBuffersAsync()},this.uploadSync=async function(){await _this.wait("mesh"),await _this.mesh.upload()}})),Class((function RenderManager(){Inherit(this,Component);const _this=this;var _hasGLUI,_hasMetal,_firingEvt,_dpr=null,_stringSchedules=new Map,_objectSchedules=new WeakMap;function getSchedulesMap(evt){return"string"==typeof evt?_stringSchedules:_objectSchedules}function getSchedule(evt){return getSchedulesMap(evt).get(evt)}function fire(evt,data){let array=getSchedule(evt);if(array){let len=array.length;for(let i=0;i<len;i++){let cb=array[i];if(!array.markedForDeletion.has(cb)){_firingEvt=evt;try{data?cb(data):cb(Render.TIME,Render.DELTA)}catch(error){let errorEvt={callback:cb,error:error,preventStopRender:!1};Events.emitter._fireEvent(Render.RENDER_CALLBACK_ERROR,errorEvt),evt.preventStopRender||_this.unschedule(cb,evt)}}}_firingEvt=void 0,array.markedForDeletion.size&&(array.markedForDeletion.forEach(((_,cb)=>{array.remove(cb)})),array.markedForDeletion.clear())}}function startFrame(){fire(_this.FRAME_BEGIN)}function resizeHandler(){_this.renderer&&_this.renderer.setSize(Stage.width,Stage.height)}function getDPR(){return window.AURA?Device.pixelRatio:GPU.OVERSIZED?1:GPU.lt(0)?Math.min(1.3,Device.pixelRatio):GPU.lt(1)?Math.min(1.8,Device.pixelRatio):GPU.mobileLT(2)?Math.min(2,Device.pixelRatio):GPU.gt(4)?Math.max(1.5,Device.pixelRatio):Math.max(1.25,Device.pixelRatio)}function directRenderCallback(render){_hasGLUI&&_hasMetal&&GLUI.renderDirect(render)}this.NORMAL="normal",this.MAGIC_WINDOW="magic_window",this.VR=this.WEBVR="webvr",this.AR=this.WEBAR="webar",this.RENDER="RenderManager_render",this.BEFORE_RENDER="RenderManager_before_render",this.POST_RENDER=this.FRAME_END="RenderManager_post_render",this.EYE_RENDER="RenderManager_eye_render",this.BEFORE_OBJECT_EYE_RENDER="RenderManager_before_object_eye_render",this.FRAME_BEGIN="RenderManager_frame_begin",this.AFTER_LOOPS="RenderManager_after_loops",this.NATIVE_FRAMERATE="RenderManager_native_framerate",this.READY="render_gl_ready",this.initialized=Promise.create(),_this.events.sub(Events.RESIZE,resizeHandler),Render.startFrame=startFrame,Hydra.ready((_=>{_hasGLUI=!!window.GLUI,_hasMetal=!!window.Metal})),this.get("DPR",(v=>getDPR())),this.initialize=function(type,params={}){if(_this.camera&&_this.camera.destroy(),_this.renderer&&_this.renderer.destroy(),type!=_this.WEBVR&&type!=_this.WEBAR||(params.xrCompatible=!0,params.alpha=!1,window.Ares&&(params.alpha=!0),window.XRDeviceManager&&XRDeviceManager.antialias&&(params.antialias=!0)),!_this.gl){let camera=new PerspectiveCamera(45,Stage.width/Stage.height,.01,200);_this.gl=function(){"safari"==Device.system.browser&&Device.system.browserVersion<13&&delete params.powerPreference,Utils.query("compat")&&(params.forceWebGL1=!0);let renderer=new Renderer(params);return renderer.setSize(Stage.width,Stage.height),renderer.setPixelRatio(getDPR()),renderer}(),_this.scene=new Scene,_this.nuke=_this.initClass(Nuke,Stage,Object.assign({renderer:_this.gl,scene:_this.scene,camera:camera,dpr:World.DPR},params))}switch(_dpr=_dpr||World.DPR||1,type){case _this.WEBVR:_this.renderer=_this.initClass(VRRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(VRCamera);break;case _this.WEBAR:_this.renderer=_this.initClass(ARRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(ARCamera),window.Ares&&(document.body.appendChild(_this.gl.domElement),_this.gl.domElement.style.backgroundColor="transparent",document.body.style.backgroundColor="transparent");break;case _this.MAGIC_WINDOW:_this.renderer=_this.initClass(MagicWindowRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(VRCamera);break;case _this.NORMAL:_this.renderer=_this.initClass(RenderManagerRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(RenderManagerCamera)}_this.type=type,_this.nuke.camera=_this.camera.worldCamera,_this.initialized.resolve()},this.render=function(scene,camera,renderTarget,forceClear){fire(_this.AFTER_LOOPS),_this.type==_this.VR&&fire(World.NUKE),fire(_this.BEFORE_RENDER),_this.renderer.render(scene||_this.scene,_this.nuke.camera,renderTarget,forceClear,directRenderCallback),_this.events.fire(_this.POST_RENDER),fire(_this.POST_RENDER)},this.schedule=function(callback,slot){let schedules=getSchedulesMap(slot),array=schedules.get(slot);array||(array=[],array.markedForDeletion=new Map,schedules.set(slot,array)),array.indexOf(callback)>=0?array.markedForDeletion.delete(callback):array.push(callback)},this.scheduleOne=function(callback,slot){let result;"function"!=typeof callback&&(slot=callback,result=Promise.create(),callback=result.resolve);let array=getSchedule(slot);if(array){if(array.find((h=>h.scheduleOneCallback===callback)))return}let handler=function(){return _this.unschedule(handler,slot),callback.apply(this,arguments)};return handler.scheduleOneCallback=callback,_this.schedule(handler,slot),result},this.unschedule=function(callback,slot){const array=getSchedule(slot);if(!array)return;const index=array.indexOf(callback);index<0||(_firingEvt?array.markedForDeletion.set(callback,!0):array.splice(index,1))},this.setSize=function(width,height){_this.events.unsub(Events.RESIZE,resizeHandler),_this.renderer.setSize(width,height)},this.fire=fire}),"static"),Class((function RenderManagerCamera(){Inherit(this,Component);const _this=this;this.worldCamera=window.THREE?new THREE.PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3):new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),_this.events.sub(Events.RESIZE,(()=>{_this.worldCamera.aspect=Stage.width/Stage.height,_this.worldCamera.updateProjectionMatrix()}))})),Class((function RenderManagerRenderer(_renderer,_nuke){Inherit(this,Component);const _this=this;var _evt={};_nuke.onBeforeProcess=_=>{_evt.stage=Stage,_evt.camera=_nuke.camera,_this.events.fire(RenderManager.RENDER,_evt)},this.render=function(scene,camera,_1,_2,directRender){_nuke.camera=camera,_nuke?_nuke.render(directRender):_renderer.render(scene,camera,null,null,directRender)},this.setSize=function(width,height){_renderer.setSize(width,height)}})),Class((function Frag3D(_name){Inherit(this,Object3D);this.layout=this.initClass(SceneLayout,_name),this.uploadSync=function(){}})),Class((function FragFXScene(_name){Inherit(this,FXScene);const _this=this;this.layout=this.initClass(SceneLayout,_name),this.scene.add(this.layout.group),this.group=new Group,this._initFXScene=function(nuke,rtPool,options){for(let key in options)options[key]||delete options[key];if(RenderManager.type==RenderManager.WEBVR&&!options.vrMode)return _this.onFXSceneVisibility=bool=>{if(bool){_this.group.visible=!0;let recurse=obj=>{if(obj.classRef?.layers)for(let key in obj.classRef.layers){let layer=obj.classRef.layers[key];!0===layer.visible&&(layer.visible=!1,layer.visible=!0)}obj.children.forEach(recurse)};_this.group.children.forEach(recurse)}},void _this.vrWorldMode();options.screenQuad&&defer((_=>{let shader=_this.initClass(Shader,"ScreenQuad",{customCompile:Utils.uuid(),depthWrite:!1,tMap:{value:_this.rt}}),mesh=new Mesh(World.QUAD,shader);mesh.frustumCulled=!1,mesh.renderOrder=-1,_this.group.add(mesh)})),rtPool?_this.create(nuke,rtPool(),options):_this.create(nuke,options)},this.uploadSync=function(){return Initializer3D.uploadAll(_this.layout)}})),Class((function SceneLayout(_name,_options={}){Inherit(this,Object3D);const _this=this;var _dataStore,_data,_timeline,_breakpoint,_stateData,_gizmo;const ZERO=new Vector3;var _initializers=[],_promises=[],_breakpoints=[],_folders={},_groups={},_custom={},_meshes={},_exists={},_layers={},_uil=UIL.sidebar,_graph,_config,_groupIndex=0,_groupsSynced=Promise.create();function initialize(promise){_promises.push(promise)}function initGizmo(){_options.noGizmo||Utils.query("nogizmo")||RenderManager.type!=RenderManager.NORMAL||(_gizmo=_this.initClass(SceneLayoutGizmo))}function createFolder(name){let folder=new UILFolder(`sl_${_name}_${name}`,{label:name,closed:!0});return folder.hide(),_folders[`sl_${_name}_${name}`]=folder,folder}async function initConfig(){let input=InputUIL.create(`CONFIG_sl_${_name}`,_uil);input.add("Animation"),input.add("Layout"),input.add("Cinema Config"),_graph&&_graph.addSpecial("Config",`Config (${_name})`,"Config"),input.setLabel("Config");let animation=input.get("Animation"),layout=input.get("Layout");animation&&(await ready(),_groupsSynced.then((async()=>{if(animation=animation.replace(/^\//g,""),_this.animation=_this.initClass(HierarchyAnimation,animation,linkObjects),_timeline)_this.startRender((_=>{_this.animation.elapsed=_timeline.elapsed,_this.animation.update()}));else if(_uil){let range=new UILControlRange("Animation",{min:0,max:1,step:.001});range.onChange((val=>{_this.animation.elapsed=val,_this.animation.update()})),_uil.add(range)}await _this.animation.ready(),_this.animation.update()}))),layout&&(await ready(),_this.layout=_this.initClass(HierarchyLayout,layout,linkObjects),await _this.layout.ready()),_config=input,await defer(),_this.configured=!0}async function linkObjects(data){let array=[];for(let i=0;i<data.length;i++){let name=data[i].name,exists=_this.exists(name);exists||"null"==name.toLowerCase()||console.warn(`linkAnimation :: ${name} does not exist`);let group=new Group,mesh=exists?await _this.getLayer(name):null;mesh&&(_this.layout&&mesh instanceof Mesh?(mesh._parent.add(group),group.add(mesh)):group=mesh.group||mesh),group.name=name,array.push(group)}return array}async function initGraph(){if(_options.noGraph||!window.UILGraph||SceneLayout.noGraph)return _uil=null,void _groupsSynced.resolve();(_graph=UILGraph.instance().getGraph(_name,_this))?(UIL.sidebar.element.show(),await _this.ready(),_graph.syncVisibility(_layers),_graph.syncGroupNames(_groups,_folders),_groupsSynced.resolve(),Global.PLAYGROUND&&Utils.getConstructorName(_this.parent)==Global.PLAYGROUND&&_graph.open()):_groupsSynced.resolve()}function ssReflectionsEnabled(){if(void 0!==_this.cachedSSReflections)return _this.cachedSSReflections;let p=_this,has=!1;for(;p;)p.ssgiEnabled&&(has=!0),p=p.parent;return _this.cachedSSReflections=has,has}function generateScreenSpaceReflectionsPanel(shader){let texturePath="assets/images/_scenelayout/mask.jpg";shader.addUniforms({tReflectivity:{value:Utils3D.getTexture(texturePath)},tRoughness:{value:Utils3D.getTexture(texturePath)},ssReflectivity:{value:1},ssIORrefl:{value:1},ssRougness:{value:0},ssgiIntensity:{value:1}})}function initParams(){if(_options.rootPath?"/"!=_options.rootPath.charAt(_options.rootPath.length-1)&&(_options.rootPath+="/"):_options.rootPath="",_this.timeline=_timeline=_options.timeline,_timeline&&(_timeline.add({v:0},{v:1},100,"linear"),_uil)){let range=new UILControlRange("Timeline",{min:0,max:1,step:.001});range.onChange((val=>{_timeline.elapsed=val,_timeline.update()})),_uil.add(range),range.hide(),_graph&&_graph.addSpecial("Timeline","Timeline")}_this.baseRenderOrder=_options.baseRenderOrder||0,_this.data=_options.data,_breakpoint=_options.breakpoint||SceneLayout.breakpoint,_options.breakpoint&&(_this.localBreakpoint=!0),_options.uil&&(_uil=_options.uil)}async function initData(){if(await UILStorage.ready(),_dataStore=InputUIL.create(`scenelayout_${_name}`,null),void 0===(_data=JSON.parse(_dataStore.get("data")||"{}")).layers&&(_data.layers=-1),_stateData=await UILGroupBridge.createSceneLayout(_name,_this),_options.perFrame)_data.layers>0?createLayers():_this.loaded=!0;else{for(let i=0,c=_data.layers+1;i<c;i++)initialize(createLayer(i));_this.loaded=!0}}function createShader(shaderName,input,params={}){let shader;try{shader=_this.initClass(Shader,shaderName,{unique:`Element_${input.id}_${_name}`,...params})}catch(e){if("SceneLayout"===shaderName)throw e;return console.error(e,", replacing with default UV tile."),createShader("SceneLayout",input,params)}if("SceneLayout"===shaderName||!window[shaderName]){let texturePath=input.getImage("texture");texturePath?texturePath.includes("assets/images")||(texturePath=_options.rootPath+texturePath):texturePath="assets/images/_scenelayout/uv.jpg",shader.addUniforms({tMap:{value:Utils3D.getTexture(texturePath)},uAlpha:{value:1}})}return shader}function createLayers(){let index=0,renderWorker=new Render.Worker((function(){initialize(createLayer(index)),index++==_data.layers&&(renderWorker.stop(),_this.loaded=!0)}),_options.perFrame)}function getGroup(name,index){if(!name)return _this.group;if(name==_name)return _this.group;if(!_groups[name]){let uilGroup=_uil?createFolder(name):null;uilGroup&&(uilGroup.setLabel(`${name} (Group)`),_uil.add(uilGroup),_graph&&_graph.addGroup(uilGroup.id,name));let config=InputUIL.create(`GROUP_${_name}_${name}`,uilGroup);config.setLabel("Parameters"),config.addToggle("occlusionCulling"),_timeline&&config.add("tween"),config.addToggle("billboard"),config.add("breakpoints"),config.add("name","hidden");let breakpoints=config.get("breakpoints");breakpoints&&(breakpoints=breakpoints.replace(/ /g,"").split(","));let breakpoint=breakpoints&&_breakpoint?"-"+_breakpoint:"";"-"==breakpoint.charAt(breakpoint.length-1)&&(breakpoint="");let group=new Group;group.name=name,_groups[name]=group,_layers[name]=group,_exists[name]="group",group.prefix=`${name}_${_name}${breakpoint}`;let meshUIL=MeshUIL.add(group,uilGroup);meshUIL.setLabel("Mesh"),_this.add(group),UIL.global&&(group._meshUIL=meshUIL),uilGroup&&(uilGroup.params=config),breakpoints&&_breakpoints.push(group),config.get("billboard")&&updateBillboard(!0,mesh);let occlusionCulling=config.get("occlusionCulling");"boolean"==typeof occlusionCulling&&occlusionCulling&&_groups[name].generateOcclusionMesh();let appState=_stateData.getGroup(index||_groupIndex);appState||(appState=_stateData.syncGroup(index||_groupIndex,name),_this.flag("needsGroupFixing",!0)),_this.flag("needsGroupFixing")&&(group.fixStateBinding=appState.id),appState.scene=_name,_this.bindState(appState,"name",(name=>{_groups[name]=group,_layers[name]=group,_exists[name]="group";for(let key in _layers)key!=name&&_layers[key]==_layers[name]&&(delete _layers[key],delete _exists[key],delete _groups[key])})),_this.bindState(appState,"visible",(bool=>{group.visible=bool})),_this.bindState(appState,"deleted",(bool=>{bool&&(delete _groups[name],delete _layers[name],delete _exists[name],group._parent.remove(group))})),appState.slGroup=group}return void 0===index&&(_data.groups=_groupIndex,_groupIndex++,_dataStore.setValue("data",JSON.stringify(_data))),_this.flag("needsGroupFixing")&&Utils.debounce(healGroups,100),_groups[name]}function healGroups(){_stateData.healGroups(_groupIndex)}async function createLayer(index,groupName,returnName){let created=!1,input,id="number"==typeof index?index:++_data.layers,graphGroupName=groupName;if(graphGroupName){let nameLabel=UILStorage.get(`INPUT_GROUP_${_name}_${groupName}_name`);nameLabel&&(groupName=nameLabel)}let appState=_stateData.layers[id];if(appState?.deleted)return;if(_this.preventLayerCreation&&_this.preventLayerCreation(UILStorage.get(`INPUT_Config_${id}_${_name}_name`)))return;let group=_uil?createFolder(id):null,shader,mesh;appState&&(_this.bindState(appState,"visible",(bool=>{mesh&&(mesh.visible=bool)})),_this.bindState(appState,"parent",(async parentName=>{let parent;if(await _this.wait((_=>!!mesh)),parentName?.includes?.("group")&&(parent=Number(parentName.split("group_")[1])),null==parentName)return _this.group.add(mesh),mesh.position.y+=1,void(mesh.position.y-=1);if(parentName.includes("_env_")){let groupName=parentName.split("_env_")[1];return _groups[groupName].add(mesh),mesh.position.y+=1,void(mesh.position.y-=1)}if(parentName.startsWith("sl_")){let groupName=parentName.split("_").pop();if(isNaN(groupName)){return _groups[groupName].add(mesh),mesh.position.y+=1,void(mesh.position.y-=1)}}if(parent>-1){let obj=_stateData.getGroup(parent);obj?.slGroup&&obj.slGroup.add(mesh),mesh.position.y+=1,mesh.position.y-=1}else _this.group.add(mesh)}))),Hydra.LOCAL&&_this.delayedCall((_=>{created||console.error(`SceneLayout :: 5 second timer expired creating ${_name} ${input.get("name")}`)}),5e3),input=InputUIL.create(`Config_${id}_${_name}`,group),input.setLabel("Parameters"),input.add("name","hidden").add("sortIndex","hidden").addFile("geometry",{relative:"assets/geometry"}).addToggle("visible",!0).addToggle("transparent").addToggle("depthWrite",!0).addToggle("depthTest",!0).addToggle("occlusionCulling",!1).addToggle("castShadow").addToggle("receiveShadow").addToggle("receiveLight").addToggle("billboard").addToggle("animates",!0).add("shader").add("custom",null,"customClass").add("script",null,"scriptClass").add("wildcard").add("renderOrder","hidden").add("group","hidden").add("breakpoints").addSelect("side",[{label:"Front Side",value:"shader_front_side"},{label:"Back Side",value:"shader_back_side"},{label:"Double Side",value:"shader_double_side"},{label:"Double Side Transparent",value:"shader_double_side_trasparency"}]).addSelect("blending",[{label:"Normal",value:"shader_normal_blending"},{label:"Additive",value:"shader_additive_blending"},{label:"Premultiplied Alpha",value:"shader_premultiplied_alpha_blending"}]),window.FX.ScreenSpaceRaytracer&&input.addToggle("ssgi"),input.name=_name,input.prefix=`Element_${id}_${_name}`,input.id=id,group&&(group.params=input),_timeline&&input.addToggle("tween"),_options.physics&&(input.addToggle("physics"),input.add("physicsCode"),input.addFile("physicsBounds",{relative:"assets/geometry"}));let name=input.get("name")||id,shaderName=input.get("shader")||"SceneLayout",geomPath=input.getFilePath("geometry"),visible=input.get("visible"),transparent=input.get("transparent"),depthWrite=input.get("depthWrite"),depthTest=input.get("depthTest"),occlusionCulling=input.get("occlusionCulling"),billboard=input.get("billboard"),animates=input.get("animates"),doTween=input.get("tween"),renderOrder=input.getNumber("renderOrder"),blending=input.get("blending"),side=input.get("side"),physics=input.get("physics"),castShadow=input.get("castShadow"),receiveShadow=input.get("receiveShadow"),receiveLight=input.get("receiveLight"),ssReflections=input.get("ssgi");ssReflections&&!ssReflectionsEnabled()&&(ssReflections=!1),appState&&(appState.scene=_name,_this.bindState(appState,"sortIndex",(async index=>{if(mesh||await _this.wait((_=>mesh)),appState.parent){let[fraction,groupSortIndex]=await _stateData.calculateRenderFraction(id),renderOrder=_this.baseRenderOrder+groupSortIndex+fraction;input.setValue("renderOrder",renderOrder-_this.baseRenderOrder),mesh.renderOrder=renderOrder,mesh.classRef?.setRenderOrder&&mesh.classRef.setRenderOrder(renderOrder)}else{let renderOrder=_this.baseRenderOrder+index;input.setValue("renderOrder",renderOrder-_this.baseRenderOrder),input.setValue("sortIndex",index),mesh.renderOrder=renderOrder,mesh.classRef?.setRenderOrder&&mesh.classRef.setRenderOrder(renderOrder)}})));let breakpoints=input.get("breakpoints");breakpoints&&(breakpoints=breakpoints.replace(/ /g,"").split(","));let breakpoint=breakpoints&&_breakpoint?"-"+_breakpoint:"";"-"==breakpoint.charAt(breakpoint.length-1)&&(breakpoint=""),name&&group&&group.setLabel(name),groupName&&input.setValue("group",groupName);let groupParent=getGroup(input.get("group"));if(group){let groupName=input.get("group"),groupId=groupName?`sl_${_name}_${graphGroupName||groupName}`:void 0;_graph&&_graph.addLayer(group.id,name||id+"",groupId)}if(_uil&&_uil.add(group),"ignore"==name)return created=!0;let customClass=input.get("custom")||input.get("customClass"),scriptClass=input.get("script")||input.get("scriptClass"),customCompile;if(shaderName.includes("|")&&([shaderName,customCompile]=shaderName.split("|")),_exists[name]=customClass?"custom":"mesh",customClass){if(customClass===_this.parent.constructor.name)return console.warn(`Tried to recursively initialize ${customClass}`);if(!window[customClass])return console.warn(`Tried to initialize ${customClass} but it doesn't  exist!`);let obj=_this.initClass(window[customClass],input,group,id,null);if(mesh=obj.group,obj.wildcard=input.get("wildcard"),obj.animates=input.get("animates"),"boolean"==typeof visible&&mesh&&(mesh.visible=visible),_custom[name]=obj,_layers[name]=obj,appState&&_this.bindState(appState,"name",(name=>{_layers[name]=obj,_exists[name]="custom";for(let key in _layers)key!=name&&_layers[key]==_layers[name]&&(delete _layers[key],delete _exists[key])})),_this.onCreateLayer){let capture=cb=>(_this.delayedCall((_=>cb(obj,name)),32),!0);if(!0===_this.onCreateLayer(name,group,capture))return}if(obj.group&&(groupParent.add(obj.group),groupParent&&groupParent.fixStateBinding&&(appState.parent=groupParent.fixStateBinding)),obj.renderOrder=_this.baseRenderOrder+renderOrder,mesh){let meshUIL;obj.camera||(mesh.prefix=`Element_${id}_${_name}${breakpoint}`,meshUIL=MeshUIL.add(mesh,group),meshUIL.setLabel("Mesh"),UIL.global&&(mesh._meshUIL=meshUIL)),breakpoints&&_breakpoints.push(mesh),scriptClass&&!1!==visible&&(scriptClass.includes(",")?(scriptClass=scriptClass.replace(/ /g,"").split(","),scriptClass.forEach((script=>{window[script]?(mesh.scriptClass=mesh.scriptClass||[],mesh.scriptClass.push(_this.initClass(window[script],mesh,shader,group,input))):console.warn(`scriptClass ${script} not found`)}))):window[scriptClass]?mesh.scriptClass=_this.initClass(window[scriptClass],mesh,shader,group,input):console.warn(`scriptClass ${scriptClass} not found`)),UIL.global&&(mesh._sceneLayout=input._sceneLayout={meshUIL:meshUIL,mesh:mesh,shader:shader,name:name,input:input})}return created=!0,input}if(_this.onCreateLayer){let capture=cb=>{let mesh=new Group;return mesh.prefix=`Element_${id}_${_name}${breakpoint}`,MeshUIL.add(mesh,group),_meshes[name]=mesh,_layers[name]=mesh,_this.delayedCall((_=>cb(mesh,name)),32),created=!0,!0};if(!0===_this.onCreateLayer(name,group,capture))return created=!0}let geom=World.PLANE;geomPath&&geomPath.includes(["World","SceneLayout"])&&(geom=eval(geomPath),geomPath=null),shaderName.includes(".shader")&&(shader=await resolveShaderRef(shaderName,name),shader||(shaderName="SceneLayout")),shader||(shaderName.includes("PBR")?shader=_this.initClass(PBRShader,shaderName,{unique:`Element_${id}_${_name}`}):(shader=createShader(shaderName,input,{customCompile:customCompile,ssReflections:ssReflections}),defer((_=>{for(let key in shader.uniforms){let uniform=shader.uniforms[key];uniform&&uniform.value instanceof Texture&&initialize(uniform.value.promise)}})))),"boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&(shader.depthTest=depthTest),"boolean"==typeof transparent&&(shader.transparent=transparent),ssReflections&&generateScreenSpaceReflectionsPanel(shader),_this.onCreateGeometry&&(geomPath=_this.onCreateGeometry(geomPath,input.get("wildcard")));let gltfNodes=null;if(geomPath)if(String(geomPath).indexOf(".glb")>0||String(geomPath).indexOf(".gltf")>0){let loader=new GLTFLoader;gltfNodes=await loader.parse(geomPath,_this,name),geom=new PlaneGeometry(0,0)}else geom=await GeomThread.loadGeometry(geomPath);if(mesh=new Mesh(geom,shader),"boolean"==typeof occlusionCulling&&(mesh.occlusionCulled=occlusionCulling),gltfNodes)for(let i=0;i<gltfNodes.length;i++)mesh.add(gltfNodes[i]);"boolean"==typeof _options.frustumCulled&&(mesh.frustumCulled=_options.frustumCulled),"boolean"==typeof visible&&(mesh.visible=visible),groupParent.add(mesh),groupParent.fixStateBinding&&(appState.parent=groupParent.fixStateBinding),mesh.prefix=`Element_${id}_${_name}${breakpoint}`,mesh.uilName=name,mesh.uilGroup=group,mesh.uilGraph=_graph,mesh.wildcard=input.get("wildcard"),mesh.animates=input.get("animates");let meshUIL=MeshUIL.add(mesh,group);if(meshUIL.setLabel("Mesh"),UIL.global&&(mesh._meshUIL=meshUIL),physics){let path=input.getFilePath("physicsBounds"),obj;if(path){const shapes=await PhysicsBounds.parsePhysicsBoundsShapes(Assets.getPath(path));shapes&&(obj=Physics.instance().createFromShapes(shapes,{},mesh))}obj||(obj=Physics.instance().create(mesh)),obj.prefix=`Physics_${id}_${_name}`,PhysicsUIL.add(obj,group).setLabel("Physics");let physicsCodeClassName=input.get("physicsCode"),physicsCodeClass;physicsCodeClassName&&(physicsCodeClass=window[physicsCodeClassName],physicsCodeClass||console.warn(`physicsCode class ${physicsCodeClassName} not found`)),physicsCodeClass&&_this.initClass(physicsCodeClass,obj,mesh,group,input)}if(_meshes[name]=mesh,_layers[name]=mesh,appState&&_this.bindState(appState,"name",(name=>{_layers[name]=mesh,_exists[name]=customClass?"custom":mesh;for(let key in _layers)key!=name&&_layers[key]==_layers[name]&&(delete _layers[key],delete _exists[key])})),breakpoints&&_breakpoints.push(mesh),mesh.renderOrder=_this.baseRenderOrder+(renderOrder||0),billboard&&updateBillboard(!0,mesh),"SceneLayout"!=shaderName&&window[shaderName]&&(mesh.shaderClass=_this.initClass(window[shaderName],mesh,shader,group,input)),shader._copied||shader!==mesh.shader&&!shaderName.includes("PBR")||ShaderUIL.add(shader,group).setLabel("Shader"),shader._copied&&shader._copied.shaderClass&&shader._copied.shaderClass.applyClone&&shader._copied.shaderClass.applyClone(mesh),"number"!=typeof index&&_dataStore.setValue("data",JSON.stringify(_data)),blending&&(shader.blending=blending),side&&(shader.side=side),castShadow&&(mesh.castShadow=castShadow),receiveShadow=receiveShadow||Shader.shouldReceiveShadow(shader),receiveShadow&&(shader.receiveShadow=receiveShadow),receiveLight&&(shader.receiveLight=receiveLight),scriptClass&&(scriptClass.includes(",")?(scriptClass=scriptClass.replace(/ /g,"").split(","),scriptClass.forEach((script=>{window[script]?(mesh.scriptClass=mesh.scriptClass||[],mesh.scriptClass.push(_this.initClass(window[script],mesh,shader,group,input))):console.warn(`scriptClass ${script} not found`)}))):window[scriptClass]?mesh.scriptClass=_this.initClass(window[scriptClass],mesh,shader,group,input):console.warn(`scriptClass ${scriptClass} not found`)),input.onUpdate=key=>{switch(key){case"name":break;case"visible":mesh.visible=input.get(key);break;case"renderOrder":mesh.renderOrder=_this.baseRenderOrder+input.getNumber(key);break;case"transparent":shader.transparent=input.get(key);break;case"depthWrite":shader.depthWrite=input.get(key);break;case"depthTest":shader.depthTest=input.get(key);break;case"side":shader.side=input.get(key);break;case"blending":shader.blending=input.get(key);break;case"geometry":updateGeometry(input.getFilePath(key),mesh);break;case"shader":updateShader(input.get(key),mesh,group,input);break;case"scriptClass":updateScriptClass(input.get(key),mesh,group,input);break;case"receiveShadow":updateShadow(input.get(key),mesh);break;case"receiveLight":updateLighting(input.get(key),mesh);break;case"billboard":updateBillboard(input.get(key),mesh)}UIL.global&&(World.SCENE.displayNeedsUpdate=!0,window?.view?.scene&&(view.scene.displayNeedsUpdate=!0))},Hydra.LOCAL&&Global.PLAYGROUND){_this.events.sub(SceneLayout.HOTLOAD_GEOMETRY,(({file:file})=>{mesh.geometry?._src?.includes(file)&&updateGeometry(file,mesh)}));const scriptClassNeedsUpdate=(inst,file)=>(inst.__cacheName||(inst.__cacheName=Utils.getConstructorName(inst)),!!file.includes(inst.__cacheName)&&inst.__cacheName);_this.events.sub(SceneLayout.HOTLOAD_SCRIPT,(({file:file})=>{if(file.includes(mesh.shader?.vsName)&&(shader.hotReloading=!0,"SceneLayout"!==shaderName&&window[shaderName]&&(mesh.shaderClass=_this.initClass(window[shaderName],mesh,shader,group,input)),group.remove(shader.UILPrefix),delete ShaderUIL.exists[shader.UILPrefix],ShaderUIL.add(shader,group).setLabel("Shader"),shader.hotReloading=!1),mesh.scriptClass)if(Array.isArray(mesh.scriptClass))mesh.scriptClass.every(((inst,index)=>{let name=scriptClassNeedsUpdate(inst,file);return!name||(mesh.scriptClass.remove(inst),updateScriptClass(name,mesh,group,input),!1)}));else{let name=scriptClassNeedsUpdate(mesh.scriptClass,file);name&&updateScriptClass(name,mesh,group,input)}}))}return UIL.global&&(mesh._sceneLayout=input._sceneLayout={meshUIL:meshUIL,mesh:mesh,input:input,name:name,get shaderUIL(){return this.mesh.shader.shaderUIL}}),created=!0,returnName?name:input}async function updateGeometry(geomPath,mesh){let geom=World.PLANE;geomPath&&geomPath.includes(["World","SceneLayout"])?(geom=eval(geomPath),geomPath=null):geomPath&&(geom=await GeomThread.loadGeometry(geomPath+"?"+Utils.timestamp())),mesh.geometry=geom}async function resolveShaderRef(shaderName,layerName){let shaderLayer=shaderName.split(".shader")[0],promise=_this.getLayer(shaderLayer);Hydra.LOCAL&&(promise=Promise.race([promise,(async()=>{await _this.loadedAllLayers()})()]));let layer=await promise;if(layer){let shader=layer.shader;return shader._copied=layer,shader}Hydra.LOCAL&&console.error(`Couldn’t find shader “${shaderName}” for layer “${layerName}” in SceneLayout “${_name}”, because layer “${shaderLayer}” doesn't exist`)}async function updateShader(shaderName="",mesh,group,input){let shader;shaderName.includes(".shader")&&(shader=await resolveShaderRef(shaderName,mesh.uilName),shader||(shaderName="SceneLayout")),shader||(shader=shaderName.includes("PBR")?_this.initClass(PBRShader,shaderName,{unique:`Element_${input.id}_${_name}`}):createShader(shaderName,input)),group.remove(mesh.shader.UILPrefix);for(let key in mesh.shader.uniforms){if("t"===mesh.shader.uniforms[key].type)try{mesh.shader.shaderUIL.copyTexture(key,shader)}catch(e){console.error(e)}}mesh.shader=shader,"SceneLayout"!==shaderName&&window[shaderName]&&(mesh.shaderClass=_this.initClass(window[shaderName],mesh,shader,group,input)),ShaderUIL.add(shader,group).setLabel("Shader")}function updateLighting(bool,mesh){mesh.shader.customCompile=Utils.uuid(),mesh.shader.receiveLight=bool,mesh.shader.resetProgram(),mesh.shader.upload()}function updateShadow(bool,mesh){mesh.shader.customCompile=Utils.uuid(),mesh.shader.receiveShadow=bool,mesh.shader.resetProgram(),mesh.shader.upload()}function updateBillboard(bool,mesh){bool?(mesh._billboardLoop=_=>Utils3D.billboard(mesh),_this.startRender(mesh._billboardLoop)):(mesh.rotation.set(0,0,0),_this.stopRender(mesh._billboardLoop))}function updateScriptClass(scriptClass,mesh,group,input){scriptClass&&(scriptClass.includes(",")?(scriptClass=scriptClass.replace(/ /g,"").split(",")).forEach((script=>{window[script]?(mesh.scriptClass=mesh.scriptClass||[],mesh.scriptClass.push(_this.initClass(window[script],mesh,mesh.shader,group,input))):console.warn(`scriptClass ${script} not found`)})):window[scriptClass]?mesh.scriptClass=_this.initClass(window[scriptClass],mesh,mesh.shader,group,input):console.warn(`scriptClass ${scriptClass} not found`))}function addListeners(){_this.events.sub(SceneLayout.BREAKPOINT,(e=>_this.localBreakpoint?null:setBreakpoint(e)))}function setBreakpoint({value:value}){value!=_breakpoint&&(_breakpoint=value,_breakpoints.forEach((mesh=>{if(!mesh.prefix)return;mesh.prefix=mesh.prefix.split("-")[0]+"-"+_breakpoint,"-"==mesh.prefix.charAt(mesh.prefix.length-1)&&(mesh.prefix=mesh.prefix.slice(0,-1));let meshUIL=new MeshUILConfig(mesh);UIL.global&&(mesh._meshUIL=meshUIL)})))}async function ready(){await _this.wait(_this,"loaded"),UIL.sidebar&&UIL.sidebar.toolbar.hideAll()}function copyFolderProps(from,to){let mesh,params,shader;to.forEachFolder((child=>{switch(child.label){case"Parameters":params=child;break;case"Mesh":mesh=child;break;case"Shader":shader=child}}));let allowed=["Parameters","Mesh","Shader"];from.forEachFolder((child=>{if(!(allowed.indexOf(child.label)<0))switch(child.toClipboard(),child.label){case"Parameters":params.fromClipboard();break;case"Mesh":mesh.fromClipboard();break;case"Shader":shader.fromClipboard()}}))}this.isSceneLayout=!0,this.name=_name,async function(){window.Physics&&(_options.physics=!0),_this.group.sceneLayout=_this,await initialize(defer()),SceneLayout.getTexture||(SceneLayout.getTexture=Utils3D.getTexture),initGraph(),initParams(),initialize(initConfig()),initData(),addListeners(),ready(),UIL.global&&initGizmo()}(),this.ready=async function(early){if(await _this.wait(_this,"loaded"),await _this.wait(_this,"configured"),early)return!0;await defer(),await defer()},this.getLayer=async function(name){let timer;return Hydra.LOCAL&&(timer=_this.delayedCall((_=>{_exists[name]||console.warn(`${name} doesn't exist in SceneLayout ${_name}`)}),1e3)),await _this.wait(_layers,name),timer&&clearTimeout(timer),_layers[name]},this.getLayers=async function(){let array=[];for(let i=0;i<arguments.length;i++)array.push(_this.getLayer(arguments[i]));return Promise.all(array)},this.getAllLayers=async function(){return await this.ready(),await this.loadedAllLayers(),_layers},this.getAllMatching=async function(label){let layers=await _this.getAllLayers(),array=[];for(let key in layers)key.includes(label)&&(layers[key].layerName=key,array.push(layers[key]));return array},this.exists=function(name){return _exists[name]},this._createLayer=function(parentId,returnName=!1){return createLayer(null,parentId,returnName)},this._createGroup=function(){return getGroup(`group_${_groupIndex}`),_groupIndex},this._deleteGroup=function(){},this._getGroup=function(name,index){return getGroup(name,index)},this._rename=function(id,name,value){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];folder&&(folder.setLabel(value),folder.params&&folder.params.setValue("name",value),[_groups,_custom,_meshes,_exists,_layers].forEach((function(store){store[name]&&(store[value]=store[name],store[name]=null,delete store[name])})))},this._deleteLayer=function(id,name,coded){id.includes("_")&&(id=(id=id.split("_"))[id.length-1]);let folder=_folders[id]||_folders[`sl_${_name}_${id}`],layer=_layers[id]||_layers[name];return layer&&layer.isGroup&&layer.length>1?(alert("Can't delete a group that has nested layers."),!1):!(!coded&&!confirm("Are you sure you want to delete this layer?"))&&(layer&&layer._parent&&(layer._parent.remove(layer),layer._parent=null),folder&&folder.parent&&folder.parent.remove(folder),UILStorage.set(`sl_${_name}_${id}_deleted`,!0),!0)},this._changeParent=function(childId,childName,parentId,parentName){let child=_layers[childId]||_layers[childName],parent=_layers[parentId]||_layers[parentName]||_this;if(!child)return;let folder=_folders[childId]||_folders[`sl_${_name}_${childName}`];folder&&folder.params&&folder.params.setValue("group",parentName||null);let parentObject=parent.group||parent,childObject=child.group||child;parentObject.isObject3D&&childObject.isObject3D&&parentObject.add(childObject),child.updateMatrix&&child.updateMatrix()},this._visible=function(name,visible){let mesh=_layers[name];mesh&&(mesh.group&&(mesh=mesh.group),mesh.visible=visible)},this._focus=function(name){UIL.sidebar.toolbar.filterSingle(name)},this._blur=function(name){let folder=_folders[name]||_folders[`sl_${_name}_${name}`];folder&&folder.forEachFolder&&(folder.forEachFolder((f=>f.close())),folder.close())},this._sort=function(order){order.forEach(((label,index)=>{label.children&&label.children.forEach((function(child,j,all){let folder=_folders[child];if(!folder||!folder.params)return;let renderOrder=_this.baseRenderOrder+index+(j+1)/(all.length+1);folder.params.setValue("renderOrder",renderOrder-_this.baseRenderOrder);let mesh=_layers[child]||_layers[folder.label];mesh&&(mesh.renderOrder=renderOrder)}));let folder=_folders[label];if(!folder||!folder.params)return;let renderOrder=_this.baseRenderOrder+index;folder.params.setValue("renderOrder",renderOrder-_this.baseRenderOrder);let mesh=_layers[label]||_layers[folder.label];mesh&&(mesh.renderOrder=renderOrder)}))},this._duplicateLayer=function(id,parentId){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];if(!folder)return;createLayer(null,parentId);let copyShader,copy=Object.values(_folders).last();folder.forEachControl((input=>{"shader"===input.label&&(copyShader=input.value)})),copyShader&&(console.log(copyShader),copy.forEachControl((input=>{"shader"===input.label&&input.force(copyShader)}))),copyFolderProps(folder,copy)},this._duplicateGroup=function(id,children){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];if(!folder)return;let copyId=`group_${_groupIndex+1}`;getGroup(copyId),copyFolderProps(folder,Object.values(_folders).last()),children.forEach((childId=>{_this._duplicateLayer(childId,copyId)}))},this._getCinemaConfig=async function(){let _cinemaConfig=_config.get("Cinema Config").replace(".json","");return await get(Assets.getPath(`assets/geometry/${_cinemaConfig}.json`))},this._applyCinemaConfig=function(id,params){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];if(!folder)return;let mesh=folder.getAll().filter((sub=>"Mesh"==sub.label))[0];if(params.geometry&&folder.params.setValue("geometry",params.geometry.replace("assets/geometry/","")),["position","quaternion","scale"].forEach((transform=>{if(params[transform]){let value=JSON.parse(params[transform]);if("quaternion"==transform){let quat=(new Quaternion).fromArray(value);value=(new Euler).setFromQuaternion(quat).toArray().slice(0,3).map((angle=>180*angle/Math.PI)),transform="rotation"}mesh.getAll().filter((control=>control.label==transform))[0].force(value)}})),params.visible&&"false"===params.visible&&!params.geometry&&(folder.params.setValue("geometry","World.PLANE"),folder.params.setValue("side","shader_double_side"),!Global.PLAYGROUND)){_meshes[folder.params.get("name")].shader.neverRender=!0}params.shader&&folder.params.setValue("shader",params.shader)},this.loadedAllLayers=async function(){return await _this.ready(),Promise.catchAll(_promises)},this.set("breakpoint",(value=>{_this.localBreakpoint=!0,setBreakpoint({value:value})})),this.get("breakpoint",(_=>_breakpoint)),this.get("layers",(_=>_layers)),this.get("layerCount",(_=>_data.layers)),this.onDestroy=function(){_graph?.destroy?.(),_this.textures&&!_options.persistTextures&&_this.textures.forEach((t=>{t.destroy&&t.destroy()}))},this.addInitializer=function(callback){_initializers.push(callback)},this._completeInitialization=async function(sync){if(!_initializers.length)return!0;for(let i=0;i<_initializers.length;i++)await _initializers[i](sync);_initializers.length=0}}),(_=>{SceneLayout.BREAKPOINT="sl_breakpoint",SceneLayout.HOTLOAD_GEOMETRY="sl_hotload_geom",SceneLayout.HOTLOAD_SCRIPT="sl_hotload_script",SceneLayout.setBreakpoint=function(value){SceneLayout.breakpoint!==value&&(SceneLayout.breakpoint=value,Events.emitter._fireEvent(SceneLayout.BREAKPOINT,{value:value}))}})),Class((function SceneLayoutGizmo(){Inherit(this,Object3D);const _this=this;var _controls,_update,_attached,_lastVal;function findCamera(){let camera=World.CAMERA,p=_this.group._parent;for(;p;)p instanceof Scene&&p.nuke&&(camera=p.nuke.camera),p=p._parent;return camera}function update(){let uil=_attached._cameraUIL||_attached._meshUIL,key="translate"==_controls.getMode()?"position":"scale",value=_attached[key].toArray();(function same(a,b){return!(!a||!b||Math.abs(a[0]-b[0])>Base3D.DIRTY_EPSILON||Math.abs(a[1]-b[1])>Base3D.DIRTY_EPSILON||Math.abs(a[2]-b[2])>Base3D.DIRTY_EPSILON)})(value,_lastVal)||(_lastVal=value,_attached._cameraUIL&&"position"==key&&(key="groupPos"),uil?.[`forceUpdate${key.toUpperCase()}`]?.(value))}function startMoving(){_update=setInterval(update,250)}function stopMoving(){clearInterval(_update),update()}function keyDown(e){document.activeElement.tagName.toLowerCase().includes(["textarea","input"])||("."==e.key&&_controls.setMode("translate"),"/"==e.key&&_controls.setMode("scale"),"="!=e.key&&"+"!=e.key||(_controls.visible=!_controls.visible))}function playgroundEvent(camera){camera||(_controls.visible=!1,camera=findCamera()),_controls.camera=camera}async function nodeFocused(e){if(_controls.visible=!1,"Config"!=e.name&&e.layoutInstance==_this.parent){let layer=await _this.parent.getLayer(e.name),group=layer.group||layer;if(!group||!group.updateMatrixWorld)return;_controls.attach(group),_attached=group,_controls.visible=!0}}this.isGizmo=!0,(_controls=new TransformControls(findCamera(),World.ELEMENT.div)).onChange=_controls.onMouseDown=_controls.onMouseUp=_controls.onObjectChange=e=>{},_controls.onMouseDown=startMoving,_controls.onMouseUp=stopMoving,_controls.draggingChanged=e=>{let activeControls=Playground.instance().activeControls;activeControls&&(activeControls.enabled=!e.value)},SceneLayoutGizmo.initialized?_controls.visible=!1:SceneLayoutGizmo.initialized=!0,_this.group.add(_controls),AppState.bind("playground_camera_active",playgroundEvent),function addListeners(){_this.events.sub(Keyboard.DOWN,keyDown),_this.events.sub(UILGraphNode.FOCUSED,nodeFocused)}(),_this.delayedCall((_=>{_controls.camera=findCamera()}),500),_this.group.traverse((obj=>{obj.isGizmo=!0})),Device.mobile&&(_this.group.visible=!1)})),Class((function SceneLayoutPreloader(_name){Inherit(this,Component);function findMatch(src,arr){return!(!src||src.startsWith("."))&&((src=src.trim()).startsWith("/")&&(src=src.slice(1)),arr.find((({filename:filename})=>filename.includes(src))))}this.load=function(name){let promise=Promise.create(),array=[],keys=UILStorage.getKeys(),i=0,worker=new Render.Worker((_=>{let key=keys[i];if(!key)return worker.stop(),void Promise.all(array).then(promise.resolve);if(key.includes(name)){let val=UILStorage.get(key);if(!val||!val.includes)return i++;if(key.includes("geometry")&&("{"==val.charAt(0)&&(val=JSON.parse(val).src),val.includes(".json")||val.includes(".bin")||(val+=".json"),val.includes("assets/")||(val="assets/geometry/"+val),findMatch(val.split("assets/geometry/")[1],UIL_ASSETS_GEOMETRIES)&&array.push(GeomThread.loadGeometry(Assets.getPath(val),null,!0))),val.includes(".json")||val.includes(".bin"))val.includes("assets/")||(val="assets/geometry/"+val),findMatch(val.split("assets/geometry/")[1],UIL_ASSETS_GEOMETRIES)&&array.push(fetch(Assets.getPath(val)).catch((e=>{})));else if(val.includes("src")){let obj=JSON.parse(val),src=obj.src;if(obj.compressed)if("ktx2"===obj.compressed){let src0=src.split(".")[0];src=src0+".ktx2"}else{let ext,src0=src.split(".")[0],src1=src0.split("/");ext=Renderer.extensions.etc1?"astc":Renderer.extensions.pvrtc?"pvrtc":Renderer.extensions.astc?"astc":"dxt",src=src0+"/"+src1[src1.length-1]+"-"+ext+".ktx"}findMatch(src.split("assets/images/")[1],UIL_ASSETS_TEXTURES)&&array.push(fetch(Assets.getPath(src)).catch((e=>{})))}}i++}),1);return promise}}),"static"),Class((function UILGroupBridge(){Inherit(this,Component);const _this=this;var _map={};function Bridge(name){let store=InputUIL.create(`scenelayout_${name}`,null),data=JSON.parse(store.get("data")||"{}");void 0===data.layers&&(data.layers=-1),void 0===data.groups&&(data.groups=-1);var _healedGroups,_healedMap,_name=name;this.all=new StateArray,this.layers=new StateArray,this.groups=new StateArray;const $this=this;async function bindChanges(obj,key){await _this.wait($this,"sceneLayout"),$this.sceneLayout.bindState(obj,"name",(name=>{UILStorage.set(`${key}_name`,name)})),$this.sceneLayout.bindState(obj,"sortIndex",(index=>{UILStorage.set(`${key}_sortIndex`,index)})),$this.sceneLayout.bindState(obj,"parent",(parent=>{UILStorage.set(`${key}_parent`,parent)}))}function run(){data.groups=Math.max(data.groups,Number(UILStorage.get(`groupBridge_${name}_groups`))-1||-1);let healedGroups=_healedGroups=Number(UILStorage.get(`groupBridge_${name}healGroups`));healedGroups>0&&(_healedMap={});for(let i=0,c=data.layers+1;i<c;i++){let obj=AppState.createLocal(),key=`INPUT_Config_${i}_${name}`;obj.deleted=UILStorage.get(`sl_${name}_${i}_deleted`),obj.visible=!0,obj.parent=UILStorage.get(`${key}_parent`),obj.name=UILStorage.get(`${key}_name`)||"layer_"+i,obj.id=`sl_${name}_${i}`,obj.sortIndex=Number(UILStorage.get(`${key}_sortIndex`)),isNaN(obj.sortIndex)&&(obj.sortIndex=$this.all.length),$this.layers.push(obj),obj.deleted||$this.all.push(obj),obj.type="layer",bindChanges(obj,key)}this.groups=new StateArray;for(let i=0,c=data.groups+1;i<c;i++){if(healedGroups>0&&i<healedGroups)continue;let obj=AppState.createLocal(),key=`GROUP_${name}_group_${i}`;obj.visible=!0,obj.children=new StateArray,obj.id=`sl_${name}_group_${i}`,obj.deleted=UILStorage.get(`groupBridge_${obj.id}_deleted`),obj.name=UILStorage.get(`${key}_name`)||"group_"+i,obj.sortIndex=Number(UILStorage.get(`${key}_sortIndex`)),isNaN(obj.sortIndex)&&(obj.sortIndex=$this.all.length),$this.groups.push(obj),obj.type="group",_this.wait($this,"sceneLayout").then((_=>{$this.sceneLayout._getGroup("group_"+i,healedGroups>0?i:void 0)})),_healedMap&&(_healedMap[i]=obj),obj.deleted||$this.all.push(obj),bindChanges(obj,key)}$this.all.sort(((a,b)=>a.sortIndex-b.sortIndex))}run(),this.createGroup=async function(){let obj=AppState.createLocal();obj.deleted=!1,obj.visible=!0,obj.type="group",obj.children=new StateArray,obj.sortIndex=this.all.length,this.groups.push(obj),this.all.push(obj);let prevCount=Number(UILStorage.get(`groupBridge_${name}_groups`))||0;UILStorage.set(`groupBridge_${name}_groups`,prevCount+1),_healedGroups>0?(prevCount+=_healedGroups,this.sceneLayout._getGroup("group_"+prevCount,prevCount),_healedMap[prevCount]=obj):this.sceneLayout._createGroup(),obj.name="group_"+prevCount,obj.id=`sl_${name}_group_${prevCount}`},this.syncGroup=function(index,name){let obj=AppState.createLocal();return obj.deleted=!1,obj.visible=!0,obj.type="group",obj.children=new StateArray,obj.sortIndex=this.all.length,this.groups.push(obj),this.all.push(obj),obj.name=name,obj.id=`sl_${_name}_${name}`,obj},this.getGroup=function(index){return _healedMap?_healedMap[index]:this.groups[index]},this.healGroups=function(index){Number(UILStorage.get(`groupBridge_${name}healGroups`))>0||UILStorage.set(`groupBridge_${name}healGroups`,index)},this.createLayer=async function(parent){let obj=AppState.createLocal(),key=`INPUT_Config_${this.layers.length}_${name}`;obj.deleted=!1,obj.visible=!0,obj.parent=parent,obj.name="layer_"+this.layers.length,obj.type="layer",obj.id=`sl_${name}_${this.layers.length}`,obj.sortIndex=this.all.length,this.layers.push(obj),this.all.push(obj);let layer=await this.sceneLayout._createLayer();obj.name=layer.get("name")||obj.name,bindChanges(obj,key)},this.sync=function(){this.all.refresh([]),this.layers.refresh([]),this.groups.refresh([]),run()},this.deleteNode=function(obj){return obj.children?.length?alert("You can't delete a group with children"):confirm("Are you sure you want to delete this layer?")?(obj.deleted=!0,this.all.remove(obj),"layer"==obj.type&&this.sceneLayout._deleteLayer(obj.id,obj.name,!0),"group"==obj.type&&(this.sceneLayout._deleteGroup(obj.id,obj.name,!0),UILStorage.set(`groupBridge_${obj.id}_deleted`,!0)),!0):void 0},this.calculateRenderFraction=async function(index){let parent,obj=this.layers[index];if(this.groups.forEach((node=>{node.id.includes(obj.parent)&&(parent=node)})),!parent)return[0,0];let fraction=parent.children.indexOf(obj)/(parent.children.length-1)*.99;return isNaN(fraction)?(await _this.wait(50),this.calculateRenderFraction(index)):[fraction,parent.sortIndex]}}this.createSceneLayout=this.create=async function(name,layout){return layout||await _this.wait(_map,name),_map[name]||(_map[name]=new Bridge(name)),layout&&(_map[name].sceneLayout=layout),_map[name]}}),"static"),Class((function Scroll(_object,_params){Inherit(this,Component);const _this=this,PROHIBITED_ELEMENTS=["prevent_interactionScroll"];this.x=0,this.y=0,this.max={x:0,y:0},this.delta={x:0,y:0},this.enabled=!0,_this.bounds=null;const _scrollTarget={x:0,y:0},_scrollInertia={x:0,y:0};let _axes=["x","y"];var _lastDelta,_deltaChange=0;function checkIfProhibited(element){let el=element;for(;el;){if(el.classList)for(let i=0;i<PROHIBITED_ELEMENTS.length;i++)if(el.classList.contains(PROHIBITED_ELEMENTS[i]))return!0;el=el.parentNode}return!1}function loop(){_this.object&&(Math.round(_this.object.div.scrollLeft)===Math.round(_this.x)&&Math.round(_this.object.div.scrollTop)===Math.round(_this.y)||(_this.x=_scrollTarget.x=_this.object.div.scrollLeft,_this.y=_scrollTarget.y=_this.object.div.scrollTop,stopInertia())),_axes.forEach((axis=>{_this.isInertia&&(_scrollInertia[axis]*=.9,_scrollTarget[axis]+=_scrollInertia[axis]);let scale=_this.scale;Device.mobile&&(scale=_this.touchScale),_this.limit&&(_scrollTarget[axis]=Math.max(_scrollTarget[axis],0)),_this.limit&&(_scrollTarget[axis]=Math.min(_scrollTarget[axis],_this.max[axis]/scale)),_this.delta[axis]=_this.flag("block")?0:.5*(_scrollTarget[axis]*scale-_this[axis]),_this[axis]+=_this.delta[axis],Math.abs(_this.delta[axis])<.01&&(_this.delta[axis]=0),Math.abs(_this[axis])<.001&&(_this[axis]=0),_this.flag("block")&&(_scrollTarget[axis]=0,_this.delta[axis]=0,_this[axis]=0),_this.object&&("x"==axis&&(_this.object.div.scrollLeft=Math.round(_this.x)),"y"==axis&&(_this.object.div.scrollTop=Math.round(_this.y)))}))}function stopInertia(){_this.isInertia=!1,clearTween(_scrollTarget)}function edgeScroll(e){let element=document.elementFromPoint(Math.clamp(Mouse.x,0,Stage.width),Math.clamp(Mouse.y,0,Stage.height));element&&checkIfProhibited(element)||_params.lockMouseX&&Mouse.x>Stage.width||"touch"===e.pointerType&&_this.enabled&&(e.preventDefault&&e.preventDefault(),_axes.forEach((axis=>{let dir=axis.toUpperCase(),delta=`offset${dir}`,diff=(_this[`ieDelta${dir}`]||e[delta])-e[delta];_scrollTarget[axis]+=diff,_scrollInertia[axis]=diff,_this.isInertia=!0,_this[`ieDelta${dir}`]=e[delta]})),_this.onUpdate&&_this.onUpdate(),_this.events.fire(Events.UPDATE,_scrollInertia))}function edgeScrollEnd(){_this.ieDeltaX=!1,_this.ieDeltaY=!1}function scroll(e){let element=document.elementFromPoint(Math.clamp(Mouse.x,0,Stage.width),Math.clamp(Mouse.y,0,Stage.height));if(element&&checkIfProhibited(element))return;if(_params.lockMouseX&&Mouse.x>Stage.width)return;if(!_this.enabled)return;if(!checkBounds(e))return;if(_this.object&&_this.limit&&e.preventDefault&&e.preventDefault(),!_this.mouseWheel)return;stopInertia();let newDelta=0;_axes.forEach((axis=>{let delta="delta"+axis.toUpperCase();if("mac"==Device.system.os){if("firefox"==Device.system.browser)return 1===e.deltaMode?(_scrollTarget[axis]+=4*e[delta],_scrollInertia[axis]=4*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])):void(_scrollTarget[axis]+=e[delta]);if(Device.system.browser.includes(["chrome","safari"]))return _scrollTarget[axis]+=.33*e[delta],_scrollInertia[axis]=.33*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}if("windows"==Device.system.os){if("firefox"==Device.system.browser&&1===e.deltaMode)return _scrollTarget[axis]+=10*e[delta],_scrollInertia[axis]=10*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis]);if(Device.system.browser.includes(["chrome"])){let s=.25;return _scrollTarget[axis]+=e[delta]*s,_scrollInertia[axis]=e[delta]*s,_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}if("ie"==Device.system.browser)return _scrollTarget[axis]+=e[delta],_scrollInertia[axis]=e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}_scrollTarget[axis]+=e[delta],newDelta=_scrollInertia[axis]})),newDelta=Math.abs(newDelta),newDelta!=_lastDelta&&_deltaChange++,_this.flag("hardBlock")||(_deltaChange>3?newDelta>_lastDelta&&_this.flag("block",!1):newDelta>=_lastDelta&&_this.flag("block",!1)),_lastDelta=newDelta,_this.onUpdate&&_this.onUpdate(),_this.events.fire(Events.UPDATE,_scrollInertia),_this.events.fire(Scroll.EVENT,e)}function down(e){if(!_this.enabled)return;if(!checkBounds(e))return;let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));element&&checkIfProhibited(element)||(stopInertia(),_this.isDragging=!0)}function drag(e){if(!_this.enabled)return;if(!checkBounds(e))return;let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));element&&checkIfProhibited(element)||(_axes.forEach((axis=>{let newDelta=Math.abs(Mouse.delta[axis]);_this.flag("hardBlock")||newDelta>_lastDelta&&_this.flag("block",!1),_lastDelta=newDelta,_scrollTarget[axis]-=Mouse.delta[axis]})),_this.events.fire(Events.UPDATE))}function up(e){if(!_this.enabled||_this.preventInertia)return;if(!checkBounds(e))return;let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));if(element&&checkIfProhibited(element))return;const m="android"==Device.system.os?35:25,obj={};_axes.forEach((axis=>{obj[axis]=_scrollTarget[axis]-Mouse.delta[axis]*m})),tween(_scrollTarget,obj,2500,"easeOutQuint"),_this.isDragging=!1}function onKeyDown({key:key,shiftKey:shiftKey}){let dst=null;switch(key){case"Up":case"ArrowUp":dst=_scrollTarget.y-150;break;case"Down":case"ArrowDown":dst=_scrollTarget.y+150;break;case"Home":dst=0;break;case"End":dst=_this.max.y;break;case"PageUp":dst=_scrollTarget.y-Stage.height;break;case"PageDown":dst=_scrollTarget.y+Stage.height;break;case" ":case"Spacebar":onKeyDown(shiftKey?{key:"PageUp"}:{key:"PageDown"})}null!==dst&&_this.scrollTo(dst,"y",400,"easeOutCubic")}function resize(){if(!_this.enabled)return;if(stopInertia(),!_this.object)return;const p={};Device.mobile&&_axes.forEach((axis=>p[axis]=_this.max[axis]?_scrollTarget[axis]/_this.max[axis]:0)),void 0===_params.height&&(_this.max.y=_this.object.div.scrollHeight-_this.object.div.clientHeight),void 0===_params.width&&(_this.max.x=_this.object.div.scrollWidth-_this.object.div.clientWidth),Device.mobile&&_axes.forEach((axis=>_this[axis]=_scrollTarget[axis]=p[axis]*_this.max[axis]))}function checkBounds(e){return!_this.bounds||!(e.x/Stage.width>_this.bounds.x.y||e.x/Stage.width<_this.bounds.x.x||e.y/Stage.height>_this.bounds.y.y||e.y/Stage.height<_this.bounds.y.x)}!function initParams(){_object&&_object.div||(_params=_object,_object=null),_params||(_params={}),_this.object=_object,_this.hitObject=_params.hitObject||_this.object,_this.max.y=_params.height||0,_this.max.x=_params.width||0,_this.scale=_params.scale||1,_this.touchScale=_params.touchScale||1,_this.isDragging=!1,_this.drag=void 0!==_params.drag?_params.drag:!!Device.mobile,_this.mouseWheel=!1!==_params.mouseWheel,_this.limit="boolean"==typeof _params.limit&&_params.limit,_this.bounds=_params.bounds||null,_this.keyboard=_params.keyboard||!1,Array.isArray(_params.axes)&&(_axes=_params.axes)}(),_this.object&&function style(){_this.object.css({overflow:"auto"})}(),function addHandlers(){if(Device.mobile||("ie"===Device.system.browser&&Device.system.browserVersion>=17&&(document.body.addEventListener("pointermove",edgeScroll,!0),document.body.addEventListener("pointerup",edgeScrollEnd,!0)),"ie"==Device.system.browser?document.body.addEventListener("wheel",scroll,!0):__window.bind("wheel",scroll),_this.keyboard&&_this.events.sub(Keyboard.DOWN,onKeyDown)),_this.drag){_this.hitObject&&_this.hitObject.bind("touchstart",(e=>{let element=document.elementFromPoint(Math.clamp(e.x||0,0,Stage.width),Math.clamp(e.y||0,0,Stage.height));element&&checkIfProhibited(element)||e.preventDefault()}));let input=_this.hitObject?_this.initClass(Interaction,_this.hitObject):Mouse.input;_this.events.sub(input,Interaction.START,down),_this.events.sub(input,Interaction.DRAG,drag),_this.events.sub(input,Interaction.END,up)}_this.events.sub(Events.RESIZE,resize)}(),resize(),_this.startRender(loop),this.reset=function(){return _this.object&&_this.object.div&&(_this.object.div.scrollLeft=_this.x=0,_this.object.div.scrollTop=_this.y=0),_scrollTarget.x=_scrollTarget.y=0,_scrollInertia.x=_scrollInertia.y=0,stopInertia(),this},this.onDestroy=function(){__window.unbind("wheel",scroll),_this.events.unsub(Keyboard.DOWN,onKeyDown)},this.resize=resize,this.scrollTo=function(value,axis="y",time=800,ease="easeInOutCubic"){let values={};values[axis]=value,tween(_scrollTarget,values,time,ease)},this.setTarget=function(value,axis="y"){_scrollTarget[axis]=value},this.blockUntilNewScroll=function(){return _this.reset(),_this.flag("block",!0),_this.flag("hardBlock",!0,200),this},this.stopInertia=stopInertia}),(_=>{var _scroll;Scroll.EVENT="scroll_event",Scroll.createUnlimited=Scroll.getUnlimited=function(options){return _scroll||(_scroll=new Scroll({limit:!1,drag:Device.mobile})),_scroll}})),Class((function Shaders(){Inherit(this,Component);var _this=this,_dependencies;function parseSingleShader(code,fileName){let uniforms=code.split("#!UNIFORMS")[1].split("#!")[0],varyings=code.split("#!VARYINGS")[1].split("#!")[0],attributes=code.split("#!ATTRIBUTES")[1].split("#!")[0];for(;code.includes("#!SHADER");){let split=(code=code.slice(code.indexOf("#!SHADER"))).split("#!SHADER")[1],br=split.indexOf("\n"),name=split.slice(0,br).split(": ")[1];name.slice(0,6).includes("Vertex")&&(name=fileName.split(".")[0]+".vs"),name.slice(0,8).includes("Fragment")&&(name=fileName.split(".")[0]+".fs");let glsl=split.slice(br);glsl=name.includes(".vs")?attributes+uniforms+varyings+glsl:uniforms+varyings+glsl;let splitName=name.split(".");_this[splitName[0]+(splitName[1].includes("vs")?".vs":".fs")]=glsl,code=code.replace("#!SHADER","$")}}function parseCompiled(shaders){var split=shaders.split("{@}");split.shift();for(var i=0;i<split.length;i+=2){var name=split[i],text=split[i+1];text.includes("#!UNIFORMS")?parseSingleShader(text,name):_this[name]=text}}function parseRequirements(){for(var key in _this){var obj=_this[key];"string"==typeof obj&&(_this[key]=require(obj,key))}}function require(shader,key){if(!shader.includes("require"))return shader;for(shader=shader.replace(/# require/g,"#require");shader.includes("#require");){var name=shader.split("#require(")[1].split(")")[0];if(name=name.replace(/ /g,""),!_this[name])throw"Shader required "+name+", but not found in compiled shaders.\n"+shader;_dependencies&&(_dependencies[name]||(_dependencies[name]=[]),_dependencies[name].includes(key)||_dependencies[name].push(key)),shader=shader.replace("#require("+name+")",_this[name])}return shader}Hydra.LOCAL&&(_dependencies={}),this.get("dependencies",(_=>_dependencies)),this.parse=function(code,file){code.includes("{@}")?(parseCompiled(code),parseRequirements()):(file=(file=file.split("/"))[file.length-1],_this[file]=code),_this.shadersParsed=!0},this.parseSingle=parseSingleShader,this.onReady=this.ready=function(callback){let promise=Promise.create();return callback&&promise.then(callback),_this.wait((()=>promise.resolve()),_this,"shadersParsed"),promise},this.getShader=function(string){_this.FALLBACKS&&_this.FALLBACKS[string]&&(string=_this.FALLBACKS[string]);var code=_this[string];if(!code)throw`No shader ${string} found`;for(;code.includes("#test ");)try{var test=code.split("#test ")[1],name=test.split("\n")[0],glsl=code.split("#test "+name+"\n")[1].split("#endtest")[0];eval(name)||(code=code.replace(glsl,"")),code=code.replace("#test "+name+"\n",""),code=code.replace("#endtest","")}catch(e){throw"Error parsing test :: "+string}return code}}),"static"),Class((function ShadowInspector(_shadow){Inherit(this,Component);var _this=this;_shadow=_shadow.classRef||_shadow,function(){let rt=_shadow.light.shadow.rt,$obj=$gl(rt.width/4,rt.height/4,rt.texture);GLUI.Stage.add($obj);let shader=_this.initClass(Shader,"ShadowInspector",{tMap:{value:rt.texture}});$obj.useShader(shader)}()}));class Skin extends Mesh{constructor(geometry,shader,bones=geometry.bones){super(geometry,shader),this.isSkin=!0,this.createBones(bones),this.createBoneTexture(),this.animations=[],this.pingPong=-1,Object.assign(this.shader.uniforms,{boneTexture:{value:this.boneTextureA},boneTextureSize:{value:this.boneTextureSize}})}createBones(bonesData){this.root=new Base3D,this.bones=[],bonesData.forEach((data=>{const bone=new Base3D;bone.name=data.name,bone.position.set(...data.pos),bone.quaternion.set(...data.rot),bone.quaternion.normalize(),bone.scale.set(...data.scl),this.bones.push(bone)})),bonesData.forEach(((data,i)=>{if(-1===data.parent)return this.root.add(this.bones[i]);this.bones[data.parent].add(this.bones[i])})),this.root.updateMatrixWorld(!0),this.bones.forEach((bone=>{bone.bindInverse=(new Matrix4).copy(bone.matrixWorld),bone.bindInverse=bone.bindInverse.getInverse(bone.bindInverse)}))}createBoneTexture(){const size=Math.max(4,Math.pow(2,Math.ceil(Math.log(Math.sqrt(4*this.bones.length))/Math.LN2)));this.boneMatrices=new Float32Array(size*size*4),this.boneTextureSize=size,this.boneTextureA=new DataTexture(this.boneMatrices,size,size),this.boneTextureB=new DataTexture(this.boneMatrices,size,size),this.boneTextureC=new DataTexture(this.boneMatrices,size,size)}addAnimation(data){const animation=new SkinAnimation(this,data);return this.animations.push(animation),animation}async loadAnimation(path){path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),path=Thread.absolutePath(Assets.getPath(path));const data=await get(path);return this.addAnimation(data)}update(){let total=0;this.animations.forEach((animation=>total+=animation.weight)),this.animations.forEach(((animation,i)=>{animation.update(total||1,0===i)}))}updateMatrixWorld(force){switch(super.updateMatrixWorld(force),this.root.updateMatrixWorld(!0),this.bones.forEach(((bone,i)=>{Skin.tempMat4.multiplyMatrices(bone.matrixWorld,bone.bindInverse),this.boneMatrices.set(Skin.tempMat4.elements,16*i)})),this.pingPong++,this.pingPong>2&&(this.pingPong=0),this.pingPong){case 0:this.shader.uniforms.boneTexture.value=this.boneTextureA,Texture.renderer.manualUpdateDynamic(this.boneTextureB);break;case 1:this.shader.uniforms.boneTexture.value=this.boneTextureB,Texture.renderer.manualUpdateDynamic(this.boneTextureC);break;case 2:this.shader.uniforms.boneTexture.value=this.boneTextureC,Texture.renderer.manualUpdateDynamic(this.boneTextureA)}}}Skin.tempMat4=new Matrix4;class SkinAnimation{constructor(skin,data){this.skin=skin,this.data=data,this.elapsed=0,this.weight=1,this.duration=data.duration,this.data.skeleton.forEach((d=>{for(let j=0;j<d.keys.length;j++)SkinAnimation.tempRot.set(...d.keys[j].rot),SkinAnimation.tempRot.normalize(),d.keys[j].rot=SkinAnimation.tempRot.toArray()}))}update(totalWeight,isSet){const animationWeight=isSet?1:this.weight/totalWeight,numberKeys=this.duration+1,elapsed=this.elapsed%numberKeys;let prevKey,nextKey;this.data.skeleton.forEach(((d,i)=>{const prev=Math.floor(elapsed),next=Math.floor(elapsed+1)%numberKeys,weight=elapsed-prev;prevKey=d.keys[prev],nextKey=d.keys[next],SkinAnimation.tempPos.set(...prevKey.pos),SkinAnimation.tempRot.set(...prevKey.rot),SkinAnimation.tempScl.set(...prevKey.scl),SkinAnimation.tempPos2.set(...nextKey.pos),SkinAnimation.tempRot2.set(...nextKey.rot),SkinAnimation.tempScl2.set(...nextKey.scl),SkinAnimation.tempPos.lerp(SkinAnimation.tempPos2,weight,!1),SkinAnimation.tempRot.slerp(SkinAnimation.tempRot2,weight,!1),SkinAnimation.tempScl.lerp(SkinAnimation.tempScl2,weight,!1),this.skin.bones[i].position.lerp(SkinAnimation.tempPos,animationWeight,!1),this.skin.bones[i].quaternion.slerp(SkinAnimation.tempRot,animationWeight,!1),this.skin.bones[i].scale.lerp(SkinAnimation.tempScl,animationWeight,!1)}))}}SkinAnimation.tempPos=new Vector3,SkinAnimation.tempRot=new Quaternion,SkinAnimation.tempScl=new Vector3,SkinAnimation.tempPos2=new Vector3,SkinAnimation.tempRot2=new Quaternion,SkinAnimation.tempScl2=new Vector3,Class((function SnapshotFrame(_texture,_options={}){Inherit(this,FXScene);const _this=this;var _mesh;if(_texture.isAppState){let params=_texture;(_options=params).nuke=_this.parent.nuke||params.nuke,_texture=params.texture}else _options.nuke||!_texture.nuke||_texture instanceof FXLayer||(_options.nuke=_texture.nuke),_options.nuke||(_options.nuke=World.NUKE);function loop(){World.RENDERER.renderSingle(_mesh,_this.nuke.camera,_this.rt)}!function(){_options.uniforms||(_options.uniforms={}),_this.create(_options.nuke,_options),_this.preventRender=!0;let shader=_this.initClass(Shader,_options?.shaderName||"SnapshotFrame",{tMap:{value:_texture},..._options.uniforms,depthWrite:!1});_this.shader=shader,(_mesh=new Mesh(World.QUAD,shader)).frustumCulled=!1,_this.startRender(loop,_options.nuke)}()})),Class((function SnapshotFramePingPong(_fxScene){Inherit(this,Component);const _this=this;let _rtClone;function loop(){_this.rt||(_this.rt=_fxScene.rt),_this.rt&&!_rtClone&&(_rtClone=_this.rt.clone()),_this.rt&&_rtClone&&(_this.rt.width===_rtClone.width&&_this.rt.height===_rtClone.height||_rtClone.setSize(_this.rt.width,_this.rt.height),[_rtClone,_this.rt]=[_this.rt,_rtClone],_fxScene.useRT(_this.rt))}_this.rt=_fxScene.rt,_this.rt&&(_rtClone=_this.rt.clone()),_this.startRender(loop,_fxScene.nuke)})),Class((function SplineGen(){Inherit(this,Component);const _this=this;var _file,_subdivide=100;async function exec(){if(_this.flag("building"))return;_this.flag("building",!0);let json=await get(_file),array=[],generator=_this.initClass(Generator,json),data=await generator.exec();array=[...array,...data];let output=_file.split(".js").join("-SPLINES.js");Dev.writeFile(output+"?compress",array),alert("Conversion complete!"),_this.flag("building",!1)}function Generator(_data){Inherit(this,Component);var _animation;const COUNT=_subdivide;var _groups=[];function connect(hierarchy){let array=[];for(let i=0;i<hierarchy.length;i++){let group=new Group;array.push(group),i>0&&_groups.push(group)}return array}_animation=this.initClass(HierarchyAnimation,_data,connect),this.exec=async function(){await _animation.ready();let results=[];return _groups.forEach(((group,index)=>{let array=[];for(let i=0;i<COUNT;i++){_animation.elapsed=(i+1)/COUNT,_animation.update();let pos=group.position.toArray();array.push(Number(pos[0].toFixed(2)),Number(pos[1].toFixed(2)),Number(pos[2].toFixed(2)))}results.push(array),console.log((index+1)/_groups.length)})),results}}!function(){let folder=new UILFolder("splinegen",{label:"Spline Gen",closed:!0});UIL.global.add(folder);let number=new UILControlNumber("subdivide",{value:100,step:1});folder.add(number),number.onChange((v=>{_subdivide=v,console.log(_subdivide)}));let file=new UILControlFile("splinegen_file",{label:"File"});file.onFinishChange((e=>{_file=e.src})),folder.add(file);let button=new UILControlButton("button",{actions:[{title:"Run",callback:exec}],hideLabel:!0});folder.add(button)}()})),Class((function SplineLoader(){Inherit(this,Component);var _promises={};function packSplineInTexture({path:path},id){(async _=>{let json=await get(path),splines=json.length,count=splines*json[0].length,textureSize=(num=>{let values=[2,4,8,16,32,64,128,256,512,1024,2048,4096];for(let i=0;i<values.length;i++){var p2=values[i];if(p2*p2>=num)return p2}})(count),flat=json.flat(),perSpline=json[0].length/3,array=new Float32Array(textureSize*textureSize*3);for(let i=0;i<count;i++)array[i]=flat[i];resolve({array:array,splines:splines,perSpline:perSpline,textureSize:textureSize},id,[array.buffer])})()}function loadStaticSpline({path:path,particleCount:particleCount},id){(async _=>{let output=new Float32Array(4*Math.pow((num=>{let values=[2,4,8,16,32,64,128,256,512,1024,2048,4096];for(let i=0;i<values.length;i++){var p2=values[i];if(p2*p2>=num)return p2}})(particleCount),2)),json=await get(path);json=json.curves;let v3=new Vector3,v30=new Vector3,v31=new Vector3,total=0;for(let i=0;i<json.length;i++)total+=json[i].length/3;let index=0;for(let i=0;i<json.length;i++){let data=json[i],jsonCount=data.length/3,weight=jsonCount/total,count=Math.round(weight*particleCount);for(let j=0;j<count;j++){let i0=Math.random(0,jsonCount-2),i1=i0+1;v30.set(data[3*i0+0],data[3*i0+1],data[3*i0+2]),v31.set(data[3*i1+0],data[3*i1+1],data[3*i1+2]),v3.copy(v30).lerp(v31,Math.random()),output[4*index+0]=v3.x,output[4*index+1]=v3.y,output[4*index+2]=v3.z,index++}}resolve({array:output},id,[output.buffer])})()}!async function(){await Hydra.ready(),Thread.upload(packSplineInTexture),Thread.upload(loadStaticSpline)}(),this.load=function(path){if(_promises[path])return _promises[path];let promise=_promises[path]=Promise.create();return"/"==path.charAt(0)&&(path=path.slice(1)),path.includes("assets/geometry")||(path="assets/geometry/"+path),path.includes(".json")||(path+=".json"),path=Hydra.absolutePath(Assets.getPath(path)),Thread.shared().packSplineInTexture({path:path}).then((data=>{data.texture=new DataTexture(data.array,data.textureSize,data.textureSize,Texture.RGBFormat,Texture.FLOAT),promise.resolve(data)})),promise},this.loadStatic=function(path,particleCount){if(_promises[path])return _promises[path];let promise=_promises[path]=Promise.create();return"/"==path.charAt(0)&&(path=path.slice(1)),path.includes("assets/geometry")||(path="assets/geometry/"+path),path.includes(".json")||(path+=".json"),path=Hydra.absolutePath(Assets.getPath(path)),Thread.shared().loadStaticSpline({path:path,particleCount:particleCount}).then((data=>{promise.resolve(data.array)})),promise}}),"static"),Class((function SplineParticles(_proton,_group,_input){Inherit(this,Component);const _this=this;var _config,_life;async function initFile(file){if(file||(file=_this.parent.data&&_this.parent.data.splineFile?_this.parent.data.splineFile:_config.get("json")),!file)return _proton.visible=_proton.group.visible=!1;let data="string"==typeof file?await SplineLoader.load(file):file;_proton.behavior.addUniforms({tSpline:{value:data.texture,ignoreUIL:!0},uSplineTexSize:{value:data.textureSize,ignoreUIL:!0},uPerSpline:{value:data.perSpline,ignoreUIL:!0},uSplineCount:{value:data.splines,ignoreUIL:!0},uSetup:{value:1,ignoreUIL:!0}}),await async function initLifeBehavior(){let pass=_this.initClass(AntimatterPass,"SplineParticleLife",{unique:_input.prefix,uMaxCount:_proton.behavior.uniforms.uMaxCount,uSplineCount:_proton.behavior.uniforms.uSplineCount,uSetup:_proton.behavior.uniforms.uSetup,tAttribs:_proton.behavior.uniforms.tAttribs,tOrigin:_proton.behavior.uniforms.tOrigin,uDecayRate:{value:0},uDecayRange:{value:new Vector2(1,1)},uFlowRange:{value:new Vector2(1,1)},uSplineSpeed:{value:new Vector2(1,1)},uTimeMultiplier:{value:1},uStartOffset:{value:0},uStartSpacing:{value:0},uDelayStart:{value:0,ignoreUIL:!0},uIHold:{value:0,ignoreUIL:!0},uMaxDelay:{value:0},uMaxSDelay:{value:0},uHoldBack:{value:0},uHoldBack2:{value:0,ignoreUIL:!0},uInfinite:{value:_config.get("infinite")?1:0,ignoreUIL:!0},uRelease:{value:new Vector2(0,1),ignoreUIL:!0},uLifeSlow:{value:new Vector4(1,1,1,1)},HZ:{value:Render.HZ_MULTIPLIER,ignoreUIL:!0}});ShaderUIL.add(pass,_group).setLabel("Life"),pass.addInput("tPos",_proton.behavior.output),_proton.antimatter.addPass(pass,0),_proton.behavior.addInput("tLife",pass.output),_this.life=_life=pass}(),_config.onUpdate=key=>{"infinite"==key&&_life.setUniform("uInfinite",_config.get("infinite")?1:0)},_proton.behavior.setUniform("uSetup",1),_life.setUniform("uSetup",1),_proton.behavior.onInit=_=>{_this.delayedCall((_=>{_proton.behavior.setUniform("uSetup",0),_life.setUniform("uSetup",0),_this.flag("setup",!0)}),100)},_proton.shader.addUniforms({uSplineCount:{value:data.splines,ignoreUIL:!0},tLifeData:{value:_life.output,ignoreUIL:!0},tSpline:{value:data.texture,ignoreUIL:!0},uSplineTexSize:{value:data.textureSize,ignoreUIL:!0},uPerSpline:{value:data.perSpline,ignoreUIL:!0}}),_this.flag("setup",!0)}!function initConfig(){(_config=InputUIL.create(_input.prefix+"SplineConfig",_group)).setLabel("Spline Config"),_config.add("json"),_config.addToggle("infinite")}(),initFile(),this.loadFile=initFile,this.loadConfig=function(fromKey,toKey){let copyConfig=InputUIL.create(fromKey.split("P_")[1]+"SplineConfig",null);_config.copyFrom(copyConfig,["json","infinite"]);let baseFromKey=`am_SplineParticleLife_${fromKey.split("P_")[1]}`,baseToKey=`am_SplineParticleLife_${toKey.split("P_")[1]}`;["uDecayRate","uDecayRange","uFlowRange","uSplineSpeed","uTimeScale","uStartOffset","uMaxDelay","uMaxSDelay","uHoldBack"].forEach((name=>{let val=UILStorage.get(baseFromKey+name);val&&UILStorage.set(baseToKey+name,val)}))},this.saveValues=function(){return _life.shader},this.ready=function(){return _this.wait("setup")},this.release=async function(){await _this.wait("life");let v=_life.uniforms.uRelease.value;++v.x>=v.y&&(v.x=0),_life.setUniform("uIHold",0),_life.setUniform("uDelayStart",World.RENDERER.time.value)},this.hold=async function(){await _this.wait("life"),_life.setUniform("uDelayStart",9999999999),_life.setUniform("uIHold",1)},this.loop=async function(){await _this.wait("life"),_proton.behavior.setUniform("uInfinite",1),_life.setUniform("uInfinite",1)},this.reset=async function(){await _this.wait("life"),_proton.behavior.setUniform("uSetup",1),_life.setUniform("uSetup",1),await _this.wait(100),_proton.behavior.setUniform("uSetup",0),_life.setUniform("uSetup",0)},this.set("releaseSections",(async v=>{await _this.wait("life"),_life.uniforms.uRelease.value.y=v})),this.set("holdBack",(async v=>{await _this.wait("life"),_life.uniforms.uHoldBack2.value=v})),this.get("splineJSON",(_=>_config.get("json")))}),(_=>{Shaders.ready().then((_=>{ProtonPresets.register("Spline",(input=>{let shader=Shaders.getShader("SplineParticlePreset.fs");shader=shader.split("void main() {")[1].slice(0,-1);let code="#require(curl.glsl)\n#require(splineparticles.fs)\n"+shader;input.setValue("uniforms","\n            uSplineThickness: 1\n            uThicknessStep: [1, 1]\n            uThicknessSpeed: 0\n            uRangeThickness: 0\n            uRangeScale: 1\n            uDistribution: 1\n            uDistributionRange: [1, 1]\n            uExtrudeRandom: 1\n            uSCurlNoiseScale: 1\n            uSCurlTimeScale: 0\n            uSCurlNoiseSpeed: 0\n            "),input.get("code")||input.setValue("code",code)}))}))})),Class((function SplineParticlesStatic(_proton,_group,_input){Inherit(this,Component);const _this=this;var _config;!function initConfig(){_proton.antimatter.preventRender=!0,(_config=InputUIL.create(_input.prefix+"SplineConfig",_group)).setLabel("Spline Config"),_config.add("json")}(),async function initFile(){let file=_config.get("json");if(!file)return;let data=await SplineLoader.loadStatic(file,_proton.particleCount);_proton.antimatter.vertices.bufferData(data,4),_proton.antimatter.preventRender=!1,_this.flag("initialized",!0)}(),this.loaded=function(){return _this.wait("initialized")}}),(_=>{Hydra.ready().then((_=>{Proton.forceCloneVertices.push("SplineParticlesStatic")}))})),Class((function Text3D(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_fontObject,$text;this.translate=new Vector3,this.rotate=new Vector3;var _mouse=new Vector2;function initUIL(){(_config=InputUIL.create(_input.prefix+"_text3d",_group)).setLabel("Text3D"),_config.addTextarea("text").addTextarea("fontStyle"),_config.addToggle("anchor2D",!1),_config.addToggle("renderRetina",!1),_config.add("data","hidden"),UIL.sidebar&&(_config.onUpdate=key=>{if("data"!=key){let text=parseData(_config.get("text")),obj=getFontObject();_config.setValue("data",JSON.stringify(obj)),$text&&($text.setText(text,obj),obj.color&&$text.setColor(obj.color)),_this.onUpdate&&_this.onUpdate()}})}function parseData(text){if(!text||!text.includes("$DATA"))return text;for(;text.includes("$DATA");){let code=text.split("$DATA")[1].split(" ")[0].split("\n")[0],line="$DATA"+code;text=text.replace(line,eval(line.replace("$DATA","_this.parent.data")))}return text}function getFontObject(){let font=_config.get("fontStyle")||"",obj={};return font=font.split("\n"),font.forEach((line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val),"false"===val&&(obj[key]=!1),"true"===val&&(obj[key]=!0))})),obj}function initText(){if(!(_fontObject=JSON.parse(_config.get("data")||"{}")).size)return;Text3D.FONT_CONFIG&&(_fontObject.config=Text3D.FONT_CONFIG),Text3D.LANG_BREAK&&(_fontObject.langBreak=Text3D.LANG_BREAK),_fontObject.shader||(_fontObject.shader="Text3D");let text=parseData(_config.get("text"));text&&createText(text,_fontObject)}async function overrideLocalize(text,fontObject,cb){if(!text)return;_this.localized=!0,fontObject.text=text,_this.text&&_this.text.destroy&&_this.text.destroy(),_this.text=new Text3D.FallbackText,_this.text.setColor(_fontObject.color),_this.text.onSetText=text=>_this.setText(text);Text3D.createFallbackTexture(text,fontObject).then((texture=>{_this.text.setColor(fontObject.color);let geom=new PlaneGeometry(texture.width,texture.height);for(geom.computeBoundingBox(),"center"!=fontObject.align&&geom.applyMatrix((new Matrix4).makeTranslation(texture.width/2,0,0));_this.group.children.length;)_this.group.remove(_this.group.children[0]);return _this.text.createMesh(geom,texture),_this.add(_this.text.group),_this.text}))}function createText(text,fontObject){if((fontObject.localize||_input.forceLocalize)&&Text3D.missingChars(text,fontObject))return overrideLocalize(text,fontObject);($text=$glText(text,null,null,fontObject)).enable3D(_config.get("anchor2D")),GLUIUtils.setRetinaMode($text,_config.get("renderRetina"),_this),$text.text.onCreateShader=shader=>{let shaderName=_input.get("shader");shaderName&&(shader.fragmentShader?.length&&(shader.fragmentShader=shader.fragmentShader.split("void main")[0]+"\n"+Shaders.getShader(shaderName+".fs")),shader.customCompile=shaderName),$text.text3d=_this,window[shaderName]&&(_this.shaderClass=_this.parent.initClass(window[shaderName],$text,shader,_group,_input),ShaderUIL.add(shader,_group).setLabel("Shader"))},_this.text=$text;let setText=$text.setText.bind($text);$text.setText=function(text,obj){if(obj)for(let key in obj)_fontObject[key]=obj[key];_fontObject.text=text,setText(text,_fontObject),_this.events.fire(Events.UPDATE),defer(setUniforms)},$text.loaded().then((_=>{if(!$text)return;_this.shader=$text.mesh.shader,_this.shader.addUniforms({uTransition:{value:1,ignoreUIL:!0},uOpacity:{value:1,ignoreUIL:!0},uTranslate:{value:_this.translate},uRotate:{value:_this.rotate},uWordCount:{value:0,ignoreUIL:!0},uLetterCount:{value:0,ignoreUIL:!0},uLineCount:{value:0,ignoreUIL:!0},uByWord:{value:0,ignoreUIL:!0},uByLine:{value:0,ignoreUIL:!0},uMouse:{value:_mouse,ignoreUIL:!0},uPadding:{value:.3,ignoreUIL:!0},uScrollDelta:{value:0,ignoreUIL:!0},uBoundingMin:{value:(new Vector3).copy($text.dimensions.min),ignoreUIL:!0},uBoundingMax:{value:(new Vector3).copy($text.dimensions.max),ignoreUIL:!0}}),MouseFluid.instance().applyTo(_this.shader);let scroll=Scroll.createUnlimited();_this.startRender((_=>{_this.shader.uniforms.uScrollDelta.value=Math.lerp(.1*scroll.delta.y,_this.shader.uniforms.uScrollDelta.value,.05)})),Text3D.onCreateShader&&Text3D.onCreateShader(_this.shader)})),setUniforms()}async function setUniforms(){if(await _this.wait(_this,"shader"),await $text.loaded(),_input&&_input.get){let depthWrite=_input.get("depthWrite"),depthTest=_input.get("depthTest");"boolean"==typeof depthWrite&&($text.mesh.shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&($text.mesh.shader.depthTest=depthTest);let blending=_input.get("blending");blending&&($text.mesh.shader.blending=blending)}_this.shader.set("uWordCount",$text.mesh.geometry.wordCount),_this.shader.set("uLetterCount",$text.mesh.geometry.letterCount),_this.shader.set("uLineCount",$text.mesh.geometry.lineCount),_this.shader.set("uBoundingMin",(new Vector3).copy($text.dimensions.min)),_this.shader.set("uBoundingMax",(new Vector3).copy($text.dimensions.max))}_this.wildcard=_input.get("wildcard"),async function(){_this.group.text=_this,initUIL(),initText(),Text3D.onCreate&&Text3D.onCreate(_this),_this.startRender((_=>{_mouse.lerp(Mouse.normal,.2)}))}(),this.get("fontObject",(_=>_fontObject)),this.setProperties=function(obj){return obj={..._fontObject,...obj},$text?($text.setText(obj.text,obj),setUniforms()):createText(obj.text,obj),_this.text.loaded()},this.setPropertiesCheck=function(obj,force){let applyProperties=!1;for(const key in obj)_fontObject[key]!==obj[key]&&(applyProperties=!0,_fontObject[key]=obj[key]);return applyProperties||force?_this.setProperties():Promise.resolve()},this.setText=function(text){if(_fontObject.text=text,$text){if(_fontObject.localize&&Text3D.missingChars(text,_fontObject))return _this.group.remove($text.group),_this.shader=void 0,$text=null,void createText(text,_fontObject);$text.setText(text),setUniforms(),$text.mesh&&($text.mesh.onBeforeRender(),$text.mesh.updateMatrixWorld(!0))}else createText(text,_fontObject)},this.setColor=function(color){_fontObject.color=color,_this.text&&_this.text.setColor(color)},this.set("animateByWord",(async bool=>{_this.localized||(await _this.wait(_this,"shader"),_this.shader.set("uByWord",bool?1:0))})),this.set("animateByLine",(async bool=>{_this.localized||(await _this.wait(_this,"shader"),_this.shader.set("uByLine",bool?1:0))})),this.set("animationPadding",(async p=>{_this.localized||(await _this.wait(_this,"shader"),_this.shader.set("uPadding",p))})),this.set("transition",(async v=>{if(_this.localized)return _this.text.alpha=v;await _this.wait(_this,"shader"),_this.shader.set("uTransition",v)})),this.tween=async function(val,time,ease,delay){return _this.localized?_this.text.tween(val,time,ease,delay):(await _this.wait(_this,"shader"),_this.shader.tween("uTransition",val,time,ease,delay))},this.upload=function(){$text&&$text.upload()},this.ready=function(){return _this.wait(_this,"shader")},this.set("renderOrder",(v=>{$text&&($text.setZ(v),$text.seoSortOrder=v)})),this.getDimensions=async _=>(await $text.loaded(),await $text.text.ready(),$text.dimensions)}),(_=>{var _projection;Text3D.missingChars=function(){return!1},Text3D.measureScreen=async function($text,camera=World.CAMERA,z=0){_projection||(_projection=new ScreenProjection(World.CAMERA)),$text instanceof Text3D&&($text=$text.text),await $text.loaded(),$text.mesh.onBeforeRender(),$text.mesh.updateMatrixWorld(!0),await defer(),_projection.camera=camera;let bb=new Box3;bb.setFromObject($text.mesh),bb.min.z=bb.max.z=z;let min=_projection.project(bb.min).clone(),max=_projection.project(bb.max).clone();return{width:Math.abs(min.x-max.x),height:Math.abs(min.y-max.y)}}})),Class((function UI3D(_name=""){Inherit(this,Component);const _this=this,_rtSize=new Vector2,_captureUnitSize=new Vector2;if(this.create=function(width=512,height=512,dpr,data){_rtSize.set(width,height),_captureUnitSize.set(width>height?1:width/height,width>height?height/width:1),"number"!=typeof dpr&&(data=dpr,dpr=void 0),data?(_this.layout=_this.initClass(StageLayout,Utils.getConstructorName(_this)+_name,{glui:!0,data:data,noGraph:!_this.isPlayground()}),_this.root=_this.layout.element,_this.capture=_this.initClass(StageLayoutCapture,_this.layout,width,height,UI3D.getRTPool(width,height,dpr))):(_this.capture=_this.initClass(GLUITexture,width,height,UI3D.getRTPool(width,height,dpr)),_this.root=_this.capture.root),_this.root.capture=_this.capture,_this.$gluiObject=$gl(_captureUnitSize.x,_captureUnitSize.y,_this.capture),_this.capture.object3d=_this.$gluiObject},this.setSize=function(size){const fillRatio=(new Vector2).copy(size).divide(_rtSize);fillRatio.divideScalar(Math.max(fillRatio.x,fillRatio.y,1)),_captureUnitSize.set(size.x>size.y?1:size.x/size.y,size.x>size.y?size.y/size.x:1),_captureUnitSize.multiplyScalar(Math.max(fillRatio.x,fillRatio.y)),_this.capture.setSize(size.x,size.y),_this.$gluiObject.size(_captureUnitSize.x,_captureUnitSize.y)},this.useShader=function(shader){_this.$gluiObject.useShader(shader)},this.ready=function(){return _this.wait(_this,"isReady")},this.hide=function(){_this.capture.visible=!1,_this.capture.enabled=!1,_this.capture.scene.visible=!1,_this.$gluiObject.hide(),_this.capture.mouseEnabled=!1},this.show=function(){_this.capture.visible=!0,_this.capture.enabled=!0,_this.capture.scene.visible=!0,_this.$gluiObject.show(),_this.capture.mouseEnabled=!0},this.linkMesh=function(mesh,test){_this.hide(),_this.startRender((_=>{let drawing=mesh._drawing;drawing&&test&&(drawing=test()),drawing?_this.flag("drawing")||(_this.flag("drawing",!0),_this.show()):_this.flag("drawing")&&(_this.flag("drawing",!1),_this.hide())}),24)},"object"==typeof _name&&_name.isAppState){let props=_name;_name=props.name,null==props.dpr&&(props.dpr=1),props.width&&props.height&&this.create(props.width,props.height,props.dpr,props.data)}}),(_=>{var _pools={};UI3D.getRTPool=function(width,height,dpr=World.DPR){let key=width+" "+height;return _pools[key]||(_pools[key]=RTPool.instance().clone(Texture.UNSIGNED_BYTE,3,Texture.RGBAFormat),_pools[key].setSize(width*dpr,height*dpr)),_pools[key]},UI3D.findStageLayoutCapture=function(p){for(;p;){if(p.capture)return p.capture;p=p.parent}}})),Class((function UI3DLayer(_input,_group,_id){Inherit(this,Object3D);const _this=this;var _config,_obj;function completeShader(shader){let transparent=_input.get("transparent"),depthWrite=_input.get("depthWrite"),depthTest=_input.get("depthTest"),blending=_input.get("blending"),castShadow=_input.get("castShadow"),side=_input.get("side"),receiveShadow=_input.get("receiveShadow"),renderOrder=_input.getNumber("renderOrder");"boolean"==typeof depthWrite&&(shader.depthWrite=shader.mesh.depthWrite=depthWrite),"boolean"==typeof depthTest&&(shader.depthTest=shader.mesh.depthTest=depthTest),"boolean"==typeof transparent&&(shader.transparent=transparent),"boolean"==typeof castShadow&&(shader.mesh.castShadow=castShadow),"boolean"==typeof receiveShadow&&(shader.receiveShadow=receiveShadow),"number"==typeof renderOrder&&(shader.mesh.renderOrder=renderOrder),blending&&(shader.blending=blending),side&&(shader.side=side)}(function(){_config=InputUIL.create(_input.prefix+"ui3d",_group),_config.add("class"),_config.add("visibilityTest"),_config.addToggle("retina"),_config.setLabel("Config");let testString=_config.get("visibilityTest");if(testString&&testString.length&&!eval(testString))return;let className=_config.get("class");if(!className||0==_input.get("visible"))return;let wildcard=_input.get("wildcard");if(!window[className])throw`UI3DLayer :: ${className} doesn't exist!`;let obj=_this.initClass(window[className],{data:wildcard,uil:{input:_input,group:_group,id:_id}});if(!obj.$gluiObject)throw`UI3DLayer :: ${className} not instance of UI3D (or create() hasn't been called)`;completeShader(obj.$gluiObject.shader),GLUIUtils.setRetinaMode(obj.$gluiObject,_config.get("retina")||UI3DLayer.overrideRetina,_this),GLUIUtils.isRetinaMode(obj.$gluiObject)?_this.flag("retina",!0):obj.$gluiObject.enable3D(),_obj=obj})(),_this.getObject=function(){return _obj},this.onDestroy=function(){_this.flag("retina")&&GLUI.Scene.remove(_obj.$gluiObject)},_this.get("renderOrder",(()=>_obj?.$gluiObject.shader.mesh.renderOrder)),_this.set("renderOrder",(renderOrder=>{_obj&&(_obj.$gluiObject.shader.mesh.renderOrder=renderOrder)}))})),Class((function UIL(){Inherit(this,Component);const _this=this;let _style,$el,_ui={};Hydra.ready((async _=>{if(await UILStorage.ready(),!Utils.query("editMode")&&!(Hydra.LOCAL&&window.Platform&&window.Platform.isDreamPlatform&&Utils.query("uil"))&&(!Hydra.LOCAL||Device.mobile||window._BUILT_||!Utils.query("uil")&&!Device.detect("hydra")))return function doNotLoad(){Hydra.LOCAL&&UILSocket.remoteUIL&&(_this.sidebar=_this.global=new UILPanel({title:"null"}))}();!async function init(){(function initContainer(){$el=$("UIL"),$el.css({position:"fixed",contain:"strict",top:0}).size("100%","100%").mouseEnabled(!1),document.body.insertAdjacentElement("beforeend",$el.div),$el.setZ(1e5)})(),function initStyle(){let initial='\n.UIL {\n  /********** Range Input Styles **********/\n  /*Range Reset*/\n  /* Removes default focus */\n  /***** Chrome, Safari, Opera and Edge Chromium styles *****/\n  /* slider track */\n  /* slider thumb */\n  /******** Firefox styles ********/\n  /* slider track */\n  /* slider thumb */\n}\n.UIL {\n  --color-black: #000000;\n  --color-white: #ffffff;\n  --color-neutral-0: var(--color-black);\n  --color-neutral-10: #161616;\n  --color-neutral-20: #272727;\n  --color-neutral-30: #303030;\n  --color-neutral-40: #363636;\n  --color-neutral-70: #737373;\n  --color-neutral-80: #8b8c8a;\n  --color-neutral-90: #cccccc;\n  --color-neutral-100: var(--color-white);\n  --color-accent-50: #1a6dea;\n  --color-accent-60: #3787ff;\n  --color-accent-80: #79aeff;\n  --color-error-60: #e64040;\n  --color-error: var(--color-error-60);\n  --color-highlight: var(--color-accent-50);\n  --color-hightlight-light: var(--color-accent-60);\n  --color-highlight-transparent: rgba(26, 109, 234, 0.24);\n  --font-color-base: var(--color-white);\n  --font-color-highlight: var(--color-accent-80);\n  --color-action: var(--color-highlight);\n  --color-action--alt: var(--color-hightlight-light);\n  --color-action--contrast: var(--color-white);\n  --color-action--disabled: var(--color-neutral-70);\n  --color-icon-default: var(--color-neutral-70);\n  --color-divider-main: var(--color-neutral-40);\n  --panel-background-color: var(--color-neutral-10);\n  --font-primary: "Manrope", Helvetica Neue, Helvetica, sans-serif;\n  --font-secondary: var(--font-primary);\n  --font-tertiary: Courier New, Courier, Lucida Sans Typewriter,\n    Lucida Typewriter, monospace;\n  --font-size-base: 12px;\n  --font-family: var(--font-primary);\n  --label1: normal 400 10px/120% var(--font-primary);\n  --label2: normal 400 11px/130% var(--font-primary);\n  --label3: normal 400 12px/130% var(--font-primary);\n  --label3-semi: normal 600 11px/130% var(--font-primary);\n  --label3-bold: normal 700 11px/130% var(--font-primary);\n  --label4-medium: 500 12px/15px var(--font-primary);\n  --line-height: 1.3;\n  --border-radius: 8px;\n  --spacing: 10px;\n  --spacing-small: 8px;\n  --border-width: 1px;\n  --border: var(--border-width) solid var(--color-neutral-40);\n  --focus-outline-width: 1px;\n  --focus-outline-offset: 0;\n  --focus-outline: var(--focus-outline-width) solid var(--color-action);\n  --duration: 300ms;\n  --timing: ease-out;\n}\n.UIL *,\n.UIL :after,\n.UIL :before {\n  background-repeat: no-repeat;\n  box-sizing: inherit;\n}\n.UIL :after,\n.UIL :before {\n  text-decoration: inherit;\n  vertical-align: inherit;\n}\n.UIL hr {\n  color: inherit;\n  height: 0;\n  overflow: visible;\n}\n.UIL details,\n.UIL main {\n  display: block;\n}\n.UIL summary {\n  display: list-item;\n}\n.UIL small {\n  font-size: 80%;\n}\n.UIL ul,\n.UIL ol {\n  list-style: none;\n  padding-left: 0;\n}\n.UIL [hidden] {\n  display: none;\n}\n.UIL abbr[title] {\n  border-bottom: none;\n  text-decoration: underline;\n  -webkit-text-decoration: underline dotted;\n          text-decoration: underline dotted;\n}\n.UIL a {\n  background-color: transparent;\n}\n.UIL a:active,\n.UIL a:hover {\n  outline-width: 0;\n}\n.UIL code,\n.UIL kbd,\n.UIL pre,\n.UIL samp {\n  font-family: monospace, monospace;\n}\n.UIL pre {\n  font-size: 1em;\n}\n.UIL b,\n.UIL strong {\n  font-weight: bolder;\n}\n.UIL sub,\n.UIL sup {\n  font-size: 75%;\n  line-height: 0;\n  position: relative;\n  vertical-align: baseline;\n}\n.UIL sub {\n  bottom: -0.25em;\n}\n.UIL sup {\n  top: -0.5em;\n}\n.UIL table {\n  border-color: inherit;\n  text-indent: 0;\n}\n.UIL iframe {\n  border-style: none;\n}\n.UIL [type=number]::-webkit-inner-spin-button,\n.UIL [type=number]::-webkit-outer-spin-button {\n  height: var(--spacing);\n  position: absolute;\n  right: 0;\n  top: 50%;\n  -webkit-transform: translateY(-50%);\n          transform: translateY(-50%);\n}\n.UIL [type=search] {\n  -webkit-appearance: textfield;\n  outline-offset: -2px;\n}\n.UIL [type=search]::-webkit-search-decoration {\n  -webkit-appearance: none;\n}\n.UIL textarea {\n  overflow: auto;\n  resize: vertical;\n}\n.UIL optgroup {\n  font-weight: 700;\n}\n.UIL button {\n  overflow: visible;\n}\n.UIL button,\n.UIL select {\n  text-transform: none;\n}\n.UIL [role=button],\n.UIL [type=button],\n.UIL [type=reset],\n.UIL [type=submit],\n.UIL button {\n  cursor: pointer;\n}\n.UIL [type=button]::-moz-focus-inner,\n.UIL [type=reset]::-moz-focus-inner,\n.UIL [type=submit]::-moz-focus-inner,\n.UIL button::-moz-focus-inner {\n  border-style: none;\n  padding: 0;\n}\n.UIL [type=button]::-moz-focus-inner,\n.UIL [type=reset]::-moz-focus-inner,\n.UIL [type=submit]::-moz-focus-inner,\n.UIL button:-moz-focusring {\n  outline: 1px dotted ButtonText;\n}\n.UIL [type=reset],\n.UIL [type=submit],\n.UIL button,\n.UIL html [type=button] {\n  -webkit-appearance: button;\n}\n.UIL a:focus,\n.UIL button:focus,\n.UIL input:focus,\n.UIL select:focus,\n.UIL textarea:focus {\n  outline-width: 0;\n}\n.UIL select {\n  -moz-appearance: none;\n  -webkit-appearance: none;\n}\n.UIL select::-ms-expand {\n  display: none;\n}\n.UIL select::-ms-value {\n  color: currentColor;\n}\n.UIL legend {\n  border: 0;\n  color: inherit;\n  display: table;\n  max-width: 100%;\n  white-space: normal;\n}\n.UIL ::-webkit-file-upload-button {\n  -webkit-appearance: button;\n  color: inherit;\n  font: inherit;\n}\n.UIL [disabled] {\n  cursor: default;\n}\n.UIL img {\n  border-style: none;\n}\n.UIL progress {\n  vertical-align: baseline;\n}\n.UIL [aria-busy=true] {\n  cursor: progress;\n}\n.UIL [aria-controls] {\n  cursor: pointer;\n}\n.UIL [aria-disabled=true] {\n  cursor: default;\n}\n.UIL button,\n.UIL [type=button],\n.UIL [type=reset],\n.UIL [type=submit] {\n  -webkit-appearance: none;\n          appearance: none;\n  background-color: transparent;\n  border: var(--border);\n  border-color: var(--color-white);\n  border-radius: calc(var(--border-radius) * 1.5);\n  color: var(--color-action) --contrast;\n  cursor: pointer;\n  display: inline-block;\n  font: var(--label4-medium);\n  padding: calc(var(--spacing-small) * 1.5) calc(var(--spacing) * 2);\n  text-align: center;\n  text-decoration: none;\n  transition: background-color var(--duration) var(--timing);\n  -webkit-user-select: none;\n      -ms-user-select: none;\n          user-select: none;\n  vertical-align: middle;\n  white-space: nowrap;\n}\n.UIL button:hover,\n.UIL [type=button]:hover,\n.UIL [type=reset]:hover,\n.UIL [type=submit]:hover {\n  background-color: var(--color-action);\n  border-color: var(--color-action);\n}\n.UIL button:focus,\n.UIL [type=button]:focus,\n.UIL [type=reset]:focus,\n.UIL [type=submit]:focus {\n  outline: var(--focus-outline);\n  outline-offset: var(--focus-outline-offset);\n}\n.UIL button:disabled,\n.UIL [type=button]:disabled,\n.UIL [type=reset]:disabled,\n.UIL [type=submit]:disabled {\n  cursor: not-allowed;\n  opacity: 0.5;\n}\n.UIL button.solid,\n.UIL [type=button].solid,\n.UIL [type=reset].solid,\n.UIL [type=submit].solid {\n  background-color: var(--color-action);\n  border-color: var(--color-action);\n}\n.UIL button.solid:hover,\n.UIL [type=button].solid:hover,\n.UIL [type=reset].solid:hover,\n.UIL [type=submit].solid:hover {\n  background-color: transparent;\n  border-color: var(--color-white);\n}\n.UIL button.small,\n.UIL [type=button].small,\n.UIL [type=reset].small,\n.UIL [type=submit].small {\n  border-radius: var(--border-radius);\n  font: var(--label1);\n  padding: calc(var(--spacing) / 2) var(--spacing);\n}\n.UIL {\n  --form-box-shadow: inset 0 --border-width 0.1875rem rgba(#000, 0.06);\n  --form-box-shadow-focus: var(--form-box-shadow),\n    0 0 0.3125rem var(--color-action);\n  --form-group-width: 256px;\n  --form-content-max-width: 180px;\n}\n.UIL fieldset {\n  background-color: transparent;\n  border: 0;\n  margin: 0;\n  padding: 0;\n}\n.UIL legend {\n  font-weight: 600;\n  margin-bottom: var(--spacing-small);\n  padding: 0;\n}\n.UIL .form-group {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: var(--spacing-small);\n  width: 100%;\n}\n.UIL .form-group > label,\n.UIL .form-group > .label {\n  word-wrap: break-word;\n  -webkit-hyphens: auto;\n      -ms-hyphens: auto;\n          hyphens: auto;\n  white-space: normal;\n  padding-left: 5px;\n  max-width: calc( (var(--form-group-width) - var(--form-content-max-width) - var(--spacing-small)) * 1.5 );\n}\n.UIL .form-group > *:last-child {\n  width: 100%;\n  max-width: var(--form-content-max-width);\n}\n.UIL .label,\n.UIL label {\n  display: block;\n  font: var(--label2);\n  margin-bottom: 0;\n}\n.UIL input,\n.UIL select,\n.UIL textarea {\n  display: block;\n  font-family: var(--font-family);\n}\n.UIL select {\n  background-color: transparent;\n  border: none;\n  padding-right: calc(var(--spacing) * 2);\n  margin: 0;\n}\n.UIL .select-wrapper {\n  width: 100%;\n}\n.UIL select,\n.UIL [type=color],\n.UIL [type=date],\n.UIL [type=datetime],\n.UIL [type=datetime-local],\n.UIL [type=email],\n.UIL [type=month],\n.UIL [type=number],\n.UIL [type=password],\n.UIL [type=search],\n.UIL [type=tel],\n.UIL [type=text]:not(.no-style),\n.UIL [type=time],\n.UIL [type=url],\n.UIL [type=week],\n.UIL input:not([type]),\n.UIL textarea {\n  -webkit-appearance: none;\n          appearance: none;\n  background-color: var(--color-black);\n  border: var(--border);\n  border-radius: var(--border-radius);\n  box-shadow: var(--form-box-shadow);\n  box-sizing: border-box;\n  color: var(--font-color-highlight);\n  font: var(--label2);\n  margin-bottom: 0;\n  padding: var(--spacing-small);\n  transition: border-color var(--duration) var(--timing);\n  width: 100%;\n  position: relative;\n}\n.UIL select:focus,\n.UIL [type=color]:focus,\n.UIL [type=date]:focus,\n.UIL [type=datetime]:focus,\n.UIL [type=datetime-local]:focus,\n.UIL [type=email]:focus,\n.UIL [type=month]:focus,\n.UIL [type=number]:focus,\n.UIL [type=password]:focus,\n.UIL [type=search]:focus,\n.UIL [type=tel]:focus,\n.UIL [type=text]:focus:not(.no-style),\n.UIL [type=time]:focus,\n.UIL [type=url]:focus,\n.UIL [type=week]:focus,\n.UIL input:not([type]):focus,\n.UIL textarea:focus {\n  box-shadow: var(--form-box-shadow-focus);\n}\n.UIL select:disabled,\n.UIL [type=color]:disabled,\n.UIL [type=date]:disabled,\n.UIL [type=datetime]:disabled,\n.UIL [type=datetime-local]:disabled,\n.UIL [type=email]:disabled,\n.UIL [type=month]:disabled,\n.UIL [type=number]:disabled,\n.UIL [type=password]:disabled,\n.UIL [type=search]:disabled,\n.UIL [type=tel]:disabled,\n.UIL [type=text]:disabled,\n.UIL [type=time]:disabled,\n.UIL [type=url]:disabled,\n.UIL [type=week]:disabled,\n.UIL input:not([type]):disabled,\n.UIL textarea:disabled {\n  cursor: not-allowed;\n}\n.UIL select:disabled:hover,\n.UIL [type=color]:disabled:hover,\n.UIL [type=date]:disabled:hover,\n.UIL [type=datetime]:disabled:hover,\n.UIL [type=datetime-local]:disabled:hover,\n.UIL [type=email]:disabled:hover,\n.UIL [type=month]:disabled:hover,\n.UIL [type=number]:disabled:hover,\n.UIL [type=password]:disabled:hover,\n.UIL [type=search]:disabled:hover,\n.UIL [type=tel]:disabled:hover,\n.UIL [type=text]:disabled:hover,\n.UIL [type=time]:disabled:hover,\n.UIL [type=url]:disabled:hover,\n.UIL [type=week]:disabled:hover,\n.UIL input:not([type]):disabled:hover,\n.UIL textarea:disabled:hover {\n  border: var(--border);\n}\n.UIL select::-webkit-input-placeholder, .UIL [type=color]::-webkit-input-placeholder, .UIL [type=date]::-webkit-input-placeholder, .UIL [type=datetime]::-webkit-input-placeholder, .UIL [type=datetime-local]::-webkit-input-placeholder, .UIL [type=email]::-webkit-input-placeholder, .UIL [type=month]::-webkit-input-placeholder, .UIL [type=number]::-webkit-input-placeholder, .UIL [type=password]::-webkit-input-placeholder, .UIL [type=search]::-webkit-input-placeholder, .UIL [type=tel]::-webkit-input-placeholder, .UIL [type=text]::-webkit-input-placeholder, .UIL [type=time]::-webkit-input-placeholder, .UIL [type=url]::-webkit-input-placeholder, .UIL [type=week]::-webkit-input-placeholder, .UIL input:not([type])::-webkit-input-placeholder, .UIL textarea::-webkit-input-placeholder {\n  color: var(--font-color-base);\n  opacity: 0.25;\n}\n.UIL select:-ms-input-placeholder, .UIL [type=color]:-ms-input-placeholder, .UIL [type=date]:-ms-input-placeholder, .UIL [type=datetime]:-ms-input-placeholder, .UIL [type=datetime-local]:-ms-input-placeholder, .UIL [type=email]:-ms-input-placeholder, .UIL [type=month]:-ms-input-placeholder, .UIL [type=number]:-ms-input-placeholder, .UIL [type=password]:-ms-input-placeholder, .UIL [type=search]:-ms-input-placeholder, .UIL [type=tel]:-ms-input-placeholder, .UIL [type=text]:-ms-input-placeholder, .UIL [type=time]:-ms-input-placeholder, .UIL [type=url]:-ms-input-placeholder, .UIL [type=week]:-ms-input-placeholder, .UIL input:not([type]):-ms-input-placeholder, .UIL textarea:-ms-input-placeholder {\n  color: var(--font-color-base);\n  opacity: 0.25;\n}\n.UIL select::-ms-input-placeholder, .UIL [type=color]::-ms-input-placeholder, .UIL [type=date]::-ms-input-placeholder, .UIL [type=datetime]::-ms-input-placeholder, .UIL [type=datetime-local]::-ms-input-placeholder, .UIL [type=email]::-ms-input-placeholder, .UIL [type=month]::-ms-input-placeholder, .UIL [type=number]::-ms-input-placeholder, .UIL [type=password]::-ms-input-placeholder, .UIL [type=search]::-ms-input-placeholder, .UIL [type=tel]::-ms-input-placeholder, .UIL [type=text]::-ms-input-placeholder, .UIL [type=time]::-ms-input-placeholder, .UIL [type=url]::-ms-input-placeholder, .UIL [type=week]::-ms-input-placeholder, .UIL input:not([type])::-ms-input-placeholder, .UIL textarea::-ms-input-placeholder {\n  color: var(--font-color-base);\n  opacity: 0.25;\n}\n.UIL select::placeholder,\n.UIL [type=color]::placeholder,\n.UIL [type=date]::placeholder,\n.UIL [type=datetime]::placeholder,\n.UIL [type=datetime-local]::placeholder,\n.UIL [type=email]::placeholder,\n.UIL [type=month]::placeholder,\n.UIL [type=number]::placeholder,\n.UIL [type=password]::placeholder,\n.UIL [type=search]::placeholder,\n.UIL [type=tel]::placeholder,\n.UIL [type=text]::placeholder,\n.UIL [type=time]::placeholder,\n.UIL [type=url]::placeholder,\n.UIL [type=week]::placeholder,\n.UIL input:not([type])::placeholder,\n.UIL textarea::placeholder {\n  color: var(--font-color-base);\n  opacity: 0.25;\n}\n.UIL [type=search] {\n  -webkit-appearance: textfield;\n}\n.UIL textarea {\n  resize: vertical;\n}\n.UIL [type=file] {\n  width: 100%;\n}\n.UIL select {\n  width: 100%;\n}\n.UIL input:focus-visible:not(.no-style),\n.UIL textarea:focus-visible,\n.UIL select:focus-visible {\n  outline: var(--focus-outline);\n  outline-offset: var(--focus-outline-offset);\n}\n.UIL input[type=checkbox]:not(.regular-checkbox),\n.UIL input[type=radio] {\n  height: 0;\n  width: 0;\n  visibility: visible;\n  margin: 0;\n}\n.UIL input[type=checkbox]:not(.regular-checkbox) + label,\n.UIL input[type=radio] + label {\n  cursor: pointer;\n  border: var(--border);\n  text-indent: -9999px;\n  width: 44px;\n  height: 28px;\n  background: var(--color-black);\n  display: block;\n  border-radius: 28px;\n  position: relative;\n}\n.UIL input[type=checkbox]:not(.regular-checkbox) + label:after,\n.UIL input[type=radio] + label:after {\n  content: "";\n  position: absolute;\n  top: 8px;\n  left: 8px;\n  width: 12px;\n  height: 12px;\n  background-color: var(--color-action--disabled);\n  border-radius: 12px;\n  transition: 0.3s;\n}\n.UIL input[type=checkbox]:not(.regular-checkbox):checked + label,\n.UIL input[type=radio]:checked + label {\n  background: var(--color-action);\n}\n.UIL input[type=checkbox]:not(.regular-checkbox):checked + label:after,\n.UIL input[type=radio]:checked + label:after {\n  background-color: var(--color-white);\n}\n.UIL input[type=checkbox]:not(.regular-checkbox):checked + label:after,\n.UIL input[type=radio]:checked + label:after {\n  left: calc(100% - 8px);\n  -webkit-transform: translateX(-100%);\n          transform: translateX(-100%);\n}\n.UIL input[type=checkbox]:not(.regular-checkbox) + label:active:after,\n.UIL input[type=radio] + label:active:after {\n  width: 16px;\n}\n.UIL input[type=checkbox]:not(.regular-checkbox):focus-visible,\n.UIL input[type=radio]:focus-visible {\n  outline: none;\n  border: none;\n}\n.UIL input[type=checkbox]:not(.regular-checkbox):focus-visible + label,\n.UIL input[type=checkbox]:not(.regular-checkbox):focus-visible + .label,\n.UIL input[type=radio]:focus-visible + label,\n.UIL input[type=radio]:focus-visible + .label {\n  border: var(--border);\n  border-color: var(--color-action);\n}\n.UIL input[type=checkbox]:not(.regular-checkbox):focus-visible:checked + label,\n.UIL input[type=checkbox]:not(.regular-checkbox):focus-visible:checked + .label,\n.UIL input[type=radio]:focus-visible:checked + label,\n.UIL input[type=radio]:focus-visible:checked + .label {\n  border: var(--border);\n  border-color: var(--color-white);\n}\n.UIL .checkbox-control {\n  display: flex;\n  gap: calc(var(--spacing-small) / 2);\n  align-items: center;\n  line-height: 1;\n}\n.UIL .regular-checkbox {\n  -webkit-appearance: none;\n          appearance: none;\n  background-color: var(--color-black);\n  margin: 0;\n  width: 20px;\n  height: 20px;\n  max-width: 20px;\n  min-width: 20px;\n  color: currentColor;\n  border: var(--border);\n  border-radius: calc(var(--border-radius) / 2);\n  -webkit-transform: translateY(-0.075em);\n          transform: translateY(-0.075em);\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n.UIL .regular-checkbox:before {\n  border-radius: calc(var(--border-radius) / 4);\n  content: "";\n  width: calc(20px / 2);\n  height: calc(20px / 2);\n  -webkit-transform: scale(0);\n          transform: scale(0);\n  transition: 120ms -webkit-transform ease-in-out;\n  transition: 120ms transform ease-in-out;\n  transition: 120ms transform ease-in-out, 120ms -webkit-transform ease-in-out;\n  box-shadow: inset 1em 1em var(--color-action);\n}\n.UIL .regular-checkbox:checked::before {\n  -webkit-transform: scale(1);\n          transform: scale(1);\n}\n.UIL {\n  box-sizing: border-box;\n  scroll-behavior: smooth;\n}\n.UIL *,\n.UIL *::before,\n.UIL *::after {\n  box-sizing: inherit;\n}\n.UIL figure {\n  margin: 0;\n}\n.UIL img,\n.UIL picture {\n  display: block;\n  margin: 0;\n  max-width: 100%;\n}\n.UIL {\n  color: var(--font-color-base);\n  font-family: var(--font-family);\n  font-size: var(--font-size-base);\n  line-height: var(--line-height);\n  letter-spacing: 0.01em;\n}\n.UIL ::selection {\n  background-color: var(--color-action);\n  color: var(--color-action--contrast);\n}\n.UIL p {\n  margin: 0 0 var(--spacing-small);\n  overflow-wrap: break-word;\n  -webkit-hyphens: auto;\n      -ms-hyphens: auto;\n          hyphens: auto;\n}\n.UIL a {\n  -webkit-text-decoration-skip: ink;\n          text-decoration-skip-ink: auto;\n  transition: color var(--duration) var(--timing);\n}\n.UIL a:focus {\n  outline: var(--focus-outline);\n  outline-offset: var(--focus-outline-offset);\n}\n.UIL hr {\n  border-bottom: var(--border);\n  border-left: 0;\n  border-right: 0;\n  border-top: 0;\n  margin: var(--spacing) 0;\n}\n.UIL .color-selector {\n  background-color: var(--color-black);\n  border: var(--border);\n  border-radius: var(--border-radius);\n  box-shadow: var(--form-box-shadow);\n  color: var(--font-color-highlight);\n  font: var(--label2);\n  margin-bottom: 0;\n  padding: var(--spacing-small);\n  transition: border-color var(--duration) var(--timing);\n  width: 100%;\n  position: relative;\n  display: flex;\n  gap: var(--spacing-small);\n  align-items: center;\n}\n.UIL .color-selector:has(input:focus-visible) {\n  outline: var(--focus-outline);\n  outline-offset: var(--focus-outline-offset);\n}\n.UIL .color-selector .color-chip {\n  width: 20px;\n  height: 16px;\n  border-radius: calc(var(--border-radius) / 2);\n  border: var(--border);\n}\n.UIL .color-selector .color-text {\n  text-transform: uppercase;\n}\n.UIL .color-selector .hidden {\n  position: absolute;\n  left: 0;\n  opacity: 0;\n}\n.UIL {\n  --thumb-size: var(--spacing-small);\n  --thumb-radius: calc(var(--thumb-size) / 2);\n  --color-track: var(--color-black);\n  --track-height: calc(var(--thumb-size) / 2);\n}\n.UIL input[type=range] {\n  -webkit-appearance: none;\n  appearance: none;\n  background: transparent;\n  cursor: pointer;\n  width: 100%;\n}\n.UIL input[type=range]:focus {\n  outline: none;\n}\n.UIL input[type=range]::-webkit-slider-runnable-track {\n  background-color: var(--color-track);\n  border-radius: calc(var(--track-height) / 2);\n  height: var(--track-height);\n  border: var(--border);\n}\n.UIL input[type=range]::-webkit-slider-thumb {\n  -webkit-appearance: none;\n  /* Override default look */\n  appearance: none;\n  margin-top: -4px;\n  /* Centers thumb on the track */\n  /*custom styles*/\n  background-color: var(--color-action);\n  height: var(--thumb-size);\n  width: var(--thumb-size);\n  border-radius: var(--thumb-radius);\n}\n.UIL input[type=range]:focus::-webkit-slider-thumb {\n  border: var(--border);\n  outline: 1px solid var(--color-hightlight-light);\n  outline-offset: 0.125rem;\n}\n.UIL input[type=range]::-moz-range-track {\n  background-color: var(--color-track);\n  border-radius: calc(var(--track-height) / 2);\n  height: var(--track-height);\n  border: var(--border);\n}\n.UIL input[type=range]::-moz-range-thumb {\n  border: none;\n  /*Removes extra border that FF applies*/\n  border-radius: var(--thumb-radius);\n  /*Removes default border-radius that FF applies*/\n  /*custom styles*/\n  background-color: var(--color-action);\n  height: var(--thumb-size);\n  width: var(--thumb-size);\n}\n.UIL input[type=range]:focus::-moz-range-thumb {\n  border: var(--border);\n  outline: 1px solid var(--color-hightlight-light);\n  outline-offset: 0.125rem;\n}\n.UIL ::-webkit-scrollbar {\n  width: 2px;\n  height: 2px;\n}\n.UIL ::-webkit-scrollbar-track {\n  background: var(--color-neutral-10);\n}\n.UIL ::-webkit-scrollbar-thumb {\n  background: var(--color-highlight);\n}\n.UIL .sr-only,\n.UIL .visibility-hidden {\n  position: absolute;\n  width: 1px;\n  height: 1px;\n  margin: -1px;\n  padding: 0;\n  overflow: hidden;\n  clip: rect(0, 0, 0, 0);\n  border: 0;\n}\n',style=document.head.appendChild(document.createElement("style"));style.type="text/css",style.id="uil-style",style.appendChild(document.createTextNode(initial)),_style=style}(),function initSidebar(){_this.add(new UILPanel({title:"sidebar"})),_this.add(new UILPanel({title:"global",options:{side:"left",hideToolbar:!0}})),_this.globalTabs=_this.initClass(UILTabs,[{id:"playground",label:"Graph",content:null,active:!0,disabled:!1,hidden:!1,draggable:!1,hideToobar:!0},{id:"global",label:"Global",content:null,active:!1,disabled:!1,hidden:!1,draggable:!1},{id:"performance",label:"Performance",content:UILPerformance,active:!1,disabled:!1,hidden:!1,draggable:!1},{id:"memory",label:"Memory",content:UILMemory,active:!1,disabled:!1,hidden:!1,draggable:!1}],[_this.global.element])}(),function initGraph(){if(!_this.sidebar)return;_this.globalTabs.addGraph(UILGraph.instance().element.div)}()}(),_this.loaded=!0})),this.ready=function(){return _this.wait(_this,"loaded")},this.add=function(panel){return _ui[panel.id]=panel,_this[panel.id]=panel,$el.add(panel),_this},this.remove=function(id){let $panel=_ui[id];return $panel.eliminate&&$panel.eliminate(),$panel.destroy(),delete _ui[id],delete _this[id],_this},this.find=function(id){return Object.values(_ui).reduce(((acc,el)=>acc.concat(el.find(id))),[])},this.enableSorting=function(id,enable){let el=_this.find(id)[0];return el&&el.enableSorting&&el.enableSorting(enable),_this},this.addCSS=function(control,style){if(control.styled)return;let node=document.createTextNode(style);return _style&&_style.appendChild(node),control.styled=!0,_this},this.REORDER="uil_reorder"}),"static"),Class((function CameraUIL(){this.UPDATE="camera_uil_update",this.add=function(light,group){return new CameraUILConfig(light,null===group?null:group||UIL.global)}}),"static"),Class((function CameraUILConfig(_camera,_uil){const _this=this;if(!_camera.prefix)throw"camera.prefix required when using MeshUIL";var prefix="CAMERA_"+_camera.prefix,_group=_uil?createFolder():null,_dynamicFOVCallback=null;function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:_camera.prefix,closed:!0});return _uil.add(folder),folder}function initFOV(key){let initValue=UILStorage.get(`${prefix}${key}`)||_camera.camera.fov||9999;if(_group){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onFinishChange((e=>{_group&&_this["tweenUIL_"+key]?.(e),_camera.setFOV(e),UILStorage.set(`${prefix}${key}`,e)})),_group.add(number)}defer((_=>{_camera.setFOV(initValue)}))}function initVec(key){let initValue=UILStorage.get(`${prefix}${key}`)||_camera[key]?.toArray();if(initValue){if(_group){UILStorage.state.bind(`${prefix}${key}`,(val=>_camera[key].fromArray(val)));let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange((e=>{_group&&_this["tweenUIL_"+key]?.(e),_camera[key].fromArray(e)})),vector.onFinishChange((e=>UILStorage.set(`${prefix}${key}`,e))),_group.add(vector),_this["forceUpdate"+key.toUpperCase()]=_=>{let val=_camera[key].toArray();_this["tweenUIL_"+key]?_this["tweenUIL_"+key](val):vector.force(_camera[key].toArray(),!0)}}_camera[key].fromArray(initValue)}}function initNumber(key){let initValue=UILStorage.get(`${prefix}${key}`)||(void 0===_camera[key]?9999:_camera[key]);if(_group){UILStorage.state.bind(`${prefix}${key}`,(val=>_camera[key]=val));let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onChange((e=>{_camera[key]=e,_group&&_this["tweenUIL_"+key]?.(e)})),number.onFinishChange((e=>UILStorage.set(`${prefix}${key}`,e))),_group.add(number)}_camera[key]=initValue}function initRotation(key,applyValue){let toRadians=array=>array?(array.length=3,array.map((x=>Math.radians(x)))):[0,0,0],initValue=toRadians(UILStorage.get(`${prefix}${key}`));if(_group){UILStorage.state.bind(`${prefix}${key}`,(val=>{(_camera[key]||_camera.group[key]).fromArray(toRadians(val))}));let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:(array=initValue,array?(array.length=3,array.map((x=>Math.degrees(x)))):[0,0,0])});vector.onChange((e=>{_group&&_this["tweenUIL_"+key]?.(toRadians(e)),applyValue(toRadians(e),key)})),vector.onFinishChange((e=>UILStorage.set(`${prefix}${key}`,e))),_group.add(vector)}var array;applyValue(initValue,key)}function initDynamicFOV(key){let defaultCode="",code=UILStorage.get(`${prefix}${key}Code`)||defaultCode,evalCode=value=>{let method=value.includes("return")?`(function(){ return function getFOV() { ${value}}})()`:`(function(){ return function getFOV() { return ${value}}})()`;_camera._getDynamicFOV=eval(method)},editCode=_=>{let editor=new UILExternalEditor(`${prefix}${key}`,400,900);editor.setCode(code,"c"),editor.onSave=value=>{UILStorage.set(`${prefix}${key}Code`,value),evalCode(value),code=value,_camera.dynamicFOV()}},btn=new UILControlButton("btn",{actions:[{title:"Dynamic FOV",callback:editCode}],hideLabel:!0});_group&&_group.add(btn),defer((_=>{evalCode(code),_camera.dynamicFOV=_=>{if(_camera.camera.isOrthographicCamera)return;let fov=_camera._getDynamicFOV?.()||_camera.camera.fov;if(isNaN(fov))return console.warn(`${prefix} Dynamic FOV requires a float value`);_camera.setFOV(fov)},_camera.onResize((_=>_camera.dynamicFOV()))}))}function initType(){let initValue=UILStorage.get(`${prefix}type`)||"perspective";if(_group){let control=new UILControlSelect(`${prefix}type`,{label:"Type",value:initValue,options:[{label:"Perspective",value:"perspective"},{label:"Orthographic",value:"orthographic"}]});UILStorage.state.bind(`${prefix}type`,(val=>control.onChange(val))),control.onChange((e=>{"orthographic"===e?_camera.useOrthographic():_camera.usePerspective()})),control.onFinishChange((e=>UILStorage.set(`${prefix}type`,e))),_group.add(control)}"orthographic"===initValue&&_camera.useOrthographic()}function addListeners(){Events.emitter._addEvent(CameraUIL.UPDATE,update,_this)}function update(e){e.prefix==prefix&&e.group!=_this&&(e.fov&&_camera.setFOV(e.val),e.number&&(_camera[e.key]=e.val),e.rotation&&_camera.group[e.key].fromArray(e.val),e.vec&&_camera[e.key].fromArray(e.val))}initType(),_camera.position&&initVec("position"),_camera.group&&(_camera.groupPos=_camera.group.position,initVec("groupPos"),initRotation("rotation",((value,key)=>{_camera.group[key].fromArray(value)}))),initFOV("fov"),initNumber("zoom"),initNumber("near"),initNumber("far"),_camera.moveXY&&(initVec("moveXY"),initVec("lookAt"),initRotation("cameraRotation",((value,key)=>{_camera[key].fromArray(value)})),initVec("viewportFocus"),initNumber("lerpSpeed"),initNumber("lerpSpeed2"),initNumber("deltaRotate"),initNumber("deltaLerp"),initNumber("wobbleSpeed"),initNumber("wobbleStrength"),initNumber("wobbleZ")),initDynamicFOV("dynamicFOV"),_group&&addListeners(),this.setLabel=function(name){_group&&_group.setLabel(name)}})),Class((function InputUIL(){this.UPDATE="inputUil_Update",this.create=function(name,group,decoupled){return new InputUILConfig(name,null===group?null:group||UIL.global,decoupled)}}),"static"),Class((function InputUILConfig(_name,_uil,_decoupled,_slim){var _cache,_this=this;const prefix="INPUT_"+_name;var _group=_uil?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(_name,{closed:!0});_decoupled||(_uil.add(folder),_uil==UIL.sidebar&&folder.hide());return folder}():null,_fields=_uil?{}:null;function externalUpdate(e){e.prefix==prefix&&e.group!=_this&&(UILStorage.set(`${prefix}_${e.key}`,e.value),_this.onUpdate&&_this.onUpdate(e.key))}_this.group=_group,_this.keys=[],_uil&&function addListeners(){Events.emitter._addEvent(InputUIL.UPDATE,externalUpdate,_this)}(),this.state=AppState.createLocal(),this.get=function(key){if(_cache&&void 0!==_cache[key])return _cache[key];let val=UILStorage.get(`${prefix}_${key}`);return"boolean"==typeof val?val:val&&""!=val?"true"===val||"false"!==val&&(val.charAt&&"["==val.charAt(0)?JSON.parse(val):(UIL.global||(_cache||(_cache={}),_cache[key]||(_cache[key]=val)),val)):void 0},this.getFilePath=function(key){let data=this.get(key);return"{"===data?.charAt?.(0)?(data=JSON.parse(data),data.relative.includes(".")?data.relative:data.src):"object"==typeof data?data.relative.includes(".")?data.relative:data.src:data},this.getNumber=function(key){let number=Number(this.get(key));return isNaN(number)&&(number=0),number},_slim||(this.add=function(key,initValue,uil=window.UILControlText,options,params={}){if(_this.keys.push(key),!_group||"hidden"==initValue||!UIL.sidebar)return this;let fallback;"string"==typeof uil&&(fallback=uil,uil=window.UILControlText);let value=UILStorage.get(`${prefix}_${key}`);if(void 0===value&&fallback&&(value=UILStorage.get(`${prefix}_${fallback}`)),"true"===value&&(value=!0),"false"===value&&(value=!1),uil==UILControlVector&&"string"==typeof value&&(value=JSON.parse(value)),void 0===value&&(value=initValue),"string"==typeof value&&(uil==UILControlImage||uil==UILControlFile))try{value=JSON.parse(value)}catch(e){}let change=(val,fromInit)=>{val="string"==typeof val?val:JSON.stringify(val),UILStorage.set(`${prefix}_${key}`,val),_this.onUpdate&&_this.onUpdate(key,val),fromInit||Events.emitter._fireEvent(InputUIL.UPDATE,{prefix:prefix,key:key,value:val,group:_this})};"string"!=typeof initValue&&"number"!=typeof initValue&&uil!=UILControlVector||UILStorage.get(`${prefix}_${key}`)||change(initValue,!0);let opts=Utils.mergeObject(params,{label:key,value:value,options:options});uil==window.UILControlButton&&(opts=options);let config=new uil(`${prefix}_${key}`,opts);return config.onFinishChange(change),UILStorage.state.bind(`${prefix}_${key}`,(val=>_this.state.set(key,val))),uil!=UILControlVector&&uil!=UILControlRange||config.onChange(change),_group.add(config),_fields[key]=config,this},this.addToggle=function(key,initValue){return UIL.sidebar?this.add(key,initValue,UILControlCheckbox):this},this.addSelect=function(key,options){return UIL.sidebar?this.add(key,null,UILControlSelect,options):this},this.addImage=function(key,options){return UIL.sidebar?this.add(key,null,UILControlImage,null,options):this},this.addFile=function(key,options){if(!UIL.sidebar)return this;this.get(key);return this.add(key,null,UILControlFile,null,options)},this.addRange=function(key,initValue,options){return UIL.sidebar?this.add(key,initValue,UILControlRange,null,options):this},this.addNumber=function(key,initValue,step){return UIL.sidebar?this.add(key,initValue,UILControlNumber,null,{step:step}):this},this.addColor=function(key,initValue=new Color){return UIL.sidebar?this.add(key,initValue.getHexString(),UILControlColor):this},this.addTextarea=function(key,initValue){return UIL.sidebar?this.add(key,initValue,UILControlTextarea,null,{monospace:!0,rows:4}):this},this.addButton=function(key,options){if(!UIL.sidebar)return this;if("function"==typeof options){let cb=options;options={actions:[{title:key,callback:_=>cb(key)}],hideLabel:!0}}return this.add(key,null,UILControlButton,options)},this.addVector=function(key,initValue,options){return UIL.sidebar?(options||(options={step:.05}),this.add(key,initValue,UILControlVector,null,options)):this},this.getImage=function(key){let data=this.get(key);if(data)return JSON.parse(data).src},this.setValue=function(key,value){if(UILStorage.set(`${prefix}_${key}`,value),_this.onUpdate&&_this.onUpdate(key),_this.state.set(key,value),_fields){let field=_fields[key];field&&(field.value=value,field.update&&field.update())}return this},this.copyFrom=function(input,fields){fields.forEach((key=>{let val=input.get(key);void 0!==val&&("string"!=typeof val&&(val=JSON.stringify(val)),_this.setValue(key,val))}))},this.setLabel=function(name){_group&&_group.setLabel(name)},this.getField=function(key){if(_fields)return _fields[key]},this.setDescription=function(key,desc){_this.getField(key)?.setDescription(desc)})})),Class((function ListUIL(){Inherit(this,Component);const _this=this;var _panel,_created={};function removePanel(){_panel&&_panel.destroy&&(_this.events.unsub(_panel,Events.COMPLETE,removePanel),_panel=_panel.destroy())}this.create=function(id,version=1,group){"number"!=typeof version&&(group=version,version=1),group=null===group?null:group||UIL.global;let config=new ListUILConfig(id,version,UIL.global&&!_created[id]);return UIL.global&&(_created[id]||(_created[id]=config,null!=group&&config.appendUILGroup(group||UIL.global))),config},this.openPanel=function(id,name,template){return removePanel(),_panel=new ListUILEditor(id,name,template),_this.events.sub(_panel,Events.COMPLETE,removePanel),_panel},this.set=function(){},this.get=function(){},this.getPanel=function(){return _panel}}),"static"),Class((function ListUILConfig(_id,_version=1,_store){Inherit(this,Component);const _this=this;var _items,_folder,_config,_template={onSort:_=>{},onAdd:_=>{},onRemove:_=>{}},_name="";function updateConfig(){_config.version=_version}function edit(){let panel=ListUIL.openPanel(_id,_name,_this.template);_this.events.bubble(panel,Events.UPDATE),_this.events.fire(ListUIL.OPEN)}_store&&(_items=[]),function initConfig(){(_config=UILStorage.get(function name(){return`LIST_${_id}_config`}()))?_config.version!=_version&&updateConfig():(_config={},updateConfig())}(),this.add=function(item){return _items&&_items.push(item),item},this.template=function(config){return"function"==typeof config&&(_template=config),_template},this.appendUILGroup=function(uil){let folder=new UILFolder("LIST_"+_id,{closed:!0}),button=new UILControlButton("button",{actions:[{title:"Edit List",callback:edit}],hideLabel:!0});folder.add(button),uil.add(folder),_folder=folder},this.setLabel=function(name){_folder&&_folder.setLabel(name),_name=name},this.onAdd=function(cb){_template.onAdd=cb},this.onRemove=function(cb){_template.onRemove=cb},this.onSort=function(cb){_template.onSort=cb},this.internalAddItems=function(count){if(!count)return;let array=[];for(let i=0;i<count;i++){let id=`${_id}_${Utils.timestamp()}`;array.push(id)}UILStorage.set(`${_id}_list_items`,JSON.stringify(array))}}),(_=>{ListUIL.OPEN="list_uil_open"})),Class((function ListUILEditor(_id,_name,_template){Inherit(this,Component);const _this=this,PANEL_CONFIG={label:_name||"List",width:"400px",height:"auto",drag:!0};var _gui,_list,_add,_items,_tabs=[],_index=0;function initList(){!function read(){let data=UILStorage.get(`${_id}_list_items`);void 0===data&&(data="[]");_items=JSON.parse(data)}(),(_list=new UILFolder(`${_id}_list`,{hideTitle:!0})).enableSorting(_id),_gui.add(_list);for(let id of _items){let view=new ListUILItem(id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view)}}function initAdd(){!function initButton(title,callback){_add=new UILControlButton("button",{actions:[{title:title,callback:callback}],hideLabel:!0}),_gui.add(_add)}("Add Item",add)}function add(){let id=`${_id}_${Utils.timestamp()}`,view=new ListUILItem(id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view),_items.push(id),write()}function reorder(e){let order=[];for(let item of e.order)order.push(item.split("_folder")[0]);_items=order,_template().onSort(_items),write(),_this.events.fire(Events.UPDATE,{order:order})}function close(){_this.events.fire(Events.COMPLETE)}function remove(e){_items.remove(e.id),write(),refresh()}function write(){let data=JSON.stringify(_items);UILStorage.set(`${_id}_list_items`,data)}function refresh(){_index=0,_list&&_list.destroy&&(_list=_list.destroy()),_add&&_add.destroy&&(_add=_add.destroy()),initList(),initAdd()}!function initPanel(){_this.gui=_gui=new UILWindow(_id,PANEL_CONFIG),_this.gui.onClose=close,UIL.add(_gui)}(),refresh(),this.onDestroy=function(){_gui.destroy()},this.add=function(){add()}})),Class((function ListUILItem(_id,_parent,_template,_index){Inherit(this,Component);const _this=this;var _folder;function onDelete(){if(!confirm("You sure you want to delete this?"))return;let id=_id;_template().onRemove(id),_this.events.fire(Events.END,{id:id})}function onReorder(e){_this.events.fire(Events.UPDATE,e)}!async function initFolder(){(_folder=InputUIL.create(`${_id}_folder`,_parent)).setLabel("Item"),_folder.group.draggable(!0),_this.events.sub(_folder.group,UIL.REORDER,onReorder),_folder.listUILItem=_this}(),function initTemplate(){let id=_id;(0,_template().onAdd)(id,_folder,_index)}(),function initUI(){let actions=[{title:"Delete",callback:onDelete}],hideLabel=!0;_folder.addButton("delete",{actions:actions,hideLabel:hideLabel})}(),this.setLabel=function(label){_folder.setLabel(label)},this.forceSort=function(index){_folder.group.forceSort(index)},this.open=function(){_folder.group.open(),_folder.group.openChildren()},this.close=function(){_folder.group.close()}})),Class((function MeshUIL(){Inherit(this,Component);this.exists={},this.UPDATE="mesh_uil_update",this.add=function(mesh,group){return(group=null===group?null:group)&&(mesh.__uilGroup=group),new MeshUILConfig(mesh,group||UIL.global)}}),"static"),Class((function MeshUILConfig(_mesh,_uil){const _this=this;if(!_mesh.prefix)throw"mesh.prefix required when using MeshUIL";var prefix="MESH_"+_mesh.prefix,_group=_uil&&!MeshUIL.exists[prefix]?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:_mesh.prefix,closed:!0});return _uil.add(folder),folder}():null,_controls=_group?{}:null;function initVec(key){let initValue=UILStorage.get(`${prefix}${key}`)||_mesh[key].toArray();if(_group){UILStorage.state.bind(`${prefix}${key}`,(val=>_mesh[key].fromArray(val)));let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange((e=>{_mesh[key].fromArray(e),_group&&_this["tweenUIL_"+key]?.(e)})),vector.onFinishChange(save),_group.add(vector),_this["forceUpdate"+key.toUpperCase()]=_=>{let val=_mesh[key].toArray();_this["tweenUIL_"+key]?_this["tweenUIL_"+key](val):vector.force(_mesh[key].toArray(),!0)},_controls[key]=vector}_mesh[key].fromArray(initValue)}function save(){for(let key in _controls){let value=_controls[key].value;UILStorage.set(`${prefix}${key}`,value)}}function update(e){e.prefix==prefix&&e.group!=_this&&_mesh[e.key].fromArray(e.val)}this.group=_group,initVec("position"),initVec("scale"),function initRotation(){let key="rotation",toRadians=array=>array?(array.length=3,array.map((x=>Math.radians(x)))):[0,0,0],toDegrees=array=>array?(array.length=3,array.map((x=>Math.degrees(x)))):[0,0,0],initValue=toRadians(UILStorage.get(`${prefix}${key}`));if(_group){UILStorage.state.bind(`${prefix}${key}`,(val=>_mesh[key].fromArray(toRadians(val))));let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:toDegrees(initValue)});vector.onChange((e=>{_mesh[key].fromArray(toRadians(e)),_group&&_this["tweenUIL_"+key]?.(e)})),vector.onFinishChange(save),_group.add(vector),_controls[key]=vector}_mesh[key].fromArray(initValue);let rotationEuler=(new Euler).fromArray(initValue);_mesh.customRotation=(new Quaternion).setFromEuler(rotationEuler)}(),_group&&function addListeners(){Events.emitter._addEvent(MeshUIL.UPDATE,update,_this)}(),this.setLabel=function(name){_group&&_group.setLabel(name)},this.forceUpdate=function(key,val){_mesh[key].fromArray(val),_this["forceUpdate"+key.toUpperCase()]?.()}})),Class((function ShaderUIL(){this.exists={},this.UPDATE="shader_update",this.TEXTURE_UPDATE="shader_texture_update",this.SHADER_UPDATE="shader_shader_update",this.add=function(shader,group){return new ShaderUILConfig(shader.shader||shader,null===group?null:group||UIL.global)},this.createOverride=function(prefix,obj,group,shaderOnly,newClone){let uniforms={};Array.isArray(obj)?obj.forEach((o=>{o=o.uniforms||o;for(let key in o)o[key].ignoreUIL||(uniforms[key]=o[key])})):uniforms=obj.uniforms||obj;let shader=Utils3D.getTestShader();if(shader.vertexShader=shader.fragmentShader="",newClone)for(let key in uniforms){let value=uniforms[key].value;value?.clone&&(value=value.clone()),shader.uniforms[key]={value:value,type:uniforms[key].type}}else for(let key in uniforms)shader.uniforms[key]=uniforms[key];return shader.UILPrefix=prefix,null===shaderOnly?shader:this.add(shader,group)},this.createDecorator=function(shader,prefix,obj,group){let uniforms={};for(let key in obj)uniforms[key]=shader.uniforms[key];let nShader=Utils3D.getTestShader();return nShader.vertexShader=shader.fragmentShader="",nShader.uniforms=uniforms,nShader.UILPrefix=prefix,this.add(nShader,group)},this.createClone=function(prefix,obj){let uniforms=obj.uniforms||obj,shader=Utils3D.getTestShader();for(let key in uniforms){let value=uniforms[key].value,ignoreUIL=uniforms[key].ignoreUIL||null===value;!ignoreUIL&&value.clone&&(value=value.clone()),shader.uniforms[key]={value:value,ignoreUIL:ignoreUIL}}return shader.UILPrefix=prefix,shader},this.lerpShader=function(from,to,alpha,hz,uniformsFilter){from=from.uniforms||from,to=to.uniforms||to;for(let key in from){let f=from[key],t=to[key];f&&t&&(uniformsFilter&&-1===uniformsFilter.indexOf(key)||("number"==typeof t.value?f.value=Math.lerp(t.value,f.value,alpha,hz):"c"===f.type?(f.value.r=Math.lerp(t.value.r,f.value.r,alpha,hz),f.value.g=Math.lerp(t.value.g,f.value.g,alpha,hz),f.value.b=Math.lerp(t.value.b,f.value.b,alpha,hz)):"v3"===f.type?(f.value.x=Math.lerp(t.value.x,f.value.x,alpha,hz),f.value.y=Math.lerp(t.value.y,f.value.y,alpha,hz),f.value.z=Math.lerp(t.value.z,f.value.z,alpha,hz)):"v2"===f.type?(f.value.x=Math.lerp(t.value.x,f.value.x,alpha,hz),f.value.y=Math.lerp(t.value.y,f.value.y,alpha,hz)):f.value&&f.value.lerp&&f.value.lerp(t.value,alpha,hz)))}}}),"static"),Class((function ShaderUILConfig(_shader,_uil){var _textures,_this=this;const prefix=_shader.UILPrefix;var _group=_uil&&!ShaderUIL.exists[prefix]?function createFolder(){if(!UIL.sidebar)return null;let label=function getName(){let split=_shader.UILPrefix.split("/");return split.length>2?split[0]+"_"+split[2]:split[0]}();"_"==label.charAt(label.length-1)&&(label=label.slice(0,-1));let folder=new UILFolder(prefix+label,{label:label,closed:!0});return _uil.add(folder),folder}():null;function createVector(obj,key){let initValue=UILStorage.get(`${prefix}${key}`)||obj.value.toArray();if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05,description:obj.description});vector.onChange((val=>{obj.value.fromArray(val),_shader.ubo&&(_shader.ubo.needsUpdate=!0)})),_this["forceUpdate"+key.toUpperCase()]=_=>{let val=_shader.get(key).toArray();vector.force(val,!0)},vector.onFinishChange((e=>UILStorage.set(`${prefix}${key}`,e))),UILStorage.state.bind(`${prefix}${key}`,(val=>vector.setValue(val))),_group.add(vector)}obj.value.fromArray(initValue)}function createTexture(obj,key){let getTexture;_group&&!_textures&&(_textures={}),getTexture=obj.cube?obj.getTexture||ShaderUIL.getCubeTexture||Utils3D.getCubeTexture:obj.getTexture||ShaderUIL.getTexture||Utils3D.getTexture;const set=_shader.parent&&_shader.parent.setOverride?_shader.parent.setOverride:_shader.set||_shader.setUniform;_shader.get||_shader.getUniform;let prefix=_shader.UILPrefix+"_tx",data=UILStorage.get(`${prefix}_${key}`);"string"==typeof data&&(data=JSON.parse(data));let value=data?data.src:null,change=data=>{if("string"==typeof data&&(data=JSON.parse(data)),!data)return;let val=data.src,cleanPath=val.includes("?")&&!data.hotreload?val.split("?")[0]:val;data.compressed&&(val+="-compressedKtx","ktx2"===data.compressed&&(val+="2")),_textures&&(_textures[cleanPath]=change),data.src=cleanPath,UILStorage.set(`${prefix}_${key}`,data),set(key,getTexture(val,{premultiplyAlpha:obj.premultiplyAlpha,scale:obj.scale}),_shader)};if(value&&value.length&&change(data),_group){let compressOptions={};obj.cube&&(compressOptions.cube=!0);let img=new UILControlImage(prefix+key,{label:key,value:data,description:obj.description,compressOptions:compressOptions});img.onFinishChange(change),_group.add(img),UILStorage.state.bind(`${prefix}_${key}`,(val=>change(val))),_this["forceUpdate"+key.toUpperCase()]=_=>{img.force(_shader.get(key),!0)}}}function createNumber(obj,key){let initValue=UILStorage.get(`${prefix}${key}`);if(void 0===initValue&&(initValue=obj.value),_group){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05,description:obj.description});number.onChange((val=>{_shader.ubo&&(_shader.ubo.needsUpdate=!0),obj.value=Number(val)})),number.onFinishChange((e=>UILStorage.set(`${prefix}${key}`,e))),_group.add(number),_this["forceUpdate"+key.toUpperCase()]=_=>{number.forceUpdate(Number(_shader.get(key)),!0)},UILStorage.state.bind(`${prefix}${key}`,(val=>number.setValue(val)))}obj.value=initValue}function createColor(obj,key){let initValue=UILStorage.get(`${prefix}${key}`)||obj.value.getHexString();if(_group){let color=new UILControlColor(`${prefix}${key}`,{label:key,value:initValue,description:obj.description});UILStorage.state.bind(`${prefix}${key}`,(val=>color.setValue(val))),color.onChange((val=>{obj.value.set(val),_shader.ubo&&(_shader.ubo.needsUpdate=!0)})),color.onFinishChange((e=>UILStorage.set(`${prefix}${key}`,e))),_group.add(color),_this["forceUpdate"+key.toUpperCase()]=_=>{color.force(_shader.get(key).getHexString(),!0)}}initValue&&obj.value.set(initValue)}function createSelect(obj,key){let initValue=UILStorage.get(`${prefix}${key}`);if(_group){UILStorage.state.bind(`${prefix}${key}`,(val=>obj.val=val));let{options:options,description:description}=obj,select=new UILControlSelect(`${prefix}${key}`,{label:key,value:initValue,options:options,description:description});select.onChange((val=>{_group&&Events.emitter._fireEvent(ShaderUIL.UPDATE,{prefix:prefix,key:key,val:val,group:_this}),obj.value=val,UILStorage.set(`${prefix}${key}`,val)})),_group.add(select)}initValue&&(obj.value=initValue)}function textureUpdate(e){if(!_textures)return;let cleanPath=e.file.split("?")[0];for(let key in _textures){cleanPath==(key.includes("?")?key.split("?")[0]:key)&&_textures[key]({src:e.file,hotreload:!0})}}function update(e){if(e.prefix==_shader.UILPrefix&&e.group!=_this)if(e.color){let val=e.val,obj=_shader.uniforms[e.key];Array.isArray(val)?obj.value.setRGB(val[0],val[1],val[2]):obj.value.set(val)}else e.texture?"remote"!=e.texture&&_shader.set(e.key,e.texture):e.vector?_shader.uniforms[e.key].value.fromArray(e.val):_shader.uniforms[e.key].value=e.val}this.group=_group,this.shader=_shader,_group&&(_shader.shaderUIL=_this),function initItems(){for(var key in _shader.uniforms){let obj=_shader.uniforms[key];obj&&!obj.ignoreUIL&&(obj.options&&Array.isArray(obj.options)?createSelect(obj,key):("number"==typeof obj.value&&createNumber(obj,key),obj.value instanceof Color&&createColor(obj,key),(null===obj.value||obj.value instanceof Texture)&&createTexture(obj,key),obj.value instanceof Vector2&&createVector(obj,key),obj.value instanceof Vector3&&createVector(obj,key),obj.value instanceof Vector4&&createVector(obj,key)))}}(),_group&&function addListeners(){Events.emitter._addEvent(ShaderUIL.UPDATE,update,_this),Events.emitter._addEvent(ShaderUIL.TEXTURE_UPDATE,textureUpdate,_this)}(),this.setLabel=function(name){_group&&_group.setLabel(name)},this.forceUpdate=function(e){e.prefix=_shader.UILPrefix,update(e),_this["forceUpdate"+e.key.toUpperCase()]?.()},this.copyTexture=function(key,shader){let newPrefix=shader.UILPrefix+"_tx",prefix=_shader.UILPrefix+"_tx",data=UILStorage.get(`${prefix}_${key}`);data&&UILStorage.set(`${newPrefix}_${key}`,data)}})),Class((function ShadowUIL(){this.add=function(light,group){return new ShadowUILConfig(light,null===group?null:group||UIL.global)}}),"static"),Class((function ShadowUILConfig(_light,_uil){if(!_light.prefix)throw"light.prefix required when using MeshUIL";var prefix="SHADOW_"+_light.prefix,_group=_uil?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:_light.prefix,closed:!0});return _uil.add(folder),folder}():null;function initNumber(key){let initValue=UILStorage.get(`${prefix}${key}`)||_light.shadow[key];if(_group){UILStorage.state.bind(`${prefix}${key}`,(val=>_light.shadow[key]=val));let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onFinishChange((e=>{_light.shadow[key]=e,UILStorage.set(`${prefix}${key}`,e)})),_group.add(number)}_light.shadow[key]=initValue}function initVec(key){let initValue=UILStorage.get(`${prefix}${key}`)||_light[key].toArray();if(_group){UILStorage.state.bind(`${prefix}_${key}`,(val=>_light[key].fromArray(val)));let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange((e=>{_light[key].fromArray(e),"target"==key&&_light.shadow.camera.lookAt(_light.target)})),vector.onFinishChange((e=>{_light[key].fromArray(e),"target"==key&&_light.shadow.camera.lookAt(_light.target),UILStorage.set(`${prefix}${key}`,e)})),_group.add(vector)}_light[key].fromArray(initValue)}_light.target=_light.shadow.target,initVec("position"),initVec("target"),initNumber("fov"),initNumber("size"),initNumber("area"),initNumber("near"),initNumber("far"),function initTick(key){let initValue=UILStorage.get(`${prefix}${key}`);if(_group){UILStorage.state.bind(`${prefix}_${key}`,(val=>_light[key]=val));let tick=new UILControlCheckbox(`${prefix}${key}`,{label:key,value:initValue});tick.onFinishChange((e=>{_light[key]=e,UILStorage.set(`${prefix}${key}`,e)})),_group.add(tick)}_light[key]=initValue}("static"),this.setLabel=function(name){_group&&_group.setLabel(name)}})),Class((function TimelineUIL(){Inherit(this,Component);const _this=this;var _panel,_created={};function removePanel(){_panel&&_panel.destroy&&(_this.events.unsub(_panel,Events.COMPLETE,removePanel),_panel=_panel.destroy())}this.create=function(id,version=1,group){"number"!=typeof version&&(group=version,version=1),group=null===group?null:group||UIL.global;let config=new TimelineUILConfig(id,version,UIL.global&&!_created[id]);return UIL.global&&(_created[id]||(_created[id]=config,null!=group&&config.appendUILGroup(group||UIL.global))),config},this.openPanel=function(id,name,template){return removePanel(),_panel=new TimelineUILEditor(id,name,template),_this.events.sub(_panel,Events.COMPLETE,removePanel),_panel},this.set=function(){},this.get=function(){}}),"static"),Class((function TimelineUILConfig(_id,_version=1,_store){Inherit(this,Component);const _this=this;var _items,_folder,_config,_template={onSort:_=>{},onAdd:_=>{},onRemove:_=>{}},_name="";function name(){return`TL_${_id}_config`}function updateConfig(){_config.version=_version}function edit(){let panel=TimelineUIL.openPanel(name(),_name,_this.template);_this.events.bubble(panel,Events.UPDATE),_this.events.fire(TimelineUIL.OPEN)}this.model=new TimelineUILModel(name()),_store&&(_items=[]),function initConfig(){(_config=UILStorage.get(name()))?_config.version!=_version&&updateConfig():(_config={},updateConfig())}(),this.add=function(item){return _items&&_items.push(item),item},this.template=function(config){return"function"==typeof config&&(_template=config),_template},this.appendUILGroup=function(uil){let folder=new UILFolder("TL_"+_id,{closed:!0}),button=new UILControlButton("button",{actions:[{title:"Edit Timeline",callback:edit}],hideLabel:!0});folder.add(button),uil.add(folder),_folder=folder},this.setLabel=function(name){_folder&&_folder.setLabel(name),_name=name},this.onAdd=function(cb){_template.onAdd=cb},this.onRemove=function(cb){_template.onRemove=cb},this.onSort=function(cb){_template.onSort=cb},this.internalAddItems=function(count){if(!count)return;let array=[];for(let i=0;i<count;i++){let id=`${_id}_${Utils.timestamp()}`;array.push(id)}UILStorage.set(`${_id}_list_items`,JSON.stringify(array))}}),(_=>{TimelineUIL.OPEN="list_uil_open"})),Class((function TimelineUILEditor(_id,_name,_template){Inherit(this,Component);const _this=this,PANEL_CONFIG={label:"Timeline Editor",width:"800px",height:"auto",drag:!0};var _gui,_list,_add,_config,_items,_tabs=[],_index=0;function initList(){!function read(){let data=UILStorage.get(`${_id}_list_items`);void 0===data&&(data="[]");_items=JSON.parse(data)}(),_list=new UILFolder(`${_id}_list`,{hideTitle:!0}),_gui.add(_list);for(let id of _items){let view=_this.initClass(TimelineUILItem,id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view)}_config.rails&&function attachRails(){_tabs.forEach(((t,i)=>{t.onUpdate=v=>{_tabs.forEach(((t2,j)=>{t2!=t&&(j<i&&t.getValue()<t2.getValue()&&t2.setValue(t.getValue()),j>i&&t.getValue()>t2.getValue()&&t2.setValue(t.getValue()))}))}}))}()}function initButton(title,callback){let btn=new UILControlButton("button",{actions:[{title:title,callback:callback}],hideLabel:!0});return _gui.add(btn),btn}function spaceEvenly(){_tabs.forEach(((t,i)=>{let perc=Math.range(i,0,_tabs.length-1,0,1);t.setValue(perc)}))}function add(){let id=`${_id}_${Utils.timestamp()}`,view=new TimelineUILItem(id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view),_items.push(id),write()}function reorder(e){let order=[];for(let item of e.order)order.push(item.split("_folder")[0]);_items=order,_template().onSort(_items),write(),_this.events.fire(Events.UPDATE,{order:order})}function remove(e){_items.remove(e.id),write(),refresh()}function write(){let data=JSON.stringify(_items);UILStorage.set(`${_id}_list_items`,data)}function refresh(){_index=0,_list&&_list.destroy&&(_list=_list.destroy()),_add&&_add.destroy&&(_add=_add.destroy()),initList(),function initAdd(){_config.lock||(_add=initButton("Add Item",add)).element.css({width:"20%"}),initButton("Space Evenly",spaceEvenly).element.css({width:"20%"})}()}_this.config=_config=JSON.parse(UILStorage.get(`${_id}_config`)||"{}"),function initPanel(){_this.gui=_gui=new UILWindow(_id,PANEL_CONFIG),UIL.add(_gui)}(),refresh(),this.onDestroy=function(){_gui.destroy()}})),Class((function TimelineUILItem(_id,_parent,_template,_index){Inherit(this,Component);const _this=this;var _folder;function onDelete(){if(!confirm("You sure you want to delete this?"))return;let id=_id;_template().onRemove(id),_this.events.fire(Events.END,{id:id})}function onReorder(e){_this.events.fire(Events.UPDATE,e)}!async function initFolder(){(_folder=InputUIL.create(`${_id}_folder`,_parent)).setLabel("Item"),_this.parent&&_this.parent.config.lock||_folder.group.draggable(!0),_this.events.sub(_folder.group,UIL.REORDER,onReorder),_folder.group.open()}(),function initTemplate(){let id=_id;(0,_template().onAdd)(id,_folder,_index)}(),function initUI(){_folder.add("label",_this.parent&&_this.parent.config.lock?"hidden":void 0),_folder.addRange("keyframe"),_folder.add("percent","hidden"),_folder.getField("keyframe").force(Math.round(100*_folder.getNumber("percent"))||0),_folder.onUpdate=key=>{if("keyframe"==key){let val=_folder.getNumber(key)/100;_folder.setValue("percent",val),_this.onUpdate&&_this.onUpdate(val)}};let label=_folder.get("label");if(label&&_folder.setLabel(label),!_this.parent||!_this.parent.config.lock){let actions=[{title:"Delete",callback:onDelete}],hideLabel=!0,btn=(_folder.addButton("delete",{actions:actions,hideLabel:hideLabel}),_folder.getField("delete"));btn&&btn.$content.css({width:"20%"})}}(),this.setLabel=function(label){_folder.setLabel(label)},this.getValue=function(value){return _folder.getNumber("percent")},this.setValue=function(value){_folder.setValue("percent",value),_folder.getField("keyframe").force(Math.round(100*value)||0)}})),Class((function TimelineUILModel(_id){var _items,_config,_data=[],_map={};!function initItems(){_config=JSON.parse(UILStorage.get(`${_id}_config`)||"{}"),_items=JSON.parse(UILStorage.get(`${_id}_list_items`)||"[]")}(),function initData(){_items.forEach(((item,i)=>{let input=InputUIL.create(`${item}_folder`,null,null,!!UIL.global),data={};data.label=input.get("label")||"Item",data.value=input.getNumber("percent")||0,data.arbitrary=input.get("arbitrary"),_data.push(data),_map[data.label]=data,UIL.global&&Render.start((_=>{data.label=input.get("label")||"Item",data.value=input.getNumber("percent")||0}),10)}))}(),this.setState=function(array){for(let i=0;i<array.length;i++)_items[i]||_items.push(`${_id}_${Utils.timestamp()}`);_items.length>array.length&&(_items=_items.slice(0,array.length)),_items.forEach(((item,i)=>{let data=array[i],input=InputUIL.create(`${item}_folder`,null);input.setValue("label",data.label),data.percent&&input.setValue("percent",data.percent),data.arbitrary&&input.setValue("percent",data.arbitrary)})),UILStorage.set(`${_id}_list_items`,JSON.stringify(_items))},this.lock=function(){return _config.lock||(_config.lock=!0,UIL.global&&UILStorage.set(`${_id}_config`,JSON.stringify(_config))),this},this.rails=function(){return _config.rails||(_config.rails=!0,UIL.global&&UILStorage.set(`${_id}_config`,JSON.stringify(_config))),this},this.getData=function(){return _data},this.get=function(key){return _map[key]}})),Class((function CameraLookAtHelper(){Inherit(this,Component);const _this=this;let _camera,_object,_defaultLookAt,_tweener={alpha:0},_lookAt=new Vector3;function update(){_lookAt.copy(_defaultLookAt),_tweener.alpha>0&&_lookAt.lerp(_object.position,_tweener.alpha,!1)}_this.get("tweener",(()=>_tweener)),_this.create=async function(camera,object,tween){_camera=camera,_object=object,_defaultLookAt=_camera.lookAt,await tween.loaded(),_camera.lookAt=_lookAt,_this.events.sub(tween,TweenUIL.UPDATED,update)}})),Class((function TweenUIL(){Inherit(this,Component);const _this=this;var _getServerTime,_folders={},_activeFolder="Tweens",_cache={},_counters={},_synchronizedTweens=[];function synchronizedPlaybackLoop(){let i=_synchronizedTweens.length-1;if(i<0)return;let serverTime=_getServerTime();for(;i>=0;){let tween=_synchronizedTweens[i];if(tween.seekImmediate){let duration=1e3*tween.duration,progress=serverTime%duration/duration;tween.seekImmediate(progress),i-=1}else if(_synchronizedTweens.splice(i,1),0===_synchronizedTweens.length){_this.stopRender(synchronizedPlaybackLoop);break}}}_this.jsons={},this.TOGGLE="tweenuil_toggle",Theatre.core.setCoreRafDriver(Theatre.core.createRafDriver({name:"no-op driver"})),_this.startRender(synchronizedPlaybackLoop),this.create=function(name,config,group){"boolean"==typeof group&&(group=void 0);let noCache=!1;"nocache"==group&&(_counters[name]=(_counters[name]||0)+1,noCache=!0,group=void 0);let folderName=_activeFolder;if("string"==typeof group&&(folderName=group,group=null),_folders[folderName]||function initFolder(){if(UIL.global){let folder=new UILFolder(_activeFolder,{label:_activeFolder,closed:!0});_folders[_activeFolder]=folder,UIL.global.add(folder)}}(),!_cache[name]||noCache){let tween=new TweenUILConfig(name,config,group||_folders[folderName],_counters[name]);tween._bindOnDestroy((_=>{delete _cache[name]})),_cache[name]=tween}return _cache[name]},this.setFolder=function(name){_activeFolder=name},this.setServerTimeGetter=function(getServerTime){_getServerTime=getServerTime},this.playSynchronized=async function(tween){_getServerTime?(await tween.preload(),tween.progress,tween.manualRender=!0,_synchronizedTweens.unshift(tween)):console.error("Need to call TweenUIL.setServerTimeGetter(() => time) before using TweenUIL.playSynchronized()")},this.stopSynchronized=function(tween){_synchronizedTweens.remove(tween)}}),"static"),Class((function TweenUILAnchor(){Inherit(this,Object3D);this.isTweenAnchor=!0})),Class((function TweenUILConfig(_name,_config,_group,_noCache){Inherit(this,Component);const _this=this;var _input,_editor,_promise,_project,_meshes,_keyframes,_pathVisualization,_projectInstanceId,_objectsWithTracks,_savedState,_rafDriver,_layersWithWarnings={},_flatMap={},_sheets={},_duration=0,_manualRender=!1,_changedKeys={},_cameras=[],_audioFile=!1;function loop(){_this.events.fire(TweenUIL.BEFORE_UPDATE),Object.keys(_flatMap).forEach((key=>_changedKeys[key]=!1)),_rafDriver.tick(Render.TIME),_this.events.fire(TweenUIL.UPDATED,{changed:_changedKeys}),_cameras.forEach((camera=>camera.update()))}function initObjectsWithTracks(state){_objectsWithTracks||(_objectsWithTracks={}),[state.staticOverrides?.byObject,state.sequence?.tracksByObject].filter(Boolean).forEach((table=>{Object.keys(table).forEach((key=>{let parts=key.split(" » "),name=parts.length>1?parts.last():key,matches=/(.*)_(shader|behavior)$/.exec(name);matches&&(name=matches[1]),_objectsWithTracks[name]=!0}))}))}function ignoreObject(name,layoutName){return!!_objectsWithTracks&&!_objectsWithTracks[name]}function findTrueDuration(sequence){let duration=0,tracks=sequence.tracksByObject;for(let k1 in tracks){let obj=tracks[k1];"tween_anchor"==k1&&findAnchorKeyframes(obj);for(let k2 in obj.trackData){let trackData=obj.trackData[k2];for(let k3 in trackData.keyframes){let keyframe=trackData.keyframes[k3];keyframe.position&&(duration=Math.max(duration,keyframe.position))}}}return duration}function checkDuration(){if(0===_duration)for(let key in _sheets)_duration=Math.max(_duration,_sheets[key].length)}function findAnchorKeyframes(obj){for(let k1 in obj)for(let k2 in obj[k1]){let keyframes=obj[k1][k2].keyframes;keyframes&&(_keyframes=keyframes)}}async function play(options={}){_config.sheets||(await prepareConfig(),linkLocally()),checkDuration();for(let key in _sheets)options.disableAutoPosition||(_sheets[key].sequence.position="reverse"===options?.direction?_duration:0),_sheets[key].sequence.play({...options,rafDriver:_rafDriver});return _promise=_this.wait(1e3*_duration)}function linkLocally(){makeSendable().sheets.forEach((obj=>{const sheet=_sheets[_config.mergedSheetName];if(sheet)for(let key in obj){for(let key2 in obj[key]){let finalObj=obj[key][key2];"number"==typeof finalObj.r&&"number"==typeof finalObj.g&&"number"==typeof finalObj.b&&Object.assign(finalObj,Theatre.core.types.rgba(finalObj))}sheet.object(getTrackNameFromKey(key),obj[key]).onValuesChange((newValue=>{_changedKeys[key]=!0,completeDataLink(newValue,_flatMap[key])}),_rafDriver)}}))}function getTrackNameFromKey(key,disambiguate=!1){let name=key.split("&"),prefix=name[0];return name.shift(),name=name.join("_"),disambiguate&&(name=`${prefix} » ${name}`),name}async function prepareConfig(){let array=Array.isArray(_config)?_config:[_config];_config={},_audioFile&&(_config.audioFile=_audioFile),_config.nudgeMultiplier=.05;let sheet={};_config.sheets=[sheet];for(let i=0;i<array.length;i++){let layoutName,objects=array[i],options={};if(objects instanceof SceneLayout)layoutName=objects.name,options.isSceneLayout=!0,objects=await getObjectsFromLayout(objects);else{if("object"!=typeof objects)throw"TweenUIL :: Type not supported";if(0===i){let obj0=objects[Object.keys(objects)[0]];obj0 instanceof Mesh?layoutName="Scene":obj0.uniforms?layoutName="Shader":isElement(obj0)&&(layoutName="Elements")}}layoutName||(layoutName=`Scene${i+1}`),mergeSheets(sheet,createSheetFromObjects(objects,layoutName,options)),0===i&&(_config.mergedSheetName=layoutName)}_this.flag("isLoaded",!0)}function mergeSheets(sheet1,sheet2){let usedNames={};return Object.keys(sheet1).forEach((key=>{usedNames[getTrackNameFromKey(key)]=!0})),Object.keys(sheet2).forEach((key=>{let name=getTrackNameFromKey(key),newKey=key;usedNames[name]&&(name=getTrackNameFromKey(key,!0),newKey=`${key.split("&")[0]}&${name}`,_flatMap[newKey]=_flatMap[key],delete _flatMap[key]),usedNames[name]=!0,sheet1[newKey]=sheet2[key]})),sheet1}function makeEulerLink(layer,key){return{copy:obj=>{layer[key].set(Math.radians(obj.x),Math.radians(obj.y),Math.radians(obj.z))},get x(){return Math.degrees(layer[key].x)},get y(){return Math.degrees(layer[key].y)},get z(){return Math.degrees(layer[key].z)}}}function getMeshObject(layer,parent,layerName){if(parent?.isTweenAnchor){let obj={};return obj.anchor={anchor:0,link:{copy(){}}},obj}layer.rotationLink=makeEulerLink(layer,"rotation");let obj={position:{x:layer.position.x,y:layer.position.y,z:layer.position.z,link:layer.position},scale:{x:layer.scale.x,y:layer.scale.y,z:layer.scale.z,link:layer.scale},rotation:{x:Math.degrees(layer.rotation.x),y:Math.degrees(layer.rotation.y),z:Math.degrees(layer.rotation.z),link:layer.rotationLink}};if(layer._cameraUIL){obj.cameraPos={x:parent.position.x,y:parent.position.y,z:parent.position.z,link:{copy(from){parent.move(from)}}},obj.projection={zoom:parent.zoom,fov:parent.getFOV(),near:parent.near,far:parent.far,link:{copy(from){parent.setProjectionProperties(from)}}},obj.lookAt={x:parent.lookAt.x,y:parent.lookAt.y,z:parent.lookAt.z,link:parent.lookAt},obj.moveXY={x:parent.moveXY.x,y:parent.moveXY.y,link:parent.moveXY},obj.cameraRotation={x:Math.degrees(parent.cameraRotation.x),y:Math.degrees(parent.cameraRotation.y),z:Math.degrees(parent.cameraRotation.z),link:makeEulerLink(parent,"cameraRotation")},obj.viewportFocus={x:parent.viewportFocus.x,y:parent.viewportFocus.y,link:parent.viewportFocus};let camera=layer.classRef;camera.manualRender=!0,_cameras.push(camera)}return UIL.global&&(_meshes||(_meshes=[]),layer._uilLayerName=layerName,_meshes.push(layer)),parent?.tweenToggle&&(obj.toggle={on:0,link:{copy:e=>{0==e.on&&parent.flag("tweenToggle")?(parent.flag("tweenToggle",!1),parent.events.fire(TweenUIL.TOGGLE,{on:!1})):1!=e.on||parent.flag("tweenToggle")||(parent.events.fire(TweenUIL.TOGGLE,{on:!0}),parent.flag("tweenToggle",!0))}}}),obj}function getShaderObject(shader){let obj={};for(let key in shader.uniforms){let uniform=shader.uniforms[key],value=uniform.value;void 0===value||uniform.ignoreUIL&&!uniform.enableTweenUIL||"HZ"==key||("number"==typeof value?obj[key]={value:value,link:uniform}:value instanceof Vector2?obj[key]={x:value.x,y:value.y,link:value}:value instanceof Vector3?obj[key]={x:value.x,y:value.y,z:value.z,link:value}:value instanceof Vector4?obj[key]={x:value.x,y:value.y,z:value.z,w:value.w,link:value}:value instanceof Color&&(obj[key]={r:value.r,g:value.g,b:value.b,a:1,link:value}))}return obj}function isElement(object){return!!object?.div?.hydraObject||void 0!==GLUIObject&&(object instanceof GLUIObject||object instanceof GLUIText)}function getElementObject($element){let obj={_config:{nudgeMultiplier:1}};return void 0!==$element.x&&(obj.x={value:$element.x,link:$element}),void 0!==$element.y&&(obj.y={value:$element.y,link:$element}),void 0!==$element.z&&(obj.z={value:$element.z,link:$element}),void 0!==$element.scale&&(obj.scale={value:$element.scale,link:$element}),void 0!==$element.scaleX&&(obj.scaleX={value:$element.scaleX,link:$element}),void 0!==$element.scaleY&&(obj.scaleY={value:$element.scaleY,link:$element}),void 0!==$element.rotation&&(obj.rotation={value:$element.rotation,link:$element}),void 0!==$element.rotationX&&(obj.rotationX={value:$element.rotationX,link:$element}),void 0!==$element.rotationY&&(obj.rotationY={value:$element.rotationY,link:$element}),void 0!==$element.rotationZ&&(obj.rotationZ={value:$element.rotationZ,link:$element}),void 0!==$element.alpha&&(obj.alpha={value:$element.alpha,link:$element}),obj}function getPlainObject(object){let obj={};for(let key in object){let value=object[key];"number"==typeof value?obj[key]={value:value,link:object}:value instanceof Vector2?obj[key]={x:value.x,y:value.y,link:value}:value instanceof Vector3?obj[key]={x:value.x,y:value.y,z:value.z,link:value}:value instanceof Vector4?obj[key]={x:value.x,y:value.y,z:value.z,w:value.w,link:value}:value instanceof Color&&(obj[key]={r:value.r,g:value.g,b:value.b,a:1,link:value})}if(Object.keys(obj).length)return obj}async function getObjectsFromLayout(layout){let layers=await layout.getAllLayers(),objects={};for(let key in layers){let layer=layers[key];ignoreObject(key,layout.name)||!1!==layer.animates&&(layer.ready&&!layer.disabled&&await layer.ready(),objects[key]=layer)}return objects}function createSheetFromObjects(objects,layoutName,{isSceneLayout:isSceneLayout}){let sheet={};for(let name in objects){let object=objects[name],key=`${layoutName}&${name}`;if(ignoreObject(name))continue;let matched=!1;if(object.uniforms)_flatMap[key]=sheet[key]=getShaderObject(object);else if(isElement(object))_flatMap[key]=sheet[key]=getElementObject(object);else if((object instanceof Mesh||object instanceof Group)&&(_flatMap[key]=sheet[key]=getMeshObject(object,null,key),matched=!0),object.shader&&(_flatMap[`${key}&shader`]=sheet[`${key}&shader`]=getShaderObject(object.shader),matched=!0),object.behavior&&(_flatMap[`${key}&behavior`]=sheet[`${key}&behavior`]=getShaderObject(object.behavior),matched=!0),object.group&&(_flatMap[key]=sheet[key]=getMeshObject(object.group,object,key),matched=!0),!matched&&!isSceneLayout){let obj=getPlainObject(object);obj?_flatMap[key]=sheet[key]=obj:console.warn(`Unclear how to animate object ${key}`,object)}}return sheet}function makeSendable(){const cleanObject=obj=>{let newObj={};for(let key in obj)"link"!=key&&(newObj[key]=obj[key]);return newObj};let obj={sheets:[],nudgeMultiplier:_config.nudgeMultiplier};return _audioFile&&(obj.audioFile=_audioFile),obj.filePath=Assets.getPath(`assets/data/timeline-${_name}.json`),obj.filePath.includes("http")||(obj.filePath=Hydra.absolutePath(obj.filePath)),_config.sheets.forEach((sheet=>{let newSheet={};for(let key in sheet){let top=sheet[key];newSheet[key]={};for(let key2 in top)newSheet[key][key2]=cleanObject(top[key2])}obj.sheets.push(newSheet)})),obj}function completeDataLink(dataObj,realObj){let transform;for(let key2 in realObj){if("_config"===key2)continue;let valueObj=dataObj[key2],link=realObj[key2].link;void 0!==valueObj.value?(!Object.prototype.hasOwnProperty.call(link,key2)&&Object.prototype.hasOwnProperty.call(link,"value")?link.value=valueObj.value:link[key2]=valueObj.value,transform=link.transform,transform&&"alpha"==key2&&link.css("opacity",valueObj.value)):link.copy(valueObj)}transform&&transform()}function linkData(data){for(let key in data){let dataObj=data[key],realObj=_flatMap[key];_changedKeys[key]=!0,completeDataLink(dataObj,realObj)}}async function openEditor(){_config.sheets||await prepareConfig(),_editor&&_editor.close(),(_editor=new UILExternalTimeline(_name,800,1200,makeSendable())).onMessage=linkData,_editor.onVisualizePath=handleVisualizePath,_editor.onPositionChange=onPositionChange,_this.state.editorOpen=!0,_editor.onDestroy=_=>{_editor=null,_this.state.editorOpen=!1,handleVisualizePath({}),_meshes?.forEach((mesh=>{mesh._cameraUIL&&(mesh._cameraUIL.tweenUIL_groupPos=null,mesh._cameraUIL.tweenUIL_scale=null,mesh._cameraUIL.tweenUIL_rotation=null,mesh._cameraUIL.tweenUIL_position=null,mesh._cameraUIL.tweenUIL_zoom=null,mesh._cameraUIL.tweenUIL_fov=null,mesh._cameraUIL.tweenUIL_near=null,mesh._cameraUIL.tweenUIL_far=null,mesh._cameraUIL.tweenUIL_lookAt=null,mesh._cameraUIL.tweenUIL_cameraRotation=null,mesh._cameraUIL.tweenUIL_viewportFocus=null),mesh._meshUIL&&(mesh._meshUIL.tweenUIL_scale=null,mesh._meshUIL.tweenUIL_position=null,mesh._meshUIL.tweenUIL_rotation=null)}))},_meshes?.forEach((mesh=>{mesh._cameraUIL?(mesh._cameraUIL.tweenUIL_groupPos=value=>_editor.sendUpdate(mesh._uilLayerName,value,"position"),mesh._cameraUIL.tweenUIL_scale=value=>_editor.sendUpdate(mesh._uilLayerName,value,"scale"),mesh._cameraUIL.tweenUIL_rotation=value=>_editor.sendUpdate(mesh._uilLayerName,value,"rotation"),mesh._cameraUIL.tweenUIL_position=value=>_editor.sendUpdate(mesh._uilLayerName,value,"cameraPos"),mesh._cameraUIL.tweenUIL_zoom=value=>_editor.sendUpdate(mesh._uilLayerName,{zoom:value},"projection"),mesh._cameraUIL.tweenUIL_fov=value=>_editor.sendUpdate(mesh._uilLayerName,{fov:value},"projection"),mesh._cameraUIL.tweenUIL_near=value=>_editor.sendUpdate(mesh._uilLayerName,{near:value},"projection"),mesh._cameraUIL.tweenUIL_far=value=>_editor.sendUpdate(mesh._uilLayerName,{far:value},"projection"),mesh._cameraUIL.tweenUIL_lookAt=value=>_editor.sendUpdate(mesh._uilLayerName,value,"lookAt"),mesh._cameraUIL.tweenUIL_cameraRotation=value=>_editor.sendUpdate(mesh._uilLayerName,value,"cameraRotation"),mesh._cameraUIL.tweenUIL_viewportFocus=value=>_editor.sendUpdate(mesh._uilLayerName,value,"viewportFocus")):mesh._meshUIL&&(mesh._meshUIL.tweenUIL_position=value=>_editor.sendUpdate(mesh._uilLayerName,value,"position"),mesh._meshUIL.tweenUIL_scale=value=>_editor.sendUpdate(mesh._uilLayerName,value,"scale"),mesh._meshUIL.tweenUIL_rotation=value=>_editor.sendUpdate(mesh._uilLayerName,value,"rotation"))}))}function updateKeyframeData(){for(let key in _sheets)_this.keyframeTotalProgress=_keyframes.positionObject.position/_sheets[key].length;_this.keyframeIndex=_keyframes.current,_this.keyframeLocalProgress=Math.fract(_keyframes.positionObject.position)}function updateKeyframeLoop(hz){_keyframes.positionObject.position=Math.lerp(_keyframes.positionObject.target,_keyframes.positionObject.position,.07*hz,!1);for(let key in _sheets)_sheets[key].sequence.position=_keyframes.positionObject.position;updateKeyframeData()}function onPositionChange(position){_this.state.editorPosition=position}function handleVisualizePath(data){if(!_pathVisualization&&!data.position)return;let object;if(_pathVisualization||(_pathVisualization=_this.initClass(TweenUILPathVisualization)),data.sheetId){let parts=data.objectKey.split(" » "),prefix=parts.length>1?parts[0]:data.sheetId,objectKey=parts.length>1?parts.last():data.objectKey,key=`${prefix}&${objectKey}`;object=_meshes.find((({_uilLayerName:_uilLayerName})=>_uilLayerName===key)),!object&&parts.length<=1&&(object=_meshes.find((({_uilLayerName:_uilLayerName})=>_uilLayerName?.split("&")?.[1]===objectKey))),object||_layersWithWarnings[key]||(console.warn(`Couldn’t find mesh for object “${key}”.`),_layersWithWarnings[key]=!0)}_pathVisualization.object=object,_pathVisualization.update(data)}!async function(){_this.state=AppState.createLocal({editorOpen:!1,editorPosition:0}),function initRafDriver(){_rafDriver=Theatre.core.createRafDriver({name:["TweenUIL",_name,_noCache].filter(Boolean).join("_")}),_this.startRender(loop)}(),(_input=InputUIL.create(_name+"_tween",_group)).setLabel(_name),_input.addButton("edit",{label:"Edit",actions:[{title:"Editor",callback:openEditor}]});try{if(_savedState=TweenUIL.jsons[_name],_savedState?.then&&(_savedState=await _savedState),!_savedState){let promise=get(Assets.getPath(`assets/data/timeline-${_name}.json`));if(_noCache&&(TweenUIL.jsons[_name]=promise),"string"==typeof(_savedState=await promise))throw new Error("Malformed TweenUIL timeline")}_noCache&&(_projectInstanceId=`instance_${_noCache}`,TweenUIL.jsons[_name]=_savedState)}catch{Hydra.LOCAL&&console.warn(`No saved TweenUIL timeline “timeline-${_name}.json”, create one with the Editor`),_savedState={sheetsById:{},definitionVersion:"0.4.0",revisionHistory:[]}}_project=Theatre.core.getProject(_name,{state:_savedState}),_this._bindOnDestroy((_=>{_project.destroy()})),await _project.ready;for(let key in _savedState.sheetsById){_sheets[key]=_project.sheet(key,{instanceId:_projectInstanceId});let state=_savedState.sheetsById[key];_group||initObjectsWithTracks(state),_sheets[key].length=findTrueDuration(state.sequence)}_input.addButton("play",{label:"Play",actions:[{title:"Play",callback:play}]}),_input.addRange("Scrub",0,{min:0,max:1,step:5e-4}),_input.onUpdate=async key=>{if("Scrub"==key){_config.sheets||await play();let value=_input.getNumber("Scrub");_this.seek(value)}},_this.flag("ready",!0)}(),this.play=async function(options){return await _this.wait("ready"),play(options)},this.seek=function(value){if(_this.flag("ready")){checkDuration();for(let key in _sheets)_sheets[key].sequence.position=Math.min(_sheets[key].length,_duration*value)}},this.seekImmediate=function(value){_this.seek(value),loop()},this.promise=async function(){return await _this.wait("ready"),_promise},this.setLabel=function(label){_input&&_input.setLabel(label)},this.preload=async function(){if(await _this.wait("ready"),_config.sheets){if(!_this.flag("isLoaded"))return _this.wait("isLoaded")}else await prepareConfig(),linkLocally();_this.seek(0)},this.loaded=async function(){if(!_this.flag("isLoaded")&&_config.sheets)return _this.wait("isLoaded");await _this.preload()},this.seekToKeyframe=async function(index){if(_this.flag("isLoaded")||await _this.preload(),!_keyframes)return console.warn("TweenUILConfig :: Missing keyframes! Add tween_anchor layer");_keyframes.current=index,_keyframes.positionObject={position:_keyframes[index].position,target:_keyframes[index].position},_this.seek(_keyframes[index].position),updateKeyframeData(),_this.startRender(updateKeyframeLoop,RenderManager.NATIVE_FRAMERATE)},this.playToKeyframe=async function(index,time,ease="linear",delay){await _this.wait("ready"),_keyframes.positionObject||await _this.seekToKeyframe(0);let nextKeyframe=_keyframes[index],currentKeyframe=_keyframes[_keyframes.current];if(!nextKeyframe)return;let position=nextKeyframe.position;return time||(time=1e3*Math.abs(nextKeyframe.position-currentKeyframe.position)),_keyframes.tween&&(_keyframes.tween=clearTween(_keyframes.tween)),_keyframes.current=index,_this.flag("playingToKeyframe",!0,time+50),_keyframes.tween=tween(_keyframes.positionObject,{target:position},time,ease,delay),_keyframes.tween.promise()},this.peekInKeyframeDirection=function(dir,percent){if(!_keyframes||_this.flag("playingToKeyframe"))return;let currentKeyframe=_keyframes[_keyframes.current],nextKeyframe=_keyframes[_keyframes.current+dir];nextKeyframe&&(_keyframes.positionObject.target=Math.mix(currentKeyframe.position,nextKeyframe.position,percent))},this.playToNextKeyframe=async function(time,ease,delay){return this.playToKeyframe(_keyframes.current+1,time,ease,delay)},this.playToPrevKeyframe=async function(time,ease,delay){return this.playToKeyframe(_keyframes.current-1,time,ease,delay)},this.playToDirKeyframe=async function(dir,time,ease,delay){return this.playToKeyframe(_keyframes.current+dir,time,ease,delay)},this.get("position",(_=>{let position=0;for(let key in _sheets)position=Math.max(position,_sheets[key]?.sequence?.position||0);return _this.state.editorOpen&&(position=_this.state.editorPosition),position})),this.get("progress",(_=>(checkDuration(),_this.position/_duration))),_this.get("duration",(()=>_duration)),this.get("totalKeyframes",(_=>_keyframes?_keyframes.length:0)),this.get("currentKeyframe",(_=>_keyframes?_keyframes.current:0)),this.get("keyframeValue",(_=>{if(!_keyframes)return 0;let position=_this.position;for(let i=0;i<_keyframes.length;++i){let keyframe=_keyframes[i];if(position>=keyframe.position){let nextKeyframe=_keyframes[i+1];if(!nextKeyframe)return keyframe.value;if(position<nextKeyframe.position)return Math.range(position,keyframe.position,nextKeyframe.position,keyframe.value,nextKeyframe.value,!0)}}return _keyframes[0]?.value||0})),_this.get("keyframeSection",(_=>Math.fract(_this.keyframeValue))),_this.getPositionAtKeyframeValue=keyframeValue=>{let index=Math.floor(keyframeValue),position=_keyframes[index]?.position||0,progress=Math.fract(keyframeValue);if(progress){let nextPosition=_keyframes[index+1]?.position;nextPosition&&(position=Math.mix(position,nextPosition,progress))}return position},_this.getProgressAtKeyframeValue=keyframeValue=>(checkDuration(),_this.getPositionAtKeyframeValue(keyframeValue)/_duration),_this.getTrackData=function(objectName){for(let key in _savedState.sheetsById){let tracks=_savedState.sheetsById[key].sequence.tracksByObject;if(tracks[objectName])return tracks[objectName]}},this.get("manualRender",(()=>_manualRender)),this.set("manualRender",(value=>{(value=!!value)!==_manualRender&&((_manualRender=value)?_this.stopRender(loop):_this.startRender(loop))})),this.get("sheets",(()=>_sheets)),_this.update=()=>{_manualRender||!Hydra.LOCAL||_this.flag("manualRenderWarned")||(console.warn("Set manualRender to true if using TweenUIL.update()"),_this.flag("manualRenderWarned",!0)),loop()},_this.setAudio=async function(path){await _this.loaded();let source=Assets.getPath(path);for(let sheet in _this.sheets)_this.sheets[sheet].sequence.attachAudio({source:source});_audioFile=source,_config&&(_config.audioFile=source)}}),(()=>{TweenUIL.BEFORE_UPDATE="TweenUIL.BEFORE_UPDATE",TweenUIL.UPDATED="TweenUIL.UPDATED"})),Class((function UILFile(_offline,_path){Inherit(this,Component);this.load=async function(){let path=window.UIL_STATIC_PATH||"assets/data/uil.json";try{let data=await get(path);return"string"==typeof data?Hydra.LOCAL?null:{}:data}catch(e){return{}}},this.save=async function(sessionData,data){if(Dev.writeFile(window.UIL_STATIC_PATH||"assets/data/uil.json",data),_offline){let partial={};try{partial=await get("assets/data/uil-partial.json",data);for(let key in sessionData)partial[key]=sessionData[key]}catch(e){partial=sessionData}Dev.writeFile("assets/data/uil-partial.json",partial),Storage.set("uil_update_partial",!0)}}})),Class((function UILStorage(){Inherit(this,Component);const _this=this;var _storage,_platform,_fs,_keys,_storeIds=[],_data={},_dataSession={},_id=window.UIL_ID||"default",_remote=window.UIL_REMOTE||!1;window.UIL_ID=_id=_id.replaceAll(/[^a-zA-Z0-9 _-]/g,""),this.SAVE="uil_save",this.state=AppState.createLocal();const OFFLINE_FIREBASE=Utils.query("offlineFB");function clearOfflineData(){Storage.set("uil_update_partial",!1),Dev.writeFile("assets/data/uil-partial.json",{})}async function init(){_fs&&_fs.destroy(),_fs=_this.initClass(uilFile()?UILFile:UILRemote,OFFLINE_FIREBASE);let data=await _fs.load();if(null===data){let remoteFs=_this.initClass(UILRemote),remoteData=await remoteFs.load();confirm("Looks like the local uil.json has merge conflicts, do you want to sync from Firebase and resolve it?")?(_data[_id]=remoteData,await write(),window.location.reload()):data={}}for(let key in data)_this.state.set(key,data[key]);if(_data[_id]=data,_this.loaded=!0,!OFFLINE_FIREBASE&&Storage.get("uil_update_partial")&&!uilFile()){if(!confirm("Looks like you have UIL data captured offline, do you want to sync it to Firebase?"))return clearOfflineData();let data=await get("assets/data/uil-partial.json");for(let key in data)_this.set(key,data[key]);write(!0,!0),clearOfflineData()}}async function write(direct,silent){let prevent=!1,e={prevent:_=>prevent=!0};_this.events.fire(_this.SAVE,e),!direct&&(e.wait&&await e.wait(),prevent)||(_fs.save(_dataSession,_data[_id]),_dataSession={},silent||(__body.css({display:"none"}),_this.delayedCall((()=>{__body.css({display:"block"})}),100)))}function uilFile(){return!Utils.query("editMode")&&(!Hydra.LOCAL||!(window.Config&&Config.PLATFORM_CONFIG&&Utils.query("uil"))&&(!!Device.mobile||(!!OFFLINE_FIREBASE||(!(!window._BUILT_||Hydra.LOCAL)||(!!window.AURA||(!!window._UIL_FILE_||(!window._FIREBASE_UIL_&&!window.UIL_ID||!Device.detect("hydra")&&!Utils.query("uil"))))))))}Hydra.ready((async _=>{window.Platform&&Platform.isDreamPlatform&&Config.PLATFORM_CONFIG?async function initLocalCached(){_fs=_this.initClass(UILFile),_data[_id]=await _fs.load(),_this.loaded=!0}():Hydra.LOCAL&&window.Platform&&window.Platform.isPlatform||init(),(Utils.query("editMode")||Hydra.LOCAL&&window.Platform&&window.Platform.isDreamPlatform&&Utils.query("uil")||Hydra.LOCAL&&!Device.mobile&&!window._BUILT_&&(Utils.query("uil")||Device.detect("hydra")))&&__window.bind("keydown",(e=>{(e.ctrlKey||e.metaKey)&&83==e.keyCode&&(e.preventDefault(),write())}))})),this.reload=function(id,path,persist){_this.loaded=!1,_platform||(_platform=_id),persist&&_storeIds.push(id),_id=id,window.UIL_ID=id,window.UIL_STATIC_PATH=path,init()},this.set=function(key,value){if(void 0===value)return console.warn(`Trying to set UILStorage with an undefined value for ${key}`);_this.state.set(key,value),null===value?(delete _data[_id][key],_dataSession[key]=value):(_data[_id][key]=value,_dataSession[key]=value)},this.setWrite=function(key,value){this.set(key,value),write(!0)},this.clearMatch=function(string){for(let key in _data[_id])key.includes(string)&&delete _data[_id][key];write(!0)},this.write=function(silent){write(!0,silent)},this.get=function(key){let val=_data[_id]&&_data[_id][key];if(void 0===val&&_platform&&(val=_data[_platform][key]),void 0===val&&_storeIds)for(let i=0;i<_storeIds.length;i++)try{val=_data[_storeIds[i]][key]}catch(e){val=void 0}return val},this.ready=function(){return _this.wait(_this,"loaded")},this.getKeys=function(){return _keys||(_keys=Object.keys(_data[_id])),_keys},this.hasData=function(){return!!_data[_id]},_this.uploadFileToRemoteBucket=async function({file:file,progress:progress}){if(!_remote)return;_storage||(await Services.ready(),_storage=Services.app().storage());let filename=file.name.replace(/ /g,"_");const ref=_storage.ref(`_tmp/${filename}`),path=`https://storage.googleapis.com/${ref.bucket}/uploads/${_id}/${filename}`.toLowerCase(),metadata={customMetadata:{id:_id,path:path,contentType:file.type}},result=ref.put(file,metadata);let exists;for(progress&&result.on("state_changed",(snapshot=>{let _progress=snapshot.bytesTransferred/snapshot.totalBytes*95;progress.css({width:_progress+"%"})}),(error=>{err&&console.log(error),progress.css({width:0})}),(()=>{progress.css({width:0})}));!exists;)try{await fetch(path).then((r=>r.ok))&&(exists=!0)}catch(err){exists=!1}return metadata},this.parse=function(key,hint){let data=_data[_id][key];if(void 0===data)return null;if(Array.isArray(data)){if(hint instanceof Vector2)return{value:(new Vector2).fromArray(data)};if(hint instanceof Vector3)return{value:(new Vector3).fromArray(data)};if(hint instanceof Vector4)return{value:(new Vector4).fromArray(data)}}else if("string"==typeof data){if("#"===data.charAt(0))return{value:new Color(data)};if(!isNaN(data))return{value:Number(data)}}return{value:data}}}),"static"),Class((function UILClipboard(){Inherit(this,Component);var _store={};this.copy=function(folders){_store={};for(let key in folders){let folder=folders[key];_store[folder.label]=folder.value}},this.paste=function(folders){for(let key in folders){let folder=folders[key];folder&&(null!=_store[folder.label]&&(key.includes("name")||key.includes("shader")||(folder.force(_store[folder.label],!0),folder.finish())))}},this.get("store",(_=>_store))}),"static"),Class((function UILWindow(_title,_opts={hide:!1,drag:!0,resize:!0}){Inherit(this,Element);const _this=this;let $this,$header,$container,$toggle,$title,_folder,_hidden,_initialX,_initialY,_open=!_opts.closed,_x=_opts.left||350,_y=_opts.top||50,_xOffset=_x,_yOffset=_y,_dragging=!1;function hide(){$this&&$this.invisible(),_hidden=!0,_this.onClose&&_this.onClose()}function show(){$this&&$this.visible(),_hidden=!1}function onKeydown(e){if(e.ctrlKey||e.metaKey){if(72==e.keyCode&&e.shiftKey){if(`${document.activeElement.type}`.includes(["textarea","input","number"]))return;e.preventDefault(),_hidden?show():hide()}67==e.which&&e.shiftKey&&(e.preventDefault(),_folder.forEachFolder((f=>f.close()))),79==e.which&&e.shiftKey&&(e.preventDefault(),_folder.forEachFolder((f=>f.open())))}}function onMouseDown(e){e.preventDefault(),$header.css({cursor:"move"}),_initialX=e.clientX-_xOffset,_initialY=e.clientY-_yOffset,_dragging=!0,document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("mouseup",onMouseUp,!1)}function onMouseMove(e){e.preventDefault(),_x=e.clientX-_initialX,_y=e.clientY-_initialY,_xOffset=_x,_yOffset=_y,$this.x=_x,$this.y=_y,$this.transform()}function onMouseUp(){$header.css({cursor:""}),_initialX=_x,_initialY=_y,_dragging=!1,document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1)}function onToggle(e){"click"!==e.type&&13!==e.which||(_open?function close(){_open=!1,$container.css({display:"none"}),$toggle.text("▶")}():function open(){_open=!0,$container.css({display:"block"}),$toggle.text("▼")}())}function undim(){_dragging||$this.css({opacity:1})}function dim(){_dragging||$this.css({opacity:.3})}_this.id=_title,function initHTML(){$this=_this.element,$this.bg("#161616").transform({x:_x,y:_y}).mouseEnabled(!0),$this.css({position:"absolute",userSelect:"none",overflowY:"auto",borderRadius:4,maxHeight:_opts.maxHeight||"100%",border:"1px solid #2e2e2e"})}(),function initHeader(){$header=$this.create("header"),$header.size("100%","auto").bg("#272727"),$header.css({display:"block",color:"#B1B1B1",padding:"4px 4px",boxSizing:"border-box",fontFamily:"sans-serif",fontSize:11,fontWeight:"bold",userSelect:"none",minWidth:200}),$toggle=$header.create("toggle"),$toggle.text(_open?"▼":"▶").css({fontSize:8,paddingLeft:4,display:"inline-block",verticalAlign:"middle"}),$toggle.click(onToggle),$title=$header.create("title"),$title.text(_opts.label||_title).css({display:"inline-block",marginLeft:4}),$title.click(onToggle);let $close=$header.create("close");$close.text("✕").css({position:"absolute",right:7,top:5,display:"inline-block"}),$close.click(hide)}(),function initContainer(){$container=$this.create("container"),$container.size(_opts.width||"auto",_opts.height||"auto"),$container.css({position:"realtive",overflowY:"auto",padding:4,boxSizing:"border-box",minWidth:_opts.minWidth||0}),_opts.resize&&$container.css({resize:"both",minWidth:200,minHeight:60}),_open||$container.css({display:"none"})}(),function initGroup(){_folder=_this.initClass(UILFolder,_title,{hideTitle:!0,background:"#161616"},null),_this.folder=_folder,$container.add(_folder)}(),function addHandlers(){document.addEventListener("keydown",onKeydown,!1),_opts.drag&&$header.div.addEventListener("mousedown",onMouseDown,!1),_opts.hide&&($this.div.addEventListener("mouseover",undim,!1),$this.div.addEventListener("mouseleave",dim,!1))}(),this.add=function(child){return _folder.add(child),_this},this.remove=function(x){return _folder.remove(id),_this},this.get=function(id){return _folder.get(id)},this.find=function(id){return _folder.find(id)},this.filter=function(str){return _folder.filter(str)},this.show=function(){return show(),_this},this.hide=function(){return hide(),_this},this.isVisible=function(){return!_hidden},this.enableSorting=function(key){return _folder.enableSorting&&_folder.enableSorting(key),_this},this.eliminate=function(){_opts.drag&&$header.div.removeEventListener("mousedown",onMouseDown,!1),_opts.hide&&($this.div.removeEventListener("mouseover",undim,!1),$this.div.removeEventListener("mouseleave",dim,!1)),document.removeEventListener("keydown",onKeydown,!1)}})),Class((function UILExternalColor(_title,_value){Inherit(this,Component);const _this=this;var _window;function onReload(){_this.onDestroy()}(_window=window.open(location.protocol+"//localhost/hydra/editor/color/index.html",`hydra_color_${_title}`,"width=480,height=220,left=200,top=100,location=no")).window.onload=_=>{_window.window.initPicker(_title,_value,_this)},window.addEventListener("beforeunload",onReload),this.update=function(value){_this.events.fire(Events.UPDATE,{value:value})},this.onDestroy=function(){window.removeEventListener("beforeunload",onReload),_window&&_window.window&&_window.window.close()}})),Class((function UILExternalEditor(_title,_height=500,_width=700){Inherit(this,Component);const _this=this;var _window,_code,_language;_window=window.open(location.protocol+"//localhost/hydra/editor/code/index.html","_blank",`width=${_width},height=${_height},left=200,top=100`),_this.events.sub(Events.UNLOAD,(_=>_window.close())),_window.window.onload=_=>{_window.window.initEditor(_title,_code,_language,_this)},this.setCode=function(code,language){_code=code,_language=language},this.saved=async function(code){_this.onSave&&_this.onSave(code),await defer(),UILStorage.write()}})),Class((function UILExternalFilePicker(callback,type="textures"){Inherit(this,Component);const _this=this;var _window;async function init(){const assets=await get(Assets.getPath("assets/js/app/config/UILAssetsConfig.js"));let basePath,list;eval(assets),"textures"===type&&(basePath=`${document.location.pathname}/assets/images`,list=window.UIL_ASSETS_TEXTURES),"geometries"===type&&(basePath=`${document.location.pathname}/assets/geometry`,list=window.UIL_ASSETS_GEOMETRIES),_window=window.open(`${location.protocol}//localhost/hydra/editor/filepicker/index.html`,"pick file","width=800,height=700"),_this.events.sub(Events.UNLOAD,(_=>_window.close())),_window.window.onload=_=>{_window.window.initPicker(_this,basePath,list)},window.addEventListener("beforeunload",onReload)}function onReload(){_this.onDestroy()}!async function(){await Dev.execUILScript("assetsconfig"),await init()}(),this.refresh=function(){_window&&_window.window&&_window.window.close(),init()},this.update=function(value){callback&&callback(value)},this.onDestroy=function(){window.removeEventListener("beforeunload",onReload),_window&&_window.window&&_window.window.close()}})),Class((function UILExternalTimeline(_title,_height=500,_width=700,_config){Inherit(this,Component);const _this=this;var _window;_window=window.open(location.protocol+"//localhost/hydra/editor/timeline/index.html","_blank",`width=${_width},height=${_height},left=200,top=100`),_this.events.sub(Events.UNLOAD,(_=>_window.close())),_window.window.onload=_=>{_window.window.initEditor(_title,_config)},_window.window.addEventListener("message",(e=>{if(e.data.bundle&&_this.onMessage&&_this.onMessage(e.data.bundle),e.data.save){let path;_this.onSave&&_this.onSave(),window.UIL_STATIC_PATH?(path=window.UIL_STATIC_PATH,path=path.substring(0,path.lastIndexOf("/"))):path="assets/data",Dev.writeFile(`${path}/timeline-${_title}.json?compress`,e.data.save)}e.data.visualizePath&&_this.onVisualizePath?.(e.data.visualizePath),void 0!==e.data.position&&_this.onPositionChange&&_this.onPositionChange(e.data.position)})),_this.startRender((_=>{_window.closed&&_this.destroy()}),10),this.saved=async function(code){_this.onSave&&_this.onSave(code),await defer(),UILStorage.write()},this.sendUpdate=function(layerName,value,key){_window.window.sendUpdate(layerName,value,key)}})),Namespace("FX"),FX.Class((function UnrealBloom(_nuke,options,_unique){Inherit(this,Component);var _triangleGeometry,_luminosityShader,_compositeShader,_mesh,_inputTexture,_this=this;if("object"==typeof _nuke&&_nuke.isAppState){let params=_nuke;_nuke=_this.parent.nuke||params.nuke||World.NUKE,_unique=params.unique,options=params}"string"==typeof options?(_unique=_params,options={},_nuke=World.NUKE):"string"==typeof _nuke?(_unique=_nuke,options={},_nuke=World.NUKE):!_nuke||_nuke instanceof Nuke?(_nuke=_nuke||World.NUKE,options=options||{},_unique=_unique||""):(options=_nuke,_nuke=World.NUKE);var _oldClearColor=new Color,_oldClearAlpha=1,_renderTargetsHorizontal=[],_renderTargetsVertical=[],_separableBlurShaders=[],_nMips=options.nMips||3,_DPR=options.dpr||_nuke.dpr,_blurDirectionX=new Vector2(_DPR,0),_blurDirectionY=new Vector2(0,_DPR),_kernelSizeArray=options.kernelSizeArray||[3,5,7,9,11],_bloomFactors=options.bloomFactors||[1,.8,.6,.4,.2],_useRTPool=!1!==options.useRTPool;function render(){if(!_this.enabled||!1===_this.visible)return;let renderer=_nuke.renderer;_oldClearColor.copy(renderer.getClearColor()),_oldClearAlpha=renderer.getClearAlpha();let oldAutoClear=renderer.autoClear;renderer.autoClear=!0,renderer.setClearColor(_this.clearColor,0);let inputRenderTarget=_inputTexture||_nuke.rttBuffer.texture;_luminosityShader.uniforms.luminosityThreshold.value>.01&&(_luminosityShader.uniforms.tDiffuse.value=inputRenderTarget,_mesh.shader=_luminosityShader,renderer.renderSingle(_mesh,_nuke.camera,_this.renderTargetBright),inputRenderTarget=_this.renderTargetBright);for(let i=0;i<_nMips;i++)_mesh.shader=_separableBlurShaders[i],_separableBlurShaders[i].uniforms.colorTexture.value=inputRenderTarget,_separableBlurShaders[i].uniforms.direction.value=_blurDirectionX,renderer.renderSingle(_mesh,_nuke.camera,_renderTargetsHorizontal[i]),_separableBlurShaders[i].uniforms.colorTexture.value=_renderTargetsHorizontal[i].texture,_separableBlurShaders[i].uniforms.direction.value=_blurDirectionY,renderer.renderSingle(_mesh,_nuke.camera,_renderTargetsVertical[i]),inputRenderTarget=_renderTargetsVertical[i];_mesh.shader=_compositeShader,renderer.renderSingle(_mesh,_nuke.camera,_renderTargetsHorizontal[0]),renderer.setClearColor(_oldClearColor,_oldClearAlpha),renderer.autoClear=oldAutoClear}function resizeHandler(){_this.resolution.set(_nuke.stage.width,_nuke.stage.height).multiplyScalar(_DPR),_blurDirectionX.x=_DPR,_blurDirectionY.y=_DPR;let resx=Math.round(_this.resolution.x/2),resy=Math.round(_this.resolution.y/2);_this.renderTargetBright&&_this.renderTargetBright.setSize(resx,resy);for(var i=0;i<_renderTargetsHorizontal.length;i++){_renderTargetsHorizontal[i].setSize(resx,resy),_renderTargetsVertical[i].setSize(resx,resy);let shader=_separableBlurShaders[i];shader&&(shader.uniforms.texSize.value=new Vector2(resx,resy)),resx=Math.round(resx/2),resy=Math.round(resy/2)}}this.uniforms={tUnrealBloom:{value:null,ignoreUIL:!0},unique:_unique},this.resolution=new Vector2(_nuke.stage.width*_DPR,_nuke.stage.height*_DPR),this.clearColor=new Color(0,0,0),this.enabled=void 0===options.enabled||options.enabled,this.outputTexture=null,function initRTs(){if(FX.UnrealBloom.hasRTs)return;let pars={minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:Texture.RGBAFormat},resx=Math.round(_this.resolution.x/2),resy=Math.round(_this.resolution.y/2);_this.renderTargetBright=new RenderTarget(resx,resy,pars),_this.renderTargetBright.texture.generateMipmaps=!1,FX.UnrealBloom.putRT("renderTargetBright",_this.renderTargetBright);for(let i=0;i<_nMips;i++){let renderTargetHorizonal=new RenderTarget(resx,resy,pars);renderTargetHorizonal.texture.generateMipmaps=!1,_renderTargetsHorizontal.push(renderTargetHorizonal),FX.UnrealBloom.putRT("mipHorizontal"+i,renderTargetHorizonal);let renderTargetVertical=new RenderTarget(resx,resy,pars);renderTargetVertical.texture.generateMipmaps=!1,_renderTargetsVertical.push(renderTargetVertical),FX.UnrealBloom.putRT("mipVertical"+i,renderTargetVertical),resx=Math.round(resx/2),resy=Math.round(resy/2)}_this.outputTexture=_renderTargetsHorizontal[0].texture,_this.uniforms.tUnrealBloom.value=_renderTargetsHorizontal[0].texture}(),function initScene(){_triangleGeometry=World.QUAD,_luminosityShader=_this.initClass(Shader,"UnrealBloomLuminosity",{tDiffuse:{value:null,ignoreUIL:!0},luminosityThreshold:{value:1},smoothWidth:{value:.01,ignoreUIL:!0},defaultColor:{value:new Color(0),ignoreUIL:!0},defaultOpacity:{value:0,ignoreUIL:!0},unique:_unique}),(_mesh=new Mesh(_triangleGeometry,_luminosityShader)).frustumCulled=!1}(),function initBlurShaders(){let resx=Math.round(_this.resolution.x/2),resy=Math.round(_this.resolution.y/2);for(let i=0;i<_nMips;i++){let shader=_this.initClass(Shader,"UnrealBloomGaussian",{unique:_unique,colorTexture:{value:null},texSize:{value:new Vector2(resx,resy)},direction:{value:new Vector2(.5,.5)}},null,(glsl=>`\n#define KERNEL_RADIUS ${_kernelSizeArray[i]}\n#define SIGMA ${_kernelSizeArray[i]}\n${glsl}`),`gaussian${i}`);_separableBlurShaders.push(shader),resx=Math.round(resx/2),resy=Math.round(resy/2)}}(),function initCompositeShader(){let uniforms={bloomStrength:{value:1},bloomTintColor:{value:new Color("#ffffff")},bloomRadius:{value:0},unique:_unique};for(let i=0;i<_nMips;i++)uniforms[`blurTexture${i+1}`]={value:_useRTPool?null:_renderTargetsVertical[i].texture,ignoreUIL:!0};(_compositeShader=_this.initClass(Shader,"UnrealBloomComposite",uniforms,null,((glsl,type)=>{if("vs"===type)return glsl;let compositeUniforms="",compositeMain="";for(let i=0;i<_nMips;i++)compositeUniforms+=`uniform sampler2D blurTexture${i+1};\n`,compositeMain+=`lerpBloomFactor(${_bloomFactors[i].toFixed(4)}) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture${i+1}, vUv) ${i<_nMips-1?"+ ":""}`;return(glsl=glsl.replace("uniform sampler2D blurTexture1;",compositeUniforms)).replace("lerpBloomFactor(1.0) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture1, vUv)",compositeMain)}))).needsUpdate=!0}(),function initPass(){_this.pass=_this.initClass(NukePass,"UnrealBloomPass",_this.uniforms)}(),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler),_this.events.sub(_nuke,Nuke.BEFORE_PASSES,render),_this.startRender((()=>{}))}(),options.noUIL||_this.delayedCall((_=>{ShaderUIL.add(_luminosityShader).setLabel("UnrealBloom Luminosity"),ShaderUIL.add(_compositeShader).setLabel("UnrealBloom Composite")}),2e3),this.set("texture",(texture=>{_inputTexture=texture})),this.get("luminosityShader",(_=>_luminosityShader)),this.get("compositeShader",(_=>_compositeShader)),this.set("dpr",(dpr=>{_DPR=dpr,resizeHandler()})),this.renderBloom=render,this.renderMesh=_mesh,this.onDestroy=function(){_renderTargetsHorizontal.forEach((r=>r.destroy())),_renderTargetsVertical.forEach((r=>r.destroy())),_this.renderTargetBright&&_this.renderTargetBright.destroy()},this.getRTs=function(){const rt=FX.UnrealBloom.getRT;_this.renderTargetBright=rt("renderTargetBright"),_renderTargetsHorizontal=[],_renderTargetsVertical=[];for(let i=0;i<_nMips;i++)_renderTargetsHorizontal.push(rt("mipHorizontal"+i)),_renderTargetsVertical.push(rt("mipVertical"+i)),_compositeShader.uniforms[`blurTexture${i+1}`].value=_renderTargetsVertical[i].texture;_this.outputTexture=_renderTargetsHorizontal[0].texture,_this.uniforms.tUnrealBloom.value=_renderTargetsHorizontal[0].texture,resizeHandler()},this.putRTs=function(){_this.renderTargetBright=null,_renderTargetsHorizontal=[],_renderTargetsVertical=[]},this.onInvisible=function(){_this.putRTs(),_this.visible=!1},this.onVisible=function(){_this.getRTs(),_this.visible=!0}}),(_=>{var _pool={};FX.UnrealBloom.putRT=function(key,rt){FX.UnrealBloom.hasRTs=!0,_pool[key]=rt},FX.UnrealBloom.getRT=function(key){return _pool[key]}})),Class((function UnsupportedRedirect(){Inherit(this,Component);var _this=this,_tests=[];this.BOTS=["google","apis-google","mediapartners-google","adsbot-google","googlebot","feedfetcher-google","google-read-aloud","storebot-google","bingbot","facebot","facebookexternalhit","slurp","duckduckbot","baiduspider","yandexbot","sogou","exabot"],this.chrome=55,this.firefox=51,this.safari=8,this.ie=13,this.requiresWebGL=!0,this.url="./fallback",this.test=function(){_this.unsupported()&&function redirect(){window.location=_this.url}()},this.unsupported=function(){return!_this.BOTS.find((bot=>Device.detect(bot)))&&(!!_tests.find((test=>test()))||(!(!_this.requiresWebGL||Device.graphics.webgl&&!GPU.BLOCKLIST)||("chrome"===Device.system.browser&&Device.system.browserVersion<_this.chrome||("firefox"===Device.system.browser&&Device.system.browserVersion<_this.firefox||("safari"===Device.system.browser&&Device.system.browserVersion<_this.safari||("ie"===Device.system.browser&&Device.system.browserVersion<_this.ie||!!Utils.query("unsupported")))))))},this.custom=function(...tests){_tests.push(...tests)}}),"static"),Class((function AbstractUserInput(){Inherit(this,Component);const _this=this;var _downTime;this.position=new Vector3,this.quaternion=new Quaternion,this.plane2D=new Vector2,this.isDown=!1,this.directionVec=new Vector3,this.velocity=new VelocityTracker(_this.position),this.velocity.start(),this.down=function(){_this.isDown=!0,_this.events.fire(UserInput.DOWN),_downTime=Render.TIME},this.up=function(){_this.isDown=!1,Render.TIME-_downTime<500&&_this.click(),_this.events.fire(UserInput.UP)},this.click=function(){_this.events.fire(UserInput.CLICK)}})),Class((function UserInput(){Inherit(this,Component);const _this=this;var _vr,_gazeSelector,_manager;function updateState(){for(let i=0;i<_this.inputs.length;i++)_this.inputs[i].updateVRState&&_this.inputs[i].updateVRState(_this.inputs)}this.inputs=[],this.DOWN="user_input_down",this.UP="user_input_up",this.CLICK="user_input_click",this.pointerDistanceFromCamera=1,this.camera=null,async function(){await Hydra.ready(),await Hydra.ready(),await RenderManager.initialized,_this.camera=World.CAMERA,_manager=_this.initClass(UserInputPositionManager),window.UserInputBody&&(_this.body=_this.initClass(UserInputBody)),RenderManager.type!=RenderManager.VR?(_this.inputs.push(_this.initClass(UserInputMouseTouch)),_this.flag("loaded",!0),_manager.initPointer()):(_vr=!0,_manager.initVR(),VRInput.ready().then((_=>{VRInput.controllers.forEach((controller=>{_this.inputs.push(_this.initClass(UserInputVRController,controller,"controller"))})),_this.inputs.forEach((inp=>inp.active=!inp.handedness)),_this.flag("loaded",!0),updateState(),_manager.update("controller")})),VRInput.handsReady().then((_=>{_this.inputs.push(_this.initClass(UserInputVRController,VRInput.getHand("left"),"hand")),_this.inputs.push(_this.initClass(UserInputVRController,VRInput.getHand("right"),"hand")),_this.flag("loaded",!0),updateState(),_manager.update("hand"),_this.inputs.forEach((inp=>inp.active=inp.handedness)),_this.events.sub(VRInput.CHANGE,(type=>{_manager.update("controllers"==type?"controller":"hand");let left=VRInput.getHand("left");for(let i=0;i<_this.inputs.length;i++)if(_this.inputs[i].controller==left)return;_this.inputs.push(_this.initClass(UserInputVRController,VRInput.getHand("left"),"hand")),_this.inputs.push(_this.initClass(UserInputVRController,VRInput.getHand("right"),"hand")),updateState(),_this.inputs.forEach((inp=>inp.active="hands"==type?inp.handedness:!inp.handedness))}))})))}(),this.bindClick=async function(obj,hover,click){await _this.ready(),_this.inputs.forEach((inp=>inp.bindClick(obj,hover,click)))},this.unbindClick=async function(obj){await _this.ready(),_this.inputs.forEach((inp=>inp.unbindClick(obj)))},this.bindGaze=async function(obj,hover,click){_vr?(_gazeSelector||(_gazeSelector=UserInputGazeSelector.instance()),_gazeSelector.bind(obj,hover,click)):_this.bindClick(obj,hover,click)},this.unbindGaze=function(obj){_gazeSelector&&_gazeSelector.unbind(obj)},this.getGaze=function(){return _gazeSelector||(_gazeSelector=UserInputGazeSelector.instance()),_gazeSelector},this.bindProximity=async function(obj,hover,click){await _this.ready(),_this.inputs.forEach((inp=>inp.bindProximity(obj,hover,click)))},this.unbindProximity=async function(obj){await _this.ready(),_this.inputs.forEach((inp=>inp.unbindProximity(obj)))},this.alignToPlane=async function(mesh){await _this.ready(),_this.inputs.forEach((inp=>inp.alignToPlane(mesh)))},this.ready=function(){return _this.wait("loaded")},this.getGazeMesh=function(){return _gazeSelector||(_gazeSelector=UserInputGazeSelector.instance()),_gazeSelector.mesh},this.resetGaze=function(animateIn=!1){_gazeSelector&&(_gazeSelector.reset(),animateIn&&!_gazeSelector.isVisible&&_gazeSelector.animateIn())}}),"static"),Class((function UserInputGazeSelector(){Inherit(this,Component);const _this=this;var _over,_mesh,_shader,_wrapper,_objects=[],_test=[],_v3=new Vector3,_raycaster=Raycaster.find(World.CAMERA),_mouse=new Vector2,lastDistance=2;this.prevent=!1,this.snapToPosition=!1,this.trackingTime=1500;const renderSlot=RenderManager.type===RenderManager.NORMAL?Camera.instance():RenderManager.EYE_RENDER;function startTracking(){_this.tracking||_shader.uniforms.uVisible.value<.5||(_this.tracking=!0,_this.finishedTracking=!1,_over&&(_over.__hasTracked=!0),_this.events.fire(UserInputGazeSelector.TRACKING_STARTED,{object:_over}),_this.startRender(track,renderSlot),_shader.tween("uAlpha",.9,_this.trackingTime/3,"easeOutSine"),_shader.tween("uAlpha2",.25,_this.trackingTime/3,"easeOutSine"),_shader.set("uTime",0),_shader.tween("uTime",1,_this.trackingTime,"easeInOutSine"),_this.timeout=_this.delayedCall((_=>{_this.finishedTracking=!0,stopTracking(),_this.animateOut(),_over&&_over.__gazeClick&&_over.__gazeClick({action:"click",mesh:_over})}),_this.trackingTime))}function stopTracking(){_this.tracking&&(_this.tracking=!1,_this.events.fire(UserInputGazeSelector.TRACKING_STOPPED,{object:_over,finished:_this.finishedTracking}),_this.stopRender(track,renderSlot),_this.timeout&&clearTimeout(_this.timeout),_shader.tween("uAlpha",.2,500,"linear"),_shader.tween("uAlpha2",.8,500,"linear"),_this.finishedTracking||_shader.tween("uTime",0,1e3,"easeOutSine"))}function positionSelector(){Utils3D.positionInFrontOfCamera(_wrapper,lastDistance)}function track(){if(!_over)return;_v3.set(0,0,-1).applyQuaternion(World.CAMERA.quaternion);let[hit]=_raycaster.checkFromValues(_over,World.CAMERA.position,_v3);hit&&RenderManager.type==RenderManager.VR&&_this.snapToPosition&&(_wrapper.position.copy(hit.point),lastDistance=hit.point.distanceTo(World.CAMERA.position),_wrapper.lookAt(World.CAMERA.position))}function loop(){if(_mouse.lerp(Mouse.tilt,.1),positionSelector(),!_objects.length||_this.prevent)return;_test.length=0;for(let i=_objects.length-1;i>-1;i--){let obj=_objects[i];obj.determineVisible()&&_test.push(obj)}_v3.set(0,0,-1).applyQuaternion(World.CAMERA.quaternion);let[hit]=_raycaster.checkFromValues(_test,World.CAMERA.position,_v3);if(hit)if(_over)!_over||_over.__hasTracked||_over.__preventTrack||(_over.__gazeHover&&_over.__gazeHover({action:"over",mesh:hit.object}),startTracking());else{if((_over=hit.object).__hasTracked=!1,_over.__preventTrack)return;_over.__gazeHover&&_over.__gazeHover({action:"over",mesh:hit.object}),startTracking()}else _over&&(_over.__gazeHover&&_over.__gazeHover({action:"out"}),_over.__hasTracked=!1,_over=null,stopTracking())}!function initMesh(){_wrapper=new Group,World.SCENE.add(_wrapper),_shader=_this.initClass(Shader,"GazeSelector",{uColor:{value:new Color(Colors.grey[0])},uTime:{value:0},uAlpha:{value:0},uAlpha2:{value:.8},uVisible:{value:0},transparent:!0,depthWrite:!1,depthTest:!1,blending:Shader.ADDITIVE_BLENDING}),_this.mesh=_mesh=new Mesh(World.PLANE,_shader),_mesh.scale.setScalar(Device.mobile.phone?1.25:.9),_wrapper.add(_mesh),_wrapper.renderOrder=9999,positionSelector()}(),this.bind=function(obj,hover,click){_objects.some((el=>el.id===obj.id))||(obj.__gazeHover=hover,obj.__gazeClick=click,_objects.push(obj),_this.animateIn())},this.unbind=function(obj){if(!obj)return;let lengthBefore=_objects.length;_objects=_objects.filter((el=>el.id!==obj.id)),_over&&_over.id===obj.id&&(_over.__gazeHover&&_over.__gazeHover({action:"out"}),_over.__hasTracked=!1,_over=null,stopTracking()),lengthBefore&&0===_objects.length&&_this.isVisible&&_this.animateOut()},_this.reset=function(){_shader.set("uTime",0),_shader.tween("uAlpha",.2,2e3,"easeInOutSine"),_shader.tween("uAlpha2",.8,2e3,"easeInOutSine"),lastDistance=2},_this.animateIn=function(){return _this.isVisible=!0,_this.startRender(loop,renderSlot),_this.finishedTracking=!1,_shader.tween("uVisible",1,2e3,"easeInOutSine"),_wrapper.scale.x=_wrapper.scale.y=1.2,tween(_wrapper.scale,{x:1,y:1},2e3,"easeInOutCubic").promise()},_this.animateOut=async function(){_this.isVisible=!1,_shader.tween("uTime",0,10,"easeOutSine"),await _shader.tween("uVisible",0,1e3,"easeOutSine").promise(),_this.stopRender(loop,renderSlot),_over&&(_over.__gazeHover&&_over.__gazeHover({action:"out"}),_over.__hasTracked=!1,_over=null),stopTracking()},this.getMesh=function(){return _mesh},Dev.expose("gazeObjects",(()=>_objects))}),"singleton",(()=>{UserInputGazeSelector.TRACKING_STARTED="gaze_selector_tracking_started",UserInputGazeSelector.TRACKING_STOPPED="gaze_selector_tracking_stopped"})),Class((function UserInputMouseTouch(){Inherit(this,AbstractUserInput);const _this=this;var _plane,_hoverMeshes=[],_activeHover=null;function loop(){if(World.CAMERA&&(_this.position.copy(ScreenProjection.find(_this.parent.camera).unproject(Mouse,_this.parent.pointerDistanceFromCamera)),_this.position.velocity=_this.velocity.value,_hoverMeshes.length&&function performHoverCheck(){let[newHover]=Raycaster.find(World.CAMERA).checkHit(_hoverMeshes);newHover?_activeHover?newHover.object!==_activeHover.object&&(_activeHover.object.__uiHover({action:"out",hit:_activeHover,mesh:_activeHover.object}),newHover.object.__uiHover({action:"over",newHover:newHover,mesh:newHover.object}),_activeHover=newHover):(newHover.object.__uiHover({action:"over",newHover:newHover,mesh:newHover.object}),_activeHover=newHover):_activeHover&&(_activeHover.object.__uiHover({action:"out",hit:_activeHover,mesh:_activeHover.object}),_activeHover=null)}(),_plane)){let[hit]=Raycaster.find(World.CAMERA).checkHit(_plane,Mouse);hit?(_this.plane2D.x=Math.range(hit.uv.x,0,1,-1,1),_this.plane2D.y=Math.range(hit.uv.y,0,1,-1,1)):(_this.plane2D.x=-10,_this.plane2D.y=-10)}}function touchStart(e){_this.down()}function touchMove(e){}function touchEnd(e){_this.up()}this.activeInput=!0,_this.startRender(loop,24),function addListeners(){_this.events.sub(Mouse.input,Interaction.START,touchStart),_this.events.sub(Mouse.input,Interaction.MOVE,touchMove),_this.events.sub(Mouse.input,Interaction.END,touchEnd)}(),this.bindClick=function(obj,hover,click){hover&&(obj.__uiHover=hover,_hoverMeshes.push(obj)),click&&Interaction3D.find(World.CAMERA).add(obj,null,click),obj.hitDestroy=()=>this.unbindClick(obj)},this.unbindClick=function(obj){_hoverMeshes.remove(obj),Interaction3D.find(World.CAMERA).remove(obj)},this.bindProximity=function(obj,hover,click){this.bindClick(obj,hover,click)},this.unbindProximity=function(obj){this.unbindClick(obj)},this.alignToPlane=function(mesh){_plane=mesh}})),Class((function UserInputPositionManager(){Inherit(this,Component);const _this=this;var _type;const pointer=new Vector3(99999,99999,99999),leftHand=new Vector3(99999,99999,99999),rightHand=new Vector3(-99999,-99999,-99999),_inputs=_this.parent.inputs;function switchToBody(){_this.stopRender(handlePointer),_this.stopRender(handleVR),AppState.set("UserInput/hand0",AppState.get("UserInputBody/leftHand3D")),AppState.set("UserInput/hand1",AppState.get("UserInputBody/rightHand3D"))}function handleVR(){leftHand.set(99999,99999,99999),rightHand.set(-99999,-99999,-99999),_inputs.length<=2?(_inputs[0]&&leftHand.copy(_inputs[0].position),_inputs[1]&&rightHand.copy(_inputs[1].position)):_inputs.forEach(((input,i)=>{input.type==_type&&(i%2==0?leftHand.copy(input.position):rightHand.copy(input.position))}))}function handlePointer(){pointer.lerp(_inputs[0].position,.5)}AppState.set("UserInput/hand0",leftHand),AppState.set("UserInput/hand1",rightHand),AppState.set("UserInput/pointer",pointer),AppState.bind("UserInputBody/detected",switchToBody),this.update=function(type){_type=type,_inputs.forEach((input=>{"controller"!=input.type||input.addedEvents||(input.addedEvents=!0,_this.events.sub(input.controller,VRInput.BUTTON,(e=>AppState.set("UserInput/VRButton",e,!0))),_this.events.sub(input.controller,VRInput.JOYSTICK,(e=>AppState.set("UserInput/VRJoystick",e,!0))))}))},this.initVR=function(){_this.startRender(handleVR)},this.initPointer=function(){_this.startRender(handlePointer)}})),Class((function UserInputVRController(_controller,_type){Inherit(this,AbstractUserInput);const _this=this;var _plane,_hoverMeshes=[],_activeHover=null,_proximity=[],_v3=new Vector3;const ZERO=new Vector3;function initProximitySphere(obj){let box=(new Box3).setFromObject(obj);obj.__proximitySphere=box.getBoundingSphere()}function intersects(objA,objB){return objA.__proximitySphere||initProximitySphere(objA),objB.__proximitySphere||initProximitySphere(objB),objA.__proximitySphere.center.copy(objA.getWorldPosition()),objB.__proximitySphere.center.copy(objB.getWorldPosition()),objA.__proximitySphere.intersectsSphere(objB.__proximitySphere)}function loop(){if(_controller.body&&_controller.body.getWorldPosition&&World.CAMERA&&!_controller.body.getWorldPosition().equals(ZERO)&&_controller.group.visible){if(_v3.copy(_controller.pointer),_this.position.copy(_controller.group.position),_this.quaternion.copy(_controller.group.quaternion),_controller.isAbstractHand&&_this.position.copy(_controller.body.position),_hoverMeshes.length&&function performHoverCheck(){let[newHover]=Raycaster.checkFromValues(_hoverMeshes,World.CAMERA.position,_this.directionVec);newHover?_activeHover?newHover.object!==_activeHover.object&&(_activeHover.object.__uiHover({action:"out",hit:_activeHover,mesh:_activeHover.object}),newHover.object.__uiHover({action:"over",newHover:newHover,mesh:newHover.object}),_activeHover=newHover):(newHover.object.__uiHover({action:"over",newHover:newHover,mesh:newHover.object}),_activeHover=newHover):_activeHover&&(_activeHover.object.__uiHover({action:"out",hit:_activeHover,mesh:_activeHover.object}),_activeHover=null)}(),_proximity.length)for(let i=_proximity.length-1;i>-1;i--){let mesh=_proximity[i];mesh.visible&&(_controller.isAbstractHand&&_controller.tips.forEach((t=>{t.body&&intersects(t.body,mesh)&&fireProximity(mesh,t.body)})),intersects(_controller.body,mesh)&&fireProximity(mesh,_controller.body))}if(_plane){let[hit]=Raycaster.find(World.CAMERA).checkFromValues(_plane,_controller.group.position,_v3);hit?(_this.plane2D.x=Math.range(hit.uv.x,0,1,-1,1),_this.plane2D.y=Math.range(hit.uv.y,0,1,-1,1)):(_this.plane2D.x=-10,_this.plane2D.y=-10)}}}function fireProximity(mesh,body){Render.TIME-mesh.__uiFireTime<500||(mesh.__uiFireTime=Render.TIME,mesh.__uiClick&&mesh.__uiClick({action:"click",mesh:mesh,handedness:_controller.handedness,controller:_controller,hitBody:body}))}function button(e){World.CAMERA&&!_controller.body.getWorldPosition().equals(ZERO)&&_controller.group.visible&&"trigger"===e.label&&(e.pressed?(_this.down(),_controller.isAbstractHand||Interaction3D.useInput(_controller),UserInput.inputs.forEach((inp=>inp.activeInput=!1)),_this.activeInput=!0):(_this.up(),_activeHover&&_activeHover.object.__uiClick({action:"click",mesh:_activeHover.object,hit:_activeHover.hit})))}this.controller=_controller,this.type=_type,function addListeners(){_this.events.sub(_controller,VRInput.BUTTON,button)}(),_this.startRender(loop,24,World.NUKE),"right"!==_controller.handedness||_controller.isAbstractHand||(Interaction3D.useInput(_controller),_this.activeInput=!0),_this.position.velocity=_this.velocity.value,this.bindClick=function(obj,over,click){obj.__uiHover=over,obj.__uiClick=click,_hoverMeshes.push(obj),obj.hitDestroy=_=>_hoverMeshes.remove(obj)},this.unbindClick=function(obj){_hoverMeshes.remove(obj)},this.bindProximity=function(obj,over,click){obj.__uiHover=over,obj.__uiClick=click,_proximity.push(obj),obj.hitDestroy=_=>_proximity.remove(obj)},this.unbindProximity=function(obj){_proximity.remove(obj)},this.alignToPlane=function(plane){_plane=plane},this.setState=function(hoverMeshes,proximity){_hoverMeshes=[...hoverMeshes],_proximity=[...proximity]},this.updateVRState=function(array){array.forEach((obj=>{obj.setState&&obj!=_this&&obj.setState(_hoverMeshes,_proximity)}))},this.getPosRelativeTo=function(head){return _v3.set(head.x,0,head.z),_v3.add(_this.position),_v3},this.triggerHaptics=function(strength,time){_controller.triggerHaptics&&_controller.triggerHaptics(strength,time)}})),Class((function AbstractUserInput(){Inherit(this,Component);const _this=this;var _downTime;this.position=new Vector3,this.quaternion=new Quaternion,this.plane2D=new Vector2,this.isDown=!1,this.directionVec=new Vector3,this.velocity=new VelocityTracker(_this.position),this.velocity.start(),this.down=function(){_this.isDown=!0,_this.events.fire(UserInput.DOWN),_downTime=Render.TIME},this.up=function(){_this.isDown=!1,Render.TIME-_downTime<500&&_this.click(),_this.events.fire(UserInput.UP)},this.click=function(){_this.events.fire(UserInput.CLICK)}})),Class((function VelocityTracker(_vector){Inherit(this,Component);var _this=this,Vector="number"==typeof _vector.z?Vector3:Vector2,_vec=new Vector,_velocity=new Vector,_last=new Vector;function loop(time,delta){_vec.subVectors(_vector,_last).divideScalar(Render.DELTA/(1e3/Render.REFRESH_RATE)),_last.copy(_vector),_vec.length()>0&&_velocity.copy(_vec)}this.value=_velocity,this.start=function(){_this.startRender(loop)},this.onDestroy=this.stop=function(){_this.stopRender(loop)},this.copy=function(){_last.copy(_vector)},this.update=loop})),Class((function Video(_params){Inherit(this,Component);const _this=this;let $video,_video,_loadingState,_handlers,_sharedVideo=!1,_ready=Promise.create(),_loaded=Promise.create(),_initialPlay=!0,_buffering=!0;function startPreload(){return _loadingState=!0,_video.load(),_ready}async function startPlayback(){if(!_this.playing&&(_loadingState=!1,_video.readyState<2&&(_video.load(),await _ready),!_this.playing)){_initialPlay&&(_initialPlay=!1,_params.currentTime&&(_video.currentTime=_params.currentTime)),_this.playing=!0;try{return await _video.play()}catch(error){throw _this.playing=!1,error}}}function getSource(src=""){return src&&!src.includes(["webm","mp4","ogv","blob","?"])&&(src+="."+Device.media.video),src}function progress(e){_this.events.fire(Video.PROGRESS,e)}function timeupdate(e){_this.events.fire(Video.UPDATE,e)}function play(e){if(_loadingState)return _loadingState=!1;_this.events.fire(Video.PLAY,e)}function pause(e){_this.events.fire(Video.PAUSE,e)}function playing(e){_this.events.fire(Video.PLAYING,e)}function buffering(state){_this.events.fire(Video.BUFFERING,{isBuffering:state})}function ended(e){_this.events.fire(Video.ENDED,e)}function waiting(e){_this.events.fire(Video.WAITING,e)}function canplay(e){loadeddata(),_this.events.fire(Video.CANPLAY,e)}function loadedmetadata(e){_this.dimensions.width=_video.videoWidth,_this.dimensions.height=_video.videoHeight,_this.events.fire(Video.LOADEDMETADATA,e)}function loadeddata(e){_video.readyState>=2&&_ready.resolve(),_video.readyState>=4&&_loaded.resolve()}function error(){_this.playing&&(_this.playing=!1),_this.events.fire(Video.ERROR,_video.error)}_params.toJSON&&((_params=_params.toJSON()).autoplay=_params.autoPlay,"string"==typeof _params.events&&(_params.events=_params.events.split(","))),function initParam(){let defaults={muted:!0,loop:!1,autoplay:!1,inline:!0,controls:!1,currentTime:0,playback:1,preload:!1,width:640,height:360,events:[],disableRemotePlayback:!0};_params=Object.assign(defaults,_params)}(),function init(){return _params.src instanceof HTMLVideoElement?(_video=_params.src,_sharedVideo=!0):(_video=document.createElement("video"),_params.src&&(_video.src=getSource(_params.src)),_video.setAttribute("crossorigin","anonymous"),_video.disableRemotePlayback=_params.disableRemotePlayback,_video.autoplay=_params.autoplay,_video.loop=_params.loop,_video.controls=_params.controls,_video.height=_params.height,_video.width=_params.width,_video.defaultMuted=_params.muted,_video.defaultPlaybackRate=_params.playback,_video.preload="string"==typeof _params.preload?_params.preload:_params.preload?"auto":"none",_video.muted=_params.autoplay||_params.muted,_video.setAttribute("webkit-playsinline",_params.inline),_video.setAttribute("playsinline",_params.inline),_video.autoplay&&_video.setAttribute("autoplay",_params.autoplay),_video.setAttribute("muted",_params.muted),_params.loop&&_video.setAttribute("loop",_params.loop)),_this.dimensions={width:_params.width,height:_params.height},_this.div=_video,$video=$(_video),_params.autoplay?startPlayback():_params.preload?startPreload():void 0}(),function addHandlers(){["loadedmetadata","loadeddata","error"].forEach((ev=>{_params.events.includes(ev)||_params.events.push(ev)})),_handlers={play:play,pause:pause,ended:ended,playing:playing,progress:progress,waiting:waiting,timeupdate:timeupdate,loadedmetadata:loadedmetadata,loadeddata:loadeddata,canplay:canplay,error:error},_params.events.forEach((ev=>_video.addEventListener(ev,_handlers[ev],!0))),_video.onwaiting=e=>{_buffering=!0,buffering(_buffering)},_video.onplaying=e=>{_buffering=!1,buffering(_buffering)}}(),function initSharedVideo(){_sharedVideo&&(_video.readyState>=1&&(_this.dimensions.width=_video.videoWidth,_this.dimensions.height=_video.videoHeight),_video.readyState>=2&&_ready.resolve(),_video.readyState>=4&&_loaded.resolve())}(),this.set("loop",(bool=>_video.loop=bool)),this.get("loop",(()=>_video.loop)),this.set("src",(src=>{(src=getSource(src))!==_video.src&&(_ready=Promise.create(),_loaded=Promise.create(),_video.src=src,_this.playing?(_this.playing=!1,startPlayback()):_params.preload&&startPreload())})),this.get("src",(()=>_video.currentSrc)),this.set("volume",(v=>{v<.001&&(_video.muted=!0),_video.volume=v})),this.get("volume",(()=>_video.volume)),this.set("muted",(bool=>_video.muted=bool)),this.get("muted",(()=>_video.muted)),this.set("controls",(bool=>_video.controls=bool)),this.get("controls",(()=>_video.controls)),this.get("duration",(()=>_video.duration)),this.get("ended",(()=>_video.ended)),this.get("playback",(()=>_video.playbackRate)),this.get("time",(()=>_video.currentTime)),this.get("error",(()=>_video.error)),this.get("canRender",(()=>_video.readyState>=2)),this.get("canPlayThrough",(()=>_video.readyState>=4)),this.get("paused",(()=>_video.paused)),this.get("buffering",(()=>_buffering)),this.get("element",(()=>$video)),this.get("object",(()=>$video)),this.get("video",(()=>_video)),this.get("bufferedSeconds",(_=>_video.readyState<2?0:_video.buffered.end(0)-_video.buffered.start(0))),this.load=async function(){return startPreload()},this.play=async function(){return startPlayback()},this.pause=function(){_this.playing=!1,_video.pause()},this.stop=function(){_this.playing=!1,_video.pause(),_this.seek(0)},this.seek=function(t){if(_video.fastSeek)return _video.fastSeek(t);_video.currentTime=t},this.seekExact=function(t){_video.currentTime=t},this.ready=function(){return _ready},this.loaded=function(){return _loaded},this.onDestroy=function(){_this.stop(),_sharedVideo||(_video.src=""),function removeListeners(){_params.events.forEach((ev=>_video.removeEventListener(ev,_handlers[ev],!0))),_video.onwaiting=()=>{},_video.onplaying=()=>{}}(),_video=null},this.setSize=function(width,height){_video.width=width,_video.height=height,_this.dimensions.width=width,_this.dimensions.height=height}}),(()=>{Video.PLAY="hydra_video_play",Video.CANPLAY="hydra_video_can_play",Video.LOADEDMETADATA="hydra_video_loaded_metadata",Video.PAUSE="hydra_video_pause",Video.PROGRESS="hydra_video_progress",Video.UPDATE="hydra_video_update",Video.PLAYING="hydra_video_playing",Video.BUFFERING="hydra_video_buffering",Video.ENDED="hydra_video_ended",Video.WAITING="hydra_video_waiting",Video.ERROR="hydra_video_error"})),Class((function VideoTexture(_path,_props={}){Inherit(this,Component);const _this=this;let _video,_requestId,_hasRequestCallback=!1,_sharedVideo=!1;if(_this.canUpdate=!0,"object"==typeof _path&&!(_path instanceof HTMLVideoElement)){let path=_path.path;_props=_path,_path=path,delete _props.path}let{loop:loop,preload:preload,autoplay:autoplay,muted:muted,firstFrame:firstFrame,parseColor:parseColor,fps:fps,events:events=[]}=_props;function update(){if(_requestId=null,!_this.destroy||!_video.destroy)return;let updateTex=_video.canRender&&_this.canUpdate;firstFrame&&updateTex&&(updateTex=_video.time>0),updateTex&&(_this.videoTexture&&(_this.texture.destroy(),_this.texture=_this.videoTexture,delete _this.videoTexture),_this.texture.image||(_this.texture.image=_video.video,_this.texture.upload()),_this.colorParser&&_this.colorParser.update(_video.time),_this.texture.loaded=_this.texture.needsUpdate=!0,_this.uniform.value=_this.texture),_hasRequestCallback&&(_requestId=_video.element.div.requestVideoFrameCallback(update))}function noop(){}function handleSharedVideoPlaying(){start()}function handleSharedVideoPause(){stop()}function start(){_this.active=!0,_requestId&&(_video.element.div.cancelVideoFrameCallback(_requestId),_requestId=null),_hasRequestCallback?_this.startRender(noop):_this.startRender(update,fps,RenderManager.BEFORE_RENDER),update()}function stop(){_this.active=!1,_hasRequestCallback?_requestId&&_video.element.div.cancelVideoFrameCallback(_requestId):_this.stopRender(update)}void 0===loop&&(loop=!0),void 0===preload&&(preload=!0),void 0===autoplay&&(autoplay=!0),void 0===muted&&(muted=!0),void 0===firstFrame&&(firstFrame=!1),void 0===parseColor&&(parseColor=!1),void 0===events&&(events=[]),void 0===fps&&(fps=30),_this.uniform={value:null},function(){let src;if(_props.start&&defer((_=>_this.start())),_path instanceof HTMLVideoElement?(_sharedVideo=!0,src=_path,autoplay=!1,preload=!1,events=[...events,"pause"]):src=_path.includes("blob")?_path:Assets.getPath(_path),!_sharedVideo&&_path.includes(["jpg","png"])){let noop=_=>{};_this.texture=Utils3D.getTexture(src),_this.video={play:noop,pause:noop},parseColor&&(_this.colorParser=_this.initClass(VideoTextureColorParser,src,!0))}else{let videoEvents=["timeupdate","playing","ended"];if(events.forEach((ev=>{videoEvents.includes(ev)||videoEvents.push(ev)})),_video=_this.initClass(Video,{src:src,loop:loop,preload:preload,autoplay:autoplay,muted:muted,events:videoEvents}),_this.texture=new Texture,_this.texture.format=Texture.RGBFormat,_this.texture.minFilter=_this.texture.magFilter=Texture.LINEAR,_this.texture.generateMipmaps=!1,_this.texture.loaded=!1,_this.video=_video,_this.dimensions=_video.dimensions,_this.texture.dimensions=_this.dimensions,_this.events.bubble(_video,Video.PLAYING),parseColor&&(_this.colorParser=_this.initClass(VideoTextureColorParser,src,!1)),firstFrame){_this.videoTexture=_this.texture,_this.texture=Utils3D.getTexture(firstFrame);const update=_=>{_this.texture=_this.videoTexture,_this.events.unsub(_video,Video.PLAYING,update)};_this.events.sub(_video,Video.PLAYING,update)}}_this.uniform.value=_this.texture,_hasRequestCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,"safari"===Device.system.browser&&(_hasRequestCallback=!1),_sharedVideo&&function initSharedVideo(){_this.events.sub(_video,Video.PLAYING,handleSharedVideoPlaying),_this.events.sub(_video,Video.PAUSE,handleSharedVideoPause),!_video.paused&&_video.video.readyState>=2&&handleSharedVideoPlaying()}()}(),this.set("loop",(loop=>_video.loop=loop)),this.set("muted",(muted=>_video.muted=muted)),this.set("src",(src=>{_requestId&&(_video.element.div.cancelVideoFrameCallback(_requestId),_requestId=null),_video.src=src.includes("blob")?src:Assets.getPath(src),_hasRequestCallback&&(_requestId=_video.element.div.requestVideoFrameCallback(update))})),this.start=async function(){_sharedVideo||_video&&(start(),await _video.play())},this.stop=function(){_sharedVideo||_video&&(stop(),_video.pause())},this.seek=function(time){_sharedVideo||_video&&_video.seek(time)},this.onInvisible=function(){_sharedVideo||(_this.active&&_video.pause(),VideoTexture.element().removeChild(_this.video.object,!0))},this.onVisible=function(){_sharedVideo||(_this.active&&_video.play(),VideoTexture.element().add(_this.video.object))},this.onDestroy=function(){_this.texture.destroy(),_sharedVideo||VideoTexture.element().removeChild(_this.video.object,!0)}}),(_=>{var $element;VideoTexture.element=function(){return $element||(($element=Stage.create("VideoTextures")).css({position:"absolute",pointerEvents:"none",left:0,top:0,overflow:"hidden"}),$element.size(0,0).setZ(-10),Stage.add($element)),$element}})),Class((function VideoTextureColorParser(_path,_static){Inherit(this,Component);const _this=this;var _colorData,_color=new Color;this.color=new Color,this.lerp=1,async function(){let path=_path.split(".")[0]+".json";_colorData=await get(path)}(),this.update=function(time){if(_colorData)for(let key in _colorData)if(time<=key){_color.set("#"+_colorData[key]),_this.color.lerp(_color,_this.lerp);break}}})),Namespace("FX"),FX.Class((function VolumetricLight(_nuke=World.NUKE,_unique,_options={}){Inherit(this,Component);const _this=this;var _scene,_layer,_volume,_light,_invisible;if("object"==typeof _nuke&&_nuke.isAppState){let params=_nuke;_nuke=params.nuke||_this.parent.nuke||World.NUKE,_unique=params.unique,_options=params}var _obj={},_blurs=[],_projection=new ScreenProjection(_nuke.camera),_lightPos=new Vector3;function render({stage:stage,camera:camera}){if(!_light||!_this.enabled||_invisible)return;_scene.nuke.setSize(stage.width,stage.height),_scene.nuke.stage=stage,_scene.nuke.camera=camera,_projection.camera=camera,_lightPos.setFromMatrixPosition(_light.matrixWorld);let screen=_projection.project(_lightPos,stage);screen.x/=stage.width,screen.y/=stage.height,_volume.uniforms.lightPos.value.set(screen.x,1-screen.y),_scene.render()}!function polymorph(){"object"==typeof _unique&&(_options=_unique,_unique=void 0),_this.enabled=void 0===_options.enabled||_options.enabled}(),_this.enabled&&(function initLayer(){(_layer=_this.initClass(_options.useFXScene?FXScene:FXLayer,_nuke,_options)).name=(_unique?_unique.capitalize():"")+"VolumetricLight",_this.startRender((_=>_layer.render())),_layer.setDPR(1),_this.fxLayer=_layer}(),function initScene(){(_scene=_this.initClass(FXScene,_nuke)).setDPR(_options.dpr||1),_this.rt=_scene.rt;let shader=_this.initClass(Shader,_options.screenQuadShader||"ScreenQuad",{customCompile:"volumetricLight",tMap:{value:_layer},depthWrite:!1}),mesh=new Mesh(World.QUAD,shader);mesh.frustumCulled=!1,_scene.scene.add(mesh),_this.screenQuadMesh=mesh,_this.fxScene=_scene}(),function initPasses(){[new Vector2(1.5*_scene.nuke.dpr,0),new Vector2(0,1.5*_scene.nuke.dpr)].forEach((dir=>{let pass=new NukePass("LightBlur",{uDir:{value:dir}});_blurs.push(pass),_scene.nuke.add(pass)})),_volume=new NukePass("VolumetricLight",{unique:_unique,lightPos:{value:new Vector2,ignoreUIL:!0},fExposure:{type:"f",value:.2},fDecay:{type:"f",value:.93},fDensity:{type:"f",value:.96},fWeight:{type:"f",value:.4},fClamp:{type:"f",value:1}}),_scene.nuke.add(_volume),ShaderUIL.add(_volume).setLabel("Volumetric Light"),_this.volumeShader=_volume,_this.uniforms={tVolumetricBlur:{value:_scene}}}(),function addListeners(){_this.events.sub(_nuke,Nuke.RENDER,render)}()),this.addOccluder=function(mesh){_this.enabled&&_layer.add(mesh)},this.addLight=function(mesh){_this.enabled&&(_light=mesh)},this.set("resolution",(v=>{_this.enabled&&(_layer.setResolution(v),_scene.setResolution(v))})),this.set("dpr",(v=>{_this.enabled&&(_layer.setDPR(v),_scene.setDPR(v))})),this.onInvisible=function(){_invisible=!0},this.onVisible=function(){_invisible=!1},this.upload=async function(){_scene&&_scene.nuke&&await Initializer3D.uploadNukeAsync(_scene.nuke)},this.setComposite=function(texture){_this.enabled&&_this.screenQuadMesh.shader.set("tMap",texture)},this.render=function(stage,camera){_this.enabled&&(_this.events.unsub(_nuke,Nuke.RENDER,render),_obj.stage=stage,_obj.camera=camera,render(_obj))}})),Class((function XRConfig(_params){void 0!==_params.mixedReality&&(XRDeviceManager.mixedReality=_params.mixedReality),void 0!==_params.multiview&&(XRDeviceManager.multiview=_params.multiview),void 0!==_params.hands&&(XRDeviceManager.features.push("hand-tracking"),VRInput.useControllerHands=!0),void 0!==_params.foveation&&(XRDeviceManager.foveationLevel=function(){switch(_params.foveation){case"none":return null;case"low":return XRDeviceManager.FOVEATION_LEVEL_LOW;case"medium":return XRDeviceManager.FOVEATION_LEVEL_MEDIUM;case"high":return XRDeviceManager.FOVEATION_LEVEL_HIGH}}()),void 0!==_params.scaleFactor&&(XRDeviceManager.scaleFactor=_params.scaleFactor),void 0!==_params.framerate&&(XRDeviceManager.targetFramerate=_params.framerate),void 0!==_params.antialias&&(XRDeviceManager.antialias=_params.antialias)})),Class((function XRDeviceManager(){Inherit(this,Component);const _this=this;var _session,_promise;function getFoveationFeatureName(){switch(_this.foveationLevel){case _this.FOVEATION_LEVEL_LOW:return"low-fixed-foveation-level";case _this.FOVEATION_LEVEL_MEDIUM:return"medium-fixed-foveation-level";case _this.FOVEATION_LEVEL_HIGH:case _this.FOVEATION_LEVEL_HIGH_TOP:return"high-fixed-foveation-level";default:return"no-fixed-foveation"}}this.SESSION_START="xr_start",this.SESSION_END="xr_end",this.CONTROLS_START="controls_start",this.HEADSET_IDLE="headset_idle",this.HEADSET_RESUME="headset_resume",this.FOVEATION_LEVEL_NONE=0,this.FOVEATION_LEVEL_LOW=1,this.FOVEATION_LEVEL_MEDIUM=2,this.FOVEATION_LEVEL_HIGH=3,this.FOVEATION_LEVEL_HIGH_TOP=4,this.multiview=!0,this.scaleFactor=1,this.preallocatedScaleFactors=[],this.features=["bounded-floor"],this.reloadWhenSessionEnds=!0,this.mixedReality=!1,this.getVRSession=async function(){if(_session)return _session;if(_this.flag("disable3D"))return _this.flag("needNewSession",!0),null;let requiredFeatures=["local-floor"];if(_this.multiview){World.RENDERER.extensions.oculusMultiview&&(requiredFeatures.push("layers"),_this.MULTIVIEW=!0)}let optionalFeatures=[..._this.features,getFoveationFeatureName()],sessionType="immersive-"+(_this.mixedReality&&Device.system.xr.ar?"ar":"vr");return"immersive-vr"==sessionType&&_this.mixedReality&&(_this.mixedReality=!1),(_session=await navigator.xr.requestSession(sessionType,{requiredFeatures:requiredFeatures,optionalFeatures:optionalFeatures})).addEventListener("end",(_=>{_session=null,_this.flag("needNewSession",!0),_this.events.fire(_this.SESSION_END)})),_session.addEventListener("visibilitychange",(e=>{switch(e.session.visibilityState){case"visible":_this.events.fire(_this.HEADSET_RESUME);break;case"visible-blurred":case"hidden":_this.events.fire(_this.HEADSET_IDLE)}})),_session},this.waitForVRSession=async function(){let promise=Promise.create(),inter=setInterval((_=>{_session&&(clearInterval(inter),promise.resolve(_session))}),20);return promise},this.getARSession=async function(){return _session||((_session=await navigator.xr.requestSession("immersive-ar")).addEventListener("end",(_=>{_session=null,_this.flag("needNewSession",!0),_this.events.fire(_this.SESSION_END)})),_session.addEventListener("visibilitychange",(e=>{switch(e.session.visibilityState){case"visible":_this.events.fire(_this.HEADSET_RESUME);break;case"visible-blurred":case"hidden":_this.events.fire(_this.HEADSET_IDLE)}})),_session)},this.startSession=function(){return _this.isDisabled()&&_this.enable3D(),_this.flag("needNewSession")&&(_this.flag("needNewSession",!1),RenderManager.camera.reset?.(),RenderManager.renderer.reset?.(),_promise=null),_this.getVRSession(),_promise||(_promise=Promise.create(),_this.events.sub(_this.SESSION_START,_promise.resolve),_promise)},this.endSession=function(){_this.flag("needNewSession",!0),_this.events.fire(_this.SESSION_END);let promise=_session?.end();return _session=null,promise},this.waitForEnd=function(){let promise=Promise.create();return _this.events.sub(_this.SESSION_END,promise.resolve),promise},this.disable3D=function(){_this.flag("disable3D",!0)},this.enable3D=function(){_this.flag("disable3D",!1)},this.isDisabled=function(){return _this.flag("disable3D")},this.set("targetFramerate",(async value=>{await _promise,_session?.updateTargetFrameRate?.(value)}))}),"static"),Class((function ARCamera(){Inherit(this,Component);const _this=this;var _session;this.worldCamera=new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),this.getFrameOfReference=async function(){return _session=await XRDeviceManager.getARSession(),await _session.requestReferenceSpace("local")},this.getRenderCamera=function(view,pose){if(pose)return _this.worldCamera.position.copy(view.transform.position),_this.worldCamera.quaternion.copy(view.transform.orientation),_this.worldCamera.updateMatrixWorld(!0),_this.worldCamera.projectionMatrix.fromArray(view.projectionMatrix),_this.worldCamera}})),Class((function ARRenderer(_renderer,_nuke){Inherit(this,Component);const _this=this;var _session,_arCamera,_callback,_frame,_frameOfRef,_gl,_view;async function setup(){(_session=await XRDeviceManager.getARSession()).baseLayer=new XRWebGLLayer(_session,_renderer.context,{framebufferScaleFactor:RenderManager.DPR/Device.pixelRatio,stencil:_renderer.stencil}),_session.updateRenderState({baseLayer:_session.baseLayer}),_gl=_renderer.context,_arCamera=RenderManager.camera,_frameOfRef=await _arCamera.getFrameOfReference(),ARUtils.frameOfReference=_frameOfRef,_session.requestAnimationFrame(rAF),Renderer.overrideViewport=!0,_renderer.arRenderingPath=renderAR,Render.useRAF(rAFOverride),_this.events.fire(XRDeviceManager.SESSION_START)}function renderAR(render,scene,camera){_gl.bindFramebuffer(_gl.FRAMEBUFFER,_session.baseLayer.framebuffer);let viewport=_session.baseLayer.getViewport(_view);_gl.viewport(viewport.x,viewport.y,viewport.width,viewport.height),_renderer.resolution.set(viewport.width,viewport.height),_renderer.autoClear=!1,render(scene,camera),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_renderer.autoClear=!0,_nuke.postRender&&_nuke.postRender()}function rAFOverride(callback){_callback=callback}function rAF(t,frame){_session.requestAnimationFrame(rAF);let pose=frame.getViewerPose(_frameOfRef);pose&&(ARUtils.pose=pose,_view=pose.views[0],window.AURA&&(ARUtils.setFramebuffer(_session.baseLayer,_view),_nuke.rtt=ARUtils.getFramebuffer()),_arCamera.getRenderCamera(_view,pose),_frame=frame,_callback&&_callback(t))}defer(setup),this.render=function(scene,camera){_frame&&(_nuke.passes.length&&window.AURA?_nuke.render():_renderer.render(scene,camera))},this.setSize=function(width,height){_renderer.setPixelRatio(RenderManager.DPR),_renderer.setSize(width,height)},this.getCameraTexture=function(texture){texture._gl=_session.getCameraTexture()}})),Class((function ARUtils(){Inherit(this,Component);const _this=this;var _origin,_direction,_matrix,_session,_env,_framebuffer,_originArray,_directionArray,_cameraTexture,_envShaders=[],_tracking=!1;function checkStatus(){_session.trackingStatus?_tracking||(_tracking=!0,_this.events.fire(_this.TRACKING_CHANGE,{tracking:!0})):_tracking&&(_tracking=!1,_this.events.fire(_this.TRACKING_CHANGE,{tracking:!1}))}async function handleEnvTexture({texture:texture}){let t=new Texture;t.cube=!0,t.needsReupload=t.needsUpdate=!1,t._metal=t._gl=texture;let size="ios"==Device.system.os?256:16,hdr="android"==Device.system.os,lastEnv=_env;_env=_this.initClass(DynamicEnvGenerator,t,size,30,hdr),await _env.ready(),_envShaders.forEach((shader=>{shader.set("tEnvSpecular",_env.specular.texture),shader.set("tEnvDiffuse",_env.diffuse.texture)})),lastEnv&&lastEnv.destroy()}this.lightIntensity={type:"f",value:0},this.FIRST_TRANSFORM="arutils_first_transform",this.TRACKING_CHANGE="arutils_tracking_change",this.TRACKING_STARTED="arutils_tracking_started",this.CLOUD_ANCHOR="cloud_anchor",_this.events.sub(XRDeviceManager.SESSION_START,(async _=>{RenderManager.type==RenderManager.WEBAR&&((_session=await XRDeviceManager.getARSession()).onCreated=_=>_this.events.fire(_this.TRACKING_STARTED),_this.startRender(checkStatus,10),_session.addEventListener("envTexture",handleEnvTexture))})),this.getTrackingStatus=async function(){return _session||(_session=await XRDeviceManager.getARSession()),_session.trackingStatus},this.resetOrigin=function(){},this.findSurface=async function(obj=Mouse){if(_session||(_session=await XRDeviceManager.getARSession()),!_this.frameOfReference)return;_origin||(_origin=new Vector3,_direction=new Vector3,_matrix=new Matrix4,_originArray=new Float32Array(3),_directionArray=new Float32Array(3)),_matrix.copy(World.CAMERA.matrixWorld),_origin.set(0,0,0),_origin.applyMatrix4(_matrix),_direction.set(0,0,-1),_direction.applyMatrix4(_matrix),_direction.sub(_origin).normalize(),_origin.toArray(_originArray),_direction.toArray(_directionArray);let output=[];return(await _session.requestHitTest(_originArray,_directionArray,_this.frameOfReference)).forEach((hit=>{let array=hit.hitMatrix,group=new Group;group.matrixWorld.fromArray(array),group.matrix.fromArray(array),group.matrixWorld.decompose(group.position,group.rotation,group.scale),group.hit=hit,output.push(group)})),output},this.addAnchor=async function(hit,type="normal"){return _session||(_session=await XRDeviceManager.getARSession()),hit=hit.hit||hit,window.AURA?hit.type=type:type=void 0,_session.addAnchor(hit,type)},this.removeAnchor=async function(hit){hit=hit.hit||hit,_session||(_session=await XRDeviceManager.getARSession()),_session.removeAnchor(hit,hit.type)},this.getCameraTexture=async function(){return _session||(_session=await XRDeviceManager.getARSession()),_cameraTexture||(_cameraTexture=new Texture,await RenderManager.renderer.getCameraTexture(_cameraTexture),_cameraTexture.needsUpdate=!1),_cameraTexture},this.getCameraQuad=async function(shader){let texture=await _this.getCameraTexture();shader?shader.set("tMap",texture):shader=_this.initClass(Shader,"ARCameraQuad",{tMap:{value:texture},depthWrite:!1,depthTest:!1});let mesh=new Mesh(World.QUAD,shader);return mesh.renderOrder=-999,mesh},this.applyEnvLighting=async function(shader){_env&&(await _env.ready(),shader.set("tEnvDiffuse",_env.diffuse.texture)),_envShaders.push(shader)},this.setFramebuffer=function(baseLayer,view){if(!_this.framebuffer){let viewport=baseLayer.getViewport(view);(_framebuffer=new RenderTarget(viewport.width,viewport.height))._gl=baseLayer.framebuffer}},this.getFramebuffer=function(){return _framebuffer}}),"static"),Class((function VRInput(){Inherit(this,Component);const _this=this;var _sources,_session,_frame,_reference,_controller,_matrix,_identity,_controllers=[],_handColors={},_hands={},_fakeHands={};function onXRFrame(t,frame){_session=(_frame=frame).session,_frame.getViewerPose(_reference),function updateControllers(){_sources=_session.inputSources;for(let index=0;index<_sources.length;++index){let source=_sources[index];if(source.hand){if(_hands[source.handedness]||(_hands[source.handedness]=_this.initClass(VRInputHand,source.handedness)),_handColors[source.handedness]&&_hands[source.handedness].setColor(_handColors[source.handedness]),_hands[source.handedness].update(_frame,source.hand,_reference),!_this.flag("handsActive")){_this.flag("handsActive",!0),_controllers.forEach((c=>c.group.visible=!1));for(let key in _fakeHands)_fakeHands[key].group.visible=!1;for(let key in _hands)_hands[key].group.visible=!0;_this.isSetupFakeHands=!1}}else{let pose=_frame.getPose(source.targetRaySpace,_reference);if(!pose)continue;if(_matrix.fromArray(pose.transform.matrix),_matrix.equals(_identity))continue;let handedness=source.handedness,controller=_controllers.find((c=>c.handedness===handedness));if(!controller){controller=_this.initClass(VRInputController,handedness,_controller);let insertIndex=Math.min(index,_controllers.length);_controllers.splice(insertIndex,0,controller)}if(controller.inputSource=source,source.gamepad&&controller.processGamepad(source.gamepad),pose&&pose.transform&&(controller.grip=pose.transform.matrix),_this.useControllerHands&&(_fakeHands[handedness]||(_fakeHands[handedness]=_this.initClass(VRInputControllerHand,handedness,controller)),_handColors[source.handedness]&&_fakeHands[handedness].setColor(_handColors[source.handedness]),_fakeHands[handedness].handedness=handedness,_fakeHands[handedness].update(pose.transform.matrix),_controllers.forEach((c=>c.group.visible=!1))),_this.isSetupHands&&_this.flag("handsActive")){if(_this.flag("handsActive",!1),_this.useControllerHands)for(let key in _fakeHands)_fakeHands[key].group.visible=!0;else _controllers.forEach((c=>c.group.visible=!0));for(let key in _hands)_hands[key].group.visible=!1;_this.isSetupHands=!1}}}!_this.isSetup&&_controllers[0]&&(_this.isSetup=!0);!_this.isSetupHands&&_hands.left&&_this.flag("handsActive")&&(_this.isSetupHands=!0,Promise.all([_hands.left.ready(),_hands.right.ready()]).then((_=>{Interaction3D.useInput([..._hands.left.tips,..._hands.right.tips])})),_this.events.fire(_this.CHANGE,{type:"hands"}));_this.isSetupFakeHands||!_fakeHands.left||_this.flag("handsActive")||(_this.isSetupFakeHands=!0,Promise.all([_fakeHands.left.ready(),_fakeHands.right.ready()]).then((_=>{Interaction3D.useInput([..._fakeHands.left.tips,..._fakeHands.right.tips])})),_this.events.fire(_this.CHANGE,{type:"controllers"}))}()}async function setup(){if(RenderManager.type==RenderManager.WEBVR){var session=await XRDeviceManager.getVRSession();session&&(_matrix=new Matrix4,new Matrix4,_identity=new Matrix4,_reference=await RenderManager.camera.getFrameOfReference(),session.addEventListener("selectstart",onSelectStart),session.addEventListener("selectend",onSelectEnd),session.addEventListener("native",nativeEvent),await _this.wait(100),RenderManager.renderer.onFrame=onXRFrame,await _this.wait(_this,"isSetup"),_this.events.fire(XRDeviceManager.CONTROLS_START))}}function nativeEvent(e){if(_this.enabled)for(let controller of _controllers)controller.inputSource==e.inputSource&&(e.controller=controller,controller.events.fire(_this.NATIVE,e))}function onSelectStart(e){if(_this.enabled)for(let controller of _controllers)controller.inputSource==e.inputSource&&(e.controller=controller,controller.events.fire(_this.SELECT_START,e))}function onSelectEnd(e){if(_this.enabled)for(let controller of _controllers)controller.inputSource==e.inputSource&&(e.controller=controller,controller.events.fire(_this.SELECT_END,e))}this.SELECT_START="select_start",this.SELECT_END="select_end",this.NATIVE="native",this.BUTTON="vr_button",this.JOYSTICK="vr_joystick",this.CHANGE="vr_input_change",function addHandlers(){_this.events.sub(XRDeviceManager.SESSION_START,setup)}(),_this.enabled=!0,this.get("controllers",(_=>_controllers)),this.setControllerConfig=function(config){_controller=config;for(let controller of _controllers)controller.applyControllerConfig(config)},this.ready=function(){return _this.wait("isSetup")},this.getHandType=function(){return _this.isSetupHands?"real":"fake"},this.handsReady=function(){return Promise.race([_this.wait("isSetupHands"),_this.wait("isSetupFakeHands")])},this.getHand=function(type){return _this.isSetupHands?_hands[type]:_fakeHands[type]},this.setHandColor=function(handedness,color){_handColors[handedness]=color,_this.isSetupHands?_hands[handedness].setColor(color):_fakeHands[handedness].setColor(color)},this.setBeamColor=async function(color){await _this.ready();for(let controller of _controllers)controller.setBeamColor(color)},this.setControllerObject=function(Class){_this.setControllerConfig({body:Class})}}),"static"),Class((function VRInputController(_type,_config){Inherit(this,Object3D);const _this=this;var _body,_beam,_point,_hitPositionRequested,_beamRequested,_grip=new Matrix4,_target=new Matrix4,_q=new Quaternion,_v3=new Vector3,_haptics={},_buttons={},_joystick={x:0,y:0};this.isVrController=!0,this.pointer=new Vector3;const PHYSICAL_SYNC=!!window.PhysicalSync;function initBody(){_body=_this.initClass(_config.body,{controller:_this,type:_type})}function loop(){_grip.decompose(_this.group.position,_this.group.quaternion,_this.group.scale),_this.group.updateMatrixWorld(!0),_this.group.getWorldPosition(_this.group.worldPos),_this.group.getWorldQuaternion(_this.group.worldQuat),_this.pointer.set(0,0,-1).applyQuaternion(_this.group.worldQuat),PHYSICAL_SYNC&&PhysicalSync.realignObject(_this.group)}function beforeRender(){_config.enableHitHaptics&&_hitPositionRequested&&!_point.group.visible&&_this.triggerHaptics(.4,30),_beam&&(_beam.group.visible=_beamRequested),_point&&(_point.group.visible=_hitPositionRequested),_beamRequested=!1,_hitPositionRequested=!1}function getButtonLabel(i){let label;switch(i){case 0:label="trigger";break;case 1:label="side_trigger";break;case 2:label="touch_pad";break;case 3:label="joy_click";break;case 4:label="a";break;case 5:label="b"}return label}!function(){!function initConfig(){_config||(_config={});_config.body||(_config.body=VRInputControllerBody);_config.beam||(_config.beam=VRInputControllerBeam);_config.point||(_config.point=VRInputControllerPoint)}(),initBody(),function initBeam(){(_beam=_this.initClass(_config.beam)).group.visible=!1}();let velocity=new VelocityTracker(_this.group.position);velocity.start(),_this.velocity=velocity.value,Interaction3D.useInput(_this),RenderManager.camera.wrapper.add(_this.group),_this.startRender(loop),_this.startRender(beforeRender,RenderManager.BEFORE_RENDER)}(),this.get("target",(_=>_target)),this.set("target",(m=>_target.fromArray(m))),this.get("grip",(_=>_grip)),this.set("grip",(m=>_grip.fromArray(m))),this.get("color",(_=>_beam.color)),this.set("color",(c=>{_beam.color=c})),this.get("body",(_=>_body.mesh)),this.get("handedness",(_=>_this.inputSource.handedness)),this.setHitPosition=function(hit){_point&&_point.group&&hit&&hit.point&&(_point.group.position.copy(hit.point),_v3.copy(hit.face.normal),hit.object.getWorldQuaternion(_q),_v3.applyQuaternion(_q),_v3.add(hit.point),_point.group.lookAt(_v3),_hitPositionRequested=!0)},this.applyControllerConfig=function(config){_config=config,_body&&(_this.group.remove(_body.group),_body.destroy(),_body=null),initBody()},this.processGamepad=function(gamepad){gamepad.buttons.forEach(((b,i)=>{b.pressed?_buttons[i]||(_buttons[i]=!0,_this.events.fire(VRInput.BUTTON,{pressed:!0,label:getButtonLabel(i),controller:_this})):_buttons[i]&&(_buttons[i]=!1,_this.events.fire(VRInput.BUTTON,{pressed:!1,label:getButtonLabel(i),controller:_this}))}));let joyX=gamepad.axes[2],joyY=gamepad.axes[3];joyX==_joystick.x&&joyY==_joystick.y||(_joystick.x=joyX,_joystick.y=joyY,_joystick.controller=_this,_this.events.fire(VRInput.JOYSTICK,_joystick)),1==_haptics.needsUpdate&&gamepad.hapticActuators&&gamepad.hapticActuators.length&&(_haptics.needsUpdate=!1,gamepad.hapticActuators[0].pulse(_haptics.strength,_haptics.time))},this.onDestroy=function(){RenderManager.camera.wrapper.remove(_this.group),World.SCENE.remove(_point.group)},this.setBeamColor=function(color){_beam&&(_beam.color=color)},this.showBeam=function(){_beam&&(_beamRequested=!0)},this.hideBeam=function(){},this.triggerHaptics=function(strength,time){if("number"!=typeof strength||"number"!=typeof time)throw"triggerHaptics requires (strength, time)";_haptics.strength=strength,_haptics.time=time,_haptics.needsUpdate=!0}})),Class((function VRInputControllerBeam(){Inherit(this,Object3D);const _this=this;var _geom,_shader,_mesh,_color;!function initGeom(){_geom=new CylinderGeometry(.005,0,2)}(),function initShader(){_color=VRInputControllerBeam.getColor(),_shader=_this.initClass(Shader,"VRInputControllerBeam",{uColor:{value:new Color(_color)},transparent:!0})}(),function initMesh(){(_mesh=new Mesh(_geom,_shader)).renderOrder=9999}(),function position(){_this.group.rotation.x=.5*Math.PI,_this.group.position.z=-1,_this.group.add(_mesh)}(),this.set("color",(function(color){VRInputControllerBeam.setColor(color),_shader.set("uColor",new Color(color)),_color=color})),this.get("color",(function(){return _color}))}),(_=>{var _color="#ffffff";VRInputControllerBeam.setColor=function(color){return _color=color},VRInputControllerBeam.getColor=function(){return _color}})),Class((function VRInputControllerBody(){Inherit(this,Object3D);const _this=this;!async function(){let geom=await GeomThread.loadGeometry(Assets.getPath("~assets/geometry/hand_indexed.bin")),shader=_this.initClass(Shader,"VRInputControllerDefault",{uAlpha:{value:.5},transparent:!0,depthWrite:!1,side:Shader.DOUBLE_SIDE}),mesh=new Mesh(geom,shader);_this.group.add(mesh),_this.mesh=mesh,mesh.renderOrder=9999}()})),Class((function VRInputControllerPoint(){Inherit(this,Object3D);const _this=this;var _geom,_shader,_mesh,_color,_borderColor;!function initGeom(){_color=VRInputControllerPoint.getColor(),_borderColor=VRInputControllerPoint.getBorderColor(),_geom=World.PLANE}(),function initShader(){_shader=_this.initClass(Shader,"VRInputControllerPoint",{uColor:{value:new Color(_color)},uBorderColor:{value:new Color(_borderColor)},uAlpha:{value:1},depthTest:!1,transparent:!0})}(),function initMesh(){(_mesh=new Mesh(_geom,_shader)).scale.setScalar(.02),_mesh.renderOrder=1e4,_this.group.visible=!1,_this.group.add(_mesh)}(),this.set("color",(function(color){VRInputControllerPoint.setColor(color),_shader.set("uColor",new Color(color)),_color=color})),this.get("color",(function(){return _color})),this.set("borderColor",(function(color){VRInputControllerPoint.setBorderColor(color),_shader.set("uBorderColor",new Color(color)),_borderColor=color})),this.get("borderColor",(function(){return _borderColor}))}),(_=>{var _color="#ffffff",_borderColor="#000000";VRInputControllerPoint.setColor=function(color){return _color=color},VRInputControllerPoint.getColor=function(){return _color},VRInputControllerPoint.setBorderColor=function(color){return _borderColor=color},VRInputControllerPoint.getBorderColor=function(){return _borderColor}})),Class((function VRAbstractHand(){Inherit(this,Object3D);const _this=this;this.pointer=new Vector3,this.isAbstractHand=!0;var _targetColor=new Color;const PHYSICAL_SYNC=!!window.PhysicalSync;function loop(){if(PHYSICAL_SYNC&&PhysicalSync.realignObject(_this.group),_this.thumb){for(let i=_this.tips.length-1;i>-1;i--)_this.tips[i].update();_this.pointer.set(0,0,-1).applyQuaternion(_this.index.quaternion);let distance=_this.thumb.position.distanceTo(_this.index.position);_this.flag("pinching")&&distance>.025?(_this.flag("pinching",!1),_this.events.fire(VRInputHand.PINCH,{action:"end",hand:_this})):!_this.flag("pinching")&&distance<=.015&&(_this.flag("pinching",!0),_this.events.fire(VRInputHand.PINCH,{action:"start",hand:_this}))}_this.index&&_this.pointer.set(0,0,-1).applyQuaternion(_this.index.quaternion)}!function createBody(){_this.body=Utils3D.createDebug(.07),_this.body.shader.neverRender=!0;let velocity=new VelocityTracker(_this.body.position);velocity.start(),_this.velocity=velocity.value}(),function initShader(){_this.shader=VRAbstractHand.shader?VRAbstractHand.shader.clone():_this.initClass(Shader,"VRHand",{transparent:!0,uColor:{value:new Color("#ffffff")},uStatic:{value:0}}),_this.shader.uniforms.uColor={value:new Color}}(),_this.startRender(loop),_this.setColor=function(colorHex){_targetColor.set(colorHex),_this.shader.uniforms.uColor.value.lerp(_targetColor,.07)},_this.setShader=function(shader){_this.shader=shader}}),(_=>{VRAbstractHand.useShader=function(shader){VRAbstractHand.shader=shader}})),Class((function VRHandFingerTip(_bone,_prev){const _this=this;this.position=new Vector3,this.quaternion=new Quaternion;var _null=new Group,_velocity=new VelocityTracker(this.position);this.velocity=_velocity.value,this.direction=new Vector3,this.body=new Mesh(World.SPHERE,Utils3D.getTestShader()),this.body.visible=!1,this.body.scale.setScalar(.01),this.update=function(){_bone.getWorldPosition(_this.position),_prev.getWorldPosition(_null.position),_this.position.divideScalar(100),_null.position.divideScalar(100),_this.direction.copy(_bone.position).sub(_prev.position).normalize(),_null.isCamera=!0,_null.lookAt(_this.position),_this.quaternion.copy(_null.quaternion),_this.position.applyMatrix4(RenderManager.camera.wrapper.matrixWorld),_this.body.position.x=_this.position.x,_this.body.position.y=_this.position.y,_this.body.position.z=_this.position.z,_this.body.matrix.elements[12]=_this.body.matrixWorld.elements[12]=_this.position.x,_this.body.matrix.elements[13]=_this.body.matrixWorld.elements[13]=_this.position.y,_this.body.matrix.elements[14]=_this.body.matrixWorld.elements[14]=_this.position.z,_velocity.update()},this.updateStatic=function(position,quaternion){_this.position.copy(position),_this.quaternion.copy(quaternion),_this.direction.set(0,0,-1).applyQuaternion(quaternion),_this.body.position.copy(_this.position),_this.body.matrix.elements[12]=_this.body.matrixWorld.elements[12]=_this.position.x,_this.body.matrix.elements[13]=_this.body.matrixWorld.elements[13]=_this.position.y,_this.body.matrix.elements[14]=_this.body.matrixWorld.elements[14]=_this.position.z}})),Class((function VRInputControllerHand(_type,_controller){Inherit(this,VRAbstractHand);const _this=this;var _geom,_mesh,_tip,_grip=new Matrix4;this.tips=[],async function(){_geom=await GeomThread.loadGeometry("vrhands/pointy_hand_"+_type),_this.flag("loaded",!0),_this.shader.uniforms.uStatic.value=1,(_mesh=new Mesh(_geom,_this.shader)).scale.multiplyScalar(.01),_this.add(_mesh),_mesh.frustumCulled=!1,_mesh.rotation.set(Math.radians(-90),0,Math.radians(-90)),_mesh.position.x=.03*("left"==_type?-1:1),(_tip=Utils3D.createDebug(.02)).position.set(.014*("left"==_type?-1:1),.02,-.125),_tip.shader.neverRender=!0,_this.add(_tip),_this.tips[0]=_this.initClass(VRHandFingerTip,_tip),RenderManager.camera.wrapper.add(_this.group),_this.group.add(_this.body)}(),this.update=function(matrix){16==matrix.length&&(_grip.fromArray(matrix),_grip.decompose(_this.group.position,_this.group.quaternion,_this.group.scale),_this.tips[0]&&_this.tips[0].updateStatic(_tip.getWorldPosition(),_this.group.quaternion),window.PhysicalSync&&PhysicalSync.realignObject(_this.group),_this.group.updateMatrixWorld(!0))},this.ready=function(){return _this.wait("loaded")},this.get("index",(_=>_this.tips[0]))})),Class((function VRInputHand(_type){Inherit(this,VRAbstractHand);const _this=this;var _geom,_mesh,_center;this.hand=this.handedness=_type,this.tips=[];var _bones=[];const joints=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"];!async function(){await async function initMesh(){_geom=await GeomThread.loadSkinnedGeometry("vrhands/hand_"+_type),_this.flag("loaded",!0),(_mesh=new Skin(_geom,_this.shader,_geom.bones)).root.rotation.x=Math.PI/2,_mesh.scale.setScalar(.01),_this.add(_mesh),_mesh.frustumCulled=!1,RenderManager.camera.wrapper.add(_this.group)}(),function mapBones(){let findBone=name=>{for(let i=0;i<_mesh.bones.length;i++)if(_mesh.bones[i].name==name)return _mesh.bones[i]};["b_%_wrist","b_%_thumb1","b_%_thumb2","b_%_thumb3","b_%_thumb_null","b_%_index0","b_%_index1","b_%_index2","b_%_index3","b_%_index_null","b_%_middle0","b_%_middle1","b_%_middle2","b_%_middle3","b_%_middle_null","b_%_ring0","b_%_ring1","b_%_ring2","b_%_ring3","b_%_ring_null","b_%_pinky0","b_%_pinky1","b_%_pinky2","b_%_pinky3","b_%_pinky_null"].forEach((boneName=>{if(boneName){boneName=boneName.replace("%","right"===_type?"r":"l");const bone=findBone(boneName);boneName.includes("null")&&_this.tips.push(_this.initClass(VRHandFingerTip,bone,findBone(boneName.replace("_null","3")))),boneName.includes("middle1")&&(_center=_this.initClass(VRHandFingerTip,bone,findBone(boneName.replace("_middle1","_middle0")))),_bones.push(bone)}else _bones.push(null)}))}()}(),this.update=function(frame,hand,ref){if(_mesh){for(let i=0;i<joints.length;i++){let jointSpace=hand.get(joints[i]);if(jointSpace){let jointPose=frame.getJointPose(jointSpace,ref);_bones[i]&&jointPose&&(_bones[i].position.copy(jointPose.transform.position).multiplyScalar(100),_bones[i].quaternion.copy(jointPose.transform.orientation))}}_center.update(),_this.body.position.x=_center.position.x,_this.body.position.y=_center.position.y,_this.body.position.z=_center.position.z,_this.body.matrix.elements[12]=_this.body.matrixWorld.elements[12]=_center.position.x,_this.body.matrix.elements[13]=_this.body.matrixWorld.elements[13]=_center.position.y,_this.body.matrix.elements[14]=_this.body.matrixWorld.elements[14]=_center.position.z,_this.group.updateMatrixWorld(!0)}},this.useShader=function(shader){_mesh.shader=shader},this.ready=function(){return _this.wait("loaded")},this.get("thumb",(_=>_this.tips[0])),this.get("index",(_=>_this.tips[1])),this.get("middle",(_=>_this.tips[2])),this.get("ring",(_=>_this.tips[3])),this.get("pinky",(_=>_this.tips[4]))}),(_=>{VRInputHand.PINCH="vr_hand_pinch"})),Class((function VRInputHandAura(_type){Inherit(this,VRAbstractHand);const _this=this;var _boneMapping,_mesh,_center;const _data={rootPose:{position:[],orientation:[]}};var _quaternion=new Quaternion,_vector=new Vector3;function loop(){if("number"!=typeof _data.hand)return;_boneMapping.forEach((entry=>{let orientation=_data[entry.name],bone=_mesh.bones[entry.skinIndex];_quaternion.fromArray(orientation),bone.quaternion.slerp(_quaternion,.5)}));let position=_data.rootPose.position,orientation=_data.rootPose.orientation;_vector.fromArray(position),_quaternion.fromArray(orientation),_mesh.bones[0].position.lerp(_vector,.5),_mesh.bones[0].quaternion.slerp(_quaternion,1)}this.hand=this.handedness=_type,this.tips=[],async function(){await async function initMesh(){_geom=await GeomThread.loadSkinnedGeometry("vrhands/aura_"+_type),_this.flag("loaded",!0),_mesh=new Skin(_geom,_this.shader,_geom.bones),_this.add(_mesh),_mesh.frustumCulled=!1,World.SCENE.add(_this.group)}(),function initBoneMapping(){_boneMapping=[{name:"ovrHandBone_WristRoot",skinIndex:0,skeletonIndex:0},{name:"ovrHandBone_ForearmStub",skinIndex:23,skeletonIndex:1},{name:"ovrHandBone_Thumb0",skinIndex:1,skeletonIndex:2},{name:"ovrHandBone_Thumb1",skinIndex:2,skeletonIndex:3},{name:"ovrHandBone_Thumb2",skinIndex:3,skeletonIndex:4},{name:"ovrHandBone_Thumb3",skinIndex:4,skeletonIndex:5},{name:"ovrHandBone_Index1",skinIndex:6,skeletonIndex:6},{name:"ovrHandBone_Index2",skinIndex:7,skeletonIndex:7},{name:"ovrHandBone_Index3",skinIndex:8,skeletonIndex:8},{name:"ovrHandBone_Middle1",skinIndex:10,skeletonIndex:9},{name:"ovrHandBone_Middle2",skinIndex:11,skeletonIndex:10},{name:"ovrHandBone_Middle3",skinIndex:12,skeletonIndex:11},{name:"ovrHandBone_Ring1",skinIndex:14,skeletonIndex:12},{name:"ovrHandBone_Ring2",skinIndex:15,skeletonIndex:13},{name:"ovrHandBone_Ring3",skinIndex:16,skeletonIndex:14},{name:"ovrHandBone_Pinky0",skinIndex:18,skeletonIndex:15},{name:"ovrHandBone_Pinky1",skinIndex:19,skeletonIndex:16},{name:"ovrHandBone_Pinky2",skinIndex:20,skeletonIndex:17},{name:"ovrHandBone_Pinky3",skinIndex:21,skeletonIndex:18}]}(),function initFingerTips(){const getBone=key=>{for(let i=0;i<_boneMapping.length;i++){let entry=_boneMapping[i];if(entry.name==key)return _mesh.bones[entry.skinIndex]}};["ovrHandBone_Thumb3","ovrHandBone_Index3","ovrHandBone_Middle3","ovrHandBone_Ring3","ovrHandBone_Pinky3"].forEach((key=>{_this.tips.push(_this.initClass(VRHandFingerTip,getBone(key),getBone(key.replace("3","2"))))})),_center=_this.initClass(VRHandFingerTip,getBone("ovrHandBone_Middle1"),getBone("ovrHandBone_Middle3"))}(),_this.startRender(loop)}(),this.update=function(frame,data){_mesh&&(_data.hand=data.hand,_data.rootPose.position[0]=data.rootPose.position[0],_data.rootPose.position[1]=data.rootPose.position[1],_data.rootPose.position[2]=data.rootPose.position[2],_data.rootPose.orientation[0]=data.rootPose.orientation[0],_data.rootPose.orientation[1]=data.rootPose.orientation[1],_data.rootPose.orientation[2]=data.rootPose.orientation[2],_data.rootPose.orientation[3]=data.rootPose.orientation[3],_boneMapping.forEach((entry=>{_data[entry.name]||(_data[entry.name]=[]),_data[entry.name][0]=data[entry.name][0],_data[entry.name][1]=data[entry.name][1],_data[entry.name][2]=data[entry.name][2],_data[entry.name][3]=data[entry.name][3]})),_this.group.visible=data.confidence>3,_center.update(),_this.body.position.copy(_center.position),_this.body.updateMatrixWorld(!0))},this.ready=function(){return _this.wait("loaded")},this.get("thumb",(_=>_this.tips[0])),this.get("index",(_=>_this.tips[1])),this.get("middle",(_=>_this.tips[2])),this.get("ring",(_=>_this.tips[3])),this.get("pinky",(_=>_this.tips[4]))})),Class((function VRCamera(_gl,_nuke){Inherit(this,Component);const _this=this;var _session,_frame,_added,_map=new Map,_tempCameras=new Map,_wrapper0=new Group,_wrapper1=new Group;function applyCamera(camera){_this.worldCamera.projectionMatrix.copy(camera.projectionMatrix),function applyDepthClipPlanes(){let{near:depthNear,far:depthFar}=_this.worldCamera;Math.abs(_session.renderState.depthNear-depthNear)<.001&&Math.abs(_session.renderState.depthFar-depthFar)<1||_session.updateRenderState({depthNear:depthNear,depthFar:depthFar})}(),_this.worldCamera.position.copy(camera.position),_this.worldCamera.quaternion.copy(camera.quaternion),_this.worldCamera.matrixWorld.copy(camera.matrixWorld),_this.worldCamera.matrix.copy(camera.matrix)}this.worldCamera=new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),this.offset=_wrapper0.position,this.inset=_wrapper1.position,this.wrapper=_wrapper0,this.absoluteCameraPos=new Vector3,_wrapper0.add(_wrapper1),this.getFrameOfReference=async function(){if(_frame)return _frame;_session=await XRDeviceManager.getVRSession();try{_frame=await _session.requestReferenceSpace("bounded-floor")}catch(e){_frame=await _session.requestReferenceSpace("local-floor")}return _frame},this.newFrame=function(){_map.clear()},this.getRenderCamera=function(view,pose){if(!pose)return;if(_map.has(view.eye))return applyCamera(_map.get(view.eye)),_this.worldCamera;_tempCameras.has(view.eye)||_tempCameras.set(view.eye,new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3));let camera=_tempCameras.get(view.eye);return _added||(World.SCENE.add(_wrapper0),_added=!0),_this.absoluteCameraPos.copy(view.transform.position),_wrapper1.position.copy(view.transform.position),_wrapper1.quaternion.copy(view.transform.orientation),_wrapper0.updateMatrixWorld(!0),camera.projectionMatrix.fromArray(view.projectionMatrix),Utils3D.decompose(_wrapper1,camera),camera.updateMatrixWorld(!0),_map.set(view.eye,camera),applyCamera(camera),_this.worldCamera},this.forceUpdate=function(){_wrapper0.updateMatrixWorld(!0),Utils3D.decompose(_wrapper1,_this.worldCamera),_this.worldCamera.updateMatrixWorld(!0)},this.reset=function(){_frame=null}})),Class((function VRRenderer(_renderer,_nuke){Inherit(this,Component);const _this=this;var _session,_gl,_callback,_frame,_scaleFactor,_nativeScaleFactor,_currentUnparsedScaleFactor,_frameOfRef,_vrCamera,_frameBound,_firedEyeRender,_xrFramebuffer,_xrGLBinding,_mvExt,_depthStencilTex,_multiviewLayer,_frustums=[],_renderEvt={},_objRenderEvt={},_cameras={},_viewCameras=new WeakMap;const USE_UBO=Renderer.UBO;function updateShaderMultiView(shader){let vs=shader.vertexShader,obj=shader.mesh;if(obj&&_renderer.extensions.oculusMultiview&&XRDeviceManager.multiview){let topLevelScene=!1,parent=obj._parent;for(;parent;)parent==World.SCENE&&(topLevelScene=!0),parent=parent._parent;if(topLevelScene){let newHeader="#version 300 es\n";newHeader+="#extension GL_OVR_multiview : require\n",newHeader+="layout(num_views=2) in;\n";let uniforms="uniform mat4 leftProjectionMat;\n";uniforms+="uniform mat4 leftModelViewMat;\n",uniforms+="uniform mat4 rightProjectionMat;\n",uniforms+="uniform mat4 rightModelViewMat;\n",uniforms+="#define MULTIVIEW 1\n",vs=vs.replace("#version 300 es\n",newHeader),vs=vs.replace(/modelViewMatrix[ *]/g,"(gl_ViewID_OVR == 0u ? leftModelViewMat : rightModelViewMat)"),vs=vs.replace(/projectionMatrix[ *]/g,"(gl_ViewID_OVR == 0u ? leftProjectionMat : rightProjectionMat)"),vs=vs.split("__ACTIVE_THEORY_LIGHTS__"),vs[0]+=uniforms,vs=vs.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=vs}}}function parseScaleFactor(value){return"number"==typeof value?value:"native"===value?_nativeScaleFactor:1}function parseFixedFoveation(foveationLevel){return Math.range(foveationLevel||0,XRDeviceManager.FOVEATION_LEVEL_NONE,XRDeviceManager.FOVEATION_LEVEL_HIGH_TOP,0,1,!0)}async function setup(){(_session=await XRDeviceManager.waitForVRSession())&&(_nativeScaleFactor=XRWebGLLayer.getNativeFramebufferScaleFactor(_session),_currentUnparsedScaleFactor=XRDeviceManager.scaleFactor,_scaleFactor=parseScaleFactor(_currentUnparsedScaleFactor),function initBaseLayers(){let scaleFactors=[_scaleFactor,...XRDeviceManager.preallocatedScaleFactors.map(parseScaleFactor)],baseLayers={};scaleFactors.forEach((scaleFactor=>{baseLayers[scaleFactor]||(baseLayers[scaleFactor]=new XRWebGLLayer(_session,_renderer.context,{stencil:_renderer.stencil,framebufferScaleFactor:scaleFactor}))})),_session.baseLayer=baseLayers[_scaleFactor],XRDeviceManager.preallocatedScaleFactors.length&&(_baseLayers=baseLayers)}(),Render.useRAF(rAFOverride),_vrCamera=RenderManager.camera,_frameOfRef=await _vrCamera.getFrameOfReference(),_renderer.vrRenderingPath=render,_gl=_renderer.context,XRDeviceManager.MULTIVIEW?(console.log("SET UP MULTIVIEW"),_xrFramebuffer=_gl.createFramebuffer(),_xrGLBinding=new XRWebGLBinding(_session,_gl),(_multiviewLayer=_xrGLBinding.createProjectionLayer({scaleFactor:_scaleFactor,textureType:"texture-array",depthFormat:_gl.DEPTH_COMPONENT24})).fixedFoveation=parseFixedFoveation(XRDeviceManager.foveationLevel),_session.updateRenderState({layers:[_multiviewLayer]}),_mvExt=_renderer.extensions.oculusMultiview):_session.updateRenderState({baseLayer:_session.baseLayer}),_this.events.fire(XRDeviceManager.SESSION_START),setTimeout((_=>{World.RENDERER.preventRender=!1,_session.requestAnimationFrame(rAF),setTimeout((_=>{AppState.set("Global/immersive",Utils.uuid())}),20)})))}function getCamera(eye,camera){return _cameras[eye]||(_cameras[eye]=camera.clone()),_cameras[eye]}function initCameraUBO(camera){camera._ubo=new UBO(0,_gl),camera._ubo.push({value:camera.projectionMatrix}),camera._ubo.push({value:camera.matrixWorldInverse}),camera._ubo.push({value:camera.worldPos}),camera._ubo.push({value:camera.worldQuat}),camera._ubo.push({value:_renderer.resolution}),camera._ubo.push(_renderer.time),camera._ubo.push(Render.timeScaleUniform),camera._ubo.upload()}function rAF(t,frame){_vrCamera.newFrame(),_frame=frame,_frameBound=!1,_firedEyeRender=!1,_callback&&_callback(t),_this.onFrame&&_this.onFrame(t,frame),_session.requestAnimationFrame(rAF)}function render(scene,camera,projScreenMatrix,frustum,attachSceneUniforms,rt){if(!_frame)return;let pose;camera.getWorldPosition(camera.worldPos),camera.getWorldQuaternion(camera.worldQuat),USE_UBO&&(camera._ubo?camera._ubo.update():initCameraUBO(camera));try{if(pose=_frame.getViewerPose(_frameOfRef),!pose)return}catch(e){return}if(rt){let width=_session.baseLayer.framebufferWidth,height=_session.baseLayer.framebufferHeight;rt.width==width&&rt.height==height||rt.setSize(Math.round(width*rt.vrRT),Math.round(height*rt.vrRT),!0),rt._gl||rt.upload()}let multiViewport,fixedFoveation=parseFixedFoveation(XRDeviceManager.foveationLevel);_session.baseLayer&&fixedFoveation!==_session.baseLayer.fixedFoveation&&(_session.baseLayer.fixedFoveation=fixedFoveation),_multiviewLayer&&fixedFoveation!==_multiviewLayer.fixedFoveation&&(_multiviewLayer.fixedFoveation=fixedFoveation);let fireEyeRender=!_firedEyeRender;_firedEyeRender=!0;for(let i=0;i<pose.views.length;i++){let view=pose.views[i],renderCamera=_vrCamera.getRenderCamera(view,pose);if(!renderCamera)continue;let viewCamera=getCamera(view.eye,renderCamera);_viewCameras.set(view,viewCamera),viewCamera.projectionMatrix.copy(renderCamera.projectionMatrix),viewCamera.matrix.copy(renderCamera.matrix),viewCamera.matrixWorld.copy(renderCamera.matrixWorld),viewCamera.matrixWorldInverse.getInverse(viewCamera.matrixWorld),viewCamera.worldPos.copy(renderCamera.worldPos),viewCamera.worldQuat.copy(renderCamera.worldQuat),viewCamera.position.copy(renderCamera.position),viewCamera.quaternion.copy(renderCamera.quaternion);let viewport=_session.baseLayer.getViewport(view);if(USE_UBO&&(viewCamera._ubo?viewCamera._ubo.update():initCameraUBO(viewCamera)),fireEyeRender&&(_renderEvt.stage=viewport,_renderEvt.camera=viewCamera,_renderEvt.view=i,_renderEvt.eye=view.eye,RenderManager.fire(RenderManager.EYE_RENDER,_renderEvt)),_frustums[i]||(_frustums[i]=new Frustum),_frustums[i].setFromCamera(viewCamera),XRDeviceManager.MULTIVIEW&&scene==World.SCENE){let glLayer=_xrGLBinding.getViewSubImage(_session.renderState.layers[0],view),viewport=glLayer.viewport;glLayer.framebuffer=_xrFramebuffer,_gl.bindFramebuffer(_gl.FRAMEBUFFER,_xrFramebuffer),multiViewport=viewport,0==i&&(_mvExt.framebufferTextureMultiviewOVR(_gl.DRAW_FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,glLayer.colorTexture,0,0,2),null==glLayer.depthStencilTexture?_depthStencilTex||(_depthStencilTex=_gl.createTexture(),_gl.bindTexture(_gl.TEXTURE_2D_ARRAY,_depthStencilTex),_gl.texStorage3D(_gl.TEXTURE_2D_ARRAY,1,_gl.DEPTH_COMPONENT24,viewport.width,viewport.height,2)):_depthStencilTex=glLayer.depthStencilTexture,_mvExt.framebufferTextureMultiviewOVR(_gl.DRAW_FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_depthStencilTex,0,0,2))}}let forceClear=!1;if(_frameBound||(_frameBound=!rt,multiViewport||_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt?rt._gl:_session.baseLayer.framebuffer),XRDeviceManager.autoClearFrameBuffer&&(forceClear=!0)),_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],XRDeviceManager.mixedReality?0:Renderer.CLEAR[3]),(forceClear||rt||_renderer.autoClear&&_this.autoClear)&&_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT),XRDeviceManager.MULTIVIEW&&scene==World.SCENE)for(let l=0;l<2;l++)for(let i=0;i<scene.toRender[l].length;i++){let object=scene.toRender[l][i];if(object.onBeforeRender&&object.onBeforeRender(),object._drawing=!1,!object.determineVisible()||!object.shader.visible||object.shader.neverRender||object.neverRender)continue;let inFrustum=!1;for(let f=0;f<pose.views.length;f++)inFrustum||(inFrustum=_frustums[f].intersectsObject(object));if(!object.frustumCulled||inFrustum){object._drawing=!0,object.shader.draw(object,object.geometry);let views=pose.views;_objRenderEvt.object=object,_objRenderEvt.view=0,_objRenderEvt.eye=views[0].eye,RenderManager.fire(RenderManager.BEFORE_OBJECT_EYE_RENDER,_objRenderEvt),_objRenderEvt.object=null;let leftCamera=_viewCameras.get(views[0]),rightCamera=_viewCameras.get(views[1]),viewport=multiViewport;_renderer.resolution.set(2*viewport.width,viewport.height),USE_UBO&&(leftCamera._ubo?leftCamera._ubo.update():initCameraUBO(leftCamera)),object.leftModelViewMatrix||(object.leftModelViewMatrix=new Matrix4,object.rightModelViewMatrix=new Matrix4),object.leftModelViewMatrix.multiplyMatrices(leftCamera.matrixWorldInverse,object.matrixWorld),object.rightModelViewMatrix.multiplyMatrices(rightCamera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix),_gl.viewport(viewport.x,viewport.y,viewport.width,viewport.height),attachSceneUniforms(object,scene,leftCamera),Shader.renderer.appendUniform(object.shader,"leftProjectionMat",leftCamera.projectionMatrix,"mat4"),Shader.renderer.appendUniform(object.shader,"rightProjectionMat",rightCamera.projectionMatrix,"mat4"),Shader.renderer.appendUniform(object.shader,"leftModelViewMat",object.leftModelViewMatrix,"mat4"),Shader.renderer.appendUniform(object.shader,"rightModelViewMat",object.rightModelViewMatrix,"mat4"),object.geometry.draw(object,object.shader),USE_UBO&&leftCamera._ubo.unbind()}}else for(let l=0;l<2;l++)for(let i=0;i<scene.toRender[l].length;i++){let object=scene.toRender[l][i];if(object.onBeforeRender&&object.onBeforeRender(),object._drawing=!1,!object.determineVisible()||!object.shader.visible||object.shader.neverRender||object.neverRender)continue;let inFrustum=!1;for(let f=0;f<pose.views.length;f++)inFrustum||(inFrustum=_frustums[f].intersectsObject(object));if(!object.frustumCulled||inFrustum){object._drawing=!0,object.shader.draw(object,object.geometry);for(let j=0;j<pose.views.length;j++){let view=pose.views[j];_objRenderEvt.object=object,_objRenderEvt.view=j,_objRenderEvt.eye=view.eye,RenderManager.fire(RenderManager.BEFORE_OBJECT_EYE_RENDER,_objRenderEvt),_objRenderEvt.object=null;let viewCamera=_viewCameras.get(view),viewport=_session.baseLayer.getViewport(view);rt?_renderer.resolution.set(rt.width,rt.height):_renderer.resolution.set(2*viewport.width,viewport.height),USE_UBO&&(viewCamera._ubo?viewCamera._ubo.update():initCameraUBO(viewCamera)),object.modelViewMatrix.multiplyMatrices(viewCamera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix),rt?_gl.viewport(j*rt.width/2,0,rt.width/2,rt.height):_gl.viewport(viewport.x,viewport.y,viewport.width,viewport.height),attachSceneUniforms(object,scene,viewCamera),object.geometry.draw(object,object.shader),USE_UBO&&viewCamera._ubo.unbind()}}}Shader.renderer.resetState()}function rAFOverride(callback){_callback=callback}this.autoClear=!0,Shader.renderer.multiViewOverride=updateShaderMultiView,setup(),this.render=function(scene,camera){_frame&&_renderer.render(scene,camera)},this.setSize=function(width,height){_renderer.setSize(width,height)},this.reset=function(){setup()},this.getBaseLayer=function(){return _session.baseLayer}})),Class((function SocketConnection(_server,_channel){Inherit(this,Component);var _socket,_pingPong,_this=this,_fail=0,_binary={},_time=Render.TIME;const PING="ping",PONG="pong";function connect(){_this.pending=!1,(_socket=new WebSocket(_server,["permessage-deflate"])).binaryType="arraybuffer",_socket.onopen=open,_socket.onmessage=message,_socket.onclose=close,_socket.onerror=close}function sendPing(){_socket&&_socket.readyState==WebSocket.OPEN&&_socket.send(PING)}function checkIfConnected(){_this.blocked||_this.connected||(_this.blocked=!0,_this.events.fire(SocketConnection.BLOCKED))}function open(e){_fail=0,_this.connected=!0,_this.events.fire(SocketConnection.OPEN,{socket:_this},!0),_channel&&_this.send("register",{channel:_channel}),_pingPong=setInterval(sendPing,5e3)}function message(e){if(e.data!=PONG&&e.data!=PING)if("string"==typeof e.data)try{let data=JSON.parse(e.data),evt=data._evt;evt?(delete data._evt,_this.events.fire(evt,data,!0)):(_binary.data=data,_this.events.fire(SocketConnection.BINARY,_binary))}catch(er){}else _binary.data=e.data,_this.events.fire(SocketConnection.BINARY,_binary)}function close(e){if(Render.TIME-_time<50&&!_this.blocked)return _this.blocked=!0,_this.events.fire(SocketConnection.BLOCKED);_this.pending||_fail++>250||(_this.connected=!1,_this.pending=!0,_this.events.fire(SocketConnection.CLOSE,{socket:_this},!0),_this.timer=_this.delayedCall(connect,250),clearTimeout(_pingPong))}this.connected=!1,async function(){try{connect()}catch(e){await defer(),_this.events.fire(SocketConnection.ERROR,{socket:_this}),_this.timer=_this.delayedCall(connect,250),_this.delayedCall(checkIfConnected,2e4)}}(),this.send=function(evt,data={}){if(!_this.connected)return _this.delayedCall((_=>_this.send(evt,data)),100);data._evt=evt,_socket&&_socket.readyState==WebSocket.OPEN&&_socket.send(null!=data.length?data:JSON.stringify(data))},this.sendBinary=function(data){_socket&&_socket.readyState==WebSocket.OPEN&&_socket.bufferedAmount<1024&&_socket.send("binary:"+(null!=data.length?data:JSON.stringify(data)))},this.close=function(){_socket.onclose=null,_socket.onerror=null,clearTimeout(_this.timer),_socket.close()}}),(_=>{SocketConnection.OPEN="socket_connection_open",SocketConnection.CLOSE="socket_connection_close",SocketConnection.ERROR="socket_connection_error",SocketConnection.BINARY="socket_connection_binary",SocketConnection.BLOCKED="socket_connection_blocked"})),Class((function Container(){Inherit(this,Element);const _this=this,$this=this.element,USING_XR=Device.system.xr.vr;var _app=_this.initClass(App);!async function(){AppState.set("Global/playground",!1),function initHTML(){Stage.add($this),$this.css({position:"static"})}(),async function loadView(){let loader=_this.initClass(AssetLoader,Assets.list().filter(_app.loaderData.assets.split(",").map((f=>f.trim()))));_this.initClass(window[_app.loaderData.fragment],{loader:loader});loader.loadModules(),await Initializer3D.createWorld(),await CMSData.ready(),AppState.set("Global/loadComplete",!0),async function loadComplete(){USING_XR?(_app.xrLandingData&&Stage.add(_this.initClass(window[_app.xrLandingData])),async function waitForInteraction(){await World.instance().initXR(RenderManager.WEBVR);let ref=_this.initClass(window[_app.entryPointData]);ref.group&&World.SCENE.add(ref.group);let click=async e=>{e&&e.isLeaveEvent||(await XRDeviceManager.startSession(),Stage.unbind("touchend",click))};window.AURA?click():Stage.bind("touchend",click)}()):(await World.instance().init(),_this.initClass(window[_app.entryPointData]),$this.add(World.ELEMENT))}()}()}()}),"singleton"),Class((function Playground(){Inherit(this,Component);const _this=this;let _view,_isRT;const USING_XR=Device.system.xr.vr;async function initXR(){let app=App.toString();app.includes("_this.initClass(XRConfig")&&(app=app.split("_this.initClass(XRConfig,")[1].split(");")[0],_this.initClass(XRConfig,eval(app))),USING_XR?waitForInteraction():(await World.instance().init(),initView(),Stage.add(World.ELEMENT),initDoubleClick())}async function waitForInteraction(){World.instance().initXR(RenderManager.WEBVR).then(initView);let click=async e=>{e&&e.isLeaveEvent||(_this.events.unsub(Mouse.input,Interaction.END,click),await XRDeviceManager.startSession())};window.AURA?click():_this.events.sub(Mouse.input,Interaction.END,click)}function initDoubleClick(){_this.lastClick=performance.now();Stage.bind("click",(function(){performance.now()-_this.lastClick<180&&onDoubleClick(),_this.lastClick=performance.now()}))}function onDoubleClick(){let camera=_isRT?_view.nuke.camera:World.NUKE.camera,scene=_isRT?_view.scene:World.SCENE,raycaster=Raycaster.find(camera),objs=[];scene.traverse((obj=>{objs.push(obj)}));let intersects=raycaster.checkHit(objs,Mouse),found=!1;intersects.forEach((element=>{if(found)return;const uilGraph=element?.object?.uilGraph;uilGraph&&(found=!0,uilGraph?.find?.(element?.object?.uilName)?.focus?.())}))}async function addUIToWorldScene(uiGroup){USING_XR?await RenderManager.scheduleOne(RenderManager.EYE_RENDER):await defer();let group=new Group,v3=new Vector3,distance=USING_XR?1.5:2;return v3.set(0,0,-distance).applyQuaternion(World.CAMERA.quaternion),group.position.copy(World.CAMERA.position).add(v3),group.lookAt(World.CAMERA.position),group.add(uiGroup),World.SCENE.add(group),group}async function initGLUIView(element){if(USING_XR){(await addUIToWorldScene(element.group)).scale.setScalar(1/1024)}else GLUI.Stage.add(element)}async function initUI3DView(ui3d){USING_XR?(await addUIToWorldScene(ui3d.$gluiObject.group),ui3d.$gluiObject.depthTest=!1):Device.mobile?initGLUIView(ui3d.root):(GLUI.Scene.add(ui3d.$gluiObject),await addUIToWorldScene(ui3d.$gluiObject.anchor))}async function initView(){let request=Global.PLAYGROUND.split("/")[0],view=window["Playground"+request]||window[request]||null;if(!view)throw`No Playground class ${request} found.`;if(_view=view.instance?view.instance():_this.initClass(view),_view.element?_view.element.mesh?await initGLUIView(_view.element):Stage.add(_view.element):_view.root&&_view.$gluiObject&&await initUI3DView(_view),_view.rt&&_view.scene&&_view.nuke&&!_view.isVrWorldMode&&!_view.isVrSceneMode)if(request.includes("Figma")){let dimensions=_view.dimensions,$obj=$gl(dimensions[0],dimensions[1],_view.rt.texture);$obj.x=40,$obj.y=40,"portrait"===Utils.query("orientation")&&($obj.scale=.5,$obj.y=-300),GLUI.Stage.add($obj)}else{let shader=_this.initClass(Shader,"ScreenQuad",{tMap:{value:_view}}),mesh=new Mesh(World.QUAD,shader);mesh.frustumCulled=!1,World.SCENE.add(mesh),_isRT=!0}else World.SCENE.add(_view.group||_view.mesh||_view.object3D||new Group);initCameraHelper(_view.nuke||World.NUKE),Dev.expose("view",_view)}function initCameraHelper(nuke){let orbitCamera=new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3);orbitCamera.position.z=6;let lastCamera,timer0,timer1,timer2,wasdCamera=orbitCamera.clone();_this.onResize((_=>{orbitCamera.aspect=wasdCamera.aspect=Stage.width/Stage.height,orbitCamera.updateProjectionMatrix(),wasdCamera.updateProjectionMatrix()}));let orbit=new DebugControls(orbitCamera,World.ELEMENT.div),wasd=new WASDControls(wasdCamera,World.ELEMENT.div);orbit.enabled=!1,wasd.enabled=!1,_this.startRender((_=>{orbit.update(),wasd.update()})),_this.orbitControls=orbit,_this.wasdControls=wasd;const clearTimers=_=>{clearTimeout(timer0),clearTimeout(timer1),clearTimeout(timer2)},goToOrbit=_=>{orbit.enabled=!0,wasd.enabled=!1,nuke.camera!=wasdCamera&&nuke.camera!=orbitCamera&&(lastCamera=nuke.camera),nuke.camera=orbitCamera,AppState.set("playground_camera_active",nuke.camera),_this.activeControls=orbit,clearTimers()};Utils.query("orbit")&&(goToOrbit(),timer0=_this.delayedCall(goToOrbit,500),timer1=_this.delayedCall(goToOrbit,1e3),timer2=_this.delayedCall(goToOrbit,3e3)),_this.events.sub(Keyboard.DOWN,(_=>{document.activeElement.tagName.toLowerCase().includes(["textarea","input"])||(Keyboard.pressing.includes("!")&&(orbit.enabled=!1,wasd.enabled=!1,lastCamera&&(nuke.camera=lastCamera),AppState.set("playground_camera_active",!1),clearTimers()),Keyboard.pressing.includes("@")&&goToOrbit(),Keyboard.pressing.includes("#")&&(wasd.enabled=!0,orbit.enabled=!1,nuke.camera!=wasdCamera&&nuke.camera!=orbitCamera&&(lastCamera=nuke.camera),nuke.camera=wasdCamera,AppState.set("playground_camera_active",nuke.camera),_this.activeControls=wasd,clearTimers()))}))}!async function(){await UILStorage.ready(),Global.PLAYGROUND=Utils.query("p"),AppState.set("Global/playground",Global.PLAYGROUND),initXR()}()}),"singleton"),Class((function World(){Inherit(this,Component);const _this=this;var _renderer,_scene,_camera,_nuke,_controls;World.DPR=Tests.getDPR();var _type=RenderManager.NORMAL;async function init(){World.PLANE||(await async function initWorld(){World.PLANE=new PlaneGeometry(1,1),World.PLANEHI=new PlaneGeometry(1,1,100,50),World.QUAD=Utils3D.getQuad(),World.BOX=new BoxGeometry(1,1,1),World.BOXHI=new BoxGeometry(1,1,1,10,10,10),World.SPHERE=new SphereGeometry(1,16,16),World.TUBE=new CylinderGeometry(.1,.1,20,10,100);let options={powerPreference:"high-performance"};Tests.enableWorldNukeMSAA()&&(options.samplesAmount=Tests.msaaSamples()||void 0,options.multisample=!!options.samplesAmount);RenderManager.initialize(_type,options),_renderer=RenderManager.gl,_scene=RenderManager.scene,_camera=RenderManager.camera.worldCamera,_nuke=RenderManager.nuke,_renderer.shadows=!1,Nuke.recyclePingPong=!0,Tests.renderFXAA()&&_nuke.add(new FXAA);World.SCENE=_scene,World.RENDERER=_renderer,World.ELEMENT=$(_renderer.domElement),World.CAMERA=_camera,World.NUKE=_nuke}(),_renderer&&(RenderManager.type==RenderManager.NORMAL&&(Camera.instance(_camera),Render.capFPS=Tests.capFPS()),function initControls(){if(!window.DebugControls)return;const renderTypeNormal=RenderManager.type===RenderManager.NORMAL;if(!Utils.query("orbit")){let camera=new BaseCamera;return camera.group.position.set(0,0,6),void camera.lock()}const Controls=Utils.query("wasd")?WASDControls:DebugControls;_controls=new Controls(_camera,World.ELEMENT.div),renderTypeNormal?_controls.target=new Vector3(0,0,0):_controls.enabled=!1;World.CONTROLS=_controls,World.CAMERA.position.z=6}(),function addHandlers(){_this.events.sub(Events.RESIZE,resize)}(),Utils.query("uilOnly")||Render.onDrawFrame(loop)))}function resize(){_renderer.setSize(Stage.width,Stage.height),_camera.aspect=Stage.width/Stage.height,_camera.updateProjectionMatrix()}function loop(t,delta){_controls&&_controls.enabled&&_controls.update(),RenderManager.render()}this.initXR=async function(type,startImmersive=!0){_type=type,await init()},this.init=function(){return init()},this.ready=function(){return _this.wait((_=>!!World.NUKE))}}),(function(){var _instance;World.instance=function(){return _instance||(_instance=new World),_instance}})),Class((function About(_params,...restArgs){const _this=this;Inherit(_this,FragFXScene,"About"),Inherit(_this,XComponent),_this.fragName="About",_this.contexts='FragFXScene, "About"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this._initFXScene(World.NUKE,null,{format:void 0,type:void 0,minFilter:void 0,magFilter:void 0,multiRenderTarget:void 0,mipmaps:void 0,screenQuad:void 0,vrMode:void 0,multisample:void 0,samplesAmount:void 0}),_this.refractionLayer=_this.initClass(FXLayer,AppState.createLocal({name:"Refraction"},!0)),_this.refractionLayer.isFragment&&_promises.push(_this.wait(_this.refractionLayer,"__ready")),_this.refraction=_this.initClass(SnapshotFrame,AppState.createLocal({texture:_this.refractionLayer},!0)),_this.refraction.isFragment&&_promises.push(_this.wait(_this.refraction,"__ready")),(_this.nuke||World.NUKE).paused=!0,_this.ref_NukePass753=_this.initClass(NukePass,AppState.createLocal({shader:"AboutComposite"},!0)),_this.ref_NukePass753.isFragment&&_promises.push(_this.wait(_this.ref_NukePass753,"__ready")),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),scrollDelta=0,_this.layers.logo.shader.addUniforms({uScrollDelta:{value:0}});let rotation=0,delta=new Vector2,zero=new Vector2;_this.startRender((_=>{if(null==_this.scrollProgress)return;delta.lerp(Mouse.down?Mouse.delta:zero,.07),rotation+=delta.x*(Device.mobile?.0075:.0025)*.5,_this.layers.logo.position.y=Math.range(_this.scrollProgress,-1,1,6,-2),_this.layers.logo.rotation.y=-Math.radians(200)*(-.5+_this.scrollProgress)+Math.radians(60)+2*rotation;let dif=scrollDelta-_this.scrollProgress;scrollDelta=_this.scrollProgress,_this.layers.logo.shader.uniforms.uScrollDelta.value=Math.lerp(100*dif,_this.layers.logo.shader.uniforms.uScrollDelta.value,.1)}));const getText=text3d=>text3d.text.text.string;GLA11y.registerPage(_this.scene,"AboutPage"),GLA11y.textNode(_this.layers.text.group,getText(_this.layers.text)),GLA11y.textNode(_this.layers.copy.group,getText(_this.layers.copy));getText(_this.layers.copy);_this.layers.camera.lock(),_this.layers.logo.shader.set("tRefraction",_this.refraction),_this.onInit=async _=>{let video=await _this.get("ViewController/video");_this.layers.logo.shader.uniforms.tVideo=video.uniform},_this.layers.text.originTransform=Utils3D.cloneTransform(_this.layers.text),_this.layers.copy.originTransform=Utils3D.cloneTransform(_this.layers.copy),_this.onResize((function updateLayout(){Device.mobile&&Stage.height>Stage.width?(_this.layers.text.group.scale.set(.65,.65,1),_this.layers.text.group.position.set(-1.2,.6,-5),_this.layers.copy.group.scale.set(1.1,1.1,1),_this.layers.copy.group.position.set(-1.2,-1,-5),_this.layers.logo.scale.set(2.1,2.1,2.1)):(_this.layers.text.group.scale.copy(_this.layers.text.originTransform.scale),_this.layers.text.group.position.copy(_this.layers.text.originTransform.position),_this.layers.copy.group.position.copy(_this.layers.copy.originTransform.position))}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.nuke&&(_this.ref_NukePass753.texture=_this.nuke.rttBuffer),(_this.ref_NukePass753.upload||_this.ref_NukePass753.pass)&&((_this.nuke||World.NUKE).add(_this.ref_NukePass753.pass instanceof NukePass?_this.ref_NukePass753.pass:_this.ref_NukePass753),ShaderUIL.add(_this.ref_NukePass753.pass instanceof NukePass?_this.ref_NukePass753.pass:_this.ref_NukePass753)),(_this.nuke||World.NUKE).paused=!1,_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function AboutLogoShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="AboutLogoShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({tMap:{value:Utils3D.getTexture("assets/images/room/matcap-test.jpg"),getTexture:Utils3D.getRepeatTexture},tRefraction:{value:null,getTexture:Utils3D.getRepeatTexture},tVideo:{value:null,getTexture:Utils3D.getRepeatTexture},tNormal:{value:null,getTexture:Utils3D.getRepeatTexture},uVisible:{value:0},uAlpha:{value:1},uScrollDelta:{value:0},uNormalScale:{value:1},transparent:!0});for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function App(){const _this=this;Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="App",_this.contexts="Component",this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.ref_XRConfig842=_this.initClass(XRConfig,AppState.createLocal({multiview:"false"},!0)),_this.ref_XRConfig842.isFragment&&_promises.push(_this.wait(_this.ref_XRConfig842,"__ready")),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.loaderData={fragment:"LoaderView",assets:"shaders, uil"},_this.entryPointData="ViewController",_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function ChainInstancer(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,Object3D),Inherit(_this,XComponent),_this.fragName="ChainInstancer",_this.contexts="Component,Object3D",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}if(_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),Tests.hideChain())return void(_this.mesh.visible=!1);let meshes=[],batch=_this.createFragment(MeshBatch);for(let i=0;i<80;i++){let mesh=_this.mesh.clone();mesh.position.y=-.22*i,mesh.rotation.y=Math.radians(90)*i,mesh.scale.setScalar(2.6),mesh.scale.y*=.8,batch.add(mesh),meshes.push(mesh)}_this.mesh.visible=!1;let root=_this.findParent("Work");_this.startRender((_=>{root&&null!=root.scrollProgress&&(_this.group.position.copy(_this.mesh.position),meshes.forEach(((mesh,i)=>{mesh.shader.uniforms.uScroll.value=root.scrollProgress,mesh.rotation.y=Math.radians(90)*i-root.scrollProgress*Math.radians(360)*4})))}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function ChainShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="ChainShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({tRefraction:{value:null},uScroll:{value:0},uReflection:{value:new Vector2(1,1)}}),_this.onInit=async _=>{let refraction=await _this.get("Work/refraction");_this.shader.set("tRefraction",refraction)};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function ChatDOM(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="ChatDOM",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){function replaceRandomLetters(str,numReplacements){if(str.length<2)return str;let result=str.split("");for(let i=0;i<numReplacements;i++){const randomPos=Math.floor(Math.random()*str.length),randomChar="0123456789".charAt(Math.floor(10*Math.random()));result[randomPos].includes([" ","/","?",",",".","\n"])||(result[randomPos]=randomChar)}return result.join("")}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{addTo:"Stage",_type:"UI",refName:"unnamed",children:[{_type:"div",refName:"wrapper",children:[{_type:"div",refName:"messages",children:[]},{maxLength:100,rows:1,placeholder:"Ask me anything...",_type:"textarea",refName:"input",children:[]},{_type:"div",refName:"flashing",children:[]}]}]}),_this.assistant=_this.initClass(InteractAI.Assistant),_this.assistant.isFragment&&_promises.push(_this.wait(_this.assistant,"__ready")),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.wrapper.css({opacity:0}),_this.wrapper.hide(),_this.flashing.css({opacity:0}),_this.wrapper.progress=0,_this.set("isFocused",!1),_this.set("lastClick",0),_this.input.bind("focus",(_=>_this.set("isFocused",!0))),_this.input.bind("blur",(_=>_this.set("isFocused",!1))),_this.input.bind("input",(_=>{let text=_this.input.val();_this.input.classList().toggle("extended",!!text)})),_this.input.bind("keydown",(async e=>{if(_this.input.val(_this.input.val().replace(/\n/g," ")),13===e.which&&!e.shiftKey){if(e.preventDefault(),!e.repeat){if(_this.get("InteractAIAssistant/isThinking"))return;let formText=_this.input.val();if(_this.input.val(""),_this.input.classList().toggle("extended",!1),formText){let blinker=await _this.addMessage(formText,"#00ffff");blinker.classList.add("blink"),e.preventDefault(),_this.input.progress=1,_this.flashing.progress=0,tween(_this.input,{progress:0},400,"easeOutSine").onUpdate((_=>{_this.input.css({opacity:_this.input.progress})})).onComplete((_=>_this.input.div.disabled=!0)),tween(_this.flashing,{progress:1},600,"easeOutSine",800).onUpdate((_=>{_this.flashing.css({opacity:_this.flashing.progress})}));let response=await _this.assistant.once(formText);response.length>400&&(response=response.substring(0,400)+"..."),_this.addMessage(response,"#ffffff",!0),blinker.classList.remove("blink"),_this.input.div.disabled=!1,_this.input.progress=0,tween(_this.input,{progress:1},400,"easeInSine").onUpdate((_=>{_this.input.css({opacity:_this.input.progress}),_this.flashing.css({opacity:1-_this.input.progress})}))}}e.preventDefault()}})),_this.onInit=function(){_this.addMessage("What are you looking for?","#f4f4f4",!0),_this.addFilter("-> websites","Website",!0,100),_this.addFilter("-> installations","Installation",!0,200),_this.addFilter("-> XR / AI","XR",!0,300),_this.addFilter("-> multiplayer","Multiplayer",!0,400),_this.addFilter("-> games","Game",!0,500)},_this.addMessage=async(str,color,animated=!1,delay=0)=>{let elem=document.createElement("p"),text=document.createTextNode(str);if(elem.appendChild(text),color&&(elem.style.color=color),_this.messages.div.prepend(elem),animated){text.textContent="",await _this.wait(delay),text.progress=.95;let duration=Math.clamp(2*str.length+50,500,1500),setNodeText=_=>{let substr=str.slice(0,str.length*(1-text.progress));text.textContent=substr.slice(0,substr.length*text.progress*text.progress)+replaceRandomLetters(substr.slice(substr.length*text.progress*text.progress),substr.length*text.progress*.5)};_this.startRender(setNodeText,15),tween(text,{progress:0},duration,"linear").onComplete((_=>{_this.stopRender(setNodeText),text.textContent=str}))}return elem},_this.addLink=async(title,href,animated=!1,delay=0)=>{let link=document.createElement("a");if(link.text=title,link.setAttribute("title",title),link.setAttribute("href",href),link.setAttribute("target","_blank"),_this.messages.div.prepend(link),animated){link.textContent="",await _this.wait(delay),link.progress=.95;let setNodeText=_=>{let substr=title.slice(0,title.length*(1-link.progress));link.textContent=substr.slice(0,substr.length*link.progress*link.progress)+replaceRandomLetters(substr.slice(substr.length*link.progress*link.progress),substr.length*link.progress*.5)};_this.startRender(setNodeText,15),tween(link,{progress:0},600,"linear").onComplete((_=>{_this.stopRender(setNodeText),link.textContent=title}))}return link},_this.addFilter=async(title,tag,animated=!1,delay=0)=>{let link=document.createElement("a");if(link.text=title,link.setAttribute("title",title),tag&&link.classList.add("home"),link.onclick=async _=>{_this.get("disableFiltering",!0)||(_this.set("disableFiltering",!0),_this.delayedCall((()=>{_this.set("disableFiltering",!1)}),1e3),_this.fire("clickFilter"),tag&&defer((_=>link.classList.add("active"))),_this.active=link.text,_this.set("Work/project",null),_this.set("lastClick",Date.now()),tag&&(await defer(),CMSData.filter(tag.toLowerCase())))},_this.messages.div.prepend(link),_this.listen("clickFilter",(_=>link.classList.remove("active"))),animated){link.textContent="",await _this.wait(delay),link.progress=.95;let setNodeText=_=>{let substr=title.slice(0,title.length*(1-link.progress));link.textContent=substr.slice(0,substr.length*link.progress*link.progress)+replaceRandomLetters(substr.slice(substr.length*link.progress*link.progress),substr.length*link.progress*.5)};_this.startRender(setNodeText,15),tween(link,{progress:0},600,"linear").onComplete((_=>{_this.stopRender(setNodeText),link.textContent=title}))}return defer((_=>{_this.active&&title==_this.active&&tag&&link.classList.add("active")})),link},_this.bind("updateText",(({text:text,color:color="#ffffff",animated:animated=!1,delay:delay=0})=>_this.addMessage(text,color,animated,delay))),_this.bind("updateLink",(({title:title,href:href,animated:animated=!1,delay:delay=0})=>_this.addLink(title,href,animated,delay))),_this.bind("updateFilter",(({title:title,tag:tag,animated:animated=!1,delay:delay=0})=>_this.addFilter(title,tag,animated,delay))),_this.listen("clearText",(_=>_this.clearChat())),_this.listen("resetOptions",(_=>_this.onInit())),_this.listen("Global/loadFinished",(_=>{_this.wrapper.tween({opacity:1},2e3,"easeInOutSine",3300);let showingContact=!1,routeIsNotWork=!0;const checkVisibility=_=>{showingContact||routeIsNotWork?_this.hideChat():_this.showChat()};_this.bind("ViewController/contact",(active=>{showingContact=!!active,checkVisibility()})),_this.bind("Work/scrollProgress",(val=>{let prev=routeIsNotWork;routeIsNotWork=!(val>.05&&val<.95),prev!=routeIsNotWork&&checkVisibility()}))})),_this.hideChat=async _=>{if(_this.hidden)return;_this.wrapper.tween({opacity:0},300,"easeInSine");let uniforms=await _this.get("ViewController/uniforms");tween(_this.wrapper,{progress:0},300,"easeInSine").onUpdate((_=>{uniforms.uChatOpen.value=_this.wrapper.progress})).onComplete((_=>_this.wrapper.hide()))},_this.showChat=async _=>{_this.wrapper.show(),_this.wrapper.css({opacity:0}).tween({opacity:1},1e3,"easeOutSine");let uniforms=await _this.get("ViewController/uniforms");tween(_this.wrapper,{progress:1},1e3,"easeOutSine").onUpdate((_=>{uniforms.uChatOpen.value=_this.wrapper.progress}))},_this.clearChat=_=>{for(;_this.messages.div.firstChild;)_this.messages.div.removeChild(_this.messages.div.firstChild)},_this.element.goob('\n    .wrapper {\n        display: flex;\n        flex-direction: column;\n        justify-content: flex-end;\n        padding: 3rem 3rem;\n        mix-blend-mode: color-dodge;\n\n        @media (max-width: 768px) {\n            padding: 2rem 2rem;\n            mix-blend-mode: normal;\n        }\n\n        pointer-events: none;\n        \n        position: fixed;\n        bottom: 0;\n        left: 0;\n        z-index: 3;\n\n        width: min(450px, 100%);\n        height: calc(100% - 100px);\n        background-color: transparent;\n    }\n\n    .messages {\n        display: flex;\n        flex-direction: column-reverse;\n        justify-content: flex-start;\n        overflow: hidden;\n\n        margin-bottom: 1rem;\n        height: 100%;\n        -webkit-mask-image: linear-gradient(to top, white 0%, white 75%, transparent 90%);\n\n        p, a {\n            font-family: "nbarchitekt", monospace;\n            font-size: 14px;\n            font-weight: 400;\n            line-height: 1.5;\n            margin: 6px 0;\n            margin-left: 10px;\n            white-space: pre-wrap;\n\n            @media (max-width: 768px) {\n                font-size: 13px;\n                margin: 4px 0;\n            }\n\n            @keyframes cursor-blink {\n                0% { background: transparent; }\n                25% { background: transparent; }\n                50% { background: #00ffff; }\n                75% { background: #00ffff; }\n                100% { background: transparent; }\n            }\n\n            &.blink::after {\n                content: "";\n                position: absolute;\n                width: 8px;\n                height: 12px;\n                margin-top: 4px;\n                margin-left: 10px;\n    \n                border: none;\n                background-color: #00ffff;\n                display: inline-block;\n                animation: cursor-blink 1.5s infinite;\n            }\n        }\n\n    }\n\n\n    a {\n        color: #c6c6c6;\n        pointer-events: auto;\n        cursor: pointer;\n\n        font-weight: 700;\n        width: fit-content;\n        transition: all 0.4s cubic-bezier(.17,.4,.02,.99);\n        transform: translateX(0px);\n\n        @media (max-width: 768px) {\n            color: #eeeeee;\n            &.home {\n                color: #9ca5ff;\n            }\n        }\n        \n\n        &.active {\n            color: #ffffff;\n            text-shadow: #ffffff 1px 0px 5px;\n            transform: translateX(10px);\n        }\n\n        @media (hover: hover) {\n            &:hover {\n                color: #ffffff;\n                font-weight: 400;\n            }\n        }\n    }\n\n    textarea {\n        background: rgba(0,0,0,0.2);\n        color: rgba(255,255,255,0.7);\n        font-family: "nbarchitekt", monospace;\n        font-weight: 400;\n        font-size: 14px;\n        outline: none;\n\n        border: 2px solid rgba(255,255,255,0.3);\n        border-radius: 50px;\n        padding: 14px 25px 4px;\n\n        transition: all 0.8s cubic-bezier(.17,.4,.02,.99);\n        width: 200px;\n        white-space: nowrap;\n        min-height: 40px;\n        resize: none;\n        pointer-events: auto;\n        overflow: hidden;\n\n        @media (max-width: 768px) {\n            font-size: 13px;\n        }\n\n        &:hover {\n            border: 2px solid rgba(255,255,255,0.5);\n        }\n\n        &:focus {\n            color: #eeeeee;\n            background: rgba(0,0,0,0.5);\n            border: 2px solid rgba(255,255,255,0.8);\n        }\n\n        &.extended {\n            background: rgba(0,0,0,0.5);\n            border: 2px solid rgba(255,255,255,0.9);\n            width: 330px;\n        }\n\n        &::placeholder, * {\n            color: rgba(255,255,255,0.4);\n        }\n    }\n\n    .flashing {\n        position: relative;\n        left: 37px;\n        bottom: 32px;\n\n        width: 12px;\n        height: 12px;\n        border-radius: 6px;\n        background-color: #00ffff;\n        color: #00ffff;\n        opacity: 0.3;\n        animation: dot-flashing 1.5s infinite linear alternate;\n        animation-delay: 0.75s;\n\n        &::before, &::after {\n            content: "";\n            display: inline-block;\n            position: absolute;\n            top: 0;\n            width: 12px;\n            height: 12px;\n            border-radius: 6px;\n            color: #00ffff;\n            opacity: 1;\n            background-color: #00ffff;\n            animation: dot-flashing 1.5s infinite alternate;\n        }\n\n        &::before {\n            left: -25px;\n            animation-delay: 0s;\n        }\n\n        &::after {\n            left: 25px;\n            animation-delay: 1.5s;\n        }\n    }\n\n    @keyframes dot-flashing {\n        0% { background-color: #00ffff; box-shadow: 0 1px 6px #00ffff; }\n        50%, 100% { background-color: rgba(200,255,255,0.2); }\n    }\n');for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function ChatUI(_params,...restArgs){const _this=this;Inherit(_this,GLUIElement),Inherit(_this,XComponent),_this.fragName="ChatUI",_this.contexts="GLUIElement",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"ui",children:[{_type:"ChatUIInput",refName:"input",children:[]},{_type:"ChatUIResponse",refName:"response",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.bind("ViewController/contact",(active=>{active?_this.ui.tween({alpha:0},500,"easeOutSine"):_this.ui.tween({alpha:1},500,"easeOutSine")})),_this.onResize((function updateLayout(){let y=Stage.height-300;_this.input.element.x=0,_this.input.element.y=y,_this.response.element.x=80,_this.response.element.y=y+140}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function ChatUIInput(_params,...restArgs){const _this=this;Inherit(_this,GLUIElement),Inherit(_this,XComponent),_this.fragName="ChatUIInput",_this.contexts="GLUIElement",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"wrapper",children:[{font:"NBArchitektStd-Regular",fontSize:12,fontColor:"#ffffff",_type:"glText",_innerText:"_",refName:"text",children:[]},{font:"NBArchitektStd-Regular",fontSize:12,fontColor:"#ffffff",_type:"glText",_innerText:"_",refName:"suggestion",children:[]},{width:400,height:400,bg:"#000000",_type:"glObject",refName:"bg",children:[]},{bg:"#00ffff",width:8,height:12,_type:"glObj",refName:"cursor",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());let bgShader=new Shader("ChatBGShader",{uColor:{value:new Color("#111111")},uBottom:{value:1},uScroll:{value:0},uHeight:{value:.12},uDisabled:{value:0},uActive:{value:0},uScrollDelta:{value:0}});_this.bg.useShader(bgShader);let color1=new Color("#00ffff"),color2=new Color("#ffffff"),text="";_this.bind("ChatUIInput/reset",(async _=>{_this.bg.disabled=!1,bgShader.tween("uDisabled",0,800,"easeInOutSine"),text="",_this.text.setText(text+"_"),_this.text.setColor(color2)})),_this.bind("ChatUIResponse/submit",(async t=>{_this.text.setText(t),_this.text.setColor(color1),bgShader.tween("uDisabled",1,500,"easeOutSine"),_this.bg.disabled=!0})),_this.events.sub(Keyboard.DOWN,(async e=>{if(!_this.bg.disabled){if(e&&e.key&&!e.metaKey&&!e.shiftKey&&!e.ctrlKey&&!e.altKey&&"Tab"!==e.key)switch(e.key){case"Enter":text.length>0?_this.set("ChatUIResponse/submit",text.toLowerCase()):_this.set("ChatUIResponse/submit","PROMETHEUS".toLowerCase());break;case"Backspace":text=text.slice(0,-1),_this.text.setText(text+"_");break;case"Delete":case"Escape":text="",_this.text.setText(text+"_");break;case"Shift":case"Dead":case"Alt":case"Control":case"ArrowRight":case"ArrowLeft":case"ArrowUp":case"ArrowDown":break;default:let letters="0123456789abcdefghijklmnopqrstuvwxyz ".split("");text.length<32&&e.key.toLowerCase().includes(letters)&&(text+=e.key),_this.text.setText(text+"_")}_this.text.alpha=1,loop()}}));let scroll=Scroll.createUnlimited(),scrolled=0;function loop(){scrolled+=.002*scroll.delta.y,bgShader.uniforms.uScroll.value=Math.lerp(scrolled,bgShader.uniforms.uScroll.value,.1);let delta=.3*-Math.clamp(scroll.delta.y,-20,20);bgShader.uniforms.uScrollDelta.value=Math.lerp(delta,bgShader.uniforms.uScrollDelta.value,.1);let active=""!==text?1:0;bgShader.uniforms.uActive.value=Math.lerp(active,bgShader.uniforms.uActive.value,.1),_this.text.x=.22*_this.bg.width,_this.text.y=_this.bg.height/2-7+5*bgShader.uniforms.uScrollDelta.value,_this.suggestion.x=_this.text.x,_this.suggestion.y=_this.text.y,_this.cursor.x=_this.text.x-20,_this.cursor.y=_this.text.y,_this.suggestion.alpha=text.length>0?0:.2,_this.set("ChatUIInput/y",5*bgShader.uniforms.uScrollDelta.value)}_this.startRender(loop),_this.startRender((_=>{_this.suggestion.setText("PROMETHEUS"),_this.cursor.visible=!_this.cursor.visible,_this.cursor.alpha=_this.cursor.visible?1:0,_this.bg.disabled||(_this.cursor.alpha=0),_this.text.alpha=_this.cursor.visible?1:0,(""!==text||_this.bg.disabled)&&(_this.text.alpha=1)}),3);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function ChatUIResponse(_params,...restArgs){const _this=this;Inherit(_this,GLUIElement),Inherit(_this,XComponent),_this.fragName="ChatUIResponse",_this.contexts="GLUIElement",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"wrapper",children:[{font:"NBArchitektStd-Regular",align:"center",fontSize:10.5,lineHeight:1.5,fontColor:"#ffffff",width:350,_type:"glText",_innerText:"Response",refName:"response",children:[]}]}),_this.assistant=_this.initClass(InteractAI.Assistant),_this.assistant.isFragment&&_promises.push(_this.wait(_this.assistant,"__ready")),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());let options={lineHeight:2},base="What are you looking for?\nIm trained on 112 projects",response=base;_this.response.type=1,_this.bind("ChatUIResponse/submit",(async text=>{switch(text){case null:response=base;break;case"contact":response=base,_this.set("ViewController/contact",!0);break;default:_this.response.erasing=!0,_this.response.tween({alpha:0},3e3,"easeOutCubic"),response=await _this.assistant.once(text),response.length>400&&(response=response.substring(0,400)+"...")}_this.set("ChatUIInput/reset",response),_this.set("ChatUIResponse/update",response)})),_this.bind("ChatUIResponse/update",(async text=>{_this.response.erasing=!0,await _this.response.tween({alpha:0},400,"easeInSine").promise(),response=text||base,_this.response.erasing=!1,_this.response.tween({alpha:1},1500,"easeOutCubic")})),_this.startRender((_=>{let trim=response.substring(0,400*_this.response.alpha);trim=function replaceRandomLetters(str,numReplacements){if(str.length<2)return str;let result=str.split("");const replacementChars="0123456789";for(let i=0;i<numReplacements;i++){const randomPos=Math.floor(Math.random()*str.length),randomChar=replacementChars.charAt(Math.floor(Math.random()*replacementChars.length));result[randomPos].includes([" ","/","?",",",".","\n"])||(result[randomPos]=randomChar)}return result.join("")}(trim,response.length*Math.smoothStep(.8,0,_this.response.alpha)),trim.length<response.length&&(trim+="_"),_this.response.setText(trim,options)}),20),_this.startRender((_=>{let y=_this.get("ChatUIInput/y");_this.response.height=_this.response.dimensions.height,_this.response.x=0,_this.response.y=-_this.response.height+y}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function CleanRoom(_params,...restArgs){const _this=this;Inherit(_this,FragFXScene,"CleanRoom"),Inherit(_this,XComponent),_this.fragName="CleanRoom",_this.contexts='FragFXScene, "CleanRoom"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this._initFXScene(World.NUKE,null,{format:void 0,type:void 0,minFilter:void 0,magFilter:void 0,multiRenderTarget:void 0,mipmaps:void 0,screenQuad:void 0,vrMode:void 0,multisample:void 0,samplesAmount:void 0}),(_this.nuke||World.NUKE).paused=!0,_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.uniforms={uRGBStrength:{value:1},uVolumetricStrength:{value:1},uContrast:{value:new Vector2(1,1)}},_this.layout.group.scale.setScalar(2),_this.layers.camera.lock();GLA11y.registerPage(_this.scene,"CleanRoomPage"),GLA11y.textNode(_this.layers.text.group,_this.layers.text.text.text.string);let url="https://lab.activetheory.net/";async function updateLayout(){Device.mobile&&Stage.height>Stage.width?(_this.layers.text.group.position.x=.2,_this.layers.text.group.position.y=.9,_this.layers.text2.group.position.x=-.3,_this.layers.text2.group.position.y=.4-.5,_this.layers.camera.position.z=7):(_this.layers.camera.position.z=5,_this.layers.text.group.position.copy(_this.layers.text.group.oPos),_this.layers.text2.group.position.copy(_this.layers.text2.group.oPos))}_this.layers.hit.shader.set("uAlpha",0),_this.layers.text.text.alpha=.7,_this.layers.text2.text.alpha=.7,_this.layers.atlogo.shader.set("uAlpha",_this.layers.hit.visible?.4:.7),Interaction3D.find(_this.layers.camera).add(_this.layers.hit,(function onHover(e){switch(e.action){case"over":_this.layers.text.text.tween({alpha:1},500,"easeOutCubic"),_this.layers.text2.text.tween({alpha:1},500,"easeOutCubic"),_this.layers.atlogo.shader.tween("uAlpha",1,500,"easeOutCubic"),tween(_this.layers.camera.group.position,{z:-.15},500,"easeOutCubic");break;case"out":_this.layers.text.text.tween({alpha:.7},800,"easeOutCubic"),_this.layers.text2.text.tween({alpha:.7},800,"easeOutCubic"),_this.layers.atlogo.shader.tween("uAlpha",.4,800,"easeOutCubic"),tween(_this.layers.camera.group.position,{z:0},800,"easeOutCubic")}}),(function onClick(e){open(url)}),{url:url}),_this.layers.text.group.oPos=(new Vector3).copy(_this.layers.text.group.position),_this.layers.text2.group.oPos=(new Vector3).copy(_this.layers.text2.group.position),updateLayout(),_this.onResize(updateLayout),_this.startRender((_=>{if(null==_this.scrollProgress)return;let base=Device.mobile&&Stage.height>Stage.width?.85:.8;_this.layers.room.rotation.y=Math.radians(-15)*(-base+_this.scrollProgress)})),_this.onInit=async _=>{_this.volumetricLight.addLight(_this.layers.white)};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.composite=_this.initClass(NukePass,AppState.createLocal({shader:"CleanRoomComposite",uniforms:_this.uniforms},!0)),_this.composite.isFragment&&_promises.push(_this.wait(_this.composite,"__ready")),_this.nuke&&(_this.composite.texture=_this.nuke.rttBuffer),_this.volumetricLight=_this.initClass(FX.VolumetricLight,AppState.createLocal({unique:"cleanroom",nuke:_this.nuke,dpr:.4,enabled:Tests.volumetricLight()},!0)),_this.volumetricLight.isFragment&&_promises.push(_this.wait(_this.volumetricLight,"__ready")),_this.volumetricLight.uniforms&&_this.composite.addUniforms(_this.volumetricLight.uniforms),(_this.composite.upload||_this.composite.pass)&&((_this.nuke||World.NUKE).add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite),ShaderUIL.add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite)),(_this.nuke||World.NUKE).paused=!1,_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function CleanRoomGlass(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="CleanRoomGlass",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.shader.addUniforms({tRefraction:{value:null},tEnv:{value:null},uDistortStrength:{value:1},uFresnelPow:{value:1},uRefractionRatio:{value:1}}),await _this.waitLayers();let inner=_this.createFragment(FXScene,_this.findParent("CleanRoom").nuke);inner.add(_this.layers.glass).shader=_this.createFragment(Shader,"GlassInner",{side:Shader.BACK_SIDE}),_this.shader.set("tInner",inner);let rt=await _this.get("CleanRoom/refraction");_this.shader.set("tRefraction",rt);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function CleanRoomRefractionScene(_params,...restArgs){const _this=this;Inherit(_this,FragFXScene,"CleanRoomRefractionScene"),Inherit(_this,XComponent),_this.fragName="CleanRoomRefractionScene",_this.contexts='FragFXScene, "CleanRoomRefractionScene"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this._initFXScene(World.NUKE,null,{format:void 0,type:void 0,minFilter:void 0,magFilter:void 0,multiRenderTarget:void 0,mipmaps:void 0,screenQuad:void 0,vrMode:void 0,multisample:void 0,samplesAmount:void 0}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function Contact(_params,...restArgs){const _this=this;Inherit(_this,FragFXScene,"Contact"),Inherit(_this,XComponent),_this.fragName="Contact",_this.contexts='FragFXScene, "Contact"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),(_this.nuke||World.NUKE).paused=!0,_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.uniforms={uRGBStrength:{value:1},uVolumetricStrength:{value:1},uContrast:{value:new Vector2(1,1)}};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.composite=_this.initClass(NukePass,AppState.createLocal({shader:"HomeComposite",uniforms:_this.uniforms},!0)),_this.composite.isFragment&&_promises.push(_this.wait(_this.composite,"__ready")),_this.nuke&&(_this.composite.texture=_this.nuke.rttBuffer),(_this.composite.upload||_this.composite.pass)&&((_this.nuke||World.NUKE).add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite),ShaderUIL.add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite)),(_this.nuke||World.NUKE).paused=!1,_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function ContactUI(_params,...restArgs){const _this=this;Inherit(_this,GLUIElement),Inherit(_this,Initialization),Inherit(_this,XComponent),_this.fragName="ContactUI",_this.contexts="GLUIElement,Initialization",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){function hover(e){switch(e.action){case"over":e.object.tween({alpha:.6},300,"easeOutQuart"),e.object.line&&e.object.line.tween({scaleX:0,alpha:.6},300,"easeOutQuart");break;case"out":e.object.tween({alpha:1},500,"easeOutQuart"),e.object.line&&e.object.line.tween({scaleX:1,alpha:1},500,"easeOutQuart")}}async function updateLayout(){if(Device.mobile&&Stage.height>Stage.width){let scaleX=Math.range(Stage.width,0,350,.4,.8,!0),scaleY=Math.range(Stage.height,0,650,0,.95,!0);_this.ui.scale=Math.min(scaleX,scaleY),_this.ui.x=Math.range(_this.ui.scale,0,1,Stage.width/2,0),_this.ui.y=Math.range(_this.ui.scale,0,1,.65*Stage.height,0),_this.globe.x=.5*Stage.width-_this.globe.width/2,_this.globe.y=.45*Stage.height-_this.globe.height/2,_this.globe.scale=.6,_this.globe.alpha=1,_this.arrow1.x=.5*Stage.width,_this.arrow1.y=.25*Stage.height,_this.arrow1.rotation=-90,_this.arrow1.scale=.5,_this.arrow2.x=_this.arrow1.x,_this.arrow2.y=.45*Stage.height,_this.arrow2.rotation=_this.arrow1.rotation,_this.arrow2.scale=_this.arrow1.scale,_this.star1.x=.5*Stage.width-Math.max(.1*Stage.width,85)-_this.star1.width/2,_this.star1.y=.45*Stage.height-_this.star1.height/2-274,_this.star2.x=.5*Stage.width+Math.max(.1*Stage.width,85)-_this.star2.width/2,_this.star2.y=.45*Stage.height-_this.star2.height/2-274,_this.contact.x=.5*Stage.width,_this.contact.y=.45*Stage.height-280,_this.nyc.x=.5*Stage.width+5,_this.nyc.y=.4*Stage.height-58,_this.lax.x=.5*Stage.width+5,_this.lax.y=.23*Stage.height-58,_this.ams.x=.5*Stage.width+5,_this.ams.y=.57*Stage.height-58,await _this.wait((_=>_this.email.dimensions.width)),await _this.wait((_=>_this.subscribe.dimensions.width)),await _this.wait((_=>_this.privacy.dimensions.width)),_this.email.x=.5*Stage.width+2,_this.email.y=.55*Stage.height+120,_this.subscribe.x=.5*Stage.width-.5*_this.subscribe.dimensions.width+2,_this.subscribe.y=_this.email.y+50,_this.privacy.x=.5*Stage.width-.5*_this.privacy.dimensions.width+2,_this.privacy.y=_this.subscribe.y+30,_this.line1.width=_this.email.dimensions.width+5,_this.line2.width=_this.subscribe.dimensions.width,_this.line3.width=_this.privacy.dimensions.width,_this.line1.x=.5*Stage.width-.5*_this.line1.width,_this.line1.y=_this.email.y+24,_this.line2.x=.5*Stage.width-.5*_this.line2.width,_this.line2.y=_this.subscribe.y+17,_this.line3.x=.5*Stage.width-.5*_this.line3.width,_this.line3.y=_this.privacy.y+17,_this.in.x=.5*Stage.width-.5*_this.in.width,_this.in.y=_this.line3.y+50,_this.tw.x=.5*Stage.width-.5*_this.tw.width+50,_this.tw.y=_this.line3.y+50,_this.ig.x=.5*Stage.width-.5*_this.ig.width-50,_this.ig.y=_this.line3.y+50}else{let width=1400,height=500,scaleX=Math.range(Stage.width,0,width,0,1),scaleY=Math.range(Stage.height,0,height,0,1);_this.ui.scale=Math.min(scaleX,scaleY),_this.ui.scale=Math.min(1.15,_this.ui.scale),_this.ui.x=Stage.width/2-.5*_this.ui.scale*width,_this.ui.y=Stage.height/2-.5*_this.ui.scale*height,_this.globe.x=.5*width-_this.globe.width/2,_this.globe.y=.5*height-_this.globe.height/2,_this.globe.scale=1.06,_this.globe.alpha=.6,_this.arrow1.x=.325*width-_this.arrow1.width/2,_this.arrow1.y=.5*height-_this.arrow1.height/2,_this.arrow2.x=.675*width-_this.arrow2.width/2,_this.arrow2.y=.5*height-_this.arrow2.height/2,_this.star1.x=.44*width-_this.star1.width/2,_this.star1.y=.5*height-_this.star1.height/2-203,_this.star2.x=.56*width-_this.star2.width/2,_this.star2.y=.5*height-_this.star2.height/2-203,_this.contact.x=.5*width,_this.contact.y=height/2-210,_this.lax.x=.15*width+5,_this.lax.y=height/2-58,_this.nyc.x=.5*width+5,_this.nyc.y=height/2-58,_this.ams.x=.85*width+5,_this.ams.y=height/2-58,await _this.wait((_=>_this.ams.dimensions.width)),await _this.wait((_=>_this.lax.dimensions.width)),await _this.wait((_=>_this.email.dimensions.width)),await _this.wait((_=>_this.subscribe.dimensions.width)),await _this.wait((_=>_this.privacy.dimensions.width)),_this.email.x=width/2,_this.email.y=height/2+200,_this.privacy.x=_this.lax.x-.5*_this.lax.dimensions.width,_this.privacy.y=height/2+200,_this.subscribe.x=_this.privacy.x,_this.subscribe.y=_this.privacy.y+30,_this.line1.width=_this.email.dimensions.width+2,_this.line1.x=_this.email.x-.5*_this.line1.width-1,_this.line1.y=_this.email.y+20,_this.line2.width=_this.privacy.dimensions.width,_this.line2.x=_this.privacy.x,_this.line2.y=_this.privacy.y+15,_this.line3.width=_this.subscribe.dimensions.width,_this.line3.x=_this.subscribe.x,_this.line3.y=_this.subscribe.y+15,_this.ig.x=_this.ams.x-20,_this.ig.y=_this.privacy.y-7,_this.in.x=_this.ig.x+50,_this.in.y=_this.ig.y+1,_this.tw.x=_this.in.x+50,_this.tw.y=_this.ig.y+1}}function replaceRandomLetters(str,numReplacements){let result=str.split("");for(let i=0;i<numReplacements;i++){const randomPos=Math.floor(Math.random()*str.length),randomChar="01234567890".charAt(Math.floor(11*Math.random()));result[randomPos].includes([" ","/","?",",","."])||(result[randomPos]=randomChar)}return result.join("")}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{addTo:"GLUI.Stage",_type:"UI",refName:"ui",children:[{width:1e3,height:700,bg:"assets/images/ui/globe.png",_type:"glObject",refName:"globe",children:[]},{width:80,height:80,bg:"assets/images/ui/arrow.png",_type:"glObject",refName:"arrow1",children:[]},{width:80,height:80,bg:"assets/images/ui/arrow.png",_type:"glObject",refName:"arrow2",children:[]},{width:16,height:16,bg:"assets/images/ui/star.png",_type:"glObject",refName:"star1",children:[]},{width:16,height:16,bg:"assets/images/ui/star.png",_type:"glObject",refName:"star2",children:[]},{font:"NBArchitektStd-Light",fontSize:14,align:"center",letterSpacing:.1,fontColor:"#ffffff",_type:"glText",_innerText:"CONTACT US",refName:"contact",children:[]},{font:"NBArchitektStd-Light",fontSize:110,align:"center",letterSpacing:.1,fontColor:"#ffffff",_type:"glText",_innerText:"LAX",refName:"lax",children:[]},{font:"NBArchitektStd-Light",fontSize:110,align:"center",letterSpacing:.1,fontColor:"#ffffff",_type:"glText",_innerText:"SYD",refName:"nyc",children:[]},{font:"NBArchitektStd-Light",fontSize:110,align:"center",letterSpacing:.1,fontColor:"#ffffff",_type:"glText",_innerText:"AMS",refName:"ams",children:[]},{font:"NBArchitektStd-Bold",fontSize:12,align:"left",letterSpacing:.1,fontColor:"#ffffff",_type:"glText",_innerText:"Privacy Notice",refName:"privacy",children:[]},{font:"NBArchitektStd-Bold",fontSize:12,align:"left",letterSpacing:.1,fontColor:"#ffffff",_type:"glText",_innerText:"Newsletter Signup",refName:"subscribe",children:[]},{font:"NBArchitektStd-Bold",fontSize:16,align:"center",letterSpacing:.1,fontColor:"#ffffff",_type:"glText",_innerText:"HELLO@ACTIVETHEORY.NET",refName:"email",children:[]},{width:34,height:34,bg:"assets/images/ui/ig.png",_type:"glObject",refName:"ig",children:[]},{width:30,height:30,bg:"assets/images/ui/in.png",_type:"glObject",refName:"in",children:[]},{width:30,height:30,bg:"assets/images/ui/tw.png",_type:"glObject",refName:"tw",children:[]},{width:276,height:2,bg:"#ffffff",_type:"glObject",refName:"line1",children:[]},{width:189,height:1,bg:"#ffffff",_type:"glObject",refName:"line2",children:[]},{width:160,height:1,bg:"#ffffff",_type:"glObject",refName:"line3",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.onInit=async function(){await _this.initSync(_this.ui.group),await _this.initSync(_this.ui),_this.set("ready",!0)},_this.ui.alpha=0,_this.ui.hide(),_this.privacy.line=_this.line2,_this.subscribe.line=_this.line3,_this.email.line=_this.line1,_this.arrow1.alpha=Device.mobile&&Stage.height>Stage.width?0:1,_this.arrow2.alpha=Device.mobile&&Stage.height>Stage.width?0:1,GLA11y.registerPage(_this.ui.group,"ContactPage"),GLA11y.textNode(_this.contact.group,"Contact Us"),GLA11y.textNode(_this.lax.group,"Los Angeles"),GLA11y.textNode(_this.nyc.group,"New York City"),GLA11y.textNode(_this.ams.group,"Amsterdam"),GLA11y.textNode(_this.privacy.group,"Privacy Notice"),GLA11y.textNode(_this.subscribe.group,"Newsletter Signup"),GLA11y.textNode(_this.email.group,"Email us at hello@activetheory.net"),GLA11y.objectNode(_this.email,_this.ui.group),GLA11y.objectNode(_this.subscribe,_this.ui.group),GLA11y.objectNode(_this.privacy,_this.ui.group),GLA11y.objectNode(_this.in,_this.ui.group),GLA11y.objectNode(_this.tw,_this.ui.group),GLA11y.objectNode(_this.ig,_this.ui.group),_this.email.interact(hover,(_=>window.open("mailto:hello@activetheory.net")),"#"),_this.subscribe.interact(hover,(_=>window.open("https://mailchi.mp/activetheory/newsletter","_blank")),"#"),_this.privacy.interact(hover,(_=>window.open("https://www.notion.so/Active-Theory-Privacy-Notice-dc343e6976e24c5e866be0ee64bf99eb","_blank")),"#"),_this.ig.interact(hover,(_=>window.open("https://www.instagram.com/activetheory","_blank")),"#","Instagram"),_this.in.interact(hover,(_=>window.open("https://www.linkedin.com/company/active-theory/","_blank")),"#","Linked in"),_this.tw.interact(hover,(_=>window.open("https://twitter.com/active_theory","_blank")),"#","Twitter"),_this.bind("ViewController/contact",(active=>{updateLayout(),active?(_this.ui.show(),_this.ui.shader.blending=Shader.ADDITIVE_BLENDING,_this.ui.tween({alpha:.95},2e3,"easeInOutSine")):_this.ui.tween({alpha:0},1e3,"easeOutSine").onComplete((_=>_this.ui.hide()))})),_this.onResize(updateLayout),_this.startRender((_=>{let glitch=Math.smoothStep(.7,.1,_this.ui.alpha);_this.nyc.setText(replaceRandomLetters("NYC",1*glitch)),_this.lax.setText(replaceRandomLetters("LAX",1*glitch)),_this.ams.setText(replaceRandomLetters("AMS",1*glitch)),_this.email.setText(replaceRandomLetters("HELLO@ACTIVETHEORY.NET",10*glitch)),_this.subscribe.setText(replaceRandomLetters("Newsletter Signup",10*glitch)),_this.privacy.setText(replaceRandomLetters("Privacy Notice",10*glitch)),_this.contact.setText(replaceRandomLetters("CONTACT US",10*glitch))}),12);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function DragAndDrop(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="DragAndDrop",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.element.attr("draggable","true"),_this.dragEl=_this.element;let _dragId,initialized=!1;function setDragging(){_this.set("UIL/Graph/dragging",_this.dragId)}function removeDragListeners(){_this.set("UIL/Graph/dragging",!1),_this.dragEl.div.removeEventListener("mousedown",setDragging,!1),window.removeEventListener("mouseup",_this.removeDragListeners,!1),_this.dropTarget.classList?.().remove("hover"),_this.dragEl.div.removeEventListener("dragstart",_this.dragStart,!1),_this.dragEl.div.removeEventListener("dragend",_this.dragEnd,!1),_this.dropTarget.div.removeEventListener("dragenter",_this.dragEnter),_this.dropTarget.div.removeEventListener("dragleave",_this.dragLeave),_this.dropTarget.div.removeEventListener("dragover",_this.dragOver),_this.dropTarget.div.removeEventListener("drop",_this.drop),_this.dragEl?.div?.removeEventListener("mousedown",_this.addDragListeners,!1)}_this.setDragEnabled=function(val){_this.dragEl.attr("draggable",val),!1===val&&removeDragListeners()},_this.setDragElement=function(el){_this.element.div.removeEventListener("mousedown",setDragging,!1),_this.element.attr("draggable",!1),_this.dragEl=el,_this.dragEl.attr("draggable",!0)},_this.onInit=function(){_this.dropTarget&&!initialized&&(!function addDragListeners(){if(_this.dragEl.div.addEventListener("mousedown",setDragging,!1),window.addEventListener("mouseup",_this.removeDragListeners,!1),!_this.element||!_this.dropTarget)return;_this.dragEl.div.addEventListener("dragstart",_this.dragStart,!1),_this.dragEl.div.addEventListener("dragend",_this.dragEnd,!1),_this.dropTarget.div.addEventListener("dragenter",_this.dragEnter),_this.dropTarget.div.addEventListener("dragleave",_this.dragLeave),_this.dropTarget.div.addEventListener("dragover",_this.dragOver),_this.dropTarget.div.addEventListener("drop",_this.drop)}(),_dragId=_this.data?_this.data.id:!!_this.id&&_this.id,initialized=!0)},_this.onRemoveView=function(){removeDragListeners()},_this.bind("UIL/Graph/dragging",(isDragging=>{})),_this.dragStart=function(event){event.stopPropagation(),_dragId||console.warn("No Drag Id is set on Drag and Drop. Set either _this.data.id or _this.id on the class inheriting from DragAndDrop",_this),event.dataTransfer.setData("text/plain",_dragId),event.dataTransfer.effectAllowed="move",event.dropEffect="move",_this.element.css({opacity:.4}),_this.onDragStart?.(event)},_this.dragEnd=function(event){event.stopPropagation(),_this.onDragEnd?.(event),_this.element?.css({opacity:1})},_this.dragEnter=function(event){_this.dropTarget.classList().add("hover"),_this.onDragEnter?.(event)},_this.dragLeave=function(event){_this.dropTarget.classList().remove("hover"),_this.onDragLeave?.(event)},_this.dragOver=function(event){event.preventDefault(),event.stopPropagation(),event.dataTransfer.dropEffect="move",_this.onDragOver?.(event)},_this.drop=function(event){return event.stopPropagation(),_this.dropTarget.classList().remove("hover"),_this.onDrop?.(event.dataTransfer.getData("text")),!1},_this.element.goob("\n    cursor: pointer;\n    .highlight {\n        pointer-events: none;\n    }\n"),"UILGraphGroupChildren"===Utils.getConstructorName(_this)&&_this.element.goob("\n        .highlight {\n            background: #1aeade !important;\n        }\n    ");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function FloorShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="FloorShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}function updateGlassShader(obj){obj.shader=_this.createFragment(Shader,"GlassReflection",{transparent:!0})}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({uDistortStrength:{value:1},uMirrorStrength:{value:1},uRUVOffset:{value:new Vector2},uRUVScale:{value:1}}),_this.normal=new Vector3(0,1,0),_this.onInit=async _=>{await _this.waitLayers();for(let key in _this.layers)if("floor"!=key&&"arealight"!=key&&"camera"!=key&&"floaters"!=key&&_this.layers[key].clone){let obj=await _this.mirror.add(_this.layers[key]);"glass"==key&&updateGlassShader(obj)}_this.mirror.start()};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.mirror=_this.initClass(FX.Mirror,AppState.createLocal({mesh:_this.mesh,normal:_this.normal,size:1280},!0)),_this.mirror.isFragment&&_promises.push(_this.wait(_this.mirror,"__ready")),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function Footer(_params,...restArgs){const _this=this;Inherit(_this,FragFXScene,"Footer"),Inherit(_this,XComponent),_this.fragName="Footer",_this.contexts='FragFXScene, "Footer"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this._initFXScene(World.NUKE,null,{format:void 0,type:void 0,minFilter:void 0,magFilter:void 0,multiRenderTarget:void 0,mipmaps:void 0,screenQuad:void 0,vrMode:void 0,multisample:void 0,samplesAmount:void 0}),_this.refractionLayer=_this.initClass(FXLayer,AppState.createLocal({name:"HomeRefraction"},!0)),_this.refractionLayer.isFragment&&_promises.push(_this.wait(_this.refractionLayer,"__ready")),_this.refraction=_this.initClass(SnapshotFrame,AppState.createLocal({texture:_this.refractionLayer},!0)),_this.refraction.isFragment&&_promises.push(_this.wait(_this.refraction,"__ready")),(_this.nuke||World.NUKE).paused=!0,_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.camera=_this.layers.camera,_this.uniforms={uRGBStrength:{value:1},uVolumetricStrength:{value:1},uContrast:{value:new Vector2(1,1)}},_this.set("pane",_this.layers.pane),_this.set("camera",_this.layers.camera),_this.layers.camera.lock();let tweenTimeline=_this.createFragment(TweenTimeline),rotation=0,baseRotation=Math.random(0,Math.radians(360)),delta=new Vector2,zero=new Vector2;_this.startRender((_=>{if(null==_this.scrollProgress)return;let progress=1-_this.scrollProgress;if(tweenTimeline.elapsed=_this.scrollProgress,tweenTimeline.update(),_this.layers.camera.group.position.y=Math.range(_this.scrollProgress,0,1,26,-20),_this.layers.camera.group.position.z=Device.mobile.phone?10:0,!_this.layers.particles.layers)return;delta.lerp(Mouse.down?Mouse.delta:zero,.07),rotation+=delta.x*(Device.mobile?.0075:.0025);let scrollTarget=Math.radians(180)+Math.radians(180*progress);_this.layers.particles.layers.particles.group.rotation.y=baseRotation+-(rotation+scrollTarget),_this.layers.particles.layers.particles.shader.uniforms.uScroll.value=progress,_this.layers.particles.layers.logo.position.y=Math.range(progress,0,1,32,-12)+10,_this.layers.particles.layers.logo.rotation.y=Math.radians(90)+2*(rotation+scrollTarget),_this.layers.particles.layers.logo.rotation.x=Math.radians(180),_this.layers.particles.layers.particles.shader.uniforms.uLogoPos.value.copy(_this.layers.particles.layers.logo.position),_this.layers.particles.layers.particles.shader.uniforms.uLogoPos.value.y*=-1,_this.layers.particles.layers.particles.shader.uniforms.uLogoPos.value.y+=22,_this.layers.particles.layers.column.position.y=_this.layers.particles.layers.logo.position.y-10,_this.layers.particles.layers.column.rotation.y=1*_this.layers.particles.layers.logo.rotation.y,_this.layers.particles.layers.column2.position.y=_this.layers.particles.layers.logo.position.y-10,_this.layers.particles.layers.column2.rotation.y=1*_this.layers.particles.layers.logo.rotation.y,_this.layers.particles.layers.logo.shader.uniforms.tRefraction.value=_this.refraction,_this.layers.particles.layers.column.shader.uniforms.tRefraction.value=_this.refraction,_this.layers.particles.layers.column2.shader.uniforms.tRefraction.value=_this.refraction})),_this.onInit=async _=>{await _this.layers.particles.layout.getAllLayers(),_this.volumetricLight.addLight(_this.layers.particles.layers.logo)};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.composite=_this.initClass(NukePass,AppState.createLocal({shader:"HomeComposite",uniforms:_this.uniforms},!0)),_this.composite.isFragment&&_promises.push(_this.wait(_this.composite,"__ready")),_this.nuke&&(_this.composite.texture=_this.nuke.rttBuffer),_this.volumetricLight=_this.initClass(FX.VolumetricLight,AppState.createLocal({unique:"home",nuke:_this.nuke,resolution:.1,enabled:Tests.volumetricLight()},!0)),_this.volumetricLight.isFragment&&_promises.push(_this.wait(_this.volumetricLight,"__ready")),_this.volumetricLight.uniforms&&_this.composite.addUniforms(_this.volumetricLight.uniforms),(_this.composite.upload||_this.composite.pass)&&((_this.nuke||World.NUKE).add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite),ShaderUIL.add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite)),(_this.nuke||World.NUKE).paused=!1,_this.initClass(StateInitializer,TubesInteraction,"tubes",{scene:"#x#_this.scene#x#",camera:"_this.camera",refraction:"_this.refraction"},{init:"#x#Tests.interactiveTubes()#x#"}),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function HexagonGrid(_input,_group){const _this=this;Inherit(_this,Object3D),Inherit(_this,XComponent),_this.fragName="HexagonGrid",_this.contexts="Object3D",_this.uilInput=_input,_this.uilFolder=_group,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mouseFluid=_this.initClass(MouseFluid),_this.mouseFluid.isFragment&&_promises.push(_this.wait(_this.mouseFluid,"__ready")),_this.batch=_this.initClass(MeshBatch),_this.batch.isFragment&&_promises.push(_this.wait(_this.batch,"__ready")),_this.uilInput=_input,_this.uilFolder=_group,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());const WIDTH=Math.floor(16/9*25);var _hold={value:0,v1:0,v2:0},_time={value:0,v:0};_this.shaderUniforms={tBaseColor:{value:Utils3D.getRepeatTexture("assets/images/pbr/damaged_road_basecolor.png"),getTexture:Utils3D.getRepeatTexture},tMRO:{value:Utils3D.getRepeatTexture("assets/images/pbr/damaged_road_mro.png"),getTexture:Utils3D.getRepeatTexture},tNormal:{value:Utils3D.getRepeatTexture("assets/images/pbr/damaged_road_normal.png"),getTexture:Utils3D.getRepeatTexture},tEnvDiffuse:{value:Utils3D.getRepeatTexture("assets/images/pbr/corsica_beach-diffuse-RGBM.png"),premultiplyAlpha:!1},tEnvSpecular:{value:Utils3D.getRepeatTexture("assets/images/pbr/corsica_beach-specular-RGBM.png"),premultiplyAlpha:!1},tLightmap:{value:null,premultiplyAlpha:!1},tLUT:{value:Utils3D.getLookupTexture("assets/images/pbr/lut.png"),ignoreUIL:!0},tVideo:{value:Utils3D.getTexture("assets/images/lab.jpg")},uTint:{value:new Color("#FFFFFF")},uTiling:{value:new Vector2(1,1)},uOffset:{value:new Vector2(0,0)},uMRON:{value:new Vector4(1,.4,.5,.04)},uEnv:{value:new Vector2(1,0)},uEnvRotation:{value:0},uScroll:{value:0},uVisible:{value:1},uHold:_hold,uTime:_time,uRotation:{value:0},uUVScale:{value:new Vector2(1,1)},uParams:{value:new Vector4(1,1,1,1)},uFogColor:{value:new Color},uUseLightmap:{value:0},uHDR:{value:1},uUseTonemapping:{value:1,ignoreUIL:!0},uUseLinearOutput:{value:0,ignoreUIL:!0}},_this.group.add(_this.batch.group),async function initGrid(){await _this.wait((_=>!!_this.shader)),ShaderUIL.add(_this.shader,_this.uilFolder);const hexagonWidth=.08*Math.sqrt(3);await _this.mouseFluid.applyTo(_this.shader);let geometry=await GeomThread.loadGeometry("assets/geometry/hexgrid/hexagon_gem.bin");for(let i=0;i<25;i++)for(let j=0;j<WIDTH;j++){let side=0;0==i?side=1:24==i?side=3:0==j&&i%2==0?side=4:j==WIDTH-1&&i%2!=0&&(side=2),(0==i&&0==j||24==i&&0==j)&&(side=5);let mesh=new Mesh(geometry,_this.shader);mesh.attributes={side:side},mesh.position.x=hexagonWidth*j-hexagonWidth*WIDTH*.5,mesh.position.x+=.5*hexagonWidth*(i%2),mesh.position.y=.12*i-1.5+.06,mesh.scale.setScalar(.08),_this.batch.add(mesh)}}();Scroll.createUnlimited();let root=_this.findParent("CleanRoom");_this.startRender((_=>{_hold.v1=Mouse.down?1:0,_hold.v2=Math.lerp(_hold.v1,_hold.v2,.03),_hold.value=Math.lerp(_hold.v2,_hold.value,.03);Math.abs(_hold.v1-_hold.value);_this.group.rotation.z=Stage.width>Stage.height?0:Math.radians(90),root.scrollProgress&&(_this.shader.uniforms.uScroll.value=root.scrollProgress),_this.shader.set("uRotation",_this.group.rotation.z),_this.shader.uniforms.uUVScale.value.x=Stage.width>Stage.height?1:2,_this.group.scale.x=Stage.width>Stage.height?.7:.45,_time.value+=.02*Render.HZ_MULTIPLIER}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.shader=_this.initClass(Shader,AppState.createLocal({name:"PhysicalShader",uniforms:_this.shaderUniforms},!0)),_this.shader.isFragment&&_promises.push(_this.wait(_this.shader,"__ready")),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function Home(_params,...restArgs){const _this=this;Inherit(_this,FragFXScene,"Home"),Inherit(_this,XComponent),_this.fragName="Home",_this.contexts='FragFXScene, "Home"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this._initFXScene(World.NUKE,null,{format:void 0,type:void 0,minFilter:void 0,magFilter:void 0,multiRenderTarget:void 0,mipmaps:void 0,screenQuad:void 0,vrMode:void 0,multisample:void 0,samplesAmount:void 0}),_this.refractionLayer=_this.initClass(FXLayer,AppState.createLocal({name:"HomeRefraction"},!0)),_this.refractionLayer.isFragment&&_promises.push(_this.wait(_this.refractionLayer,"__ready")),_this.refraction=_this.initClass(SnapshotFrame,AppState.createLocal({texture:_this.refractionLayer},!0)),_this.refraction.isFragment&&_promises.push(_this.wait(_this.refraction,"__ready")),(_this.nuke||World.NUKE).paused=!0,_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.camera=_this.layers.camera,_this.uniforms={uRGBStrength:{value:1},uVolumetricStrength:{value:1},uContrast:{value:new Vector2(1,1)}},_this.set("pane",_this.layers.pane),_this.set("camera",_this.layers.camera),_this.set("refraction",_this.refraction),_this.layers.camera.lock();let tweenTimeline=_this.createFragment(TweenTimeline),rotation=0,baseRotation=Math.radians(-20),delta=new Vector2,zero=new Vector2;_this.layers.scroll.text.alpha=0,_this.listen("Global/loadFinished",(async _=>{_this.layers.scroll.out||tween(_this.layers.scroll.text,{alpha:.8},5e3,"easeInOutSine",5e3)})),_this.startRender((_=>{if(null==_this.scrollProgress)return;let visibleV=_this.get("ViewController/visibleV");if(tweenTimeline.elapsed=_this.scrollProgress,tweenTimeline.update(),_this.layers.camera.group.position.y=Math.range(_this.scrollProgress,0,1,40,Device.mobile.phone?-11:-7),_this.layers.camera.group.position.z=Math.range(visibleV,0,1,-42,Device.mobile.phone?15:5),_this.layers.camera.group.position.z-=15*(1-_this.scrollProgress),_this.layers.camera.position.y=Math.range(_this.scrollProgress,0,1,4.5,Device.mobile.phone?1:2.5),_this.scrollProgress>.2&&function animateOutScrollText(){_this.layers.scroll.out||(_this.layers.scroll.out=!0,tween(_this.layers.scroll.text,{alpha:0},500,"easeOutSine"))}(),!_this.layers.particles.layers)return;let scrollTarget=Math.radians(90)-Math.radians(190*_this.scrollProgress);delta.lerp(Mouse.down?Mouse.delta:zero,.07),rotation+=delta.x*(Device.mobile?.0075:.0025),_this.layers.particles.layers.particles.group.rotation.y=baseRotation+rotation+scrollTarget,_this.layers.particles.layers.particles.shader.uniforms.uScroll.value=_this.scrollProgress,_this.layers.particles.layers.particles.shader.uniforms.uVisible.value=Math.smoothStep(0,.92,visibleV),Mouse.down&&(_this.layers.particles.layers.particles.shader.uniforms.uPulse.value=0),_this.layers.particles.layers.particles.shader.uniforms.uPulse.value+=.001,_this.layers.particles.layers.logo.position.y=_this.layers.camera.group.position.y+4.5-.6*(1-visibleV),_this.layers.particles.layers.logo.rotation.y=Math.radians(270)+2*(rotation+scrollTarget)+Math.radians(210)*Math.pow(1-visibleV,1.2),_this.layers.particles.layers.logo.shader.uniforms.uVisible.value=Math.smoothStep(.5,1,visibleV),_this.layers.particles.layers.particles.shader.uniforms.uLogoPos.value.copy(_this.layers.particles.layers.logo.position),_this.layers.particles.layers.particles.shader.uniforms.uLogoPos.value.x+=1,_this.layers.particles.layers.particles.shader.uniforms.uLogoPos.value.z+=2,_this.layers.particles.layers.column.position.y=_this.layers.particles.layers.logo.position.y-10,_this.layers.particles.layers.column.rotation.y=1*_this.layers.particles.layers.logo.rotation.y,_this.layers.particles.layers.column.shader.uniforms.uVisible.value=Math.smoothStep(.5,1,visibleV),_this.layers.particles.layers.column2.position.y=_this.layers.particles.layers.logo.position.y-10,_this.layers.particles.layers.column2.rotation.y=1*_this.layers.particles.layers.logo.rotation.y,_this.layers.particles.layers.column2.shader.uniforms.uVisible.value=Math.smoothStep(.5,1,visibleV),_this.layers.particles.layers.logo.shader.uniforms.tRefraction.value=_this.refraction,_this.layers.particles.layers.column.shader.uniforms.tRefraction.value=_this.refraction,_this.layers.particles.layers.column2.shader.uniforms.tRefraction.value=_this.refraction})),_this.onInit=async _=>{await _this.layers.particles.layout.getAllLayers(),_this.volumetricLight.addLight(_this.layers.particles.layers.logo)};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.composite=_this.initClass(NukePass,AppState.createLocal({shader:"HomeComposite",uniforms:_this.uniforms},!0)),_this.composite.isFragment&&_promises.push(_this.wait(_this.composite,"__ready")),_this.nuke&&(_this.composite.texture=_this.nuke.rttBuffer),_this.volumetricLight=_this.initClass(FX.VolumetricLight,AppState.createLocal({unique:"home",nuke:_this.nuke,dpr:.2,enabled:Tests.volumetricLight()},!0)),_this.volumetricLight.isFragment&&_promises.push(_this.wait(_this.volumetricLight,"__ready")),_this.volumetricLight.uniforms&&_this.composite.addUniforms(_this.volumetricLight.uniforms),(_this.composite.upload||_this.composite.pass)&&((_this.nuke||World.NUKE).add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite),ShaderUIL.add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite)),(_this.nuke||World.NUKE).paused=!1,_this.initClass(StateInitializer,TubesInteraction,"tubes",{scene:"#x#_this.scene#x#",camera:"_this.camera",refraction:"_this.refraction"},{init:"#x#Tests.interactiveTubes()#x#"}),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function HomeColumnShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="HomeColumnShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({tMap:{value:Utils3D.getTexture("assets/images/room/matcap-test.jpg"),getTexture:Utils3D.getRepeatTexture},tRefraction:{value:null,getTexture:Utils3D.getRepeatTexture},tVideo:{value:null,getTexture:Utils3D.getRepeatTexture},uVisible:{value:1},uOffset:{value:0},uAlpha:{value:1},transparent:!0}),_this.onInit=async _=>{let video=await _this.get("ViewController/video");_this.shader.uniforms.tVideo=video.uniform};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function HomeLogoShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="HomeLogoShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({tMap:{value:Utils3D.getTexture("assets/images/room/matcap-test.jpg"),getTexture:Utils3D.getRepeatTexture},tRefraction:{value:null,getTexture:Utils3D.getRepeatTexture},tVideo:{value:null,getTexture:Utils3D.getRepeatTexture},tNormal:{value:null,getTexture:Utils3D.getRepeatTexture},uVisible:{value:0},uAlpha:{value:1},uScrollDelta:{value:0},uNormalScale:{value:1},transparent:!0}),_this.onInit=async _=>{let video=await _this.get("ViewController/video");_this.shader.uniforms.tVideo=video.uniform};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function JellyInstancer(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,Object3D),Inherit(_this,XComponent),_this.fragName="JellyInstancer",_this.contexts="Component,Object3D",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}if(_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),Tests.hideChain())return void(_this.mesh.visible=!1);let meshes=[],batch=_this.createFragment(MeshBatch);for(let i=0;i<4;i++){let mesh=_this.mesh.clone();reset(mesh),mesh.position.y+=Math.range(i,0,4,30,-30),mesh.frustumCulled=!1,batch.add(mesh),meshes.push(mesh)}function reset(mesh){mesh.position.x=Utils.headsTails(-1,1)*Math.random(4,12),mesh.position.z=Utils.headsTails(-1,1)*Math.random(4,12),mesh.position.y=-10,mesh.scale.setScalar(Math.random(2,3,3)),mesh.scale.y*=1.5}_this.mesh.visible=!1;let root=_this.findParent("Home");_this.startRender((_=>{_this.group.position.copy(_this.mesh.position),root&&null!=root.scrollProgress&&(batch.group.rotation.y=-root.scrollProgress*Math.radians(360)*.5-3e-5*Render.TIME,meshes.forEach(((mesh,i)=>{mesh.shader.uniforms.uScroll.value=root.scrollProgress,mesh.position.y+=.01,mesh.position.y>60&&reset(mesh),mesh.rotation.y=Math.radians(90)*i-root.scrollProgress*Math.radians(360)*2-5e-4*Render.TIME})))}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function JellyShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="JellyShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({tRefraction:{value:null},tVideo:{value:null},uScroll:{value:0},uReflection:{value:new Vector2(1,1)}}),_this.onInit=async _=>{let refraction=await _this.get("Home/refraction");_this.shader.set("tRefraction",refraction);let video=await _this.get("ViewController/video");_this.shader.uniforms.tVideo=video.uniform};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function LoaderGLUI(_params,...restArgs){const _this=this;Inherit(_this,GLUIElement),Inherit(_this,XComponent),_this.fragName="LoaderGLUI",_this.contexts="GLUIElement",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{addTo:"GLUI.Stage",_type:"UI",refName:"ui",children:[{width:1e3,height:1e3,bg:"#0000ff",_type:"glObject",refName:"visual",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());let bgShader=_this.createFragment(Shader,"LoaderBGShader",{uColor:{value:new Color("#111111")},uBottom:{value:0},uProgress:{value:0},uBars:{value:Device.mobile.phone?24:20},uVisible:{value:1},uMobile:{value:Device.mobile.phone?1:0},uHeight:{value:.14},uScrollDelta:{value:0},uAlpha:{value:0},transparent:!0});_this.visual.useShader(bgShader),_this.startRender((_=>{_this.visual.width=Stage.width,_this.visual.height=Stage.height,_this.visual.x=Stage.width/2-_this.visual.width/2,_this.visual.y=Stage.height/2-_this.visual.height/2,bgShader.uniforms.uProgress.value=Math.lerp(_this.progress,bgShader.uniforms.uProgress.value,.02)})),_this.visual.scale=Device.mobile?2:1,_this.ui.alpha=0,_this.onInit=async _=>{_this.flag("isReady",!0)};_this.ready=async function(){await _this.wait("isReady"),_this.ui.alpha=0,await _this.ui.tween({alpha:1},800,"easeOutSine",100).promise()},_this.animateOut=async function(){bgShader.tween("uVisible",0,800,"easeInCubic"),await _this.ui.tween({alpha:0},800,"easeInCubic").promise()};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function LoaderView(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="LoaderView",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{css:"position: absolute",size:"100%",setZ:1e4,_type:"UI",refName:"unnamed",children:[{font:"nbarchitekt",fontSize:13,css:"textAlign: center, lineHeight: 1, letterSpacing: 0.1em, z-index: 100, position: absolute",fontColor:"#81ecfe",_type:"div",_innerText:"000000000000000000000000000000000000",refName:"behind",children:[]},{font:"nbarchitekt",fontSize:16,css:"textAlign: center, lineHeight: 1, letterSpacing: 0.1em, z-index: 100, position: absolute",fontColor:"#e0fff6",_type:"div",_innerText:"0",refName:"text",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.text.size(220,14).center().css({textAlign:"center",opacity:1}),_this.behind.size(220,220).center().css({textAlign:"left",opacity:.4}),_this.behind.css({maskImage:"radial-gradient(black 49%, transparent 50%)"}),_this.text.percent=0,_this.params.loader.add(2),_this.bind("FXScroll/firstScene",(_=>{_this.params.loader.trigger(1)})),_this.params.loader.add(1),_this.bind("ContactUI/ready",(_=>{_this.params.loader.trigger(1)})),_this.params.loader.add(1),_this.bind("NavUI/ready",(_=>{_this.params.loader.trigger(1)})),_this.onInit=async _=>{await GPU.ready(),await World.instance().ready(),_this.gluiLoader=_this.createFragment(LoaderGLUI),await _this.gluiLoader.ready(),_this.params.loader.trigger(1)};let tick=0;_this.startRender((_=>{let text="";for(var i=0;i<16;i++){for(var j=0;j<30;j++)text+="/";text+="\n"}tick++,text=text.slice(0,Math.round(_this.text.percent*text.length)),text.length>0?_this.behind.html(function replaceRandomLetters(str,numReplacements){let result=str.split("");const replacementChars=Math.round(100*_this.text.percent).toString();for(let i=0;i<numReplacements;i++){const randomPos=Math.floor(Math.random()*str.length),randomChar=replacementChars.charAt(Math.floor(Math.random()*replacementChars.length));result[randomPos].includes([" "," ","\n","?",","])||(result[randomPos]=randomChar)}return result.join("")}(text,tick%2==0?30:0)):_this.behind.html(text)}),24),_this.startRender((_=>{let percent=Math.round(100*_this.text.percent);percent<10&&(percent="//"+percent),percent<100&&(percent="/"+percent),_this.text.text(`${percent}`),_this.gluiLoader&&(_this.gluiLoader.progress=_this.text.percent)})),_this.bind(_this.params.loader,Events.PROGRESS,(({percent:percent})=>{tween(_this.text,{percent:.9*percent},1e3,"linear")})),_this.bind(_this.params.loader,Events.COMPLETE,(async _=>{_this.behind.tween({opacity:0},2e3,"easeOutSine"),_this.text.tween({opacity:0},2e3,"easeInOutSine"),await tween(_this.text,{percent:1},500,"easeOutSine").promise(),await _this.gluiLoader.animateOut(),_this.fire("Global/loadFinished"),function animateInScrollbar(){let obj={opacity:0},root=document.documentElement;tween(obj,{opacity:.9},2e3,"easeOutSine",1e3).onUpdate((()=>{root.style.setProperty("--baropacity",obj.opacity)}))}(),_this.destroy()}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function LogoParticle(_params,...restArgs){const _this=this;Inherit(_this,Frag3D,"LogoParticle"),Inherit(_this,XComponent),_this.fragName="LogoParticle",_this.contexts='Frag3D, "LogoParticle"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.onInit=async _=>{let video=await _this.get("ViewController/video");await _this.layers.logo.ready(),_this.layers.logo.shader.uniforms.tVideo=video.uniform,_this.layers.logo.isReady=!0};let root=_this.findParent("TreeScene");_this.startRender((_=>{root&&root.scrollProgress&&_this.layers.logo&&_this.layers.logo.isReady&&(_this.layers.logo.shader.uniforms.uScroll.value=root.scrollProgress)}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function MusicPlayerDOM(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="MusicPlayerDOM",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{addTo:"Stage",_type:"UI",refName:"unnamed",children:[{_type:"div",refName:"wrapper",children:[{"aria-label":"Previous Song",click:"$goPrev",_type:"button",refName:"arrowL",children:[{_type:"p",_innerText:"<<",refName:"textL",children:[]}]},{_type:"div",refName:"ticker",children:[{_type:"div",_innerText:"Song--Artist",refName:"tickerItem0",children:[]},{_type:"div",_innerText:"Song--Artist",refName:"tickerItem1",children:[]}]},{"aria-label":"Next Song",click:"$goNext",_type:"button",refName:"arrowR",children:[{_type:"p",_innerText:">>",refName:"textR",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),GlobalAudio3D.setup(),_this.sfx=SFXController.instance();let SONGS=[{title:"Sergey Azbel - Themis",src:"assets/music/Sergey Azbel - Themis.mp3"},{title:"nuer self - Dusk",src:"assets/music/nuer self - Dusk.mp3"},{title:"Flint - Fly up High",src:"assets/music/Flint - Fly up High.mp3"},{title:"Hotham - To the Stars",src:"assets/music/Hotham - To the Stars.mp3"},{title:"Jozeque - Sultans of Streams",src:"assets/music/Jozeque - Sultans of Streams.mp3"},{title:"Downtown Binary - Other Worlds",src:"assets/music/Downtown Binary - Other Worlds.mp3"},{title:"Magiksolo - Quantum World",src:"assets/music/Magiksolo - Quantum World.mp3"},{title:"BXRDVJA - Ghost Cities",src:"assets/music/BXRDVJA - Ghost Cities.mp3"}];SONGS=SONGS.shuffle(),_this.goPrev=_=>_this.set("songIndex",(_this.get("songIndex")-1+SONGS.length)%SONGS.length),_this.goNext=_=>_this.set("songIndex",(_this.get("songIndex")+1)%SONGS.length),function setup(){SONGS.forEach((song=>_this.sfx.registerSound(song.title,Assets.getPath(song.src))))}(),_this.set("readyToShow",0),_this.listen(GlobalAudio3D,Events.READY,(()=>{_this.bind("songIndex",(index=>{_this.ticker.tween({opacity:0},100,"easeInSine").onComplete((_=>{_this.tickerItem0.text(index+1+". "+SONGS[index].title),_this.tickerItem1.text(index+1+". "+SONGS[index].title),_this.ticker.tween({opacity:.7},1e3,"easeOutSine",200)})),SONGS.forEach((song=>_this.sfx.stop(song.title))),_this.sfx.play(SONGS[index].title)})),Storage.get("muted")?_this.sfx.muted=!0:_this.sfx.muted=!1,GlobalAudio3D.volume=0,tween(GlobalAudio3D,{volume:.15},2e3,"easeInOutSine"),_this.set("Global/audioEnabled",_this.sfx.muted?0:1),GlobalAudio3D.muted=_this.sfx.muted,_this.set("readyToShow",_this.get("readyToShow")+1)})),_this.set("songIndex",Math.random(0,SONGS.length-1)),_this.bind("Global/audioEnabled",(enabled=>{_this.visible&&(Storage.set("muted",!enabled),tween(GlobalAudio3D,{volume:enabled?.15:0},500,"easeOutSine"),2!==enabled&&_this.events.fire(SFXController.TOGGLE_AUDIO),_this.wrapper.tween({opacity:enabled?.8:0},500,"easeOutSine"))})),_this.wrapper.div.style.opacity=0,_this.listen("Global/loadFinished",(_=>_this.set("readyToShow",_this.get("readyToShow")+1))),_this.bind("readyToShow",(ready=>{2===ready&&(_this.visible=!0,_this.wrapper.css({opacity:0}).transform({y:-100}),_this.wrapper.tween({opacity:_this.sfx.muted?0:.8,y:0},2e3,"easeOutCubic",1500))})),_this.bind("Work/project",((data,prevData)=>{data?GlobalAudio3D.events.fire(Events.MESSAGE,{isMuffled:!0}):prevData&&GlobalAudio3D.events.fire(Events.MESSAGE,{isMuffled:!1})})),_this.startRender((_=>{for(const title in _this.sfx.activeSounds)if(_this.sfx.activeSounds[title].length)return;_this.goNext()}),5),_this.element.goob('\n    .wrapper {\n        display: flex;\n        flex-direction: row;\n        justify-content: space-between;\n        align-items: center;\n        mix-blend-mode: color-dodge;\n\n        position: fixed;\n        top: 70px;\n        right: 32px;\n        margin: 2.6rem 2.6rem;\n        @media (max-width: 768px) {\n            top: 55px;\n            margin: 2rem 2rem;\n        }\n        z-index: 3;\n        padding: 10px 4px;\n        pointer-events: none;\n        border: 1px solid rgba(255,255,255,0.1);\n        background-color: rgba(255,255,255,0.1);\n\n        width: 170px;\n        height: 42px;\n        background-color: transparent;\n        border-radius: 7px;\n        opacity: 0;\n\n        transition: all 0.4s ease-out;\n        &:hover {\n            opacity: 1;\n        }\n    }\n\n    button {\n        width: 36px;\n        height: 32px;\n        pointer-events: auto;\n        cursor: pointer;\n        background-color: rgba(255,255,255,0.1);\n        border-radius: 5px;\n        border: 1px solid rgba(255,255,255,0.6);\n        mix-blend-mode: color-dodge;\n\n        font-family: "nbarchitekt", monospace;\n        font-size: 14px;\n        font-weight: 700;\n        color: white;\n\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        opacity: 0.3;\n        transition: all 0.4s ease-out;\n        &:hover {\n            opacity: 1;\n        }\n    }\n\n    @keyframes ticker {\n        0% {\n            -webkit-transform: translate3d(0, 0, 0);\n            transform: translate3d(0, 0, 0);\n            visibility: visible;\n        }\n      \n        100% {\n            -webkit-transform: translate3d(-100%, 0, 0);\n            transform: translate3d(-100%, 0, 0);\n        }\n    }\n    .ticker {\n        display: inline-block;\n        height: 30px;\n        line-height: 30px;\n        width: 80px;\n        overflow: hidden;\n        background-color: transparent;\n        white-space: nowrap;\n        opacity: 0.5;\n        box-sizing: content-box;\n        mix-blend-mode: color-dodge;\n\n        > * {\n            display: inline-block;\n            height: 30px;\n            margin: 0;\n\n            animation-iteration-count: infinite;\n            animation-timing-function: linear;\n            animation-name: ticker;\n            animation-duration: 9s;\n\n            padding: 0 0.8rem;\n            font-family: "nbarchitekt", monospace;\n            font-size: 10px;\n            font-weight: 400;\n            color: white;\n        }\n    }\n    \n');for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function NavUI(_params,...restArgs){const _this=this;Inherit(_this,GLUIElement),Inherit(_this,Initialization),Inherit(_this,XComponent),_this.fragName="NavUI",_this.contexts="GLUIElement,Initialization",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{addTo:"GLUI.Stage",_type:"UI",refName:"ui",children:[{text:"Work",_type:"NavUIItem",refName:"work",children:[]},{text:"Contact",_type:"NavUIItem",refName:"contact",children:[]},{width:50,height:40,bg:"#ffffff",_type:"glObject",refName:"audio",children:[]},{width:320,height:320,bg:"#000000",_type:"glObject",refName:"bg",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.onInit=async function(){await _this.initSync(_this.ui.group),await _this.initSync(_this.ui),_this.set("ready",!0)};let bgShader=_this.createFragment(Shader,"NavBGShader",{uColor:{value:new Color("#111111")},uBottom:{value:0},uDisabled:{value:0},uScroll:{value:0},uHeight:{value:.14},uScrollDelta:{value:0},uUIColor:{value:new Color},uUIBlend:{value:0}});_this.bg.useShader(bgShader);let audioShader=_this.createFragment(Shader,"NavAudioShader",{uColor:{value:new Color("#ffffff")},uScroll:{value:0},uAmplitude:{value:0},uAlpha:{value:0},uHover:{value:0}});_this.audio.useShader(audioShader),GLA11y.registerPage(_this.ui.group,"NavigationUI"),GLA11y.objectNode(_this.audio,_this.ui.group),_this.audio.interact((function hover(e){switch(e.action){case"over":audioShader.tween("uHover",1,300,"easeOutSine");break;case"out":audioShader.tween("uHover",0,500,"easeOutSine")}}),(function click(){let toggle=!_this.get("Global/audioEnabled");_this.set("Global/audioEnabled",toggle)}),"#","Toggle Audio"),_this.set("Global/audioEnabled",!1),_this.ui.alpha=.001,_this.listen("Global/loadFinished",(_=>{_this.ui.tween({alpha:1},2e3,"easeInOutSine",1e3),audioShader.tween("uAlpha",1,2e3,"easeInOutSine")})),_this.bind("Work/project",((data,prevData)=>{data?(bgShader.set("uUIColor",new Color("#"+data.color)),bgShader.tween("uUIBlend",1,1500,"workInOut")):prevData&&bgShader.tween("uUIBlend",0,1500,"workInOut")})),_this.bind("Global/audioEnabled",(enabled=>{audioShader.tween("uAmplitude",!Tests.noMusic()&&enabled?1:0,500,"easeOutCubic")})),_this.startRender((async _=>{let scrolled=await _this.get("ViewController/scrollV"),delta=await _this.get("ViewController/scrollDeltaV");bgShader.uniforms.uScroll.value=scrolled,bgShader.uniforms.uScrollDelta.value=delta,audioShader.uniforms.uScroll.value=scrolled,_this.work.wrapper.x=_this.bg.x+80,_this.work.wrapper.y=_this.bg.y+.475*_this.bg.height+4.5*bgShader.uniforms.uScrollDelta.value,_this.contact.wrapper.x=_this.bg.x+_this.bg.width*Math.mix(.6,.5,Tests.noMusic()?1:0)-2,_this.contact.wrapper.y=_this.bg.y+.475*_this.bg.height+4.5*bgShader.uniforms.uScrollDelta.value,_this.audio.x=_this.bg.x+.5*_this.bg.width-_this.audio.width/2-13,_this.audio.y=_this.bg.y+.475*_this.bg.height+4.5*bgShader.uniforms.uScrollDelta.value-12,Tests.noMusic()&&(_this.work.wrapper.x-=8,_this.contact.wrapper.x+=20,_this.audio.width=30,_this.audio.alpha=.6,_this.audio.x-=2)})),_this.onResize((function updateLayout(){_this.bg.width=Tests.noMusic()?300:340,Device.mobile?(_this.bg.x=Stage.width-_this.bg.width-0+20,_this.bg.y=.3*-_this.bg.height-10):(_this.bg.x=Stage.width-_this.bg.width-0+10,_this.bg.y=.25*-_this.bg.height-10)}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function NavUIItem(_params,...restArgs){const _this=this;Inherit(_this,GLUIElement),Inherit(_this,XComponent),_this.fragName="NavUIItem",_this.contexts="GLUIElement",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"wrapper",children:[{width:60,height:30,bg:"#ff0000",_type:"glObject",refName:"hit",children:[]},{font:"NBArchitektStd-Regular",fontSize:12,fontColor:"#ffffff",_type:"glText",_innerText:"_",refName:"text",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.hit.alpha=0,_this.hit.y=-10,_this.hit.x=-10,await _this.wait((_=>_this.parent.ui.group.seo)),GLA11y.objectNode(_this.hit,_this.parent.ui.group),_this.hit.interact((function hover(e){switch(e.action){case"over":_this.text.tween({alpha:.7},200,"easeOutSine");break;case"out":_this.text.tween({alpha:1},400,"easeOutSine")}}),click,"#",_this.params.text);let link=_this.params.text.toLowerCase();"contact"==link&&(_this.events.sub(Keyboard.DOWN,(async e=>{e&&e.key&&e.key.toLowerCase().includes(["x","escape"])&&active&&click()})),_this.bind("ViewController/contact",(a=>{active=a})));let active=!1;function click(){"contact"==link?active?_this.set("ViewController/contact",!1):_this.set("ViewController/contact",!0):(_this.set("ViewController/contact",!1),_this.fire("ViewController/goToWork"),_this.set("Work/project",null))}_this.startRender((_=>{let delta=_this.get("ViewController/scrollDeltaV");_this.text.setText(function replaceRandomLetters(str,numReplacements){let result=str.split("");for(let i=0;i<numReplacements;i++){const randomPos=Math.floor(Math.random()*str.length),randomChar="1234567890".charAt(Math.floor(10*Math.random()));result[randomPos].includes([" ","/","?",",","."])||(result[randomPos]=randomChar)}return result.join("")}(active?"CLOSE-X":_this.params.text,Math.floor(.2*delta)+.1*Math.smoothStep(1,.7,_this.text.alpha)))}),12);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function PBRCapture(_input,_group){const _this=this;Inherit(_this,Object3D),Inherit(_this,XComponent),_this.fragName="PBRCapture",_this.contexts="Object3D",_this.uilInput=_input,_this.uilFolder=_group,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.uilInput=_input,_this.uilFolder=_group,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.input=_this.createUIL("pbrcapture_"+_this.uilInput.prefix,_this.uilFolder),_this.input.setLabel("PBR Capture"),_this.input.addButton("save",{label:"Save",actions:[{title:"Save",callback:function save(){let scene=World.SCENE,p=_this.group._parent;for(;p;)p instanceof Scene&&(scene=p),p=p._parent;cube.render(scene),equi.render(),equi.toBlob()}}]});let cube=new CubeCamera(.1,100,2048);_this.add(cube);let equi=new CubemapToEquirectangular(2048,cube);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function ParticleTest(_params,...restArgs){const _this=this;Inherit(_this,Frag3D,"ParticleTest"),Inherit(_this,XComponent),_this.fragName="ParticleTest",_this.contexts='Frag3D, "ParticleTest"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.onInit=async _=>{let video=await _this.get("ViewController/video");_this.layers.video.shader.uniforms.tMap=video.uniform,_this.layers.bg.shader.uniforms.tMap=video.uniform,_this.layers.logo.shader.uniforms.tVideo=video.uniform,await _this.layers.particles.ready(),_this.layers.particles.shader.uniforms.tVideo=video.uniform;let attenuation=1;Tests.particleCount()<=16384?attenuation=1.6:Tests.particleCount()<=65536?attenuation=1.4:Tests.particleCount()<=262144&&(attenuation=1.2),_this.layers.particles.shader.addUniforms({uSizeBias:{value:attenuation}})};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function SpineInstancer(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,Object3D),Inherit(_this,XComponent),_this.fragName="SpineInstancer",_this.contexts="Component,Object3D",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());let batch=_this.createFragment(MeshBatch),meshes=[];for(let i=0;i<40;i++){let mesh=_this.mesh.clone();mesh.position.set(0,0,0),mesh.position.y=-.65*i+4,mesh.rotation.y=.4*i,batch.add(mesh),meshes.push(mesh)}_this.mesh.visible=!1,_this.startRender((_=>{_this.group.position.copy(_this.mesh.position)}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function SpineShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="SpineShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({tRefraction:{value:null},uReflection:{value:new Vector2(1,1)}});let refraction=await _this.get("Work/refraction");_this.shader.set("tRefraction",refraction);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function Tests(){const _this=this;Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="Tests",_this.contexts="Component",this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.getDPR=_=>GPU.OVERSIZED?.8:GPU.lt(0)?.9:GPU.lt(1)||GPU.lt(2)?Math.min(Device.pixelRatio,1):GPU.lt(3)?Math.min(Device.pixelRatio,1.25):GPU.lt(4)?Math.max(1.5,Math.min(Device.pixelRatio,1.5)):GPU.lt(5)?Math.max(1.5,Math.max(Device.pixelRatio,2)):GPU.mobileLT(0)?1:GPU.mobileLT(1)||GPU.mobileLT(2)?Math.min(Device.pixelRatio,1):GPU.mobileLT(3)?Math.min(Device.pixelRatio,1.25):GPU.mobileLT(4)?Math.min(Device.pixelRatio,1.5):GPU.mobileLT(5)?Math.min(Device.pixelRatio,1.75):1,_this.capFPS=_=>GPU.lt(2)||GPU.mobileLT(2)?30.001:GPU.lt(3)?Render.REFRESH_RATE>60?60.001:null:Device.mobile&&GPU.mobileLT(3)&&Render.REFRESH_RATE>100?100.001:null,_this.renderFXAA=_=>(!1!==_this.msaaSamples()||GPU.lt(1)||GPU.mobileLT(2),!1),_this.noMusic=_=>!!Device.mobile,_this.enableWorldNukeMSAA=_=>!1,_this.videoVFX=_=>!0,_this.msaaSamples=_=>4,_this.particleCount=_=>GPU.mobileLT(2)?16384:GPU.mobileLT(4)?65536:GPU.mobileLT(5)?262144:GPU.lt(2)?16384:GPU.lt(3)?65536:GPU.lt(4)?524288:1048576,_this.flowerParticleCount=_=>GPU.mobileLT(3)?16384:GPU.mobileLT(4)?65536:GPU.mobileLT(5)?262144:GPU.lt(2)?16384:GPU.lt(3)?65536:GPU.lt(4)?262144:524288,_this.detailParticleCount=_=>GPU.mobileLT(2)?16384:GPU.mobileLT(4)?65536:GPU.lt(2)?16384:GPU.lt(3)?65536:262144,_this.logoParticleCount=_=>GPU.mobileLT(3)||GPU.lt(2)?16384:65536,_this.hideChain=_=>!!GPU.mobileLT(4)||!!GPU.lt(2),_this.lensStreak=_=>!GPU.lt(3)&&!GPU.mobileLT(3),_this.pingPongRender=_=>_this.capFPS()<40?GPU.lt(0)||GPU.mobileLT(1):!!GPU.lt(3)||!!GPU.mobileLT(3),_this.bloom=_=>!GPU.lt(3)&&!GPU.mobileLT(3),_this.volumetricLight=_=>!!Device.graphics.webgl.webgl2&&(!GPU.lt(2)&&!GPU.mobileLT(2)),_this.interactiveTubes=_=>!!_this.volumetricLight();for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()}),"static"),Class((function TreeFBR(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="TreeFBR",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({uScroll:{value:1}}),_this.onInit=async _=>{if(!Global.PLAYGROUND){let video=await _this.get("ViewController/video");_this.shader.uniforms.tVideo=video.uniform}};let root=_this.findParent("TreeScene");_this.startRender((_=>{root&&null!=root.scrollProgress&&(_this.shader.uniforms.uScroll.value=root.scrollProgress)})),_this.layers.camera&&_this.layers.camera.lock();for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function TreeMirror(_input,_group){const _this=this;Inherit(_this,Object3D),Inherit(_this,XComponent),_this.fragName="TreeMirror",_this.contexts="Object3D",_this.uilInput=_input,_this.uilFolder=_group,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.uilInput=_input,_this.uilFolder=_group,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),await _this.waitLayers();let mirror=_this.createFragment(FX.Mirror,_this.layers.water.mesh,{size:1024});mirror.start();for(let key in _this.layers)_this.layers[key].shader&&(console.log(key),mirror.add(_this.layers[key]));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function TreeScene(_params,...restArgs){const _this=this;Inherit(_this,FragFXScene,"TreeScene"),Inherit(_this,XComponent),_this.fragName="TreeScene",_this.contexts='FragFXScene, "TreeScene"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this._initFXScene(World.NUKE,null,{format:void 0,type:void 0,minFilter:void 0,magFilter:void 0,multiRenderTarget:void 0,mipmaps:void 0,screenQuad:void 0,vrMode:void 0,multisample:void 0,samplesAmount:void 0}),(_this.nuke||World.NUKE).paused=!0,_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.uniforms={uRGBStrength:{value:1},uContrast:{value:new Vector2(1,1)}},_this.startRender((_=>{null!=_this.scrollProgress&&(_this.layers.wrapper.rotation.y=Math.radians(180)+Math.radians(-60)*(-.5+_this.scrollProgress),_this.layers.camera.position.z=(Device.mobile?40:35)-15*_this.scrollProgress,_this.layers.cables.shader.uniforms.uLight.value.x=-.5+_this.scrollProgress)})),_this.onInit=async _=>{};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.composite=_this.initClass(NukePass,AppState.createLocal({shader:"TreeSceneComposite",uniforms:_this.uniforms},!0)),_this.composite.isFragment&&_promises.push(_this.wait(_this.composite,"__ready")),_this.nuke&&(_this.composite.texture=_this.nuke.rttBuffer),(_this.composite.upload||_this.composite.pass)&&((_this.nuke||World.NUKE).add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite),ShaderUIL.add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite)),(_this.nuke||World.NUKE).paused=!1,_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function TreeWaterShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="TreeWaterShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({tWaterNormal:{value:null,getTexture:Utils3D.getRepeatTexture},uSpeed:{value:1},uScale:{value:1},uWaterUVStrength:{value:1},uBrightness:{value:1}});let mirror=_this.createFragment(FX.Mirror,_this.mesh,{size:1024});mirror.start(),_this.onInit=async _=>{let video=await _this.get("ViewController/video");_this.shader.uniforms.tVideo=video.uniform,await _this.waitLayers();for(let key in _this.layers){if("water"==key)continue;let layer=_this.layers[key];"logo_particle"==key&&(layer=layer.layers.logo,await layer.ready(),layer=layer.mesh),layer.shader&&layer.clone&&mirror.add(layer)}};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function TriangleInstance(_proton,_group,_input){const _this=this;Inherit(_this,Component),Inherit(_this,Object3D),Inherit(_this,XComponent),_this.fragName="TriangleInstance",_this.contexts="Component,Object3D",_this.proton=_proton,_this.uilInput=_input,_this.uilFolder=_group,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.proton=_proton,_this.uilInput=_input,_this.uilFolder=_group,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());let geom=function createEquilateralTriangleGeometry(sideLength){const height=sideLength*Math.sqrt(3)/2,vertices=new Float32Array([0,height,0,-sideLength/2,0,0,sideLength/2,0,0]),geometry=new Geometry;return geometry.addAttribute("position",new GeometryAttribute(vertices,3)),geometry.computeVertexNormals(),geometry}(.5);_this.proton.applyToInstancedGeometry(geom);let shader=_this.createFragment(Shader,"TriangleParticleShader",{}),mesh=new Mesh(geom,shader);_this.add(mesh);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function TubeController(_proton,_group,_input){const _this=this;Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="TubeController",_this.contexts="Component",_this.proton=_proton,_this.uilInput=_input,_this.uilFolder=_group,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.proton=_proton,_this.uilInput=_input,_this.uilFolder=_group,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.proton.tubes.useColor();for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function TubePlayer(_params,...restArgs){const _this=this;Inherit(_this,PlayerView),Inherit(_this,XComponent),_this.fragName="TubePlayer",_this.contexts="PlayerView",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());const move=new Group,pos=move.position,camera=_this.params.camera,tubes=_this.params.proton.tubes,velocity=_this.createFragment(VelocityTracker,pos),velVec=new Vector3;_this.params.local&&_this.setPlayerData("color",function getColor(){let hue=Math.random(0,1,4),color=new Color,hsl=new ColorHSL(hue,.5,.6);return color.setHSL(hsl),color.getHexString()}());let color=new Color;_this.bind(_this.state,"color",(value=>{color.set(value)})),_this.bindLink(move,"move");let pos2=new Vector3,dist=new Vector3;_this.startRender((_=>{if(_this.params.local){let z=40;pos.copy(ScreenProjection.find(camera).unproject(Mouse,Stage,z))}velocity.update()})),_this.startRender((_=>{_this.get("ViewController/visibleV")<.9&&_this.params.local||(dist.subVectors(pos,pos2),dist.length()<.5||(velVec.copy(velocity.value).normalize().multiplyScalar(.4),tubes.release(pos,1,.3,velVec,color),pos2.copy(pos)))}),60);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function TubeShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="TubeShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({tRefraction:{value:null},transparent:!0});for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function TubesInteraction(_params,...restArgs){const _this=this;Inherit(_this,Frag3D,"TubesInteraction"),Inherit(_this,MultiplayerEnvironment),Inherit(_this,XComponent),_this.fragName="TubesInteraction",_this.contexts='Frag3D, "TubesInteraction",MultiplayerEnvironment',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),await _this.layers.particles.ready(),await _this.layers.particles.tubes.ready(),_this.layers.particles.tubes.shader.set("tRefraction",_this.params.refraction),_this.params.scene.add(_this.group),_this.layers.particles.tubes.mesh.visible=!0;for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.ref_MultiplayerConfig939=_this.initClass(MultiplayerConfig,AppState.createLocal({server:"wss://s.dreamwave.network/ws",roomKey:"atv6",playerClass:"TubePlayer",maxInRoom:3,data:{camera:_this.params.camera,proton:_this.layers.particles}},!0)),_this.ref_MultiplayerConfig939.isFragment&&_promises.push(_this.wait(_this.ref_MultiplayerConfig939,"__ready")),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControl(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILControl",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());var _onChange=()=>{};_this.element.attr("data-type","UILControl"),_this.element.div._this=_this;let _onFinishChange=()=>{};function isEqual(a,b){return Array.isArray(a)||Array.isArray(b)?a+""==b+"":"object"==typeof a||"object"==typeof b?JSON.stringify(a)===JSON.stringify(b):a===b}function clone(value){return Array.isArray(value)?[...value]:null===value?"":"object"==typeof value?Object.assign({},value):value}_this.element.goob("\n    & {\n        padding: calc(var(--spacing) / 2) var(--spacing);\n        width: 100%;\n    }\n"),_this.init=(id,opts={})=>{_this.id=id,_this.opts=opts,_this.setValue(clone(opts.value)),_this.previous=clone(_this.value),_this.value&&_this.set("value",_this.value),_this.setLabel(opts.label||id),_this.element.attr("data-id",id)},_this.finish=(history=!0)=>{_onFinishChange(_this.value),isEqual(_this.value,_this.previous)||(history&&UILHistory.set(_this,_this.previous),UILLocalStorage.set(_this.id,_this.value),UILStorage.set(_this.id,_this.value),_this.previous=clone(_this.value))},_this.force=value=>{_this.setValue(clone(value)),_this.finish(!1)},_this.debounce=(callback,time=250)=>{let interval;return(...args)=>{clearTimeout(interval),interval=setTimeout((()=>{interval=null,callback(...args)}),time)}},_this.onChange=cb=>(_onChange=cb,_this),_this.onFinishChange=cb=>(_onFinishChange=cb,_this),_this.getValue=function(){return _this.value},_this.setValue=value=>{isEqual(value,_this.value)||(_this.value=clone(value),_this.update&&_this.update(_this.value),"function"==typeof _onChange&&_onChange(_this.value))},_this.getView=function(){return _this.view},_this.setView=view=>{_this.view&&_this.view.destroy(),_this.view=view,_this.content.add(_this.view)},_this.hide=function(){return _this.visible=!1,_this.element.css({display:"none"}),_this},_this.show=function(){return _this.visible=!0,_this.element.css({display:"inline-block"}),_this},_this.isVisible=function(){return _this.visible},_this.setLabel=label=>{_this.label=label,_this.state.set("label",label)},_this.setDescription=function(desc){console.log("description: "+desc),_this.label.attr("title",desc)};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()}),(_=>{UILControl.infoIcon='<span><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9 9a3 3 0 016 1c0 2-3 3-3 3M12 17h0"/></svg></span>'})),Class((function UILControlButton(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlButton",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group",_type:"div",refName:"unnamed",children:[{htmlFor:"$state.groupId",_type:"label",_innerText:"$state.label",refName:"componentLabel",children:[]},{id:"$state.groupId",className:"content",_type:"div",refName:"unnamed",children:[{view:"UILInputButton",data:"$data",_type:"ViewState",refName:"unnamed",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),_this.state.set("groupId",`${_this.params.id}-group`),_this.data=new StateArray(_this.params.options.actions),_this.init(_this.params.id,_this.params.options),_this.params.options.hideLabel&&(_this.element.classList().add("hide-label"),_this.componentLabel.classList().add("visibility-hidden")),_this.setTitle=title=>{_this.data.forEach((button=>{button.title=title}))},_this.element.goob("\n    .button {\n        width: 100%;\n    }\n\n    &.hide-label {\n        .form-group,\n        .content {\n            width: 100%;\n            max-width: 100% !important;\n        }\n\n    }\n    \n    .UILInputButton + .UILInputButton {\n        margin-top: 2px;\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControlCheckbox(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlCheckbox",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){function handleChecked(isChecked){_this.checkboxInput.div.checked=isChecked,isChecked?_this.checkboxInput.div.setAttribute("checked",_this.value):_this.checkboxInput.div.removeAttribute("checked")}function handleClick(){_this.value=!_this.value,_this.state.set("isChecked",_this.value),_this.finish()}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group",_type:"div",refName:"unnamed",children:[{id:"$state.labelId",className:"label",_type:"div",_innerText:"$state.label",refName:"unnamed",children:[]},{className:"checkbox",_type:"div",refName:"unnamed",children:[{type:"checkbox",id:"$state.id",ariaLabelledBy:"$state.labelId",checked:"$state.isChecked",_type:"input",refName:"checkboxInput",children:[]},{htmlFor:"$state.id",_type:"label",_innerText:"$state.label",refName:"checkboxLabel",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),_this.init(_this.params.id,_this.params.options),function initListeners(){_this.checkboxInput.click(handleClick)}(),_this.onInit=()=>{_this.state.set("labelId",`${_this.id}-label`),_this.state.set("isChecked",_this.params.options?.value),_this.state.bind("isChecked",handleChecked)},_this.element.goob("\n    & {\n        width: 50%;\n        \n        > .label, .content {\n            display: none;\n        }\n    }\n\n    .form-group > *:last-child {\n        width: auto;\n    }\n\n    .UILControlCheckbox:nth-of-type(even) {\n        padding-left: calc(var(--spacing-small) / 2);\n    }\n\n    .UILControlCheckbox:nth-of-type(odd) {\n        padding-right: calc(var(--spacing-small) / 2);\n    }\n\n\n"),_this.update=()=>{_this.state.set("isChecked",_this.value)};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControlColor(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlColor",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){function onColorInput(){_this.state.set("value",_this.colorInput.div.value),Utils.debounce(_this.finish,200)}function onTextInput(){_this.state.set("value",_this.textInput.div.value),Utils.debounce(_this.finish,200)}function onTextClick(){_this.textInput.div.focus(),_this.textInput.div.select()}function finishChange(){_this.finish()}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group UIL",_type:"div",refName:"unnamed",children:[{_type:"label",_innerText:"$state.label",refName:"unnamed",children:[]},{className:"color-input",_type:"div",refName:"unnamed",children:[{className:"color-selector",_type:"div",refName:"unnamed",children:[{_type:"label",refName:"unnamed",children:[{className:"color-chip",_type:"div",refName:"colorChip",children:[]}]},{className:"color-text no-style",type:"text",_type:"input",refName:"textInput",children:[]},{id:"color",name:"color",type:"color",className:"color-box hidden",_type:"input",refName:"colorInput",children:[]}]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),_this.state.set("value",_this.params.options.value),_this.state.bind("value",_this.textInput),_this.bindState(_this.state,"value",(function handleColorState(color){_this.setValue(_this.state.value),function updateUI(){_this.colorChip.div.style.backgroundColor=_this.state.get("value"),_this.colorInput.div.value=_this.state.get("value")}()})),_this.colorInput.div.value=_this.params.options.value,_this.init(_this.params.id,_this.params.options),function initListeners(){_this.colorInput.div.addEventListener("input",onColorInput,!1),_this.colorInput.div.addEventListener("blur",finishChange,!1),_this.textInput.div.addEventListener("input",onTextInput,!1),_this.textInput.div.addEventListener("click",onTextClick,!1),_this.textInput.div.addEventListener("blur",finishChange,!1)}(),_this.update=function(){_this.state.set("value",_this.value)},_this.onDestroy=function(){_this.colorInput.div.removeEventListener("input",onInput,!1),_this.colorInput.div.removeEventListener("blur",finishChange,!1)},_this.element.goob("\n    & {}\n\n    #color {\n        cursor: pointer;\n    }\n\n    .color-box {\n        max-width: 35px;\n    }\n\n    .color-text {\n        -webkit-appearance: none;\n                appearance: none;\n        margin: 0;\n        border: 0;\n        outline: 0;\n        font: var(--label2);\n        color: var(--font-color-highlight);\n        background: transparent;\n        position: absolute;\n        width: 100%;\n        height: 100%;\n        top: 0;\n        left: 0;\n        padding: 0 0 0 37px;\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControlFile(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlFile",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group",_type:"div",refName:"unnamed",children:[{id:"$state.id",_type:"label",_innerText:"$state.label",refName:"unnamed",children:[]},{className:"content",_type:"div",refName:"unnamed",children:[{title:"$state.fileUrl",_type:"div",refName:"previewImage",children:[]},{type:"text",id:"geometry-text-input",ariaLabelledBy:"$state.id",placeholder:"$state.placeholder",_type:"input",refName:"inputText",children:[]},{type:"file",id:"$state.inputFileId",ariaLabelledBy:"$state.id",_type:"input",refName:"inputFile",children:[]},{_type:"button",_innerText:"Select File",refName:"inputButton",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),_this.state.set("inputFileId",_this.params.id+"-inputFile"),_this.state.set("inputTextId",_this.params.id+"-inputText"),_this.state.set("placeholder",_this.params.options.relative);const ogValues={src:_this.params.options.src||"",relative:_this.params.options.relative||"",prefix:_this.params.options.prefix||"",filename:_this.params.options.filename||""};function togglePreviewImage(){_this.state.hasFile?_this.previewImage.show():_this.previewImage.hide()}function setPreviewImage(){_this.element.div.style.setProperty("--preview-background",`url(${_this.state.get("fileUrl")})`)}async function inputFileChange(event){let file=event.target.files[0];_this.state.set("hasFile",!0),_this.value.filename=file.name,_this.value.relative=function getRelative(){return _this.inputText.div.value.includes(_this.value.prefix)?_this.inputText.div.value.replace(_this.value.prefix,""):_this.inputText.div.value}(),_this.value.src=function getSrc(){return _this.value.filename&&_this.value.filename.includes("http")?_this.value.filename:`${_this.value.prefix?_this.value.prefix+"/":""}${_this.value.relative?_this.value.relative+"/":""}${_this.value.filename}`}(),_this.finish()}async function inputTextChange(event){event.target.value&&(_this.inputText.val().includes(["World","SceneLayout"]),_this.value={src:"",relative:_this.inputText.val(),prefix:"",filename:""},_this.finish())}_this.value=Object.assign({},ogValues),_this.inputFile.classList().add("sr-only"),_this.inputButton.classList().add("small"),_this.init(_this.params.id,_this.params.options),togglePreviewImage(),function toggleTextInput(){_this.inputText.show()}(),function initListeners(){_this.inputButton.click((()=>_this.inputFile.div.click())),_this.inputFile.bind("change",inputFileChange),_this.inputText.bind("change",inputTextChange),_this.bindState(_this.state,"fileUrl",setPreviewImage),_this.bindState(_this.state,"hasFile",togglePreviewImage)}(),_this.onInit=()=>{_this.value&&_this.value.src&&(_this.state.set("hasFile",!0),_this.state.set("fileUrl",_this.value.src),_this.inputText.div.value=_this.value.filename)},_this.force=function(value,isClipboard){},_this.onDestroy=function(){},_this.element.goob("\n    & {}\n\n    .path {\n        margin-bottom: var(--spacing-small);\n    }\n\n    .content {\n        display: flex;\n        flex-direction: column;\n        gap: var(--spacing-small);\n    }\n\n    .previewImage {\n        background-image: var(--preview-background);\n        background-size: cover;\n        background-position: center;\n        background-repeat: no-repeat;\n        width: 100%;\n        aspect-ratio: 16 / 9;\n        display: none;\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControlImage(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlImage",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){function openFilePicker(){new UILExternalFilePicker(filePickerSelected,"textures")}function filePickerSelected(value){console.log("file selected: "+value),window.UIL_REMOTE&&console.warn("UIL_REMOTE is not supported when using file picker!");const v={compressed:!1,filename:value.split("/").last(),prefix:"assets/images",relative:"assets/images",src:`assets/images/${value}`};_this.force(v,!0),_this.finish()}async function supportsKtx2(){if(void 0===Dev.supportsKtx2)try{await Dev.execUILScript("compressktx2",{options:["--help"],output:"",src:[]}),Dev.supportsKtx2=!0}catch(e){console.log("%cKTX2 support not found in this project%c. 💁‍️ See https://www.notion.so/a91bbc09b19d4475bfc5bcb8d6048d70 for upgrade instructions","background-color: #ffde7b","background-color: unset"),Dev.supportsKtx2=!1}return Dev.supportsKtx2}async function compressKtx2(){let result,path=_this.value.src.split("?")[0];if(_this.params.options.compressOptions?.cube){_this.compress.bg("#fdb460").html("Cubemap");let[output,src]=function parseCubePaths(path){let info=Utils3D.splitCubemapPath(path),src=Utils3D.getCubemapFacePaths(info);return[`${info.prefix}.ktx2`,src]}(path);result=await Dev.execUILScript("compressktx2",{options:["--genmipmap","--encode","etc1s","--cubemap"],output:output,src:src})}else{let noext=function removeImageExtension(filename){const lastDotIndex=filename.lastIndexOf(".");return-1!==lastDotIndex?filename.substring(0,lastDotIndex):filename}(path.split("/").last()),folder=function getFolderPath(url){return(url=url.split("/")).last().includes(".")&&url.pop(),url.join("/")}(path);result=await Dev.execUILScript("compressktx2",{options:["--genmipmap","--encode","etc1s"],output:`${folder}/${noext}.ktx2`,src:[path]})}return"Error"!==result}async function compressClick(){if(!_this.value.src||_this.flag("compressPending"))return;_this.flag("compressPending",!0),_this.compress.bg("#f4ee42").text("---");let success=!1;try{if(await supportsKtx2())success=await compressKtx2();else{"Error"!==await Dev.execUILScript("compressktx",{src:_this.value.src.split("?")[0]})&&(success=!0)}}catch(e){console.error(e)}success?_this.compress.bg("#46f441").html("Success"):_this.compress.bg("#f44141").html("Failed"),_this.flag("compressPending",!1),_this.finish()}async function checkChange(){let compressed=!!_this.check.div.checked;compressed&&await supportsKtx2()&&(compressed="ktx2"),_this.value.compressed=compressed,_this.value.useCompressed=!!compressed,_this.finish()}async function change(){let file=_this.picker.div.files[0];if(!file)return;let name=file.name;if(window.UIL_REMOTE){const{customMetadata:customMetadata}=await UILStorage.uploadFileToRemoteBucket({file:file,progress:_this.progress});name=customMetadata.path}_this.value.filename=name,_this.value.relative=function getRelative(){return _this.value.filename.includes("http")?"":_this.value.relative.includes(_this.value.prefix)?_this.value.relative.replace(`${_this.value.prefix}`,""):_this.value.relative}(),_this.value.src=function getSrc(){return _this.value.filename.includes("http")?_this.value.filename:`${_this.value.prefix?_this.value.prefix+"/":""}${_this.value.relative?_this.value.relative+"/":""}${_this.value.filename}`}(),_this.value.compressed=!!_this.check.div.checked,_this.value.useCompressed=_this.value.compressed;let compressed=!!_this.check.div.checked;compressed&&await supportsKtx2()&&(compressed="ktx2"),_this.value.compressed=compressed,_this.value.useCompressed=!!compressed,await function imageExists(url){return!!url.includes("http")||(url=Assets.getPath(url),fetch(url).then((e=>404!=e.status)).catch((e=>console.warn("UILControlImage image url validation failed",e))))}(_this.value.src)?(_this.value=Object.assign({},_this.value),_this.picker.div.value="",_this.picker.attr("title",_this.value.src),_this.img.css({backgroundImage:`url(${Assets.getPath(_this.value.src)})`}),_this.delete.show(),_this.finish()):(_this.picker.div.value="",console.warn("UIL: Could not find image",_this.value),alert(`"${_this.value.src}" not found!\nMake sure "relative path" is correct.`))}function deleteImage(){_this.value={src:"",relative:"",prefix:"assets/images",filename:"",useCompressed:!1},_this.input.div.value="",_this.picker.div.value="",_this.picker.attr("title",null),_this.img.css({backgroundImage:""}),_this.delete.hide(),_this.value=Object.assign({},_this.value),_this.finish()}function inputChange(){_this.value.relative=_this.input.div.value}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group",_type:"div",refName:"unnamed",children:[{htmlFor:"image",_type:"label",_innerText:"$state.label",refName:"unnamed",children:[]},{type:"text",className:"path",_type:"input",refName:"input",children:[]}]},{className:"wrapper",_type:"div",refName:"unnamed",children:[{className:"preview",_type:"div",refName:"unnamed",children:[{_type:"div",refName:"img",children:[]},{className:"picker",type:"file",id:"imageFile",accept:"image/*",_type:"input",refName:"picker",children:[]},{className:"progress",_type:"div",refName:"unnamed",children:[]},{_type:"button",refName:"delete",children:[{width:10,height:10,viewBox:"0 0 10 10",fill:"none",stroke:"currentColor",xmlns:"http://www.w3.org/2000/svg",_type:"svg",refName:"unnamed",children:[{strokeWidth:2,strokeLinecap:"round",d:"M2 2l6 6M2 8l6-6",_type:"path",refName:"unnamed",children:[]}]}]},{className:"copy",_type:"div",_innerText:"Drag and drop your file here",refName:"unnamed",children:[]}]},{className:"preview-controls",_type:"div",refName:"unnamed",children:[{className:"control-button small",_type:"button",_innerText:"Browse Assets",refName:"browseButton",children:[]},{className:"control-button small",_type:"button",_innerText:"Compress",refName:"compress",children:[]},{className:"checkbox-control",htmlFor:"$state.compressedInput",_type:"label",refName:"unnamed",children:[{className:"regular-checkbox",type:"checkbox",name:"$state.compressedInput",id:"$state.compressedInput",_type:"input",refName:"check",children:[]},{_type:"span",_innerText:"Use Compressed",refName:"unnamed",children:[]}]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),_this.state.set("compressedInput",`${_this.params.id}-compressed`),_this.params.options.value=Object.assign({src:"",relative:_this.params.options.relative||"",prefix:_this.params.options.prefix,filename:"",useCompressed:!1},_this.params.options.value),_this.value=Object.assign({},_this.params.options.value),_this.init(_this.params.id,_this.params.options),_this.check.div.checked=_this.params.options.value.useCompressed,_this.value.relative?_this.input.div.value=_this.value.relative:_this.input.attr("placeholder","Relative Path"),_this.delete.hide(),_this.value.src&&_this.img.css({backgroundImage:`url('${Assets.getPath(_this.value.src)}')`}),function initListeners(){_this.picker.div.addEventListener("change",change,!1),_this.input.div.addEventListener("change",inputChange,!1),_this.browseButton.click(openFilePicker),_this.delete.div.onclick=deleteImage,_this.compress.div.onclick=compressClick,_this.check.div.onchange=checkChange}(),_this.force=async function(value,isClipboard){_this.value=Object.assign({},value),_this.input.div.value=_this.value.relative,_this.picker.div.value="",_this.picker.attr("title",_this.value.src),console.log(value),_this.img.css({backgroundImage:`url('${Assets.getPath(_this.value.src)}')`}),_this.check.div.checked=_this.value.compressed;let compressed=!!_this.check.div.checked;compressed&&await supportsKtx2()&&(compressed="ktx2"),_this.value.compressed=compressed,_this.value.useCompressed=!!compressed},_this.onDestroy=function(){_this.picker.div.removeEventListener("change",change,!1),_this.input.div.removeEventListener("change",inputChange,!1)},_this.element.goob("\n    & {}\n\n    .form-group {\n        margin-bottom: var(--spacing-small);\n    }\n\n    .picker {\n        &:focus {\n            .img {\n                border-color: var(--color-accent-80);\n            }\n        }\n    }\n\n    .wrapper {\n        display: flex;\n        gap: var(--spacing-small);\n    }\n\n    .preview {\n        width: 160px;\n        height: 128px;\n        box-sizing: border-box;\n        position: relative;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        overflow: hidden;\n        flex-shrink: 0;\n    }\n\n    .img {\n        width: 100%;\n        height: 100%;\n        position: absolute;\n        inset: 0px;\n        background-size: cover;\n        background-repeat: no-repeat;\n        background-position: center center;\n        border: 1px dotted var(--color-neutral-40);\n        text-align: center;\n    }\n\n    .picker {\n        position: absolute;\n        opacity: 0;\n        inset: 0px;\n    }\n\n    .progress {\n        position: absolute;\n        bottom: 0px;\n        height: 10px;\n        left: 0px;\n        background: rgb(155, 156, 155);\n    }\n\n    .copy {\n        color: var(--color-neutral-80);\n        font: var(--label2);\n        padding: var(--spacing-small);\n        text-align: center;\n    }\n\n    .control-button {\n        margin-bottom: calc(var(--spacing-small) / 2);\n        width: 100%;\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControlNumber(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlNumber",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group",_type:"div",refName:"unnamed",children:[{id:"$state.labelId",_type:"label",_innerText:"$state.label",refName:"unnamed",children:[]},{view:"UILInputNumber",data:"$data",_type:"ViewState",refName:"unnamed",children:[]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),_this.state.set("labelId",`${_this.params.id}-label`),_this.data=Data.request(`vectorInputData-${_this.params.id}`,(()=>[{id:_this.params.id,value:_this.params.options.value||0,labelledBy:_this.state.labelId,min:_this.params.options.min||-1/0,max:_this.params.options.max||1/0,step:_this.params.options.step||1,precision:_this.params.options.precision||3,onInputCB:value=>function onInput(value){_this.setValue(Number(value)),_this.data[value]=value}(value),onFinishCB:()=>function onFinish(){_this.finish()}()}])),_this.init(_this.params.id,_this.params.options),_this.update=function(){_this.data.forEach((input=>{input.value=_this.value}))};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControlRange(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlRange",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){function change(){_this.finish()}function input(){_this.value=Number(_this.slider.div.value)}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group",_type:"div",refName:"unnamed",children:[{htmlFor:"$state.id",_type:"label",_innerText:"$state.label",refName:"unnamed",children:[]},{type:"range",id:"$state.id",min:"$props.min",max:"$props.max",step:"$props.step",_type:"input",refName:"slider",children:[]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.props={min:0,max:100,step:1},_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),Object.assign(_this.props,_this.params.options),_this.init(_this.params.id,_this.params.options),_this.slider.div.value=_this.params.options.value||"",function initListeners(){_this.slider.div.addEventListener("change",change,!1),_this.slider.div.addEventListener("input",input,!1)}(),_this.force=function(value){_this.value=value,_this.slider.div.value=value,_this.finish(!1)},_this.onDestroy=function(){_this.slider.div.removeEventListener("change",change,!1),_this.slider.div.removeEventListener("input",input,!1)},_this.element.goob("\n    & {}\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControlSelect(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlSelect",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group",_type:"div",refName:"unnamed",children:[{htmlFor:"$state.id",_type:"label",_innerText:"$state.label",refName:"selectLabel",children:[]},{className:"select-wrapper",_type:"div",refName:"unnamed",children:[{id:"$state.id",_type:"select",refName:"select",children:[]},{className:"arrow",_type:"div",_innerText:" ▼ ",refName:"unnamed",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),!_this.params.options.options)throw"UILControlSelect is missing select options";function change(){_this.finish()}function input(){let i=_this.select.div.selectedIndex;_this.value=_this.selectOptions[i].value}_this.params.options.value=_this.params.options.value||_this.params.options.options[0].value,function initOptions(){_this.selectOptions=_this.params.options.options.map((({value:value,label:label})=>{const el=document.createElement("option");return el.setAttribute("value",value),_this.value===value&&el.setAttribute("selected",!0),el.text=label||value,el.value=value,_this.select.add(el),el}))}(),function initListeners(){_this.select.div.addEventListener("change",change,!1),_this.select.div.addEventListener("input",input,!1)}(),_this.init(_this.params.id,_this.params.options),_this.select.div.value=_this.params.options.value,_this.force=function(value){_this.select.div.value=value,_this.value=value},_this.onDestroy=function(){_this.select.div.removeEventListener("change",change,!1),_this.select.div.removeEventListener("input",input,!1)},_this.element.goob("\n    .select-wrapper {\n        position: relative;\n    }\n\n    .arrow {\n        color: var(--color-neutral-70);\n        font-size: 7px;\n        position: absolute;\n        right: var(--spacing-small);\n        top: 15px;\n        pointer-events: none;\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControlText(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlText",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){function onChange(){clearTimeout(_this.timeout),_this.timeout=setTimeout(onFinishChange,400),_this.value=_this.textInput.div.value}function onFinishChange(){null!==_this.timeout&&(clearTimeout(_this.timeout),_this.timeout=null,_this.finish())}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group",_type:"div",refName:"unnamed",children:[{htmlFor:"$state.id",_type:"label",_innerText:"$state.label",refName:"textInputLabel",children:[]},{type:"text",id:"$state.id",_type:"input",refName:"textInput",children:[]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),function initListeners(){_this.textInput.div.addEventListener("input",onChange,!1),_this.textInput.div.addEventListener("change",onFinishChange,!1)}(),_this.init(_this.params.id,_this.params.options),_this.textInput.div.value=_this.params.options.value||"",_this.update=function(){_this.textInput.div.value=_this.value||""},_this.onDestroy=function(){_this.textInput.div.removeEventListener("input",onChange,!1),_this.textInput.div.removeEventListener("change",onBlur,!1)};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControlTextarea(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlTextarea",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){let _timeout;function onChange(){clearTimeout(_timeout),_timeout=setTimeout(onFinishChange,400),_this.value=_this.textareaInput.div.value}function onFinishChange(){null!==_timeout&&(clearTimeout(_timeout),_timeout=null,_this.finish())}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group",_type:"div",refName:"unnamed",children:[{htmlFor:"$state.id",title:"$state.label",_type:"label",_innerText:"$state.label",refName:"unnamed",children:[]},{type:"text",id:"$state.id",maxLength:"$props.max",minLength:"$props.min",rows:"$props.rows",readOnly:"$props.readonly",_type:"textarea",refName:"textareaInput",children:[]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.props={max:1/0,min:-1/0,rows:2,readonly:!1},_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),Object.assign(_this.props,_this.params.options),_this.init(_this.params.id,_this.params.options),_this.textareaInput.div.value=_this.params.options.value||"",function initListeners(){_this.textareaInput.div.addEventListener("input",onChange,!1),_this.textareaInput.div.addEventListener("change",onFinishChange,!1)}(),_this.update=function(){_this.textareaInput.div.value=_this.value||""},_this.onDestroy=function(){_this.textareaInput.div.removeEventListener("input",onChange,!1),_this.textareaInput.div.removeEventListener("change",onFinishChange,!1)},_this.element.goob("\n    .textareaInput {\n        font-family: Consolas, monaco, monospace;\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILControlVector(_params,...restArgs){const _this=this;Inherit(_this,UILControl),Inherit(_this,XComponent),_this.fragName="UILControlVector",_this.contexts="UILControl",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"form-group",_type:"div",refName:"unnamed",children:[{id:"$state.labelId",_type:"label",_innerText:"$state.label",refName:"unnamed",children:[]},{className:"number-inputs",_type:"div",refName:"unnamed",children:[{view:"UILInputNumber",data:"$inputData",_type:"ViewState",refName:"unnamed",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}),_this.state.set("id",_this.params.id),_this.state.set("labelId",`${_this.params.id}-label`),_this.inputData=await Data.request(`vectorInputData-${_this.params.id}`,(()=>_this.params.options.value.map(((value,index)=>({value:value||0,labelledBy:_this.state.labelId,min:_this.params.options.min||-1/0,max:_this.params.options.max||1/0,step:_this.params.options.step||1,precision:_this.params.options.precision||3,onInputCB:(v,m)=>function onInput(value,index,master){master?_this.vector=_this.vector.map((v=>value)):_this.vector[index]=value;_this.setValue([..._this.vector]),_this.inputData.forEach(((input,idx)=>{input.value=_this.vector[idx]}))}(v,index,m),onFinishCB:()=>function onFinish(){_this.finish()}(),index:index}))))),_this.vector=[],_this.params.options.value)_this.length=_this.vector.length;else{if(!_this.params.options.components)throw'UILControlVector: Cannot detect vector type. Define "options.components" count or init with a initial value';_this.params.options.value=new Array(_this.params.options.components).fill(0)}_this.length=_this.params.options.value.length,_this.init(_this.params.id,_this.params.options),_this.vector=[..._this.value],_this.update=function(){_this.inputData.forEach(((input,index)=>{input.value=_this.value[index]}))},_this.element.goob("\n    .number-inputs {\n        display: flex;\n        gap: calc(var(--spacing-small) / 2);\n    }\n"),_this.force=function(value,history=!1){_this.vector=[...value],_this.setValue([..._this.vector]),_this.inputData.forEach(((input,index)=>input.value=_this.value[index])),_this.finish(history)};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILFolder(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILFolder",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"a",refName:"header",children:[{htmlFor:"$state.label",_type:"label",_innerText:"$state.label",refName:"unnamed",children:[]},{_type:"div",_innerText:"☰",refName:"drag",children:[]}]},{_type:"div",refName:"container",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.params.options||(_this.params=Object.assign({},{id:_this.params},{options:restArgs[0]}));let _children={},_open=!_this.params.options.closed,_visible=!0,_order=[],_draggable=!1,_sortableChildren=!1,_headerDrag=!1,_hasClipboard=!1;_this.params.id;function removeDragHandlers(){_this.element.div.removeEventListener("dragstart",dragStart,!1),_this.element.div.removeEventListener("dragover",dragOver,!1),_this.element.div.removeEventListener("drop",drop,!1)}function onToggle(event){_this.state.open?_this.close():_this.open(),_this.state.open?_this.header.div.focus():_this.header.div.blur()}function onMouseDown(event){_headerDrag=!0,_this.header.div.addEventListener("mouseup",onMouseUp)}function onMouseUp(event){_headerDrag=!1,_this.header.div.removeEventListener("mouseup",onMouseUp)}function onKeydown(event){event.preventDefault(),13===event.which&&(_open?close():open())}function onKeyup(event){event.preventDefault(),_hasClipboard&&("c"==event.key&&event.metaKey?function onCopy(){UILClipboard.copy(_children)}():"v"==event.key&&event.metaKey&&function onPaste(){UILClipboard.paste(_children)}())}function onFocus(){_this.element.div.classList.add("active"),_hasClipboard=!0}function onBlur(){_this.element.div.classList.remove("active"),_hasClipboard=!1}function matchItem(str,item){return UILFuzzySearch.search(str,item.id.toLowerCase())||UILFuzzySearch.search(str,item.label.toLowerCase())}function dragStart(e){if(!UILFolder.DragLock){if(!_headerDrag)return e.preventDefault(),void e.stopPropagation();UILFolder.DragLock=_this.state.id,e.dataTransfer.setData("text/plain",_this.state.id),e.dataTransfer.effectAllowed="move",_this.element.css({opacity:.5})}}function dragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function drop(e){if(!UILFolder.DragLock)return;if(e.dataTransfer.items)for(var i=0;i<e.dataTransfer.items.length;i++)if("file"===e.dataTransfer.items[i].kind)return;e.preventDefault(),_headerDrag=!1;let target=e.currentTarget._this,dragging=_this.parent.getChildById(UILFolder.DragLock);UILFolder.DragLock=null,target&&target.parent&&dragging&&(dragging.element.css({opacity:1}),dragging.parent.getChildById(target.id)&&(e.stopPropagation(),target.parent.container.div.insertBefore(dragging.element.div,target.element.div),_order=[...target.parent.container.div.childNodes].map((el=>el._this.id)),_this.events.fire(UIL.REORDER,{order:[..._order]}),function saveSort(){UILStorage.set(`UIL_${UIL.sortKey}_${_this.parent.id}_order`,JSON.stringify(_order))}()))}function getUrlID(){return`${Global.PLAYGROUND||"Global"}_folder_${_this.state.id}`}function saveFolderState(){sessionStorage.setItem(getUrlID(),JSON.stringify({open:_this.state.open}))}_this.id=_this.params.id,_this.label=_this.params.options.label||_this.params.id,_this.level=-1,_this.createState(),_this.state.set("id",_this.params.id),_this.state.set("label",_this.params.options.label||_this.params.id),_this.state.set("open",!_this.params.options.closed),_this.params.options.hideTitle&&_this.header.classList().add("hide-title"),_this.element.css({maxHeight:_this.params.options.maxHeight||"none"}),_this.element.attr("data-id",_this.params.id),_this.element.attr("data-type","UILFolder"),_this.element.div._this=_this,_this.onInit=()=>{!function restoreFolderState(){let json=JSON.parse(sessionStorage.getItem(getUrlID()));json?json.open?_this.open():_this.close():_this.open()}()},_this.onMounted=()=>{_this.flag("isReady",!0)},_this.ready=_=>_this.wait("isReady"),function initListeners(){_this.header.div.addEventListener("keydown",onKeydown,!1),_this.header.div.addEventListener("click",onToggle,!1),_this.header.div.addEventListener("mousedown",onMouseDown),_this.header.div.addEventListener("focus",onFocus,!1),_this.header.div.addEventListener("blur",onBlur,!1),_this.header.div.addEventListener("keydown",onKeyup,!1)}(),_this.add=async function(child){return await _this.wait((()=>_this.ready)),await defer(),child.draggable&&child.draggable(_sortableChildren),child.parent=_this,_children[child.id]=child,_this.container.add(child),_this},_this.remove=function(x){},_this.getChildById=function(id){return _children[id]},_this.getAll=function(){},_this.getVisible=function(){return Object.values(_children).filter((x=>x.isVisible()))},_this.find=function(id){return id===_this.id?_this:Object.values(_children).reduce(((acc,item)=>item.id===id?acc.concat(item):item instanceof UILFolder?acc.concat(item.find(id)):acc),[])},_this.filter=function filter(str,match=!1){str=str.toLowerCase();let result=[],haystack=Object.values(_children);for(let el of haystack)if(el instanceof UILFolder){let matches=el.filter(str,!0);matches.length?(result.concat(matches),el.show(),el.open()):matchItem(str,el)?(result.push(el),el.show(),el.showChildren(),el.close()):el.getVisible().length?el.show():el.hide()}else matchItem(str,el)?(result.push(el),el.show()):el.hide();return result},_this.filterSingle=function filterSingle(str){str=str.toLowerCase();let haystack=Object.values(_children);for(let el of haystack)el instanceof UILFolder?(el.filterSingle(str),str==el.state.label.toString().toLowerCase()||str==el.state.id.toString().toLowerCase()?(el.show(),el.showChildren(),el.open(!0)):el.getVisible().length?el.show():el.hide()):matchItem(str,el)?(el.show(),el.state.open&&el.open(!0)):el.hide();return[]},_this.open=function(keepClosed=!1){if(_this.element)return _this.state.set("open",!0),_this.element.classList().add("open"),_open=!0,1!=keepClosed&&_this.forEachFolder((f=>f.close())),saveFolderState(),_this.onOpen&&_this.onOpen(),_this},_this.close=function(){_this.state.set("open",!1),_this.element.classList().remove("open"),_open=!1,saveFolderState()},_this.setLabel=function(label){_this.state.set("label",label)},_this.hide=function(){if(_this.element)return _visible=!1,_this.element.css({display:"none"}),_this},_this.show=function(){if(_this.element)return _visible=!0,_this.element.css({display:"block"}),_this},_this.showChildren=function(){return Object.values(_children).forEach((el=>el instanceof UILFolder?el.showChildren():el.show())),_this.show(),_this},_this.isOpen=function(){return _open},_this.isVisible=function(){return _visible},_this.forEachFolder=function(cb){return Object.values(_children).forEach((el=>{el instanceof UILFolder&&(cb(el),el.forEachFolder(cb))})),_this},_this.forEachControl=function(cb){return Object.values(_children).forEach((el=>{el instanceof UILFolder?el.forEachControl(cb):cb(el)})),_this},_this.enableSorting=function(key){_sortableChildren=!0,UIL.sortKey=key,Object.values(_children).forEach((el=>{el instanceof UILFolder&&el.draggable(!0)}));let order=function getSort(){let sort=UILStorage.get(`UIL_${UIL.sortKey}_${_this.id}_order`);if(sort)return JSON.parse(sort)}();return order&&(_order=order,function restoreSort(){_order.forEach((id=>{_children[id]&&_this.container.add(_children[id])}))}()),_this},_this.draggable=function(enable){_draggable=enable,_this.element.attr("draggable",enable),enable?(!function addDragHandlers(){_this.element.div.addEventListener("dragstart",dragStart,!1),_this.element.div.addEventListener("dragover",dragOver,!1),_this.element.div.addEventListener("drop",drop,!1)}(),_this.drag&&_this.drag.show()):(removeDragHandlers(),_this.drag&&_this.drag.hide())},_this.toClipboard=function(){UILClipboard.copy(_children)},_this.fromClipboard=function(){UILClipboard.paste(_children)},_this.eliminate=function(){_this.params.options.hideTitle||(_this.header.div.removeEventListener("keydown",onToggle,!1),_this.header.div.removeEventListener("click",onToggle,!1),_this.header.div.removeEventListener("mousedown",onMouseDown),_this.header.div.removeEventListener("focus",onFocus,!1),_this.header.div.removeEventListener("blur",onBlur,!1)),_draggable&&removeDragHandlers()},_this.forceSort=function(index){_this.parent.container.div.insertBefore(_this.element.div,_this.parent.container.div.children[index]),_order=[..._this.parent.container.div.childNodes].map((el=>el._this.state.id)),_this.events.fire(UIL.REORDER,{order:[..._order]})},_this.openChildren=function(){Object.values(_children).forEach((el=>el instanceof UILFolder?el.open():null))},_this.onToggle=onToggle,UIL.addCSS(UILFolder,"\n    .UILFolder .UILFolder .UILFolder .header { \n        padding-left: calc(var(--left-padding) + var(--spacing-small)); \n    }\n    .UILFolder .UILFolder .UILFolder .header:before {\n        left: calc(var(--spacing-small) * 2);\n    }\n\n    .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .header {\n        padding-left: calc(var(--left-padding) + var(--spacing-small) * 3); \n    }\n    .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .header:before {\n        left: calc(var(--spacing-small) * 3);\n    }\n\n    .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .header {\n        padding-left: calc(var(--left-padding) + var(--spacing-small) * 4); \n    }\n    .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .header:before {\n        left: calc(var(--spacing-small) * 4);\n    }\n\n    .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .header {\n        padding-left: calc(var(--left-padding) + var(--spacing-small) * 5); \n    }\n    .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .header:before {\n        left: calc(var(--spacing-small) * 5);\n    }\n\n    .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .header {\n        padding-left: calc(var(--left-padding) + var(--spacing-small) * 6); \n    }\n    .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .header:before {\n        left: calc(var(--spacing-small) * 6);\n    }\n\n"),_this.element.goob("\n    & {\n        --left-padding: calc(var(--spacing) * 1.75);\n\n        background-color: var(--panel-background-color);\n        width: 100%;\n\n        &:has(> .header:focus) {\n            border: 1px solid var(--color-action--alt);\n        }\n        \n        &.open {\n            > .header:before {\n                transform: rotate(90deg);\n            }\n    \n            > .container {\n                display: block;\n            }\n        }\n    }\n\n    .header {\n        border-bottom: 1px solid var(--color-divider-main);\n        color: var(--color-white);\n        display: flex;\n        font: var(--label4);\n        padding: var(--spacing); \n        padding-left: var(--left-padding);\n        position: relative;\n        align-items: center;\n        text-decoration: none;\n        line-height: 1;\n        user-select: none;\n\n        &:hover {\n            outline: 1px solid var(--color-action--alt);\n        }\n\n        &:before {\n            content: '';\n            display: block;\n            width: 0;\n            height: 0;\n            border-color: transparent transparent transparent var(--color-icon-default);\n            border-style: solid;\n            border-width: 3px 0 3px 4px;\n            position: absolute;\n            left: var(--spacing-small);\n            transition: transform .3s ease-out;\n        }\n\n        &.hide-title {\n            display: none;\n        }\n    }\n\n    .container {\n        display: none;\n    }\n\n    .drag {\n        position: absolute;\n        right: 7px;\n        top: 8px;\n        display: inline-block;\n        pointerEvents: none;\n    }\n"),_this.listen("UILGraphLayout/destroy",(label=>{let name=label.split("-")[0];_this.label.includes(name)&&_this.element.hide()}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILGate(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILGate",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"UILGateLogin",refName:"login",children:[]},{_type:"UILGateError",refName:"error",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.views={login:_this.login,error:_this.error},_this.createState(),_this.bindState(_this.state,"updateView",(async function updateView(newView){_this.state.currentView&&await _this.views[_this.state.currentView].animateOut();_this.views[newView].animateIn(),_this.state.set("currentView",newView)})),_this.state.set("updateView","login"),_this.animateIn=function(){_this.element.tween({opacity:1},500,"easeOutCubic")},_this.animateOut=function(){_this.element.tween({opacity:0},500,"easeOutCubic").onComplete((()=>_this.destroy()))},_this.element.goob("\n    & {\n        background-color: var(--color-black);\n        position: absolute;\n        inset: 0;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        pointer-events: all;\n        opacity: 0;\n        z-index: 100001;\n    }\n\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILGateError(_params,...restArgs){const _this=this;Inherit(_this,UILGateView),Inherit(_this,XComponent),_this.fragName="UILGateError",_this.contexts="UILGateView",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){function goBack(){_this.parent.state.set("updateView","login")}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"gate",_type:"article",refName:"unnamed",children:[{className:"gate-header",_type:"header",refName:"unnamed",children:[{_type:"div",refName:"logo",children:[]},{className:"version",_type:"h1",_innerText:"UIL v2.3",refName:"unnamed",children:[]}]},{className:"gate-main",_type:"div",refName:"unnamed",children:[{className:"error",_type:"h2",_innerText:"Error",refName:"unnamed",children:[]},{_type:"p",_innerText:"You do not have access to this page",refName:"unnamed",children:[]}]},{className:"gate-footer",_type:"footer",refName:"unnamed",children:[{_type:"button",_innerText:"Go Back",refName:"backButton",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),function initListeners(){_this.backButton.click(goBack)}(),_this.logo.html(UILGate.logo),_this.element.goob("\n    & {\n        --logo-size: 25px;\n\n        opacity: 0;\n    }\n\n    .gate-header {\n        gap: var(--spacing);\n        justify-self: start;\n    }\n\n    .logo {\n        width: var(--logo-size);\n        height: var(--logo-size);\n    }\n\n    .error {\n        font-size: 64px;\n        font-weight: 300;\n        line-height: 1;\n        letter-spacing: 0.2rem;\n        margin: calc(var(--spacing) * 3) 0;\n    }\n\n    .gate-main {\n        font-size: 14px;\n        margin-bottom: calc(var(--spacing) * 3);\n    }\n\n    .gate-footer {\n        justify-self: start;\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILGateLogin(_params,...restArgs){const _this=this;Inherit(_this,UILGateView),Inherit(_this,XComponent),_this.fragName="UILGateLogin",_this.contexts="UILGateView",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){async function openLoginModal(){_this.loginButton.div.disabled=!0,_this.user=await UILRemote.auth.login(),_this.user.success?async function handleLogin(){await _this.animateOut(),_this.parent.animateOut(),window.location.reload()}():async function handleError(){_this.parent.state.set("updateView","error"),await _this.wait(500),_this.loginButton.div.disabled=!1}()}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"gate",_type:"article",refName:"unnamed",children:[{className:"gate-header",_type:"header",refName:"unnamed",children:[{className:"version",_type:"h1",_innerText:"UIL v2.3",refName:"unnamed",children:[]}]},{className:"gate-main",_type:"div",refName:"logoContainer",children:[]},{className:"gate-footer",_type:"footer",refName:"unnamed",children:[{_type:"button",_innerText:"Log in with Google",refName:"loginButton",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),function initListeners(){_this.loginButton.click(openLoginModal)}(),_this.logoContainer.html(UILGate.logo),_this.element.goob("\n    & {\n        --max-spacing: 240px;\n        --logo-size: 145px;\n        --dot-size: 4px;\n    }\n\n    .gate-header {\n        justify-content: space-between;\n        width: 100%;\n    }\n    \n    .version {\n        margin-bottom: 0;\n        position: relative;\n        width: 100%;\n\n        &:after {\n            background-color: var(--color-white);\n            content: '';\n            display: block;\n            width: var(--dot-size);\n            height: var(--dot-size);\n            border-radius: 50%;\n            position: absolute;\n            right: 0;\n            top: 3px;\n        }\n    }\n\n    .gate-main {\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        width: var(--logo-size);\n    }\n\n    .loginButton:disabled {\n        cursor: not-allowed !important;\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILGateView(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILGateView",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.element.hide(),_this.animateIn=function(){_this.element.css({opacity:0}).show().tween({opacity:1},500,"easeOutCubic")},_this.animateOut=function(){return _this.element.tween({opacity:0},500,"easeOutCubic").onComplete((()=>{_this.element.hide()})).promise()},_this.element.goob("\n    & {\n        opacity: 0;\n    }\n\n    .gate {\n        display: grid;\n        justify-items: center;\n        grid-template-rows: 1fr minmax(calc(var(--logo-size) + var(--spacing) * 2), calc(var(--logo-size) + var(--max-spacing))) 1fr;\n        max-height: 100%;\n    }\n\n    .gate-header {\n        display: flex;\n        align-items: center;\n    }\n\n    .version {\n        font: var(--label3);\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()}),(_=>{UILGate.logo='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 145 146">\n        <g fill="#F7F7F7" clip-path="url(#a)">\n            <path\n                d="M72.5.703C32.46.703 0 33.162 0 73.203c0 40.04 32.46 72.5 72.5 72.5 40.041 0 72.5-32.46 72.5-72.5 0-40.041-32.459-72.5-72.5-72.5Zm0 135.146c-34.6 0-62.646-28.047-62.646-62.646 0-34.6 28.047-62.647 62.646-62.647 34.6 0 62.646 28.047 62.646 62.647 0 34.599-28.046 62.646-62.646 62.646Z" />\n            <path\n                d="m89.002 42.766-26.976-.006-13.573 12.644s-4.06 4.033-7.464 7.523c-3.403 3.49-5.636 8.807-5.636 14.158 0 5.683 2.428 10.62 6.237 14.83a781.937 781.937 0 0 0 10.757 10.713c5.172 5.039 9.355 6.219 15.242 6.199 7.424-.025 11.03-3.311 13.602-5.638.911-.824 8.037-8.033 8.037-8.033l.01 13.651 12.903-12.551V55.903c0-8.16-5.208-13.333-13.14-13.141l.001.004Zm-.006 35.544S75.63 91.828 74.014 93.405c-2.029 1.979-3.812 2.507-6.22 2.507-2.406 0-3.64-.076-6.218-2.507-2.264-2.135-10.09-10.078-10.557-10.616-1.404-1.604-2.107-3.444-2.107-5.516 0-2.472.904-4.581 2.708-6.319l15.034-15.04L89 55.91l-.005 22.403.001-.002Z" />\n        </g>\n        <defs>\n            <clipPath id="a">\n                <path fill="#fff" d="M0 .703h145v145H0z" />\n            </clipPath>\n        </defs>\n    </svg>'})),Class((function UILGraph(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILGraph",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"div",refName:"wrapper",children:[{addTo:"$body",_type:"UILGraphContextMenu",refName:"contextMenu",children:[]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.body=__body;let _uniq=0;var _layouts={};UIL.sidebar&&UIL.sidebar.toolbar&&UIL.sidebar.toolbar.element.hide(),_this.onMounted=async function(){await _this.wait(1e3);const{x:x,y:y}=_this.element.div.getBoundingClientRect();_this.contextMenu.setOffset({x:x,y:y})},_this.add=function(_layout){_layouts[_layout.id]||(_layouts[_layout.id]=_layout,_this.element.add(_layout))},_this.getGraph=function(name,layoutInstance,isGL=!0){if(!UIL.sidebar)return;let _graph=new UILGraphLayout({name:name,layoutInstance:layoutInstance,isGL:isGL,uniq:_uniq++});return _this.add(_graph),_graph},_this.element.goob("\n    position:relative;\n    width: 100%;\n    height: auto;\n    user-select: none;\n    margin-bottom: 4px;\n    border-radius: 4px;\n    background-color: #161616;\n\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()}),"singleton",(()=>{UILGraph.FOCUSED="uilgraph_focused",UILGraph.BLURRED="uilgraph_blurred",UILGraph.GROUP_TYPE="uilgraph_group_type",UILGraph.LAYER_TYPE="uilgraph_layer_type",UILGraph.SPECIAL_TYPE="uilgraph_special_type",UILGraph.LAYOUT_TYPE="uilgraph_layout_type",UILGraph.OPEN_CONTEXT_MENU="uilgraph_open_context_menu",UILGraph.CLOSE_CONTEXT_MENU="uilgraph_close_context_menu",UILGraph.ACTION_DELETE="uilgraph_action_delete",UILGraph.ACTION_LAYER="uilgraph_action_layer",UILGraph.ACTION_GROUP="uilgraph_action_group",UILGraph.TREE_LAST="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAVAQMAAABFfO2wAAAABlBMVEUAAAC0tLQrlfMqAAAAAXRSTlMAQObYZgAAABFJREFUCNdjaGDAh/4fYMALACnuBsCqBlYuAAAAAElFTkSuQmCC')",UILGraph.TREE_GROUP="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAVAQMAAABFfO2wAAAABlBMVEUAAAC0tLQrlfMqAAAAAXRSTlMAQObYZgAAABFJREFUCNdjaGDAh/4fwK8AAHduC8BoO2AxAAAAAElFTkSuQmCC')",UILGraph.TREE_LAYER="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAVAQMAAABFfO2wAAAABlBMVEUAAAC0tLQrlfMqAAAAAXRSTlMAQObYZgAAAA1JREFUCNdjaGCgBAEAUE4KgSOykIMAAAAASUVORK5CYII=')",UILGraph.EYE_ICON='<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',UILGraph.CONFIG_ICON='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 219.9 261.5"><path d="M85.6,226.6c-1.7,1-9.2,1.2-28.7,0.9l-26.4-0.3l-6.7-3.2c-12.3-5.8-20.4-16-22.7-28.7C-0.3,187.7-0.4,41.8,1,33.4\n    c1.4-8.5,5-15.6,11-21.7C17.8,6,25.3,2,32.8,0.7C35.4,0.2,56.2-0.1,79,0c41.3,0.2,41.5,0.2,46,2.5c5.6,2.9,54.2,51,57.3,56.7\n    c2.1,3.8,2.2,5.3,2.5,36.2c0.3,31.3,0.2,32.3-1.7,34.2c-2.7,2.7-7.5,2.7-10.1,0.1c-1.9-1.9-2-3.4-2-29.3c0-14.9-0.5-29-1-31.1\n    c-0.7-3.3-4.6-7.7-24.7-27.8c-13.1-13.2-25-24.6-26.5-25.4c-2.2-1.1-9.9-1.4-42.6-1.4c-45.2,0-46.1,0.1-53.5,7.4\n    c-8,7.8-7.7,3.9-7.7,91.1c0,84.9-0.1,83.3,6.2,90.9c1.7,2.1,5.4,4.9,8.2,6.2c4.9,2.3,6,2.4,29.3,2.4c16,0,25.1,0.4,26.7,1.1\n    C90.3,216.1,90.5,224,85.6,226.6z M78,85.5c27.7-0.3,29.9-0.4,31.9-2.2c2.9-2.6,2.9-8.6,0-11.2c-2-1.8-4.2-1.9-32.3-2.1\n    c-24.3-0.2-30.7,0-33.3,1.1c-6,2.7-5.7,10.7,0.3,13.2C47.6,85.6,53.4,85.8,78,85.5z M43.8,131.2h47.5c45.3,0,47.6-0.1,49.6-1.9\n    c2.7-2.5,2.8-7.9,0.1-10.6c-1.9-1.9-3.3-2-49.3-2H44.3l-2.1,2.3c-2.7,2.9-2.8,6.7-0.3,9.8L43.8,131.2z M219.8,209.8\n    c-0.5,8.9-1.4,10.4-7.6,13c-2.7,1.2-4.2,2.4-3.8,3.2c1.9,4.6,2.8,8.9,2.3,10.9c-0.8,3.1-12.4,14.7-15.5,15.5\n    c-2,0.5-6.4-0.4-10.9-2.3c-0.6-0.3-2,1.3-3.1,3.8c-1,2.4-2.6,4.9-3.5,5.6c-2.2,1.9-15.3,2.7-20.5,1.3c-3.6-1-4.6-1.9-6.8-6.2\n    c-2-4-2.9-4.9-4.2-4.4c-5.7,2.4-7.1,2.7-9.5,2.1c-3.4-0.8-14.1-10.8-15.7-14.6c-1.1-2.5-1-3.7,0.4-7.3c0.9-2.3,1.6-4.6,1.6-4.9\n    c0-0.4-2-1.6-4.4-2.7c-6-2.6-7-4.9-7-15.8c-0.1-8.3,0.2-9.4,2.3-11.7c1.3-1.4,3.9-3,5.7-3.6c3.9-1.3,3.9-1.5,1.9-6.3\n    c-0.8-2-1.5-4.5-1.5-5.6c0-2.6,7.8-12,12.9-15.5c4.3-3,5.7-3,13.6,0.1c0.9,0.3,2.3-1.4,3.9-4.6c1.7-3.3,3.4-5.2,4.9-5.5\n    c1.2-0.3,3.1-0.7,4.2-1c2.4-0.6,14.7,0.2,17,1c0.9,0.4,2.7,2.8,4.1,5.5c1.3,2.7,2.8,4.9,3.3,4.9s2.5-0.7,4.4-1.5c6-2.5,7.3-2,15.2,6\n    c8.2,8.1,8.7,9.5,5.9,16.5c-0.9,2.3-1.5,4.2-1.3,4.3c0.2,0.1,2.5,1.2,5.1,2.4C219.1,195.2,220.4,198.8,219.8,209.8z M205,207.7\n    c0-2.1-0.9-3-4.5-4.8c-4.7-2.3-8.5-7.1-8.5-10.8c0-1.2,0.7-4.1,1.5-6.4c1.4-3.9,1.4-4.5-0.1-6.1c-1.4-1.6-1.9-1.6-6-0.2\n    c-8.4,2.9-14.1,0.5-17.6-7.5c-2.6-5.7-5.8-5.8-8.3-0.3c-3.6,8.1-10.2,10.9-18,7.7c-3.7-1.6-4-1.6-5.7,0.2c-1.8,1.7-1.8,2-0.2,5.7\n    c3.2,7.8,0.4,14.4-7.7,18c-5.7,2.6-5.4,5.8,0.7,8.7c7.7,3.5,10.2,10.2,6.9,18.1c-1.3,3.2-1.3,3.6,0.5,5.2s2.2,1.7,6.2,0\n    c7.4-2.9,13.8-0.2,17.3,7.4c2.7,6,5.5,5.6,9.2-1.2c2.3-4.3,3.5-5.5,7-6.7c3.8-1.3,4.7-1.2,9.4,0.4c4.7,1.7,5.2,1.7,6.7,0.2\n    c1.5-1.4,1.5-2-0.2-6.6c-1.1-3.1-1.5-6-1.1-7.9c0.8-3.7,4.7-7.7,9.1-9.3C204.3,210.6,205,209.7,205,207.7z M175.7,228.3\n    c-12.3,5.7-25.7,1-31.3-11c-4.5-9.7-2.4-19.7,5.7-27c2.7-2.4,6.6-4.8,8.6-5.4c5.4-1.4,7.3-1.4,12.9,0.3\n    C192.2,191.3,194.9,219.3,175.7,228.3z M171.1,201.6c-3.6-3.6-7-3.7-11-0.3c-2.4,2-3.1,3.4-3.1,6c0,7.7,9.4,11.3,14.5,5.8\n    C174.9,209.4,174.8,205.3,171.1,201.6z M110,164.7c-1.9-1.9-3.3-2-34-2s-32.1,0.1-34,2c-3,3-2.7,8.3,0.6,10.9\n    c2.6,2,3.8,2.1,33.5,2.1c30.5,0,30.8,0,33.3-2.3C113,172.2,113.3,168,110,164.7z"/></svg>',UILGraph.TIMELINE_ICON='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 248.6 232"><path d="M245.3,145.4c-6.8,26.1-24.7,51.4-46.9,66.4c-20.7,13.9-41.2,20.2-66.2,20.2c-28.7-0.1-53.1-9.2-75.7-28.5\n    c-8-6.9-21.3-22.9-20.3-24.5c0.5-0.8,16.7-12.4,20.1-14.4c0.7-0.4,3.2,2,6,5.9c12.3,16.8,33.4,29.6,55,33.4c11.5,2,31,0.9,41.4-2.5\n    c36.7-11.8,61.1-42.8,62.7-79.7c1.3-27-6.6-48.3-24.6-67.2C163,19.2,108,17.7,72.3,51c-16.1,15.1-26.2,34.7-28.2,55.1l-0.7,7.1\n    l9.7-0.5c5.3-0.2,9.6-0.2,9.6,0s-7.3,9.5-16.1,20.8l-16.1,20.4l-15.2-20.2L0,113.4l8.2-0.3l8.2-0.3l0.7-7.9\n    C20.2,67.1,45.3,30.3,80,12.8c9.7-4.9,23-9.4,33.3-11.3c9.4-1.7,26.3-2,35.4-0.6c46.2,7,83.7,40,95.9,84.1\n    C249.7,103.8,250,127.2,245.3,145.4z M141.9,83.7L141.7,59l-2.7-2c-3.7-3-9.7-2.8-12.8,0.4l-2.5,2.4v31.1V122l2.5,2.4l2.4,2.5h30.5\n    c29.9,0,30.6,0,32.5-2.1c2.9-3.1,3.5-7.1,1.7-11.3c-0.8-2-1.6-3.7-1.8-3.8c-0.2-0.1-11.3-0.5-24.8-0.8l-24.5-0.5L141.9,83.7z\n     M87.1,66.9l-3.4,3.5l-3.4,3.5l6.9,7l7,7l3.5-3.5l3.5-3.5l-7-7L87.1,66.9z M171.7,88.4l7-7l7-7.1l-3.8-3.7l-3.8-3.7l-6.9,7l-7,7\n    l3.8,3.7L171.7,88.4z M67.7,110.9v5v5h10h10v-5v-5h-10H67.7z M90.2,152.9l-7,7l3.5,3.5l3.5,3.5l7-7l7-7l-3.5-3.5l-3.5-3.5\n    L90.2,152.9z M164.7,149.4l-3.4,3.5l6.9,7l6.9,7l3.8-3.7l3.8-3.7l-6.7-6.8c-3.7-3.7-7-6.8-7.3-6.8S166.6,147.5,164.7,149.4z\n     M127.7,170.4v9.5h5h5v-9.5v-9.5h-5h-5V170.4z"/></svg>'})),Class((function UILGraphContextMenu(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILGraphContextMenu",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"div",refName:"wrapper",children:[{_type:"div",refName:"buttons",children:[{view:"UILGraphContextMenuButton",data:"$buttonsData",_type:"ViewState",refName:"unnamed",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());const{LAYOUT_TYPE:LAYOUT_TYPE,STAGE_LAYOUT_TYPE:STAGE_LAYOUT_TYPE,GROUP_TYPE:GROUP_TYPE,LAYER_TYPE:LAYER_TYPE,SPECIAL_TYPE:SPECIAL_TYPE}=UILGraph,{ACTION:ACTION,DELETE:DELETE,COPY_LAYOUT:COPY_LAYOUT,PASTE_LAYOUT:PASTE_LAYOUT,ADD_LAYER:ADD_LAYER,COPY_LAYER:COPY_LAYER,PASTE_LAYER:PASTE_LAYER,DUPLICATE_LAYER:DUPLICATE_LAYER,CINEMA:CINEMA,FIGMA:FIGMA,ADD_GROUP:ADD_GROUP,DUPLICATE_GROUP:DUPLICATE_GROUP}=UILGraphContextMenu,_sourceButtonsData=[{label:"Add Layer",uilContexts:[GROUP_TYPE,STAGE_LAYOUT_TYPE,LAYOUT_TYPE],action:ADD_LAYER},{label:"Copy Layer",uilContexts:[LAYER_TYPE],action:COPY_LAYER},{label:"Paste Layer",uilContexts:[LAYOUT_TYPE,GROUP_TYPE,LAYER_TYPE],action:PASTE_LAYER},{label:"Duplicate Layer",uilContexts:[STAGE_LAYOUT_TYPE,LAYER_TYPE],action:DUPLICATE_LAYER},{label:"Add Group",uilContexts:[LAYOUT_TYPE,GROUP_TYPE],action:ADD_GROUP},{label:"Duplicate Group",uilContexts:[GROUP_TYPE,STAGE_LAYOUT_TYPE],action:DUPLICATE_GROUP},{label:"Copy Layout",uilContexts:[LAYOUT_TYPE],action:COPY_LAYOUT},{label:"Paste Layout",uilContexts:[LAYOUT_TYPE],action:PASTE_LAYOUT},{label:"Apply Figma Config",uilContexts:[],action:FIGMA},{label:"Delete",uilContexts:[GROUP_TYPE,STAGE_LAYOUT_TYPE,LAYER_TYPE],action:DELETE}],specialCases={};specialCases[CINEMA]=[()=>"Config"==_this.get("UIL/ContextMenu").targetId],specialCases[FIGMA]=[()=>_this.get("UIL/ContextMenu").targetId.endsWith("Root")],_this.buttonsData=new StateArray([]),_this.offset={},_this.element.hide(),window.addEventListener("click",(()=>_this.set("UIL/ContextMenu",null))),_this.bind("UIL/ContextMenu",(openContext=>{if(!openContext)return function hideContextMenu(){return _this.element.mouseEnabled(!1),_this.element.hide()}();!function filterButtons(context){if(!context)return;_this.buttonsData.refresh(JSON.parse(JSON.stringify(_sourceButtonsData)).filter((b=>b.uilContexts.includes(context.type)||specialCases[b.action]&&specialCases[b.action].map((fn=>fn())).reduce(((a,b)=>a()||b())))))}(openContext),function positionAndShowContextMenu(){const margin=7;let x=Mouse.x+margin-_this.offset.x;x>Stage.width-160&&(x=Mouse.x-160-margin-_this.offset.x);let y=Mouse.y+margin-_this.offset.y;y>Stage.height-75&&(y=Mouse.y-75-margin-_this.offset.y);y+=UIL.global.element.div.querySelector(".UILTabsContentItem").scrollTop,_this.element.transform({x:x,y:y}),_this.element.show()}(),_this.element.mouseEnabled(!0)})),_this.setOffset=({x:x,y:y})=>_this.offset={x:x,y:y},_this.element.goob("\n    position: absolute;\n    width: auto;\n    height: auto;\n    padding-top: 10px;\n    padding-bottom: 10px;\n    color: black;\n    background-color: #303030;\n    border-radius: 12px;\n    line-height: 2px;\n    overflow: hidden;\n    user-select: none;\n    z-index: 999999;\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()}),"",(()=>{UILGraphContextMenu.ACTION="uilgraph_action",UILGraphContextMenu.DELETE="uilgraph_delete",UILGraphContextMenu.COPY_LAYOUT="uilgraph_copy_layout",UILGraphContextMenu.PASTE_LAYOUT="uilgraph_paste_layout",UILGraphContextMenu.ADD_LAYER="uilgraph_add_layer",UILGraphContextMenu.COPY_LAYER="uilgraph_copy_layer",UILGraphContextMenu.PASTE_LAYER="uilgraph_paste_layer",UILGraphContextMenu.DUPLICATE_LAYER="uilgraph_duplicate_layer",UILGraphContextMenu.CINEMA="uilgraph_cinema",UILGraphContextMenu.FIGMA="uilgraph_figma",UILGraphContextMenu.ADD_GROUP="uilgraph_add_group",UILGraphContextMenu.DUPLICATE_GROUP="uilgraph_duplicate_group"})),Class((function UILGraphContextMenuButton(_data,_index,_params){const _this=this;Inherit(_this,ViewStateElement),Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILGraphContextMenuButton",_this.contexts="ViewStateElement,Element",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{click:"$onClick",_type:"UI",refName:"unnamed",children:[{_type:"div",_innerText:"$data.label",refName:"button",children:[]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.bind("UILGraphContextMenu/open",(openContext=>{if(openContext||_this.element.hide(),_this.data.targetNodeCases.reduce(((a,b)=>a()||b())))return _this.element.show();const action=_this.data.uilContexts.includes(openContext.type)?"show":"hide";_this.element[action]()})),_this.onClick=function(){_this.fire("GraphContextMenu/action",_this.data.action)},_this.element.goob("\n    position: relative;\n    width: 100%;\n    height: 27px;\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    cursor: default;\n    box-sizing: border-box;\n    padding: 0 18px;\n    user-select: none;\n    transition: background-color 300ms ease-in-out, color 300ms ease-in-out;\n    background-color: transparent;\n    color: white;\n    font-family: sans-serif;\n    font-size: 11px;\n\n    &:hover {\n        color: #fff;\n        background-color: #525252;\n    }\n\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILGraphGroup(_data,_index,_params){const _this=this;Inherit(_this,ViewStateElement),Inherit(_this,Element),Inherit(_this,DragAndDrop),Inherit(_this,XComponent),_this.fragName="UILGraphGroup",_this.contexts="ViewStateElement,Element,DragAndDrop",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"div",refName:"wrapper",children:[{_type:"div",refName:"dropTarget",children:[{_type:"div",refName:"highlight",children:[]}]},{click:"$onClick",_type:"div",refName:"header",children:[{click:"$toggleClick",_type:"div",refName:"toggleButton",children:[]},{_type:"div",refName:"typeIcon",children:[]},{tabIndex:1,_type:"div",refName:"title",children:[{_type:"div",_innerText:"$data.name",refName:"titleText",children:[]},{value:"$data.name",_type:"input",refName:"titleField",children:[]}]},{type:"group",data:"$data",layoutId:"$params.layoutId",_type:"UILGraphNodeMenu",refName:"unnamed",children:[]}]},{data:"$data",layoutId:"$params.layoutId",_type:"UILGraphGroupChildren",refName:"unnamed",children:[]}]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());function handleNodeFocused(val){if(!_this.data)return;let focusedNode;_this.data.children?.forEach((node=>{node.focused=val==node.id,node.focused&&(focusedNode=node)})),focusedNode&&(UIL.sidebar.toolbar.filterSingle(val),Storage.set(`UIL:${_this.params.layoutId}/Graph/focused`,val),_this.events.fire(UILGraphNode.FOCUSED,{name:focusedNode.name,layoutInstance:_this.params.layoutInstance}))}function handleMoveNode(e){if(!_this.data||!_this.data.children)return;const find=id=>{let found;return _this.data.children.forEach((node=>{node.id==id&&(found=node)})),found};let moveNode=find(e.moveId),targetNode=find(e.targetId);try{if(!moveNode.parent||moveNode.parent!=targetNode?.parent)return}catch(e){return}if(1==_this.data.children.length&&(moveNode.sortIndex=0),"end-of-list"==e.type){let oldIndex=moveNode.sortIndex;_this.data.children.forEach((node=>{node.parent||node.sortIndex>oldIndex&&(node.sortIndex-=1)})),moveNode.sortIndex=_this.data.children.length-1,_this.data.children.sort(((a,b)=>a.sortIndex-b.sortIndex))}else{let oldIndex=moveNode.sortIndex;if(_this.data.children.forEach((node=>{node.sortIndex>oldIndex&&(node.sortIndex-=1)})),"before"==e.type){let newIndex=targetNode.sortIndex;_this.data.children.forEach((node=>{node.sortIndex>=newIndex&&(node.sortIndex+=1)})),moveNode.sortIndex=newIndex}_this.data.children.sort(((a,b)=>a.sortIndex-b.sortIndex)),healSort()}}function healSort(){let lastIndex=-1;_this.data.children.forEach((node=>{let delta=node.sortIndex-lastIndex;delta>1&&(node.sortIndex-=delta-1),lastIndex=node.sortIndex}))}async function handleContextMenuAction(event){if(!_this.get)return;const context=_this.get("UIL/ContextMenu");if(context&&context.layoutId==_this.params.layoutId&&event===UILGraphContextMenu.DELETE){let foundNode;if(_this.data.children.forEach((node=>{node.id==context.targetId&&(foundNode=node)})),foundNode){_this.params.bridge.deleteNode(foundNode)&&(_this.data.children.forEach((node=>{node.sortIndex>foundNode.sortIndex&&(node.sortIndex-=1)})),_this.data.children.remove(foundNode))}healSort()}}function onKey(event){return"enter"==event.key.toLowerCase()?function onTitleValidate(event){(function rename(name){let previousName=_this.data.nameLabel;_this.data.set("nameLabel",name),_this.title.text(_this.data.nameLabel),_this.titleField.val(_this.data.nameLabel),_this.events.fire(UILGraphNode.RENAMED,{layoutId:_this.data.layoutId,id:_this.data.id,name:previousName,value:_this.data.nameLabel}),_this.data.set("name",name),_this.name=name})(_this.titleField.val()),hideTitleEditor()}():"escape"==event.key.toLowerCase()?hideTitleEditor():void 0}function showTitleEditor(){_this.titleField.show(),_this.titleField.div.focus(),_this.titleField.div.select()}function hideTitleEditor(){_this.titleField.hide()}function openContextMenu(e){e.preventDefault(),_this.set("UIL/ContextMenu",{layoutId:_this.params.layoutId,targetId:_this.data.id,parentId:_this.data.parentId?.split(`${_this.data.scene}_`)[1],name:_this.data.name,type:UILGraph.GROUP_TYPE,isStageLayout:_this.data.isStageLayout})}_this.id=_this.data.id,_this.name=_this.data.name,_this.nameLabel=_this.data.name,_this.isGraphGroup=!0,_this.sortOrder=_this.params.order,_this.typeIcon.html(UILGraphLayout.GROUP_ICON),_this.toggleButton.html(UILGraphLayout.ARROW_ICON),_this.toggleButton.classList()[_this.data.open?"remove":"add"]("closed"),_this.titleField.hide(),_this.onClick=function(e){e.target.getAttribute("class")?.indexOf("toggleButton")>-1||e.target.getAttribute("class")?.indexOf("arrow")>-1||_this.fire(`UIL/${_this.params.layoutId}/UILGraph/node/focused`,_this.data.id)},_this.data.set("open",!0),_this.toggleClick=_=>{_this.data.set("open",!_this.data.open),_this.fire("UILGraphGroup/open",{open:_this.data.open,id:_this.data.id,layoutId:_this.data.layoutId})},_this.bind(_this.data,"open",(val=>_this.toggleButton?.classList?.()[val?"remove":"add"]("closed"))),_this.bind(_this.data,"locked",(value=>{_this.wrapper.css({pointerEvents:value?"none":"auto"}),_this.setDragEnabled(!value)})),function addHandlers(){_this.header.div.addEventListener("contextmenu",openContextMenu),_this.element.div.addEventListener("mousedown",_this.addDragListeners,!1),window.addEventListener("mouseup",_this.removeDragListeners,!1),_this.header.div.addEventListener("dblclick",showTitleEditor,!1),_this.titleField.div.addEventListener("keyup",onKey,!1),_this.titleField.div.addEventListener("blur",hideTitleEditor,!1),_this.bind(`UIL/${_this.params.layoutId}/UILGraph/node/focused`,handleNodeFocused),_this.listen("UILGraph/MoveNode",handleMoveNode),_this.listen("GraphContextMenu/action",handleContextMenuAction)}(),_this.header.classList()[_this.data.selected?"add":"remove"]("focused"),_this.bind(_this.data,"focused",(val=>{if(!_this.header)return;const focusedAction=val?"add":"remove";_this.header.classList()[focusedAction]("focused")})),_this.onMounted=function(){_this.element.div.classList.add("UILGraphNode"),_this.header.css({paddingLeft:32*_this.data.depth+"px"}),_this.setDragElement(_this.header),_this.data.locked&&(_this.wrapper.css({pointerEvents:"none"}),_this.data.special||_this.setDragEnabled(!1))},_this.onDrop=function(dropId){_this.fire("UILGraph/MoveNode",{moveId:dropId,targetId:_this.data.id,type:"before"})},_this.element.goob(`\n    position: relative;\n    width: 300px;\n    height: auto;\n    font-family: sans-serif;\n    font-size: 11px;\n    width: 100%;\n    cursor: grab;\n\n    & > .wrapper > .header {\n        width: 100%;\n        height: auto;\n        outline: none;\n        display: flex;\n        flex-direction: row;\n        align-items: center;\n        padding: 9px;\n        padding-left: 32px;\n        box-sizing: border-box;\n        user-select: none;\n        border: 1px solid rgba(26, 109, 234, 0);\n    }\n\n    & > .wrapper > .header {\n        transition: border-color 200ms, background-color 200ms;\n    }\n\n    & > .wrapper > .header:hover {\n        border: 1px solid rgba(26, 109, 234, 1);\n    }\n\n\n    & > .wrapper > .header.focused {\n        background-color: rgba(26, 109, 234, 1);\n    }\n\n    & > .wrapper > .header.focused:hover {\n        border: 1px solid rgba(26, 109, 234, 0);\n    }\n\n    .toggleButton {\n        position: absolute;\n        width: 32px;\n        height: auto;\n        box-sizing: border-box;\n        text-align: center;\n        padding: 9px;\n        margin-left: -32px;\n        transform: rotate(180deg);\n        opacity: 0.6;\n        transition: opacity 200ms;\n    }\n\n    .toggleButton:hover {\n        opacity: 1;\n    }\n\n    .toggleButton.closed {\n        transform: rotate(0deg);\n    }\n\n    .toggleButton path {\n        fill: var(--color-white);\n    }\n\n    .typeIcon {\n        margin-right: 9px;\n        margin-left: -4px;\n    }\n\n    .typeIcon path {\n        fill: var(--color-white);\n    }\n\n    .typeIcon rect {\n        stroke: var(--color-white);\n    }\n\n    .title {\n        display: block;\n        verticalAlign: middle;\n    }\n\n    .titleField {\n        background-color: #b1b1b1;\n        position: absolute !important;\n        display: inline-block;\n        margin-left: ${30*(_this.data.depth-1)}px;\n        top: 4px;\n        left: 32px;\n        width: auto !important;\n        padding: 9px !important;\n        verticalAlign: middle;\n        fontWeight: bold;\n        border: 0;\n        outline: none;\n        z-index: 1;\n    }\n\n    .UILGraphNodeMenu {\n        position: absolute;\n        right: 0;\n    }\n\n    .visibilityButton {\n    }\n\n    .UILGraphGroupChildren {\n        overflow: hidden;\n        margin-top: -4px;\n    }\n\n`);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILGraphGroupChildren(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,DragAndDrop),Inherit(_this,XComponent),_this.fragName="UILGraphGroupChildren",_this.contexts="Element,DragAndDrop",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"div",refName:"wrapper",children:[{_type:"div",refName:"items",children:[{view:"UILGraphLayer",data:"$params.data.children",layoutId:"$params.layoutId",_type:"ViewState",refName:"unnamed",children:[]}]},{_type:"div",refName:"dropTarget",children:[{_type:"div",refName:"highlight",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.setDragEnabled(!1),_this.items.classList()[_this.params.data.open?"remove":"add"]("hidden"),_this.bind(_this.params.data,"open",(val=>_this.items?.classList?.()[val?"remove":"add"]("hidden"))),_this.onDrop=function(dropId){_this.fire("UILGraph/MoveNode",{moveId:dropId,targetId:_this.params.data.id,type:"end-of-list"})},_this.element.goob(`\n    & > .wrapper > .items.hidden {\n        display: none;\n    }\n\n    & > .wrapper > .dropTarget {\n        margin-bottom: 0;\n        margin-left: ${32*_this.params.data.depth}px;\n        height: 6px;\n    }\n`);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILGraphLayer(_data,_index,_params){const _this=this;Inherit(_this,ViewStateElement),Inherit(_this,Element),Inherit(_this,DragAndDrop),Inherit(_this,XComponent),_this.fragName="UILGraphLayer",_this.contexts="ViewStateElement,Element,DragAndDrop",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{click:"$onClick",_type:"div",refName:"wrapper",children:[{_type:"div",refName:"line",children:[]},{_type:"div",refName:"dropTarget",children:[{_type:"div",refName:"highlight",children:[]}]},{tabIndex:1,_type:"a",refName:"header",children:[{_type:"div",refName:"typeIcon",children:[]},{tabIndex:1,_type:"div",refName:"title",children:[{_type:"div",_innerText:"$data.titleString",refName:"titleInner",children:[]},{value:"$data.name",_type:"input",refName:"titleField",children:[]}]},{type:"layer",data:"$data",_type:"UILGraphNodeMenu",refName:"nodemenu",children:[]}]}]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());function onKey(event){return"enter"==event.key.toLowerCase()?function onTitleValidate(event){(function rename(name){let previousName=_this.data.name;_this.data.set("nameLabel",name),_this.title.text(_this.data.nameLabel),_this.titleField.val(_this.data.nameLabel),_this.events.fire(UILGraphNode.RENAMED,{layoutId:_this.data.layoutId,id:_this.data.id,name:previousName,value:_this.data.nameLabel}),_this.data.set("name",name),_this.name=name})(_this.titleField.val()),hideTitleEditor()}():"escape"==event.key.toLowerCase()?hideTitleEditor():void 0}function showTitleEditor(){_this.data.special||(_this.titleField.show(),_this.titleField.div.focus(),_this.titleField.div.select())}function hideTitleEditor(){_this.titleField.hide()}function openContextMenu(e){e.preventDefault(),_this.set("UIL/ContextMenu",{layoutId:_this.params.layoutId,targetId:_this.data.id,parentId:_this.data.parentId?.split(`sl_${_this.data.scene}_`)[1],name:_this.data.name,type:_this.data.special?UILGraph.SPECIAL_TYPE:UILGraph.LAYER_TYPE,isStageLayout:_this.data.isStageLayout})}_this.data.titleString=_this.data.label||_this.data.name,_this.titleField.hide(),_this.data.special&&(_this.typeIcon.hide(),_this.dropTarget.hide(),_this.setDragEnabled(!1)),_this.data.locked&&(_this.wrapper.css({pointerEvents:"none"}),_this.data.special||_this.setDragEnabled(!1)),function addHandlers(){_this.header.div.addEventListener("contextmenu",openContextMenu),_this.header.div.addEventListener("dblclick",showTitleEditor,!1),_this.titleField.div.addEventListener("keyup",onKey,!1),_this.titleField.div.addEventListener("blur",hideTitleEditor,!1)}(),_this.bind(_this.data,"locked",(value=>{_this.wrapper.css({pointerEvents:value?"none":"auto"}),_this.data.special||_this.setDragEnabled(!value)})),_this.onDrop=function(dropId){_this.fire("UILGraph/MoveNode",{moveId:dropId,targetId:_this.data.id,type:"before"})},_this.wrapper.classList()[_this.data.focused?"add":"remove"]("focused"),_this.bind(_this.data,"focused",(val=>{_this.wrapper?.classList()[val?"add":"remove"]("focused")})),"UILGraphLayout"==_this.parent.parent.fragName?_this.line.hide():_this.line.size(25,25).html(UILGraphLayout.LINE_ELBOW).css({left:12,top:2,position:"absolute"}),_this.onMounted=function(){_this.element.div.classList.add("UILGraphNode"),_this.header.css({paddingLeft:32*_this.data.depth+"px"})},_this.onClick=function(){_this.fire(`UIL/${_this.params.layoutId}/UILGraph/node/focused`,_this.data.id)},_this.element.goob(`\n    position: relative;\n    height: auto;\n    width: 100%;\n    cursor: grab;\n\n    & > .wrapper {\n        width: 100%;\n        border: 1px solid transparent;\n        transition: border-color 200ms, background-color 200ms;\n\n    }\n\n    & > .wrapper:hover {\n        border: 1px solid #1A6DEA;\n    }\n\n    & > .wrapper:active {\n        cursor: grabbing !important;\n    }\n\n    & > .wrapper.focused {\n        background-color: #1A6DEA;\n    }\n\n    & > .wrapper.focused:hover {\n        border: 1px solid transparent;\n    }\n\n    & > .wrapper.dragging {\n        background-color: transparent;\n    }\n\n    & > .wrapper.dragging:hover {\n        border: 1px solid #1A6DEA;\n    }\n\n\n    & > .wrapper.focused.dragging {\n        background-color: transparent;\n    }\n\n    & > .wrapper.focused.dragging:hover {\n        border: 1px solid #1A6DEA;\n    }\n\n    .header {\n        color: var(--color-white);\n        display: flex;\n        flex-direction: row;\n        align-items: center;\n        width: 100%;\n        height: auto;\n        outline: none;\n        padding: 9px;\n        padding-left: 0;\n        box-sizing: border-box;\n        user-select: none;\n        padding-left: 32px;\n    }\n\n    .typeIcon {\n        height: 8px;\n        width: 8px;\n        border: 1px solid #737373;\n        margin-left: 0 !important;\n        margin-right: 9px;\n    }\n\n    .UILGraphNodeMenu {\n        position: absolute;\n        right: 0;\n    }\n\n    .title {\n        display: block;\n        verticalAlign: middle;\n    }\n\n    .titleField {\n        background-color: #b1b1b1;\n        position: absolute !important;\n        display: inline-block;\n        margin-left: ${28*(_this.data.depth-1)}px;\n        top: 2px;\n        left: 36px;\n        width: auto !important;\n        padding: 8px !important;\n        verticalAlign: middle;\n        fontWeight: bold;\n        border: 0;\n        outline: none;\n        z-index: 1;\n    }\n\n    & > .wrapper > .dropTarget {\n        margin-left: ${32*(_this.data.depth-1)}px;\n    }\n\n`);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILGraphLayout(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,DragAndDrop),Inherit(_this,XComponent),_this.fragName="UILGraphLayout",_this.contexts="Element,DragAndDrop",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];(async function(){function createStateArray(array){return new StateArray(array||[])}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"div",refName:"wrapper",children:[{tabIndex:1,_type:"div",refName:"header",children:[{_type:"div",refName:"toggle",children:[]},{_type:"div",_innerText:"$params.name",refName:"title",children:[]}]},{_type:"div",refName:"children",children:[{_type:"div",refName:"viewstate",children:[{view:"$determineView",data:"$nodes",layoutId:"$id",bridge:"$groupBridge",layoutInstance:"$layoutInstance",_type:"ViewState",refName:"layers",children:[]}]},{_type:"div",refName:"dropTarget",children:[{_type:"div",refName:"highlight",children:[]}]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());var _isOpen=!1,_isFocused=!1,_saveEnabled=!1,_isGL=!0===_this.params.isGL,_layoutInstance=_this.params.layoutInstance,_isStageLayout=_layoutInstance.isStageLayout;function handleParentBinding(node){_this.bind(node,"parent",((val,prevValue)=>{val?_this.groupBridge.groups.forEach((n=>{n.id.includes(val)&&!n.children.includes(node)&&(n.children.push(node),_this.nodes.remove(node),1==n.children.length&&(node.sortIndex=0))})):prevValue&&_this.groupBridge.groups.forEach((n=>{n.id.includes(prevValue)&&(n.children.remove(node),_this.nodes.push(node),node.sortIndex=_this.nodes.length)}))}))}function addHandlers(){_this.header.div.addEventListener("contextmenu",openContextMenu),_this.bind(`UIL/${_this.id}/UILGraph/node/focused`,handleNodeFocused),_this.listen("GraphContextMenu/action",handleContextMenuAction),_this.listen("UILGraph/MoveNode",handleMoveNode),_this.events.sub(UILSocket.EDITOR_BRIDGE,onEditorBridgeMessage)}function handleMoveNode(e){const find=id=>{let found;return _this.groupBridge.all.forEach((node=>{node.id==id&&(found=node)})),found};let moveNode=find(e.moveId),targetNode=find(e.targetId);if(moveNode&&!(moveNode.parent&&moveNode.parent==targetNode?.parent||moveNode==targetNode||targetNode?.parent&&moveNode.id.includes(targetNode.parent)||targetNode?.children&&moveNode.children)){if("end-of-list"==e.type)if(targetNode)moveNode.parent=targetNode.id;else{let oldIndex=moveNode.sortIndex;_this.nodes.forEach((node=>{node.sortIndex>oldIndex&&(node.sortIndex-=1)})),moveNode.sortIndex=_this.nodes.length-1,moveNode.parent=null,_this.nodes.sort(((a,b)=>a.sortIndex-b.sortIndex))}else{if("group"==moveNode.type&&"group"==targetNode?.type)return;if(targetNode?.parent)return moveNode.parent=targetNode.parent,_this.fire("UILGraph/MoveNode",e),void healSort();moveNode.parent=null;let oldIndex=moveNode.sortIndex;if(_this.nodes.forEach((node=>{node.sortIndex>oldIndex&&(node.sortIndex-=1)})),"before"==e.type){let newIndex=targetNode.sortIndex;_this.nodes.forEach((node=>{node.sortIndex>=newIndex&&(node.sortIndex+=1)})),moveNode.sortIndex=newIndex}_this.nodes.sort(((a,b)=>a.sortIndex-b.sortIndex))}healSort(),_this.set(`UIL/${_this.id}/UILGraph/node/focused`,e.moveId)}}function healSort(){let lastIndex=-1;_this.nodes.forEach((node=>{let delta=node.sortIndex-lastIndex;delta>1&&(node.sortIndex-=delta-1),lastIndex=node.sortIndex}))}async function onEditorBridgeMessage(e){if(e.layout&&e.layout===_this.name){if("create"==e.action){let layer=await _layoutInstance._createLayer(null);await _this.wait(100),_this.events.fire(UILGraphLayout.BRIDGE_CREATE,{layoutName:_layoutInstance.name,layerName:layer._sceneLayout.name,newName:e.layerName})}if("delete"==e.action){let node=find(e.layerName);_layoutInstance._deleteLayer(node.id,e.layerName,!0)&&_this.remove(node,!0)}if("eval"==e.action){let layer=await _layoutInstance.getLayer(e.layerName);eval("layer._sceneLayout."+e.code)}}}function openContextMenu(e){e.preventDefault(),_this.set("UIL/ContextMenu",{layoutId:_this.id,targetId:_this.id,type:_isStageLayout?UILGraph.STAGE_LAYOUT_TYPE:UILGraph.LAYOUT_TYPE,isStageLayout:_isStageLayout})}async function handleContextMenuAction(event){const context=_this.get("UIL/ContextMenu");if(context&&context.layoutId==_this.id)switch(event){case UILGraphContextMenu.DELETE:let foundNode;if(_this.nodes.forEach((node=>{node.id==context.targetId&&(foundNode=node)})),foundNode&&!foundNode.parent){_this.groupBridge.deleteNode(foundNode)&&(_this.nodes.remove(foundNode),_this.nodes.forEach((node=>{node.sortIndex>foundNode.sortIndex&&(node.sortIndex-=1)})),_this.nodes.length&&_this.set(`UIL/${_this.id}/UILGraph/node/focused`,_this.nodes[0].id))}healSort();break;case UILGraphContextMenu.ADD_LAYER:{_this.groupBridge.createLayer();let newNode=_this.groupBridge.layers[_this.groupBridge.layers.length-1];handleParentBinding(newNode),_this.nodes.push(newNode),context.targetId&&context.targetId!=_this.id&&(newNode.parent="group"+context.targetId.split("_group")[1]),healSort()}break;case UILGraphContextMenu.ADD_GROUP:{_this.groupBridge.createGroup();let newNode=_this.groupBridge.groups[_this.groupBridge.groups.length-1];handleParentBinding(newNode),_this.nodes.push(newNode),healSort()}break;case UILGraphContextMenu.COPY_LAYER:var dataToCopy={UIL_ID:window.UIL_ID,layout:context.layoutId,layer:_this.params.id||`${_this.params.name}-${_this.params.uniq}`,location:window.location.pathname.split("/").filter(Boolean)[0]};if(window.Platform&&Router){const world=await Platform.getRoute(Router.getStateString());dataToCopy.world=world}navigator.clipboard.writeText(JSON.stringify(dataToCopy));break;case UILGraphContextMenu.COPY_LAYOUT:dataToCopy={UIL_ID:window.UIL_ID,layout:context.layoutId,location:window.location.pathname.split("/").filter(Boolean)[0]};if(window.Platform&&Router){const world=await Platform.getRoute(Router.getStateString());dataToCopy.world=world}navigator.clipboard.writeText(JSON.stringify(dataToCopy));break;case UILGraphContextMenu.DUPLICATE_LAYER:case UILGraphContextMenu.DUPLICATE_GROUP:break;case UILGraphContextMenu.CINEMA:applyCinemaConfig();break;case UILGraphContextMenu.FIGMA:applyFigmaConfig();break;case UILGraphContextMenu.PASTE_LAYER:return alert("The Paste Layer feature is not yet implemented.");case UILGraphContextMenu.PASTE_LAYOUT:return alert("The Paste Layout feature is not yet implemented.")}}function handleNodeFocused(val){let focusedNode;_this.nodes.forEach((node=>{node.focused=val==node.id,node.focused&&(focusedNode=node)})),focusedNode&&(UIL.sidebar.toolbar.filterSingle(val),Storage.set(`UIL:${_this.id}/Graph/focused`,val),Storage.set("UILGraphLayoutFocused",_this.id),_this.set("UILGraphLayoutFocused",_this.id),_this.events.fire(UILGraphNode.FOCUSED,{name:focusedNode.name,layoutInstance:_layoutInstance}))}_this.id=_this.params.id||`${_this.params.name.toLowerCase()}-${_this.params.uniq}`,_this.layoutInstance=_layoutInstance,_this.attachmentId=`${_this.params.name}-${_this.params.uniq}`,_this.addSpecial=_this.addLayer=_this.addGroup=_this.syncVisibility=_this.syncGroupNames=_this.open=_=>{},_this.groupBridge=await UILGroupBridge.createSceneLayout(_layoutInstance.name),_this.determineView=data=>"group"==data.type?UILGraphGroup:UILGraphLayer,_this.setDragEnabled(!1),_this.nodes=createStateArray(),_this.groupBridge.all.forEach((node=>{handleParentBinding(node),node.parent||_this.nodes.push(node)})),addHandlers(),_this.delayedCall((_=>{Storage.get("UILGraphLayoutFocused")==_this.id&&_this.set(`UIL/${_this.id}/UILGraph/node/focused`,Storage.get(`UIL:${_this.id}/Graph/focused`))}),500),_this.onDrop=function(dropId){_this.fire("UILGraph/MoveNode",{moveId:dropId,targetId:null,type:"end-of-list"})},_this.bind("UILGraphLayoutFocused",(id=>{id!=_this.id&&_this.groupBridge.all.forEach((node=>{node.focused=!1}))})),_this.element.goob("\n    position: relative;\n    width: 100%;\n    height: auto;\n    font-family: sans-serif;\n    font-size: 11px;\n\n    & > .wrapper {\n        background-color: #161616;\n    }\n\n    .header {\n        width: 100%;\n        height: auto;\n        outline: none;\n        display: block;\n        padding: 4px;\n        box-sizing: border-box;\n        user-select: none;\n    }\n\n    .toggle {\n        position: relative;\n        width: 2px;\n        height: 2px;\n        fontSize: 9ps;\n        text-align: center;\n        display: inline-block;\n        vertical-align: middle;\n        border: 1px solid #b1b1b1;\n        border-radius: 50%;\n        margin-left: 2px;\n    }\n\n    .title {\n        display: inline-block;\n        vertical-align: middle;\n        marginLeft: 6px;\n    }\n\n    .children {\n        overflow: hidden;\n        transition: filter 0.1s linear;\n        filter: brightness(0.8);\n    }\n    .children:hover {\n        filter: brightness(1.0);\n    }\n\n    .lastPseudoLayer {\n        height: 8px;\n    }\n\n    .dropTarget {\n        position: relative;\n        height: 15px;\n        width: 100%;\n        margin-bottom: -15px;\n    }\n\n    .dropTarget .highlight {\n        width: 100%;\n        height: 6px;\n        background: #1A6DEA;\n        opacity: 0;\n        transition: opacity 200ms;\n    }\n\n    .dropTarget.hover .highlight{\n        opacity: 1;\n    }\n\n    & > .wrapper > .children > .dropTarget {\n        margin-bottom: 0;\n    }\n\n    .iconButton {\n        width: 16px;\n        height: 16px;\n        cursor: pointer;\n        transition: opacity 200ms;\n        stroke: var(--color-white);\n        fill: var(--color-white);\n        opacity: 0.6;\n        margin: 2px;\n    }\n    \n    .iconButton rect {\n        fill: var(--color-white);\n    }\n    \n    .iconButton:hover {\n        opacity: 1;\n    }\n"),_this.onDestroy=_=>{_this.fire("UILGraphLayout/destroy",_this.attachmentId)};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()})()}),"",(()=>{UILGraphLayout.VISIBILE_ICON='<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M8 10C9.1046 10 10 9.1046 10 8C10 6.8954 9.1046 6 8 6C6.8954 6 6 6.8954 6 8C6 9.1046 6.8954 10 8 10Z" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>\n    <path d="M14 8C12.7409 9.4955 10.4789 11 8 11C5.52113 11 3.25904 9.4955 2 8C3.53237 6.57913 5.32775 5 8 5C10.6723 5 12.4677 6.5791 14 8Z" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>\n    </svg>',UILGraphLayout.INVISIBLE_ICON='<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M3 3L13 13" stroke-width="0.833333" stroke-linecap="round" stroke-linejoin="round"/>\n    <path d="M7.09535 7.32587C7.03396 7.47036 7 7.62933 7 7.79621C7 8.461 7.53893 8.99998 8.20377 8.99998C8.40481 8.99998 8.59434 8.9507 8.76095 8.86354" stroke-width="0.833333" stroke-linecap="round" stroke-linejoin="round"/>\n    <path d="M5.27945 6C4.40054 6.56451 3.66836 7.36877 3 8.12613C3.98694 9.55876 5.76015 11 7.70328 11C8.51324 11 9.29372 10.7496 10 10.3538" stroke-width="0.833333" stroke-linecap="round" stroke-linejoin="round"/>\n    <path d="M8 5C10.2269 5 11.7231 6.68437 13 8.2C12.8231 8.46896 12.6224 8.73824 12.4011 9" stroke-width="0.833333" stroke-linecap="round" stroke-linejoin="round"/>\n    </svg>',UILGraphLayout.LOCKED_ICON='<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M10.6667 8H11.6C11.8209 8 12 8.16788 12 8.375V12.625C12 12.8321 11.8209 13 11.6 13H4.4C4.17909 13 4 12.8321 4 12.625V8.375C4 8.16788 4.17909 8 4.4 8H5.33333M10.6667 8V5.5C10.6667 4.66667 10.1333 3 8 3C5.86667 3 5.33333 4.66667 5.33333 5.5V8M10.6667 8H5.33333" stroke-width="0.937501" stroke-linecap="round" stroke-linejoin="round"/>\n    <rect x="4" y="8" width="8" height="5" />\n    </svg>\n    ',UILGraphLayout.UNLOCKED_ICON='<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M10.6667 8H11.6C11.8209 8 12 8.16787 12 8.375V12.625C12 12.8321 11.8209 13 11.6 13H4.4C4.17909 13 4 12.8321 4 12.625V8.375C4 8.16787 4.17909 8 4.4 8H5.33333H10.6667ZM10.6667 8V5.5C10.6667 4.66667 10.1333 3 8 3C7.04247 3 6.40727 3.33577 5.99796 3.78125" stroke-width="0.750001" stroke-linecap="round" stroke-linejoin="round"/>\n    </svg>\n    \n    ',UILGraphLayout.SCENE_ICON='<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M13.0009 8.00124C13.0009 8.59111 12.8984 9.1589 12.7107 9.6841C12.3622 10.6588 11.7218 11.4931 10.8938 12.0814C10.0768 12.6618 9.07846 13.0025 8.00125 13.0025C6.92403 13.0025 5.92567 12.6618 5.10869 12.0814C4.28067 11.4931 3.63876 10.6588 3.29178 9.6841C3.1041 9.1589 3.00158 8.59111 3.00158 8.00124C3.00158 7.32936 3.13406 6.68745 3.37537 6.10232C3.77598 5.12446 4.47782 4.30275 5.36577 3.75074C6.12913 3.27443 7.03286 3 8.00125 3C8.96964 3 9.87178 3.27443 10.6367 3.75074C11.5247 4.30275 12.2265 5.12446 12.6271 6.10232C12.8684 6.68745 13.0009 7.32936 13.0009 8.00124Z" stroke-width="0.75" stroke-miterlimit="10"/>\n    <path d="M8.00129 3C8.96968 3 9.87183 3.27443 10.6368 3.75074C10.3339 3.82644 10.0217 3.88795 9.69992 3.93685C9.15421 4.02044 8.58485 4.0646 7.99972 4.0646C7.41458 4.0646 6.84522 4.02044 6.29951 3.93685C5.97935 3.88795 5.66706 3.82487 5.36267 3.75074C6.12918 3.27443 7.0329 3 8.00129 3Z" stroke-width="0.75" stroke-miterlimit="10"/>\n    <path d="M12.6271 6.10232C12.0419 6.25373 11.4221 6.37675 10.777 6.46822C9.89537 6.59282 8.96484 6.66064 8.00118 6.66064C7.03752 6.66064 6.10698 6.59282 5.22534 6.46822C4.58027 6.37675 3.96044 6.25373 3.37531 6.10232C3.77591 5.12446 4.47776 4.30275 5.36571 3.75074C6.12906 3.27443 7.03279 3 8.00118 3C8.96957 3 9.87172 3.27443 10.6366 3.75074C11.5246 4.30275 12.2264 5.12446 12.6271 6.10232Z" stroke-width="0.75" stroke-miterlimit="10"/>\n    <path d="M8.00116 13.0009C6.92394 13.0009 5.92559 12.6603 5.10861 12.0799C5.44139 11.9868 5.78522 11.9111 6.14166 11.8512C6.73626 11.7518 7.35925 11.6982 8.00116 11.6982C8.64307 11.6982 9.26764 11.7518 9.86066 11.8512C10.2155 11.9111 10.5609 11.9868 10.8937 12.0799C10.0767 12.6603 9.07837 13.0009 8.00116 13.0009V13.0009Z" stroke-width="0.75" stroke-miterlimit="10"/>\n    <path d="M12.7107 9.6841C12.3621 10.6588 11.7218 11.4931 10.8938 12.0814C10.0768 12.6618 9.07844 13.0025 8.00122 13.0025C6.92401 13.0025 5.92565 12.6618 5.10867 12.0814C4.28065 11.4931 3.63874 10.6588 3.29176 9.6841C3.88951 9.52638 4.52353 9.39863 5.18595 9.30242C6.08021 9.17309 7.02337 9.1037 8.00122 9.1037C8.97907 9.1037 9.92381 9.17309 10.8165 9.30242C11.4789 9.39705 12.1129 9.52638 12.7107 9.6841V9.6841Z" stroke-width="0.75" stroke-miterlimit="10"/>\n    <path d="M7.99971 13.0025C9.61028 13.0025 10.9159 10.7634 10.9159 8.00124C10.9159 5.23913 9.61028 3 7.99971 3C6.38913 3 5.0835 5.23913 5.0835 8.00124C5.0835 10.7634 6.38913 13.0025 7.99971 13.0025Z" stroke-width="0.75" stroke-miterlimit="10"/>\n    <path d="M7.99967 3V13.0009" stroke-width="0.75" stroke-miterlimit="10"/></svg>',UILGraphLayout.GROUP_ICON='<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <rect x="2.5" y="2.5" width="7" height="7" />\n    <path d="M14 14V6H11V11H6V14H14Z" />\n    </svg>',UILGraphLayout.ARROW_ICON='<svg width="6" class="arrow" height="4" viewBox="0 0 6 4" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M6 0L3 4L0 -2.62268e-07L6 0Z" />\n    </svg>',UILGraphLayout.LINE_ELBOW='<svg fill="#aaaaaa" width="20px" height="22px" viewBox="0 0 256 256" id="Flat" xmlns="http://www.w3.org/2000/svg">\n    <path d="M210.82825,178.82861h-.00013l-48,48a3.99992,3.99992,0,0,1-5.65625-5.65722L198.34277,180H64a4.0002,4.0002,0,0,1-4-4V32a4,4,0,0,1,8,0V172H198.34277l-41.1709-41.17139a3.99992,3.99992,0,0,1,5.65625-5.65722l48,48h.00013a4.02834,4.02834,0,0,1,.49841.61035c.06543.09814.11047.20434.1665.30664a3.97146,3.97146,0,0,1,.20093.38183,3.91958,3.91958,0,0,1,.126.406c.03345.11377.07751.22266.10083.34033a4.01026,4.01026,0,0,1,0,1.5669c-.02332.11767-.06738.22656-.10083.34033a3.90157,3.90157,0,0,1-.126.406,3.94471,3.94471,0,0,1-.20093.38183c-.0559.1023-.10095.2085-.1665.30664A4.02834,4.02834,0,0,1,210.82825,178.82861Z"/>\n    </svg>'})),Class((function UILGraphNode(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILGraphNode",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()}),"",(()=>{UILGraphNode.FOCUSED="uilgraphnode_focused",UILGraphNode.BLURRED="uilgraphnode_blurred",UILGraphNode.RENAMED="uilgraphnode_renamed",UILGraphNode.TOGGLE_VISIBILITY="uilgraphnode_toggle_visibility"})),Class((function UILGraphNodeMenu(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILGraphNodeMenu",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"div",refName:"wrapper",children:[{className:"iconButton",click:"$onSceneClick",_type:"div",refName:"sceneButton",children:[]},{className:"iconButton",click:"$onLockClick",_type:"div",refName:"lockButton",children:[]},{className:"iconButton",click:"$onVisibilityClick",_type:"div",refName:"visibilityButton",children:[]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.sceneButton.html(UILGraphLayout.SCENE_ICON),_this.sceneButton.classList()[_this.params.data.scenelayout?"remove":"add"]("hidden"),_this.lockButton.html(_this.params.data.locked?UILGraphLayout.LOCKED_ICON:UILGraphLayout.UNLOCKED_ICON),_this.visibilityButton.html(_this.params.data.visible?UILGraphLayout.VISIBILE_ICON:UILGraphLayout.INVISIBLE_ICON),_this.params.data.special&&_this.visibilityButton.classList().add("hidden"),_this.onLockClick=_=>_this.params.data.set("locked",!_this.params.data.locked),_this.onVisibilityClick=_=>_this.params.data.set("visible",!_this.params.data.visible),_this.onSceneClick=_=>window.location.search=`?p=${_this.params.data.scenelayout}&uil`,_this.onInit=function(){_this.lockButton.css({pointerEvents:"all"}),_this.bind(_this.params.data,"locked",(value=>{_this.lockButton.html(value?UILGraphLayout.LOCKED_ICON:UILGraphLayout.UNLOCKED_ICON),_this.fire("UILGraph/LockNode",{id:_this.params.data.id,layoutId:_this.params.layoutId,value:value}),value&&_this.set(`UIL/${_this.params.layoutId}/UILGraph/node/focused`,null)})),_this.bind(_this.params.data,"visible",(val=>{_this.visibilityButton?.html(val?UILGraphLayout.VISIBILE_ICON:UILGraphLayout.INVISIBLE_ICON),_this.events.fire(UILGraphNode.TOGGLE_VISIBILITY,{..._this.params.data.toJSON(),visible:val})}))},_this.element.goob("\n    .wrapper {\n        display: flex;\n        margin-right: 5px;\n        color: var(--color-icon-default);\n        align-items: right;\n    }\n\n    .iconButton.hidden {\n        display: none;\n    }\n\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILHistoryDay(_data,_index,_params){const _this=this;Inherit(_this,Element),Inherit(_this,ViewStateElement),Inherit(_this,XComponent),_this.fragName="UILHistoryDay",_this.contexts="Element,ViewStateElement",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{click:"$onClick",_type:"div",refName:"day",children:[{className:"day__info",_type:"div",refName:"unnamed",children:[{_type:"span",_innerText:"$data.date",refName:"unnamed",children:[]},{_type:"span",_innerText:"$data.amount",refName:"unnamed",children:[]}]},{className:"day__icon",_type:"div",refName:"icon",children:[]}]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.onInit=function(){!function initHTML(){_this.icon.html(UILHistoryDay.arrowRightIcon)}()},_this.onClick=function(){_this.parent.parent.onSelectDay(_this.data.date)},_this.element.goob("\n    .day {\n        display: flex;\n        font: var(--label4-medium);\n        font-size: 12px;\n        justify-content: center;\n        align-items: center;\n        width: 100%;\n        padding: 1rem;\n\n        border: 1px solid transparent;\n        border-bottom-color: var(--color-neutral-40);\n\n        &:hover {\n            border-color: var(--color-accent-50);\n\n            .day__icon > svg {\n                stroke: var(--font-color-base);\n            }\n        }\n\n        &__info {\n            flex-grow: 1;\n\n            > span {\n                display: inline-block;\n\n                &:last-child {\n                    margin-left: 0.2rem;\n                }\n            }\n        }\n\n        &__icon {\n            > svg {\n                display: block;\n\n                stroke: var(--color-neutral-70);\n\n                transition: stroke 0.17s ease-in-out;\n            }\n        }\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()}),(_=>{UILHistoryDay.arrowRightIcon='\n        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M6 4L10 8L6 12" stroke-linecap="round" stroke-linejoin="round"/>\n        </svg>\n    '})),Class((function UILHistoryPaginationButton(_data,_index,_params){const _this=this;Inherit(_this,Element),Inherit(_this,ViewStateElement),Inherit(_this,XComponent),_this.fragName="UILHistoryPaginationButton",_this.contexts="Element,ViewStateElement",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){function calculateDisplay(){let{pageCount:pageCount,maxButtonCount:maxButtonCount,index:index}=_this.data.toJSON();if(pageCount-=1,!(pageCount<=0||pageCount<=maxButtonCount-1)){if(_this.visibleButtonIndexes=[0,pageCount],0===_this.currentPageIndex&&_this.currentPageIndex===pageCount||_this.visibleButtonIndexes.push(_this.currentPageIndex),pageCount>maxButtonCount&&(1===index&&_this.currentPageIndex>1?setEllipsis("start"):removeEllipsis(),index===pageCount-1&&_this.currentPageIndex<=pageCount-2?setEllipsis("end"):removeEllipsis()),_this.visibleButtonIndexes=[...new Set(_this.visibleButtonIndexes)],_this.visibleButtonIndexes.length<maxButtonCount){let fillButtonCount=maxButtonCount-_this.visibleButtonIndexes.length;if(_this.currentPageIndex<=Math.ceil(pageCount/2))for(let i=0;i<fillButtonCount;i++)_this.visibleButtonIndexes.push(_this.currentPageIndex+(i+1)),fillButtonCount--;else if(_this.currentPageIndex>=Math.floor(pageCount/2))for(let i=0;i<fillButtonCount;i++)_this.visibleButtonIndexes.push(_this.currentPageIndex-(i+1)),fillButtonCount--}_this.hidden=!_this.visibleButtonIndexes.includes(index)}}function setEllipsis(position){const indexes={start:1,end:_this.data.pageCount-2};_this.data.label="...",_this.btn.classList().add("disabled"),_this.visibleButtonIndexes.push(indexes[position])}function removeEllipsis(){_this.btn.classList().remove("disabled")}function setActive(value){value?_this.btn.classList().add("active"):_this.btn.classList().remove("active")}function setDisplay(){_this.hidden?_this.element.classList().add("hidden"):_this.element.classList().remove("hidden")}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{href:"#",click:"$handleClick",_type:"a",_innerText:"$data.label",refName:"btn",children:[]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.currentPageIndex=_this.data.currentPageIndex,_this.visibleButtonIndexes=[],_this.hidden=!1,calculateDisplay(),setDisplay(),setActive(_this.data.active),_this.onInit=()=>{!function initListeners(){_this.listen("UILHistoryTab/updatePaginationIndex",(value=>{console.log("value: ",value),_this.currentPageIndex=value,calculateDisplay(),setDisplay()}))}()},_this.data.bind("active",(value=>{setActive(value)})),_this.handleClick=()=>{_this.data.callback(_this.data.index)},_this.element.goob("\n    & {\n        display: inline-block;\n        \n        &.hidden {\n            display: none;\n        }\n    }\n\n    .btn {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        min-width: 26px;\n\n        &.disabled {\n            pointer-events: none;\n        }\n    }\n\n    .has-first-ellipsis {\n        &:after {\n            content: '...';\n        }\n    }\n\n    .has-last-ellipsis {\n        &:before {\n            content: '...';\n        }\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILHistoryPaginationControls(_data,_index,_params){const _this=this;Inherit(_this,Element),Inherit(_this,ViewStateElement),Inherit(_this,XComponent),_this.fragName="UILHistoryPaginationControls",_this.contexts="Element,ViewStateElement",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"pagination",_type:"nav",refName:"unnamed",children:[{href:"#",click:"$handlePreviousClick",_type:"a",_innerText:"$state.previousLabel",refName:"btn",children:[]},{_type:"div",refName:"paginationBtnWrapper",children:[{data:"$parent.paginatedData",view:"UILHistoryPaginationButton",_type:"ViewState",refName:"unnamed",children:[]}]},{href:"#",click:"$handleNextClick",_type:"a",_innerText:"$state.nextLabel",refName:"btn",children:[]}]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.createState(),_this.state.set("previousLabel","<"),_this.state.set("nextLabel",">"),_this.handlePreviousClick=()=>{_this.parent.updatePaginationIndex(_this.parent.state.currentPageIndex-1)},_this.handleNextClick=()=>{_this.parent.updatePaginationIndex(_this.parent.state.currentPageIndex+1)},_this.element.goob("\n    & {\n        display: flex;\n        justify-content: center;\n        align-items: center;\n    }\n\n    .pagination,\n    .paginationBtnWrapper {\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        gap: calc(var(--spacing-small) / 2);\n    }\n\n    .pagination {\n        background-color: var(--color-neutral-20);\n        justify-content: space-between;\n        padding: var(--spacing-small);\n        width: 100%;\n        overflow-x: auto;\n    }\n\n    .btn {\n        background-color: transparent;\n        color: var(--color-white);\n        border-radius: 4px;\n        display: block;\n        font: var(--label3-simi);\n        line-height: 1;\n        text-decoration: none;\n        padding: calc(var(--spacing-small) / 4) calc(var(--spacing-small) / 2);\n\n        &.active {\n            background-color: var(--color-action);\n        }\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILHistoryRecord(_data,_index,_params){const _this=this;Inherit(_this,Element),Inherit(_this,ViewStateElement),Inherit(_this,XComponent),_this.fragName="UILHistoryRecord",_this.contexts="Element,ViewStateElement",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"span",refName:"metadata",children:[]},{_type:"span",_innerText:"$data.message",refName:"message",children:[]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.onInit=function(){!function initHTML(){_this.metadata.text(`${_this.data.actorName} - ${_this.data.timeFormatted}`)}()},_this.element.goob("\n    & {\n        border-bottom: 1px solid var(--color-neutral-40);\n        padding: 0.75rem 1rem;\n        word-wrap: break-word;\n        overflow-wrap: break-word;\n        word-break: break-all;\n        hyphens: auto;\n    }\n\n    .metadata,\n    .message {\n        display: flex;\n        justify-content: flex-start;\n        align-items: flex-start;\n        line-height: 14.3px;\n    }\n    \n    .metadata {\n        margin-bottom: 0.24rem;     \n        font-weight: 600;\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILHistoryTab(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILHistoryTab",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"history__panel days__body",_type:"div",refName:"dayPanel",children:[{data:"$dayData",view:"UILHistoryDay",_type:"ViewState",refName:"unnamed",children:[]}]},{className:"history__panel records",_type:"div",refName:"recordsPanel",children:[{className:"records__header",_type:"header",refName:"unnamed",children:[{className:"records__back",_type:"div",refName:"recordsBack",children:[]},{className:"records__date",_type:"h3",_innerText:"Date",refName:"recordsDateLabel",children:[]}]},{className:"records__body",_type:"div",refName:"unnamed",children:[{data:"$activePageData",view:"UILHistoryRecord",_type:"ViewState",refName:"unnamed",children:[]}]},{_type:"footer",refName:"footer",children:[{data:"$paginatedData",_type:"UILHistoryPaginationControls",refName:"unnamed",children:[]}]}]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());const dayDataId=_this.params?.actorId?`${_this.params.actorId}-days`:"days",recordsDataId=_this.params?.actorId?`${_this.params.actorId}-records`:"records";function paginateRecords(data,recordsPerPage=20,maxButtonCount=7){const result=[],pageCount=Math.ceil(data.length/recordsPerPage);pageCount<=1?_this.footer.classList().add("hidden"):_this.footer.classList().remove("hidden");for(let i=0;i<pageCount;i++){const start=i*recordsPerPage,end=start+recordsPerPage,pageItems=data.slice(start,end);result.push({currentPageIndex:_this.state.currentPageIndex,pageCount:pageCount,maxButtonCount:maxButtonCount,active:i===_this.state.currentPageIndex,index:i,label:`${i+1}`,items:pageItems,callback:activeIndex=>updatePaginationIndex(activeIndex)})}return result}function updatePaginationIndex(activeIndex){activeIndex<0||activeIndex>=_this.paginatedData.length||(_this.state.set("currentPageIndex",activeIndex),_this.paginatedData.forEach(((page,index)=>{page.active=index===activeIndex})),updateActivePageData())}function updateActivePageData(){_this.paginatedData.refresh(paginateRecords(_this.recordsData.toJSON())),_this.activePageData.refresh(_this.paginatedData[_this.state.currentPageIndex].items)}function getTime(unixTimestamp){const date=new Date(1e3*unixTimestamp),hours=date.getHours(),minutes=date.getMinutes();return`${hours%12||12}:${minutes<10?"0":""}${minutes} ${hours>=12?"PM":"AM"}`}_this.history=function getData(){const cleanHistory=UILStorage.getHistory(_this.params?.actorId).map((item=>({actorName:"",timeFormatted:getTime(item.change.time),...item.change})));return function groupByDay(list){let result={};return list.forEach((item=>{let date=function formatDate(time){const date=new Date(time),monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],monthIndex=date.getMonth(),day=date.getDate();return`${monthNames[monthIndex]} ${day}`}(1e3*item.time);result[date]||(result[date]=[]),result[date].push(item)})),result}(cleanHistory)}(),_this.dayData=Data.request(dayDataId,(()=>Object.entries(_this.history).map((([k,v])=>({date:k,amount:`(${v.length})`}))).reverse())),_this.recordsData=await Data.request(recordsDataId,(()=>_this.history[Object.keys(_this.history)[0]])),_this.createState(),_this.state.set("currentPageIndex",0),_this.paginatedData=new StateArray(paginateRecords(_this.recordsData.toJSON())),_this.activePageData=new StateArray(_this.paginatedData[_this.state.currentPageIndex].items),_this.onMounted=()=>{!function initListeners(){_this.recordsBack.click(_this.showDaysPanel)}()},_this.onInit=async function(){!async function setActorsName(){const actors=await UILStorage.getUsers();for(let key in _this.history)_this.history[key]=_this.history[key].map((record=>{const actor=actors.find((a=>a.actorId===record.actor));return record.actorName=actor?.name||"",record}))}(),function initHTML(){_this.recordsBack.html(UILHistoryTab.arrowLeftIcon)}()},_this.onSelectDay=day=>{!function updateRecordsData(day){_this.state.currentPageIndex=0,_this.recordsDateLabel.text(day),_this.recordsData.refresh([..._this.history[day]].reverse()),updateActivePageData()}(day),function showRecordsPanel(){_this.dayPanel.tween({x:"-100%"},500,"easeOutCubic"),_this.recordsPanel.tween({x:"-100%"},500,"easeOutCubic")}()},_this.updatePaginationIndex=updatePaginationIndex,_this.showDaysPanel=function(){_this.dayPanel.tween({x:0},500,"easeOutCubic"),_this.recordsPanel.tween({x:0},500,"easeOutCubic")},_this.element.goob("\n    & {\n        display: flex;\n        width: 100%;\n        height: 100%;\n        pointer-events: auto;\n        overflow: hidden;\n        padding-bottom: 40px;\n    }\n\n    .history {\n        &__panel {\n            width: 100%;\n            height: 100%;\n            flex-shrink: 0;\n            padding-bottom: 40px;\n        }\n    }\n\n    .days {\n        &__body {\n            height: 100%;\n            overflow: auto;\n        }\n    }\n\n    .records {\n        display: flex;\n        flex-direction: column;\n\n        &__header {\n            display: flex;\n            align-items: center;\n\n            border-bottom: 1px solid var(--color-neutral-40);\n        }\n\n        &__body {\n            flex-grow: 1;\n            overflow: auto;\n        }\n\n        &__back {\n            padding: 0.8125rem 1rem;\n\n            &:hover {\n                > svg { stroke: var(--font-color-base); }\n            }\n\n            > svg {\n                display: block;\n\n                stroke: var(--color-neutral-70);\n\n                transition: stroke 0.17s ease-in-out;\n            }\n        }\n\n        &__date {\n            flex-grow: 1;\n            margin: 0;\n            padding: 0.8125rem 1rem 0.8125rem 0;\n        }\n\n    }\n    \n    .footer {\n        position: absolute;\n        bottom: -1px;\n        width: 100%;\n\n        &.hidden {\n            display: none;\n        }\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()}),(_=>{UILHistoryTab.arrowLeftIcon='\n        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M10 4L6 8L10 12" stroke-linecap="round" stroke-linejoin="round"/>\n        </svg>\n    '})),Class((function UILInputButton(_data,_index,_params){const _this=this;Inherit(_this,Element),Inherit(_this,ViewStateElement),Inherit(_this,XComponent),_this.fragName="UILInputButton",_this.contexts="Element,ViewStateElement",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{className:"button small",click:"$data.callback",_type:"button",_innerText:"$data.title",refName:"button",children:[]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILInputNumber(_data,_index,_params){const _this=this;Inherit(_this,Element),Inherit(_this,ViewStateElement),Inherit(_this,XComponent),_this.fragName="UILInputNumber",_this.contexts="Element,ViewStateElement",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){let _timeout;_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{ariaLabelledBy:"$data.labelledBy",min:"$data.min",max:"$data.max",step:"$data.step",_type:"input",refName:"input",children:[]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());let _distance,_onMouseDownValue,_editing=!1,_pointer=[0,0],_prevPointer=[0,0],_step=.05,_onInputCB=()=>{},_onFinishCB=()=>{};function setValue(value){if((value=parseFloat(value).toFixed(_this.data.precision)||0)<_this.data.min&&(value=_this.data.min),value>_this.data.max&&(value=_this.data.max),isNaN(Number(value)))return _this.value=0;_this.value=Number(value),_this.data.onInputCB(_this.value,_this.master)}function updateValueAndInput(value,showDecimals=!1){setValue(value);let displayValue=showDecimals?parseFloat(_this.value).toFixed(_this.data.precision):_this.value;_editing||(_this.input.div.value=displayValue)}function onBlur(){updateValueAndInput(_this.input.div.value,!0),onFinishChange(!0)}function onKeyUp(e){13===e.keyCode&&(e.altKey?(_this.master=!0,onInput(),_this.data.onFinishCB(_this.value,_this.master)):(setValue(_this.value),_this.data.onFinishCB(_this.value,_this.master)))}function onInput(){_timeout=setTimeout(finishInput,400),_editing=!0,_this.value=_this.input.div.value}function finishInput(){isNaN(_this.input.div.value)||(setValue(_this.input.div.value),onFinishChange())}function onFinishChange(force=!1){(_editing||force)&&(_editing=!1,clearTimeout(_timeout),_this.data.onFinishCB(_this.value,_this.master),_this.master=!1)}function onMouseDown(e){(1===e.button||0===e.button&&e.metaKey||e.ctrlKey)&&(e.preventDefault(),_this.input.css({cursor:"col-resize"}),_distance=0,_onMouseDownValue=_this.value,_prevPointer=[e.screenX,e.screenY],document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("mouseup",onMouseUp,!1))}function onMouseMove(e){clearTimeout(_timeout),_editing=!0;let currentValue=_this.value;_pointer=[e.screenX,e.screenY],_distance+=_pointer[0]-_prevPointer[0]-(_pointer[1]-_prevPointer[1]);let value=Number(_onMouseDownValue)+Number(_distance/(e.shiftKey?5:50))*_step;value=Math.min(_this.data.max,Math.max(_this.data.min,value)),_this.master=e.altKey,currentValue!==value&&function setValueDrag(value){void 0===value&&value===_this.input.div.value||(setValue(value),_this.input.div.value=_this.value.toFixed(_this.data.precision),clearTimeout(_this.dragCallback),_this.dragCallback=Timer.create((_=>_this.data.onFinishCB(_this.value,_this.master)),100))}(value),_prevPointer=[e.screenX,e.screenY]}function onMouseUp(e){onFinishChange(),_this.input.css({cursor:""}),document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1)}_this.master,_this.dragCallback,_this.onMounted=()=>{updateValueAndInput(_this.data.value,!0)},function initListeners(){_this.input.div.addEventListener("mousedown",onMouseDown,!1),_this.input.div.addEventListener("keyup",onKeyUp,!1),_this.input.div.addEventListener("change",onFinishChange,!1),_this.input.div.addEventListener("blur",onBlur,!1),_this.input.div.addEventListener("input",onInput,!1)}(),_this.data.bind("value",(value=>{updateValueAndInput(value)})),_this.getValue=()=>_this.value,_this.publicSetValue=value=>{_editing?setValue(value):updateValueAndInput(value)},_this.onInput=cb=>cb,_this.onFinish=cb=>cb,_this.forceUpdate=function(value){updateValueAndInput(value)},_this.onDestroy=function(){_this.input.div.removeEventListener("mousedown",onMouseDown,!1),_this.input.div.removeEventListener("change",onFinishChange,!1),_this.input.div.removeEventListener("blur",onBlur,!1),_this.input.div.removeEventListener("input",onInput,!1)};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILMemory(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILMemory",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{data:"$statsData",view:"UILPerformanceItem",_type:"ViewState",refName:"unnamed",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.statsData=new StateArray(Object.entries(RenderCount.map).map((([key,value])=>({key:key,value:value})))),_this.startRender((function updateStats(){if(!_this.params.active)return;Object.entries(RenderCount.map).forEach((([key,value])=>{let isKeyMapped=!1;_this.statsData.forEach((d=>d.get("key")===key&&(isKeyMapped=!0))),isKeyMapped||_this.statsData.push({key:key,value:value})})),_this.statsData.forEach((d=>d.set("value",RenderCount.map[d.get("key")])))}),10),RenderCount.active=!0,_this.element.goob("\n    & {\n        width: 100%;\n        padding: var(--spacing-small);\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILPanel(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILPanel",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"UILPanelToolbar",refName:"toolbar",children:[]},{id:"$params.title",options:"$folderOptions",_type:"UILFolder",refName:"folder",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.createState(),_this.state.set("historyIsOpen",!1),_this.ready=!1,_this.id=_this.params.title,_this.folderOptions={hideTitle:!0,drag:!1};let _hidden=!1;function toggleHistory(){_this.state.set("historyIsOpen",!_this.state.historyIsOpen),_this.state.historyIsOpen?_this.element.classList().add("open"):_this.element.classList().remove("open"),_this.fire("historyPanelToggle",_this.state.historyIsOpen)}function onKeydown(e){if(e.ctrlKey||e.metaKey){if(72==e.keyCode&&e.shiftKey){if(`${document.activeElement.type}`.includes(["textarea","input","number"]))return;e.preventDefault(),_hidden?function show(){_this.element.visible(),_hidden=!1}():function hide(){_this.element.invisible(),_hidden=!0}()}37==e.keyCode&&e.shiftKey&&(e.preventDefault(),_this.element.css({left:0,right:"auto"})),39==e.keyCode&&e.shiftKey&&(e.preventDefault(),_this.element.css({left:"auto",right:0})),67==e.which&&e.shiftKey&&(e.preventDefault(),_this.folder.forEachFolder((f=>f.close()))),79==e.which&&e.shiftKey&&(e.preventDefault(),_this.folder.forEachFolder((f=>f.open())))}}_this.onMounted=()=>{_this.element.mouseEnabled(!0),_this.ready=!0,_this.params?.options?.hideToolbar&&_this.wait("toolbar").then((()=>{_this.toolbar.element.hide()})),function initListeners(){document.addEventListener("keydown",onKeydown,!1),"history"===_this.id&&(_this.element.show(),_this.bind("UILTabs/toggle-history-panel",toggleHistory))}()},_this.element.classList().add("prevent_interaction3d"),_this.element.classList().add(_this.params.title),"offscreen"===_this.params?.options?.side&&_this.element.classList().add("offscreen"),_this.add=async function(child){return await _this.wait((()=>_this.ready)),await defer(),_this.element.show(),child instanceof UILTabs?(_this.element.div.prepend(child.element.div),_this):"global"===_this.id&&child instanceof UILFolder?(UIL.globalTabs.addGlobalFolder(child),_this):(_this.folder.add(child),_this)},_this.remove=function(x){return _this.folder.remove(x.id),_this},_this.get=function(id){return _this.folder.getChildById(id)},_this.find=function(id){return _this.folder.find(id)},_this.filter=function(str){return _this.folder.filter(str)},_this.enableSorting=function(key){return _this.folder.enableSorting&&_this.folder.enableSorting(key),_this},_this.eliminate=function(){_this.toolbar.eliminate(),document.removeEventListener("keydown",onKeydown,!1)},_this.element.div.style.cssText=`\n    --panel-width: ${_this.params?.options?.width||"300px"};\n    --panel-height: ${_this.params?.options?.height||"100vh"};\n    --panel-max-height: ${_this.params?.options?.maxHeight||"100vh"};\n    --timing: ${TweenManager._getEase("easeOutCubic")};\n`,_this.element.goob(`\n    & {\n        background-color: var(--panel-background-color);\n        width: var(--panel-width);\n        height: var(--panel-height);\n        max-height: var(--panel-max-height);\n        overflow-y: auto;\n        user-select: none;\n        position: absolute;\n        top: 0;\n        left: ${"left"===_this.params?.options?.side?"0":"auto"};\n        right: ${"left"!==_this.params?.options?.side?"0":"auto"};\n        opacity: 0.6;\n        transition: opacity 0.2s var(--timing);\n        pointer-events: all;\n        border-radius: 20px;\n        margin-left: 10px;\n        margin-right: 10px;\n\n        &:hover {\n            opacity: 1;\n        }\n    }\n\n    &.history {\n        opacity: 1;\n        right: calc(var(--panel-width) * -1);\n        transition: right 0.5s ease-out;\n\n        &.open {\n            right: 0;\n        }\n    }\n`);for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILPanelToolbar(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILPanelToolbar",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"input",refName:"filterInput",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());let _state=new Map;function restoreFolderState(){_this.parent.folder.forEachFolder((folder=>{_state.get(folder)?folder.open():folder.close()})),_state.clear()}function onInput(e){if(!_this.filterInput.div.value.length)return restoreFolderState(),_this.parent.folder.showChildren();_this.parent.folder.filter(_this.filterInput.div.value)}function onFocus(){!function saveFolderState(){_this.parent.folder.forEachFolder((folder=>{_state.set(folder,folder.isOpen())}))}(),_this.filterInput.css({border:"1px solid #37a1ef"})}function onBlur(){_this.filterInput.css({border:"1px solid #2e2e2e"})}function onKeyPressed(e){if(27===e.keyCode)return _this.filterInput.div.value="",restoreFolderState(),_this.parent.folder.showChildren()}_this.ready=!1,function initListeners(){_this.filterInput.div.addEventListener("input",onInput,!1),_this.filterInput.div.addEventListener("keydown",onKeyPressed,!1),_this.filterInput.div.addEventListener("focus",onFocus,!1),_this.filterInput.div.addEventListener("blur",onBlur,!1)}(),_this.onMounted=()=>{_this.ready=!0},_this.eliminate=function(){_this.filterInput.div.removeEventListener("input",onInput,!1),_this.filterInput.div.removeEventListener("keydown",onKeyPressed,!1),_this.filterInput.div.removeEventListener("focus",onFocus,!1),_this.filterInput.div.removeEventListener("blur",onBlur,!1)},_this.filter=function(text){_this.filterInput.div.value=text,onInput()},_this.filterSingle=async function(text){_this.filterInput.div.value=text,_this?.parent?.folder?.filterSingle(_this.filterInput.div.value)},_this.hideAll=function(){_this.flag("init")||(_this.flag("init",!0),this.filterSingle("xxxxxx"))},_this.element.goob("\n    & {\n        background-color: var(--panel-background-color);\n        padding: calc(var(--spacing-small) / 2);\n        padding-bottom: 0;\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILPerformance(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILPerformance",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{data:"$statsData",view:"UILPerformanceItem",_type:"ViewState",refName:"unnamed",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.statsData=new StateArray(Object.entries(RenderStats.stats).map((([key,value])=>({key:key,value:value})))),_this.startRender((function updateStats(){if(RenderStats.active=_this.params.active,!_this.params.active)return;Object.entries(RenderStats.stats).forEach((([key,value])=>{let isKeyMapped=!1;_this.statsData.forEach((d=>d.get("key")===key&&(isKeyMapped=!0))),isKeyMapped||_this.statsData.push({key:key,value:value})})),_this.statsData.forEach((d=>d.set("value",RenderStats.stats[d.get("key")])))}),10),_this.element.goob("\n    & {\n        width: 100%;\n        padding: var(--spacing-small);\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILPerformanceItem(_data,_index,_params){const _this=this;Inherit(_this,ViewStateElement),Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILPerformanceItem",_this.contexts="ViewStateElement,Element",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"span",_innerText:"$data.key",refName:"unnamed",children:[]},{_type:"span",_innerText:"$data.value",refName:"unnamed",children:[]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.element.goob("\n    & {\n        display: flex;\n        font: var(--label3);\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: calc(var(--spacing-small) / 2);\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILTabs(_params,...restArgs){const _this=this;Inherit(_this,Element),Inherit(_this,XComponent),_this.fragName="UILTabs",_this.contexts="Element",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"header",refName:"tabsHeader",children:[{_type:"nav",refName:"nav",children:[{view:"UILTabsNavItem",data:"$state.tabsData",_type:"ViewState",refName:"unnamed",children:[]}]}]},{_type:"section",refName:"tabsContent",children:[{view:"UILTabsContentItem",data:"$state.tabsData",_type:"ViewState",refName:"unnamed",children:[]}]},{click:"$handleHistoryClick",_type:"button",refName:"historyButton",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.ready=!1,_this.createState(),_this.state.set("tabsData",new StateArray(_this.params)),_this.state.set("activeIndex",0),_this.state.set("historyLabel","History"),_this.state.bind("historyLabel",_this.historyButton),_this.onMounted=async()=>{_this.historyButton.hide(),function initListeners(){_this.bindState(_this.state,"activeIndex",(value=>{!function updateActiveTab(){_this.state.tabsData.forEach(((tab,index)=>{tab.active=_this.state.activeIndex===index})),_this.tabsContent.tween({x:-_this.element.div.offsetWidth*_this.state.activeIndex},200,"easeOutCubic")}()})),_this.bind("UILPanel/historyPanelToggle",(value=>{value?_this.state.set("historyLabel","Hide History"):_this.state.set("historyLabel","History")}))}(),_this.element.attr("style",`\n        --tab-content-width: 300px;\n        --tab-count: ${_this.state.tabsData.length};\n    `),_this.ready=!0},_this.listen("UILTabsNavItem/click",(event=>{_this.state.tabsData.forEach(((tab,index)=>{tab.id===event.id&&_this.state.set("activeIndex",index)}))})),_this.handleHistoryClick=()=>{_this.fire("toggle-history-panel")},_this.setActiveTab=index=>{_this.state.set("activeIndex",index)},_this.addTab=tabData=>{},_this.removeTab=tabId=>{},_this.setDisabledTab=tabId=>{},_this.setHiddenTab=tabId=>{},_this.addGraph=graph=>{_this.state.tabsData.find((tab=>"playground"===tab.id)).content=graph},_this.addGlobalFolder=folder=>{_this.state.tabsData.find((tab=>"global"===tab.id)).content=folder},_this.showHistoryButton=async()=>{await _this.wait((()=>_this.ready)),await defer()},_this.element.goob("\n    & {\n        box-sizing: border-box;\n        color: #fff;\n        width: 100%;\n        height: 100%;\n        overflow: hidden;\n        position: relative;\n    }\n\n    .tabsHeader {\n        background-color: var(--panel-background-color);\n        border-bottom: var(--border);\n        font: var(--label3-semi);\n    }\n    \n    .nav {\n        display: flex;\n        width: 100%;\n    }\n\n    .tabsContent {\n        display: flex;\n        width: calc(var(--tab-content-width) * var(--tab-count));\n        height: 100%;\n\n        .UILPanel.global & {\n            height: calc(100% - 39px);\n        }\n    }\n\n    .UILTabsContentItem {\n        width: var(--tab-content-width);\n    }\n\n    .historyButton {\n        background-color: var(--color-neutral-20);\n        border: none;\n        color: var(--color-neutral-70);\n        border-radius: 0;\n        width: 100%;\n        text-align-last: left;\n        position: absolute;\n        bottom: 0;\n        left: 0;\n        padding: var(--spacing-small);\n\n        &:hover {\n            color: var(--color-white);\n        }\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILTabsContentItem(_data,_index,_params){const _this=this;Inherit(_this,Element),Inherit(_this,ViewStateElement),Inherit(_this,XComponent),_this.fragName="UILTabsContentItem",_this.contexts="Element,ViewStateElement",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){function destroyToolbar(){_this.toolbar.destroy()}function destroyFolder(){_this.folder.destroy()}_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{_type:"article",refName:"contentContainer",children:[{_type:"UILPanelToolbar",refName:"toolbar",children:[]},{id:"$data.label",options:"$folderOptions",_type:"UILFolder",refName:"folder",children:[]}]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.ready=!1,_this.folderOptions={hideTitle:!0,drag:!1},_this.onMounted=()=>{_this.ready=!0,_this.set("container",_this.contentContainer)},_this.data.bind("content",(async value=>{value&&(await _this.wait((()=>_this.ready)),await defer(),"function"==typeof value?(destroyToolbar(),destroyFolder(),function addHydraObject(hydraObject){_this.initClass(hydraObject,_this.data,[_this.contentContainer])}(value)):value instanceof UILFolder?function addFolder(folder){_this.folder.add(folder)}(value):"object"==typeof value&&(destroyToolbar(),destroyFolder(),function addHTML(markup){_this.contentContainer.add(markup)}(value)))})),_this.element.goob("\n    & {\n        height: 100%;\n        max-height: 100vh;\n        overflow-y: auto;\n        \n        .UILPanel.global & {\n            max-height: calc(100vh - 40px);\n            padding-bottom: 40px;\n        }\n    }\n\n    .UILPanel.history & {\n        .contentContainer {\n            height: 100%;\n        }\n    }\n    \n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function UILTabsNavItem(_data,_index,_params){const _this=this;Inherit(_this,Element),Inherit(_this,ViewStateElement),Inherit(_this,XComponent),_this.fragName="UILTabsNavItem",_this.contexts="Element,ViewStateElement",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{click:"$onClick",href:"$state.anchor",_type:"a",_innerText:"$data.label",refName:"tab",children:[]}]}),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.createState(),_this.state.set("anchor",`#${_this.data.id}`),_this.onClick=event=>{event.preventDefault(),_this.fire("click",{id:_this.data.id})},_this.data.bind("active",(value=>{const action=value?"add":"remove";_this.tab.classList()[action]("active")})),_this.element.goob("\n    & {\n        &:last-of-type {\n            .tab:after {\n                display: none;\n            }\n        }\n    }\n\n    .tab {\n        color: var(--color-action--disabled);\n        display: block;\n        font: var(--label3-semi);\n        padding: var(--spacing-small);\n        text-decoration: none;\n        position: relative;\n\n        &:after {\n            content: '';\n            display: block;\n            width: 1px;\n            height: 66%;\n            background-color: var(--color-neutral-40);\n            position: absolute;\n            right: 0;\n            top: 16.666%;\n        }\n        \n        &.active {\n            color: var(--font-color-base);\n        }\n    }\n");for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function ViewController(_params,...restArgs){const _this=this;Inherit(_this,Frag3D,"ViewController"),Inherit(_this,Router,null,""),Inherit(_this,XComponent),_this.fragName="ViewController",_this.contexts='Frag3D, "ViewController",Router, null, ""',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){let video;_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),(_this.nuke||World.NUKE).paused=!0,_this.ref_ShaderVariants929=_this.initClass(ShaderVariants),_this.ref_ShaderVariants929.isFragment&&_promises.push(_this.wait(_this.ref_ShaderVariants929,"__ready")),_this.ref_Home118=_this.initClass(Home),_this.ref_Home118.isFragment&&_promises.push(_this.wait(_this.ref_Home118,"__ready")),_this.ref_About411=_this.initClass(About),_this.ref_About411.isFragment&&_promises.push(_this.wait(_this.ref_About411,"__ready")),_this.work=_this.initClass(Work),_this.work.isFragment&&_promises.push(_this.wait(_this.work,"__ready")),_this.ref_TreeScene70=_this.initClass(TreeScene),_this.ref_TreeScene70.isFragment&&_promises.push(_this.wait(_this.ref_TreeScene70,"__ready")),_this.ref_CleanRoom918=_this.initClass(CleanRoom),_this.ref_CleanRoom918.isFragment&&_promises.push(_this.wait(_this.ref_CleanRoom918,"__ready")),_this.ref_Footer464=_this.initClass(Footer),_this.ref_Footer464.isFragment&&_promises.push(_this.wait(_this.ref_Footer464,"__ready")),_this.scroll=_this.initClass(FXScroll,AppState.createLocal({angle:.7,pingPong:Tests.pingPongRender(),keyboard:"false",virtualScroll:"false",pageScalar:Device.mobile.phone?.5:1},!0)),_this.scroll.isFragment&&_promises.push(_this.wait(_this.scroll,"__ready")),_this.ref_NavUI747=_this.initClass(NavUI),_this.ref_NavUI747.isFragment&&_promises.push(_this.wait(_this.ref_NavUI747,"__ready")),_this.ref_ContactUI647=_this.initClass(ContactUI),_this.ref_ContactUI647.isFragment&&_promises.push(_this.wait(_this.ref_ContactUI647,"__ready")),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.set("hasMusic",!Tests.noMusic()),_this.uniforms={uRGBStrength:{value:1},uContrast:{value:new Vector2(1,1)},uScrollDelta:{value:0},uScroll:{value:0},tNormal:{value:Utils3D.getTexture("assets/images/pbr/damaged_road_normal.jpg"),getTexture:Utils3D.getRepeatTexture},uMouse:{value:new Vector2},uNormalScale:{value:1},uFrostCorner:{value:new Vector3(.8,.9,.1)},uGradient:{value:new Vector2(0,1)},uContact:{value:0},uVisible:{value:0},uChatOpen:{value:0},uUIColor:{value:new Color("#ff0000")},uMobile:{value:Device.mobile.phone?1:0},uUIBlend:{value:0}},_this.set("uniforms",_this.uniforms),Device.mobile&&_this.uniforms.uFrostCorner.value.set(.75,1.4,.35),_this.bind("ViewController/contact",(active=>{active?_this.composite.tween("uContact",1,1500,"workInOut"):_this.composite.tween("uContact",0,1500,"workInOut")})),_this.bind("Work/project",((data,prevData)=>{data?(_this.composite.set("uUIColor",new Color("#"+data.color)),_this.composite.tween("uUIBlend",1,1500,"workInOut")):prevData&&_this.composite.tween("uUIBlend",0,1500,"workInOut")})),_this.onInit=_=>{MouseFluid.instance().applyTo(_this.composite.pass),["home","about","work","tree","contact","footer"].forEach((key=>{_this.createShaderVariant(key,_this.bloom.compositeShader)})),_this.bind("Router/state",(val=>{val&&_this.setShaderVariant(val.split("/")[0])})),_this.listen("Global/loadFinished",(_=>{_this.composite.set("uVisible",0),_this.composite.tween("uVisible",1,6e3,"workInOut")}))},Tests.videoVFX()?(video=_this.createFragment(VideoTexture,"assets/video/reel.mp4",{firstFrame:"assets/video/reel-frame.jpg"}),video.start()):video=Utils3D.getTexture("assets/images/room/matcap-test.jpg"),_this.set("video",video),_this.bind("FXScroll/initialized",(_=>_this.set("scroll",_this.scroll)));let scrolled=0,delta=0;_this.startRender((_=>{if(_this.scroll&&_this.scroll.progress){let dif=scrolled-_this.scroll.progress;delta=Math.clamp(1500*dif,-3,3),scrolled=_this.scroll.progress}let lerp=Device.mobile?.15:.1;_this.uniforms.uScrollDelta.value=Math.lerp(delta,_this.uniforms.uScrollDelta.value,lerp),_this.uniforms.uScroll.value=Math.lerp(20*scrolled,_this.uniforms.uScroll.value,lerp),_this.uniforms.uMouse.value=Math.lerp(Mouse.normal,_this.uniforms.uMouse.value,lerp),_this.uniforms.uGradient.value.x=Device.mobile&&Stage.width<Stage.height?.05:.02,_this.uniforms.uGradient.value.y=Device.mobile&&Stage.width<Stage.height?2:.9,_this.set("visibleV",_this.uniforms.uVisible.value),_this.set("scrollV",_this.uniforms.uScroll.value),_this.set("scrollDeltaV",_this.uniforms.uScrollDelta.value)})),World.SCENE.add(_this.group),_this.listen("resetWork",(_=>{_this.get("Router/state").includes?.("work")&&_this.scroll.scrollTo(_this.work,1e3)})),_this.listen("topOfWork",(_=>{_this.scroll.scrollTo(_this.work)})),_this.listen("bottomOfWork",(_=>{_this.scroll.scrollTo(_this.work.end-Stage.height)})),_this.listen("goToWork",(_=>{_this.scroll.scrollTo(_this.work,1e3)})),_this.bind("navigate",(path=>_this.navigate(path))),_this.bind("Work/project",(data=>{document.title=data?`${data.title} · Active Theory`:"Active Theory · Creative Digital Experiences"}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.composite=_this.initClass(NukePass,AppState.createLocal({shader:"GlobalComposite",uniforms:_this.uniforms},!0)),_this.composite.isFragment&&_promises.push(_this.wait(_this.composite,"__ready")),_this.nuke&&(_this.composite.texture=_this.nuke.rttBuffer),_this.bloom=_this.initClass(FX.UnrealBloom,AppState.createLocal({unique:"globalbloom",nuke:_this.nuke,dpr:.3,enabled:Tests.bloom()},!0)),_this.bloom.isFragment&&_promises.push(_this.wait(_this.bloom,"__ready")),_this.bloom.uniforms&&_this.composite.addUniforms(_this.bloom.uniforms),_this.ref_FXHydraLensStreak386=_this.initClass(FX.HydraLensStreak,AppState.createLocal({nuke:_this.nuke,enabled:Tests.lensStreak()},!0)),_this.ref_FXHydraLensStreak386.isFragment&&_promises.push(_this.wait(_this.ref_FXHydraLensStreak386,"__ready")),_this.ref_FXHydraLensStreak386.uniforms&&_this.composite.addUniforms(_this.ref_FXHydraLensStreak386.uniforms),(_this.composite.upload||_this.composite.pass)&&((_this.nuke||World.NUKE).add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite),ShaderUIL.add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite)),(_this.nuke||World.NUKE).paused=!1,_this._initFXScroll([{vh:"4",cameraMove:"20",privateRoute:"home",view:"$ref_Home118"},{vh:"1",cameraMove:"2",cameraLayer:"camera",privateRoute:"about",view:"$ref_About411"},{vh:"10",route:"work",view:"$work"},{vh:"2",cameraMove:"6",cameraLayer:"camera",privateRoute:"tree",view:"$ref_TreeScene70"},{vh:"1.2",cameraMove:"4",cameraLayer:"camera",privateRoute:"contact",view:"$ref_CleanRoom918"},{vh:"4",cameraMove:"20",privateRoute:"footer",view:"$ref_Footer464"}]),_this.initClass(StateInitializer,MusicPlayerDOM,"music",void 0,{init:"hasMusic"}),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WallShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="WallShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({uRUVOffset:{value:new Vector2},uRUVScale:{value:1}});for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WaterCeilingShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="WaterCeilingShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),fbr(_this.shader),_this.shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},tVideo:{value:null}}),_this.onInit=async _=>{let video=await _this.get("ViewController/video");_this.shader.uniforms.tVideo=video.uniform};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function Work(_params,...restArgs){const _this=this;Inherit(_this,FragFXScene,"Work"),Inherit(_this,XComponent),_this.fragName="Work",_this.contexts='FragFXScene, "Work"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.detail=_this.initClass(WorkDetail),_this.detail.isFragment&&_promises.push(_this.wait(_this.detail,"__ready")),_this._initFXScene(World.NUKE,null,{format:void 0,type:void 0,minFilter:void 0,magFilter:void 0,multiRenderTarget:void 0,mipmaps:void 0,screenQuad:void 0,vrMode:void 0,multisample:void 0,samplesAmount:void 0}),_this.refractionLayer=_this.initClass(FXLayer,AppState.createLocal({name:"WorkRefraction"},!0)),_this.refractionLayer.isFragment&&_promises.push(_this.wait(_this.refractionLayer,"__ready")),_this.refraction=_this.initClass(SnapshotFrame,AppState.createLocal({texture:_this.refractionLayer},!0)),_this.refraction.isFragment&&_promises.push(_this.wait(_this.refraction,"__ready")),(_this.nuke||World.NUKE).paused=!0,_this.chat=_this.initClass(ChatDOM),_this.chat.isFragment&&_promises.push(_this.wait(_this.chat,"__ready")),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.uniforms={uRGBStrength:{value:1},uContrast:{value:new Vector2(1,1)},uTransition:{value:0},tDetail:{value:_this.detail}},_this.detail&&(_this.detail.visible=!1),_this.set("refraction",_this.refraction),_this.set("pane",_this.layers.pane),_this.set("pane_ui",_this.layers.pane_ui),_this.set("camera",_this.layers.camera),_this.set("scene",_this.scene),_this.layers.camera.lock(),Device.mobile?.phone&&(_this.layers.camera.setFOV(55),_this.layers.flower.group.scale.y*=1.2),GLA11y.registerPage(_this.scene,"WorkPage");let video=_this.createFragment(VideoTexture,"https://storage.googleapis.com/activetheory-v6.appspot.com/media/prometheus (720p).mp4",{preload:!1});_this.set("video",video),_this.bind("WorkItems/videoURL",(async src=>{video.src=src,await video.start(),_this.fire("updatedVideo",src)}));let flowerRotation=0;_this.startRender((async _=>{await _this.layers.flower.ready(),null!=_this.scrollProgress&&(_this.layers.flower.shader.uniforms.uRotate.value=Math.lerp(flowerRotation,_this.layers.flower.shader.uniforms.uRotate.value,.05),_this.layers.flower.group.rotation.y=Math.radians(100),_this.layers.flower.shader.uniforms.uScroll.value=_this.scrollProgress,_this.layers.flower.shader.uniforms.uSparkle.value+=.005,_this.set("scrollProgress",_this.scrollProgress))}));var _scroll=Scroll.getUnlimited();function checkScrollOut(){Math.abs(_scroll.delta.y)>(Device.mobile?20:10)&&_this.set("Work/project",null)}_this.events.sub(Keyboard.DOWN,(async e=>{e&&e.key&&e.key.toLowerCase().includes(["escape"])&&_this.set("Work/project",null)})),TweenManager.addCustomEase({name:"workInOut",curve:"cubic-bezier(.29,.05,.06,.92)"}),_this.bind("ViewController/resetWork",(_=>{null!=_this.scrollProgress&&(flowerRotation+=2*Math.radians(360*_this.scrollProgress),_this.layers.flower.shader.uniforms.uSparkle.value=0)})),_this.bind("Work/project",((data,prevData)=>{data?(_this.scrollProgress<.07?_this.fire("ViewController/topOfWork"):_this.scrollProgress>.93&&_this.fire("ViewController/bottomOfWork"),_this.findParent("ViewController").lockScroll(),_this.startRender(checkScrollOut),_this.detail&&(_this.detail.visible=!0),_this.composite.tween("uTransition",1,1500,"workInOut").onComplete((_=>{}))):prevData&&(_this.fire("ChatDOM/clearText"),_this.fire("ChatDOM/resetOptions"),_this.navigate("work"),_this.findParent("ViewController").unlockScroll(),_this.stopRender(checkScrollOut),_this.composite.tween("uTransition",0,800,"workInOut").onComplete((_=>{_this.detail.visible=!1})))})),_this.bind("FXScroll/initialized",(_=>{Initializer3D.uploadAllAsync(_this.detail.layout)})),_this.onInit=async _=>{await _this.layers.flower.ready();let attenuation=1;Tests.particleCount()<=16384?attenuation=1.6:Tests.particleCount()<=65536?attenuation=1.4:Tests.particleCount()<=262144&&(attenuation=1.2),Device.mobile.phone&&(attenuation*=.8),_this.layers.flower.shader.addUniforms({uSizeBias:{value:attenuation}})};for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.composite=_this.initClass(NukePass,AppState.createLocal({shader:"WorkComposite",uniforms:_this.uniforms},!0)),_this.composite.isFragment&&_promises.push(_this.wait(_this.composite,"__ready")),_this.nuke&&(_this.composite.texture=_this.nuke.rttBuffer),(_this.composite.upload||_this.composite.pass)&&((_this.nuke||World.NUKE).add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite),ShaderUIL.add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite)),(_this.nuke||World.NUKE).paused=!1,_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WorkDetail(_params,...restArgs){const _this=this;Inherit(_this,FragFXScene,"WorkDetail"),Inherit(_this,XComponent),_this.fragName="WorkDetail",_this.contexts='FragFXScene, "WorkDetail"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this._initFXScene(World.NUKE,null,{format:void 0,type:void 0,minFilter:void 0,magFilter:void 0,multiRenderTarget:void 0,mipmaps:void 0,screenQuad:void 0,vrMode:void 0,multisample:void 0,samplesAmount:void 0}),_this.particles=_this.initClass(WorkDetailParticles),_this.particles.isFragment&&_promises.push(_this.wait(_this.particles,"__ready")),_this.content=_this.initClass(WorkDetailContent),_this.content.isFragment&&_promises.push(_this.wait(_this.content,"__ready")),(_this.nuke||World.NUKE).paused=!0,_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.scene.add(_this.content.group),_this.uniforms={uRGBStrength:{value:1}};var _targetZ=0;let cube=_this.layers.cube,camera=_this.layers.camera;_this.set("camera",camera),camera.lock(),cube.shader.set("tRefraction",_this.particles),Device.mobile&&camera.still(),MouseFluid.instance().applyTo(cube.shader),GLA11y.registerPage(_this.scene,"WorkDetailPage"),_this.onResize((_=>{let width=Stage.width/Stage.height*5;cube.scale.set(width,5,5).multiplyScalar(1),cube.position.z=.35*cube.scale.z;const distance=2.5/Math.tan(Math.radians(camera.camera.fov/2));camera.group.position.z=distance,_targetZ=distance})),_this.onInit=async _=>{await _this.wait((_=>!!_this.nuke)),await _this.wait(_this.nuke,"finalTexture"),cube.shader.set("tPrevFrame",_this.nuke.finalTexture)},_this.bind("Work/project",(data=>{data?(_this.fire("WorkDetailContent/updateText",data),_this.particles.layers.camera.group.position.z=25,camera.group.position.z=_targetZ+5,tween(camera.group.position,{z:_targetZ},1500,"workInOut"),tween(_this.particles.layers.camera.group.position,{z:0},1500,"workInOut")):tween(camera.group.position,{z:_targetZ+5},1500,"workInOut")}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.composite=_this.initClass(NukePass,AppState.createLocal({shader:"WorkDetailComposite",uniforms:_this.uniforms},!0)),_this.composite.isFragment&&_promises.push(_this.wait(_this.composite,"__ready")),_this.nuke&&(_this.composite.texture=_this.nuke.rttBuffer),(_this.composite.upload||_this.composite.pass)&&((_this.nuke||World.NUKE).add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite),ShaderUIL.add(_this.composite.pass instanceof NukePass?_this.composite.pass:_this.composite)),(_this.nuke||World.NUKE).paused=!1,_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WorkDetailContent(_params,...restArgs){const _this=this;Inherit(_this,Frag3D,"WorkDetailContent"),Inherit(_this,XComponent),_this.fragName="WorkDetailContent",_this.contexts='Frag3D, "WorkDetailContent"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),MouseFluid.instance().applyTo(_this.layers.video.shader);let video=await _this.get("Work/video");_this.layers.video.shader.set("tMap",video),_this.modal||function createModal(){if(_this.modal)return;_this.modal=Stage.create("VideoModal"),_this.modal.css({display:"none"}),_this.modal.goob("\n        position: absolute;\n        align-items: center;\n        justify-content: center;\n        display: flex;\n\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        z-index: 2;\n        padding: 25px;\n\n        background-color: #000000cc;\n    "),_this.video=document.createElement("video"),_this.video.src=Assets.getPath("assets/video/reel.mp4"),_this.video.controls=!0,_this.video.style.width="100%",_this.video.style.height="auto",_this.closeButton=_this.modal.create("closeButton"),_this.closeButton.interact(null,(_=>closeModal()),"#","Close Video",{role:"button"}),_this.closeButton.goob(`\n        position: absolute !important;\n        top: 22px;\n        right: 22px;\n        z-index: 3;\n\n        width: 18px;\n        height: 18px;\n\n        border: none;\n        background: transparent url(${Assets.getPath("assets/images/ui/close.svg")});\n        background-size: cover;\n        background-position: center;\n        background-repeat: no-repeat;\n\n        @media (hover:hover) {\n            &:hover {\n                transition: 0.1s all ease;\n                transform: scale(1.1);\n            }\n        }\n    `),_this.modal.div.appendChild(_this.video),Stage.add(_this.modal)}(),_this.onFullscreenHover=e=>{tween(e.mesh.scale,"over"==e.action?{x:.55,y:.55}:{x:.5,y:.5},300,"easeOutCubic")},_this.onFullscreenClick=_=>{_this.modal.css({display:"flex",zIndex:"9999"}),_this.video.play()};let camera=await _this.get("WorkDetail/camera");Interaction3D.find(camera).add(_this.layers.button,_this.onFullscreenHover,_this.onFullscreenClick,{url:"#",label:"Open fullscreen video"}),_this.bind("Router/state",(val=>{val.includes("work/")||closeModal()}));const getText=text3d=>text3d.text.text.string;GLA11y.textNode(_this.layers.title.group,getText(_this.layers.title)),GLA11y.textNode(_this.layers.date.group,getText(_this.layers.date));let count=0;function closeModal(){_this.video.pause(),_this.video.currentTime=0,_this.modal.css({display:"none"})}_this.bind("updateText",(({title:title,date:date,body:body,tags:tags,caseStudyURL:caseStudyURL,projectURL:projectURL,ai:ai,color:color})=>{_this.layers.title.setText(title),_this.layers.date.setText(date),count++,count>1&&(_this.layers.body.visible=!1),_this.layers.body.text.alpha=0,_this.layers.body.text.tween({alpha:1},2e3,"easeInOutSine",1500);let text=date.replace(/\n/g," / ");text=text.split(",")[0];let col=new Color(Stage.width<768?"#"+color:"#ffffff"),hsl=col.getHSL();tags.split(", ")[0];_this.fire("ChatDOM/clearText"),col.setHSL(hsl.h,hsl.s,.6+.3*hsl.l),_this.set("ChatDOM/updateText",{text:`${title}`,color:col.getHexString(),animated:!0}),col.setHSL(hsl.h,hsl.s,.45+.3*hsl.l),_this.set("ChatDOM/updateText",{text:`${text}`,color:col.getHexString(),animated:!0,delay:300}),col.setHSL(hsl.h,hsl.s,.6+.3*hsl.l),_this.set("ChatDOM/updateText",{text:body,color:col.getHexString(),animated:!0,delay:600}),caseStudyURL&&_this.set("ChatDOM/updateLink",{title:"Medium Case Study",href:caseStudyURL,animated:!0,delay:800}),projectURL&&_this.set("ChatDOM/updateLink",{title:"Project Link",href:projectURL,animated:!0,delay:900}),_this.set("ChatDOM/updateFilter",{title:"<- Close",tag:null,animated:!0,delay:1400}),GLA11y.textNode(_this.layers.title.group,title),GLA11y.textNode(_this.layers.date.group,date),ai||_this.fire("CMSData/readyForResponse")})),_this.layers.title.originTransform=Utils3D.cloneTransform(_this.layers.title),_this.layers.date.originTransform=Utils3D.cloneTransform(_this.layers.date),_this.layers.video.originTransform=Utils3D.cloneTransform(_this.layers.video),_this.onResize((_=>{if(Stage.width<500){_this.layers.title.group.scale.set(.5,.5,1);let vscale=Math.map(Stage.width,350,800,.45,1,!0);_this.layers.video.scale.copy(_this.layers.video.originTransform.scale),_this.layers.video.scale.x*=vscale,_this.layers.video.scale.y*=vscale,_this.layers.video.position.y=.5,_this.layers.title.group.position.set(0,.05,2),_this.layers.date.group.position.set(1,1.2,1.5)}else _this.layers.title.group.scale.copy(_this.layers.title.originTransform.scale),_this.layers.video.scale.copy(_this.layers.video.originTransform.scale),_this.layers.title.group.position.copy(_this.layers.title.originTransform.position),_this.layers.date.group.position.copy(_this.layers.date.originTransform.position)}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WorkDetailParticles(_params,...restArgs){const _this=this;Inherit(_this,FragFXScene,"WorkDetailParticles"),Inherit(_this,XComponent),_this.fragName="WorkDetailParticles",_this.contexts='FragFXScene, "WorkDetailParticles"',_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this._initFXScene(World.NUKE,null,{format:void 0,type:void 0,minFilter:void 0,magFilter:void 0,multiRenderTarget:void 0,mipmaps:void 0,screenQuad:void 0,vrMode:void 0,multisample:void 0,samplesAmount:void 0}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.layers.camera.lock(),Device.mobile&&_this.layers.camera.still();let video=await _this.get("Work/video");await _this.layers.particles.ready();let attenuation=1;Tests.particleCount()<=16384?attenuation=1.4:Tests.particleCount()<=65536?attenuation=1.2:Tests.particleCount()<=262144&&(attenuation=1.1),_this.layers.particles.shader.addUniforms({tVideo:{value:video},uSizeBias:{value:attenuation}});for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WorkItem(_data,_index,_params){const _this=this;Inherit(_this,Object3D),Inherit(_this,ViewStateElement),Inherit(_this,XComponent),_this.fragName="WorkItem",_this.contexts="Object3D,ViewStateElement",_this.data=_data,_this.index=_index,_this.params=_params,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.data=_data,_this.index=_index,_this.params=_params,_this.createState(),_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());let stillTexture=Utils3D.getTexture(_this.data.thumbnailURL),mesh=(await _this.get("Work/pane")).clone(),mesh_shader=mesh.shader.clone();_this.add(mesh),mesh.shader=mesh_shader,mesh.visible=!0,mesh.shader.upload();let ui=(await _this.get("Work/pane_ui")).clone(),ui_shader=ui.shader.clone();async function updateLayout(){Device.mobile&&Stage.height>Stage.width?(mesh.scale.x=2.9,mesh.scale.y=2.7,mesh.shader.uniforms.uScale.value.x=1.6,mesh.shader.uniforms.uScale.value.y=.9):(mesh.shader.uniforms.uScale.value.x=1,mesh.shader.uniforms.uScale.value.y=1,mesh.scale.copy(mesh.oScale))}_this.add(ui),ui.shader=ui_shader,ui.shader.depthWrite=!1,ui.visible=!0,ui.frustumCulled=!1,ui.position.z=0,ui.shader.upload(),mesh.oScale=(new Vector3).copy(mesh.scale),updateLayout(),_this.onResize(updateLayout),_this.onInit=async _=>{let video=await _this.get("Work/video");video&&(mesh.shader.uniforms.tVideo.value=video),ui.shader.set("tMap",_this.paneRT.bitmap.capture),ui.shader.set("uColor",new Color("#"+_this.data.color)),mesh.shader.uniforms.uColor.value=new Color("#"+_this.data.color),mesh.shader.set("tMap",stillTexture),_this.bind("Work/updatedVideo",(src=>{src===_this.data.videoURL?(mesh.shader.uniforms.tVideo.value=video,mesh.shader.tween("uVideoBlend",1,500,"easeOutSine",300)):mesh.shader.set("uVideoBlend",0)}))},_this.setRenderOrder=i=>{mesh.renderOrder=i,ui.renderOrder=i+1};let mouse=new Vector2;_this.startRender((_=>{mouse.lerp(Mouse.normal,.08),mesh.shader.uniforms.uMouse.value=mouse,mesh.shader.uniforms.uHover.value=Math.lerp(_this.hovered?1:0,mesh.shader.uniforms.uHover.value,.08),ui.shader.uniforms.uHover.value=mesh.shader.uniforms.uHover.value,ui.shader.uniforms.uCamDistance.value=_this.paneRT.camdistance}));let camera=await _this.get("Work/camera");Interaction3D.find(camera).add(mesh,(function onHover(e){if(e.seo&&"over"===e.action){if(!_this.parent||!_this.parent.views)return;let t=invSmooth(_this.data.index/_this.parent.views.length),scroll=Math.range(t,0,1,root.start,root.start+root.height,!0);_this.get("ViewController/scroll").scrollTo(scroll)}_this.hovered="over"==e.action}),(function onClick(e){if(_this.__distToCamera>30)return;defer((_=>{!_this.get("ChatDOM/isFocused",!0)&&Date.now()-_this.get("ChatDOM/lastClick")>50&&_this.findParent("Work").scrollProgress<.96&&!_this.get("ViewController/contact",!0)&&_this.navigate(`work/${_this.data.perma}`)}))}),{url:`work/${_this.data.perma}`,label:_this.data.seo});let root=_this.findParent("Work");const invSmooth=x=>x+(x-x*x*(3-2*x));_this.bind("Router/state",(val=>{val==`work/${_this.data.perma}`&&(_this.set("Work/project",_this.data),_this.set("WorkItems/videoURL",_this.data.videoURL)),val.includes("/")}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.paneRT=_this.initClass(WorkPaneUI,AppState.createLocal({title:_this.data.title,copy:_this.data.subhead,projectLogo:_this.data.projectLogo,clientName:_this.data.clientName,mesh:mesh},!0)),_this.paneRT.isFragment&&_promises.push(_this.wait(_this.paneRT,"__ready")),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WorkItemShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="WorkItemShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());let mouse=new Vector2;_this.shader.addUniforms({tMap:{value:null},tVideo:{value:null},uVideoBlend:{value:0},tRefraction:{value:null},tEnv:{value:null},tNormal:{value:null,getTexture:Utils3D.getRepeatTexture},uDistortStrength:{value:1},uFresnelPow:{value:1},uRefractionRatio:{value:1},uScale:{value:new Vector2(1,1)},uColor:{value:new Color(Utils.randomColor()),batchUnique:!0},uHover:{value:0},uMouse:{value:mouse}}),_this.startRender((async _=>{let refraction=await _this.get("Work/refraction");_this.shader.set("tRefraction",refraction)}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WorkItemUIShader(_mesh,_shader,_input,_group){const _this=this;if(Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="WorkItemUIShader",_this.contexts="Component",_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}this.isFragment=!0;var _promises=[];!async function(){if(_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.mesh=_mesh,_this.shader=_shader,_this.uilInput=_input,_this.uilFolder=_group,_this.uilFolder?.addButton){let a=_this.uilFolder;_this.uilFolder=_this.uilInput,_this.uilInput=a}_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.shader.addUniforms({tMap:{value:null},uColor:{value:new Color(Utils.randomColor()),batchUnique:!0},uCamDistance:{value:0},uAlpha:{value:1},uHover:{value:0}});for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WorkItems(_input,_group){const _this=this;Inherit(_this,Object3D),Inherit(_this,XComponent),_this.fragName="WorkItems",_this.contexts="Object3D",_this.uilInput=_input,_this.uilFolder=_group,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.uilInput=_input,_this.uilFolder=_group,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.data=await _this.requestData("workItems",{},(_=>{let data=[];for(let i=0;i<15;i++)data.push({seo:"Test SEO text for item "+i,title:i%2?"Museum of Weed":"Paper Planes",subhead:i%2?"A small write-up of the project to give context to what it was, and the techniques used to create it.":"At Google I/O 2016, users in 15 countries used a mobile device to fold, stamp and throw planes into the 50-ft screen on stage. So far, 4.5 million planes have been created.",date:"2017\nVICE\nINSTALLATION",body:"We worked with VICE  to build Exhibit 7 in the Museum of Weed, a temporary exhibition in Hollywood, California showcasing the social and legal evolution of cannabis.\n\nExhibit 7, Legalization, consisted of a 30 foot interactive timeline, powered by a Kinect, and a map visualization - both of which combine to tell the story of cannabis over time.",perma:"test"+i,index:i});return data}));var _views=[],_cameraTargets=[];function positionViews(){let mobile=Device.mobile&&Stage.height>Stage.width;_cameraTargets.length=0,_views=[..._this.viewState.views];let views=_this.viewState.views,angle=0,total=Math.min(7,views.length),step=mobile?Math.radians(35):Math.radians(50),y=mobile?4:0,yStep=mobile?.16*total:.12*total;views.forEach(((view,i)=>{view.group.position.x=3.8*Math.cos(angle),view.group.position.z=3.8*Math.sin(angle);let pos=view.group.position.clone();pos.multiplyScalar(2),view.group.lookAt(pos),angle-=step,view.group.position.y+=y,pos.y+=y,y-=yStep;let target=new Group;target.position.copy(pos),Device.mobile&&Stage.width<Stage.height&&(target.position.y-=.7),target.quaternion.copy(view.group.quaternion),_cameraTargets.push(target),tween(view.group.scale,{x:1,y:1,z:1},1200,"easeOutQuint",200*i+200)}))}_this.onAddView=view=>{view.group.scale.setScalar(0),Utils.debounce(positionViews,250)},_this.onRemoveView=(inst,index)=>(_this.flag("removing")||(_this.flag("removing",!0,200),_this.fire("ViewController/resetWork")),tween(inst.group.scale,{x:0,y:0,z:0},400,"easeInQuart").promise()),_this.set("videoURL","");let target=new Group,scrollValue=(new Group,0),camera=(Scroll.getUnlimited(),await _this.get("Work/camera")),root=_this.findParent("Work");_this.handleCameraScroll=_=>{if(_this.flag("locked"))return;if(!_cameraTargets[0]||null==root.scrollProgress)return;let offset=Device.mobile?.1:.06;scrollValue=Math.smoothStep(offset,1-offset,root.scrollProgress);let numPlanes=_cameraTargets.length,segmentPosition=scrollValue*(numPlanes-1),planeIndex1=Math.floor(segmentPosition),planeIndex2=Math.min(planeIndex1+1,numPlanes-1),segmentFraction=segmentPosition-planeIndex1,t0=_cameraTargets[planeIndex1],t1=_cameraTargets[planeIndex2];target.position.copy(t0.position).lerp(t1.position,segmentFraction,!1),target.quaternion.copy(t0.quaternion).slerp(t1.quaternion,segmentFraction,!1),target.position.y+=-1*Math.smoothStep(0,.15,root.scrollProgress),target.position.y+=1*Math.smoothStep(1,.85,root.scrollProgress),_this.flag("firstframe")?(camera.group.position.lerp(target.position,.2),camera.group.quaternion.slerp(target.quaternion,.2)):(_this.flag("firstframe",!0),camera.group.position.copy(target.position),camera.group.quaternion.copy(target.quaternion)),_this.viewState.views.length&&_views[0].group&&(_views.sort(((a,b)=>a.group&&b.group?(a.__distToCamera=a.group.position.distanceToSquared(camera.group.position),b.__distToCamera=b.group.position.distanceToSquared(camera.group.position),b.__distToCamera-a.__distToCamera):0)),_views.forEach(((view,i)=>view.setRenderOrder?.(i))),"work"===_this.get("Router/state")&&_views[_views.length-1].data&&_this.set("videoURL",_views[_views.length-1].data.videoURL))},_this.startRender(_this.handleCameraScroll),_this.bind("Work/project",(data=>{if(data){let view=function findView(perma){for(let i=0;i<_views.length;i++){if(!_views[i].data)return;if(_views[i].data.perma==perma)return _views[i]}}(data.perma);view&&(_this.flag("locked",!0),tween(camera.group.position,view.group.position,700,"easeOutCubic"))}else _this.flag("locked",!1)}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_this.viewState=_this.initClass(ViewState,AppState.createLocal({view:"WorkItem",data:_this.data,onAddView:_this.onAddView,onRemoveView:_this.onRemoveView},!0)),_this.viewState.isFragment&&_promises.push(_this.wait(_this.viewState,"__ready")),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WorkLabelPlayground(_params,...restArgs){const _this=this;Inherit(_this,Component),Inherit(_this,XComponent),_this.fragName="WorkLabelPlayground",_this.contexts="Component",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.ref_WorkPaneUI608=_this.initClass(WorkPaneUI,AppState.createLocal({title:"Museum of Weed",copy:"A small write-up of the project to give context to what it was, and the techniques used to create it."},!0)),_this.ref_WorkPaneUI608.isFragment&&_promises.push(_this.wait(_this.ref_WorkPaneUI608,"__ready")),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WorkPaneUI(_params,...restArgs){const _this=this;Inherit(_this,GLUIElement),Inherit(_this,Initialization),Inherit(_this,XComponent),_this.fragName="WorkPaneUI",_this.contexts="GLUIElement,Initialization",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.bitmap=_this.initClass(UI3D,AppState.createLocal({width:1024,height:1024},!0)),_this.bitmap.isFragment&&_promises.push(_this.wait(_this.bitmap,"__ready")),_this.initClass(FragUIHelper,{_type:"UI",refName:"unnamed",children:[{font:"NBArchitektStd-Regular",fontSize:18,fontColor:"#ffffff",x:512,y:600,z:0,_type:"glText",_innerText:"client",refName:"client",children:[]},{font:"NBArchitektStd-Regular",fontSize:100,align:"center",fontColor:"#ffffff",x:512,y:280,z:0,_type:"glText",_innerText:"Museum of Weed",refName:"title",children:[]},{font:"NBArchitektStd-Regular",fontSize:18,lineHeight:1.6,fontColor:"#ffffff",x:512,y:600,z:0,_type:"glText",_innerText:"X",refName:"copy",children:[]},{width:400,height:200,bg:"assets/images/_scenelayout/black.jpg",_type:"glObject",refName:"logo",children:[]},{width:924,height:224,bg:"#060606",_type:"glObject",refName:"block",children:[]},{width:924,height:2,bg:"#ffffff",_type:"glObject",refName:"underline",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers());const logoShader=_this.createFragment(Shader,"LogoShader",{tMap:{value:null},uAlpha:{value:1}});_this.logo.useShader(logoShader),_this.onInit=async function(){_this.bitmap.capture.rt.upload(),await _this.initSync(_this.element.group),await _this.initSync(_this.element),_this.set("ready",!0)},_this.copy.alpha=0,_this.camera=await _this.get("Work/camera"),_this.camdistance=0,_this.bitmap.linkMesh(_this.params.mesh,(_=>(_this.camdistance=_this.params.mesh.getWorldPosition().distanceTo(_this.camera.group.position),_this.camdistance<6))),_this.bitmap.root.add(_this.element);_this.gl(1024,1024,_this.bitmap.capture);if(_this.params.title&&_this.params.copy&&_this.params.clientName){_this.client.setText(_this.params.clientName.replace(/,/g," /"),{size:24,align:"center",letterSpacing:.1,lineHeight:1.8});let size=.9*Math.range(_this.params.title.length,5,20,130,100,!0);_this.title.setText(_this.params.title,{size:size,align:"center",letterSpacing:.01,lineHeight:1.1,width:700}),_this.params.projectLogo&&(_this.logo.bg(_this.params.projectLogo.url),_this.client.alpha=0),await _this.client.text.ready(),await _this.title.text.ready(),_this.copy&&await _this.copy.text.ready(),resize(),await _this.wait(500),resize(),_this.bitmap.capture.needsRender=100}function resize(){_this.title.height=_this.title.dimensions.height,_this.copy&&(_this.copy.height=_this.copy.dimensions.height),_this.client.height=_this.client.dimensions.height,_this.client.width=_this.client.dimensions.width;let y=470-.5*_this.title.height-.5*_this.copy.height-.5*_this.client.height;isNaN(y)||(_this.client.y=y,y+=_this.client.height+20,_this.title.y=y+20,y+=_this.title.height+80,_this.copy&&(_this.copy.y=y),_this.logo.y=_this.client.y-105,_this.logo.scale=.65,_this.logo.x=512-_this.logo.width/2,_this.block.width=1e3,_this.block.height=.7*_this.title.height,_this.block.x=512-.5*_this.block.width,_this.block.y=_this.title.y+.8*(_this.title.height-_this.block.height))}_this.onResize((_=>{resize(),_this.bitmap.capture.needsRender=100}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function WorkUI(_params,...restArgs){const _this=this;Inherit(_this,GLUIElement),Inherit(_this,FXScrollUI),Inherit(_this,XComponent),_this.fragName="WorkUI",_this.contexts="GLUIElement,FXScrollUI",_this.params=_params,_this.args=arguments,this.isFragment=!0;var _promises=[];!async function(){_this.element&&(_this.element.onMountedHook=_=>_this.onMounted?.()),_this.initClass(FragUIHelper,{addTo:"GLUI.Stage",stickyY:0,releaseY:11.6,_type:"UI",refName:"ui",children:[{_type:"ChatUI",refName:"unnamed",children:[]}]}),_this.params=_params,_this.args=arguments,_this.parent?.layers&&(_this.layers=_this.parent.layers),_this.layout?.getAllLayers&&(_this.layers=await _this.layout.getAllLayers()),_this.ui.alpha=0;Scroll.createUnlimited();_this.startRender((_=>{let scrollProgress=_this.get("Work/scrollProgress");0==(scrollProgress>.05&&scrollProgress<.92?1:0)?_this.ui.showing&&(_this.ui.showing=!1,_this.ui.tween({alpha:0},500,"easeOutSine")):_this.ui.showing||(_this.ui.showing=!0,_this.ui.tween({alpha:1},500,"easeOutSine"))})),_this.onHover=e=>console.log(e.action),_this.onClick=_=>console.log("click"),_this.onResize((function updateLayout(){}));for(let key in _this)if(_this[key]?.then){let store=_this[key];store.then((val=>_this[key]=val)),_promises.push(store)}_promises.length&&await Promise.all(_promises),_promises=null,_this.flag?.("__ready",!0),_this.onInit?.()}()})),Class((function Main(){!async function(){if(await Device.system.detectXR(),Utils.query("performance"))return Performance.displayResults();!function init(){window._PROJECT_NAME_&&(Dev.pathName=`/${window._PROJECT_NAME_}/HTML/`,Dev.filesPath=Dev.pathName);if(UnsupportedRedirect.requiresWebGL=!0,UnsupportedRedirect.unsupported())return void window.location.replace(window._UNSUPPORTED_PAGE_);if(GLUI.init(),window.location.search.includes("p="))return AssetLoader.loadAssets(Assets.list().filter(["uil","shaders"])).then(Playground.instance);Container.instance()}()}()}));
window._MINIFIED_=true;
window._BUILT_=true;